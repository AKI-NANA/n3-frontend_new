<!-- 一括操作関数をtanaoroshi_logic.jsに追加する関数群 -->
<script>
// 一括操作関数をグローバルスコープに追加
window.bulkUpdateStock = function() {
    const selectedItems = document.querySelectorAll('.item-checkbox:checked');
    
    if (selectedItems.length === 0) {
        if (typeof window.N3Modal !== 'undefined') {
            window.N3Modal.alert({
                title: "エラー",
                message: "在庫を更新する商品を選択してください。",
                type: "error"
            });
        } else {
            alert('在庫を更新する商品を選択してください。');
        }
        return;
    }
    
    const newStock = prompt(`選択された${selectedItems.length}件の商品の新しい在庫数を入力してください:`);
    
    if (newStock === null || newStock === '') return;
    
    const stockValue = parseInt(newStock);
    if (isNaN(stockValue) || stockValue < 0) {
        alert('正しい在庫数を入力してください。');
        return;
    }
    
    // 各選択アイテムの在庫数を更新
    selectedItems.forEach(function(checkbox) {
        const index = parseInt(checkbox.value);
        const row = checkbox.closest('tr');
        
        if (window.currentProductData[index]) {
            window.currentProductData[index].current_stock = stockValue;
        }
        
        if (row) {
            const stockCell = row.querySelector('.number-cell');
            if (stockCell) {
                stockCell.textContent = stockValue;
                
                // 視覚的フィードバック
                stockCell.style.backgroundColor = '#dcfce7';
                setTimeout(() => {
                    stockCell.style.backgroundColor = '';
                }, 1500);
            }
        }
    });
    
    if (typeof window.N3Modal !== 'undefined') {
        window.N3Modal.alert({
            title: "更新完了",
            message: `${selectedItems.length}件の商品の在庫数を${stockValue}に更新しました。`,
            type: "success"
        });
    } else {
        alert(`${selectedItems.length}件の商品の在庫数を${stockValue}に更新しました。`);
    }
    
    // チェックボックスをクリア
    selectedItems.forEach(function(checkbox) {
        checkbox.checked = false;
    });
    
    window.updateMasterCheckbox();
};

window.bulkUpdateStatus = function() {
    const selectedItems = document.querySelectorAll('.item-checkbox:checked');
    
    if (selectedItems.length === 0) {
        if (typeof window.N3Modal !== 'undefined') {
            window.N3Modal.alert({
                title: "エラー",
                message: "ステータスを変更する商品を選択してください。",
                type: "error"
            });
        } else {
            alert('ステータスを変更する商品を選択してください。');
        }
        return;
    }
    
    const newStatus = prompt(`選択された${selectedItems.length}件の商品の新しいステータスを選択してください:\n\n1: 在庫あり\n2: 在庫僅少\n3: 欠品\n4: 要発注\n\n番号を入力してください (1-4):`);
    
    if (newStatus === null || newStatus === '') return;
    
    const statusMap = {
        '1': '在庫あり',
        '2': '在庫僅少',
        '3': '欠品',
        '4': '要発注'
    };
    
    if (!statusMap[newStatus]) {
        alert('正しい番号 (1-4) を入力してください。');
        return;
    }
    
    const statusText = statusMap[newStatus];
    
    // 各選択アイテムのステータスを更新
    selectedItems.forEach(function(checkbox) {
        const index = parseInt(checkbox.value);
        const row = checkbox.closest('tr');
        
        if (window.currentProductData[index]) {
            window.currentProductData[index].status = statusText;
        }
        
        if (row) {
            const statusCell = row.querySelector('.status');
            if (statusCell) {
                statusCell.textContent = statusText;
                
                // ステータス色を更新
                statusCell.className = 'status';
                if (statusText === '在庫あり') {
                    statusCell.classList.add('status--ok');
                } else if (statusText === '在庫僅少') {
                    statusCell.classList.add('status--warning');
                } else if (statusText === '欠品') {
                    statusCell.classList.add('status--error');
                }
                
                // 視覚的フィードバック
                statusCell.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    statusCell.style.transform = 'scale(1)';
                }, 500);
            }
        }
    });
    
    if (typeof window.N3Modal !== 'undefined') {
        window.N3Modal.alert({
            title: "更新完了",
            message: `${selectedItems.length}件の商品のステータスを「${statusText}」に更新しました。`,
            type: "success"
        });
    } else {
        alert(`${selectedItems.length}件の商品のステータスを「${statusText}」に更新しました。`);
    }
    
    // チェックボックスをクリア
    selectedItems.forEach(function(checkbox) {
        checkbox.checked = false;
    });
    
    window.updateMasterCheckbox();
};

window.bulkExport = function() {
    const selectedItems = document.querySelectorAll('.item-checkbox:checked');
    
    if (selectedItems.length === 0) {
        if (typeof window.N3Modal !== 'undefined') {
            window.N3Modal.alert({
                title: "エラー",
                message: "エクスポートする商品を選択してください。",
                type: "error"
            });
        } else {
            alert('エクスポートする商品を選択してください。');
        }
        return;
    }
    
    // 選択された商品データを収集
    const exportData = [];
    selectedItems.forEach(function(checkbox) {
        const index = parseInt(checkbox.value);
        if (window.currentProductData[index]) {
            exportData.push(window.currentProductData[index]);
        }
    });
    
    // CSVフォーマットに変換
    const csvHeader = 'SKU,商品名,カテゴリ,在庫数,最小在庫,価格,ステータス,場所,仕入先,最終更新\n';
    const csvBody = exportData.map(item => 
        `"${item.sku}","${item.name}","${item.category}",${item.current_stock},${item.minimum_stock},"${item.price}","${item.status}","${item.location}","${item.supplier}","${item.last_updated}"`
    ).join('\n');
    
    const csvContent = csvHeader + csvBody;
    
    // ダウンロード実行
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `tanaoroshi_export_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    if (typeof window.N3Modal !== 'undefined') {
        window.N3Modal.alert({
            title: "エクスポート完了",
            message: `${exportData.length}件の商品をCSVファイルでエクスポートしました。`,
            type: "success"
        });
    } else {
        alert(`${exportData.length}件の商品をCSVファイルでエクスポートしました。`);
    }
};

window.bulkDelete = function() {
    const selectedItems = document.querySelectorAll('.item-checkbox:checked');
    
    if (selectedItems.length === 0) {
        if (typeof window.N3Modal !== 'undefined') {
            window.N3Modal.alert({
                title: "エラー",
                message: "削除する商品を選択してください。",
                type: "error"
            });
        } else {
            alert('削除する商品を選択してください。');
        }
        return;
    }
    
    const confirmMessage = `選択された${selectedItems.length}件の商品を削除しますか？\n\nこの操作は元に戻せません。`;
    
    let confirmed = false;
    
    if (typeof window.N3Modal !== 'undefined') {
        window.N3Modal.confirm({
            title: "削除確認",
            message: confirmMessage
        }).then(function(result) {
            if (result) {
                executeDelete();
            }
        });
    } else {
        confirmed = confirm(confirmMessage);
        if (confirmed) {
            executeDelete();
        }
    }
    
    function executeDelete() {
        const deletedItems = [];
        
        selectedItems.forEach(function(checkbox) {
            const index = parseInt(checkbox.value);
            const row = checkbox.closest('tr');
            
            if (window.currentProductData[index]) {
                deletedItems.push(window.currentProductData[index].name);
                
                // データから削除マークを付ける（実際には削除しない）
                window.currentProductData[index]._deleted = true;
            }
            
            if (row) {
                // 行を削除アニメーション
                row.style.transition = 'all 0.5s ease';
                row.style.transform = 'translateX(-100%)';
                row.style.opacity = '0';
                
                setTimeout(() => {
                    if (row.parentNode) {
                        row.remove();
                    }
                }, 500);
            }
        });
        
        if (typeof window.N3Modal !== 'undefined') {
            window.N3Modal.alert({
                title: "削除完了",
                message: `${deletedItems.length}件の商品を削除しました。`,
                type: "success"
            });
        } else {
            alert(`${deletedItems.length}件の商品を削除しました。`);
        }
        
        // 統計情報を更新
        setTimeout(() => {
            if (typeof window.updateStatistics === 'function') {
                const activeData = window.currentProductData.filter(item => !item._deleted);
                window.updateStatistics(activeData);
            }
        }, 1000);
    }
};

console.log('一括操作関数をグローバルスコープに追加完了');
</script>
