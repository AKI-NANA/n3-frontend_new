<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBayデータ改良版ビューアー - 完全分析・ページネーション・画像表示対応</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f8fafc; 
            color: #1a202c;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .header { 
            text-align: center; 
            margin-bottom: 2rem; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .header p { opacity: 0.9; }
        
        /* 分析セクション */
        .analysis-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            text-align: center;
            padding: 1rem;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
            display: block;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #4a5568;
            margin-top: 0.25rem;
        }
        
        /* フィルターセクション */
        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-label {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.875rem;
        }
        
        .filter-input, .filter-select {
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            font-size: 0.875rem;
        }
        
        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .filter-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s ease;
        }
        
        .filter-btn:hover {
            background: #3182ce;
        }
        
        /* データテーブル */
        .data-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table tr:hover {
            background: #f7fafc;
        }
        
        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .product-image-placeholder {
            width: 60px;
            height: 60px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a0aec0;
            font-size: 0.75rem;
        }
        
        .product-title {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
        }
        
        .price-display {
            font-weight: 600;
            color: #38a169;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-inactive {
            background: #fed7d7;
            color: #742a2a;
        }
        
        /* ページネーション */
        .pagination-section {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }
        
        .pagination-info {
            margin-right: 1rem;
            color: #4a5568;
            font-size: 0.875rem;
        }
        
        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            background: white;
            color: #4a5568;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #f7fafc;
            border-color: #4299e1;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-btn.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: #4a5568;
        }
        
        .loading .spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 3px solid #e2e8f0;
            border-top: 3px solid #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fed7d7;
            color: #742a2a;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            border: 1px solid #feb2b2;
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .analysis-grid { grid-template-columns: repeat(2, 1fr); }
            .filters-grid { grid-template-columns: 1fr; }
            .data-table { font-size: 0.875rem; }
            .data-table th, .data-table td { padding: 0.5rem; }
            .product-title { max-width: 150px; }
        }
        
        /* アクションボタン */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        
        .action-btn--detail {
            background: #bee3f8;
            color: #2c5282;
        }
        
        .action-btn--detail:hover {
            background: #90cdf4;
        }
        
        .action-btn--external {
            background: #fbb6ce;
            color: #97266d;
        }
        
        .action-btn--external:hover {
            background: #f687b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> eBayデータ改良版ビューアー</h1>
            <p>完全データ分析・ページネーション・画像表示対応版</p>
        </div>
        
        <!-- データ分析セクション -->
        <div class="analysis-section">
            <h2><i class="fas fa-analytics"></i> データ分析結果</h2>
            <div class="analysis-grid" id="analysis-grid">
                <div class="stat-card">
                    <span class="stat-value" id="total-items">-</span>
                    <div class="stat-label">総アイテム数</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="active-items">-</span>
                    <div class="stat-label">アクティブアイテム</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="items-with-images">-</span>
                    <div class="stat-label">画像ありアイテム</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="average-price">-</span>
                    <div class="stat-label">平均価格 (USD)</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="image-coverage">-</span>
                    <div class="stat-label">画像カバー率</div>
                </div>
            </div>
        </div>
        
        <!-- フィルターセクション -->
        <div class="filters-section">
            <h3><i class="fas fa-filter"></i> フィルター・検索</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">検索 (タイトル・ID・SKU)</label>
                    <input type="text" class="filter-input" id="search-input" placeholder="キーワードを入力...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">ステータス</label>
                    <select class="filter-select" id="status-filter">
                        <option value="">全ステータス</option>
                        <option value="Active">Active</option>
                        <option value="Completed">Completed</option>
                        <option value="Ended">Ended</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">並び順</label>
                    <select class="filter-select" id="sort-select">
                        <option value="updated_at">更新日時</option>
                        <option value="created_at">作成日時</option>
                        <option value="current_price_value">価格</option>
                        <option value="title">タイトル</option>
                        <option value="quantity">数量</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">表示件数</label>
                    <select class="filter-select" id="per-page-select">
                        <option value="25">25件</option>
                        <option value="50" selected>50件</option>
                        <option value="100">100件</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="filter-btn" onclick="applyFilters()">
                        <i class="fas fa-search"></i> 検索実行
                    </button>
                </div>
            </div>
        </div>
        
        <!-- データセクション -->
        <div class="data-section">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <div>データを読み込み中...</div>
            </div>
            
            <div id="content" style="display: none;">
                <div style="overflow-x: auto;">
                    <table class="data-table" id="data-table">
                        <thead>
                            <tr>
                                <th>画像</th>
                                <th>商品ID</th>
                                <th>タイトル</th>
                                <th>価格</th>
                                <th>数量</th>
                                <th>ステータス</th>
                                <th>更新日</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                        </tbody>
                    </table>
                </div>
                
                <!-- ページネーション -->
                <div class="pagination-section" id="pagination-section">
                    <!-- 動的に生成 -->
                </div>
            </div>
            
            <div id="error-section" style="display: none;" class="error">
                <!-- エラー表示 -->
            </div>
        </div>
    </div>
    
    <script>
        // グローバル変数
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {
            search: '',
            status: '',
            sort: 'updated_at',
            order: 'DESC',
            per_page: 50
        };
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalysis();
            loadData(1);
        });
        
        // データ分析情報を読み込み
        async function loadAnalysis() {
            try {
                const response = await fetch('/modules/ebay_test_viewer/data_analysis_api.php');
                const data = await response.json();
                
                if (data.success) {
                    updateAnalysisDisplay(data);
                } else {
                    console.error('分析データ読み込みエラー:', data.error);
                }
            } catch (error) {
                console.error('分析API通信エラー:', error);
            }
        }
        
        // 分析結果表示更新
        function updateAnalysisDisplay(data) {
            const analysis = data.database_analysis;
            const imageAnalysis = data.image_analysis;
            const priceAnalysis = data.price_analysis;
            
            document.getElementById('total-items').textContent = analysis.actual_total_records || '0';
            document.getElementById('active-items').textContent = 
                data.listing_status_breakdown.find(item => item.listing_status === 'Active')?.count || '0';
            document.getElementById('items-with-images').textContent = imageAnalysis.items_with_images || '0';
            document.getElementById('average-price').textContent = 
                priceAnalysis.average_price ? `$${priceAnalysis.average_price}` : '-';
            document.getElementById('image-coverage').textContent = 
                imageAnalysis.image_coverage_percentage + '%' || '0%';
        }
        
        // データ読み込み
        async function loadData(page = 1) {
            try {
                showLoading();
                
                const params = new URLSearchParams({
                    page: page,
                    per_page: currentFilters.per_page,
                    search: currentFilters.search,
                    status: currentFilters.status,
                    sort: currentFilters.sort,
                    order: currentFilters.order
                });
                
                const response = await fetch(`/modules/ebay_test_viewer/paginated_data_api.php?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    displayData(result);
                    updatePagination(result.pagination);
                    currentPage = result.pagination.current_page;
                    totalPages = result.pagination.total_pages;
                } else {
                    showError('データ読み込みエラー: ' + result.error);
                }
                
            } catch (error) {
                showError('通信エラー: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // データ表示
        function displayData(result) {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';
            
            if (result.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #a0aec0;">データが見つかりませんでした</td></tr>';
                return;
            }
            
            result.data.forEach(item => {
                const row = createDataRow(item);
                tbody.appendChild(row);
            });
        }
        
        // データ行作成
        function createDataRow(item) {
            const tr = document.createElement('tr');
            
            // 画像列
            const imageCell = document.createElement('td');
            if (item.picture_urls && Array.isArray(item.picture_urls) && item.picture_urls.length > 0) {
                const img = document.createElement('img');
                img.className = 'product-image';
                img.src = item.picture_urls[0];
                img.alt = '商品画像';
                img.onerror = function() {
                    this.style.display = 'none';
                    const placeholder = document.createElement('div');
                    placeholder.className = 'product-image-placeholder';
                    placeholder.textContent = '画像なし';
                    this.parentNode.appendChild(placeholder);
                };
                imageCell.appendChild(img);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'product-image-placeholder';
                placeholder.innerHTML = '<i class="fas fa-image"></i>';
                imageCell.appendChild(placeholder);
            }
            
            // 商品ID列
            const idCell = document.createElement('td');
            idCell.textContent = item.ebay_item_id || '-';
            idCell.style.fontFamily = 'monospace';
            
            // タイトル列
            const titleCell = document.createElement('td');
            const titleDiv = document.createElement('div');
            titleDiv.className = 'product-title';
            titleDiv.textContent = item.title || 'タイトルなし';
            titleDiv.title = item.title || 'タイトルなし';
            titleCell.appendChild(titleDiv);
            
            // 価格列
            const priceCell = document.createElement('td');
            if (item.current_price_value && parseFloat(item.current_price_value) > 0) {
                priceCell.innerHTML = `<div class="price-display">$${parseFloat(item.current_price_value).toFixed(2)}</div>`;
            } else {
                priceCell.textContent = '-';
            }
            
            // 数量列
            const quantityCell = document.createElement('td');
            quantityCell.textContent = item.quantity || '0';
            
            // ステータス列
            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = `status-badge ${item.listing_status === 'Active' ? 'status-active' : 'status-inactive'}`;
            statusBadge.textContent = item.listing_status || 'Unknown';
            statusCell.appendChild(statusBadge);
            
            // 更新日列
            const dateCell = document.createElement('td');
            if (item.updated_at) {
                const date = new Date(item.updated_at);
                dateCell.textContent = date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
            } else {
                dateCell.textContent = '-';
            }
            dateCell.style.fontSize = '0.875rem';
            
            // 操作列
            const actionsCell = document.createElement('td');
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'action-buttons';
            
            const detailBtn = document.createElement('button');
            detailBtn.className = 'action-btn action-btn--detail';
            detailBtn.innerHTML = '<i class="fas fa-eye"></i>';
            detailBtn.title = '詳細表示';
            detailBtn.onclick = () => showItemDetail(item);
            
            const externalBtn = document.createElement('button');
            externalBtn.className = 'action-btn action-btn--external';
            externalBtn.innerHTML = '<i class="fab fa-ebay"></i>';
            externalBtn.title = 'eBayで見る';
            externalBtn.onclick = () => openEbayPage(item.view_item_url || `https://www.ebay.com/itm/${item.ebay_item_id}`);
            
            actionsDiv.appendChild(detailBtn);
            actionsDiv.appendChild(externalBtn);
            actionsCell.appendChild(actionsDiv);
            
            // 行に追加
            tr.appendChild(imageCell);
            tr.appendChild(idCell);
            tr.appendChild(titleCell);
            tr.appendChild(priceCell);
            tr.appendChild(quantityCell);
            tr.appendChild(statusCell);
            tr.appendChild(dateCell);
            tr.appendChild(actionsCell);
            
            return tr;
        }
        
        // ページネーション更新
        function updatePagination(pagination) {
            const section = document.getElementById('pagination-section');
            section.innerHTML = '';
            
            if (pagination.total_pages <= 1) return;
            
            // 情報表示
            const info = document.createElement('div');
            info.className = 'pagination-info';
            info.textContent = `${pagination.start_item}-${pagination.end_item} / ${pagination.total_items}件 (ページ ${pagination.current_page}/${pagination.total_pages})`;
            section.appendChild(info);
            
            // 前へボタン
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-btn';
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> 前へ';
            prevBtn.disabled = !pagination.has_prev;
            prevBtn.onclick = () => pagination.has_prev && loadData(pagination.prev_page);
            section.appendChild(prevBtn);
            
            // ページ番号ボタン
            const startPage = Math.max(1, pagination.current_page - 2);
            const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `pagination-btn ${i === pagination.current_page ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => i !== pagination.current_page && loadData(i);
                section.appendChild(pageBtn);
            }
            
            // 次へボタン
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-btn';
            nextBtn.innerHTML = '次へ <i class="fas fa-chevron-right"></i>';
            nextBtn.disabled = !pagination.has_next;
            nextBtn.onclick = () => pagination.has_next && loadData(pagination.next_page);
            section.appendChild(nextBtn);
        }
        
        // フィルター適用
        function applyFilters() {
            currentFilters.search = document.getElementById('search-input').value.trim();
            currentFilters.status = document.getElementById('status-filter').value;
            currentFilters.sort = document.getElementById('sort-select').value;
            currentFilters.per_page = parseInt(document.getElementById('per-page-select').value);
            
            loadData(1); // 最初のページから開始
        }
        
        // Enter キーでの検索
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
        
        // 詳細表示
        function showItemDetail(item) {
            alert(`商品詳細:\n\nID: ${item.ebay_item_id}\nタイトル: ${item.title}\n価格: $${item.current_price_value}\n数量: ${item.quantity}\nステータス: ${item.listing_status}\n\n画像数: ${item.picture_urls ? item.picture_urls.length : 0}`);
        }
        
        // eBayページを開く
        function openEbayPage(url) {
            if (url) {
                window.open(url, '_blank', 'noopener,noreferrer');
            } else {
                alert('eBayページのURLが見つかりません');
            }
        }
        
        // ローディング表示
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
            document.getElementById('error-section').style.display = 'none';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }
        
        function showError(message) {
            document.getElementById('error-section').innerHTML = `<strong>エラー:</strong> ${message}`;
            document.getElementById('error-section').style.display = 'block';
            document.getElementById('content').style.display = 'none';
        }
    </script>
</body>
</html>
