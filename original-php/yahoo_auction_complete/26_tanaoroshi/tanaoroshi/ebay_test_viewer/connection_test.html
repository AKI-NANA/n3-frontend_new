<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N3統合eBayデータビューア - 接続テスト</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px; margin: 2rem auto; padding: 0 1rem;
            background: #f8f9fa;
        }
        .test-card { 
            background: white; border-radius: 12px; padding: 2rem; 
            margin: 1rem 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        pre { background: #f1f3f4; padding: 1rem; border-radius: 6px; overflow-x: auto; }
        .btn { 
            display: inline-block; padding: 0.75rem 1.5rem; 
            background: #007bff; color: white; text-decoration: none; 
            border-radius: 6px; margin: 0.5rem 0.5rem 0.5rem 0; 
            border: none; cursor: pointer;
        }
        .btn:hover { background: #0056b3; }
        .btn--success { background: #28a745; }
        .btn--success:hover { background: #1e7e34; }
    </style>
</head>
<body>
    <div class="test-card">
        <h1>🚀 N3統合eBayデータビューア 接続テスト</h1>
        <p><strong>作成日時:</strong> <?= date('Y年m月d日 H:i:s') ?></p>
    </div>

    <?php
    // 設定ファイル読み込みテスト
    echo '<div class="test-card"><h2>📋 1. 設定ファイル読み込みテスト</h2>';
    try {
        require_once('../../common/config/config.php');
        echo '<div class="status success">✅ config.php 読み込み成功</div>';
        echo '<pre>NAGANO3_VERSION: ' . (defined('NAGANO3_VERSION') ? NAGANO3_VERSION : '未定義') . '</pre>';
        echo '<pre>DEBUG_MODE: ' . (defined('DEBUG_MODE') ? (DEBUG_MODE ? 'true' : 'false') : '未定義') . '</pre>';
    } catch (Exception $e) {
        echo '<div class="status error">❌ config.php 読み込み失敗: ' . $e->getMessage() . '</div>';
    }
    echo '</div>';

    // データベース接続テスト
    echo '<div class="test-card"><h2>🗄️ 2. データベース接続テスト</h2>';
    try {
        if (defined('NAGANO3_DB_HOST')) {
            $pdo = new PDO(
                "pgsql:host=" . NAGANO3_DB_HOST . ";dbname=nagano3;port=" . NAGANO3_DB_PORT,
                NAGANO3_DB_USER,
                NAGANO3_DB_PASS,
                [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]
            );
            echo '<div class="status success">✅ PostgreSQL接続成功</div>';
            echo '<pre>Host: ' . NAGANO3_DB_HOST . ':' . NAGANO3_DB_PORT . '</pre>';
            echo '<pre>Database: nagano3</pre>';
            echo '<pre>User: ' . NAGANO3_DB_USER . '</pre>';
            
            // テーブル存在確認
            $stmt = $pdo->query("SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'ebay_complete_api_data'");
            $tableExists = $stmt->fetchColumn() > 0;
            
            if ($tableExists) {
                echo '<div class="status success">✅ ebay_complete_api_data テーブル確認済み</div>';
                
                // レコード数確認
                $stmt = $pdo->query("SELECT COUNT(*) FROM ebay_complete_api_data");
                $recordCount = $stmt->fetchColumn();
                echo '<pre>レコード数: ' . number_format($recordCount) . ' 件</pre>';
            } else {
                echo '<div class="status warning">⚠️ ebay_complete_api_data テーブルが見つかりません</div>';
            }
            
        } else {
            echo '<div class="status error">❌ データベース設定が見つかりません</div>';
        }
    } catch (Exception $e) {
        echo '<div class="status error">❌ データベース接続失敗: ' . $e->getMessage() . '</div>';
    }
    echo '</div>';

    // ファイル存在確認
    echo '<div class="test-card"><h2>📁 3. 必要ファイル存在確認</h2>';
    $requiredFiles = [
        'paginated_ebay_viewer_n3.php' => 'メインページ',
        'ebay_data_api_n3.php' => 'APIエンドポイント', 
        'css/ebay_excel_view.css' => 'CSS',
        'js/ebay_image_handler.js' => 'JavaScript'
    ];
    
    foreach ($requiredFiles as $file => $description) {
        if (file_exists($file)) {
            echo '<div class="status success">✅ ' . $description . ': ' . $file . '</div>';
        } else {
            echo '<div class="status error">❌ ' . $description . ': ' . $file . ' が見つかりません</div>';
        }
    }
    echo '</div>';

    // 権限確認
    echo '<div class="test-card"><h2>🔐 4. 権限・セキュリティ確認</h2>';
    
    // セッション
    if (session_status() !== PHP_SESSION_NONE) {
        echo '<div class="status success">✅ セッション開始済み</div>';
        echo '<pre>セッションID: ' . session_id() . '</pre>';
    }
    
    // CSRF トークン
    if (function_exists('generate_csrf_token')) {
        $token = generate_csrf_token();
        echo '<div class="status success">✅ CSRF トークン生成機能</div>';
        echo '<pre>トークン: ' . substr($token, 0, 20) . '...</pre>';
    }
    echo '</div>';

    // 動作テスト
    echo '<div class="test-card"><h2>🧪 5. システム統合テスト</h2>';
    
    // API エンドポイントテスト
    if (file_exists('ebay_data_api_n3.php')) {
        echo '<div class="status success">✅ APIエンドポイント準備完了</div>';
        echo '<pre>URL: /modules/ebay_test_viewer/ebay_data_api_n3.php</pre>';
    }
    
    // メインページテスト
    if (file_exists('paginated_ebay_viewer_n3.php')) {
        echo '<div class="status success">✅ メインページ準備完了</div>';
        echo '<pre>URL: /modules/ebay_test_viewer/paginated_ebay_viewer_n3.php</pre>';
    }
    echo '</div>';

    ?>

    <div class="test-card">
        <h2>🎯 6. アクセス方法</h2>
        <p><strong>メインページ:</strong></p>
        <a href="paginated_ebay_viewer_n3.php" class="btn btn--success" target="_blank">
            📊 N3統合eBayデータビューア を開く
        </a>
        
        <p><strong>サイドバーからのアクセス:</strong></p>
        <p>受注管理 → eBayデータビューア（N3統合版）</p>
        
        <p><strong>直接URL:</strong></p>
        <pre>/modules/ebay_test_viewer/paginated_ebay_viewer_n3.php</pre>
        
        <h3>🚀 完成機能一覧</h3>
        <ul>
            <li>✅ PostgreSQL連携データ表示</li>
            <li>✅ 画像表示エラー完全解決</li>
            <li>✅ 検索・フィルター・ソート</li>
            <li>✅ ページネーション（25/50/100件）</li>
            <li>✅ 一括選択・一括操作</li>
            <li>✅ リアルタイム統計表示</li>
            <li>✅ N3統合デザイン</li>
            <li>✅ レスポンシブ対応</li>
            <li>✅ セキュリティ強化</li>
        </ul>
    </div>

    <div class="test-card">
        <h2>📋 テスト完了</h2>
        <p><strong>システム状態:</strong> 
            <?php 
            if (defined('NAGANO3_DB_HOST') && file_exists('paginated_ebay_viewer_n3.php')) {
                echo '<span class="status success">✅ 稼働準備完了</span>';
            } else {
                echo '<span class="status error">❌ 設定が不完全です</span>';
            }
            ?>
        </p>
        <p><strong>テスト実行時刻:</strong> <?= date('Y-m-d H:i:s') ?></p>
        <p><strong>PHP バージョン:</strong> <?= phpversion() ?></p>
    </div>
</body>
</html>