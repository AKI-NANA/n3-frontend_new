# 多モール在庫管理システム 完全開発指示書（最終版）

## 1. プロジェクト概要

**プロジェクト名**: 多モール在庫管理システム（NAGANO-3統合版）
**目標**: eBay×2 + メルカリ + Yahoo + Amazon + 実在庫 + Googleスプレッドシート連携の統合管理システム

### 基盤戦略
- **既存資産最大活用**: 抽出済み高品質コンポーネントをベースとした効率的開発
- **N3システム完全準拠**: 既存テンプレート構造・Ajax・JS読み込みとの完全互換性保証
- **段階的統合**: リスクを最小化した段階的実装アプローチ

## 2. 技術アーキテクチャ

### 2.1 既存資産活用戦略
**Tier S コンポーネント（完成度95%以上）**:
- `ebay_complete_dashboard_fixed.php` → データ取得エンジン
- `ebay_test_viewer_content.php` → 表示システム
- N3統一CSS → デザインシステム
- PostgreSQL連携システム → データベース基盤

### 2.2 推奨フォルダ構成
```
modules/multi_mall_inventory/
├── multi_mall_inventory.php           # メインPHPファイル（N3準拠）
├── api/                               # バックエンドAPI層（JSON専用）
│   ├── data_retrieval_engine.php      # 既存システム統合
│   ├── database_sync_engine.php       # DB同期エンジン
│   ├── ebay_account1.php              # eBayアカウント1専用API
│   ├── ebay_account2.php              # eBayアカウント2専用API
│   ├── mercari_api.php                # メルカリ専用API
│   ├── yahoo_api.php                  # Yahoo仕入れAPI
│   ├── amazon_api.php                 # Amazon仕入れAPI
│   ├── inventory_api.php              # 実在庫・セット品API
│   ├── image_upload_api.php           # 新規: 画像アップロードAPI
│   └── spreadsheet_sync_api.php       # 新規: スプレッドシート同期API
├── assets/                            # フロントエンド資産
│   ├── css/
│   │   └── multi_mall_inventory.css   # N3統一CSS統合版
│   └── js/
│       ├── multi_mall_inventory.js    # メインJavaScript
│       ├── tab_manager.js             # タブ管理システム
│       ├── data_manager.js            # APIデータ管理
│       ├── excel_view.js              # Excel風表示
│       ├── card_view.js               # カード表示
│       ├── modal_manager.js           # モーダル管理
│       ├── set_manager.js             # 新規: セット品管理JS
│       └── image_uploader.js          # 新規: 画像アップロードJS
├── templates/                         # 表示テンプレート
│   ├── product_display_system.php     # 既存システム活用
│   ├── inventory_management_ui.php    # 在庫管理UI
│   └── set_management_modal.php       # 新規: セット品管理モーダル
├── config/                            # 設定
│   ├── database_config.php            # PostgreSQL設定
│   ├── api_config.php                 # 各モールAPI設定
│   └── spreadsheet_config.php         # 新規: スプレッドシート設定
└── includes/                          # 共通処理
    ├── functions.php                  # 共通関数
    ├── validation.php                 # バリデーション
    └── spreadsheet_functions.php      # 新規: スプレッドシート処理
```

## 3. 詳細API仕様書

### 3.1 統一APIレスポンス形式
```json
{
  "success": true|false,
  "data": {...},
  "error": "エラーメッセージ",
  "timestamp": "2025-08-31T14:30:00Z",
  "source": "データソース識別子"
}
```

### 3.2 実在庫API仕様 (`inventory_api.php`)
**基本CRUD操作**:
```php
// 物理在庫管理
GET ?action=list&warehouse=main&category=electronics
POST ?action=update_physical&sku=P-MOUSE001&physical_quantity=10
POST ?action=update_listing&sku=P-MOUSE001&listing_quantity=8

// セット品管理
POST ?action=create_set
POST ?action=update_set_components
GET ?action=get_set_details&sku=S-GAMING-SET
```

**セット品作成リクエスト例**:
```json
{
  "action": "create_set",
  "set_sku": "S-GAMING-BUNDLE-001",
  "set_name": "ゲーミング3点セット",
  "components": [
    {"sku": "P-MOUSE-RGB-001", "quantity": 1},
    {"sku": "P-KEYBOARD-MX-002", "quantity": 1},
    {"sku": "P-HEADSET-GAME-003", "quantity": 1}
  ],
  "set_price": 85.99
}
```

### 3.3 画像アップロードAPI (`image_upload_api.php`)
```php
// エンドポイント
POST /modules/multi_mall_inventory/api/image_upload_api.php

// リクエスト（multipart/form-data）
{
  "sku": "P-MOUSE001",
  "image_file": [File],
  "image_type": "main|additional"
}

// レスポンス
{
  "success": true,
  "image_url": "https://domain.com/uploads/products/P-MOUSE001_main.jpg",
  "image_path": "/uploads/products/P-MOUSE001_main.jpg"
}
```

### 3.4 スプレッドシート同期API (`spreadsheet_sync_api.php`)
```php
// スプレッドシートからの更新受信
POST ?action=receive_update&source=spreadsheet
{
  "sku": "P-MOUSE001",
  "physical_quantity": 15,
  "listing_status": "active"
}

// スプレッドシートへのデータ送信
GET ?action=export_to_spreadsheet&range=A1:F1000
POST ?action=batch_update_spreadsheet
```

## 4. データベース設計（PostgreSQL）

### 4.1 商品マスターテーブル
```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    sku VARCHAR(50) UNIQUE NOT NULL,
    product_name VARCHAR(500) NOT NULL,
    physical_quantity INTEGER DEFAULT 0,
    listing_quantity INTEGER DEFAULT 0,
    is_physical_stock BOOLEAN NOT NULL,
    product_type VARCHAR(20) DEFAULT 'single', -- single, set, component
    status VARCHAR(20) DEFAULT 'active',
    image_url VARCHAR(255),                    -- 新規: メイン画像URL
    additional_images JSONB,                   -- 新規: 追加画像URL配列
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- SKUプレフィックスルール
-- P-: 有在庫商品 (is_physical_stock = true)
-- D-: 無在庫商品 (is_physical_stock = false)  
-- S-: セット商品
-- C-: セット構成品専用
```

### 4.2 モール出品テーブル
```sql
CREATE TABLE mall_listings (
    id SERIAL PRIMARY KEY,
    sku VARCHAR(50) REFERENCES products(sku),
    mall_type VARCHAR(20) NOT NULL, -- ebay1, ebay2, mercari, yahoo, amazon
    external_id VARCHAR(100) NOT NULL,
    listing_price DECIMAL(10,2),
    listing_quantity INTEGER,
    listing_status VARCHAR(20),
    sync_status VARCHAR(20) DEFAULT 'pending', -- pending, synced, error
    last_sync TIMESTAMP DEFAULT NOW(),
    error_message TEXT
);
```

### 4.3 セット品構成テーブル
```sql
CREATE TABLE set_components (
    set_sku VARCHAR(50) REFERENCES products(sku),
    component_sku VARCHAR(50) REFERENCES products(sku),
    quantity_per_set INTEGER NOT NULL,
    component_cost DECIMAL(10,2),             -- 新規: 構成品コスト
    PRIMARY KEY (set_sku, component_sku)
);
```

### 4.4 スプレッドシート同期ログ
```sql
CREATE TABLE spreadsheet_sync_log (
    id SERIAL PRIMARY KEY,
    sku VARCHAR(50),
    action VARCHAR(50), -- update_physical, update_listing, create_product
    old_value JSONB,
    new_value JSONB,
    sync_source VARCHAR(20), -- spreadsheet, system, manual
    sync_timestamp TIMESTAMP DEFAULT NOW(),
    status VARCHAR(20) DEFAULT 'success' -- success, failed, pending
);
```

## 5. Googleスプレッドシート完全仕様

### 5.1 スプレッドシート構成
**シート名**: 「在庫管理（NAGANO-3同期用）」

**必須列構成**:
| 列 | 項目名 | データ型 | 説明 |
|---|-------|---------|------|
| A | SKU | 文字列 | P-（有在庫）、D-（無在庫）、S-（セット品） |
| B | 商品名 | 文字列 | 人間が識別しやすい商品名 |
| C | 物理在庫数 | 数値 | 実際の棚卸し在庫数 |
| D | 表示在庫数 | 数値 | 各モールに表示する在庫数 |
| E | 出品状態 | 文字列 | active, inactive, sold_out |
| F | セット構成 | 文字列 | セット品の場合の構成情報 |
| G | 最終更新日時 | 日時 | システム同期日時 |
| H | 同期状態 | 文字列 | synced, pending, error |

### 5.2 Google Apps Script同期ロジック
```javascript
function onEdit(e) {
  const range = e.range;
  const sheet = e.source.getActiveSheet();
  
  // 在庫管理シートの物理在庫数（C列）または表示在庫数（D列）が変更された場合
  if (sheet.getName() === '在庫管理' && (range.getColumn() === 3 || range.getColumn() === 4)) {
    const sku = sheet.getRange(range.getRow(), 1).getValue();
    const physical_qty = sheet.getRange(range.getRow(), 3).getValue();
    const listing_qty = sheet.getRange(range.getRow(), 4).getValue();
    
    // バリデーション: 表示在庫 > 物理在庫の場合は警告
    if (listing_qty > physical_qty) {
      sheet.getRange(range.getRow(), 4).setBackground('#ffebee'); // 赤背景で警告
      Browser.msgBox('警告', '表示在庫数が物理在庫数を超えています。', Browser.Buttons.OK);
      return;
    }
    
    // NAGANO-3システムのAPIに同期リクエスト送信
    const response = UrlFetchApp.fetch('https://your-domain.com/modules/multi_mall_inventory/api/spreadsheet_sync_api.php', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      payload: JSON.stringify({
        action: 'receive_update',
        source: 'spreadsheet',
        sku: sku,
        physical_quantity: physical_qty,
        listing_quantity: listing_qty,
        timestamp: new Date().toISOString()
      })
    });
    
    if (response.getResponseCode() === 200) {
      const result = JSON.parse(response.getContentText());
      if (result.success) {
        // 成功: 最終更新日時を記録
        sheet.getRange(range.getRow(), 7).setValue(new Date());
        sheet.getRange(range.getRow(), 8).setValue('synced');
        sheet.getRange(range.getRow(), 4).setBackground('#e8f5e8'); // 緑背景で成功表示
      } else {
        // 失敗: エラー状態を記録
        sheet.getRange(range.getRow(), 8).setValue('error');
        Browser.msgBox('同期エラー', result.error, Browser.Buttons.OK);
      }
    }
  }
}

// 定期的な全体同期（1日1回実行）
function dailySync() {
  const sheet = SpreadsheetApp.getActiveSheet();
  const lastRow = sheet.getLastRow();
  
  for (let row = 2; row <= lastRow; row++) {
    const sku = sheet.getRange(row, 1).getValue();
    if (sku) {
      // システムから最新データを取得
      const response = UrlFetchApp.fetch(`https://your-domain.com/modules/multi_mall_inventory/api/inventory_api.php?action=get_product&sku=${sku}`);
      if (response.getResponseCode() === 200) {
        const data = JSON.parse(response.getContentText()).data;
        
        // スプレッドシートを最新データで更新
        sheet.getRange(row, 2).setValue(data.product_name);
        sheet.getRange(row, 3).setValue(data.physical_quantity);
        sheet.getRange(row, 4).setValue(data.listing_quantity);
        sheet.getRange(row, 5).setValue(data.status);
      }
    }
  }
}
```

### 5.3 スプレッドシート設定手順
1. **新規Googleスプレッドシート作成**
2. **列ヘッダー設定**: A1:H1に上記項目名を入力
3. **Google Apps Script設定**:
   - 拡張機能 → Apps Script
   - 上記コード貼り付け・保存
   - トリガー設定: onEdit（編集時）、dailySync（日次）
4. **権限設定**: UrlFetchApp実行権限付与

## 6. 段階別実装フェーズ

### Phase 1: 基盤システム統合（1週間）
**目標**: 既存コンポーネント統合・N3互換性確保

**詳細タスク**:
1.1. **既存システム統合**
- 抽出済み`data_retrieval_engine.php`の統合・カスタマイズ
- PostgreSQLスキーマ適用・初期データ投入
- N3統一CSS適用・カスタムスタイル追加

1.2. **N3システム互換性確保**
- 既存Ajax読み込みシステムとの競合回避
- main部分データ表示切り替えとの完全互換性
- テンプレート構造エラー防止対策

1.3. **基本UI実装**
- `multi_mall_inventory_system5.html`の完全PHP化
- N3デザインシステム統合
- 基本タブ切り替え・ビュー切り替え実装

**完了基準**:
- PostgreSQLからの基本データ表示
- カード・テーブルビューの完全動作
- N3既存システムとの競合ゼロ

### Phase 2: コアAPI・データ管理実装（1-2週間）
**目標**: 各モールAPI・データ管理機能の完全実装

**詳細タスク**:
2.1. **eBay API拡張統合**
- 既存`ebay_complete_dashboard_fixed.php`を2アカウント対応に拡張
- リアルタイム同期・差分検知システム
- エラー処理・復旧機能強化

2.2. **実在庫管理API開発**
- 物理在庫・表示在庫完全分離管理
- 在庫アラート・自動調整ロジック
- セット品在庫自動計算システム

2.3. **JavaScript フロントエンド開発**
- DataManagerクラス: 統一API呼び出し管理
- TabManagerクラス: タブ状態管理・Ajax連携
- ViewManagerクラス: Excel/カード表示制御

**完了基準**:
- 全APIエンドポイント正常動作
- フロントエンド・バックエンド完全分離
- リアルタイムデータ更新・表示

### Phase 3: 高度機能・セット品管理実装（2週間）
**目標**: モーダル・セット品・画像管理機能実装

**詳細タスク**:
3.1. **高度モーダルシステム**
- 新規商品登録モーダル（物理・表示在庫分離入力）
- 商品編集モーダル（インライン編集・リアルタイム保存）
- セット品構成管理モーダル

3.2. **セット品管理システム**
- セット・構成品親子関係完全管理
- 在庫自動計算・調整ロジック
- セット品専用UI・操作システム

3.3. **画像管理システム**
- ドラッグ&ドロップ画像アップロード
- 画像プレビュー・編集機能
- 複数画像管理・表示システム

**完了基準**:
- 全モーダル機能完全動作
- セット品管理完全実装
- 画像アップロード・表示システム

### Phase 4: スプレッドシート連携・最適化（1-2週間）
**目標**: Google Apps Script連携・パフォーマンス最適化

**詳細タスク**:
4.1. **Googleスプレッドシート完全連携**
- Google Apps Script双方向同期システム
- リアルタイム更新・通知機能
- エラーハンドリング・復旧システム

4.2. **パフォーマンス最適化**
- 10,000件以上対応ページネーション
- 遅延読み込み（Lazy Loading）実装
- キャッシュシステム・最適化

4.3. **統合テスト・本番化**
- 全機能結合テスト
- パフォーマンス・負荷テスト
- 本番環境デプロイ・監視

## 7. N3システム互換性・競合回避戦略

### 7.1 Ajax読み込みシステム競合回避
**問題**: 既存N3システムのAjax読み込みとの競合

**解決策**:
```javascript
// 既存システム確認・競合回避
if (typeof window.N3_AJAX_LOADED !== 'undefined') {
    // 既存システム検出時の処理
    window.MultiMallInventory.useN3Ajax = true;
} else {
    // 独自Ajax実装使用
    window.MultiMallInventory.useN3Ajax = false;
}

// 統一Ajax関数
function makeAjaxRequest(url, data, callback) {
    if (window.MultiMallInventory.useN3Ajax && window.N3_AJAX) {
        return window.N3_AJAX.request(url, data, callback);
    } else {
        return fetch(url, {
            method: 'POST',
            body: data
        }).then(response => response.json()).then(callback);
    }
}
```

### 7.2 CSS読み込み競合回避
**問題**: 既存N3統一CSSとの競合・上書き問題

**解決策**:
```css
/* 名前空間による競合回避 */
.multi-mall-inventory {
    /* すべてのスタイルを専用クラス内に封じ込め */
}

/* 既存N3クラスの継承・拡張 */
.multi-mall-inventory .btn {
    @extend .n3-btn; /* N3統一ボタンスタイル継承 */
}

/* 重要度調整 */
.multi-mall-inventory .custom-style {
    /* !important使用を最小限に抑制 */
}
```

### 7.3 main部分データ表示との互換性
**問題**: 既存システムのmain部分切り替えとの競合

**解決策**:
```php
// N3準拠のPHPテンプレート構造
<?php if (!defined('SECURE_ACCESS')) die('Direct access not allowed'); ?>

<div class="multi-mall-inventory-container">
    <!-- N3既存システムとの互換性を保った構造 -->
    <div id="multi-mall-main-content">
        <!-- 動的コンテンツエリア -->
    </div>
</div>

<script>
// N3既存システムとの協調動作
document.addEventListener('DOMContentLoaded', function() {
    if (typeof window.N3_MAIN_CONTROLLER !== 'undefined') {
        window.N3_MAIN_CONTROLLER.registerModule('multi_mall_inventory', {
            init: initMultiMallInventory,
            destroy: destroyMultiMallInventory
        });
    }
});
</script>
```

## 8. 品質保証・テスト戦略

### 8.1 自動テスト実装
- **Unit Test**: 各API・ロジック単体テスト
- **Integration Test**: データベース連携・API統合テスト  
- **E2E Test**: ブラウザ自動テスト（Selenium）
- **Performance Test**: 負荷テスト・レスポンス時間測定

### 8.2 N3互換性テスト
- **Ajax競合テスト**: 既存システムとの同時動作確認
- **CSS競合テスト**: スタイル競合・上書き問題確認
- **JavaScript競合テスト**: グローバル変数・関数競合確認
- **テンプレート構造テスト**: main部分切り替え動作確認

## 9. セキュリティ・バリデーション要件

### 9.1 入力バリデーション
```php
// SKUバリデーション
function validateSKU($sku) {
    if (!preg_match('/^[PDS]-[A-Z0-9-]+$/', $sku)) {
        throw new ValidationException('Invalid SKU format');
    }
    return true;
}

// 在庫数バリデーション  
function validateQuantity($physical, $listing) {
    if ($listing > $physical) {
        throw new ValidationException('Listing quantity cannot exceed physical quantity');
    }
    return true;
}
```

### 9.2 CSRF・認証保護
```php
// CSRF保護（N3準拠）
if (!isset($_SESSION['csrf_token']) || $_POST['csrf_token'] !== $_SESSION['csrf_token']) {
    die('CSRF token validation failed');
}

// API認証
if (!validateAPIKey($_POST['api_key'])) {
    http_response_code(401);
    die(json_encode(['error' => 'Unauthorized']));
}
```

## 10. 実装優先順位・リスク管理

### 10.1 高優先度機能（必須実装）
1. **基本在庫管理**: 物理・表示在庫分離システム
2. **eBay連携**: 既存システム拡張・2アカウント対応
3. **N3互換性**: 既存システムとの完全互換性確保
4. **データベース最適化**: PostgreSQL性能・安定性確保

### 10.2 中優先度機能（段階実装）
1. **セット品管理**: 構成品管理・自動計算システム
2. **画像管理**: アップロード・表示システム
3. **スプレッドシート連携**: Google Apps Script双方向同期
4. **他モール連携**: メルカリ・Yahoo・Amazon API

### 10.3 リスク要因・対策
- **既存システム競合**: 段階的統合・互換性テスト強化
- **パフォーマンス劣化**: キャッシュ・最適化・負荷テスト
- **データ整合性**: トランザクション・バリデーション強化
- **スプレッドシート制限**: API制限・エラー処理・代替手段

## 開発着手準備完了

この完全開発指示書により、既存NAGANO-3システムとの完全互換性を保ちながら、高品質な多モール在庫管理システムの効率的開発が実現可能です。各フェーズの明確な完了基準と互換性確保戦略により、安全かつ確実な開発進行を保証します。