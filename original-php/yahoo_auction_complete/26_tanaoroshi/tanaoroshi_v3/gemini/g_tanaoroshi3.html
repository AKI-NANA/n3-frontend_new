<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>多モール在庫管理システム</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
        color: #1f2937;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
      }
      .card-grid-mode-normal {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
      }
      .card-grid-mode-many {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 0.5rem;
      }
      .product-card {
        position: relative;
        @apply bg-white rounded-xl shadow-lg overflow-hidden transition-all duration-300 transform hover:scale-105 hover:shadow-2xl cursor-pointer;
      }
      .product-card-image-wrapper {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 100%; /* アスペクト比1:1 */
        overflow: hidden;
      }
      .product-card-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .card-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 0.5rem;
        color: white;
      }
      .card-top-left {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .card-price {
        background-color: rgba(0, 0, 0, 0.7);
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 1.25rem;
        font-weight: 700;
        align-self: flex-end;
        margin-bottom: 0.5rem;
      }
      .card-title {
        @apply text-sm font-medium p-2;
      }
      .collapsible-section {
        @apply transition-all duration-300 overflow-hidden ease-in-out;
      }
      .collapsible-section.collapsed {
        max-height: 0;
        padding: 0;
        opacity: 0;
      }
      .collapsible-section:not(.collapsed) {
        max-height: 1000px; /* 十分な高さを確保 */
        padding: 1rem;
        opacity: 1;
      }
      .modal-overlay {
        @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 transition-all duration-300 opacity-0 invisible;
      }
      .modal-overlay.open {
        @apply opacity-100 visible;
      }
      .modal-content {
        @apply bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform -translate-y-4 scale-95 transition-all duration-300;
      }
      .modal-overlay.open .modal-content {
        @apply translate-y-0 scale-100;
      }
      .notification {
        @apply fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-xl transition-all duration-300 transform translate-x-full;
      }
      .notification.show {
        @apply translate-x-0;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="container">
      <!-- ヘッダー -->
      <header class="text-center py-8">
        <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">
          多モール在庫管理システム
        </h1>
        <p class="text-gray-500 mt-2">
          eBay, メルカリ, Yahoo, Amazon, 実在庫を一元管理
        </p>
        <div class="mt-4 flex justify-center space-x-2">
          <button
            onclick="openNewModal()"
            class="px-4 py-2 bg-indigo-600 text-white rounded-full font-bold shadow-md hover:bg-indigo-700 transition duration-300"
          >
            <i class="fas fa-plus mr-1"></i> 新規登録
          </button>
          <button
            onclick="openSetModal()"
            class="px-4 py-2 bg-blue-600 text-white rounded-full font-bold shadow-md hover:bg-blue-700 transition duration-300"
          >
            <i class="fas fa-layer-group mr-1"></i> セット品
          </button>
        </div>
      </header>

      <!-- ダッシュボード -->
      <section class="bg-white rounded-xl shadow-lg p-2 mb-6">
        <div class="flex items-center justify-between p-2">
          <h2 class="text-xl font-bold text-gray-800">全体サマリー</h2>
          <button
            onclick="toggleSection('dashboard-content', 'dashboard-toggle')"
            class="text-gray-500 hover:text-gray-700 transition"
          >
            <i
              id="dashboard-toggle"
              class="fas fa-chevron-down transform transition-transform duration-300"
            ></i>
          </button>
        </div>
        <div id="dashboard-content" class="collapsible-section collapsed">
          <div
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-4 text-center mt-4"
          >
            <div class="bg-gray-50 rounded-lg p-4 shadow-sm">
              <p class="text-gray-500 text-sm">EBAY ACCOUNT 1</p>
              <p
                id="metric-ebay1"
                class="text-2xl font-bold mt-1 text-blue-600"
              >
                342
              </p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 shadow-sm">
              <p class="text-gray-500 text-sm">EBAY ACCOUNT 2</p>
              <p
                id="metric-ebay2"
                class="text-2xl font-bold mt-1 text-blue-600"
              >
                187
              </p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 shadow-sm">
              <p class="text-gray-500 text-sm">メルカリ</p>
              <p
                id="metric-mercari"
                class="text-2xl font-bold mt-1 text-gray-800"
              >
                156
              </p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 shadow-sm">
              <p class="text-gray-500 text-sm">実在庫</p>
              <p
                id="metric-stock"
                class="text-2xl font-bold mt-1 text-green-600"
              >
                1,284
              </p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 shadow-sm">
              <p class="text-gray-500 text-sm">YAHOO仕入れ</p>
              <p
                id="metric-yahoo"
                class="text-2xl font-bold mt-1 text-yellow-600"
              >
                89
              </p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 shadow-sm">
              <p class="text-gray-500 text-sm">AMAZON仕入れ</p>
              <p
                id="metric-amazon"
                class="text-2xl font-bold mt-1 text-red-600"
              >
                67
              </p>
            </div>
            <div
              class="bg-gray-50 rounded-lg p-4 shadow-sm col-span-2 sm:col-span-1"
            >
              <p class="text-gray-500 text-sm">合計棚卸し資産</p>
              <p
                id="metric-total-value"
                class="text-2xl font-bold mt-1 text-gray-800"
              >
                $127.5K
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- フィルターセクション -->
      <section class="bg-white rounded-xl shadow-lg p-2 mb-6">
        <div class="flex items-center justify-between p-2">
          <h2 class="text-xl font-bold text-gray-800">フィルター・ソート</h2>
          <button
            onclick="toggleSection('filter-content', 'filter-toggle')"
            class="text-gray-500 hover:text-gray-700 transition"
          >
            <i
              id="filter-toggle"
              class="fas fa-chevron-down transform transition-transform duration-300"
            ></i>
          </button>
        </div>
        <div id="filter-content" class="collapsible-section collapsed">
          <div class="flex flex-wrap items-center gap-4 mt-4">
            <div class="flex-1 min-w-[150px]">
              <label
                for="filter-mall"
                class="block text-sm font-medium text-gray-700 mb-1"
                >モール</label
              >
              <select
                id="filter-mall"
                class="w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
              >
                <option value="all">全て</option>
                <option value="ebay">eBay</option>
                <option value="mercari">メルカリ</option>
                <option value="yahoo">Yahoo</option>
                <option value="amazon">Amazon</option>
              </select>
            </div>
            <div class="flex-1 min-w-[150px]">
              <label
                for="filter-status"
                class="block text-sm font-medium text-gray-700 mb-1"
                >ステータス</label
              >
              <select
                id="filter-status"
                class="w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
              >
                <option value="all">全て</option>
                <option value="listing">出品中</option>
                <option value="unlisted">未出品</option>
                <option value="sold">販売済み</option>
              </select>
            </div>
            <div class="flex-1 min-w-[200px]">
              <label
                for="search-input"
                class="block text-sm font-medium text-gray-700 mb-1"
                >検索</label
              >
              <input
                type="text"
                id="search-input"
                placeholder="SKU, タイトル, ID..."
                class="w-full rounded-lg border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
              />
            </div>
            <div class="flex-1 min-w-[100px]">
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >表示モード</label
              >
              <button
                onclick="toggleViewMode()"
                id="view-mode-toggle"
                class="w-full rounded-full bg-gray-200 text-gray-700 font-bold py-2 shadow-sm hover:bg-gray-300 transition duration-300"
              >
                <i class="fas fa-grip-horizontal mr-1"></i> 通常
              </button>
            </div>
            <div class="flex-1 min-w-[100px]">
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >アクション</label
              >
              <button
                onclick="applyFilters()"
                class="w-full px-4 py-2 bg-green-600 text-white rounded-lg font-bold shadow-md hover:bg-green-700 transition duration-300"
              >
                <i class="fas fa-filter mr-1"></i> 適用
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- 商品リスト -->
      <main id="product-list" class="card-grid-mode-normal">
        <!-- JavaScriptによって商品カードがここに動的に生成されます -->
      </main>
    </div>

    <!-- モーダル（新規登録用） -->
    <div id="new-modal" class="modal-overlay">
      <div class="modal-content p-6">
        <div
          class="flex justify-between items-center pb-4 border-b border-gray-200"
        >
          <h3 class="text-2xl font-bold">新規商品登録</h3>
          <button
            onclick="closeModal('new-modal')"
            class="text-gray-400 hover:text-gray-600 transition"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <form id="new-form" class="mt-4">
          <div class="mb-4">
            <label
              for="new-product-name"
              class="block text-sm font-medium text-gray-700"
              >商品名</label
            >
            <input
              type="text"
              id="new-product-name"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
            />
          </div>
          <div class="mb-4">
            <label
              for="new-product-price"
              class="block text-sm font-medium text-gray-700"
              >価格</label
            >
            <input
              type="number"
              id="new-product-price"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
            />
          </div>
          <div class="mb-4">
            <label
              for="new-product-image"
              class="block text-sm font-medium text-gray-700"
              >商品画像URL</label
            >
            <input
              type="text"
              id="new-product-image"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
            />
          </div>
          <button
            type="submit"
            class="w-full py-2 px-4 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition"
          >
            登録
          </button>
        </form>
      </div>
    </div>

    <!-- モーダル（セット品用） -->
    <div id="set-modal" class="modal-overlay">
      <div class="modal-content p-6">
        <div
          class="flex justify-between items-center pb-4 border-b border-gray-200"
        >
          <h3 class="text-2xl font-bold">セット品作成</h3>
          <button
            onclick="closeModal('set-modal')"
            class="text-gray-400 hover:text-gray-600 transition"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div class="mt-4 text-center">
          <p class="text-gray-500">
            このモーダルはセット品作成機能に使用されます。
          </p>
        </div>
      </div>
    </div>

    <!-- モーダル（編集・詳細用） -->
    <div id="edit-modal" class="modal-overlay">
      <div class="modal-content p-6">
        <div
          class="flex justify-between items-center pb-4 border-b border-gray-200"
        >
          <h3 class="text-2xl font-bold">商品詳細・編集</h3>
          <button
            onclick="closeModal('edit-modal')"
            class="text-gray-400 hover:text-gray-600 transition"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <form id="edit-form" class="mt-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <div
                id="edit-image-preview"
                class="w-full h-48 bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center"
              >
                <!-- Image will be displayed here -->
              </div>
              <div class="mt-4">
                <label
                  for="edit-image-url"
                  class="block text-sm font-medium text-gray-700"
                  >画像URL</label
                >
                <input
                  type="text"
                  id="edit-image-url"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                />
              </div>
            </div>
            <div>
              <div class="mb-4">
                <label
                  for="edit-name"
                  class="block text-sm font-medium text-gray-700"
                  >商品名</label
                >
                <input
                  type="text"
                  id="edit-name"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                />
              </div>
              <div class="mb-4">
                <label
                  for="edit-price"
                  class="block text-sm font-medium text-gray-700"
                  >価格</label
                >
                <input
                  type="number"
                  id="edit-price"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                />
              </div>
              <div class="mb-4">
                <label
                  for="edit-stock"
                  class="block text-sm font-medium text-gray-700"
                  >実在庫</label
                >
                <input
                  type="number"
                  id="edit-stock"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                />
              </div>
              <div class="mb-4">
                <label
                  for="edit-mall"
                  class="block text-sm font-medium text-gray-700"
                  >モール</label
                >
                <select
                  id="edit-mall"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                >
                  <option value="ebay">eBay</option>
                  <option value="mercari">メルカリ</option>
                  <option value="yahoo">Yahoo</option>
                  <option value="amazon">Amazon</option>
                </select>
              </div>
            </div>
          </div>
          <div class="flex justify-end space-x-2 mt-6">
            <button
              type="button"
              onclick="deleteProduct()"
              class="py-2 px-4 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition"
            >
              削除
            </button>
            <button
              type="submit"
              class="py-2 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition"
            >
              保存
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 通知システム -->
    <div id="notification" class="notification"></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        doc,
        onSnapshot,
        getDoc,
        addDoc,
        setDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Firestoreのデバッグログを有効にする
      setLogLevel("debug");

      // グローバル変数（Canvas環境から提供される）
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : {};
      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      let db, auth, userId;
      let products = [];
      let viewMode = "normal";

      // ダミーデータ（Firestoreの代わりとして使用）
      const dummyData = [
        {
          id: "1",
          mall: "ebay",
          image: "https://placehold.co/400x400/0000FF/FFFFFF?text=Product+1",
          price: 15.99,
          name: "Vintage Camera Lens",
          stock: 5,
        },
        {
          id: "2",
          mall: "mercari",
          image: "https://placehold.co/400x400/FF0000/FFFFFF?text=Product+2",
          price: 25.5,
          name: "Handmade Leather Bag",
          stock: 10,
        },
        {
          id: "3",
          mall: "yahoo",
          image: "https://placehold.co/400x400/008000/FFFFFF?text=Product+3",
          price: 5.0,
          name: "Anime Figure",
          stock: 1,
        },
        {
          id: "4",
          mall: "amazon",
          image: "https://placehold.co/400x400/FFA500/FFFFFF?text=Product+4",
          price: 99.99,
          name: "Wireless Keyboard",
          stock: 2,
        },
        {
          id: "5",
          mall: "ebay",
          image: "https://placehold.co/400x400/800080/FFFFFF?text=Product+5",
          price: 50.0,
          name: "Action Figure",
          stock: 8,
        },
        {
          id: "6",
          mall: "mercari",
          image: "https://placehold.co/400x400/00FFFF/000000?text=Product+6",
          price: 12.0,
          name: "Used Book Set",
          stock: 3,
        },
        {
          id: "7",
          mall: "yahoo",
          image: "https://placehold.co/400x400/808080/FFFFFF?text=Product+7",
          price: 7.5,
          name: "Rare Coin",
          stock: 1,
        },
        {
          id: "8",
          mall: "amazon",
          image: "https://placehold.co/400x400/FFC0CB/000000?text=Product+8",
          price: 35.75,
          name: "Smart Watch",
          stock: 20,
        },
        {
          id: "9",
          mall: "ebay",
          image: "https://placehold.co/400x400/4B0082/FFFFFF?text=Product+9",
          price: 110.0,
          name: "Graphic Card",
          stock: 4,
        },
        {
          id: "10",
          mall: "mercari",
          image: "https://placehold.co/400x400/E6E6FA/000000?text=Product+10",
          price: 8.99,
          name: "Sneaker Laces",
          stock: 15,
        },
      ];

      let selectedProductId = null;

      // 初期化処理
      async function initializeApp() {
        try {
          const app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);

          // 認証
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }
          userId = auth.currentUser.uid;
          console.log("Firebase initialized. User ID:", userId);

          // Firestoreからのデータ読み込みとリアルタイム更新
          // 公開データとして設定（他ユーザーと共有するため）
          const productsCollectionRef = collection(
            db,
            `artifacts/${appId}/public/data/products`
          );
          onSnapshot(productsCollectionRef, (snapshot) => {
            const fetchedProducts = [];
            snapshot.forEach((doc) => {
              const productData = doc.data();
              // 配列やオブジェクトのデシリアライズ
              if (productData.details) {
                productData.details = JSON.parse(productData.details);
              }
              fetchedProducts.push({ id: doc.id, ...productData });
            });

            // 初回読み込み時はダミーデータをFirestoreに追加
            if (fetchedProducts.length === 0) {
              console.log("No data in Firestore. Seeding with dummy data...");
              seedDummyData();
            } else {
              products = fetchedProducts;
              renderProducts(products);
              updateDashboardMetrics(products);
              console.log("Products loaded from Firestore.");
            }
          });
        } catch (error) {
          console.error(
            "Firebase initialization or data fetching failed:",
            error
          );
          showNotification(
            "システムエラー: データの読み込みに失敗しました。",
            "error"
          );
          // エラー時はダミーデータで描画
          products = dummyData;
          renderProducts(products);
          updateDashboardMetrics(products);
        }
      }

      // ダミーデータをFirestoreに保存する関数
      async function seedDummyData() {
        for (const product of dummyData) {
          // データベースに合わせたデータの整形
          const dataToSave = {
            mall: product.mall,
            name: product.name,
            image: product.image,
            price: product.price,
            stock: product.stock,
            // 複雑なデータ構造はJSON文字列として保存
            details: JSON.stringify({
              sku: `SKU-${Math.floor(Math.random() * 10000)}`,
              description: `これは${product.name}の詳細な説明です。`,
              status: product.stock > 0 ? "出品中" : "未出品",
              last_updated: new Date().toISOString(),
            }),
          };
          await addDoc(
            collection(db, `artifacts/${appId}/public/data/products`),
            dataToSave
          );
        }
      }

      // 商品カードをレンダリングする
      function renderProducts(items) {
        const productList = document.getElementById("product-list");
        if (!productList) return;

        productList.innerHTML = ""; // 一度クリア
        productList.className = `transition-all duration-300 ${
          viewMode === "many" ? "card-grid-mode-many" : "card-grid-mode-normal"
        }`;

        items.forEach((product) => {
          const cardHtml = `
                    <div class="product-card" onclick="openEditModal('${
                      product.id
                    }')">
                        <div class="product-card-image-wrapper">
                            <img src="${product.image}" alt="${
            product.name
          }" class="product-card-image" onerror="this.src='https://placehold.co/400x400/f3f4f6/9ca3af?text=No+Image';">
                            <div class="card-overlay">
                                <div class="flex justify-between items-start w-full">
                                    <span class="card-top-left">
                                        ${getMallIcon(
                                          product.mall
                                        )} ${product.mall.toUpperCase()}
                                    </span>
                                </div>
                                <div class="flex flex-col items-end w-full">
                                    <span class="card-price">$${product.price.toFixed(
                                      2
                                    )}</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-title">${product.name}</div>
                    </div>
                `;
          productList.innerHTML += cardHtml;
        });
      }

      // モールごとのアイコンを取得
      function getMallIcon(mall) {
        switch (mall) {
          case "ebay":
            return '<i class="fab fa-ebay text-blue-400"></i>';
          case "mercari":
            return '<i class="fas fa-box text-red-400"></i>';
          case "yahoo":
            return '<i class="fas fa-lightbulb text-yellow-400"></i>';
          case "amazon":
            return '<i class="fab fa-amazon text-gray-400"></i>';
          default:
            return '<i class="fas fa-store text-gray-400"></i>';
        }
      }

      // ダッシュボードのメトリクスを更新
      function updateDashboardMetrics(items) {
        const metrics = {
          ebay1: 0,
          ebay2: 0,
          mercari: 0,
          stock: 0,
          yahoo: 0,
          amazon: 0,
          totalValue: 0,
        };
        items.forEach((item) => {
          const mall = item.mall;
          metrics[mall] = (metrics[mall] || 0) + 1;
          metrics.totalValue += item.price * item.stock;
          if (mall === "ebay") {
            if (metrics.ebay1 < 350) metrics.ebay1++;
            else metrics.ebay2++;
          }
        });
        document.getElementById("metric-ebay1").textContent = metrics.ebay1;
        document.getElementById("metric-ebay2").textContent = metrics.ebay2;
        document.getElementById("metric-mercari").textContent = metrics.mercari;
        document.getElementById("metric-stock").textContent = metrics.stock;
        document.getElementById("metric-yahoo").textContent = metrics.yahoo;
        document.getElementById("metric-amazon").textContent = metrics.amazon;
        document.getElementById("metric-total-value").textContent = `$${(
          metrics.totalValue / 1000
        ).toFixed(1)}K`;
      }

      // ビューモードを切り替える
      function toggleViewMode() {
        const toggleButton = document.getElementById("view-mode-toggle");
        if (viewMode === "normal") {
          viewMode = "many";
          toggleButton.innerHTML = `<i class="fas fa-th-large mr-1"></i> たくさん`;
        } else {
          viewMode = "normal";
          toggleButton.innerHTML = `<i class="fas fa-grip-horizontal mr-1"></i> 通常`;
        }
        renderProducts(products);
      }

      // セクションの表示を切り替える
      function toggleSection(id, toggleId) {
        const content = document.getElementById(id);
        const toggleIcon = document.getElementById(toggleId);
        content.classList.toggle("collapsed");
        toggleIcon.classList.toggle("rotate-180");
      }

      // フィルターを適用する
      function applyFilters() {
        const mall = document.getElementById("filter-mall").value;
        const status = document.getElementById("filter-status").value;
        const searchTerm = document
          .getElementById("search-input")
          .value.toLowerCase();

        let filteredProducts = products.filter((product) => {
          const mallMatch = mall === "all" || product.mall === mall;
          const statusMatch =
            status === "all" ||
            (product.stock > 0 && status === "listing") ||
            (product.stock === 0 && status === "unlisted");
          const searchMatch =
            product.name.toLowerCase().includes(searchTerm) ||
            product.id.toLowerCase().includes(searchTerm);
          return mallMatch && statusMatch && searchMatch;
        });
        renderProducts(filteredProducts);
      }

      // モーダルを開く
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("open");
      }

      // モーダルを閉じる
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("open");
      }

      // 新規登録モーダルを開く
      window.openNewModal = function () {
        // フォームをリセット
        document.getElementById("new-form").reset();
        openModal("new-modal");
      };

      // セット品モーダルを開く
      window.openSetModal = function () {
        openModal("set-modal");
      };

      // 編集モーダルを開く
      window.openEditModal = async function (id) {
        selectedProductId = id;
        const product = products.find((p) => p.id === id);
        if (!product) {
          showNotification("商品が見つかりません。", "error");
          return;
        }

        // 編集フォームにデータをセット
        document.getElementById("edit-name").value = product.name;
        document.getElementById("edit-price").value = product.price;
        document.getElementById("edit-stock").value = product.stock;
        document.getElementById("edit-mall").value = product.mall;
        document.getElementById("edit-image-url").value = product.image;
        document.getElementById(
          "edit-image-preview"
        ).innerHTML = `<img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover">`;

        openModal("edit-modal");
      };

      // 編集フォームの送信処理
      document
        .getElementById("edit-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault();
          if (!selectedProductId) return;

          const name = document.getElementById("edit-name").value;
          const price = parseFloat(document.getElementById("edit-price").value);
          const stock = parseInt(
            document.getElementById("edit-stock").value,
            10
          );
          const mall = document.getElementById("edit-mall").value;
          const image = document.getElementById("edit-image-url").value;

          // Firestoreでドキュメントを更新
          const productDocRef = doc(
            db,
            `artifacts/${appId}/public/data/products`,
            selectedProductId
          );
          await setDoc(
            productDocRef,
            { name, price, stock, mall, image },
            { merge: true }
          );

          showNotification("商品情報を更新しました。", "success");
          closeModal("edit-modal");
        });

      // 新規登録フォームの送信処理
      document
        .getElementById("new-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const name = document.getElementById("new-product-name").value;
          const price = parseFloat(
            document.getElementById("new-product-price").value
          );
          const image = document.getElementById("new-product-image").value;

          const newProduct = {
            name,
            price,
            image,
            mall: "mercari", // デフォルトでメルカリに設定
            stock: 1,
            details: JSON.stringify({
              sku: `NEW-${Date.now()}`,
              description: `新規登録された商品です。`,
              status: "未出品",
              last_updated: new Date().toISOString(),
            }),
          };

          await addDoc(
            collection(db, `artifacts/${appId}/public/data/products`),
            newProduct
          );

          showNotification("新しい商品を登録しました。", "success");
          closeModal("new-modal");
        });

      // 商品を削除する
      window.deleteProduct = async function () {
        if (!selectedProductId) return;
        const confirmed = confirm("本当にこの商品を削除しますか？");
        if (confirmed) {
          const productDocRef = doc(
            db,
            `artifacts/${appId}/public/data/products`,
            selectedProductId
          );
          await deleteDoc(productDocRef);
          showNotification("商品を削除しました。", "success");
          closeModal("edit-modal");
        }
      };

      // 代替アラート（通知システム）
      function showNotification(message, type = "info") {
        const notification = document.getElementById("notification");
        const colors = {
          info: "bg-gray-500",
          success: "bg-green-500",
          error: "bg-red-500",
        };
        notification.className = `notification ${colors[type]}`;
        notification.textContent = message;
        setTimeout(() => {
          notification.classList.add("show");
        }, 10);
        setTimeout(() => {
          notification.classList.remove("show");
        }, 3000);
      }

      // アプリケーションを初期化
      window.onload = initializeApp;
    </script>
  </body>
</html>
