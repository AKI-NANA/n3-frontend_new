# 多モール在庫管理システム 完全開発技術書（NAGANO-3 統合版）

## 📋 エグゼクティブサマリー

**プロジェクト名**: 多モール在庫管理システム（NAGANO-3 統合版）  
**対象モール**: eBay×2 + メルカリ + Yahoo + Amazon + 実在庫 + Google スプレッドシート  
**技術基盤**: PHP 8.0+, PostgreSQL 13+, N3 システム完全準拠  
**開発戦略**: 既存資産最大活用 + 段階的統合 + Hook 活用開発

## 🎯 1. システム設計アーキテクチャ

### 1.1 コアアーキテクチャ戦略

```
NAGANO-3 Base System
├── Multi-Mall Inventory Module
│   ├── Data Layer (PostgreSQL)
│   ├── API Integration Layer
│   ├── Business Logic Layer
│   └── Presentation Layer (N3準拠)
├── Hook Integration System
└── External Integrations (Google Sheets API)
```

### 1.2 技術スタック詳細

**バックエンド**:

- **PHP 8.0+**: PSR-4 準拠、名前空間活用
- **PostgreSQL 13+**: JSONB 活用、インデックス最適化
- **Composer**: 依存関係管理、オートローダー

**フロントエンド**:

- **N3 統一 CSS**: 既存デザインシステム準拠
- **JavaScript ES6+**: モジュラー設計、非同期処理
- **Ajax**: 非同期通信、リアルタイム更新

**外部連携**:

- **Google Sheets API v4**: 双方向同期
- **各モール API**: eBay, メルカリ, Yahoo, Amazon
- **Google Apps Script**: サーバープッシュ通知

## 🏗️ 2. システム構成要素詳細

### 2.1 データベース設計（PostgreSQL）

#### 商品マスターテーブル

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    sku VARCHAR(50) UNIQUE NOT NULL,
    product_name VARCHAR(500) NOT NULL,
    physical_quantity INTEGER DEFAULT 0,
    listing_quantity INTEGER DEFAULT 0,
    is_physical_stock BOOLEAN NOT NULL,
    product_type VARCHAR(20) DEFAULT 'single',
    status VARCHAR(20) DEFAULT 'active',
    image_url VARCHAR(255),
    additional_images JSONB,
    price_data JSONB,
    supplier_info JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- インデックス
    CONSTRAINT ck_physical_listing CHECK (listing_quantity <= physical_quantity OR NOT is_physical_stock),
    CONSTRAINT ck_product_type CHECK (product_type IN ('single', 'set', 'component'))
);

-- SKUプレフィックスルール
-- P-: 有在庫商品 (is_physical_stock = true)
-- D-: 無在庫商品 (is_physical_stock = false)
-- S-: セット商品
-- C-: セット構成品専用

CREATE INDEX idx_products_sku ON products(sku);
CREATE INDEX idx_products_type_status ON products(product_type, status);
CREATE INDEX idx_products_stock_level ON products(physical_quantity, listing_quantity);
```

#### モール出品テーブル

```sql
CREATE TABLE mall_listings (
    id SERIAL PRIMARY KEY,
    sku VARCHAR(50) REFERENCES products(sku) ON UPDATE CASCADE,
    mall_type VARCHAR(20) NOT NULL,
    external_id VARCHAR(100) NOT NULL,
    listing_title VARCHAR(255),
    listing_price DECIMAL(10,2),
    listing_quantity INTEGER,
    listing_status VARCHAR(20) DEFAULT 'draft',
    sync_status VARCHAR(20) DEFAULT 'pending',
    last_sync TIMESTAMP DEFAULT NOW(),
    sync_metadata JSONB,
    error_message TEXT,

    UNIQUE(sku, mall_type),
    CONSTRAINT ck_mall_type CHECK (mall_type IN ('ebay1', 'ebay2', 'mercari', 'yahoo', 'amazon'))
);
```

#### セット品構成テーブル

```sql
CREATE TABLE set_components (
    set_sku VARCHAR(50) REFERENCES products(sku),
    component_sku VARCHAR(50) REFERENCES products(sku),
    quantity_per_set INTEGER NOT NULL CHECK (quantity_per_set > 0),
    component_cost DECIMAL(10,2),
    PRIMARY KEY (set_sku, component_sku)
);
```

### 2.2 API アーキテクチャ設計

#### 統一 API レスポンス形式

```php
<?php
class APIResponse
{
    public static function success($data = null, $message = 'Success'): array
    {
        return [
            'success' => true,
            'data' => $data,
            'message' => $message,
            'timestamp' => date('c'),
            'source' => self::getSourceIdentifier()
        ];
    }

    public static function error($message, $code = 400, $details = null): array
    {
        return [
            'success' => false,
            'error' => [
                'message' => $message,
                'code' => $code,
                'details' => $details
            ],
            'timestamp' => date('c'),
            'source' => self::getSourceIdentifier()
        ];
    }
}
```

#### 在庫管理 API エンドポイント設計

```php
// modules/multi_mall_inventory/api/inventory_api.php
<?php
if (!defined('SECURE_ACCESS')) die('Direct access not allowed');

class InventoryAPI
{
    private $db;
    private $validator;
    private $auditLogger;

    public function __construct()
    {
        $this->db = DatabaseConnection::getInstance();
        $this->validator = new InventoryValidator();
        $this->auditLogger = new AuditLogger();
    }

    public function updatePhysicalStock(string $sku, int $quantity): array
    {
        try {
            // バリデーション
            $this->validator->validateSKU($sku);
            $this->validator->validateQuantity($quantity);

            // トランザクション開始
            $this->db->beginTransaction();

            // 在庫更新
            $result = $this->db->execute(
                "UPDATE products SET physical_quantity = ?, updated_at = NOW() WHERE sku = ?",
                [$quantity, $sku]
            );

            if ($result->rowCount() === 0) {
                throw new NotFoundException("Product not found: {$sku}");
            }

            // 表示在庫自動調整
            $this->autoAdjustListingQuantity($sku);

            // セット品在庫自動更新
            $this->updateSetProductAvailability($sku);

            // 監査ログ
            $this->auditLogger->logInventoryChange($sku, 'physical_stock_update', [
                'old_quantity' => $this->getPreviousQuantity($sku),
                'new_quantity' => $quantity
            ]);

            $this->db->commit();

            return APIResponse::success([
                'sku' => $sku,
                'physical_quantity' => $quantity,
                'listing_quantity' => $this->getListingQuantity($sku),
                'affected_sets' => $this->getAffectedSets($sku)
            ]);

        } catch (Exception $e) {
            $this->db->rollback();
            return APIResponse::error($e->getMessage(), 500);
        }
    }

    private function autoAdjustListingQuantity(string $sku): void
    {
        $product = $this->getProduct($sku);

        if ($product['is_physical_stock']) {
            // 有在庫商品: 表示在庫 > 物理在庫の場合は自動調整
            if ($product['listing_quantity'] > $product['physical_quantity']) {
                $newListingQty = max(0, $product['physical_quantity'] - 1); // 安全在庫1個

                $this->db->execute(
                    "UPDATE products SET listing_quantity = ? WHERE sku = ?",
                    [$newListingQty, $sku]
                );
            }
        }
    }
}
```

### 2.3 N3 システム統合設計

#### メインモジュール構造（N3 準拠）

```php
<?php
// modules/multi_mall_inventory/multi_mall_inventory.php
if (!defined('SECURE_ACCESS')) {
    define('SECURE_ACCESS', true);
}

require_once __DIR__ . '/../../config/database.php';
require_once __DIR__ . '/../../includes/functions.php';
require_once __DIR__ . '/../../includes/security.php';

class MultiMallInventoryModule
{
    private $page_title = "多モール在庫管理システム";
    private $module_version = "1.0.0";

    public function render(): string
    {
        // N3セキュリティ確認
        SecurityHelper::validateAccess();

        // ページルーティング
        $sub_page = $_GET['sub'] ?? 'dashboard';
        $allowed_pages = ['dashboard', 'inventory', 'listings', 'sync', 'settings'];

        if (!in_array($sub_page, $allowed_pages)) {
            $sub_page = 'dashboard';
        }

        // ヘッダー出力
        $html = $this->renderHeader();

        // メインコンテンツ
        switch ($sub_page) {
            case 'inventory':
                $html .= $this->renderInventoryManagement();
                break;
            case 'listings':
                $html .= $this->renderListingManagement();
                break;
            case 'sync':
                $html .= $this->renderSyncManagement();
                break;
            case 'settings':
                $html .= $this->renderSettings();
                break;
            default:
                $html .= $this->renderDashboard();
        }

        // フッター出力
        $html .= $this->renderFooter();

        return $html;
    }

    private function renderHeader(): string
    {
        return <<<HTML
<div class="multi-mall-inventory-container">
    <div class="inventory-header">
        <h1>{$this->page_title}</h1>
        <div class="inventory-nav">
            <a href="?page=multi_mall_inventory&sub=dashboard" class="nav-link">ダッシュボード</a>
            <a href="?page=multi_mall_inventory&sub=inventory" class="nav-link">在庫管理</a>
            <a href="?page=multi_mall_inventory&sub=listings" class="nav-link">出品管理</a>
            <a href="?page=multi_mall_inventory&sub=sync" class="nav-link">同期管理</a>
            <a href="?page=multi_mall_inventory&sub=settings" class="nav-link">設定</a>
        </div>
    </div>
HTML;
    }
}

// N3統合用インスタンス
$multi_mall_inventory = new MultiMallInventoryModule();
echo $multi_mall_inventory->render();
```

## 🔧 3. 既存資産活用戦略

### 3.1 ebay_complete_dashboard_fixed.php 活用

既存の`ebay_complete_dashboard_fixed.php`を基盤として、2 アカウント対応に拡張:

```php
<?php
class ExtendedEbayIntegration extends EbayCompleteDashboard
{
    private $account_configs = [
        'account_1' => [
            'app_id' => getenv('EBAY_APP_ID_1'),
            'dev_id' => getenv('EBAY_DEV_ID_1'),
            'cert_id' => getenv('EBAY_CERT_ID_1'),
            'token' => getenv('EBAY_TOKEN_1'),
            'site_id' => 0 // US
        ],
        'account_2' => [
            'app_id' => getenv('EBAY_APP_ID_2'),
            'dev_id' => getenv('EBAY_DEV_ID_2'),
            'cert_id' => getenv('EBAY_CERT_ID_2'),
            'token' => getenv('EBAY_TOKEN_2'),
            'site_id' => 0 // US
        ]
    ];

    public function syncAllAccounts(): array
    {
        $results = [];

        foreach ($this->account_configs as $account_id => $config) {
            try {
                $this->setCurrentAccount($config);
                $sync_result = $this->performSync();
                $results[$account_id] = $sync_result;
            } catch (Exception $e) {
                $results[$account_id] = ['error' => $e->getMessage()];
            }
        }

        return $results;
    }
}
```

### 3.2 PostgreSQL 連携強化

既存の PostgreSQL 接続を活用し、在庫管理特化の最適化:

```php
<?php
class InventoryDatabaseManager extends PostgreSQLConnection
{
    public function createInventoryTransaction(): DatabaseTransaction
    {
        return new DatabaseTransaction($this->connection, [
            'isolation_level' => 'READ COMMITTED',
            'lock_timeout' => 5000,
            'statement_timeout' => 30000
        ]);
    }

    public function getInventoryWithLocking(array $skus): array
    {
        $placeholders = str_repeat('?,', count($skus) - 1) . '?';

        return $this->executeQuery(
            "SELECT * FROM products WHERE sku IN ({$placeholders}) FOR UPDATE",
            $skus
        );
    }

    public function bulkUpdateInventory(array $updates): int
    {
        $updated_count = 0;

        $this->beginTransaction();

        try {
            foreach ($updates as $update) {
                $this->execute(
                    "UPDATE products SET physical_quantity = ?, updated_at = NOW() WHERE sku = ?",
                    [$update['quantity'], $update['sku']]
                );
                $updated_count++;
            }

            $this->commit();
            return $updated_count;

        } catch (Exception $e) {
            $this->rollback();
            throw $e;
        }
    }
}
```

## 🌐 4. Google Sheets 統合システム

### 4.1 Google Apps Script 実装

```javascript
// Google Apps Script - NAGANO-3在庫同期システム
function onEdit(e) {
  const range = e.range;
  const sheet = e.source.getActiveSheet();

  // 在庫管理シートの物理在庫数（C列）または表示在庫数（D列）が変更された場合
  if (
    sheet.getName() === "在庫管理" &&
    (range.getColumn() === 3 || range.getColumn() === 4)
  ) {
    const sku = sheet.getRange(range.getRow(), 1).getValue();
    const physical_qty = sheet.getRange(range.getRow(), 3).getValue();
    const listing_qty = sheet.getRange(range.getRow(), 4).getValue();

    // バリデーション: 表示在庫 > 物理在庫の場合は警告
    if (listing_qty > physical_qty) {
      sheet.getRange(range.getRow(), 4).setBackground("#ffebee");
      Browser.msgBox(
        "警告",
        "表示在庫数が物理在庫数を超えています。",
        Browser.Buttons.OK
      );
      return;
    }

    // NAGANO-3システムのAPIに同期リクエスト送信
    const response = UrlFetchApp.fetch(
      "https://your-domain.com/modules/multi_mall_inventory/api/spreadsheet_sync_api.php",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + getAuthToken(),
        },
        payload: JSON.stringify({
          action: "receive_update",
          source: "spreadsheet",
          sku: sku,
          physical_quantity: physical_qty,
          listing_quantity: listing_qty,
          timestamp: new Date().toISOString(),
        }),
      }
    );

    if (response.getResponseCode() === 200) {
      const result = JSON.parse(response.getContentText());
      if (result.success) {
        sheet.getRange(range.getRow(), 7).setValue(new Date());
        sheet.getRange(range.getRow(), 8).setValue("synced");
        sheet.getRange(range.getRow(), 4).setBackground("#e8f5e8");
      } else {
        sheet.getRange(range.getRow(), 8).setValue("error");
        Browser.msgBox("同期エラー", result.error, Browser.Buttons.OK);
      }
    }
  }
}

function getAuthToken() {
  return PropertiesService.getScriptProperties().getProperty(
    "NAGANO3_API_TOKEN"
  );
}

// 定期的な全体同期（1日1回実行）
function dailySync() {
  const sheet = SpreadsheetApp.getActiveSheet();
  const lastRow = sheet.getLastRow();

  for (let row = 2; row <= lastRow; row++) {
    const sku = sheet.getRange(row, 1).getValue();
    if (sku) {
      try {
        const response = UrlFetchApp.fetch(
          `https://your-domain.com/modules/multi_mall_inventory/api/inventory_api.php?action=get_product&sku=${sku}`,
          {
            headers: {
              Authorization: "Bearer " + getAuthToken(),
            },
          }
        );

        if (response.getResponseCode() === 200) {
          const data = JSON.parse(response.getContentText()).data;

          sheet.getRange(row, 2).setValue(data.product_name);
          sheet.getRange(row, 3).setValue(data.physical_quantity);
          sheet.getRange(row, 4).setValue(data.listing_quantity);
          sheet.getRange(row, 5).setValue(data.status);
        }
      } catch (error) {
        console.error(`Sync error for SKU ${sku}: ${error}`);
      }
    }
  }
}
```

### 4.2 PHP 側スプレッドシート同期 API

```php
<?php
// modules/multi_mall_inventory/api/spreadsheet_sync_api.php
class SpreadsheetSyncAPI
{
    private $inventory_api;
    private $audit_logger;

    public function receiveUpdate(): array
    {
        $input = json_decode(file_get_contents('php://input'), true);

        $validator = new SpreadsheetValidator();
        $validation_result = $validator->validate($input);

        if (!$validation_result['valid']) {
            return APIResponse::error('Validation failed', 400, $validation_result['errors']);
        }

        try {
            // 在庫更新実行
            $update_result = $this->inventory_api->updateInventory([
                'sku' => $input['sku'],
                'physical_quantity' => $input['physical_quantity'],
                'listing_quantity' => $input['listing_quantity'],
                'source' => 'spreadsheet'
            ]);

            // 監査ログ記録
            $this->audit_logger->logSpreadsheetUpdate($input);

            // モール同期トリガー
            $this->triggerMallSync($input['sku']);

            return APIResponse::success($update_result);

        } catch (Exception $e) {
            return APIResponse::error($e->getMessage(), 500);
        }
    }

    private function triggerMallSync(string $sku): void
    {
        // 非同期でモール同期を実行
        $job_queue = new JobQueue();
        $job_queue->enqueue('mall_sync', [
            'sku' => $sku,
            'trigger' => 'spreadsheet_update',
            'priority' => 'high'
        ]);
    }
}
```

## 🎨 5. UI/UX 設計（N3 準拠）

### 5.1 メインダッシュボード設計

```html
<!-- modules/multi_mall_inventory/templates/dashboard.php -->
<div class="inventory-dashboard">
  <!-- KPIカード -->
  <div class="kpi-cards-grid">
    <div class="kpi-card">
      <div class="kpi-title">総在庫商品数</div>
      <div class="kpi-value" id="total-products">0</div>
      <div class="kpi-trend positive">+12 (今月)</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-title">在庫切れアラート</div>
      <div class="kpi-value danger" id="out-of-stock">0</div>
      <div class="kpi-trend negative">要注意</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-title">同期エラー</div>
      <div class="kpi-value warning" id="sync-errors">0</div>
      <div class="kpi-trend">24h内</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-title">総出品数</div>
      <div class="kpi-value" id="total-listings">0</div>
      <div class="kpi-trend positive">5モール合計</div>
    </div>
  </div>

  <!-- クイックアクション -->
  <div class="quick-actions">
    <button class="btn btn-primary" onclick="openNewProductModal()">
      <i class="icon-plus"></i> 新規商品登録
    </button>
    <button class="btn btn-secondary" onclick="openBulkImportModal()">
      <i class="icon-upload"></i> 一括インポート
    </button>
    <button class="btn btn-info" onclick="syncAllMalls()">
      <i class="icon-sync"></i> 全モール同期
    </button>
    <button class="btn btn-success" onclick="openSpreadsheetSync()">
      <i class="icon-table"></i> スプレッドシート連携
    </button>
  </div>

  <!-- 在庫アラート -->
  <div class="inventory-alerts" id="inventory-alerts">
    <!-- 動的に生成される在庫アラート -->
  </div>

  <!-- 最近の活動 -->
  <div class="recent-activity">
    <h3>最近の在庫変動</h3>
    <div class="activity-list" id="recent-activity-list">
      <!-- 動的に生成される活動履歴 -->
    </div>
  </div>
</div>
```

### 5.2 商品管理 UI（Excel 風表示）

```html
<!-- 商品一覧（Excel風表示） -->
<div class="inventory-grid" id="inventory-grid">
  <div class="grid-header">
    <div class="grid-cell">SKU</div>
    <div class="grid-cell">商品名</div>
    <div class="grid-cell">物理在庫</div>
    <div class="grid-cell">表示在庫</div>
    <div class="grid-cell">eBay1</div>
    <div class="grid-cell">eBay2</div>
    <div class="grid-cell">メルカリ</div>
    <div class="grid-cell">Yahoo</div>
    <div class="grid-cell">Amazon</div>
    <div class="grid-cell">最終更新</div>
    <div class="grid-cell">アクション</div>
  </div>

  <div class="grid-body" id="products-grid-body">
    <!-- JavaScript動的生成 -->
  </div>
</div>
```

### 5.3 JavaScript 制御システム

```javascript
// assets/js/multi_mall_inventory.js
class MultiMallInventorySystem {
  constructor() {
    this.apiBase = "/modules/multi_mall_inventory/api/";
    this.currentView = "dashboard";
    this.products = new Map();
    this.syncStatus = new Map();

    this.initializeSystem();
  }

  async initializeSystem() {
    try {
      // 初期データ読み込み
      await this.loadDashboardData();
      await this.loadProductsList();

      // リアルタイム更新開始
      this.startRealTimeUpdates();

      // UI イベントリスナー設定
      this.setupEventListeners();

      console.log("多モール在庫管理システム初期化完了");
    } catch (error) {
      console.error("システム初期化エラー:", error);
      this.showError("システム初期化に失敗しました");
    }
  }

  async loadDashboardData() {
    const response = await fetch(
      `${this.apiBase}dashboard_api.php?action=get_kpi`
    );
    const data = await response.json();

    if (data.success) {
      this.updateKPICards(data.data);
    }
  }

  updateKPICards(kpiData) {
    document.getElementById("total-products").textContent =
      kpiData.total_products;
    document.getElementById("out-of-stock").textContent = kpiData.out_of_stock;
    document.getElementById("sync-errors").textContent = kpiData.sync_errors;
    document.getElementById("total-listings").textContent =
      kpiData.total_listings;
  }

  async updateInventory(sku, field, value) {
    try {
      const response = await fetch(`${this.apiBase}inventory_api.php`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          action: "update_inventory",
          sku: sku,
          field: field,
          value: value,
        }),
      });

      const result = await response.json();

      if (result.success) {
        this.showSuccess(`${sku}の${field}を更新しました`);
        this.refreshProduct(sku);

        // スプレッドシート同期
        await this.syncToSpreadsheet(sku);

        // モール同期トリガー
        await this.triggerMallSync(sku);
      } else {
        this.showError(result.error.message);
      }
    } catch (error) {
      console.error("在庫更新エラー:", error);
      this.showError("在庫更新に失敗しました");
    }
  }

  startRealTimeUpdates() {
    // WebSocket接続でリアルタイム更新
    if ("WebSocket" in window) {
      this.websocket = new WebSocket("ws://localhost:8080/inventory-updates");

      this.websocket.onmessage = (event) => {
        const update = JSON.parse(event.data);
        this.handleRealTimeUpdate(update);
      };
    } else {
      // ポーリングフォールバック
      setInterval(() => this.pollForUpdates(), 30000);
    }
  }

  handleRealTimeUpdate(update) {
    switch (update.type) {
      case "inventory_change":
        this.updateProductRow(update.sku, update.data);
        break;
      case "sync_status":
        this.updateSyncStatus(update.sku, update.mall, update.status);
        break;
      case "alert":
        this.showAlert(update.message, update.level);
        break;
    }
  }
}

// システム初期化
document.addEventListener("DOMContentLoaded", () => {
  window.inventorySystem = new MultiMallInventorySystem();
});
```

## 📊 6. Hook 活用開発戦略

### 6.1 必須 Hook 活用

**`18_development_project_manager.py`**:

- プロジェクトマイルストーン管理
- 進捗追跡・品質管理
- リソース配分最適化

**`20_code_quality_monitor_hook.py`**:

- コード品質スコア監視
- セキュリティ脆弱性検出
- パフォーマンス最適化提案

**`22_auto_test_generation_hook.py`**:

- 単体テスト自動生成
- 統合テスト実行
- API テスト自動化

### 6.2 Hook 統合開発プロセス

```python
# hooks/1_essential/25_inventory_system_development_hook.py
class InventorySystemDevelopmentHook:
    def __init__(self):
        self.project_manager = self.load_hook('18_development_project_manager.py')
        self.quality_monitor = self.load_hook('20_code_quality_monitor_hook.py')
        self.test_generator = self.load_hook('22_auto_test_generation_hook.py')

    def execute_development_phase(self, phase_name, requirements):
        # Phase 1: 設計・計画
        if phase_name == 'design':
            return self.project_manager.create_development_plan(requirements)

        # Phase 2: 実装
        elif phase_name == 'implementation':
            return self.implement_with_quality_monitoring(requirements)

        # Phase 3: テスト
        elif phase_name == 'testing':
            return self.test_generator.generate_comprehensive_tests(requirements)

        # Phase 4: 統合
        elif phase_name == 'integration':
            return self.integrate_with_n3_system(requirements)

    def implement_with_quality_monitoring(self, requirements):
        implementation_result = {
            'files_created': [],
            'quality_scores': {},
            'security_checks': {},
            'performance_analysis': {}
        }

        for component in requirements['components']:
            # 実装
            file_path = self.generate_component_file(component)
            implementation_result['files_created'].append(file_path)

            # 品質チェック
            quality_score = self.quality_monitor.analyze_file(file_path)
            implementation_result['quality_scores'][component['name']] = quality_score

            # セキュリティチェック
            security_result = self.quality_monitor.security_scan(file_path)
            implementation_result['security_checks'][component['name']] = security_result

        return implementation_result
```

## 🚀 7. 段階的実装計画

### Phase 1: 基盤構築（1-2 週間）

1. **データベーススキーマ設計・実装**
2. **N3 システム統合確認**
3. **基本 API エンドポイント実装**
4. **Hook 統合システム構築**

### Phase 2: コア機能実装（2-3 週間）

1. **在庫管理システム実装**
2. **eBay 2 アカウント統合**
3. **基本 UI 実装（ダッシュボード・商品一覧）**
4. **PostgreSQL 最適化**

### Phase 3: モール連携拡張（2-3 週間）

1. **メルカリ API 統合**
2. **Yahoo・Amazon API 統合**
3. **セット品管理システム**
4. **画像管理システム**

### Phase 4: 高度機能実装（2-3 週間）

1. **Google Sheets 完全統合**
2. **リアルタイム同期システム**
3. **アラート・通知システム**
4. **レポート・分析機能**

### Phase 5: 最適化・本番化（1-2 週間）

1. **パフォーマンス最適化**
2. **セキュリティ強化**
3. **本番環境デプロイ**
4. **運用監視システム**

## 🔒 8. セキュリティ設計

### 8.1 認証・認可システム

```php
<?php
class InventorySecurityManager
{
    private $session_handler;
    private $access_control;

    public function validateAPIAccess(string $endpoint, array $user_context): bool
    {
        // APIキー検証
        if (!$this->validateAPIKey($_SERVER['HTTP_AUTHORIZATION'] ?? '')) {
            throw new UnauthorizedException('Invalid API key');
        }

        // ユーザー権限確認
        $required_permission = $this->getRequiredPermission($endpoint);
        if (!$this->access_control->userHasPermission($user_context['user_id'], $required_permission)) {
            throw new ForbiddenException('Insufficient permissions');
        }

        // レート制限確認
        if (!$this->checkRateLimit($user_context['user_id'], $endpoint)) {
            throw new TooManyRequestsException('Rate limit exceeded');
        }

        return true;
    }

    public function sanitizeInventoryInput(array $input): array
    {
        $sanitized = [];

        foreach ($input as $key => $value) {
            switch ($key) {
                case 'sku':
                    $sanitized[$key] = $this->sanitizeSKU($value);
                    break;
                case 'quantity':
                    $sanitized[$key] = $this->sanitizeQuantity($value);
                    break;
                case 'product_name':
                    $sanitized[$key] = $this->sanitizeProductName($value);
                    break;
                default:
                    $sanitized[$key] = $this->sanitizeGeneral($value);
            }
        }

        return $sanitized;
    }
}
```

### 8.2 データ保護・暗号化

```php
<?php
class DataProtectionManager
{
    private $encryption_key;

    public function encryptSensitiveData(array $data): array
    {
        $sensitive_fields = ['api_keys', 'tokens', 'passwords'];

        foreach ($data as $key => $value) {
            if (in_array($key, $sensitive_fields)) {
                $data[$key] = $this->encrypt($value);
            }
        }

        return $data;
    }

    public function auditInventoryChange(string $sku, array $changes, string $user_id): void
    {
        $audit_record = [
            'timestamp' => microtime(true),
            'sku' => $sku,
            'changes' => $changes,
            'user_id' => $user_id,
            'ip_address' => $_SERVER['REMOTE_ADDR'],
            'user_agent' => $_SERVER['HTTP_USER_AGENT'],
            'session_id' => session_id()
        ];

        // セキュアログ保存
        $this->writeSecureAuditLog($audit_record);
    }
}
```

## 📈 9. パフォーマンス最適化

### 9.1 データベース最適化戦略

```sql
-- インデックス戦略
CREATE INDEX CONCURRENTLY idx_products_search ON products
USING GIN(to_tsvector('english', product_name));

CREATE INDEX idx_mall_listings_sync ON mall_listings(sync_status, last_sync)
WHERE sync_status IN ('pending', 'error');

CREATE INDEX idx_products_low_stock ON products(physical_quantity, listing_quantity)
WHERE physical_quantity <= 5;

-- パーティション戦略（履歴テーブル）
CREATE TABLE inventory_history (
    id SERIAL,
    sku VARCHAR(50),
    change_type VARCHAR(20),
    old_values JSONB,
    new_values JSONB,
    changed_at TIMESTAMP DEFAULT NOW(),
    changed_by VARCHAR(50)
) PARTITION BY RANGE (changed_at);

CREATE TABLE inventory_history_2025_q1
PARTITION OF inventory_history
FOR VALUES FROM ('2025-01-01') TO ('2025-04-01');

-- マテリアライズドビュー（レポート用）
CREATE MATERIALIZED VIEW inventory_summary AS
SELECT
    COUNT(*) as total_products,
    COUNT(*) FILTER (WHERE physical_quantity = 0) as out_of_stock,
    COUNT(*) FILTER (WHERE physical_quantity <= 5) as low_stock,
    AVG(physical_quantity) as avg_stock_level,
    SUM(CASE WHEN product_type = 'set' THEN 1 ELSE 0 END) as set_products
FROM products
WHERE status = 'active';

-- インデックスの自動更新
CREATE UNIQUE INDEX ON inventory_summary (total_products);
REFRESH MATERIALIZED VIEW CONCURRENTLY inventory_summary;
```

### 9.2 キャッシュ戦略

```php
<?php
class InventoryCacheManager
{
    private $redis;
    private $cache_ttl = [
        'product_data' => 3600,      // 1時間
        'mall_listings' => 1800,     // 30分
        'dashboard_kpi' => 300,      // 5分
        'sync_status' => 60          // 1分
    ];

    public function getProductWithCache(string $sku): ?array
    {
        $cache_key = "product:{$sku}";

        // キャッシュ確認
        $cached = $this->redis->get($cache_key);
        if ($cached) {
            return json_decode($cached, true);
        }

        // データベースから取得
        $product = $this->database->getProduct($sku);

        if ($product) {
            // キャッシュに保存
            $this->redis->setex(
                $cache_key,
                $this->cache_ttl['product_data'],
                json_encode($product)
            );
        }

        return $product;
    }

    public function invalidateProductCache(string $sku): void
    {
        $this->redis->del("product:{$sku}");

        // 関連キャッシュも無効化
        $this->redis->del("dashboard:kpi");
        $this->redis->del("product_list:*");
    }
}
```

## 🧪 10. テスト戦略

### 10.1 自動テスト実装

```php
<?php
// tests/Integration/InventoryAPITest.php
class InventoryAPITest extends TestCase
{
    public function setUp(): void
    {
        parent::setUp();
        $this->database = new TestDatabaseManager();
        $this->api = new InventoryAPI($this->database);
    }

    public function testUpdatePhysicalStock(): void
    {
        // テストデータ準備
        $test_sku = 'TEST-PRODUCT-001';
        $this->database->createTestProduct($test_sku, [
            'physical_quantity' => 10,
            'listing_quantity' => 8
        ]);

        // API呼び出し
        $result = $this->api->updatePhysicalStock($test_sku, 20);

        // 結果検証
        $this->assertTrue($result['success']);
        $this->assertEquals(20, $result['data']['physical_quantity']);

        // データベース確認
        $product = $this->database->getProduct($test_sku);
        $this->assertEquals(20, $product['physical_quantity']);
    }

    public function testInventoryConstraints(): void
    {
        $test_sku = 'TEST-CONSTRAINT-001';
        $this->database->createTestProduct($test_sku, [
            'physical_quantity' => 5,
            'listing_quantity' => 3,
            'is_physical_stock' => true
        ]);

        // 制約違反テスト: 表示在庫 > 物理在庫
        $result = $this->api->updateListingQuantity($test_sku, 10);

        $this->assertFalse($result['success']);
        $this->assertStringContains('exceeds physical quantity', $result['error']['message']);
    }
}
```

### 10.2 統合テスト（Hook 活用）

```python
# hooks/1_essential/26_inventory_integration_test_hook.py
class InventoryIntegrationTestHook:
    def execute_comprehensive_test(self):
        test_scenarios = [
            'basic_inventory_operations',
            'mall_synchronization',
            'spreadsheet_integration',
            'set_product_management',
            'concurrent_access_handling',
            'error_recovery_scenarios'
        ]

        results = {}

        for scenario in test_scenarios:
            try:
                test_result = self.run_test_scenario(scenario)
                results[scenario] = test_result
            except Exception as e:
                results[scenario] = {'status': 'failed', 'error': str(e)}

        return {
            'overall_status': self.determine_overall_status(results),
            'test_results': results,
            'recommendations': self.generate_recommendations(results)
        }

    def run_test_scenario(self, scenario_name):
        if scenario_name == 'mall_synchronization':
            return self.test_mall_sync_scenario()
        elif scenario_name == 'spreadsheet_integration':
            return self.test_spreadsheet_scenario()
        # ... 他のシナリオ

    def test_mall_sync_scenario(self):
        # 1. テストデータ作成
        test_products = self.create_test_inventory()

        # 2. モール同期実行
        sync_results = self.trigger_mall_sync(test_products)

        # 3. 同期結果確認
        verification_results = self.verify_sync_results(sync_results)

        return {
            'status': 'passed' if verification_results['all_synced'] else 'failed',
            'details': verification_results
        }
```

## 📋 11. 運用・監視設計

### 11.1 システム監視

```php
<?php
class InventorySystemMonitor
{
    private $metrics_collector;
    private $alert_manager;

    public function collectSystemMetrics(): array
    {
        return [
            'database_performance' => $this->collectDatabaseMetrics(),
            'api_performance' => $this->collectAPIMetrics(),
            'mall_sync_status' => $this->collectSyncMetrics(),
            'inventory_health' => $this->collectInventoryMetrics(),
            'system_resources' => $this->collectResourceMetrics()
        ];
    }

    public function checkInventoryAlerts(): array
    {
        $alerts = [];

        // 在庫切れアラート
        $out_of_stock = $this->database->getOutOfStockProducts();
        if (count($out_of_stock) > 0) {
            $alerts[] = [
                'level' => 'warning',
                'type' => 'out_of_stock',
                'count' => count($out_of_stock),
                'products' => array_slice($out_of_stock, 0, 5)
            ];
        }

        // 同期エラーアラート
        $sync_errors = $this->database->getSyncErrors();
        if (count($sync_errors) > 0) {
            $alerts[] = [
                'level' => 'error',
                'type' => 'sync_error',
                'count' => count($sync_errors),
                'errors' => array_slice($sync_errors, 0, 10)
            ];
        }

        return $alerts;
    }
}
```

### 11.2 バックアップ・復旧

```bash
#!/bin/bash
# backup/inventory_backup.sh

BACKUP_DIR="/var/backups/nagano3/inventory"
DB_NAME="nagano3_inventory"
DATE=$(date +%Y%m%d_%H%M%S)

# データベースバックアップ
echo "データベースバックアップ開始: $DATE"
pg_dump -h localhost -U postgres $DB_NAME | gzip > "$BACKUP_DIR/db_backup_$DATE.sql.gz"

# ファイルバックアップ
echo "ファイルバックアップ開始"
tar -czf "$BACKUP_DIR/files_backup_$DATE.tar.gz" \
    /var/www/nagano3/modules/multi_mall_inventory \
    /var/www/nagano3/uploads/inventory_images

# 古いバックアップクリーンアップ（30日以上古い）
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete

# バックアップ整合性確認
echo "バックアップ整合性確認"
gunzip -t "$BACKUP_DIR/db_backup_$DATE.sql.gz"
tar -tzf "$BACKUP_DIR/files_backup_$DATE.tar.gz" > /dev/null

echo "バックアップ完了: $DATE"
```

## 📊 12. 成果物・納期管理

### 12.1 マイルストーン管理

| Phase   | 納期    | 主要成果物        | 完了基準                        |
| ------- | ------- | ----------------- | ------------------------------- |
| Phase 1 | Week 2  | DB 設計、基本 API | PostgreSQL 稼働、基本 CRUD 完了 |
| Phase 2 | Week 5  | コア機能実装      | 在庫管理、eBay 連携完了         |
| Phase 3 | Week 8  | モール連携拡張    | 5 モール連携完了                |
| Phase 4 | Week 11 | 高度機能実装      | Google Sheets 連携完了          |
| Phase 5 | Week 13 | 本番化完了        | 本番環境稼働開始                |

### 12.2 品質管理指標

- **コードカバレッジ**: 85%以上
- **API レスポンス時間**: 95%が 500ms 以内
- **同期成功率**: 99%以上
- **セキュリティスキャン**: 脆弱性ゼロ
- **システム可用性**: 99.9%以上

## 🎯 13. まとめ・推奨事項

### 13.1 開発成功要因

1. **既存資産の最大活用**: ebay_complete_dashboard_fixed.php 等の実績あるコンポーネント活用
2. **段階的実装**: リスクを最小化した段階的デリバリー
3. **Hook 統合開発**: CAIDS Hook システムによる自動品質管理・テスト実行
4. **N3 完全準拠**: 既存システムとの完全互換性確保

### 13.2 技術的推奨事項

1. **PostgreSQL 最適化**: パーティション・インデックス戦略による高速化
2. **キャッシュ戦略**: Redis 活用による応答性能向上
3. **リアルタイム同期**: WebSocket + Google Apps Script 連携
4. **セキュリティ強化**: 多層防御・監査ログ・暗号化

### 13.3 運用推奨事項

1. **継続的監視**: システム監視・アラート・自動復旧システム構築
2. **定期バックアップ**: 自動化されたバックアップ・復旧プロセス
3. **ドキュメント整備**: 技術文書・運用マニュアル・API 仕様書
4. **チーム知識共有**: Hook 統合開発プロセス・トラブルシューティング

このシステムにより、**5 つのモール + 実在庫 + Google スプレッドシート**の統合管理が実現し、**リアルタイム同期**による正確な在庫管理と**効率的な多チャネル販売**が可能になります。

🎯 多モール在庫管理システム 高度フィルター・UI 改善指示書
📋 プロジェクト概要
対象ファイル: multi_mall_inventory_system5.html
実装目標: 高度フィルター機能 + 折りたたみ UI + 既存システム統合
開発戦略: Claude・Gemini 協働開発による効率化

🛠️ 実装要件詳細

1. 高度フィルター機能の実装
   1.1 価格フィルター
   javascript// 価格帯フィルター（モール別対応）
   const priceFilters = {
   ebay: ['0-50', '50-200', '200-500', '500+'],
   mercari: ['0-1000', '1000-5000', '5000-10000', '10000+'],
   yahoo: ['0-5000', '5000-20000', '20000+'],
   amazon: ['0-100', '100-500', '500+']
   };
   1.2 在庫タイプフィルター
   javascript// 在庫タイプ分類システム
   const stockTypeFilters = {
   physical: { label: '有在庫', field: 'is_physical_stock', value: true },
   dropship: { label: '無在庫', field: 'is_physical_stock', value: false },
   set: { label: 'セット品', field: 'product_type', value: 'set' }
   };
   1.3 動的カテゴリフィルター
   javascript// カテゴリ動的生成システム
   function generateCategoryFilter(products) {
   const categories = [...new Set(products.map(p => p.category))];
   return categories.filter(cat => cat && cat !== 'Uncategorized');
   }
2. UI 折りたたみ機能
2.1 折りたたみコンテナ設計
html<div class="collapsible-container" id="header-section">
<div class="collapsible-content">
<!-- ヘッダー・統計・フィルター -->
</div>
<button class="collapse-toggle" onclick="toggleHeaderCollapse()">
<i class="fas fa-chevron-up" id="collapse-icon"></i>
</button>
</div>
2.2 アニメーション実装
css.collapsible-container {
    transition: max-height 0.3s ease-in-out;
    overflow: hidden;
}

.collapsible-container--collapsed {
max-height: 60px;
}

.collapse-toggle {
position: absolute;
bottom: 8px;
right: 16px;
background: rgba(255, 255, 255, 0.9);
border-radius: 50%;
transition: transform 0.3s ease;
}

🎯 多モール在庫管理システム 高度フィルター・UI 改善指示書
📋 プロジェクト概要
対象ファイル: multi_mall_inventory_system5.html
実装目標: 高度フィルター機能 + 折りたたみ UI + 既存システム統合
開発戦略: Claude・Gemini 協働開発による効率化

🛠️ 実装要件詳細

1. 高度フィルター機能の実装
   1.1 価格フィルター
   javascript// 価格帯フィルター（モール別対応）
   const priceFilters = {
   ebay: ['0-50', '50-200', '200-500', '500+'],
   mercari: ['0-1000', '1000-5000', '5000-10000', '10000+'],
   yahoo: ['0-5000', '5000-20000', '20000+'],
   amazon: ['0-100', '100-500', '500+']
   };
   1.2 在庫タイプフィルター
   javascript// 在庫タイプ分類システム
   const stockTypeFilters = {
   physical: { label: '有在庫', field: 'is_physical_stock', value: true },
   dropship: { label: '無在庫', field: 'is_physical_stock', value: false },
   set: { label: 'セット品', field: 'product_type', value: 'set' }
   };
   1.3 動的カテゴリフィルター
   javascript// カテゴリ動的生成システム
   function generateCategoryFilter(products) {
   const categories = [...new Set(products.map(p => p.category))];
   return categories.filter(cat => cat && cat !== 'Uncategorized');
   }
2. UI 折りたたみ機能
2.1 折りたたみコンテナ設計
html<div class="collapsible-container" id="header-section">
<div class="collapsible-content">
<!-- ヘッダー・統計・フィルター -->
</div>
<button class="collapse-toggle" onclick="toggleHeaderCollapse()">
<i class="fas fa-chevron-up" id="collapse-icon"></i>
</button>
</div>
2.2 アニメーション実装
css.collapsible-container {
    transition: max-height 0.3s ease-in-out;
    overflow: hidden;
}

.collapsible-container--collapsed {
max-height: 60px;
}

.collapse-toggle {
position: absolute;
bottom: 8px;
right: 16px;
background: rgba(255, 255, 255, 0.9);
border-radius: 50%;
transition: transform 0.3s ease;
}
