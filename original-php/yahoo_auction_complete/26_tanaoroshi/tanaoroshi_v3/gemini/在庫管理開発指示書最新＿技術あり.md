# å¤šãƒ¢ãƒ¼ãƒ«åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  å®Œå…¨é–‹ç™ºæŠ€è¡“æ›¸ï¼ˆNAGANO-3 çµ±åˆç‰ˆï¼‰

## ğŸ“‹ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: å¤šãƒ¢ãƒ¼ãƒ«åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆNAGANO-3 çµ±åˆç‰ˆï¼‰  
**å¯¾è±¡ãƒ¢ãƒ¼ãƒ«**: eBayÃ—2 + ãƒ¡ãƒ«ã‚«ãƒª + Yahoo + Amazon + å®Ÿåœ¨åº« + Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ  
**æŠ€è¡“åŸºç›¤**: PHP 8.0+, PostgreSQL 13+, N3 ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨æº–æ‹   
**é–‹ç™ºæˆ¦ç•¥**: æ—¢å­˜è³‡ç”£æœ€å¤§æ´»ç”¨ + æ®µéšçš„çµ±åˆ + Hook æ´»ç”¨é–‹ç™º

## ğŸ¯ 1. ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1.1 ã‚³ã‚¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æˆ¦ç•¥

```
NAGANO-3 Base System
â”œâ”€â”€ Multi-Mall Inventory Module
â”‚   â”œâ”€â”€ Data Layer (PostgreSQL)
â”‚   â”œâ”€â”€ API Integration Layer
â”‚   â”œâ”€â”€ Business Logic Layer
â”‚   â””â”€â”€ Presentation Layer (N3æº–æ‹ )
â”œâ”€â”€ Hook Integration System
â””â”€â”€ External Integrations (Google Sheets API)
```

### 1.2 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯è©³ç´°

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**:

- **PHP 8.0+**: PSR-4 æº–æ‹ ã€åå‰ç©ºé–“æ´»ç”¨
- **PostgreSQL 13+**: JSONB æ´»ç”¨ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–
- **Composer**: ä¾å­˜é–¢ä¿‚ç®¡ç†ã€ã‚ªãƒ¼ãƒˆãƒ­ãƒ¼ãƒ€ãƒ¼

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**:

- **N3 çµ±ä¸€ CSS**: æ—¢å­˜ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ æº–æ‹ 
- **JavaScript ES6+**: ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼è¨­è¨ˆã€éåŒæœŸå‡¦ç†
- **Ajax**: éåŒæœŸé€šä¿¡ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

**å¤–éƒ¨é€£æº**:

- **Google Sheets API v4**: åŒæ–¹å‘åŒæœŸ
- **å„ãƒ¢ãƒ¼ãƒ« API**: eBay, ãƒ¡ãƒ«ã‚«ãƒª, Yahoo, Amazon
- **Google Apps Script**: ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥

## ğŸ—ï¸ 2. ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆè¦ç´ è©³ç´°

### 2.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼ˆPostgreSQLï¼‰

#### å•†å“ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    sku VARCHAR(50) UNIQUE NOT NULL,
    product_name VARCHAR(500) NOT NULL,
    physical_quantity INTEGER DEFAULT 0,
    listing_quantity INTEGER DEFAULT 0,
    is_physical_stock BOOLEAN NOT NULL,
    product_type VARCHAR(20) DEFAULT 'single',
    status VARCHAR(20) DEFAULT 'active',
    image_url VARCHAR(255),
    additional_images JSONB,
    price_data JSONB,
    supplier_info JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    CONSTRAINT ck_physical_listing CHECK (listing_quantity <= physical_quantity OR NOT is_physical_stock),
    CONSTRAINT ck_product_type CHECK (product_type IN ('single', 'set', 'component'))
);

-- SKUãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒ«ãƒ¼ãƒ«
-- P-: æœ‰åœ¨åº«å•†å“ (is_physical_stock = true)
-- D-: ç„¡åœ¨åº«å•†å“ (is_physical_stock = false)
-- S-: ã‚»ãƒƒãƒˆå•†å“
-- C-: ã‚»ãƒƒãƒˆæ§‹æˆå“å°‚ç”¨

CREATE INDEX idx_products_sku ON products(sku);
CREATE INDEX idx_products_type_status ON products(product_type, status);
CREATE INDEX idx_products_stock_level ON products(physical_quantity, listing_quantity);
```

#### ãƒ¢ãƒ¼ãƒ«å‡ºå“ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE mall_listings (
    id SERIAL PRIMARY KEY,
    sku VARCHAR(50) REFERENCES products(sku) ON UPDATE CASCADE,
    mall_type VARCHAR(20) NOT NULL,
    external_id VARCHAR(100) NOT NULL,
    listing_title VARCHAR(255),
    listing_price DECIMAL(10,2),
    listing_quantity INTEGER,
    listing_status VARCHAR(20) DEFAULT 'draft',
    sync_status VARCHAR(20) DEFAULT 'pending',
    last_sync TIMESTAMP DEFAULT NOW(),
    sync_metadata JSONB,
    error_message TEXT,

    UNIQUE(sku, mall_type),
    CONSTRAINT ck_mall_type CHECK (mall_type IN ('ebay1', 'ebay2', 'mercari', 'yahoo', 'amazon'))
);
```

#### ã‚»ãƒƒãƒˆå“æ§‹æˆãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE set_components (
    set_sku VARCHAR(50) REFERENCES products(sku),
    component_sku VARCHAR(50) REFERENCES products(sku),
    quantity_per_set INTEGER NOT NULL CHECK (quantity_per_set > 0),
    component_cost DECIMAL(10,2),
    PRIMARY KEY (set_sku, component_sku)
);
```

### 2.2 API ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

#### çµ±ä¸€ API ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼

```php
<?php
class APIResponse
{
    public static function success($data = null, $message = 'Success'): array
    {
        return [
            'success' => true,
            'data' => $data,
            'message' => $message,
            'timestamp' => date('c'),
            'source' => self::getSourceIdentifier()
        ];
    }

    public static function error($message, $code = 400, $details = null): array
    {
        return [
            'success' => false,
            'error' => [
                'message' => $message,
                'code' => $code,
                'details' => $details
            ],
            'timestamp' => date('c'),
            'source' => self::getSourceIdentifier()
        ];
    }
}
```

#### åœ¨åº«ç®¡ç† API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­è¨ˆ

```php
// modules/multi_mall_inventory/api/inventory_api.php
<?php
if (!defined('SECURE_ACCESS')) die('Direct access not allowed');

class InventoryAPI
{
    private $db;
    private $validator;
    private $auditLogger;

    public function __construct()
    {
        $this->db = DatabaseConnection::getInstance();
        $this->validator = new InventoryValidator();
        $this->auditLogger = new AuditLogger();
    }

    public function updatePhysicalStock(string $sku, int $quantity): array
    {
        try {
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            $this->validator->validateSKU($sku);
            $this->validator->validateQuantity($quantity);

            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
            $this->db->beginTransaction();

            // åœ¨åº«æ›´æ–°
            $result = $this->db->execute(
                "UPDATE products SET physical_quantity = ?, updated_at = NOW() WHERE sku = ?",
                [$quantity, $sku]
            );

            if ($result->rowCount() === 0) {
                throw new NotFoundException("Product not found: {$sku}");
            }

            // è¡¨ç¤ºåœ¨åº«è‡ªå‹•èª¿æ•´
            $this->autoAdjustListingQuantity($sku);

            // ã‚»ãƒƒãƒˆå“åœ¨åº«è‡ªå‹•æ›´æ–°
            $this->updateSetProductAvailability($sku);

            // ç›£æŸ»ãƒ­ã‚°
            $this->auditLogger->logInventoryChange($sku, 'physical_stock_update', [
                'old_quantity' => $this->getPreviousQuantity($sku),
                'new_quantity' => $quantity
            ]);

            $this->db->commit();

            return APIResponse::success([
                'sku' => $sku,
                'physical_quantity' => $quantity,
                'listing_quantity' => $this->getListingQuantity($sku),
                'affected_sets' => $this->getAffectedSets($sku)
            ]);

        } catch (Exception $e) {
            $this->db->rollback();
            return APIResponse::error($e->getMessage(), 500);
        }
    }

    private function autoAdjustListingQuantity(string $sku): void
    {
        $product = $this->getProduct($sku);

        if ($product['is_physical_stock']) {
            // æœ‰åœ¨åº«å•†å“: è¡¨ç¤ºåœ¨åº« > ç‰©ç†åœ¨åº«ã®å ´åˆã¯è‡ªå‹•èª¿æ•´
            if ($product['listing_quantity'] > $product['physical_quantity']) {
                $newListingQty = max(0, $product['physical_quantity'] - 1); // å®‰å…¨åœ¨åº«1å€‹

                $this->db->execute(
                    "UPDATE products SET listing_quantity = ? WHERE sku = ?",
                    [$newListingQty, $sku]
                );
            }
        }
    }
}
```

### 2.3 N3 ã‚·ã‚¹ãƒ†ãƒ çµ±åˆè¨­è¨ˆ

#### ãƒ¡ã‚¤ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ï¼ˆN3 æº–æ‹ ï¼‰

```php
<?php
// modules/multi_mall_inventory/multi_mall_inventory.php
if (!defined('SECURE_ACCESS')) {
    define('SECURE_ACCESS', true);
}

require_once __DIR__ . '/../../config/database.php';
require_once __DIR__ . '/../../includes/functions.php';
require_once __DIR__ . '/../../includes/security.php';

class MultiMallInventoryModule
{
    private $page_title = "å¤šãƒ¢ãƒ¼ãƒ«åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ";
    private $module_version = "1.0.0";

    public function render(): string
    {
        // N3ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèª
        SecurityHelper::validateAccess();

        // ãƒšãƒ¼ã‚¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
        $sub_page = $_GET['sub'] ?? 'dashboard';
        $allowed_pages = ['dashboard', 'inventory', 'listings', 'sync', 'settings'];

        if (!in_array($sub_page, $allowed_pages)) {
            $sub_page = 'dashboard';
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼å‡ºåŠ›
        $html = $this->renderHeader();

        // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
        switch ($sub_page) {
            case 'inventory':
                $html .= $this->renderInventoryManagement();
                break;
            case 'listings':
                $html .= $this->renderListingManagement();
                break;
            case 'sync':
                $html .= $this->renderSyncManagement();
                break;
            case 'settings':
                $html .= $this->renderSettings();
                break;
            default:
                $html .= $this->renderDashboard();
        }

        // ãƒ•ãƒƒã‚¿ãƒ¼å‡ºåŠ›
        $html .= $this->renderFooter();

        return $html;
    }

    private function renderHeader(): string
    {
        return <<<HTML
<div class="multi-mall-inventory-container">
    <div class="inventory-header">
        <h1>{$this->page_title}</h1>
        <div class="inventory-nav">
            <a href="?page=multi_mall_inventory&sub=dashboard" class="nav-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            <a href="?page=multi_mall_inventory&sub=inventory" class="nav-link">åœ¨åº«ç®¡ç†</a>
            <a href="?page=multi_mall_inventory&sub=listings" class="nav-link">å‡ºå“ç®¡ç†</a>
            <a href="?page=multi_mall_inventory&sub=sync" class="nav-link">åŒæœŸç®¡ç†</a>
            <a href="?page=multi_mall_inventory&sub=settings" class="nav-link">è¨­å®š</a>
        </div>
    </div>
HTML;
    }
}

// N3çµ±åˆç”¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
$multi_mall_inventory = new MultiMallInventoryModule();
echo $multi_mall_inventory->render();
```

## ğŸ”§ 3. æ—¢å­˜è³‡ç”£æ´»ç”¨æˆ¦ç•¥

### 3.1 ebay_complete_dashboard_fixed.php æ´»ç”¨

æ—¢å­˜ã®`ebay_complete_dashboard_fixed.php`ã‚’åŸºç›¤ã¨ã—ã¦ã€2 ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¯¾å¿œã«æ‹¡å¼µ:

```php
<?php
class ExtendedEbayIntegration extends EbayCompleteDashboard
{
    private $account_configs = [
        'account_1' => [
            'app_id' => getenv('EBAY_APP_ID_1'),
            'dev_id' => getenv('EBAY_DEV_ID_1'),
            'cert_id' => getenv('EBAY_CERT_ID_1'),
            'token' => getenv('EBAY_TOKEN_1'),
            'site_id' => 0 // US
        ],
        'account_2' => [
            'app_id' => getenv('EBAY_APP_ID_2'),
            'dev_id' => getenv('EBAY_DEV_ID_2'),
            'cert_id' => getenv('EBAY_CERT_ID_2'),
            'token' => getenv('EBAY_TOKEN_2'),
            'site_id' => 0 // US
        ]
    ];

    public function syncAllAccounts(): array
    {
        $results = [];

        foreach ($this->account_configs as $account_id => $config) {
            try {
                $this->setCurrentAccount($config);
                $sync_result = $this->performSync();
                $results[$account_id] = $sync_result;
            } catch (Exception $e) {
                $results[$account_id] = ['error' => $e->getMessage()];
            }
        }

        return $results;
    }
}
```

### 3.2 PostgreSQL é€£æºå¼·åŒ–

æ—¢å­˜ã® PostgreSQL æ¥ç¶šã‚’æ´»ç”¨ã—ã€åœ¨åº«ç®¡ç†ç‰¹åŒ–ã®æœ€é©åŒ–:

```php
<?php
class InventoryDatabaseManager extends PostgreSQLConnection
{
    public function createInventoryTransaction(): DatabaseTransaction
    {
        return new DatabaseTransaction($this->connection, [
            'isolation_level' => 'READ COMMITTED',
            'lock_timeout' => 5000,
            'statement_timeout' => 30000
        ]);
    }

    public function getInventoryWithLocking(array $skus): array
    {
        $placeholders = str_repeat('?,', count($skus) - 1) . '?';

        return $this->executeQuery(
            "SELECT * FROM products WHERE sku IN ({$placeholders}) FOR UPDATE",
            $skus
        );
    }

    public function bulkUpdateInventory(array $updates): int
    {
        $updated_count = 0;

        $this->beginTransaction();

        try {
            foreach ($updates as $update) {
                $this->execute(
                    "UPDATE products SET physical_quantity = ?, updated_at = NOW() WHERE sku = ?",
                    [$update['quantity'], $update['sku']]
                );
                $updated_count++;
            }

            $this->commit();
            return $updated_count;

        } catch (Exception $e) {
            $this->rollback();
            throw $e;
        }
    }
}
```

## ğŸŒ 4. Google Sheets çµ±åˆã‚·ã‚¹ãƒ†ãƒ 

### 4.1 Google Apps Script å®Ÿè£…

```javascript
// Google Apps Script - NAGANO-3åœ¨åº«åŒæœŸã‚·ã‚¹ãƒ†ãƒ 
function onEdit(e) {
  const range = e.range;
  const sheet = e.source.getActiveSheet();

  // åœ¨åº«ç®¡ç†ã‚·ãƒ¼ãƒˆã®ç‰©ç†åœ¨åº«æ•°ï¼ˆCåˆ—ï¼‰ã¾ãŸã¯è¡¨ç¤ºåœ¨åº«æ•°ï¼ˆDåˆ—ï¼‰ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ
  if (
    sheet.getName() === "åœ¨åº«ç®¡ç†" &&
    (range.getColumn() === 3 || range.getColumn() === 4)
  ) {
    const sku = sheet.getRange(range.getRow(), 1).getValue();
    const physical_qty = sheet.getRange(range.getRow(), 3).getValue();
    const listing_qty = sheet.getRange(range.getRow(), 4).getValue();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: è¡¨ç¤ºåœ¨åº« > ç‰©ç†åœ¨åº«ã®å ´åˆã¯è­¦å‘Š
    if (listing_qty > physical_qty) {
      sheet.getRange(range.getRow(), 4).setBackground("#ffebee");
      Browser.msgBox(
        "è­¦å‘Š",
        "è¡¨ç¤ºåœ¨åº«æ•°ãŒç‰©ç†åœ¨åº«æ•°ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚",
        Browser.Buttons.OK
      );
      return;
    }

    // NAGANO-3ã‚·ã‚¹ãƒ†ãƒ ã®APIã«åŒæœŸãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
    const response = UrlFetchApp.fetch(
      "https://your-domain.com/modules/multi_mall_inventory/api/spreadsheet_sync_api.php",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + getAuthToken(),
        },
        payload: JSON.stringify({
          action: "receive_update",
          source: "spreadsheet",
          sku: sku,
          physical_quantity: physical_qty,
          listing_quantity: listing_qty,
          timestamp: new Date().toISOString(),
        }),
      }
    );

    if (response.getResponseCode() === 200) {
      const result = JSON.parse(response.getContentText());
      if (result.success) {
        sheet.getRange(range.getRow(), 7).setValue(new Date());
        sheet.getRange(range.getRow(), 8).setValue("synced");
        sheet.getRange(range.getRow(), 4).setBackground("#e8f5e8");
      } else {
        sheet.getRange(range.getRow(), 8).setValue("error");
        Browser.msgBox("åŒæœŸã‚¨ãƒ©ãƒ¼", result.error, Browser.Buttons.OK);
      }
    }
  }
}

function getAuthToken() {
  return PropertiesService.getScriptProperties().getProperty(
    "NAGANO3_API_TOKEN"
  );
}

// å®šæœŸçš„ãªå…¨ä½“åŒæœŸï¼ˆ1æ—¥1å›å®Ÿè¡Œï¼‰
function dailySync() {
  const sheet = SpreadsheetApp.getActiveSheet();
  const lastRow = sheet.getLastRow();

  for (let row = 2; row <= lastRow; row++) {
    const sku = sheet.getRange(row, 1).getValue();
    if (sku) {
      try {
        const response = UrlFetchApp.fetch(
          `https://your-domain.com/modules/multi_mall_inventory/api/inventory_api.php?action=get_product&sku=${sku}`,
          {
            headers: {
              Authorization: "Bearer " + getAuthToken(),
            },
          }
        );

        if (response.getResponseCode() === 200) {
          const data = JSON.parse(response.getContentText()).data;

          sheet.getRange(row, 2).setValue(data.product_name);
          sheet.getRange(row, 3).setValue(data.physical_quantity);
          sheet.getRange(row, 4).setValue(data.listing_quantity);
          sheet.getRange(row, 5).setValue(data.status);
        }
      } catch (error) {
        console.error(`Sync error for SKU ${sku}: ${error}`);
      }
    }
  }
}
```

### 4.2 PHP å´ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒæœŸ API

```php
<?php
// modules/multi_mall_inventory/api/spreadsheet_sync_api.php
class SpreadsheetSyncAPI
{
    private $inventory_api;
    private $audit_logger;

    public function receiveUpdate(): array
    {
        $input = json_decode(file_get_contents('php://input'), true);

        $validator = new SpreadsheetValidator();
        $validation_result = $validator->validate($input);

        if (!$validation_result['valid']) {
            return APIResponse::error('Validation failed', 400, $validation_result['errors']);
        }

        try {
            // åœ¨åº«æ›´æ–°å®Ÿè¡Œ
            $update_result = $this->inventory_api->updateInventory([
                'sku' => $input['sku'],
                'physical_quantity' => $input['physical_quantity'],
                'listing_quantity' => $input['listing_quantity'],
                'source' => 'spreadsheet'
            ]);

            // ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
            $this->audit_logger->logSpreadsheetUpdate($input);

            // ãƒ¢ãƒ¼ãƒ«åŒæœŸãƒˆãƒªã‚¬ãƒ¼
            $this->triggerMallSync($input['sku']);

            return APIResponse::success($update_result);

        } catch (Exception $e) {
            return APIResponse::error($e->getMessage(), 500);
        }
    }

    private function triggerMallSync(string $sku): void
    {
        // éåŒæœŸã§ãƒ¢ãƒ¼ãƒ«åŒæœŸã‚’å®Ÿè¡Œ
        $job_queue = new JobQueue();
        $job_queue->enqueue('mall_sync', [
            'sku' => $sku,
            'trigger' => 'spreadsheet_update',
            'priority' => 'high'
        ]);
    }
}
```

## ğŸ¨ 5. UI/UX è¨­è¨ˆï¼ˆN3 æº–æ‹ ï¼‰

### 5.1 ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¨­è¨ˆ

```html
<!-- modules/multi_mall_inventory/templates/dashboard.php -->
<div class="inventory-dashboard">
  <!-- KPIã‚«ãƒ¼ãƒ‰ -->
  <div class="kpi-cards-grid">
    <div class="kpi-card">
      <div class="kpi-title">ç·åœ¨åº«å•†å“æ•°</div>
      <div class="kpi-value" id="total-products">0</div>
      <div class="kpi-trend positive">+12 (ä»Šæœˆ)</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-title">åœ¨åº«åˆ‡ã‚Œã‚¢ãƒ©ãƒ¼ãƒˆ</div>
      <div class="kpi-value danger" id="out-of-stock">0</div>
      <div class="kpi-trend negative">è¦æ³¨æ„</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-title">åŒæœŸã‚¨ãƒ©ãƒ¼</div>
      <div class="kpi-value warning" id="sync-errors">0</div>
      <div class="kpi-trend">24hå†…</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-title">ç·å‡ºå“æ•°</div>
      <div class="kpi-value" id="total-listings">0</div>
      <div class="kpi-trend positive">5ãƒ¢ãƒ¼ãƒ«åˆè¨ˆ</div>
    </div>
  </div>

  <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="quick-actions">
    <button class="btn btn-primary" onclick="openNewProductModal()">
      <i class="icon-plus"></i> æ–°è¦å•†å“ç™»éŒ²
    </button>
    <button class="btn btn-secondary" onclick="openBulkImportModal()">
      <i class="icon-upload"></i> ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    </button>
    <button class="btn btn-info" onclick="syncAllMalls()">
      <i class="icon-sync"></i> å…¨ãƒ¢ãƒ¼ãƒ«åŒæœŸ
    </button>
    <button class="btn btn-success" onclick="openSpreadsheetSync()">
      <i class="icon-table"></i> ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº
    </button>
  </div>

  <!-- åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ -->
  <div class="inventory-alerts" id="inventory-alerts">
    <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ -->
  </div>

  <!-- æœ€è¿‘ã®æ´»å‹• -->
  <div class="recent-activity">
    <h3>æœ€è¿‘ã®åœ¨åº«å¤‰å‹•</h3>
    <div class="activity-list" id="recent-activity-list">
      <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹æ´»å‹•å±¥æ­´ -->
    </div>
  </div>
</div>
```

### 5.2 å•†å“ç®¡ç† UIï¼ˆExcel é¢¨è¡¨ç¤ºï¼‰

```html
<!-- å•†å“ä¸€è¦§ï¼ˆExcelé¢¨è¡¨ç¤ºï¼‰ -->
<div class="inventory-grid" id="inventory-grid">
  <div class="grid-header">
    <div class="grid-cell">SKU</div>
    <div class="grid-cell">å•†å“å</div>
    <div class="grid-cell">ç‰©ç†åœ¨åº«</div>
    <div class="grid-cell">è¡¨ç¤ºåœ¨åº«</div>
    <div class="grid-cell">eBay1</div>
    <div class="grid-cell">eBay2</div>
    <div class="grid-cell">ãƒ¡ãƒ«ã‚«ãƒª</div>
    <div class="grid-cell">Yahoo</div>
    <div class="grid-cell">Amazon</div>
    <div class="grid-cell">æœ€çµ‚æ›´æ–°</div>
    <div class="grid-cell">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
  </div>

  <div class="grid-body" id="products-grid-body">
    <!-- JavaScriptå‹•çš„ç”Ÿæˆ -->
  </div>
</div>
```

### 5.3 JavaScript åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ 

```javascript
// assets/js/multi_mall_inventory.js
class MultiMallInventorySystem {
  constructor() {
    this.apiBase = "/modules/multi_mall_inventory/api/";
    this.currentView = "dashboard";
    this.products = new Map();
    this.syncStatus = new Map();

    this.initializeSystem();
  }

  async initializeSystem() {
    try {
      // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      await this.loadDashboardData();
      await this.loadProductsList();

      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°é–‹å§‹
      this.startRealTimeUpdates();

      // UI ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      this.setupEventListeners();

      console.log("å¤šãƒ¢ãƒ¼ãƒ«åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†");
    } catch (error) {
      console.error("ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
      this.showError("ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  }

  async loadDashboardData() {
    const response = await fetch(
      `${this.apiBase}dashboard_api.php?action=get_kpi`
    );
    const data = await response.json();

    if (data.success) {
      this.updateKPICards(data.data);
    }
  }

  updateKPICards(kpiData) {
    document.getElementById("total-products").textContent =
      kpiData.total_products;
    document.getElementById("out-of-stock").textContent = kpiData.out_of_stock;
    document.getElementById("sync-errors").textContent = kpiData.sync_errors;
    document.getElementById("total-listings").textContent =
      kpiData.total_listings;
  }

  async updateInventory(sku, field, value) {
    try {
      const response = await fetch(`${this.apiBase}inventory_api.php`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          action: "update_inventory",
          sku: sku,
          field: field,
          value: value,
        }),
      });

      const result = await response.json();

      if (result.success) {
        this.showSuccess(`${sku}ã®${field}ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
        this.refreshProduct(sku);

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒæœŸ
        await this.syncToSpreadsheet(sku);

        // ãƒ¢ãƒ¼ãƒ«åŒæœŸãƒˆãƒªã‚¬ãƒ¼
        await this.triggerMallSync(sku);
      } else {
        this.showError(result.error.message);
      }
    } catch (error) {
      console.error("åœ¨åº«æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
      this.showError("åœ¨åº«æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  }

  startRealTimeUpdates() {
    // WebSocketæ¥ç¶šã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
    if ("WebSocket" in window) {
      this.websocket = new WebSocket("ws://localhost:8080/inventory-updates");

      this.websocket.onmessage = (event) => {
        const update = JSON.parse(event.data);
        this.handleRealTimeUpdate(update);
      };
    } else {
      // ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      setInterval(() => this.pollForUpdates(), 30000);
    }
  }

  handleRealTimeUpdate(update) {
    switch (update.type) {
      case "inventory_change":
        this.updateProductRow(update.sku, update.data);
        break;
      case "sync_status":
        this.updateSyncStatus(update.sku, update.mall, update.status);
        break;
      case "alert":
        this.showAlert(update.message, update.level);
        break;
    }
  }
}

// ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
document.addEventListener("DOMContentLoaded", () => {
  window.inventorySystem = new MultiMallInventorySystem();
});
```

## ğŸ“Š 6. Hook æ´»ç”¨é–‹ç™ºæˆ¦ç•¥

### 6.1 å¿…é ˆ Hook æ´»ç”¨

**`18_development_project_manager.py`**:

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç®¡ç†
- é€²æ—è¿½è·¡ãƒ»å“è³ªç®¡ç†
- ãƒªã‚½ãƒ¼ã‚¹é…åˆ†æœ€é©åŒ–

**`20_code_quality_monitor_hook.py`**:

- ã‚³ãƒ¼ãƒ‰å“è³ªã‚¹ã‚³ã‚¢ç›£è¦–
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§æ¤œå‡º
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ææ¡ˆ

**`22_auto_test_generation_hook.py`**:

- å˜ä½“ãƒ†ã‚¹ãƒˆè‡ªå‹•ç”Ÿæˆ
- çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- API ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–

### 6.2 Hook çµ±åˆé–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹

```python
# hooks/1_essential/25_inventory_system_development_hook.py
class InventorySystemDevelopmentHook:
    def __init__(self):
        self.project_manager = self.load_hook('18_development_project_manager.py')
        self.quality_monitor = self.load_hook('20_code_quality_monitor_hook.py')
        self.test_generator = self.load_hook('22_auto_test_generation_hook.py')

    def execute_development_phase(self, phase_name, requirements):
        # Phase 1: è¨­è¨ˆãƒ»è¨ˆç”»
        if phase_name == 'design':
            return self.project_manager.create_development_plan(requirements)

        # Phase 2: å®Ÿè£…
        elif phase_name == 'implementation':
            return self.implement_with_quality_monitoring(requirements)

        # Phase 3: ãƒ†ã‚¹ãƒˆ
        elif phase_name == 'testing':
            return self.test_generator.generate_comprehensive_tests(requirements)

        # Phase 4: çµ±åˆ
        elif phase_name == 'integration':
            return self.integrate_with_n3_system(requirements)

    def implement_with_quality_monitoring(self, requirements):
        implementation_result = {
            'files_created': [],
            'quality_scores': {},
            'security_checks': {},
            'performance_analysis': {}
        }

        for component in requirements['components']:
            # å®Ÿè£…
            file_path = self.generate_component_file(component)
            implementation_result['files_created'].append(file_path)

            # å“è³ªãƒã‚§ãƒƒã‚¯
            quality_score = self.quality_monitor.analyze_file(file_path)
            implementation_result['quality_scores'][component['name']] = quality_score

            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
            security_result = self.quality_monitor.security_scan(file_path)
            implementation_result['security_checks'][component['name']] = security_result

        return implementation_result
```

## ğŸš€ 7. æ®µéšçš„å®Ÿè£…è¨ˆç”»

### Phase 1: åŸºç›¤æ§‹ç¯‰ï¼ˆ1-2 é€±é–“ï¼‰

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆãƒ»å®Ÿè£…**
2. **N3 ã‚·ã‚¹ãƒ†ãƒ çµ±åˆç¢ºèª**
3. **åŸºæœ¬ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…**
4. **Hook çµ±åˆã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰**

### Phase 2: ã‚³ã‚¢æ©Ÿèƒ½å®Ÿè£…ï¼ˆ2-3 é€±é–“ï¼‰

1. **åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…**
2. **eBay 2 ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçµ±åˆ**
3. **åŸºæœ¬ UI å®Ÿè£…ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»å•†å“ä¸€è¦§ï¼‰**
4. **PostgreSQL æœ€é©åŒ–**

### Phase 3: ãƒ¢ãƒ¼ãƒ«é€£æºæ‹¡å¼µï¼ˆ2-3 é€±é–“ï¼‰

1. **ãƒ¡ãƒ«ã‚«ãƒª API çµ±åˆ**
2. **Yahooãƒ»Amazon API çµ±åˆ**
3. **ã‚»ãƒƒãƒˆå“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ **
4. **ç”»åƒç®¡ç†ã‚·ã‚¹ãƒ†ãƒ **

### Phase 4: é«˜åº¦æ©Ÿèƒ½å®Ÿè£…ï¼ˆ2-3 é€±é–“ï¼‰

1. **Google Sheets å®Œå…¨çµ±åˆ**
2. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚·ã‚¹ãƒ†ãƒ **
3. **ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ **
4. **ãƒ¬ãƒãƒ¼ãƒˆãƒ»åˆ†ææ©Ÿèƒ½**

### Phase 5: æœ€é©åŒ–ãƒ»æœ¬ç•ªåŒ–ï¼ˆ1-2 é€±é–“ï¼‰

1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**
3. **æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤**
4. **é‹ç”¨ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ **

## ğŸ”’ 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 8.1 èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ 

```php
<?php
class InventorySecurityManager
{
    private $session_handler;
    private $access_control;

    public function validateAPIAccess(string $endpoint, array $user_context): bool
    {
        // APIã‚­ãƒ¼æ¤œè¨¼
        if (!$this->validateAPIKey($_SERVER['HTTP_AUTHORIZATION'] ?? '')) {
            throw new UnauthorizedException('Invalid API key');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ç¢ºèª
        $required_permission = $this->getRequiredPermission($endpoint);
        if (!$this->access_control->userHasPermission($user_context['user_id'], $required_permission)) {
            throw new ForbiddenException('Insufficient permissions');
        }

        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç¢ºèª
        if (!$this->checkRateLimit($user_context['user_id'], $endpoint)) {
            throw new TooManyRequestsException('Rate limit exceeded');
        }

        return true;
    }

    public function sanitizeInventoryInput(array $input): array
    {
        $sanitized = [];

        foreach ($input as $key => $value) {
            switch ($key) {
                case 'sku':
                    $sanitized[$key] = $this->sanitizeSKU($value);
                    break;
                case 'quantity':
                    $sanitized[$key] = $this->sanitizeQuantity($value);
                    break;
                case 'product_name':
                    $sanitized[$key] = $this->sanitizeProductName($value);
                    break;
                default:
                    $sanitized[$key] = $this->sanitizeGeneral($value);
            }
        }

        return $sanitized;
    }
}
```

### 8.2 ãƒ‡ãƒ¼ã‚¿ä¿è­·ãƒ»æš—å·åŒ–

```php
<?php
class DataProtectionManager
{
    private $encryption_key;

    public function encryptSensitiveData(array $data): array
    {
        $sensitive_fields = ['api_keys', 'tokens', 'passwords'];

        foreach ($data as $key => $value) {
            if (in_array($key, $sensitive_fields)) {
                $data[$key] = $this->encrypt($value);
            }
        }

        return $data;
    }

    public function auditInventoryChange(string $sku, array $changes, string $user_id): void
    {
        $audit_record = [
            'timestamp' => microtime(true),
            'sku' => $sku,
            'changes' => $changes,
            'user_id' => $user_id,
            'ip_address' => $_SERVER['REMOTE_ADDR'],
            'user_agent' => $_SERVER['HTTP_USER_AGENT'],
            'session_id' => session_id()
        ];

        // ã‚»ã‚­ãƒ¥ã‚¢ãƒ­ã‚°ä¿å­˜
        $this->writeSecureAuditLog($audit_record);
    }
}
```

## ğŸ“ˆ 9. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 9.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–æˆ¦ç•¥

```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥
CREATE INDEX CONCURRENTLY idx_products_search ON products
USING GIN(to_tsvector('english', product_name));

CREATE INDEX idx_mall_listings_sync ON mall_listings(sync_status, last_sync)
WHERE sync_status IN ('pending', 'error');

CREATE INDEX idx_products_low_stock ON products(physical_quantity, listing_quantity)
WHERE physical_quantity <= 5;

-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æˆ¦ç•¥ï¼ˆå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
CREATE TABLE inventory_history (
    id SERIAL,
    sku VARCHAR(50),
    change_type VARCHAR(20),
    old_values JSONB,
    new_values JSONB,
    changed_at TIMESTAMP DEFAULT NOW(),
    changed_by VARCHAR(50)
) PARTITION BY RANGE (changed_at);

CREATE TABLE inventory_history_2025_q1
PARTITION OF inventory_history
FOR VALUES FROM ('2025-01-01') TO ('2025-04-01');

-- ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ¬ãƒãƒ¼ãƒˆç”¨ï¼‰
CREATE MATERIALIZED VIEW inventory_summary AS
SELECT
    COUNT(*) as total_products,
    COUNT(*) FILTER (WHERE physical_quantity = 0) as out_of_stock,
    COUNT(*) FILTER (WHERE physical_quantity <= 5) as low_stock,
    AVG(physical_quantity) as avg_stock_level,
    SUM(CASE WHEN product_type = 'set' THEN 1 ELSE 0 END) as set_products
FROM products
WHERE status = 'active';

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è‡ªå‹•æ›´æ–°
CREATE UNIQUE INDEX ON inventory_summary (total_products);
REFRESH MATERIALIZED VIEW CONCURRENTLY inventory_summary;
```

### 9.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

```php
<?php
class InventoryCacheManager
{
    private $redis;
    private $cache_ttl = [
        'product_data' => 3600,      // 1æ™‚é–“
        'mall_listings' => 1800,     // 30åˆ†
        'dashboard_kpi' => 300,      // 5åˆ†
        'sync_status' => 60          // 1åˆ†
    ];

    public function getProductWithCache(string $sku): ?array
    {
        $cache_key = "product:{$sku}";

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
        $cached = $this->redis->get($cache_key);
        if ($cached) {
            return json_decode($cached, true);
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—
        $product = $this->database->getProduct($sku);

        if ($product) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            $this->redis->setex(
                $cache_key,
                $this->cache_ttl['product_data'],
                json_encode($product)
            );
        }

        return $product;
    }

    public function invalidateProductCache(string $sku): void
    {
        $this->redis->del("product:{$sku}");

        // é–¢é€£ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚ç„¡åŠ¹åŒ–
        $this->redis->del("dashboard:kpi");
        $this->redis->del("product_list:*");
    }
}
```

## ğŸ§ª 10. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 10.1 è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè£…

```php
<?php
// tests/Integration/InventoryAPITest.php
class InventoryAPITest extends TestCase
{
    public function setUp(): void
    {
        parent::setUp();
        $this->database = new TestDatabaseManager();
        $this->api = new InventoryAPI($this->database);
    }

    public function testUpdatePhysicalStock(): void
    {
        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™
        $test_sku = 'TEST-PRODUCT-001';
        $this->database->createTestProduct($test_sku, [
            'physical_quantity' => 10,
            'listing_quantity' => 8
        ]);

        // APIå‘¼ã³å‡ºã—
        $result = $this->api->updatePhysicalStock($test_sku, 20);

        // çµæœæ¤œè¨¼
        $this->assertTrue($result['success']);
        $this->assertEquals(20, $result['data']['physical_quantity']);

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª
        $product = $this->database->getProduct($test_sku);
        $this->assertEquals(20, $product['physical_quantity']);
    }

    public function testInventoryConstraints(): void
    {
        $test_sku = 'TEST-CONSTRAINT-001';
        $this->database->createTestProduct($test_sku, [
            'physical_quantity' => 5,
            'listing_quantity' => 3,
            'is_physical_stock' => true
        ]);

        // åˆ¶ç´„é•åãƒ†ã‚¹ãƒˆ: è¡¨ç¤ºåœ¨åº« > ç‰©ç†åœ¨åº«
        $result = $this->api->updateListingQuantity($test_sku, 10);

        $this->assertFalse($result['success']);
        $this->assertStringContains('exceeds physical quantity', $result['error']['message']);
    }
}
```

### 10.2 çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆHook æ´»ç”¨ï¼‰

```python
# hooks/1_essential/26_inventory_integration_test_hook.py
class InventoryIntegrationTestHook:
    def execute_comprehensive_test(self):
        test_scenarios = [
            'basic_inventory_operations',
            'mall_synchronization',
            'spreadsheet_integration',
            'set_product_management',
            'concurrent_access_handling',
            'error_recovery_scenarios'
        ]

        results = {}

        for scenario in test_scenarios:
            try:
                test_result = self.run_test_scenario(scenario)
                results[scenario] = test_result
            except Exception as e:
                results[scenario] = {'status': 'failed', 'error': str(e)}

        return {
            'overall_status': self.determine_overall_status(results),
            'test_results': results,
            'recommendations': self.generate_recommendations(results)
        }

    def run_test_scenario(self, scenario_name):
        if scenario_name == 'mall_synchronization':
            return self.test_mall_sync_scenario()
        elif scenario_name == 'spreadsheet_integration':
            return self.test_spreadsheet_scenario()
        # ... ä»–ã®ã‚·ãƒŠãƒªã‚ª

    def test_mall_sync_scenario(self):
        # 1. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
        test_products = self.create_test_inventory()

        # 2. ãƒ¢ãƒ¼ãƒ«åŒæœŸå®Ÿè¡Œ
        sync_results = self.trigger_mall_sync(test_products)

        # 3. åŒæœŸçµæœç¢ºèª
        verification_results = self.verify_sync_results(sync_results)

        return {
            'status': 'passed' if verification_results['all_synced'] else 'failed',
            'details': verification_results
        }
```

## ğŸ“‹ 11. é‹ç”¨ãƒ»ç›£è¦–è¨­è¨ˆ

### 11.1 ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–

```php
<?php
class InventorySystemMonitor
{
    private $metrics_collector;
    private $alert_manager;

    public function collectSystemMetrics(): array
    {
        return [
            'database_performance' => $this->collectDatabaseMetrics(),
            'api_performance' => $this->collectAPIMetrics(),
            'mall_sync_status' => $this->collectSyncMetrics(),
            'inventory_health' => $this->collectInventoryMetrics(),
            'system_resources' => $this->collectResourceMetrics()
        ];
    }

    public function checkInventoryAlerts(): array
    {
        $alerts = [];

        // åœ¨åº«åˆ‡ã‚Œã‚¢ãƒ©ãƒ¼ãƒˆ
        $out_of_stock = $this->database->getOutOfStockProducts();
        if (count($out_of_stock) > 0) {
            $alerts[] = [
                'level' => 'warning',
                'type' => 'out_of_stock',
                'count' => count($out_of_stock),
                'products' => array_slice($out_of_stock, 0, 5)
            ];
        }

        // åŒæœŸã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆ
        $sync_errors = $this->database->getSyncErrors();
        if (count($sync_errors) > 0) {
            $alerts[] = [
                'level' => 'error',
                'type' => 'sync_error',
                'count' => count($sync_errors),
                'errors' => array_slice($sync_errors, 0, 10)
            ];
        }

        return $alerts;
    }
}
```

### 11.2 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§

```bash
#!/bin/bash
# backup/inventory_backup.sh

BACKUP_DIR="/var/backups/nagano3/inventory"
DB_NAME="nagano3_inventory"
DATE=$(date +%Y%m%d_%H%M%S)

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–‹å§‹: $DATE"
pg_dump -h localhost -U postgres $DB_NAME | gzip > "$BACKUP_DIR/db_backup_$DATE.sql.gz"

# ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
echo "ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–‹å§‹"
tar -czf "$BACKUP_DIR/files_backup_$DATE.tar.gz" \
    /var/www/nagano3/modules/multi_mall_inventory \
    /var/www/nagano3/uploads/inventory_images

# å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ30æ—¥ä»¥ä¸Šå¤ã„ï¼‰
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•´åˆæ€§ç¢ºèª
echo "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ•´åˆæ€§ç¢ºèª"
gunzip -t "$BACKUP_DIR/db_backup_$DATE.sql.gz"
tar -tzf "$BACKUP_DIR/files_backup_$DATE.tar.gz" > /dev/null

echo "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†: $DATE"
```

## ğŸ“Š 12. æˆæœç‰©ãƒ»ç´æœŸç®¡ç†

### 12.1 ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ç®¡ç†

| Phase   | ç´æœŸ    | ä¸»è¦æˆæœç‰©        | å®Œäº†åŸºæº–                        |
| ------- | ------- | ----------------- | ------------------------------- |
| Phase 1 | Week 2  | DB è¨­è¨ˆã€åŸºæœ¬ API | PostgreSQL ç¨¼åƒã€åŸºæœ¬ CRUD å®Œäº† |
| Phase 2 | Week 5  | ã‚³ã‚¢æ©Ÿèƒ½å®Ÿè£…      | åœ¨åº«ç®¡ç†ã€eBay é€£æºå®Œäº†         |
| Phase 3 | Week 8  | ãƒ¢ãƒ¼ãƒ«é€£æºæ‹¡å¼µ    | 5 ãƒ¢ãƒ¼ãƒ«é€£æºå®Œäº†                |
| Phase 4 | Week 11 | é«˜åº¦æ©Ÿèƒ½å®Ÿè£…      | Google Sheets é€£æºå®Œäº†          |
| Phase 5 | Week 13 | æœ¬ç•ªåŒ–å®Œäº†        | æœ¬ç•ªç’°å¢ƒç¨¼åƒé–‹å§‹                |

### 12.2 å“è³ªç®¡ç†æŒ‡æ¨™

- **ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸**: 85%ä»¥ä¸Š
- **API ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: 95%ãŒ 500ms ä»¥å†…
- **åŒæœŸæˆåŠŸç‡**: 99%ä»¥ä¸Š
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³**: è„†å¼±æ€§ã‚¼ãƒ­
- **ã‚·ã‚¹ãƒ†ãƒ å¯ç”¨æ€§**: 99.9%ä»¥ä¸Š

## ğŸ¯ 13. ã¾ã¨ã‚ãƒ»æ¨å¥¨äº‹é …

### 13.1 é–‹ç™ºæˆåŠŸè¦å› 

1. **æ—¢å­˜è³‡ç”£ã®æœ€å¤§æ´»ç”¨**: ebay_complete_dashboard_fixed.php ç­‰ã®å®Ÿç¸¾ã‚ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ´»ç”¨
2. **æ®µéšçš„å®Ÿè£…**: ãƒªã‚¹ã‚¯ã‚’æœ€å°åŒ–ã—ãŸæ®µéšçš„ãƒ‡ãƒªãƒãƒªãƒ¼
3. **Hook çµ±åˆé–‹ç™º**: CAIDS Hook ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹è‡ªå‹•å“è³ªç®¡ç†ãƒ»ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
4. **N3 å®Œå…¨æº–æ‹ **: æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®å®Œå…¨äº’æ›æ€§ç¢ºä¿

### 13.2 æŠ€è¡“çš„æ¨å¥¨äº‹é …

1. **PostgreSQL æœ€é©åŒ–**: ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ã«ã‚ˆã‚‹é«˜é€ŸåŒ–
2. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥**: Redis æ´»ç”¨ã«ã‚ˆã‚‹å¿œç­”æ€§èƒ½å‘ä¸Š
3. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ**: WebSocket + Google Apps Script é€£æº
4. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**: å¤šå±¤é˜²å¾¡ãƒ»ç›£æŸ»ãƒ­ã‚°ãƒ»æš—å·åŒ–

### 13.3 é‹ç”¨æ¨å¥¨äº‹é …

1. **ç¶™ç¶šçš„ç›£è¦–**: ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»è‡ªå‹•å¾©æ—§ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰
2. **å®šæœŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§ãƒ—ãƒ­ã‚»ã‚¹
3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™**: æŠ€è¡“æ–‡æ›¸ãƒ»é‹ç”¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ»API ä»•æ§˜æ›¸
4. **ãƒãƒ¼ãƒ çŸ¥è­˜å…±æœ‰**: Hook çµ±åˆé–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šã€**5 ã¤ã®ãƒ¢ãƒ¼ãƒ« + å®Ÿåœ¨åº« + Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ**ã®çµ±åˆç®¡ç†ãŒå®Ÿç¾ã—ã€**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ**ã«ã‚ˆã‚‹æ­£ç¢ºãªåœ¨åº«ç®¡ç†ã¨**åŠ¹ç‡çš„ãªå¤šãƒãƒ£ãƒãƒ«è²©å£²**ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

ğŸ¯ å¤šãƒ¢ãƒ¼ãƒ«åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  é«˜åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»UI æ”¹å–„æŒ‡ç¤ºæ›¸
ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: multi_mall_inventory_system5.html
å®Ÿè£…ç›®æ¨™: é«˜åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ + æŠ˜ã‚ŠãŸãŸã¿ UI + æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
é–‹ç™ºæˆ¦ç•¥: Claudeãƒ»Gemini å”åƒé–‹ç™ºã«ã‚ˆã‚‹åŠ¹ç‡åŒ–

ğŸ› ï¸ å®Ÿè£…è¦ä»¶è©³ç´°

1. é«˜åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã®å®Ÿè£…
   1.1 ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
   javascript// ä¾¡æ ¼å¸¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆãƒ¢ãƒ¼ãƒ«åˆ¥å¯¾å¿œï¼‰
   const priceFilters = {
   ebay: ['0-50', '50-200', '200-500', '500+'],
   mercari: ['0-1000', '1000-5000', '5000-10000', '10000+'],
   yahoo: ['0-5000', '5000-20000', '20000+'],
   amazon: ['0-100', '100-500', '500+']
   };
   1.2 åœ¨åº«ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
   javascript// åœ¨åº«ã‚¿ã‚¤ãƒ—åˆ†é¡ã‚·ã‚¹ãƒ†ãƒ 
   const stockTypeFilters = {
   physical: { label: 'æœ‰åœ¨åº«', field: 'is_physical_stock', value: true },
   dropship: { label: 'ç„¡åœ¨åº«', field: 'is_physical_stock', value: false },
   set: { label: 'ã‚»ãƒƒãƒˆå“', field: 'product_type', value: 'set' }
   };
   1.3 å‹•çš„ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
   javascript// ã‚«ãƒ†ã‚´ãƒªå‹•çš„ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 
   function generateCategoryFilter(products) {
   const categories = [...new Set(products.map(p => p.category))];
   return categories.filter(cat => cat && cat !== 'Uncategorized');
   }
2. UI æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
2.1 æŠ˜ã‚ŠãŸãŸã¿ã‚³ãƒ³ãƒ†ãƒŠè¨­è¨ˆ
html<div class="collapsible-container" id="header-section">
<div class="collapsible-content">
<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»çµ±è¨ˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
</div>
<button class="collapse-toggle" onclick="toggleHeaderCollapse()">
<i class="fas fa-chevron-up" id="collapse-icon"></i>
</button>
</div>
2.2 ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
css.collapsible-container {
    transition: max-height 0.3s ease-in-out;
    overflow: hidden;
}

.collapsible-container--collapsed {
max-height: 60px;
}

.collapse-toggle {
position: absolute;
bottom: 8px;
right: 16px;
background: rgba(255, 255, 255, 0.9);
border-radius: 50%;
transition: transform 0.3s ease;
}

ğŸ¯ å¤šãƒ¢ãƒ¼ãƒ«åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  é«˜åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»UI æ”¹å–„æŒ‡ç¤ºæ›¸
ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: multi_mall_inventory_system5.html
å®Ÿè£…ç›®æ¨™: é«˜åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ + æŠ˜ã‚ŠãŸãŸã¿ UI + æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
é–‹ç™ºæˆ¦ç•¥: Claudeãƒ»Gemini å”åƒé–‹ç™ºã«ã‚ˆã‚‹åŠ¹ç‡åŒ–

ğŸ› ï¸ å®Ÿè£…è¦ä»¶è©³ç´°

1. é«˜åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã®å®Ÿè£…
   1.1 ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
   javascript// ä¾¡æ ¼å¸¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆãƒ¢ãƒ¼ãƒ«åˆ¥å¯¾å¿œï¼‰
   const priceFilters = {
   ebay: ['0-50', '50-200', '200-500', '500+'],
   mercari: ['0-1000', '1000-5000', '5000-10000', '10000+'],
   yahoo: ['0-5000', '5000-20000', '20000+'],
   amazon: ['0-100', '100-500', '500+']
   };
   1.2 åœ¨åº«ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
   javascript// åœ¨åº«ã‚¿ã‚¤ãƒ—åˆ†é¡ã‚·ã‚¹ãƒ†ãƒ 
   const stockTypeFilters = {
   physical: { label: 'æœ‰åœ¨åº«', field: 'is_physical_stock', value: true },
   dropship: { label: 'ç„¡åœ¨åº«', field: 'is_physical_stock', value: false },
   set: { label: 'ã‚»ãƒƒãƒˆå“', field: 'product_type', value: 'set' }
   };
   1.3 å‹•çš„ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
   javascript// ã‚«ãƒ†ã‚´ãƒªå‹•çš„ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 
   function generateCategoryFilter(products) {
   const categories = [...new Set(products.map(p => p.category))];
   return categories.filter(cat => cat && cat !== 'Uncategorized');
   }
2. UI æŠ˜ã‚ŠãŸãŸã¿æ©Ÿèƒ½
2.1 æŠ˜ã‚ŠãŸãŸã¿ã‚³ãƒ³ãƒ†ãƒŠè¨­è¨ˆ
html<div class="collapsible-container" id="header-section">
<div class="collapsible-content">
<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»çµ±è¨ˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
</div>
<button class="collapse-toggle" onclick="toggleHeaderCollapse()">
<i class="fas fa-chevron-up" id="collapse-icon"></i>
</button>
</div>
2.2 ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…
css.collapsible-container {
    transition: max-height 0.3s ease-in-out;
    overflow: hidden;
}

.collapsible-container--collapsed {
max-height: 60px;
}

.collapse-toggle {
position: absolute;
bottom: 8px;
right: 16px;
background: rgba(255, 255, 255, 0.9);
border-radius: 50%;
transition: transform 0.3s ease;
}
