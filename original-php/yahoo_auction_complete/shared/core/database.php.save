                throw new Exception("削除条件が指定されていません");
            }
            
            $sql = "DELETE FROM " . $this->escapeIdentifier($table);
            $params = [];
            
            // WHERE句の構築
            $whereClause = [];
            foreach ($conditions as $column => $value) {
                if (is_array($value)) {
                    $placeholders = str_repeat('?,', count($value) - 1) . '?';
                    $whereClause[] = $this->escapeIdentifier($column) . " IN ({$placeholders})";
                    $params = array_merge($params, $value);
                } else {
                    $whereClause[] = $this->escapeIdentifier($column) . " = ?";
                    $params[] = $value;
                }
            }
            $sql .= " WHERE " . implode(' AND ', $whereClause);
            
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute($params);
            
            return $stmt->rowCount();
            
        } catch (PDOException $e) {
            error_log("Database delete error: " . $e->getMessage());
            throw new Exception("データ削除エラー: " . $e->getMessage());
        }
    }
    
    /**
     * 安全なINSERTクエリ実行
     * 
     * @param string $table テーブル名
     * @param array $data 挿入データ
     * @return int 挿入されたレコードのID
     */
    public function insert($table, $data) {
        try {
            if (empty($data)) {
                throw new Exception("挿入データが指定されていません");
            }
            
            $columns = array_keys($data);
            $placeholders = str_repeat('?,', count($columns) - 1) . '?';
            
            $sql = "INSERT INTO " . $this->escapeIdentifier($table) . 
                   " (" . implode(', ', array_map([$this, 'escapeIdentifier'], $columns)) . ")" .
                   " VALUES ({$placeholders})";
            
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute(array_values($data));
            
            return $this->pdo->lastInsertId();
            
        } catch (PDOException $e) {
            error_log("Database insert error: " . $e->getMessage());
            throw new Exception("データ挿入エラー: " . $e->getMessage());
        }
    }
    
    /**
     * カウントクエリ実行
     * 
     * @param string $table テーブル名
     * @param array $conditions WHERE条件
     * @return int レコード数
     */
    public function count($table, $conditions = []) {
        try {
            $sql = "SELECT COUNT(*) as count FROM " . $this->escapeIdentifier($table);
            $params = [];
            
            if (!empty($conditions)) {
                $whereClause = [];
                foreach ($conditions as $column => $value) {
                    $whereClause[] = $this->escapeIdentifier($column) . " = ?";
                    $params[] = $value;
                }
                $sql .= " WHERE " . implode(' AND ', $whereClause);
            }
            
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute($params);
            
            $result = $stmt->fetch();
            return intval($result['count']);
            
        } catch (PDOException $e) {
            error_log("Database count error: " . $e->getMessage());
            throw new Exception("カウントエラー: " . $e->getMessage());
        }
    }
    
    /**
     * トランザクション開始
     */
    public function beginTransaction() {
        return $this->pdo->beginTransaction();
    }
    
    /**
     * トランザクションコミット
     */
    public function commit() {
        return $this->pdo->commit();
    }
    
    /**
     * トランザクションロールバック
     */
    public function rollback() {
        return $this->pdo->rollback();
    }
    
    /**
     * カスタムクエリ実行（複雑なクエリ用）
     * 
     * @param string $sql SQLクエリ
     * @param array $params パラメータ
     * @return PDOStatement
     */
    public function query($sql, $params = []) {
        try {
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute($params);
            return $stmt;
            
        } catch (PDOException $e) {
            error_log("Database query error: " . $e->getMessage());
            throw new Exception("クエリエラー: " . $e->getMessage());
        }
    }
    
    /**
     * 識別子のエスケープ（テーブル名・カラム名）
     * 
     * @param string $identifier
     * @return string
     */
    private function escapeIdentifier($identifier) {
        // PostgreSQL用の識別子エスケープ
        return '"' . str_replace('"', '""', $identifier) . '"';
    }
    
    /**
     * 接続状態確認
     * 
     * @return bool
     */
    public function isConnected() {
        try {
            $this->pdo->query("SELECT 1");
            return true;
        } catch (PDOException $e) {
            return false;
        }
    }
}
?>
