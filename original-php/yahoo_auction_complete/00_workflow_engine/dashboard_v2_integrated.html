<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAGANO-3 統合ワークフロー監視ダッシュボード v2.1 - 利益計算統合版</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary-color: #3498db; --success-color: #27ae60; --warning-color: #f39c12; --danger-color: #e74c3c; --info-color: #9b59b6; --dark-color: #2c3e50; --light-color: #ecf0f1;
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --profit-color: #f39c12; /* 利益計算用カラー */
        }
        
        body { font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--background-gradient); min-height: 100vh; color: #333; }
        
        .dashboard-container { display: grid; grid-template-columns: 320px 1fr; min-height: 100vh; }
        
        .sidebar { background: rgba(44, 62, 80, 0.95); color: white; padding: 20px; overflow-y: auto; }
        
        .sidebar-header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar-header h1 { font-size: 1.4em; margin-bottom: 5px; }
        .sidebar-header .version { font-size: 0.8em; opacity: 0.7; }
        
        /* 利益計算専用セクション */
        .profit-section { background: rgba(243, 156, 18, 0.1); border: 1px solid rgba(243, 156, 18, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .profit-section h3 { color: var(--profit-color); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .profit-stats { display: grid; gap: 10px; }
        .profit-stat { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; font-size: 0.9em; }
        .profit-stat .label { opacity: 0.8; }
        .profit-stat .value { font-weight: bold; color: var(--profit-color); }
        
        .connection-status { display: flex; align-items: center; gap: 8px; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 0.9em; }
        .connection-status.connected { background: rgba(39, 174, 96, 0.2); border: 1px solid rgba(39, 174, 96, 0.3); }
        .connection-status.disconnected { background: rgba(231, 76, 60, 0.2); border: 1px solid rgba(231, 76, 60, 0.3); }
        
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
        .status-indicator.connected { background: #27ae60; }
        .status-indicator.disconnected { background: #e74c3c; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .sidebar-section { margin-bottom: 25px; }
        .sidebar-section h3 { font-size: 1em; margin-bottom: 15px; color: #bdc3c7; text-transform: uppercase; font-weight: 600; letter-spacing: 1px; }
        
        .queue-stats { display: grid; gap: 10px; }
        .queue-stat { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; font-size: 0.9em; }
        .queue-stat .label { opacity: 0.8; }
        .queue-stat .value { font-weight: bold; color: var(--primary-color); }
        
        .main-content { padding: 20px; overflow-y: auto; }
        
        .header { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-title { font-size: 1.8em; color: var(--dark-color); margin-bottom: 5px; }
        .header-subtitle { color: #7f8c8d; font-size: 1em; }
        .header-controls { display: flex; gap: 10px; align-items: center; }
        
        .control-btn { background: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; display: flex; align-items: center; gap: 5px; }
        .control-btn:hover { background: #2980b9; transform: translateY(-1px); }
        .control-btn:disabled { background: #95a5a6; cursor: not-allowed; transform: none; }
        .control-btn.profit { background: var(--profit-color); }
        .control-btn.profit:hover { background: #d68910; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .stat-card { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); position: relative; overflow: hidden; transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--primary-color); }
        .stat-card.success::before { background: var(--success-color); }
        .stat-card.warning::before { background: var(--warning-color); }
        .stat-card.danger::before { background: var(--danger-color); }
        .stat-card.profit::before { background: var(--profit-color); }
        
        .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stat-icon { font-size: 2em; opacity: 0.8; }
        .stat-trend { font-size: 0.8em; padding: 2px 6px; border-radius: 10px; background: rgba(39, 174, 96, 0.1); color: var(--success-color); }
        .stat-trend.down { background: rgba(231, 76, 60, 0.1); color: var(--danger-color); }
        .stat-value { font-size: 2.5em; font-weight: bold; margin-bottom: 5px; color: var(--dark-color); }
        .stat-label { color: #7f8c8d; font-size: 1em; font-weight: 500; }
        
        /* タブナビゲーション */
        .tab-navigation { display: flex; background: rgba(255, 255, 255, 0.95); border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .tab-btn { flex: 1; padding: 15px 20px; border: none; background: transparent; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9em; font-weight: 600; }
        .tab-btn:hover { background: rgba(52, 152, 219, 0.1); }
        .tab-btn.active { background: var(--primary-color); color: white; }
        .tab-btn.profit.active { background: var(--profit-color); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .panel { background: rgba(255, 255, 255, 0.95); border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow: hidden; }
        .panel-header { padding: 20px; border-bottom: 2px solid #ecf0f1; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #f8f9fa, #e9ecef); }
        .panel-title { font-size: 1.3em; font-weight: bold; color: var(--dark-color); display: flex; align-items: center; gap: 10px; }
        .panel-content { padding: 20px; max-height: 600px; overflow-y: auto; }
        
        .workflow-item { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 15px; border-left: 5px solid var(--primary-color); position: relative; transition: all 0.3s ease; }
        .workflow-item:hover { background: #e3f2fd; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .empty-state { text-align: center; padding: 40px; color: #7f8c8d; }
        .empty-state i { font-size: 3em; margin-bottom: 15px; opacity: 0.5; }
        
        /* 利益計算専用スタイル */
        .profit-calculator-embed { width: 100%; height: 800px; border: none; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .profit-result-item { background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-left: 5px solid var(--profit-color); padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        .profit-result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .profit-result-type { font-weight: bold; color: var(--profit-color); }
        .profit-result-value { font-size: 1.2em; font-weight: bold; color: var(--success-color); }
        .profit-result-details { font-size: 0.9em; color: #666; }
        
        @media (max-width: 1200px) {
            .dashboard-container { grid-template-columns: 1fr; }
            .sidebar { order: 2; max-height: none; }
        }
        
        @media (max-width: 768px) {
            .content-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .tab-navigation { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- サイドバー -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-cogs"></i> NAGANO-3</h1>
                <div class="version">v2.1 - 利益計算統合版</div>
            </div>
            
            <!-- 接続状態 -->
            <div id="connectionStatus" class="connection-status disconnected">
                <div class="status-indicator disconnected"></div>
                <span>接続中...</span>
            </div>
            
            <!-- 利益計算統計 -->
            <div class="profit-section">
                <h3><i class="fas fa-calculator"></i> 利益計算統計</h3>
                <div class="profit-stats" id="profitStats">
                    <div class="profit-stat">
                        <span class="label">総計算数</span>
                        <span class="value" id="totalCalculations">0</span>
                    </div>
                    <div class="profit-stat">
                        <span class="label">利益商品</span>
                        <span class="value" id="profitableItems">0</span>
                    </div>
                    <div class="profit-stat">
                        <span class="label">平均利益率</span>
                        <span class="value" id="avgMargin">0%</span>
                    </div>
                    <div class="profit-stat">
                        <span class="label">eBay計算</span>
                        <span class="value" id="ebayCalcs">0</span>
                    </div>
                    <div class="profit-stat">
                        <span class="label">Shopee計算</span>
                        <span class="value" id="shopeeCalcs">0</span>
                    </div>
                </div>
            </div>
            
            <!-- キュー統計 -->
            <div class="sidebar-section">
                <h3><i class="fas fa-list"></i> キュー統計</h3>
                <div class="queue-stats" id="queueStats">
                    <div class="queue-stat">
                        <span class="label">高優先度</span>
                        <span class="value" id="highPriorityCount">0</span>
                    </div>
                    <div class="queue-stat">
                        <span class="label">通常優先度</span>
                        <span class="value" id="normalPriorityCount">0</span>
                    </div>
                    <div class="queue-stat">
                        <span class="label">処理中</span>
                        <span class="value" id="processingCount">0</span>
                    </div>
                    <div class="queue-stat">
                        <span class="label">完了</span>
                        <span class="value" id="completedCount">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- メインコンテンツ -->
        <div class="main-content">
            <!-- ヘッダー -->
            <div class="header">
                <div class="header-top">
                    <div>
                        <div class="header-title">統合監視ダッシュボード + 利益計算システム</div>
                        <div class="header-subtitle">Yahoo Auction → eBay・Shopee 完全自動化 + 利益計算統合</div>
                    </div>
                    <div class="header-controls">
                        <button class="control-btn profit" onclick="openProfitCalculator()">
                            <i class="fas fa-calculator"></i> 利益計算
                        </button>
                        <button class="control-btn" onclick="toggleAutoRefresh()">
                            <i class="fas fa-pause" id="autoRefreshIcon"></i>
                            <span id="autoRefreshText">自動更新 ON</span>
                        </button>
                        <button class="control-btn" onclick="reconnectSSE()">
                            <i class="fas fa-sync-alt"></i> 再接続
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- タブナビゲーション -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="showTab('workflow')" data-tab="workflow">
                    <i class="fas fa-tasks"></i> ワークフロー監視
                </button>
                <button class="tab-btn profit" onclick="showTab('profit')" data-tab="profit">
                    <i class="fas fa-calculator"></i> 利益計算システム
                </button>
                <button class="tab-btn" onclick="showTab('analytics')" data-tab="analytics">
                    <i class="fas fa-chart-bar"></i> 分析・統計
                </button>
            </div>
            
            <!-- 統計カード -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="color: var(--primary-color);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-trend" id="processingTrend">+0</div>
                    </div>
                    <div class="stat-value" id="totalProcessing">0</div>
                    <div class="stat-label">処理中ワークフロー</div>
                </div>
                
                <div class="stat-card success">
                    <div class="stat-header">
                        <div class="stat-icon" style="color: var(--success-color);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-trend" id="approvedTrend">+0</div>
                    </div>
                    <div class="stat-value" id="totalApproved">0</div>
                    <div class="stat-label">承認済み</div>
                </div>
                
                <div class="stat-card profit">
                    <div class="stat-header">
                        <div class="stat-icon" style="color: var(--profit-color);">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div class="stat-trend" id="profitTrend">+0</div>
                    </div>
                    <div class="stat-value" id="totalProfitCalc">0</div>
                    <div class="stat-label">利益計算実行</div>
                </div>
                
                <div class="stat-card danger">
                    <div class="stat-header">
                        <div class="stat-icon" style="color: var(--danger-color);">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-trend" id="failedTrend">+0</div>
                    </div>
                    <div class="stat-value" id="totalFailed">0</div>
                    <div class="stat-label">エラー・失敗</div>
                </div>
            </div>
            
            <!-- タブコンテンツ -->
            
            <!-- ワークフロー監視タブ -->
            <div id="workflow" class="tab-content active">
                <div class="content-grid">
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <i class="fas fa-tasks"></i> アクティブワークフロー
                            </div>
                            <button class="control-btn" onclick="refreshWorkflows()">
                                <i class="fas fa-sync-alt" id="workflowRefreshIcon"></i> 更新
                            </button>
                        </div>
                        <div class="panel-content">
                            <div id="workflowList">
                                <div class="empty-state">
                                    <i class="fas fa-search"></i>
                                    <p>ワークフローを読み込み中...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <i class="fas fa-chart-line"></i> 統計・制御
                            </div>
                        </div>
                        <div class="panel-content">
                            <div class="sidebar-section">
                                <h3>緊急制御</h3>
                                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                    <button class="control-btn" style="background: var(--warning-color);" onclick="pauseAllWorkflows()">
                                        <i class="fas fa-pause"></i> 全停止
                                    </button>
                                    <button class="control-btn" onclick="resumeAllWorkflows()">
                                        <i class="fas fa-play"></i> 再開
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 利益計算システムタブ -->
            <div id="profit" class="tab-content">
                <div class="content-grid">
                    <div class="panel" style="grid-column: 1 / -1;">
                        <div class="panel-header">
                            <div class="panel-title">
                                <i class="fas fa-calculator"></i> 利益計算システム統合
                            </div>
                            <div class="header-controls">
                                <button class="control-btn profit" onclick="refreshProfitStats()">
                                    <i class="fas fa-sync-alt"></i> 統計更新
                                </button>
                                <button class="control-btn profit" onclick="openProfitCalculatorNewTab()">
                                    <i class="fas fa-external-link-alt"></i> 新しいタブで開く
                                </button>
                            </div>
                        </div>
                        <div class="panel-content">
                            <iframe 
                                id="profitCalculatorFrame" 
                                class="profit-calculator-embed"
                                src="../05_rieki/advanced_tariff_calculator.php"
                                onload="handleProfitCalculatorLoad()">
                            </iframe>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 分析・統計タブ -->
            <div id="analytics" class="tab-content">
                <div class="content-grid">
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <i class="fas fa-chart-bar"></i> 利益計算履歴
                            </div>
                        </div>
                        <div class="panel-content">
                            <div id="profitHistoryList">
                                <div class="empty-state">
                                    <i class="fas fa-calculator"></i>
                                    <p>利益計算履歴を読み込み中...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <i class="fas fa-chart-pie"></i> プラットフォーム分析
                            </div>
                        </div>
                        <div class="panel-content">
                            <canvas id="platformChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let eventSource = null;
        let isAutoRefreshEnabled = true;
        let currentTab = 'workflow';
        let platformChart = null;
        let dashboardData = {};
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            connectSSE();
            loadProfitStats();
            
            // 利益計算iframe通信設定
            setupProfitCalculatorCommunication();
        });
        
        // SSE接続
        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }

            const clientId = 'dashboard_' + Math.random().toString(36).substr(2, 9);
            eventSource = new EventSource(`server_sent_events_8080.php?action=dashboard&client_id=${clientId}`);

            eventSource.onopen = function(event) {
                updateConnectionStatus(true);
                console.log('SSE接続成功 - 利益計算統合版');
            };

            eventSource.onerror = function(event) {
                updateConnectionStatus(false);
                setTimeout(() => {
                    if (isAutoRefreshEnabled) {
                        connectSSE();
                    }
                }, 5000);
            };

            eventSource.addEventListener('dashboard_update', function(event) {
                const data = JSON.parse(event.data);
                updateDashboard(data);
            });
        }
        
        // ダッシュボード更新
        function updateDashboard(data) {
            updateQueueStats(data.queue_stats || {});
            updateWorkflowList(data.active_workflows || []);
            dashboardData = { ...dashboardData, ...data };
        }
        
        // 利益計算統計読み込み
        function loadProfitStats() {
            fetch('../05_rieki/workflow_integration.php?action=dashboard_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateProfitStats(data.data);
                    }
                })
                .catch(error => {
                    console.error('利益計算統計読み込みエラー:', error);
                });
        }
        
        // 利益計算統計更新
        function updateProfitStats(stats) {
            // サイドバー統計
            animateValue(document.getElementById('totalCalculations'), 0, stats.total_calculations || 0);
            animateValue(document.getElementById('profitableItems'), 0, stats.profitable_items || 0);
            document.getElementById('avgMargin').textContent = (stats.average_profit_margin || 0) + '%';
            animateValue(document.getElementById('ebayCalcs'), 0, stats.platform_breakdown?.ebay || 0);
            animateValue(document.getElementById('shopeeCalcs'), 0, stats.platform_breakdown?.shopee || 0);
            
            // メイン統計カード
            animateValue(document.getElementById('totalProfitCalc'), 0, stats.total_calculations || 0);
            
            // プラットフォーム分析チャート更新
            updatePlatformChart(stats.platform_breakdown || {});
            
            // 履歴リスト更新
            updateProfitHistoryList(stats.recent_calculations || []);
        }
        
        // プラットフォーム分析チャート
        function initializeCharts() {
            const ctx = document.getElementById('platformChart');
            if (ctx) {
                platformChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['高精度シミュレーション', 'eBay USA', 'Shopee 7カ国'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: [
                                '#3498db',
                                '#e74c3c', 
                                '#f39c12'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }
        
        function updatePlatformChart(breakdown) {
            if (platformChart) {
                platformChart.data.datasets[0].data = [
                    breakdown.advanced || 0,
                    breakdown.ebay || 0,
                    breakdown.shopee || 0
                ];
                platformChart.update();
            }
        }
        
        // 利益計算履歴更新
        function updateProfitHistoryList(calculations) {
            const historyList = document.getElementById('profitHistoryList');
            
            if (calculations.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calculator"></i>
                        <p>利益計算履歴がありません</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            calculations.forEach(calc => {
                const profitColor = calc.profit_jpy > 0 ? 'var(--success-color)' : 'var(--danger-color)';
                const typeIcon = getCalcTypeIcon(calc.type);
                
                html += `
                    <div class="profit-result-item">
                        <div class="profit-result-header">
                            <div class="profit-result-type">
                                <i class="fas ${typeIcon}"></i> ${getCalcTypeName(calc.type)}
                            </div>
                            <div class="profit-result-value" style="color: ${profitColor};">
                                ¥${calc.profit_jpy.toLocaleString()}
                            </div>
                        </div>
                        <div class="profit-result-details">
                            利益率: ${calc.margin_percent}% | 計算日時: ${calc.timestamp}
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }
        
        // タブ切り替え
        function showTab(tabName) {
            currentTab = tabName;
            
            // タブボタン更新
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // コンテンツ更新
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // タブ固有の処理
            if (tabName === 'profit') {
                setTimeout(() => {
                    refreshProfitCalculatorFrame();
                }, 300);
            } else if (tabName === 'analytics') {
                loadProfitStats();
            }
        }
        
        // 制御関数
        function toggleAutoRefresh() {
            isAutoRefreshEnabled = !isAutoRefreshEnabled;
            const icon = document.getElementById('autoRefreshIcon');
            const text = document.getElementById('autoRefreshText');
            
            if (isAutoRefreshEnabled) {
                icon.className = 'fas fa-pause';
                text.textContent = '自動更新 ON';
                connectSSE();
            } else {
                icon.className = 'fas fa-play';
                text.textContent = '自動更新 OFF';
                if (eventSource) {
                    eventSource.close();
                }
            }
        }
        
        function reconnectSSE() {
            connectSSE();
            showAlert('SSE接続を再開しました', 'info');
        }
        
        function refreshWorkflows() {
            const icon = document.getElementById('workflowRefreshIcon');
            icon.classList.add('fa-spin');
            
            fetch('integrated_workflow_engine_8080.php?action=get_active_workflows')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateWorkflowList(data.data);
                        showAlert('ワークフロー一覧を更新しました', 'info');
                    }
                })
                .finally(() => {
                    icon.classList.remove('fa-spin');
                });
        }
        
        function refreshProfitStats() {
            loadProfitStats();
            showAlert('利益計算統計を更新しました', 'info');
        }
        
        function openProfitCalculator() {
            showTab('profit');
        }
        
        function openProfitCalculatorNewTab() {
            window.open('../05_rieki/advanced_tariff_calculator.php', '_blank');
        }
        
        function refreshProfitCalculatorFrame() {
            const frame = document.getElementById('profitCalculatorFrame');
            if (frame) {
                frame.src = frame.src;
            }
        }
        
        function handleProfitCalculatorLoad() {
            console.log('利益計算システムが読み込まれました');
        }
        
        // 利益計算iframe通信設定
        function setupProfitCalculatorCommunication() {
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'profit_calculation_result') {
                    // 利益計算結果をワークフローに通知
                    notifyProfitCalculationToWorkflow(event.data.result);
                    
                    // 統計更新
                    setTimeout(loadProfitStats, 1000);
                }
            });
        }
        
        function notifyProfitCalculationToWorkflow(result) {
            const notificationData = {
                action: 'notify_calculation',
                data: {
                    type: result.type || 'advanced',
                    input: result.input || {},
                    result: result
                }
            };
            
            fetch('../05_rieki/workflow_integration.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(notificationData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('利益計算結果をワークフローに統合しました', 'info');
                }
            });
        }
        
        function pauseAllWorkflows() {
            showAlert('全ワークフローの一時停止機能（実装予定）', 'info');
        }
        
        function resumeAllWorkflows() {
            showAlert('全ワークフローの再開機能（実装予定）', 'info');
        }
        
        // ヘルパー関数
        function animateValue(element, start, end, duration = 1000) {
            if (!element) return;
            
            const startTime = Date.now();
            const change = end - start;

            function update() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.floor(start + (change * progress));
                element.textContent = current;

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            update();
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const indicator = statusElement.querySelector('.status-indicator');
            const text = statusElement.querySelector('span');

            if (connected) {
                statusElement.className = 'connection-status connected';
                indicator.className = 'status-indicator connected';
                text.textContent = 'リアルタイム接続中 (統合版)';
            } else {
                statusElement.className = 'connection-status disconnected';
                indicator.className = 'status-indicator disconnected';
                text.textContent = '接続を再試行中...';
            }
        }
        
        function updateQueueStats(queueStats) {
            const elements = {
                highPriorityCount: queueStats.high_priority || 0,
                normalPriorityCount: queueStats.normal_priority || 0,
                processingCount: queueStats.processing || 0,
                completedCount: queueStats.completed_jobs || 0
            };

            Object.keys(elements).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    animateValue(element, parseInt(element.textContent), elements[id]);
                }
            });

            const totalProcessing = (queueStats.high_priority || 0) + 
                                  (queueStats.normal_priority || 0) + 
                                  (queueStats.processing || 0);

            animateValue(document.getElementById('totalProcessing'), 
                        parseInt(document.getElementById('totalProcessing').textContent), totalProcessing);
            animateValue(document.getElementById('totalApproved'), 
                        parseInt(document.getElementById('totalApproved').textContent), queueStats.completed_jobs || 0);
            animateValue(document.getElementById('totalFailed'), 
                        parseInt(document.getElementById('totalFailed').textContent), queueStats.failed_jobs || 0);
        }
        
        function updateWorkflowList(workflows) {
            const workflowList = document.getElementById('workflowList');
            
            if (workflows.length === 0) {
                workflowList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>アクティブなワークフローはありません</p>
                    </div>
                `;
                return;
            }

            let html = '';
            workflows.slice(0, 5).forEach(workflow => {
                html += `
                    <div class="workflow-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>ワークフロー #${workflow.id}</strong><br>
                                <small>ステップ ${workflow.current_step || 1}/9 - ${workflow.status}</small>
                            </div>
                            <div style="text-align: right;">
                                <small>${formatDateTime(workflow.updated_at)}</small>
                            </div>
                        </div>
                    </div>
                `;
            });

            workflowList.innerHTML = html;
        }
        
        function getCalcTypeIcon(type) {
            const icons = {
                'advanced': 'fa-chart-line',
                'ebay': 'fab fa-ebay',
                'shopee': 'fa-shopping-bag'
            };
            return icons[type] || 'fa-calculator';
        }
        
        function getCalcTypeName(type) {
            const names = {
                'advanced': '高精度シミュレーション',
                'ebay': 'eBay USA',
                'shopee': 'Shopee 7カ国'
            };
            return names[type] || type;
        }
        
        function formatDateTime(dateTime) {
            if (!dateTime) return '不明';
            return new Date(dateTime).toLocaleString('ja-JP', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function showAlert(message, type = 'info') {
            // 簡単なアラート表示（実装簡略化）
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
    </script>
</body>
</html>