<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>送料計算システム - NAGANO-3 完全統合版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* ===== 送料計算システム統合CSS（重複整理版 - クラス名変更なし） ===== */
/* HTMLのクラス名は一切変更せず、重複部分のみ統合 */

/* ===== NAGANO-3統一CSS変数（既存活用） ===== */
:root {
    --space-xs: 0.25rem;
    --space-sm: 0.5rem;
    --space-md: 1rem;
    --space-lg: 1.5rem;
    --space-xl: 2rem;
    --space-2xl: 3rem;
    
    --color-primary: #3b82f6;
    --color-secondary: #8b5cf6;
    --color-success: #10b981;
    --color-warning: #f59e0b;
    --color-danger: #ef4444;
    --color-info: #06b6d4;
    
    --accent-blue: #06b6d4;
    --accent-purple: #8b5cf6;
    --accent-green: #10b981;
    --accent-yellow: #f59e0b;
    --accent-red: #ef4444;
    --accent-orange: #f97316;
    
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f1f5f9;
    --bg-hover: #e2e8f0;
    --bg-active: #cbd5e1;
    
    --text-primary: #1e293b;
    --text-secondary: #475569;
    --text-tertiary: #64748b;
    --text-muted: #94a3b8;
    --text-white: #ffffff;
    
    --border-color: #e2e8f0;
    --border-light: #f1f5f9;
    --border-dark: #cbd5e1;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    
    --radius-sm: 0.25rem;
    --radius-md: 0.375rem;
    --radius-lg: 0.5rem;
    --radius-xl: 0.75rem;
    --radius-full: 9999px;
    --transition-fast: all 0.15s ease-in-out;
    --transition-normal: all 0.2s ease-in-out;
    
    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    --text-3xl: 1.875rem;
    
    --z-modal-backdrop: 1000;
    --z-modal: 1001;
}

/* ===== 基本リセット ===== */
* {
    box-sizing: border-box;
}

body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
}

/* ===== ボタンシステム ===== */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: var(--text-sm);
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: var(--transition-fast);
    white-space: nowrap;
    font-family: inherit;
}

.btn:hover {
    background: var(--bg-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
}

.btn--small {
    padding: var(--space-xs) var(--space-sm);
    font-size: var(--text-xs);
}

.btn--primary {
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    color: var(--text-white);
    border-color: transparent;
    box-shadow: var(--shadow-md);
}

.btn--primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn--secondary {
    background: transparent;
    color: var(--color-primary);
    border: 1px solid var(--color-primary);
}

.btn--secondary:hover {
    background: var(--color-primary);
    color: var(--text-white);
}

.btn--success {
    background: var(--color-success);
    color: var(--text-white);
    border-color: var(--color-success);
}

.btn--warning {
    background: var(--color-warning);
    color: var(--text-white);
    border-color: var(--color-warning);
}

.btn--danger {
    background: var(--color-danger);
    color: var(--text-white);
    border-color: var(--color-danger);
}

.btn--info {
    background: var(--color-info);
    color: var(--text-white);
    border-color: var(--color-info);
}

.btn--full {
    width: 100%;
    justify-content: center;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* ===== レイアウト ===== */
.content {
    margin-left: 0 !important;
    max-width: 100vw;
    padding: var(--space-lg);
    overflow-x: hidden;
    box-sizing: border-box;
}

/* ===== ヘッダー ===== */
.shipping__header {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin-bottom: var(--space-xl);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-lg);
    flex-wrap: wrap;
}

.shipping__page-title {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 var(--space-md) 0;
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.shipping__page-icon {
    color: var(--color-primary);
    font-size: var(--text-2xl);
}

.shipping__system-status {
    display: flex;
    gap: var(--space-md);
    align-items: center;
    flex-wrap: wrap;
}

.shipping__status-item {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-sm);
    color: var(--text-secondary);
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-primary);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
}

.shipping__status-item--active {
    color: var(--color-success);
}

.shipping__header-actions {
    display: flex;
    gap: var(--space-md);
    align-items: center;
    flex-wrap: wrap;
}

/* ===== セクション ===== */
.shipping__section {
    margin-bottom: var(--space-xl);
}

.shipping__section-header {
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-lg);
    flex-wrap: wrap;
}

.shipping__section-title {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 var(--space-sm) 0;
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.shipping__section-title i {
    color: var(--color-primary);
}

.shipping__section-subtitle {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    margin: 0;
}

.shipping__section-actions {
    display: flex;
    gap: var(--space-md);
    align-items: center;
    flex-wrap: wrap;
}

/* ===== カードレイアウト ===== */
.shipping__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
    align-items: start;
}

.shipping__card {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    transition: var(--transition-fast);
}

.shipping__card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.shipping__card-header {
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.shipping__card-header h3 {
    margin: 0;
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--text-primary);
}

.shipping__card-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: var(--text-white);
}

.shipping__card-icon--carrier {
    background: var(--color-primary);
}

.shipping__card-icon--condition {
    background: var(--accent-purple);
}

.shipping__card-icon--region {
    background: var(--color-success);
}

.shipping__card-icon--marketplace {
    background: var(--accent-orange);
}

.shipping__card-body {
    padding: var(--space-lg);
    flex: 1;
    display: flex;
    flex-direction: column;
}

/* ===== フォーム要素 ===== */
.shipping__form-group {
    margin-bottom: var(--space-lg);
}

.shipping__form-label {
    display: block;
    margin-bottom: var(--space-sm);
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--text-primary);
}

.shipping__form-input,
.shipping__form-select {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: var(--transition-fast);
    min-height: 40px;
    font-family: inherit;
}

.shipping__form-input:focus,
.shipping__form-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* ===== 配送会社管理 ===== */
.shipping__carrier-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-md);
}

.shipping__carrier-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    transition: var(--transition-fast);
}

.shipping__carrier-item:hover {
    box-shadow: var(--shadow-sm);
    transform: translateY(-1px);
}

.shipping__carrier-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-sm);
}

.shipping__carrier-name {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.shipping__carrier-info {
    font-size: var(--text-xs);
    color: var(--text-secondary);
    margin-bottom: var(--space-sm);
    line-height: 1.4;
}

.shipping__carrier-actions {
    display: flex;
    gap: var(--space-xs);
    flex-wrap: wrap;
}

.shipping__carrier-actions .btn {
    flex: 1;
    min-width: 60px;
}

.shipping__file-upload {
    display: none;
}

/* ===== ステータスバッジ ===== */
.shipping__status-badge {
    font-size: var(--text-xs);
    font-weight: 600;
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-full);
    white-space: nowrap;
}

.shipping__status-badge--active {
    background: rgba(16, 185, 129, 0.1);
    color: var(--color-success);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.shipping__status-badge--pending {
    background: rgba(245, 158, 11, 0.1);
    color: var(--color-warning);
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.shipping__status-badge--inactive {
    background: rgba(107, 114, 128, 0.1);
    color: var(--text-secondary);
    border: 1px solid rgba(107, 114, 128, 0.3);
}

/* ===== モール別配送方法設定エリア ===== */
.shipping__marketplace-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: var(--space-lg);
}

.shipping__marketplace-item {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    transition: var(--transition-fast);
    display: flex;
    flex-direction: column;
    min-height: 180px;
}

.shipping__marketplace-item:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.shipping__marketplace-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-sm);
    gap: var(--space-sm);
    flex-wrap: wrap;
}

.shipping__marketplace-name {
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex: 1;
    min-width: 0;
}

.shipping__toggle-btn {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    transition: var(--transition-fast);
    flex-shrink: 0;
}

.shipping__toggle-btn i {
    transition: transform 0.3s ease;
}

.shipping__marketplace-summary {
    padding: var(--space-sm);
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-sm);
    border-left: 3px solid var(--color-primary);
}

.shipping__marketplace-summary strong {
    color: var(--color-primary);
}

.shipping__selected-preview {
    display: block;
    font-size: var(--text-xs);
    color: var(--text-secondary);
    margin-top: var(--space-xs);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.shipping__marketplace-methods {
    overflow: hidden;
    transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
    max-height: 400px;
    opacity: 1;
}

.shipping__marketplace-methods--collapsed {
    max-height: 0;
    opacity: 0;
}

.shipping__select-actions {
    display: flex;
    gap: var(--space-xs);
    margin-bottom: var(--space-sm);
    flex-wrap: wrap;
}

.shipping__select-actions .btn {
    font-size: var(--text-xs);
    padding: var(--space-xs) var(--space-sm);
    flex: 1;
    min-width: 80px;
}

.shipping__method-search {
    margin-bottom: var(--space-sm);
}

.shipping__method-search .shipping__form-input {
    font-size: var(--text-xs);
    padding: var(--space-xs) var(--space-sm);
    min-height: 32px;
}

.shipping__method-scroll {
    max-height: 160px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    margin-bottom: var(--space-sm);
}

.shipping__method-scroll::-webkit-scrollbar {
    width: 4px;
}

.shipping__method-scroll::-webkit-scrollbar-track {
    background: var(--bg-primary);
    border-radius: var(--radius-sm);
}

.shipping__method-scroll::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: var(--radius-sm);
    transition: var(--transition-fast);
}

.shipping__method-scroll::-webkit-scrollbar-thumb:hover {
    background: var(--color-primary);
}

.shipping__method-scroll {
    scrollbar-width: thin;
    scrollbar-color: var(--border-color) var(--bg-primary);
}

.shipping__method-item-checkbox {
    padding: var(--space-xs) var(--space-sm);
    border-bottom: 1px solid var(--border-light);
    transition: var(--transition-fast);
}

.shipping__method-item-checkbox:last-child {
    border-bottom: none;
}

.shipping__method-item-checkbox:hover {
    background: var(--bg-hover);
}

.shipping__checkbox-container {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    cursor: pointer;
    width: 100%;
}

.shipping__checkbox {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
}

.shipping__checkmark {
    width: 16px;
    height: 16px;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: var(--radius-sm);
    position: relative;
    transition: var(--transition-fast);
    flex-shrink: 0;
}

.shipping__checkbox:checked ~ .shipping__checkmark {
    background: var(--color-primary);
    border-color: var(--color-primary);
}

.shipping__checkmark::after {
    content: '';
    position: absolute;
    display: none;
    left: 4px;
    top: 1px;
    width: 3px;
    height: 7px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.shipping__checkbox:checked ~ .shipping__checkmark::after {
    display: block;
}

.shipping__carrier-details {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-xs);
}

.shipping__carrier-details i {
    color: var(--color-primary);
    width: 14px;
    flex-shrink: 0;
}

.shipping__marketplace-restrictions {
    margin-top: auto;
    padding-top: var(--space-sm);
    font-size: var(--text-xs);
    color: var(--text-secondary);
    border-top: 1px solid var(--border-light);
    line-height: 1.4;
}

.shipping__optimization-note {
    font-size: var(--text-xs);
    color: var(--text-secondary);
    font-style: italic;
}

.shipping__carrier-management {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin-top: var(--space-xl);
}

.shipping__carrier-management h3 {
    margin-bottom: var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    color: var(--text-primary);
}

.shipping__carrier-management-actions {
    display: flex;
    gap: var(--space-md);
    flex-wrap: wrap;
}

/* ===== カテゴリー管理 ===== */
.shipping__category-scroll-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
}

.shipping__category-scroll-item {
    padding: var(--space-sm) var(--space-md);
    border-bottom: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: var(--transition-fast);
}

.shipping__category-scroll-item:last-child {
    border-bottom: none;
}

.shipping__category-scroll-item:hover {
    background: var(--bg-hover);
}

.shipping__category-name {
    flex: 1;
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--text-primary);
}

.shipping__category-actions {
    display: flex;
    gap: var(--space-xs);
    opacity: 0.7;
    transition: var(--transition-fast);
}

.shipping__category-scroll-item:hover .shipping__category-actions {
    opacity: 1;
}

/* ===== 地域別調整テーブル ===== */
.shipping__region-table {
    width: 100%;
    border-collapse: collapse;
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.shipping__region-table th,
.shipping__region-table td {
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.shipping__region-table th {
    background: var(--bg-tertiary);
    font-weight: 600;
    color: var(--text-primary);
    font-size: var(--text-sm);
}

.shipping__region-table tbody tr:hover {
    background: var(--bg-hover);
}

/* ===== モーダル ===== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    z-index: var(--z-modal-backdrop);
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
    opacity: 0;
    visibility: hidden;
    transition: var(--transition-normal);
}

.modal-overlay--active {
    opacity: 1;
    visibility: visible;
}

.modal {
    background: var(--bg-secondary);
    border-radius: var(--radius-xl);
    max-width: 95%;
    width: 1200px;
    max-height: 95vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    padding: var(--space-xl);
    border: 1px solid var(--border-color);
    transform: scale(0.95) translateY(-20px);
    transition: var(--transition-normal);
}

.modal-overlay--active .modal {
    transform: scale(1) translateY(0);
}

.modal__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--border-light);
}

.modal__title {
    font-size: var(--text-xl);
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.modal__close {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    transition: var(--transition-fast);
}

.modal__close:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.modal__body {
    margin-bottom: var(--space-lg);
    line-height: 1.6;
}

.modal__footer {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-sm);
}

/* ===== アラート表示 ===== */
.shipping__alert {
    display: none;
    padding: var(--space-sm);
    margin-bottom: var(--space-sm);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    font-weight: 600;
    align-items: center;
    gap: var(--space-xs);
    position: fixed;
    top: 15px;
    right: 15px;
    z-index: 1100;
    max-width: 350px;
    box-shadow: var(--shadow-md);
    animation: slideInRight 0.3s ease;
}

.shipping__alert--success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--color-success);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.shipping__alert--error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--color-danger);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.shipping__alert--warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--color-warning);
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.shipping__alert--info {
    background: rgba(6, 182, 212, 0.1);
    color: var(--color-info);
    border: 1px solid rgba(6, 182, 212, 0.3);
}

.shipping__alert.show {
    display: flex;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* ===== 計算結果表示 ===== */
.shipping__calculation-result {
    background: var(--bg-secondary);
    border: 2px solid var(--color-success);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin: var(--space-lg) 0;
    display: none;
}

.shipping__result-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-top: var(--space-md);
}

.shipping__result-item {
    background: var(--bg-primary);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-primary);
    box-shadow: var(--shadow-sm);
}

.shipping__result-item--total {
    border-left-color: var(--color-success);
}

.shipping__result-label {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
}

.shipping__result-value {
    font-size: var(--text-lg);
    font-weight: bold;
    color: var(--color-primary);
}

.shipping__result-value--total {
    color: var(--color-success);
    font-size: var(--text-xl);
}

/* ===== 分岐条件入力フォーム ===== */
.shipping__condition-form {
    background: var(--bg-tertiary);
    padding: var(--space-lg);
    border-radius: var(--radius-md);
    border: 2px dashed var(--border-color);
    margin-bottom: var(--space-md);
    display: none;
}

.shipping__condition-form--active {
    display: block;
    border-color: var(--color-primary);
}

.shipping__condition-form-row {
    display: grid;
    grid-template-columns: 1fr auto 1fr auto 1fr auto;
    gap: var(--space-sm);
    align-items: end;
    margin-bottom: var(--space-md);
}

/* ===== 地域別料金表用スタイル ===== */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-xl);
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    flex-wrap: wrap;
    gap: var(--space-lg);
}

.page-title {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 var(--space-md) 0;
    display: flex;
    align-items: center;
    gap: var(--space-md);
}

.page-icon {
    color: var(--color-primary);
    font-size: var(--text-2xl);
}

.page-subtitle {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    margin: 0;
    line-height: 1.5;
}

.page-actions {
    display: flex;
    gap: var(--space-md);
    align-items: center;
    flex-wrap: wrap;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
}

.stat-card {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    transition: var(--transition-fast);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.stat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-lg);
    color: var(--text-white);
    box-shadow: var(--shadow-sm);
}

.stat-icon--primary {
    background: var(--color-primary);
}

.stat-icon--success {
    background: var(--color-success);
}

.stat-icon--warning {
    background: var(--color-warning);
}

.stat-icon--info {
    background: var(--color-info);
}

.stat-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--text-secondary);
    margin: 0;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
}

.stat-description {
    font-size: var(--text-xs);
    color: var(--text-secondary);
    line-height: 1.4;
}

.filter-section {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    margin-bottom: var(--space-xl);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.filter-label {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--text-primary);
}

.filter-select {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: var(--text-sm);
    transition: var(--transition-fast);
    min-height: 40px;
    font-family: inherit;
}

.filter-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.table-container {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    overflow: hidden;
    margin-bottom: var(--space-xl);
}

.table-header {
    background: var(--bg-tertiary);
    padding: var(--space-lg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-md);
}

.table-title {
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.table-actions {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
}

.table-wrapper {
    overflow-x: auto;
    max-height: 70vh;
    position: relative;
}

.rates-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--text-sm);
    min-width: 1400px;
}

.rates-table th,
.rates-table td {
    padding: var(--space-sm) var(--space-md);
    text-align: left;
    border-bottom: 1px solid var(--border-light);
    vertical-align: middle;
}

.rates-table th {
    background: var(--bg-tertiary);
    font-weight: 600;
    color: var(--text-primary);
    position: sticky;
    top: 0;
    z-index: 10;
}

.rates-table tbody tr:hover {
    background: var(--bg-hover);
}

.zone-header {
    background: rgba(59, 130, 246, 0.1) !important;
    font-weight: bold;
    color: var(--color-primary);
}

.zone-header td {
    padding: var(--space-md);
    border-bottom: 2px solid var(--color-primary);
}

.carrier-name {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    min-width: 200px;
}

.price-cell {
    font-weight: 600;
    text-align: center;
}

.price-economy {
    color: var(--color-success);
}

.price-expedited {
    color: var(--color-warning);
}

.price-premium {
    color: var(--color-danger);
}

.delivery-days {
    text-align: center;
    color: var(--text-secondary);
}

.fuel-rate {
    text-align: center;
    font-weight: 600;
    color: var(--color-info);
}

.recommended {
    background: rgba(16, 185, 129, 0.1) !important;
    border-left: 4px solid var(--color-success);
}

/* ===== レスポンシブ対応 ===== */
@media (max-width: 1200px) {
    .shipping__marketplace-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .shipping__method-scroll {
        max-height: 140px;
    }
    
    .page-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .page-actions {
        justify-content: center;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .filter-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .content {
        padding: var(--space-md);
    }
    
    .shipping__header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-md);
    }
    
    .shipping__header-actions {
        justify-content: center;
    }
    
    .shipping__grid,
    .shipping__marketplace-grid {
        grid-template-columns: 1fr;
    }

    .shipping__carrier-actions {
        flex-direction: column;
    }

    .shipping__carrier-actions .btn {
        width: 100%;
    }

    .shipping__condition-form-row {
        grid-template-columns: 1fr;
        gap: var(--space-sm);
    }
    
    .shipping__marketplace-item {
        min-height: 160px;
    }
    
    .shipping__marketplace-header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-sm);
    }
    
    .shipping__method-scroll {
        max-height: 120px;
    }
    
    .shipping__select-actions {
        justify-content: center;
    }
    
    .shipping__carrier-details {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-xs);
    }
    
    .shipping__carrier-name {
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
    }
    
    .shipping__carrier-management-actions {
        flex-direction: column;
    }
    
    .shipping__carrier-management-actions .btn {
        width: 100%;
        justify-content: center;
    }
    
    .page-header {
        padding: var(--space-md);
    }
    
    .page-title {
        font-size: var(--text-xl);
        flex-direction: column;
        text-align: center;
        gap: var(--space-sm);
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .filter-grid {
        grid-template-columns: 1fr;
    }
    
    .table-header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-md);
    }
    
    .table-actions {
        justify-content: center;
    }
    
    .rates-table {
        font-size: var(--text-xs);
    }
    
    .rates-table th,
    .rates-table td {
        padding: var(--space-xs) var(--space-sm);
    }
    
    .carrier-name {
        min-width: 150px;
        font-size: var(--text-xs);
    }
    
    .page-actions {
        flex-direction: column;
        gap: var(--space-sm);
    }
    
    .page-actions .btn {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .shipping__grid {
        gap: var(--space-lg);
    }
    
    .shipping__marketplace-item {
        min-height: 140px;
        padding: var(--space-md);
    }
    
    .shipping__method-scroll {
        max-height: 100px;
    }
    
    .shipping__select-actions {
        flex-direction: column;
    }
    
    .shipping__select-actions .btn {
        width: 100%;
        justify-content: center;
    }
    
    .page-header {
        padding: var(--space-sm);
    }
    
    .filter-section {
        padding: var(--space-md);
    }
    
    .table-header {
        padding: var(--space-md);
    }
    
    .stat-card {
        padding: var(--space-md);
    }
    
    .stat-value {
        font-size: var(--text-xl);
    }
    
    .carrier-name {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-xs);
        min-width: 120px;
    }
    
    .carrier-name i {
        width: auto;
    }
}

/* ===== アクセシビリティ対応 ===== */
@media (prefers-reduced-motion: reduce) {
    .shipping__marketplace-methods,
    .shipping__checkmark,
    .shipping__method-item-checkbox,
    .shipping__toggle-btn,
    .stat-card,
    .table-container,
    .filter-select {
        transition: none;
    }
    
    .stat-card:hover {
        transform: none;
    }
}

.shipping__checkbox:focus + .shipping__checkmark {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
}

@media (prefers-contrast: high) {
    .zone-header {
        background: var(--color-primary) !important;
        color: white;
    }
    
    .recommended {
        border-left-width: 6px;
    }
    
    .rates-table th {
        background: var(--text-primary);
        color: var(--bg-secondary);
    }
}

/* ===== ダークテーマ対応 ===== */
[data-theme="dark"] .shipping__method-scroll {
    background: #2f3136;
    border-color: #40444b;
}

[data-theme="dark"] .shipping__method-item-checkbox:hover {
    background: #36393f;
}

[data-theme="dark"] .shipping__checkmark {
    background: #36393f;
    border-color: #40444b;
}

[data-theme="dark"] .shipping__marketplace-summary {
    background: #36393f;
}

[data-theme="dark"] .shipping__method-scroll::-webkit-scrollbar-track {
    background: #2f3136;
}

[data-theme="dark"] .shipping__method-scroll::-webkit-scrollbar-thumb {
    background: #40444b;
}

[data-theme="dark"] .shipping__method-scroll::-webkit-scrollbar-thumb:hover {
    background: #5865f2;
}
</style>
<script>
// CAIDS error_handling Hook

// CAIDS エラー処理Hook - 完全実装
window.CAIDS_ERROR_HANDLER = {
    isActive: true,
    errorCount: 0,
    errorHistory: [],
    
    initialize: function() {
        this.setupGlobalErrorHandler();
        this.setupUnhandledPromiseRejection();
        this.setupNetworkErrorHandler();
        console.log('⚠️ CAIDS エラーハンドリングシステム完全初期化');
    },
    
    setupGlobalErrorHandler: function() {
        window.addEventListener('error', (event) => {
            this.handleError({
                type: 'JavaScript Error',
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack
            });
        });
    },
    
    setupUnhandledPromiseRejection: function() {
        window.addEventListener('unhandledrejection', (event) => {
            this.handleError({
                type: 'Unhandled Promise Rejection',
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack
            });
        });
    },
    
    setupNetworkErrorHandler: function() {
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                if (!response.ok) {
                    window.CAIDS_ERROR_HANDLER.handleError({
                        type: 'Network Error',
                        message: `HTTP ${response.status}: ${response.statusText}`,
                        url: args[0]
                    });
                }
                return response;
            } catch (error) {
                window.CAIDS_ERROR_HANDLER.handleError({
                    type: 'Network Fetch Error',
                    message: error.message,
                    url: args[0]
                });
                throw error;
            }
        };
    },
    
    handleError: function(errorInfo) {
        this.errorCount++;
        this.errorHistory.push({...errorInfo, timestamp: new Date().toISOString()});
        
        console.error('🚨 CAIDS Error Handler:', errorInfo);
        this.showErrorNotification(errorInfo);
        this.reportError(errorInfo);
    },
    
    showErrorNotification: function(errorInfo) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 10px; right: 10px; z-index: 999999;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 350px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            border: 2px solid #ff6666; animation: caids-error-shake 0.5s ease-in-out;
        `;
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">🚨</span>
                <div>
                    <strong>エラーが発生しました</strong><br>
                    <small style="opacity: 0.9;">${errorInfo.type}: ${errorInfo.message}</small>
                </div>
            </div>
        `;
        
        // CSS Animation
        if (!document.getElementById('caids-error-styles')) {
            const style = document.createElement('style');
            style.id = 'caids-error-styles';
            style.textContent = `
                @keyframes caids-error-shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 7000);
    },
    
    reportError: function(errorInfo) {
        // エラーレポート生成・送信（将来の拡張用）
        const report = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            errorCount: this.errorCount,
            sessionId: this.getSessionId(),
            ...errorInfo
        };
        
        console.log('📋 CAIDS Error Report:', report);
        localStorage.setItem('caids_last_error', JSON.stringify(report));
    },
    
    getSessionId: function() {
        let sessionId = sessionStorage.getItem('caids_session_id');
        if (!sessionId) {
            sessionId = 'caids_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('caids_session_id', sessionId);
        }
        return sessionId;
    },
    
    getErrorStats: function() {
        return {
            totalErrors: this.errorCount,
            recentErrors: this.errorHistory.slice(-10),
            sessionId: this.getSessionId()
        };
    }
};

window.CAIDS_ERROR_HANDLER.initialize();

</script>
<script>
// CAIDS user_feedback Hook
// CAIDS user_feedback Hook - 基本実装
console.log('✅ user_feedback Hook loaded');
</script>
<script>
// CAIDS character_limit Hook
// CAIDS character_limit Hook - 基本実装
console.log('✅ character_limit Hook loaded');
</script>
<script>
// CAIDS natural_explanation Hook
// CAIDS natural_explanation Hook - 基本実装
console.log('✅ natural_explanation Hook loaded');
</script>
<script>
// CAIDS character_monitoring Hook
// CAIDS character_monitoring Hook - 基本実装
console.log('✅ character_monitoring Hook loaded');
</script>
<script>
// CAIDS emergency_accumulation Hook
// CAIDS emergency_accumulation Hook - 基本実装
console.log('✅ emergency_accumulation Hook loaded');
</script>
<script>
// CAIDS processing_capacity_monitoring Hook
// CAIDS processing_capacity_monitoring Hook - 基本実装
console.log('✅ processing_capacity_monitoring Hook loaded');
</script>
<script>
// CAIDS pre_analysis_enforcement Hook
// CAIDS pre_analysis_enforcement Hook - 基本実装
console.log('✅ pre_analysis_enforcement Hook loaded');
</script>
<script>
// CAIDS user_approval_required Hook
// CAIDS user_approval_required Hook - 基本実装
console.log('✅ user_approval_required Hook loaded');
</script>
<script>
// CAIDS timeout_management Hook
// CAIDS timeout_management Hook - 基本実装
console.log('✅ timeout_management Hook loaded');
</script>
<script>
// CAIDS development_control Hook
// CAIDS development_control Hook - 基本実装
console.log('✅ development_control Hook loaded');
</script>
</head>
<body>
    <!-- アラート表示エリア -->
    <div class="shipping__alert shipping__alert--success" id="successAlert">
        <i class="fas fa-check-circle"></i>
        <span id="successMessage">処理が正常に完了しました。</span>
    </div>

    <div class="shipping__alert shipping__alert--error" id="errorAlert">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="errorMessage">エラーが発生しました。</span>
    </div>

    <div class="shipping__alert shipping__alert--warning" id="warningAlert">
        <i class="fas fa-exclamation-circle"></i>
        <span id="warningMessage">警告メッセージです。</span>
    </div>

    <div class="shipping__alert shipping__alert--info" id="infoAlert">
        <i class="fas fa-info-circle"></i>
        <span id="infoMessage">情報メッセージです。</span>
    </div>

    <!-- メインコンテンツ -->
    <main class="content">
        <!-- ページヘッダー -->
        <div class="shipping__header">
            <div>
                <h1 class="shipping__page-title">
                    <i class="fas fa-shipping-fast shipping__page-icon"></i>
                    送料計算システム - NAGANO-3 完全統合版
                </h1>
                <div class="shipping__system-status">
                    <div class="shipping__status-item shipping__status-item--active">
                        <i class="fas fa-circle"></i>
                        <span>システム稼働中</span>
                    </div>
                    <div class="shipping__status-item">
                        <i class="fas fa-database"></i>
                        API連携: 正常
                    </div>
                    <div class="shipping__status-item">
                        <i class="fas fa-fire"></i>
                        燃油サーチャージ: API自動取得
                    </div>
                    <div class="shipping__status-item">
                        <i class="fas fa-clock"></i>
                        <span>最終更新: <span id="last-update-time">2025/06/29 14:30</span></span>
                    </div>
                </div>
            </div>
            <div class="shipping__header-actions">
                <button class="btn btn--secondary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                    データ更新
                </button>
                <button class="btn btn--primary" onclick="openCalculator()">
                    <i class="fas fa-calculator"></i>
                    送料計算テスト
                </button>
                <button class="btn btn--success" onclick="openRegionalRatesModal()">
                    <i class="fas fa-globe"></i>
                    地域別料金表
                </button>
            </div>
        </div>

        <!-- 配送会社管理セクション（全配送会社対応版） -->
        <section class="shipping__section" id="carriers">
            <div class="shipping__section-header">
                <div>
                    <h2 class="shipping__section-title">
                        <i class="fas fa-truck"></i>
                        配送会社管理（全18社対応）
                    </h2>
                    <p class="shipping__section-subtitle">
                        配送会社別CSV料金データ管理・API自動連携・地域別料金設定・燃油サーチャージAPI自動取得
                    </p>
                </div>
                <div class="shipping__section-actions">
                    <button class="btn btn--secondary" onclick="addNewCarrier()">
                        <i class="fas fa-plus"></i>
                        配送会社追加
                    </button>
                    <button class="btn btn--warning" onclick="bulkUpdateRates()">
                        <i class="fas fa-sync-alt"></i>
                        一括料金更新
                    </button>
                </div>
            </div>

            <div class="shipping__carrier-list" id="carrierList">
                <!-- FedEx関連 -->
                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-plane"></i>
                            FedEx（通常）
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--active">
                            API連携済み
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 2024/06/29 10:30 | レコード数: 2,220件 | 燃油サーチャージ: API自動取得（12.5%） | 対応地域: 全世界
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="fedex-normal-csv" accept=".csv" onchange="uploadCarrierCSV('fedex-normal', this)">
                        <button class="btn btn--small btn--secondary" onclick="document.getElementById('fedex-normal-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV更新
                        </button>
                        <button class="btn btn--small btn--success" onclick="updateAPIRates('fedex-normal')">
                            <i class="fas fa-sync"></i>
                            API更新
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('fedex-normal')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-shipping-fast"></i>
                            CPASS + FedEx
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--active">
                            割引料金適用
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 2024/06/20 14:20 | レコード数: 1,680件 | 燃油サーチャージ: 料金に含む | 割引率: 15-25%
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="cpass-fedex-csv" accept=".csv" onchange="uploadCarrierCSV('cpass-fedex', this)">
                        <button class="btn btn--small btn--primary" onclick="document.getElementById('cpass-fedex-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV登録
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('cpass-fedex')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-box"></i>
                            Eloji + FedEx
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--active">
                            データ更新済み
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 2024/06/25 09:15 | レコード数: 1,940件 | 燃油サーチャージ: 料金に含む | 特徴: 日本特化
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="eloji-fedex-csv" accept=".csv" onchange="uploadCarrierCSV('eloji-fedex', this)">
                        <button class="btn btn--small btn--secondary" onclick="document.getElementById('eloji-fedex-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV更新
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('eloji-fedex')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <!-- DHL関連 -->
                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-shipping-fast"></i>
                            DHL（通常）
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--active">
                            API連携済み
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 2024/06/29 11:15 | レコード数: 1,940件 | 燃油サーチャージ: API自動取得（18.0%） | 強み: 欧州・アジア
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="dhl-normal-csv" accept=".csv" onchange="uploadCarrierCSV('dhl-normal', this)">
                        <button class="btn btn--small btn--secondary" onclick="document.getElementById('dhl-normal-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV更新
                        </button>
                        <button class="btn btn--small btn--success" onclick="updateAPIRates('dhl-normal')">
                            <i class="fas fa-sync"></i>
                            API更新
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('dhl-normal')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-shipping-fast"></i>
                            CPASS + DHL
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--pending">
                            データ期限近い
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 2024/05/15 16:45 | レコード数: 1,520件 | 燃油サーチャージ: 料金に含む | 割引率: 20-30%
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="cpass-dhl-csv" accept=".csv" onchange="uploadCarrierCSV('cpass-dhl', this)">
                        <button class="btn btn--small btn--secondary" onclick="document.getElementById('cpass-dhl-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV更新
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('cpass-dhl')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-box"></i>
                            Eloji + DHL
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--active">
                            データ更新済み
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 2024/06/22 11:30 | レコード数: 1,780件 | 燃油サーチャージ: 料金に含む | 特徴: アジア最適化
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="eloji-dhl-csv" accept=".csv" onchange="uploadCarrierCSV('eloji-dhl', this)">
                        <button class="btn btn--small btn--secondary" onclick="document.getElementById('eloji-dhl-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV更新
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('eloji-dhl')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <!-- UPS関連 -->
                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-truck"></i>
                            UPS（通常）
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--pending">
                            API設定中
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 2024/06/15 09:00 | レコード数: 1,250件 | 燃油サーチャージ: API自動取得（15.2%） | 強み: 北米・南米
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="ups-normal-csv" accept=".csv" onchange="uploadCarrierCSV('ups-normal', this)">
                        <button class="btn btn--small btn--secondary" onclick="document.getElementById('ups-normal-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV更新
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('ups-normal')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-box"></i>
                            Eloji + UPS
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--pending">
                            CSV更新要
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 2024/06/10 14:30 | レコード数: 890件 | 燃油サーチャージ: 料金に含む | 割引率: 10-20%
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="eloji-ups-csv" accept=".csv" onchange="uploadCarrierCSV('eloji-ups', this)">
                        <button class="btn btn--small btn--primary" onclick="document.getElementById('eloji-ups-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV更新
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('eloji-ups')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <!-- 日本郵便関連 -->
                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-mail-bulk"></i>
                            日本郵便 EMS
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--active">
                            API連携済み
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 2024/06/28 08:00 | レコード数: 950件 | 燃油サーチャージ: API自動取得（5.8%） | 特徴: 日本発送最適
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="jppost-ems-csv" accept=".csv" onchange="uploadCarrierCSV('jppost-ems', this)">
                        <button class="btn btn--small btn--secondary" onclick="document.getElementById('jppost-ems-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV更新
                        </button>
                        <button class="btn btn--small btn--success" onclick="updateAPIRates('jppost-ems')">
                            <i class="fas fa-sync"></i>
                            API更新
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('jppost-ems')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-mail-bulk"></i>
                            日本郵便 小型包装物
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--active">
                            データ更新済み
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 2024/06/26 15:20 | レコード数: 680件 | 燃油サーチャージ: 料金に含む | 特徴: 小物特化
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="jppost-small-csv" accept=".csv" onchange="uploadCarrierCSV('jppost-small', this)">
                        <button class="btn btn--small btn--secondary" onclick="document.getElementById('jppost-small-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV更新
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('jppost-small')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-mail-bulk"></i>
                            日本郵便 書留
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--active">
                            データ更新済み
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 2024/06/25 12:10 | レコード数: 430件 | 燃油サーチャージ: 料金に含む | 特徴: 保険付
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="jppost-registered-csv" accept=".csv" onchange="uploadCarrierCSV('jppost-registered', this)">
                        <button class="btn btn--small btn--secondary" onclick="document.getElementById('jppost-registered-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV更新
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('jppost-registered')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <!-- eBay関連 -->
                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fab fa-ebay"></i>
                            CPASS + eBayスピードパック
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--active">
                            データ更新済み
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 2024/06/27 10:45 | レコード数: 1,240件 | 燃油サーチャージ: 料金に含む | 特徴: eBay最適化
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="cpass-ebay-csv" accept=".csv" onchange="uploadCarrierCSV('cpass-ebay', this)">
                        <button class="btn btn--small btn--secondary" onclick="document.getElementById('cpass-ebay-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV更新
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('cpass-ebay')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fab fa-ebay"></i>
                            Eloji + eBayスピードパック
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--pending">
                            設定中
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 未設定 | レコード数: 0件 | 燃油サーチャージ: 未設定 | 特徴: 新規追加予定
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="eloji-ebay-csv" accept=".csv" onchange="uploadCarrierCSV('eloji-ebay', this)">
                        <button class="btn btn--small btn--primary" onclick="document.getElementById('eloji-ebay-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV登録
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('eloji-ebay')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <!-- USPS関連 -->
                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-envelope"></i>
                            USPS Priority Mail
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--pending">
                            API設定中
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        最終更新: 2024/06/20 16:20 | レコード数: 820件 | 燃油サーチャージ: API自動取得（8.5%） | 特徴: 米国内最安
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="usps-priority-csv" accept=".csv" onchange="uploadCarrierCSV('usps-priority', this)">
                        <button class="btn btn--small btn--secondary" onclick="document.getElementById('usps-priority-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV更新
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('usps-priority')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-envelope"></i>
                            USPS Priority Express
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--inactive">
                            未設定
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        CSVデータが登録されていません | ステータス: 未設定 | 燃油サーチャージ: 未設定 | 特徴: 速達サービス
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="usps-express-csv" accept=".csv" onchange="uploadCarrierCSV('usps-express', this)">
                        <button class="btn btn--small btn--primary" onclick="document.getElementById('usps-express-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV登録
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('usps-express')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <!-- その他の配送会社 -->
                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-shipping-fast"></i>
                            TNT Express
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--inactive">
                            未設定
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        CSVデータが登録されていません | ステータス: 未設定 | 燃油サーチャージ: 未設定 | 特徴: ヨーロッパ強化
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="tnt-express-csv" accept=".csv" onchange="uploadCarrierCSV('tnt-express', this)">
                        <button class="btn btn--small btn--primary" onclick="document.getElementById('tnt-express-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV登録
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('tnt-express')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>

                <div class="shipping__carrier-item">
                    <div class="shipping__carrier-header">
                        <h3 class="shipping__carrier-name">
                            <i class="fas fa-globe"></i>
                            Aramex
                        </h3>
                        <span class="shipping__status-badge shipping__status-badge--inactive">
                            未設定
                        </span>
                    </div>
                    <div class="shipping__carrier-info">
                        CSVデータが登録されていません | ステータス: 未設定 | 燃油サーチャージ: 未設定 | 特徴: 中東・アフリカ
                    </div>
                    <div class="shipping__carrier-actions">
                        <input type="file" class="shipping__file-upload" id="aramex-csv" accept=".csv" onchange="uploadCarrierCSV('aramex', this)">
                        <button class="btn btn--small btn--primary" onclick="document.getElementById('aramex-csv').click()">
                            <i class="fas fa-upload"></i>
                            CSV登録
                        </button>
                        <button class="btn btn--small btn--warning" onclick="editCarrier('aramex')">
                            <i class="fas fa-edit"></i>
                            設定
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- モール別配送方法設定セクション（新規追加） -->
<!-- モール別配送方法設定セクション（複数選択対応版） -->
<!-- モール別配送方法設定セクション（複数選択対応版） -->
<section class="shipping__section" id="marketplace-shipping">
    <div class="shipping__section-header">
        <div>
            <h2 class="shipping__section-title">
                <i class="fas fa-store"></i>
                モール別配送方法設定（複数選択対応）
            </h2>
            <p class="shipping__section-subtitle">
                登録済み18配送会社の複数選択管理。各モールで複数配送方法を同時適用し、最適な配送オプションを自動選択
            </p>
        </div>
        <div class="shipping__section-actions">
            <button class="btn btn--secondary" onclick="refreshCarrierList()">
                <i class="fas fa-sync"></i>
                配送会社更新
            </button>
            <button class="btn btn--warning" onclick="bulkSelectCarriers()">
                <i class="fas fa-check-double"></i>
                一括選択
            </button>
            <button class="btn btn--success" onclick="saveMarketplaceSettings()">
                <i class="fas fa-save"></i>
                設定保存
            </button>
        </div>
    </div>

    <div class="shipping__marketplace-grid">
        <!-- Shopify -->
        <div class="shipping__marketplace-item">
            <div class="shipping__marketplace-header">
                <h3 class="shipping__marketplace-name">
                    <i class="fab fa-shopify" style="color: var(--color-success);"></i>
                    Shopify
                </h3>
                <span class="shipping__status-badge shipping__status-badge--active">連携済み</span>
                <button class="btn btn--small btn--secondary shipping__toggle-btn" onclick="toggleCarrierPanel('shopify')">
                    <i class="fas fa-chevron-down"></i>
                    <span>設定</span>
                </button>
            </div>
            <div class="shipping__marketplace-summary">
                選択済み: <strong><span id="shopify-selected-count">4</span></strong> / 全<span id="shopify-total-count">18</span>社
                <span class="shipping__selected-preview" id="shopify-preview">FedEx（通常）, DHL（通常）, UPS（通常）, 日本郵便 EMS</span>
            </div>
            <div class="shipping__marketplace-methods shipping__marketplace-methods--collapsed" id="shopify-methods">
                <div class="shipping__select-actions">
                    <button class="btn btn--small btn--secondary" onclick="selectAllCarriers('shopify')">
                        <i class="fas fa-check-square"></i>
                        全選択
                    </button>
                    <button class="btn btn--small btn--secondary" onclick="clearAllCarriers('shopify')">
                        <i class="fas fa-square"></i>
                        全解除
                    </button>
                </div>
                <label class="shipping__form-label">利用可能配送方法（複数選択）</label>
                <div class="shipping__method-search">
                    <input type="text" placeholder="配送会社検索..." class="shipping__form-input" id="shopify-carrier-search" onkeyup="filterCarriers('shopify', this.value)">
                </div>
                <div class="shipping__method-list-checkbox shipping__method-scroll" id="shopify-carrier-list">
                    <!-- JavaScriptで動的生成（チェックボックス版） -->
                </div>
                <div class="shipping__method-summary">
                    <span class="shipping__optimization-note">※複数選択時は最適配送会社を自動選択</span>
                </div>
            </div>
            <div class="shipping__marketplace-restrictions">
                制限: 重量30kg以下、寸法200cm以下 | 特徴: グローバル配送対応、追跡番号自動通知
            </div>
        </div>

        <!-- eBay -->
        <div class="shipping__marketplace-item">
            <div class="shipping__marketplace-header">
                <h3 class="shipping__marketplace-name">
                    <i class="fab fa-ebay" style="color: var(--color-primary);"></i>
                    eBay
                </h3>
                <span class="shipping__status-badge shipping__status-badge--active">連携済み</span>
                <button class="btn btn--small btn--secondary shipping__toggle-btn" onclick="toggleCarrierPanel('ebay')">
                    <i class="fas fa-chevron-down"></i>
                    <span>設定</span>
                </button>
            </div>
            <div class="shipping__marketplace-summary">
                選択済み: <strong><span id="ebay-selected-count">4</span></strong> / 全<span id="ebay-total-count">18</span>社
                <span class="shipping__selected-preview" id="ebay-preview">CPA SS + eBayスピードパック, FedEx（通常）, DHL（通常）, 日本郵便 小型包装物</span>
            </div>
            <div class="shipping__marketplace-methods shipping__marketplace-methods--collapsed" id="ebay-methods">
                <div class="shipping__select-actions">
                    <button class="btn btn--small btn--secondary" onclick="selectAllCarriers('ebay')">
                        <i class="fas fa-check-square"></i>
                        全選択
                    </button>
                    <button class="btn btn--small btn--secondary" onclick="clearAllCarriers('ebay')">
                        <i class="fas fa-square"></i>
                        全解除
                    </button>
                </div>
                <label class="shipping__form-label">利用可能配送方法（複数選択）</label>
                <div class="shipping__method-search">
                    <input type="text" placeholder="配送会社検索..." class="shipping__form-input" id="ebay-carrier-search" onkeyup="filterCarriers('ebay', this.value)">
                </div>
                <div class="shipping__method-list-checkbox shipping__method-scroll" id="ebay-carrier-list">
                    <!-- JavaScriptで動的生成（チェックボックス版） -->
                </div>
                <div class="shipping__method-summary">
                    <span class="shipping__optimization-note">※複数選択時は最適配送会社を自動選択</span>
                </div>
            </div>
            <div class="shipping__marketplace-restrictions">
                制限: eBayポリシー準拠 | 特徴: グローバルシッピングプログラム対応、配送時間表示
            </div>
        </div>

        <!-- Amazon -->
        <div class="shipping__marketplace-item">
            <div class="shipping__marketplace-header">
                <h3 class="shipping__marketplace-name">
                    <i class="fab fa-amazon" style="color: var(--color-warning);"></i>
                    Amazon
                </h3>
                <span class="shipping__status-badge shipping__status-badge--pending">設定中</span>
                <div class="shipping__select-actions">
                    <button class="btn btn--small btn--secondary" onclick="selectAllCarriers('amazon')">
                        <i class="fas fa-check-square"></i>
                        全選択
                    </button>
                    <button class="btn btn--small btn--secondary" onclick="clearAllCarriers('amazon')">
                        <i class="fas fa-square"></i>
                        全解除
                    </button>
                </div>
            </div>
            <div class="shipping__marketplace-methods">
                <label class="shipping__form-label">利用可能配送方法（複数選択）</label>
                <div class="shipping__method-search">
                    <input type="text" placeholder="配送会社検索..." class="shipping__form-input" id="amazon-carrier-search" onkeyup="filterCarriers('amazon', this.value)">
                </div>
                <div class="shipping__method-list-checkbox shipping__method-scroll" id="amazon-carrier-list">
                    <!-- JavaScriptで動的生成（チェックボックス版） -->
                </div>
                <div class="shipping__method-summary">
                    選択済み: <strong><span id="amazon-selected-count">0</span></strong> / 全<span id="amazon-total-count">18</span>社
                    <span class="shipping__optimization-note">※複数選択時は最適配送会社を自動選択</span>
                </div>
            </div>
            <div style="margin-top: var(--space-md); font-size: var(--text-xs); color: var(--text-secondary);">
                制限: Amazon配送規則適用 | 特徴: FBA連携、Prime対応、返品対応自動化
            </div>
        </div>

        <!-- Etsy -->
        <div class="shipping__marketplace-item">
            <div class="shipping__marketplace-header">
                <h3 class="shipping__marketplace-name">
                    <i class="fas fa-handshake" style="color: var(--accent-orange);"></i>
                    Etsy
                </h3>
                <span class="shipping__status-badge shipping__status-badge--active">連携済み</span>
                <div class="shipping__select-actions">
                    <button class="btn btn--small btn--secondary" onclick="selectAllCarriers('etsy')">
                        <i class="fas fa-check-square"></i>
                        全選択
                    </button>
                    <button class="btn btn--small btn--secondary" onclick="clearAllCarriers('etsy')">
                        <i class="fas fa-square"></i>
                        全解除
                    </button>
                </div>
            </div>
            <div class="shipping__marketplace-methods">
                <label class="shipping__form-label">利用可能配送方法（複数選択）</label>
                <div class="shipping__method-search">
                    <input type="text" placeholder="配送会社検索..." class="shipping__form-input" id="etsy-carrier-search" onkeyup="filterCarriers('etsy', this.value)">
                </div>
                <div class="shipping__method-list-checkbox shipping__method-scroll" id="etsy-carrier-list">
                    <!-- JavaScriptで動的生成（チェックボックス版） -->
                </div>
                <div class="shipping__method-summary">
                    選択済み: <strong><span id="etsy-selected-count">0</span></strong> / 全<span id="etsy-total-count">18</span>社
                    <span class="shipping__optimization-note">※複数選択時は最適配送会社を自動選択</span>
                </div>
            </div>
            <div style="margin-top: var(--space-md); font-size: var(--text-xs); color: var(--text-secondary);">
                制限: 手作り・ヴィンテージ商品 | 特徴: 個人販売者対応、カスタム配送オプション
            </div>
        </div>

        <!-- Mercari -->
        <div class="shipping__marketplace-item">
            <div class="shipping__marketplace-header">
                <h3 class="shipping__marketplace-name">
                    <i class="fas fa-shopping-bag" style="color: var(--accent-red);"></i>
                    Mercari
                </h3>
                <span class="shipping__status-badge shipping__status-badge--inactive">未対応</span>
                <div class="shipping__select-actions">
                    <button class="btn btn--small btn--secondary" onclick="selectAllCarriers('mercari')">
                        <i class="fas fa-check-square"></i>
                        全選択
                    </button>
                    <button class="btn btn--small btn--secondary" onclick="clearAllCarriers('mercari')">
                        <i class="fas fa-square"></i>
                        全解除
                    </button>
                </div>
            </div>
            <div class="shipping__marketplace-methods">
                <label class="shipping__form-label">利用可能配送方法（複数選択）</label>
                <div class="shipping__method-search">
                    <input type="text" placeholder="配送会社検索..." class="shipping__form-input" id="mercari-carrier-search" onkeyup="filterCarriers('mercari', this.value)">
                </div>
                <div class="shipping__method-list-checkbox shipping__method-scroll" id="mercari-carrier-list">
                    <!-- JavaScriptで動的生成（チェックボックス版） -->
                </div>
                <div class="shipping__method-summary">
                    選択済み: <strong><span id="mercari-selected-count">0</span></strong> / 全<span id="mercari-total-count">18</span>社
                    <span class="shipping__optimization-note">※複数選択時は最適配送会社を自動選択</span>
                </div>
            </div>
            <div style="margin-top: var(--space-md); font-size: var(--text-xs); color: var(--text-secondary);">
                制限: 国内配送のみ | 特徴: 匿名配送、配送料割引、補償付き
            </div>
        </div>

        <!-- Yahoo!ショッピング -->
        <div class="shipping__marketplace-item">
            <div class="shipping__marketplace-header">
                <h3 class="shipping__marketplace-name">
                    <i class="fab fa-yahoo" style="color: var(--accent-purple);"></i>
                    Yahoo!ショッピング
                </h3>
                <span class="shipping__status-badge shipping__status-badge--pending">設定中</span>
                <div class="shipping__select-actions">
                    <button class="btn btn--small btn--secondary" onclick="selectAllCarriers('yahoo')">
                        <i class="fas fa-check-square"></i>
                        全選択
                    </button>
                    <button class="btn btn--small btn--secondary" onclick="clearAllCarriers('yahoo')">
                        <i class="fas fa-square"></i>
                        全解除
                    </button>
                </div>
            </div>
            <div class="shipping__marketplace-methods">
                <label class="shipping__form-label">利用可能配送方法（複数選択）</label>
                <div class="shipping__method-search">
                    <input type="text" placeholder="配送会社検索..." class="shipping__form-input" id="yahoo-carrier-search" onkeyup="filterCarriers('yahoo', this.value)">
                </div>
                <div class="shipping__method-list-checkbox shipping__method-scroll" id="yahoo-carrier-list">
                    <!-- JavaScriptで動的生成（チェックボックス版） -->
                </div>
                <div class="shipping__method-summary">
                    選択済み: <strong><span id="yahoo-selected-count">0</span></strong> / 全<span id="yahoo-total-count">18</span>社
                    <span class="shipping__optimization-note">※複数選択時は最適配送会社を自動選択</span>
                </div>
            </div>
            <div style="margin-top: var(--space-md); font-size: var(--text-xs); color: var(--text-secondary);">
                制限: Yahoo!ポリシー準拠 | 特徴: PayPay連携、Tポイント対応、配送オプション豊富
            </div>
        </div>

        <!-- Shopee（新規追加） -->
        <div class="shipping__marketplace-item">
            <div class="shipping__marketplace-header">
                <h3 class="shipping__marketplace-name">
                    <i class="fas fa-shopping-cart" style="color: var(--accent-orange);"></i>
                    Shopee
                </h3>
                <span class="shipping__status-badge shipping__status-badge--pending">設定中</span>
                <div class="shipping__select-actions">
                    <button class="btn btn--small btn--secondary" onclick="selectAllCarriers('shopee')">
                        <i class="fas fa-check-square"></i>
                        全選択
                    </button>
                    <button class="btn btn--small btn--secondary" onclick="clearAllCarriers('shopee')">
                        <i class="fas fa-square"></i>
                        全解除
                    </button>
                </div>
            </div>
            <div class="shipping__marketplace-methods">
                <label class="shipping__form-label">利用可能配送方法（複数選択）</label>
                <div class="shipping__method-search">
                    <input type="text" placeholder="配送会社検索..." class="shipping__form-input" id="shopee-carrier-search" onkeyup="filterCarriers('shopee', this.value)">
                </div>
                <div class="shipping__method-list-checkbox shipping__method-scroll" id="shopee-carrier-list">
                    <!-- JavaScriptで動的生成（チェックボックス版） -->
                </div>
                <div class="shipping__method-summary">
                    選択済み: <strong><span id="shopee-selected-count">0</span></strong> / 全<span id="shopee-total-count">18</span>社
                    <span class="shipping__optimization-note">※複数選択時は最適配送会社を自動選択</span>
                </div>
            </div>
            <div style="margin-top: var(--space-md); font-size: var(--text-xs); color: var(--text-secondary);">
                制限: 東南アジア地域 | 特徴: 現地配送特化、COD対応、Shopee Logistics連携
            </div>
        </div>

        <!-- Rakuten Global -->
        <div class="shipping__marketplace-item">
            <div class="shipping__marketplace-header">
                <h3 class="shipping__marketplace-name">
                    <i class="fas fa-globe" style="color: var(--color-danger);"></i>
                    Rakuten Global
                </h3>
                <span class="shipping__status-badge shipping__status-badge--inactive">未対応</span>
                <div class="shipping__select-actions">
                    <button class="btn btn--small btn--secondary" onclick="selectAllCarriers('rakuten-global')">
                        <i class="fas fa-check-square"></i>
                        全選択
                    </button>
                    <button class="btn btn--small btn--secondary" onclick="clearAllCarriers('rakuten-global')">
                        <i class="fas fa-square"></i>
                        全解除
                    </button>
                </div>
            </div>
            <div class="shipping__marketplace-methods">
                <label class="shipping__form-label">利用可能配送方法（複数選択）</label>
                <div class="shipping__method-search">
                    <input type="text" placeholder="配送会社検索..." class="shipping__form-input" id="rakuten-global-carrier-search" onkeyup="filterCarriers('rakuten-global', this.value)">
                </div>
                <div class="shipping__method-list-checkbox shipping__method-scroll" id="rakuten-global-carrier-list">
                    <!-- JavaScriptで動的生成（チェックボックス版） -->
                </div>
                <div class="shipping__method-summary">
                    選択済み: <strong><span id="rakuten-global-selected-count">0</span></strong> / 全<span id="rakuten-global-total-count">18</span>社
                    <span class="shipping__optimization-note">※複数選択時は最適配送会社を自動選択</span>
                </div>
            </div>
            <div style="margin-top: var(--space-md); font-size: var(--text-xs); color: var(--text-secondary);">
                制限: 国際配送専用 | 特徴: 楽天越境EC、多言語対応、海外決済システム
            </div>
        </div>
    </div>

    <!-- 配送会社管理パネル（拡張版） -->
    <div class="shipping__carrier-management">
        <h3 style="margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-sm);">
            <i class="fas fa-cogs"></i>
            配送会社管理パネル（複数選択対応）
        </h3>
        <div class="shipping__carrier-management-actions">
            <button class="btn btn--primary" onclick="openCarrierMappingModal()">
                <i class="fas fa-map"></i>
                配送会社マッピング表示
            </button>
            <button class="btn btn--warning" onclick="bulkCarrierUpdate()">
                <i class="fas fa-sync-alt"></i>
                全モール一括更新
            </button>
            <button class="btn btn--info" onclick="optimizeCarrierSelection()">
                <i class="fas fa-magic"></i>
                最適化推奨設定
            </button>
            <button class="btn btn--success" onclick="exportCarrierSettings()">
                <i class="fas fa-download"></i>
                設定エクスポート
            </button>
        </div>
    </div>
</section>

<script>
// ===== 登録済み配送会社データ（18社）- 変更なし =====
const registeredCarriers = [
    // FedEx関連
    { id: 'fedex-normal', name: 'FedEx（通常）', icon: 'fas fa-plane', status: 'active', apiEnabled: true },
    { id: 'cpass-fedex', name: 'CPA SS + FedEx', icon: 'fas fa-shipping-fast', status: 'active', apiEnabled: false },
    { id: 'eloji-fedex', name: 'Eloji + FedEx', icon: 'fas fa-box', status: 'active', apiEnabled: false },
    
    // DHL関連
    { id: 'dhl-normal', name: 'DHL（通常）', icon: 'fas fa-shipping-fast', status: 'active', apiEnabled: true },
    { id: 'cpass-dhl', name: 'CPA SS + DHL', icon: 'fas fa-shipping-fast', status: 'pending', apiEnabled: false },
    { id: 'eloji-dhl', name: 'Eloji + DHL', icon: 'fas fa-box', status: 'active', apiEnabled: false },
    
    // UPS関連
    { id: 'ups-normal', name: 'UPS（通常）', icon: 'fas fa-truck', status: 'pending', apiEnabled: true },
    { id: 'eloji-ups', name: 'Eloji + UPS', icon: 'fas fa-box', status: 'pending', apiEnabled: false },
    
    // 日本郵便関連
    { id: 'jppost-ems', name: '日本郵便 EMS', icon: 'fas fa-mail-bulk', status: 'active', apiEnabled: true },
    { id: 'jppost-small', name: '日本郵便 小型包装物', icon: 'fas fa-mail-bulk', status: 'active', apiEnabled: false },
    { id: 'jppost-registered', name: '日本郵便 書留', icon: 'fas fa-mail-bulk', status: 'active', apiEnabled: false },
    
    // eBay関連
    { id: 'cpass-ebay', name: 'CPA SS + eBayスピードパック', icon: 'fab fa-ebay', status: 'active', apiEnabled: false },
    { id: 'eloji-ebay', name: 'Eloji + eBayスピードパック', icon: 'fab fa-ebay', status: 'pending', apiEnabled: false },
    
    // USPS関連
    { id: 'usps-priority', name: 'USPS Priority Mail', icon: 'fas fa-envelope', status: 'pending', apiEnabled: true },
    { id: 'usps-express', name: 'USPS Priority Express', icon: 'fas fa-envelope', status: 'inactive', apiEnabled: false },
    
    // その他
    { id: 'tnt-express', name: 'TNT Express', icon: 'fas fa-shipping-fast', status: 'inactive', apiEnabled: false },
    { id: 'aramex', name: 'Aramex', icon: 'fas fa-globe', status: 'inactive', apiEnabled: false },
    { id: 'shopee-logistics', name: 'Shopee Logistics', icon: 'fas fa-shopping-cart', status: 'pending', apiEnabled: false }
];

// モール別デフォルト設定（複数選択版）
const marketplaceDefaults = {
    'shopify': ['fedex-normal', 'dhl-normal', 'ups-normal', 'jppost-ems'],
    'ebay': ['cpass-ebay', 'fedex-normal', 'dhl-normal', 'jppost-small'],
    'amazon': ['fedex-normal', 'dhl-normal', 'jppost-ems'],
    'etsy': ['jppost-ems', 'jppost-small', 'fedex-normal'],
    'mercari': ['jppost-ems', 'jppost-small'],
    'yahoo': ['jppost-ems', 'fedex-normal'],
    'shopee': ['shopee-logistics', 'dhl-normal', 'fedex-normal'],
    'rakuten-global': ['jppost-ems', 'fedex-normal', 'dhl-normal']
};

let marketplaceSettings = {};

// ===== 初期化（修正版：最初は全て折りたたみ） =====
function initializeMarketplaceShipping() {
    Object.keys(marketplaceDefaults).forEach(marketplace => {
        generateCarrierListCheckbox(marketplace);
        updateCarrierCounts(marketplace);
        updateSelectedPreview(marketplace);
        
        // 初期状態で全て折りたたみ
        const panel = document.getElementById(`${marketplace}-methods`);
        if (panel) {
            panel.classList.add('shipping__marketplace-methods--collapsed');
        }
    });
}

// ===== 折りたたみパネル制御（修正版） =====
function toggleCarrierPanel(marketplace) {
    const panel = document.getElementById(`${marketplace}-methods`);
    const button = panel.closest('.shipping__marketplace-item').querySelector('.shipping__toggle-btn');
    const icon = button.querySelector('i');
    const text = button.querySelector('span');
    
    if (panel.classList.contains('shipping__marketplace-methods--collapsed')) {
        // 展開
        panel.classList.remove('shipping__marketplace-methods--collapsed');
        icon.className = 'fas fa-chevron-up';
        text.textContent = '閉じる';
    } else {
        // 折りたたみ
        panel.classList.add('shipping__marketplace-methods--collapsed');
        icon.className = 'fas fa-chevron-down';
        text.textContent = '設定';
    }
}

// ===== 選択済み配送会社プレビュー更新 =====
function updateSelectedPreview(marketplace) {
    const previewElement = document.getElementById(`${marketplace}-preview`);
    if (!previewElement) return;
    
    const selectedCarriers = marketplaceSettings[marketplace] || marketplaceDefaults[marketplace] || [];
    const carrierNames = selectedCarriers.map(carrierId => {
        const carrier = registeredCarriers.find(c => c.id === carrierId);
        return carrier ? carrier.name : carrierId;
    });
    
    if (carrierNames.length === 0) {
        previewElement.textContent = '未選択';
        previewElement.style.color = 'var(--text-secondary)';
    } else if (carrierNames.length <= 3) {
        previewElement.textContent = carrierNames.join(', ');
        previewElement.style.color = 'var(--text-primary)';
    } else {
        previewElement.textContent = `${carrierNames.slice(0, 2).join(', ')} 他${carrierNames.length - 2}社`;
        previewElement.style.color = 'var(--text-primary)';
    }
}

// ===== 配送会社リスト生成（チェックボックス版） =====
function generateCarrierListCheckbox(marketplace) {
    const container = document.getElementById(`${marketplace}-carrier-list`);
    if (!container) return;

    const enabledCarriers = marketplaceDefaults[marketplace] || [];
    
    container.innerHTML = registeredCarriers.map(carrier => {
        const isChecked = enabledCarriers.includes(carrier.id);
        const statusIcon = getStatusIcon(carrier.status);
        const apiIndicator = carrier.apiEnabled ? '<i class="fas fa-wifi" style="color: var(--color-success); font-size: 10px;" title="API対応"></i>' : '';
        
        return `
            <div class="shipping__method-item-checkbox" data-carrier-id="${carrier.id}">
                <label class="shipping__checkbox-container">
                    <input type="checkbox" class="shipping__checkbox" 
                           ${isChecked ? 'checked' : ''} 
                           onchange="toggleCarrierSelection('${marketplace}', '${carrier.id}', this.checked)">
                    <span class="shipping__checkmark"></span>
                    <div class="shipping__carrier-info">
                        <span class="shipping__carrier-details">
                            <i class="${carrier.icon}" style="color: var(--color-primary);"></i>
                            <span class="shipping__carrier-name">${carrier.name}</span>
                            ${statusIcon}
                            ${apiIndicator}
                        </span>
                    </div>
                </label>
            </div>
        `;
    }).join('');
}

// ===== 配送会社選択トグル（複数選択版） =====
function toggleCarrierSelection(marketplace, carrierId, isChecked) {
    if (!marketplaceSettings[marketplace]) {
        marketplaceSettings[marketplace] = [];
    }
    
    if (isChecked) {
        if (!marketplaceSettings[marketplace].includes(carrierId)) {
            marketplaceSettings[marketplace].push(carrierId);
        }
    } else {
        marketplaceSettings[marketplace] = marketplaceSettings[marketplace].filter(id => id !== carrierId);
    }
    
    updateCarrierCounts(marketplace);
    updateSelectedPreview(marketplace);
    
    const carrierName = registeredCarriers.find(c => c.id === carrierId)?.name;
    showAlert('info', `${marketplace}で${carrierName}を${isChecked ? '選択' : '選択解除'}しました。`);
}

// ===== 全選択・全解除 =====
function selectAllCarriers(marketplace) {
    const checkboxes = document.querySelectorAll(`#${marketplace}-carrier-list .shipping__checkbox`);
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            checkbox.checked = true;
            const carrierId = checkbox.closest('.shipping__method-item-checkbox').dataset.carrierId;
            toggleCarrierSelection(marketplace, carrierId, true);
        }
    });
    updateSelectedPreview(marketplace);
    showAlert('success', `${marketplace}の全配送会社を選択しました。`);
}

function clearAllCarriers(marketplace) {
    const checkboxes = document.querySelectorAll(`#${marketplace}-carrier-list .shipping__checkbox`);
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            checkbox.checked = false;
            const carrierId = checkbox.closest('.shipping__method-item-checkbox').dataset.carrierId;
            toggleCarrierSelection(marketplace, carrierId, false);
        }
    });
    updateSelectedPreview(marketplace);
    showAlert('warning', `${marketplace}の全配送会社選択を解除しました。`);
}

// ===== 配送会社数更新（選択済み表示） =====
function updateCarrierCounts(marketplace) {
    const selectedElement = document.getElementById(`${marketplace}-selected-count`);
    const totalElement = document.getElementById(`${marketplace}-total-count`);
    
    if (!selectedElement || !totalElement) return;
    
    const container = document.getElementById(`${marketplace}-carrier-list`);
    const checkedBoxes = container?.querySelectorAll('.shipping__checkbox:checked').length || 0;
    
    selectedElement.textContent = checkedBoxes;
    totalElement.textContent = registeredCarriers.length;
}

// ===== 配送会社フィルター（チェックボックス版対応） =====
function filterCarriers(marketplace, searchTerm) {
    const container = document.getElementById(`${marketplace}-carrier-list`);
    if (!container) return;
    
    const items = container.querySelectorAll('.shipping__method-item-checkbox');
    const term = searchTerm.toLowerCase();
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        const shouldShow = !term || text.includes(term);
        item.style.display = shouldShow ? 'block' : 'none';
    });
}

// ===== 一括選択機能 =====
function bulkSelectCarriers() {
    showAlert('info', '全モールの推奨配送会社を一括選択中...');
    
    setTimeout(() => {
        Object.keys(marketplaceDefaults).forEach(marketplace => {
            selectAllCarriers(marketplace);
        });
        showAlert('success', '全モールの推奨配送会社を一括選択しました。');
    }, 1500);
}

// ===== 最適化推奨設定 =====
function optimizeCarrierSelection() {
    showAlert('warning', 'AIによる最適配送会社選択を実行中...');
    
    setTimeout(() => {
        showAlert('success', '各モールに最適な配送会社の組み合わせを自動選択しました。コスト・速度・信頼性を総合的に判定済みです。');
        updateLastUpdateTime();
    }, 3000);
}

// ===== その他の既存関数はそのまま =====
function getStatusIcon(status) {
    const icons = {
        'active': '<i class="fas fa-check-circle" style="color: var(--color-success); font-size: 10px;" title="稼働中"></i>',
        'pending': '<i class="fas fa-clock" style="color: var(--color-warning); font-size: 10px;" title="設定中"></i>',
        'inactive': '<i class="fas fa-times-circle" style="color: var(--text-secondary); font-size: 10px;" title="未設定"></i>'
    };
    return icons[status] || '';
}

function refreshCarrierList() {
    showAlert('warning', '配送会社データを更新中...');
    setTimeout(() => {
        Object.keys(marketplaceDefaults).forEach(marketplace => {
            generateCarrierListCheckbox(marketplace);
            updateCarrierCounts(marketplace);
        });
        showAlert('success', '18社の配送会社データを最新情報に更新しました。');
        updateLastUpdateTime();
    }, 2000);
}

function saveMarketplaceSettings() {
    showAlert('warning', 'モール別配送設定を保存中...');
    setTimeout(() => {
        showAlert('success', 'モール別配送方法設定（複数選択）を保存しました。選択された配送会社から最適なオプションが自動選択されます。');
        updateLastUpdateTime();
    }, 1500);
}

function exportCarrierSettings() {
    const settings = {
        carriers: registeredCarriers,
        marketplaceSettings: marketplaceSettings,
        defaults: marketplaceDefaults,
        exportDate: new Date().toISOString(),
        selectionType: 'multiple'
    };
    
    const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'shipping-settings-multiple-export.json';
    a.click();
    URL.revokeObjectURL(url);
    
    showAlert('success', '複数選択対応の配送設定をエクスポートしました。');
}

// ===== 初期化実行 =====
document.addEventListener('DOMContentLoaded', function() {
    initializeMarketplaceShipping();
});
</script>

<script>
// ===== 登録済み配送会社データ（18社）- 変更なし =====
const registeredCarriers = [
    // FedEx関連
    { id: 'fedex-normal', name: 'FedEx（通常）', icon: 'fas fa-plane', status: 'active', apiEnabled: true },
    { id: 'cpass-fedex', name: 'CPA SS + FedEx', icon: 'fas fa-shipping-fast', status: 'active', apiEnabled: false },
    { id: 'eloji-fedex', name: 'Eloji + FedEx', icon: 'fas fa-box', status: 'active', apiEnabled: false },
    
    // DHL関連
    { id: 'dhl-normal', name: 'DHL（通常）', icon: 'fas fa-shipping-fast', status: 'active', apiEnabled: true },
    { id: 'cpass-dhl', name: 'CPA SS + DHL', icon: 'fas fa-shipping-fast', status: 'pending', apiEnabled: false },
    { id: 'eloji-dhl', name: 'Eloji + DHL', icon: 'fas fa-box', status: 'active', apiEnabled: false },
    
    // UPS関連
    { id: 'ups-normal', name: 'UPS（通常）', icon: 'fas fa-truck', status: 'pending', apiEnabled: true },
    { id: 'eloji-ups', name: 'Eloji + UPS', icon: 'fas fa-box', status: 'pending', apiEnabled: false },
    
    // 日本郵便関連
    { id: 'jppost-ems', name: '日本郵便 EMS', icon: 'fas fa-mail-bulk', status: 'active', apiEnabled: true },
    { id: 'jppost-small', name: '日本郵便 小型包装物', icon: 'fas fa-mail-bulk', status: 'active', apiEnabled: false },
    { id: 'jppost-registered', name: '日本郵便 書留', icon: 'fas fa-mail-bulk', status: 'active', apiEnabled: false },
    
    // eBay関連
    { id: 'cpass-ebay', name: 'CPA SS + eBayスピードパック', icon: 'fab fa-ebay', status: 'active', apiEnabled: false },
    { id: 'eloji-ebay', name: 'Eloji + eBayスピードパック', icon: 'fab fa-ebay', status: 'pending', apiEnabled: false },
    
    // USPS関連
    { id: 'usps-priority', name: 'USPS Priority Mail', icon: 'fas fa-envelope', status: 'pending', apiEnabled: true },
    { id: 'usps-express', name: 'USPS Priority Express', icon: 'fas fa-envelope', status: 'inactive', apiEnabled: false },
    
    // その他
    { id: 'tnt-express', name: 'TNT Express', icon: 'fas fa-shipping-fast', status: 'inactive', apiEnabled: false },
    { id: 'aramex', name: 'Aramex', icon: 'fas fa-globe', status: 'inactive', apiEnabled: false },
    { id: 'shopee-logistics', name: 'Shopee Logistics', icon: 'fas fa-shopping-cart', status: 'pending', apiEnabled: false }
];

// モール別デフォルト設定（複数選択版）
const marketplaceDefaults = {
    'shopify': ['fedex-normal', 'dhl-normal', 'ups-normal', 'jppost-ems'],
    'ebay': ['cpass-ebay', 'fedex-normal', 'dhl-normal', 'jppost-small'],
    'amazon': ['fedex-normal', 'dhl-normal', 'jppost-ems'],
    'etsy': ['jppost-ems', 'jppost-small', 'fedex-normal'],
    'mercari': ['jppost-ems', 'jppost-small'],
    'yahoo': ['jppost-ems', 'fedex-normal'],
    'shopee': ['shopee-logistics', 'dhl-normal', 'fedex-normal'],
    'rakuten-global': ['jppost-ems', 'fedex-normal', 'dhl-normal']
};

let marketplaceSettings = {};

// ===== 初期化（チェックボックス版） =====
function initializeMarketplaceShipping() {
    Object.keys(marketplaceDefaults).forEach(marketplace => {
        generateCarrierListCheckbox(marketplace);
        updateCarrierCounts(marketplace);
        updateSelectedPreview(marketplace);
    });
}

// ===== 折りたたみパネル制御 =====
function toggleCarrierPanel(marketplace) {
    const panel = document.getElementById(`${marketplace}-methods`);
    const button = panel.closest('.shipping__marketplace-item').querySelector('.shipping__toggle-btn');
    const icon = button.querySelector('i');
    const text = button.querySelector('span');
    
    if (panel.classList.contains('shipping__marketplace-methods--collapsed')) {
        // 展開
        panel.classList.remove('shipping__marketplace-methods--collapsed');
        icon.className = 'fas fa-chevron-up';
        text.textContent = '閉じる';
    } else {
        // 折りたたみ
        panel.classList.add('shipping__marketplace-methods--collapsed');
        icon.className = 'fas fa-chevron-down';
        text.textContent = '設定';
    }
}

// ===== 選択済み配送会社プレビュー更新 =====
function updateSelectedPreview(marketplace) {
    const previewElement = document.getElementById(`${marketplace}-preview`);
    if (!previewElement) return;
    
    const selectedCarriers = marketplaceSettings[marketplace] || marketplaceDefaults[marketplace] || [];
    const carrierNames = selectedCarriers.map(carrierId => {
        const carrier = registeredCarriers.find(c => c.id === carrierId);
        return carrier ? carrier.name : carrierId;
    });
    
    if (carrierNames.length === 0) {
        previewElement.textContent = '未選択';
        previewElement.style.color = 'var(--text-secondary)';
    } else if (carrierNames.length <= 3) {
        previewElement.textContent = carrierNames.join(', ');
        previewElement.style.color = 'var(--text-primary)';
    } else {
        previewElement.textContent = `${carrierNames.slice(0, 2).join(', ')} 他${carrierNames.length - 2}社`;
        previewElement.style.color = 'var(--text-primary)';
    }
}

// ===== 配送会社リスト生成（チェックボックス版） =====
function generateCarrierListCheckbox(marketplace) {
    const container = document.getElementById(`${marketplace}-carrier-list`);
    if (!container) return;

    const enabledCarriers = marketplaceDefaults[marketplace] || [];
    
    container.innerHTML = registeredCarriers.map(carrier => {
        const isChecked = enabledCarriers.includes(carrier.id);
        const statusIcon = getStatusIcon(carrier.status);
        const apiIndicator = carrier.apiEnabled ? '<i class="fas fa-wifi" style="color: var(--color-success); font-size: 10px;" title="API対応"></i>' : '';
        
        return `
            <div class="shipping__method-item-checkbox" data-carrier-id="${carrier.id}">
                <label class="shipping__checkbox-container">
                    <input type="checkbox" class="shipping__checkbox" 
                           ${isChecked ? 'checked' : ''} 
                           onchange="toggleCarrierSelection('${marketplace}', '${carrier.id}', this.checked)">
                    <span class="shipping__checkmark"></span>
                    <div class="shipping__carrier-info">
                        <span class="shipping__carrier-details">
                            <i class="${carrier.icon}" style="color: var(--color-primary);"></i>
                            <span class="shipping__carrier-name">${carrier.name}</span>
                            ${statusIcon}
                            ${apiIndicator}
                        </span>
                    </div>
                </label>
            </div>
        `;
    }).join('');
}

// ===== 配送会社選択トグル（複数選択版） =====
function toggleCarrierSelection(marketplace, carrierId, isChecked) {
    if (!marketplaceSettings[marketplace]) {
        marketplaceSettings[marketplace] = [];
    }
    
    if (isChecked) {
        if (!marketplaceSettings[marketplace].includes(carrierId)) {
            marketplaceSettings[marketplace].push(carrierId);
        }
    } else {
        marketplaceSettings[marketplace] = marketplaceSettings[marketplace].filter(id => id !== carrierId);
    }
    
    updateCarrierCounts(marketplace);
    updateSelectedPreview(marketplace);
    
    const carrierName = registeredCarriers.find(c => c.id === carrierId)?.name;
    showAlert('info', `${marketplace}で${carrierName}を${isChecked ? '選択' : '選択解除'}しました。`);
}

// ===== 全選択・全解除 =====
function selectAllCarriers(marketplace) {
    const checkboxes = document.querySelectorAll(`#${marketplace}-carrier-list .shipping__checkbox`);
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            checkbox.checked = true;
            const carrierId = checkbox.closest('.shipping__method-item-checkbox').dataset.carrierId;
            toggleCarrierSelection(marketplace, carrierId, true);
        }
    });
    updateSelectedPreview(marketplace);
    showAlert('success', `${marketplace}の全配送会社を選択しました。`);
}

function clearAllCarriers(marketplace) {
    const checkboxes = document.querySelectorAll(`#${marketplace}-carrier-list .shipping__checkbox`);
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            checkbox.checked = false;
            const carrierId = checkbox.closest('.shipping__method-item-checkbox').dataset.carrierId;
            toggleCarrierSelection(marketplace, carrierId, false);
        }
    });
    updateSelectedPreview(marketplace);
    showAlert('warning', `${marketplace}の全配送会社選択を解除しました。`);
}

// ===== 配送会社数更新（選択済み表示） =====
function updateCarrierCounts(marketplace) {
    const selectedElement = document.getElementById(`${marketplace}-selected-count`);
    const totalElement = document.getElementById(`${marketplace}-total-count`);
    
    if (!selectedElement || !totalElement) return;
    
    const container = document.getElementById(`${marketplace}-carrier-list`);
    const checkedBoxes = container?.querySelectorAll('.shipping__checkbox:checked').length || 0;
    
    selectedElement.textContent = checkedBoxes;
    totalElement.textContent = registeredCarriers.length;
}

// ===== 配送会社フィルター（チェックボックス版対応） =====
function filterCarriers(marketplace, searchTerm) {
    const container = document.getElementById(`${marketplace}-carrier-list`);
    if (!container) return;
    
    const items = container.querySelectorAll('.shipping__method-item-checkbox');
    const term = searchTerm.toLowerCase();
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        const shouldShow = !term || text.includes(term);
        item.style.display = shouldShow ? 'block' : 'none';
    });
}

// ===== 一括選択機能 =====
function bulkSelectCarriers() {
    showAlert('info', '全モールの推奨配送会社を一括選択中...');
    
    setTimeout(() => {
        Object.keys(marketplaceDefaults).forEach(marketplace => {
            selectAllCarriers(marketplace);
        });
        showAlert('success', '全モールの推奨配送会社を一括選択しました。');
    }, 1500);
}

// ===== 最適化推奨設定 =====
function optimizeCarrierSelection() {
    showAlert('warning', 'AIによる最適配送会社選択を実行中...');
    
    setTimeout(() => {
        showAlert('success', '各モールに最適な配送会社の組み合わせを自動選択しました。コスト・速度・信頼性を総合的に判定済みです。');
        updateLastUpdateTime();
    }, 3000);
}

// ===== その他の既存関数はそのまま =====
function getStatusIcon(status) {
    const icons = {
        'active': '<i class="fas fa-check-circle" style="color: var(--color-success); font-size: 10px;" title="稼働中"></i>',
        'pending': '<i class="fas fa-clock" style="color: var(--color-warning); font-size: 10px;" title="設定中"></i>',
        'inactive': '<i class="fas fa-times-circle" style="color: var(--text-secondary); font-size: 10px;" title="未設定"></i>'
    };
    return icons[status] || '';
}

function refreshCarrierList() {
    showAlert('warning', '配送会社データを更新中...');
    setTimeout(() => {
        Object.keys(marketplaceDefaults).forEach(marketplace => {
            generateCarrierListCheckbox(marketplace);
            updateCarrierCounts(marketplace);
        });
        showAlert('success', '18社の配送会社データを最新情報に更新しました。');
        updateLastUpdateTime();
    }, 2000);
}

function saveMarketplaceSettings() {
    showAlert('warning', 'モール別配送設定を保存中...');
    setTimeout(() => {
        showAlert('success', 'モール別配送方法設定（複数選択）を保存しました。選択された配送会社から最適なオプションが自動選択されます。');
        updateLastUpdateTime();
    }, 1500);
}

function exportCarrierSettings() {
    const settings = {
        carriers: registeredCarriers,
        marketplaceSettings: marketplaceSettings,
        defaults: marketplaceDefaults,
        exportDate: new Date().toISOString(),
        selectionType: 'multiple'
    };
    
    const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'shipping-settings-multiple-export.json';
    a.click();
    URL.revokeObjectURL(url);
    
    showAlert('success', '複数選択対応の配送設定をエクスポートしました。');
}

// ===== 初期化実行 =====
document.addEventListener('DOMContentLoaded', function() {
    initializeMarketplaceShipping();
});
</script>
<script>
// ===== 登録済み配送会社データ（18社）- 変更なし =====
const registeredCarriers = [
    // FedEx関連
    { id: 'fedex-normal', name: 'FedEx（通常）', icon: 'fas fa-plane', status: 'active', apiEnabled: true },
    { id: 'cpass-fedex', name: 'CPA SS + FedEx', icon: 'fas fa-shipping-fast', status: 'active', apiEnabled: false },
    { id: 'eloji-fedex', name: 'Eloji + FedEx', icon: 'fas fa-box', status: 'active', apiEnabled: false },
    
    // DHL関連
    { id: 'dhl-normal', name: 'DHL（通常）', icon: 'fas fa-shipping-fast', status: 'active', apiEnabled: true },
    { id: 'cpass-dhl', name: 'CPA SS + DHL', icon: 'fas fa-shipping-fast', status: 'pending', apiEnabled: false },
    { id: 'eloji-dhl', name: 'Eloji + DHL', icon: 'fas fa-box', status: 'active', apiEnabled: false },
    
    // UPS関連
    { id: 'ups-normal', name: 'UPS（通常）', icon: 'fas fa-truck', status: 'pending', apiEnabled: true },
    { id: 'eloji-ups', name: 'Eloji + UPS', icon: 'fas fa-box', status: 'pending', apiEnabled: false },
    
    // 日本郵便関連
    { id: 'jppost-ems', name: '日本郵便 EMS', icon: 'fas fa-mail-bulk', status: 'active', apiEnabled: true },
    { id: 'jppost-small', name: '日本郵便 小型包装物', icon: 'fas fa-mail-bulk', status: 'active', apiEnabled: false },
    { id: 'jppost-registered', name: '日本郵便 書留', icon: 'fas fa-mail-bulk', status: 'active', apiEnabled: false },
    
    // eBay関連
    { id: 'cpass-ebay', name: 'CPA SS + eBayスピードパック', icon: 'fab fa-ebay', status: 'active', apiEnabled: false },
    { id: 'eloji-ebay', name: 'Eloji + eBayスピードパック', icon: 'fab fa-ebay', status: 'pending', apiEnabled: false },
    
    // USPS関連
    { id: 'usps-priority', name: 'USPS Priority Mail', icon: 'fas fa-envelope', status: 'pending', apiEnabled: true },
    { id: 'usps-express', name: 'USPS Priority Express', icon: 'fas fa-envelope', status: 'inactive', apiEnabled: false },
    
    // その他
    { id: 'tnt-express', name: 'TNT Express', icon: 'fas fa-shipping-fast', status: 'inactive', apiEnabled: false },
    { id: 'aramex', name: 'Aramex', icon: 'fas fa-globe', status: 'inactive', apiEnabled: false },
    { id: 'shopee-logistics', name: 'Shopee Logistics', icon: 'fas fa-shopping-cart', status: 'pending', apiEnabled: false }
];

// モール別デフォルト設定（複数選択版）
const marketplaceDefaults = {
    'shopify': ['fedex-normal', 'dhl-normal', 'ups-normal', 'jppost-ems'],
    'ebay': ['cpass-ebay', 'fedex-normal', 'dhl-normal', 'jppost-small'],
    'amazon': ['fedex-normal', 'dhl-normal', 'jppost-ems'],
    'etsy': ['jppost-ems', 'jppost-small', 'fedex-normal'],
    'mercari': ['jppost-ems', 'jppost-small'],
    'yahoo': ['jppost-ems', 'fedex-normal'],
    'shopee': ['shopee-logistics', 'dhl-normal', 'fedex-normal'],
    'rakuten-global': ['jppost-ems', 'fedex-normal', 'dhl-normal']
};

let marketplaceSettings = {};

// ===== 初期化（チェックボックス版） =====
function initializeMarketplaceShipping() {
    Object.keys(marketplaceDefaults).forEach(marketplace => {
        generateCarrierListCheckbox(marketplace);
        updateCarrierCounts(marketplace);
    });
}

// ===== 配送会社リスト生成（チェックボックス版） =====
function generateCarrierListCheckbox(marketplace) {
    const container = document.getElementById(`${marketplace}-carrier-list`);
    if (!container) return;

    const enabledCarriers = marketplaceDefaults[marketplace] || [];
    
    container.innerHTML = registeredCarriers.map(carrier => {
        const isChecked = enabledCarriers.includes(carrier.id);
        const statusIcon = getStatusIcon(carrier.status);
        const apiIndicator = carrier.apiEnabled ? '<i class="fas fa-wifi" style="color: var(--color-success); font-size: 10px;" title="API対応"></i>' : '';
        
        return `
            <div class="shipping__method-item-checkbox" data-carrier-id="${carrier.id}">
                <label class="shipping__checkbox-container">
                    <input type="checkbox" class="shipping__checkbox" 
                           ${isChecked ? 'checked' : ''} 
                           onchange="toggleCarrierSelection('${marketplace}', '${carrier.id}', this.checked)">
                    <span class="shipping__checkmark"></span>
                    <div class="shipping__carrier-info">
                        <span class="shipping__carrier-details">
                            <i class="${carrier.icon}" style="color: var(--color-primary);"></i>
                            <span class="shipping__carrier-name">${carrier.name}</span>
                            ${statusIcon}
                            ${apiIndicator}
                        </span>
                    </div>
                </label>
            </div>
        `;
    }).join('');
}

// ===== 配送会社選択トグル（複数選択版） =====
function toggleCarrierSelection(marketplace, carrierId, isChecked) {
    if (!marketplaceSettings[marketplace]) {
        marketplaceSettings[marketplace] = [];
    }
    
    if (isChecked) {
        if (!marketplaceSettings[marketplace].includes(carrierId)) {
            marketplaceSettings[marketplace].push(carrierId);
        }
    } else {
        marketplaceSettings[marketplace] = marketplaceSettings[marketplace].filter(id => id !== carrierId);
    }
    
    updateCarrierCounts(marketplace);
    
    const carrierName = registeredCarriers.find(c => c.id === carrierId)?.name;
    showAlert('info', `${marketplace}で${carrierName}を${isChecked ? '選択' : '選択解除'}しました。`);
}

// ===== 全選択・全解除 =====
function selectAllCarriers(marketplace) {
    const checkboxes = document.querySelectorAll(`#${marketplace}-carrier-list .shipping__checkbox`);
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            checkbox.checked = true;
            const carrierId = checkbox.closest('.shipping__method-item-checkbox').dataset.carrierId;
            toggleCarrierSelection(marketplace, carrierId, true);
        }
    });
    showAlert('success', `${marketplace}の全配送会社を選択しました。`);
}

function clearAllCarriers(marketplace) {
    const checkboxes = document.querySelectorAll(`#${marketplace}-carrier-list .shipping__checkbox`);
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            checkbox.checked = false;
            const carrierId = checkbox.closest('.shipping__method-item-checkbox').dataset.carrierId;
            toggleCarrierSelection(marketplace, carrierId, false);
        }
    });
    showAlert('warning', `${marketplace}の全配送会社選択を解除しました。`);
}

// ===== 配送会社数更新（選択済み表示） =====
function updateCarrierCounts(marketplace) {
    const selectedElement = document.getElementById(`${marketplace}-selected-count`);
    const totalElement = document.getElementById(`${marketplace}-total-count`);
    
    if (!selectedElement || !totalElement) return;
    
    const container = document.getElementById(`${marketplace}-carrier-list`);
    const checkedBoxes = container?.querySelectorAll('.shipping__checkbox:checked').length || 0;
    
    selectedElement.textContent = checkedBoxes;
    totalElement.textContent = registeredCarriers.length;
}

// ===== 配送会社フィルター（チェックボックス版対応） =====
function filterCarriers(marketplace, searchTerm) {
    const container = document.getElementById(`${marketplace}-carrier-list`);
    if (!container) return;
    
    const items = container.querySelectorAll('.shipping__method-item-checkbox');
    const term = searchTerm.toLowerCase();
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        const shouldShow = !term || text.includes(term);
        item.style.display = shouldShow ? 'block' : 'none';
    });
}

// ===== 一括選択機能 =====
function bulkSelectCarriers() {
    showAlert('info', '全モールの推奨配送会社を一括選択中...');
    
    setTimeout(() => {
        Object.keys(marketplaceDefaults).forEach(marketplace => {
            selectAllCarriers(marketplace);
        });
        showAlert('success', '全モールの推奨配送会社を一括選択しました。');
    }, 1500);
}

// ===== 最適化推奨設定 =====
function optimizeCarrierSelection() {
    showAlert('warning', 'AIによる最適配送会社選択を実行中...');
    
    setTimeout(() => {
        showAlert('success', '各モールに最適な配送会社の組み合わせを自動選択しました。コスト・速度・信頼性を総合的に判定済みです。');
        updateLastUpdateTime();
    }, 3000);
}

// ===== その他の既存関数はそのまま =====
function getStatusIcon(status) {
    const icons = {
        'active': '<i class="fas fa-check-circle" style="color: var(--color-success); font-size: 10px;" title="稼働中"></i>',
        'pending': '<i class="fas fa-clock" style="color: var(--color-warning); font-size: 10px;" title="設定中"></i>',
        'inactive': '<i class="fas fa-times-circle" style="color: var(--text-secondary); font-size: 10px;" title="未設定"></i>'
    };
    return icons[status] || '';
}

function refreshCarrierList() {
    showAlert('warning', '配送会社データを更新中...');
    setTimeout(() => {
        Object.keys(marketplaceDefaults).forEach(marketplace => {
            generateCarrierListCheckbox(marketplace);
            updateCarrierCounts(marketplace);
        });
        showAlert('success', '18社の配送会社データを最新情報に更新しました。');
        updateLastUpdateTime();
    }, 2000);
}

function saveMarketplaceSettings() {
    showAlert('warning', 'モール別配送設定を保存中...');
    setTimeout(() => {
        showAlert('success', 'モール別配送方法設定（複数選択）を保存しました。選択された配送会社から最適なオプションが自動選択されます。');
        updateLastUpdateTime();
    }, 1500);
}

function exportCarrierSettings() {
    const settings = {
        carriers: registeredCarriers,
        marketplaceSettings: marketplaceSettings,
        defaults: marketplaceDefaults,
        exportDate: new Date().toISOString(),
        selectionType: 'multiple'
    };
    
    const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'shipping-settings-multiple-export.json';
    a.click();
    URL.revokeObjectURL(url);
    
    showAlert('success', '複数選択対応の配送設定をエクスポートしました。');
}

// ===== 初期化実行 =====
document.addEventListener('DOMContentLoaded', function() {
    initializeMarketplaceShipping();
});
</script>
                    <!-- カテゴリー・分岐条件管理セクション（拡張版） -->
        <section class="shipping__section" id="categories">
            <div class="shipping__section-header">
                <div>
                    <h2 class="shipping__section-title">
                        <i class="fas fa-code-branch"></i>
                        カテゴリー・分岐条件管理（拡張版）
                    </h2>
                    <p class="shipping__section-subtitle">
                        商品カテゴリー管理とエコノミー・エクスペディテッド自動選択条件設定・分岐条件作成機能
                    </p>
                </div>
                <div class="shipping__section-actions">
                    <button class="btn btn--secondary" onclick="openAddCategoryModal()">
                        <i class="fas fa-tags"></i>
                        カテゴリー追加
                    </button>
                    <button class="btn btn--primary" onclick="openAddConditionModal()">
                        <i class="fas fa-plus"></i>
                        条件追加
                    </button>
                    <button class="btn btn--success" onclick="openRegionalRatesModal()">
                        <i class="fas fa-table"></i>
                        地域別料金表
                    </button>
                </div>
            </div>

            <!-- 横並びカード -->
            <div class="shipping__grid">
                <!-- 左：登録済みカテゴリー -->
                <div class="shipping__card">
                    <div class="shipping__card-header">
                        <div class="shipping__card-icon shipping__card-icon--condition">
                            <i class="fas fa-tags"></i>
                        </div>
                        <h3>登録済みカテゴリー</h3>
                        <span class="shipping__status-badge shipping__status-badge--active">12件</span>
                    </div>
                    <div class="shipping__card-body">
                        <div class="shipping__category-scroll-list">
                            <div class="shipping__category-scroll-item">
                                <span class="shipping__category-name">Electronics</span>
                                <div class="shipping__category-actions">
                                    <button class="btn btn--small btn--warning" onclick="editCategory('Electronics')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--small btn--danger" onclick="deleteCategory('Electronics')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="shipping__category-scroll-item">
                                <span class="shipping__category-name">壊れ物</span>
                                <div class="shipping__category-actions">
                                    <button class="btn btn--small btn--warning" onclick="editCategory('壊れ物')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--small btn--danger" onclick="deleteCategory('壊れ物')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="shipping__category-scroll-item">
                                <span class="shipping__category-name">Clothing</span>
                                <div class="shipping__category-actions">
                                    <button class="btn btn--small btn--warning" onclick="editCategory('Clothing')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--small btn--danger" onclick="deleteCategory('Clothing')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="shipping__category-scroll-item">
                                <span class="shipping__category-name">Books</span>
                                <div class="shipping__category-actions">
                                    <button class="btn btn--small btn--warning" onclick="editCategory('Books')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--small btn--danger" onclick="deleteCategory('Books')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="shipping__category-scroll-item">
                                <span class="shipping__category-name">Jewelry</span>
                                <div class="shipping__category-actions">
                                    <button class="btn btn--small btn--warning" onclick="editCategory('Jewelry')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--small btn--danger" onclick="deleteCategory('Jewelry')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="shipping__category-scroll-item">
                                <span class="shipping__category-name">Sports & Outdoors</span>
                                <div class="shipping__category-actions">
                                    <button class="btn btn--small btn--warning" onclick="editCategory('Sports & Outdoors')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--small btn--danger" onclick="deleteCategory('Sports & Outdoors')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="shipping__category-scroll-item">
                                <span class="shipping__category-name">Home & Garden</span>
                                <div class="shipping__category-actions">
                                    <button class="btn btn--small btn--warning" onclick="editCategory('Home & Garden')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--small btn--danger" onclick="deleteCategory('Home & Garden')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="shipping__category-scroll-item">
                                <span class="shipping__category-name">Beauty & Health</span>
                                <div class="shipping__category-actions">
                                    <button class="btn btn--small btn--warning" onclick="editCategory('Beauty & Health')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--small btn--danger" onclick="deleteCategory('Beauty & Health')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="shipping__category-scroll-item">
                                <span class="shipping__category-name">Automotive</span>
                                <div class="shipping__category-actions">
                                    <button class="btn btn--small btn--warning" onclick="editCategory('Automotive')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--small btn--danger" onclick="deleteCategory('Automotive')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="shipping__category-scroll-item">
                                <span class="shipping__category-name">Musical Instruments</span>
                                <div class="shipping__category-actions">
                                    <button class="btn btn--small btn--warning" onclick="editCategory('Musical Instruments')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--small btn--danger" onclick="deleteCategory('Musical Instruments')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="shipping__category-scroll-item">
                                <span class="shipping__category-name">Baby & Kids</span>
                                <div class="shipping__category-actions">
                                    <button class="btn btn--small btn--warning" onclick="editCategory('Baby & Kids')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--small btn--danger" onclick="deleteCategory('Baby & Kids')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="shipping__category-scroll-item">
                                <span class="shipping__category-name">Pet Supplies</span>
                                <div class="shipping__category-actions">
                                    <button class="btn btn--small btn--warning" onclick="editCategory('Pet Supplies')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--small btn--danger" onclick="deleteCategory('Pet Supplies')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: var(--space-md); font-size: var(--text-xs); color: var(--text-secondary);">
                            注意: 分岐条件で使用中のカテゴリーは削除できません。Shopifyと統一したカテゴリー名を推奨します。
                        </div>
                    </div>
                </div>

                <!-- 右：分岐条件リスト（作成機能付き） -->
                <div class="shipping__card">
                    <div class="shipping__card-header">
                        <div class="shipping__card-icon shipping__card-icon--condition">
                            <i class="fas fa-list-ol"></i>
                        </div>
                        <h3>分岐条件リスト</h3>
                        <span class="shipping__status-badge shipping__status-badge--active">4条件</span>
                    </div>
                    <div class="shipping__card-body">
                        <!-- 分岐条件追加フォーム -->
                        <div class="shipping__condition-form" id="conditionForm">
                            <h4 style="margin: 0 0 var(--space-md) 0; color: var(--color-primary);">
                                <i class="fas fa-plus"></i>
                                新しい分岐条件を作成
                            </h4>
                            <div class="shipping__condition-form-row">
                                <div class="shipping__form-group" style="margin-bottom: 0;">
                                    <label class="shipping__form-label">条件タイプ</label>
                                    <select class="shipping__form-select" id="newConditionType" onchange="updateConditionFields()">
                                        <option value="category">カテゴリー</option>
                                        <option value="price">価格</option>
                                        <option value="weight">重量</option>
                                        <option value="dimension">寸法</option>
                                        <option value="destination">配送先</option>
                                        <option value="text">テキスト含む</option>
                                    </select>
                                </div>
                                <span style="align-self: center; color: var(--text-secondary);">が</span>
                                <div class="shipping__form-group" style="margin-bottom: 0;" id="conditionOperatorGroup">
                                    <label class="shipping__form-label">演算子</label>
                                    <select class="shipping__form-select" id="newConditionOperator">
                                        <option value="equals">等しい</option>
                                        <option value="contains">含む</option>
                                        <option value="greater">より大きい</option>
                                        <option value="less">より小さい</option>
                                    </select>
                                </div>
                                <span style="align-self: center; color: var(--text-secondary);">の場合</span>
                                <div class="shipping__form-group" style="margin-bottom: 0;">
                                    <label class="shipping__form-label">配送方法</label>
                                    <select class="shipping__form-select" id="newConditionResult">
                                        <option value="economy">エコノミー</option>
                                        <option value="expedited">エクスペディテッド</option>
                                    </select>
                                </div>
                                <button class="btn btn--success" onclick="addNewCondition()" style="align-self: end;">
                                    <i class="fas fa-plus"></i>
                                    追加
                                </button>
                            </div>
                            <div class="shipping__form-group" id="conditionValueGroup">
                                <label class="shipping__form-label">条件値</label>
                                <input type="text" class="shipping__form-input" id="newConditionValue" placeholder="条件値を入力">
                            </div>
                        </div>

                        <!-- 既存の条件リスト -->
                        <div style="space-y: var(--space-xs);" id="conditionsList">
                            <!-- 条件1 -->
                            <div style="display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm); background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: var(--space-xs);">
                                <span style="background: var(--color-primary); color: white; padding: var(--space-xs) var(--space-sm); border-radius: var(--radius-full); font-size: var(--text-xs); font-weight: 600; min-width: 24px; text-align: center;">1</span>
                                <span style="flex: 1; font-size: var(--text-sm);">カテゴリ「壊れ物」を含む → <strong style="color: var(--color-warning);">エクスペディテッド</strong></span>
                                <button class="btn btn--small btn--warning" onclick="editCondition(1)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn--small btn--danger" onclick="removeCondition(1)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <!-- 条件2 -->
                            <div style="display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm); background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: var(--space-xs);">
                                <span style="background: var(--color-primary); color: white; padding: var(--space-xs) var(--space-sm); border-radius: var(--radius-full); font-size: var(--text-xs); font-weight: 600; min-width: 24px; text-align: center;">2</span>
                                <span style="flex: 1; font-size: var(--text-sm);">商品価格 > $200 → <strong style="color: var(--color-warning);">エクスペディテッド</strong></span>
                                <button class="btn btn--small btn--warning" onclick="editCondition(2)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn--small btn--danger" onclick="removeCondition(2)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <!-- 条件3 -->
                            <div style="display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm); background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: var(--space-xs);">
                                <span style="background: var(--color-primary); color: white; padding: var(--space-xs) var(--space-sm); border-radius: var(--radius-full); font-size: var(--text-xs); font-weight: 600; min-width: 24px; text-align: center;">3</span>
                                <span style="flex: 1; font-size: var(--text-sm);">重量 > 2000g → <strong style="color: var(--color-warning);">エクスペディテッド</strong></span>
                                <button class="btn btn--small btn--warning" onclick="editCondition(3)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn--small btn--danger" onclick="removeCondition(3)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <!-- デフォルト条件 -->
                            <div style="display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm); background: var(--bg-tertiary); border-radius: var(--radius-md);">
                                <span style="background: var(--color-info); color: white; padding: var(--space-xs) var(--space-sm); border-radius: var(--radius-full); font-size: var(--text-xs); font-weight: 600; min-width: 24px; text-align: center;">4</span>
                                <span style="flex: 1; font-size: var(--text-sm);">デフォルト → <strong style="color: var(--color-info);">エコノミー</strong></span>
                                <button class="btn btn--small btn--secondary" onclick="editCondition(4)" disabled>
                                    <i class="fas fa-lock"></i>
                                    固定
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-top: var(--space-md); display: flex; gap: var(--space-sm); flex-wrap: wrap;">
                            <button class="btn btn--primary" onclick="toggleConditionForm()">
                                <i class="fas fa-plus"></i>
                                条件追加
                            </button>
                            <button class="btn btn--success" onclick="saveConditions()">
                                <i class="fas fa-save"></i>
                                設定を保存
                            </button>
                            <button class="btn btn--warning" onclick="testConditions()">
                                <i class="fas fa-play"></i>
                                条件テスト
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 重量・サイズ補正設定セクション -->
        <section class="shipping__section" id="correction-settings">
            <div class="shipping__section-header">
                <div>
                    <h2 class="shipping__section-title">
                        <i class="fas fa-balance-scale"></i>
                        重量・サイズ補正設定
                    </h2>
                    <p class="shipping__section-subtitle">
                        カテゴリー別の重量・寸法補正値設定・容積重量計算係数・梱包材重量管理
                    </p>
                </div>
                <div class="shipping__section-actions">
                    <button class="btn btn--secondary" onclick="resetCorrectionDefaults()">
                        <i class="fas fa-undo"></i>
                        デフォルトに戻す
                    </button>
                    <button class="btn btn--success" onclick="saveCorrectionSettings()">
                        <i class="fas fa-save"></i>
                        設定保存
                    </button>
                </div>
            </div>

            <div class="shipping__grid">
                <!-- 重量補正設定 -->
                <div class="shipping__card">
                    <div class="shipping__card-header">
                        <div class="shipping__card-icon shipping__card-icon--region">
                            <i class="fas fa-weight"></i>
                        </div>
                        <h3>重量補正設定</h3>
                    </div>
                    <div class="shipping__card-body">
                        <div class="shipping__form-group">
                            <label class="shipping__form-label">基本梱包材重量 (g)</label>
                            <input type="number" class="shipping__form-input" id="basePackagingWeight" value="150" min="0" max="1000">
                            <div style="font-size: var(--text-xs); color: var(--text-secondary); margin-top: var(--space-xs);">
                                全商品に適用される基本梱包材重量
                            </div>
                        </div>

                        <div class="shipping__form-group">
                            <label class="shipping__form-label">カテゴリー別追加重量</label>
                            <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                    <span>壊れ物</span>
                                    <input type="number" value="200" min="0" max="500" style="width: 80px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                    <span>Electronics</span>
                                    <input type="number" value="100" min="0" max="500" style="width: 80px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                    <span>Clothing</span>
                                    <input type="number" value="50" min="0" max="500" style="width: 80px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                    <span>Books</span>
                                    <input type="number" value="80" min="0" max="500" style="width: 80px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                    <span>Jewelry</span>
                                    <input type="number" value="30" min="0" max="500" style="width: 80px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                </div>
                            </div>
                        </div>

                        <div class="shipping__form-group">
                            <label class="shipping__form-label">容積重量係数</label>
                            <input type="number" class="shipping__form-input" id="volumetricDivisor" value="5000" min="3000" max="8000">
                            <div style="font-size: var(--text-xs); color: var(--text-secondary); margin-top: var(--space-xs);">
                                cm³ ÷ この数値 = 容積重量(g)
                            </div>
                        </div>
                    </div>
                </div>

                <!-- サイズ補正設定 -->
                <div class="shipping__card">
                    <div class="shipping__card-header">
                        <div class="shipping__card-icon shipping__card-icon--region">
                            <i class="fas fa-cube"></i>
                        </div>
                        <h3>サイズ補正設定</h3>
                    </div>
                    <div class="shipping__card-body">
                        <div class="shipping__form-group">
                            <label class="shipping__form-label">基本サイズ補正 (cm)</label>
                            <input type="number" class="shipping__form-input" id="baseSizeCorrection" value="2" min="0" max="10" step="0.5">
                            <div style="font-size: var(--text-xs); color: var(--text-secondary); margin-top: var(--space-xs);">
                                全商品に適用される基本サイズ補正値
                            </div>
                        </div>

                        <div class="shipping__form-group">
                            <label class="shipping__form-label">カテゴリー別追加サイズ補正</label>
                            <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                    <span>壊れ物</span>
                                    <input type="number" value="3" min="0" max="10" step="0.5" style="width: 80px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                    <span>Electronics</span>
                                    <input type="number" value="1.5" min="0" max="10" step="0.5" style="width: 80px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                    <span>Books</span>
                                    <input type="number" value="1" min="0" max="10" step="0.5" style="width: 80px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                </div>
                            </div>
                        </div>

                        <div class="shipping__form-group">
                            <label class="shipping__form-label">最大寸法制限 (cm)</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-sm);">
                                <div>
                                    <label style="font-size: var(--text-xs); color: var(--text-secondary);">最大長</label>
                                    <input type="number" class="shipping__form-input" id="calcWidth" value="15" placeholder="幅" onchange="updateDimensionCorrection()">
                                    <div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-xs);">
                                        補正後: <span id="correctedWidth">17cm</span>
                                    </div>
                                </div>
                                <div>
                                    <input type="number" class="shipping__form-input" id="calcHeight" value="5" placeholder="高さ" onchange="updateDimensionCorrection()">
                                    <div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-xs);">
                                        補正後: <span id="correctedHeight">7cm</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="shipping__form-group">
                            <label class="shipping__form-label">対象モール</label>
                            <select class="shipping__form-select" id="calcMarketplace">
                                <option value="shopify">Shopify</option>
                                <option value="ebay">eBay</option>
                                <option value="amazon">Amazon</option>
                                <option value="etsy">Etsy</option>
                                <option value="all">全モール一括計算</option>
                            </select>
                        </div>

                        <button class="btn btn--primary btn--full" onclick="calculateShipping()">
                            <i class="fas fa-calculator"></i>
                            送料計算実行
                        </button>
                    </div>
                </div>
            </div>
        </section>
    
    <!-- モーダル：カテゴリー追加 -->
    <section>
    <div class="modal-overlay" id="addCategoryModal">
        <div class="modal">
            <div class="modal__header">
                <h3 class="modal__title">カテゴリー追加</h3>
                <button class="modal__close" onclick="closeModal('addCategoryModal')">&times;</button>
            </div>
            <div class="modal__body">
                <div class="shipping__form-group">
                    <label class="shipping__form-label">カテゴリー名</label>
                    <input type="text" class="shipping__form-input" id="newCategoryName" placeholder="例: Home & Garden">
                </div>
                
                <div class="shipping__form-group">
                    <label class="shipping__form-label">説明（任意）</label>
                    <input type="text" class="shipping__form-input" id="newCategoryDescription" placeholder="カテゴリーの説明">
                </div>

                <div style="font-size: var(--text-sm); color: var(--text-secondary);">
                    <strong>注意:</strong> Shopifyと同じカテゴリー名を使用することを推奨します。
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="closeModal('addCategoryModal')">キャンセル</button>
                <button class="btn btn--primary" onclick="addCategory()">追加</button>
            </div>
        </div>
    </div>
    </section>

    <!-- モーダル：地域別料金表 -->
    <section>
    <div class="modal-overlay" id="regionalRatesModal">
        <div class="modal" style="max-width: 95%; max-height: 95vh;">
            <div class="modal__header">
                <h3 class="modal__title">地域別送料表 - 重量・サイズ階級別（全18配送会社対応）</h3>
                <button class="modal__close" onclick="closeModal('regionalRatesModal')">&times;</button>
            </div>
            <div class="modal__body" style="overflow-x: auto;">
                <div style="overflow-x: auto; border: 1px solid var(--border-color); border-radius: var(--radius-md);">
                    <table class="rates-table" style="font-size: var(--text-sm); min-width: 1400px;">
                        <thead>
                            <tr>
                                <th rowspan="2" style="min-width: 200px;">配送地域 / 配送会社</th>
                                <th colspan="4" style="background: rgba(59, 130, 246, 0.1);">重量階級基本料金 (USD)</th>
                                <th colspan="3" style="background: rgba(139, 92, 246, 0.1);">サイズ追加料金 (USD)</th>
                                <th rowspan="2">配送日数</th>
                                <th rowspan="2">燃油率(%)</th>
                            </tr>
                            <tr>
                                <th style="background: rgba(59, 130, 246, 0.1);">～500g</th>
                                <th style="background: rgba(59, 130, 246, 0.1);">501-1000g</th>
                                <th style="background: rgba(59, 130, 246, 0.1);">1001-2000g</th>
                                <th style="background: rgba(59, 130, 246, 0.1);">2001g～</th>
                                <th style="background: rgba(139, 92, 246, 0.1);">～30cm</th>
                                <th style="background: rgba(139, 92, 246, 0.1);">31-50cm</th>
                                <th style="background: rgba(139, 92, 246, 0.1);">51cm～</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Zone 1: アメリカ国内 -->
                            <tr class="zone-header">
                                <td colspan="10" style="font-weight: bold; background: rgba(16, 185, 129, 0.1);">
                                    <i class="fas fa-flag-usa"></i> Zone 1: アメリカ国内（本土48州）
                                </td>
                            </tr>
                            <tr class="recommended">
                                <td class="carrier-name">
                                    <i class="fas fa-envelope" style="color: var(--color-primary);"></i>
                                    <strong>USPS Priority Mail</strong>
                                    <span style="margin-left: auto; background: var(--color-success); color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">推奨</span>
                                </td>
                                <td class="price-cell price-economy">$6.50</td>
                                <td class="price-cell price-economy">$8.50</td>
                                <td class="price-cell price-expedited">$11.50</td>
                                <td class="price-cell price-premium">$18.50</td>
                                <td class="price-cell">+$0</td>
                                <td class="price-cell">+$2</td>
                                <td class="price-cell">+$6</td>
                                <td class="delivery-days">2-3日</td>
                                <td class="fuel-rate">12%</td>
                            </tr>
                            <tr>
                                <td class="carrier-name">
                                    <i class="fas fa-plane" style="color: var(--color-info);"></i>
                                    <strong>FedEx Ground</strong>
                                </td>
                                <td class="price-cell price-expedited">$8.50</td>
                                <td class="price-cell price-expedited">$10.50</td>
                                <td class="price-cell price-expedited">$13.50</td>
                                <td class="price-cell price-premium">$20.50</td>
                                <td class="price-cell">+$0</td>
                                <td class="price-cell">+$3</td>
                                <td class="price-cell">+$8</td>
                                <td class="delivery-days">3-7日</td>
                                <td class="fuel-rate">15%</td>
                            </tr>

                            <!-- Zone 5A: 日本・韓国・シンガポール -->
                            <tr class="zone-header">
                                <td colspan="10" style="font-weight: bold; background: rgba(6, 182, 212, 0.1);">
                                    <i class="fas fa-flag"></i> Zone 5A: 日本・韓国・シンガポール ⭐
                                </td>
                            </tr>
                            <tr class="recommended">
                                <td class="carrier-name">
                                    <i class="fas fa-mail-bulk" style="color: var(--color-success);"></i>
                                    <strong>日本郵便 EMS</strong>
                                    <span style="margin-left: auto; background: var(--color-success); color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">最安・最速</span>
                                </td>
                                <td class="price-cell price-economy">$19.20</td>
                                <td class="price-cell price-economy">$21.20</td>
                                <td class="price-cell price-expedited">$24.20</td>
                                <td class="price-cell price-premium">$31.20</td>
                                <td class="price-cell">+$0</td>
                                <td class="price-cell">+$3</td>
                                <td class="price-cell">+$8</td>
                                <td class="delivery-days">3-6日</td>
                                <td class="fuel-rate">12%</td>
                            </tr>
                            <tr>
                                <td class="carrier-name">
                                    <i class="fas fa-plane" style="color: var(--color-info);"></i>
                                    <strong>FedEx International</strong>
                                </td>
                                <td class="price-cell price-expedited">$24.80</td>
                                <td class="price-cell price-expedited">$26.80</td>
                                <td class="price-cell price-expedited">$29.80</td>
                                <td class="price-cell price-premium">$36.80</td>
                                <td class="price-cell">+$0</td>
                                <td class="price-cell">+$4</td>
                                <td class="price-cell">+$10</td>
                                <td class="delivery-days">2-4日</td>
                                <td class="fuel-rate">15%</td>
                            </tr>
                            <tr>
                                <td class="carrier-name">
                                    <i class="fas fa-shipping-fast" style="color: var(--color-danger);"></i>
                                    <strong>DHL Express</strong>
                                </td>
                                <td class="price-cell price-premium">$28.90</td>
                                <td class="price-cell price-premium">$31.40</td>
                                <td class="price-cell price-premium">$35.90</td>
                                <td class="price-cell price-premium">$42.40</td>
                                <td class="price-cell">+$0</td>
                                <td class="price-cell">+$4</td>
                                <td class="price-cell">+$10</td>
                                <td class="delivery-days">1-3日</td>
                                <td class="fuel-rate">18%</td>
                            </tr>

                            <!-- Zone 4A: 西欧 -->
                            <tr class="zone-header">
                                <td colspan="10" style="font-weight: bold; background: rgba(139, 92, 246, 0.1);">
                                    <i class="fas fa-flag"></i> Zone 4A: 西欧（UK・ドイツ・フランス等）
                                </td>
                            </tr>
                            <tr class="recommended">
                                <td class="carrier-name">
                                    <i class="fas fa-plane" style="color: var(--color-info);"></i>
                                    <strong>FedEx International</strong>
                                    <span style="margin-left: auto; background: var(--color-success); color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">欧州推奨</span>
                                </td>
                                <td class="price-cell price-economy">$24.80</td>
                                <td class="price-cell price-economy">$26.80</td>
                                <td class="price-cell price-expedited">$29.80</td>
                                <td class="price-cell price-premium">$36.80</td>
                                <td class="price-cell">+$0</td>
                                <td class="price-cell">+$4</td>
                                <td class="price-cell">+$10</td>
                                <td class="delivery-days">2-4日</td>
                                <td class="fuel-rate">15%</td>
                            </tr>

                            <!-- Zone 7B: アフリカ -->
                            <tr class="zone-header">
                                <td colspan="10" style="font-weight: bold; background: rgba(245, 158, 11, 0.1);">
                                    <i class="fas fa-flag"></i> Zone 7B: アフリカ（高コスト地域）
                                </td>
                            </tr>
                            <tr class="recommended">
                                <td class="carrier-name">
                                    <i class="fas fa-shipping-fast" style="color: var(--color-danger);"></i>
                                    <strong>DHL Express</strong>
                                    <span style="margin-left: auto; background: var(--color-warning); color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">アフリカ推奨</span>
                                </td>
                                <td class="price-cell price-premium">$42.30</td>
                                <td class="price-cell price-premium">$44.30</td>
                                <td class="price-cell price-premium">$47.30</td>
                                <td class="price-cell price-premium">$54.30</td>
                                <td class="price-cell">+$0</td>
                                <td class="price-cell">+$6</td>
                                <td class="price-cell">+$15</td>
                                <td class="delivery-days">3-7日</td>
                                <td class="fuel-rate">25%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 料金計算説明 -->
                <div style="margin-top: var(--space-xl); padding: var(--space-lg); background: var(--bg-primary); border-radius: var(--radius-lg); border-left: 4px solid var(--color-info);">
                    <h5 style="color: var(--color-info); margin-bottom: var(--space-md);">
                        <i class="fas fa-calculator"></i>
                        自動計算ロジック・API連携仕様
                    </h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-lg);">
                        <div>
                            <h6 style="color: var(--color-primary); margin-bottom: var(--space-sm);">基本計算式</h6>
                            <div style="font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.6;">
                                <code style="background: var(--bg-secondary); padding: var(--space-xs); border-radius: var(--radius-sm); display: block; margin: var(--space-xs) 0;">
                                    最終送料 = 基本送料 + 重量調整 + サイズ調整 + 価格調整 + 保険料 + 燃油サーチャージ
                                </code>
                                <ul style="margin: var(--space-sm) 0; padding-left: var(--space-lg);">
                                    <li>重量階級: 実重量 vs 容積重量の大きい方</li>
                                    <li>サイズ階級: 最大寸法で判定</li>
                                    <li>エクスペディテッド: 基本料金×1.5倍</li>
                                </ul>
                            </div>
                        </div>
                        <div>
                            <h6 style="color: var(--color-warning); margin-bottom: var(--space-sm);">価格調整・オプション</h6>
                            <div style="font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.6;">
                                <ul style="margin: 0; padding-left: var(--space-lg);">
                                    <li>価格調整: $50-200（+$1）、$200-500（+$3）、$500+（+$5）</li>
                                    <li>保険料: 商品価格×1.5%（最低$2.50）</li>
                                    <li>署名確認: $3.50（$200以上で自動追加）</li>
                                    <li>追跡サービス: $1.20（基本料金）</li>
                                </ul>
                            </div>
                        </div>
                        <div>
                            <h6 style="color: var(--color-success); margin-bottom: var(--space-sm);">API連携・自動更新</h6>
                            <div style="font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.6;">
                                <ul style="margin: 0; padding-left: var(--space-lg);">
                                    <li>燃油サーチャージ: API月次自動更新</li>
                                    <li>為替レート: 日次自動更新</li>
                                    <li>配送会社API: リアルタイム料金取得</li>
                                    <li>料金履歴: 自動バックアップ・復元</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="printRateTable()">
                    <i class="fas fa-print"></i>
                    印刷
                </button>
                <button class="btn btn--warning" onclick="exportRateTable('csv')">
                    <i class="fas fa-file-csv"></i>
                    CSV出力
                </button>
                <button class="btn btn--success" onclick="updateRateTable()">
                    <i class="fas fa-sync"></i>
                    料金更新
                </button>
                <button class="btn btn--primary" onclick="closeModal('regionalRatesModal')">
                    <i class="fas fa-times"></i>
                    閉じる
                </button>
            </div>
        </div>
    </div>
    </section>

    <!-- 燃油サーチャージ・オプション料金設定セクション（修正版：API自動取得） -->
    <section class="shipping__section" id="surcharge-settings">
        <div class="shipping__section-header">
            <div>
                <h2 class="shipping__section-title">
                    <i class="fas fa-fire"></i>
                    燃油サーチャージ・オプション料金（API自動取得）
                </h2>
                <p class="shipping__section-subtitle">
                    燃油サーチャージAPI自動取得・保険料設定・署名確認料・追跡サービス料金設定
                </p>
            </div>
            <div class="shipping__section-actions">
                <button class="btn btn--warning" onclick="updateFuelSurcharge()">
                    <i class="fas fa-sync"></i>
                    燃油サーチャージ更新
                </button>
                <button class="btn btn--success" onclick="saveSurchargeSettings()">
                    <i class="fas fa-save"></i>
                    設定保存
                </button>
            </div>
        </div>

        <div class="shipping__grid">
            <!-- 燃油サーチャージ設定（API自動取得・読み取り専用） -->
            <div class="shipping__card">
                <div class="shipping__card-header">
                    <div class="shipping__card-icon shipping__card-icon--marketplace">
                        <i class="fas fa-fire"></i>
                    </div>
                    <h3>燃油サーチャージ率（API自動取得）</h3>
                </div>
                <div class="shipping__card-body">
                    <div style="margin-bottom: var(--space-md); padding: var(--space-sm); background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-md); border-left: 4px solid var(--color-success);">
                        <div style="font-size: var(--text-sm); font-weight: 600; color: var(--color-success);">
                            <i class="fas fa-check-circle"></i>
                            API自動取得完了: 2024/06/29 08:00 (次回: 07/01 08:00)
                        </div>
                    </div>

                    <div class="shipping__form-group">
                        <label class="shipping__form-label">配送会社別燃油サーチャージ率（API自動取得）</label>
                        <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                <span><strong>FedEx</strong> (全地域)</span>
                                <div style="display: flex; align-items: center; gap: var(--space-sm); color: var(--color-primary); font-weight: 600;">
                                    <span>12.5%</span>
                                    <span style="font-size: var(--text-xs); color: var(--color-success);">✓ API取得済</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                <span><strong>DHL</strong> (全地域)</span>
                                <div style="display: flex; align-items: center; gap: var(--space-sm); color: var(--color-primary); font-weight: 600;">
                                    <span>18.0%</span>
                                    <span style="font-size: var(--text-xs); color: var(--color-success);">✓ API取得済</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                <span><strong>UPS</strong> (全地域)</span>
                                <div style="display: flex; align-items: center; gap: var(--space-sm); color: var(--color-primary); font-weight: 600;">
                                    <span>15.2%</span>
                                    <span style="font-size: var(--text-xs); color: var(--color-success);">✓ API取得済</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                <span><strong>日本郵便</strong> (全地域)</span>
                                <div style="display: flex; align-items: center; gap: var(--space-sm); color: var(--color-primary); font-weight: 600;">
                                    <span>5.8%</span>
                                    <span style="font-size: var(--text-xs); color: var(--color-success);">✓ API取得済</span>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                                <span><strong>USPS</strong> (Zone 1-2)</span>
                                <div style="display: flex; align-items: center; gap: var(--space-sm); color: var(--color-primary); font-weight: 600;">
                                    <span>8.5%</span>
                                    <span style="font-size: var(--text-xs); color: var(--color-success);">✓ API取得済</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: var(--space-lg); padding: var(--space-sm); background: rgba(6, 182, 212, 0.1); border-radius: var(--radius-md); border-left: 4px solid var(--color-info);">
                        <div style="font-size: var(--text-sm); color: var(--color-info);">
                            <i class="fas fa-info-circle"></i>
                            <strong>自動更新仕様:</strong> 各配送会社APIから月次自動取得。CPASS・Elojiは割引料金に燃油サーチャージ含む。
                        </div>
                    </div>
                </div>
            </div>

            <!-- オプション料金設定 -->
            <div class="shipping__card">
                <div class="shipping__card-header">
                    <div class="shipping__card-icon shipping__card-icon--marketplace">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3>オプション料金設定</h3>
                </div>
                <div class="shipping__card-body">
                    <div class="shipping__form-group">
                        <label class="shipping__form-label">保険料設定</label>
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; margin-bottom: var(--space-sm);">
                            <label style="font-size: var(--text-sm);">保険料率</label>
                            <div style="display: flex; align-items: center; gap: var(--space-xs);">
                                <input type="number" value="1.5" min="0" max="10" step="0.1" style="width: 60px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                <span style="font-size: var(--text-sm);">%</span>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; margin-bottom: var(--space-sm);">
                            <label style="font-size: var(--text-sm);">最低保険料</label>
                            <div style="display: flex; align-items: center; gap: var(--space-xs);">
                                <span style="font-size: var(--text-sm);">$</span>
                                <input type="number" value="2.50" min="0" max="50" step="0.50" style="width: 60px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center;">
                            <label style="font-size: var(--text-sm);">自動適用価格</label>
                            <div style="display: flex; align-items: center; gap: var(--space-xs);">
                                <span style="font-size: var(--text-sm);">$</span>
                                <input type="number" value="100" min="0" max="1000" step="10" style="width: 80px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                <span style="font-size: var(--text-xs); color: var(--text-secondary);">以上</span>
                            </div>
                        </div>
                    </div>

                    <div class="shipping__form-group">
                        <label class="shipping__form-label">署名確認料金</label>
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center; margin-bottom: var(--space-sm);">
                            <label style="font-size: var(--text-sm);">署名確認料</label>
                            <div style="display: flex; align-items: center; gap: var(--space-xs);">
                                <span style="font-size: var(--text-sm);">$</span>
                                <input type="number" value="3.50" min="0" max="20" step="0.50" style="width: 60px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center;">
                            <label style="font-size: var(--text-sm);">自動適用価格</label>
                            <div style="display: flex; align-items: center; gap: var(--space-xs);">
                                <span style="font-size: var(--text-sm);">$</span>
                                <input type="number" value="200" min="0" max="1000" step="10" style="width: 80px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                                <span style="font-size: var(--text-xs); color: var(--text-secondary);">以上</span>
                            </div>
                        </div>
                    </div>

                    <div class="shipping__form-group">
                        <label class="shipping__form-label">追跡サービス料金</label>
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-sm); align-items: center;">
                            <label style="font-size: var(--text-sm);">基本追跡料</label>
                            <div style="display: flex; align-items: center; gap: var(--space-xs);">
                                <span style="font-size: var(--text-sm);">$</span>
                                <input type="number" value="1.20" min="0" max="10" step="0.10" style="width: 60px; padding: var(--space-xs); border: 1px solid var(--border-color); border-radius: var(--radius-sm);">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 送料計算テストセクション -->
    <section class="shipping__section" id="calculator">
        <div class="shipping__section-header">
            <div>
                <h2 class="shipping__section-title">
                    <i class="fas fa-calculator"></i>
                    送料計算テスト
                </h2>
                <p class="shipping__section-subtitle">
                    リアルタイム送料計算・配送会社比較・モール別最適設定確認
                </p>
            </div>
        </div>

        <div class="shipping__grid" style="grid-template-columns: 1fr 1fr;">
            <div class="shipping__card">
                <div class="shipping__card-header">
                    <div class="shipping__card-icon shipping__card-icon--condition">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <h3>計算条件入力</h3>
                </div>
                <div class="shipping__card-body">
                    <div class="shipping__form-group">
                        <label class="shipping__form-label">商品重量 (g) - 自動補正付き</label>
                        <input type="number" class="shipping__form-input" id="calcWeight" value="500" min="0" onchange="updateWeightCorrection()">
                        <div style="display: flex; justify-content: space-between; margin-top: var(--space-sm); font-size: var(--text-sm);">
                            <span>実測重量:</span>
                            <span id="actualWeight">500g</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs); font-size: var(--text-sm);">
                            <span>梱包材込み:</span>
                            <span id="packagedWeight">650g</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs); font-size: var(--text-sm);">
                            <span>容積重量:</span>
                            <span id="volumetricWeight">524g</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: var(--text-sm);">
                            <span style="color: var(--color-primary); font-weight: 600;">課金対象重量:</span>
                            <span id="billingWeight" style="color: var(--color-primary); font-weight: 600;">650g</span>
                        </div>
                    </div>
                    
                    <div class="shipping__form-group">
                        <label class="shipping__form-label">商品価格 ($)</label>
                        <input type="number" class="shipping__form-input" id="calcPrice" value="100" min="0">
                    </div>
                    
                    <div class="shipping__form-group">
                        <label class="shipping__form-label">配送先地域（Zone別）</label>
                        <select class="shipping__form-select" id="calcDestination">
                            <option value="zone1">Zone 1: アメリカ国内（本土48州）</option>
                            <option value="zone1-hi-ak">Zone 1B: ハワイ・アラスカ</option>
                            <option value="zone2">Zone 2: カナダ</option>
                            <option value="zone3a">Zone 3A: メキシコ・中央アメリカ</option>
                            <option value="zone3b">Zone 3B: 南米</option>
                            <option value="zone4a">Zone 4A: 西欧（UK・ドイツ・フランス等）</option>
                            <option value="zone4b">Zone 4B: 東欧・ロシア</option>
                            <option value="zone5a" selected>Zone 5A: 日本・韓国・シンガポール</option>
                            <option value="zone5b">Zone 5B: 中国・台湾・香港</option>
                            <option value="zone5c">Zone 5C: 東南アジア（タイ・マレーシア等）</option>
                            <option value="zone6">Zone 6: オセアニア（豪州・NZ）</option>
                            <option value="zone7a">Zone 7A: 中東</option>
                            <option value="zone7b">Zone 7B: アフリカ</option>
                            <option value="zone8">Zone 8: 離島・特別地域</option>
                        </select>
                    </div>
                    
                    <div class="shipping__form-group">
                        <label class="shipping__form-label">商品カテゴリ</label>
                        <select class="shipping__form-select" id="calcCategory">
                            <option value="Electronics">Electronics</option>
                            <option value="壊れ物">壊れ物</option>
                            <option value="Clothing">Clothing</option>
                            <option value="Books">Books</option>
                            <option value="Jewelry">Jewelry</option>
                            <option value="Sports & Outdoors">Sports & Outdoors</option>
                            <option value="Home & Garden">Home & Garden</option>
                            <option value="Beauty & Health">Beauty & Health</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Musical Instruments">Musical Instruments</option>
                            <option value="Baby & Kids">Baby & Kids</option>
                            <option value="Pet Supplies">Pet Supplies</option>
                        </select>
                    </div>
                    
                    <div class="shipping__form-group">
                        <label class="shipping__form-label">寸法 (cm) - 自動補正付き</label>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-sm);">
                            <div>
                                <input type="number" class="shipping__form-input" id="calcLength" value="20" placeholder="長さ" onchange="updateDimensionCorrection()">
                                <div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-xs);">
                                    補正後: <span id="correctedLength">22cm</span>
                                </div>
                            </div>
                            <div>
                                <input type="number" class="shipping__form-input" id="calcWidth" value="15" placeholder="幅" onchange="updateDimensionCorrection()">
                                <div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-xs);">
                                    補正後: <span id="correctedWidth">17cm</span>
                                </div>
                            </div>
                            <div>
                                <input type="number" class="shipping__form-input" id="calcHeight" value="5" placeholder="高さ" onchange="updateDimensionCorrection()">
                                <div style="font-size: var(--text-xs); color: var(--text-muted); margin-top: var(--space-xs);">
                                    補正後: <span id="correctedHeight">7cm</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="shipping__card">
                <div class="shipping__card-header">
                    <div class="shipping__card-icon shipping__card-icon--condition">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h3>計算結果 & 比較</h3>
                </div>
                <div class="shipping__card-body">
                    <div class="shipping__calculation-result" id="calculationResult">
                        <h4 style="color: var(--color-success); margin-bottom: var(--space-md);">
                            <i class="fas fa-check-circle"></i>
                            送料計算結果
                        </h4>
                        
                        <div class="shipping__result-grid" id="resultGrid">
                            <!-- 結果はJavaScriptで動的に表示 -->
                        </div>

                        <h4 style="color: var(--color-info); margin: var(--space-lg) 0 var(--space-md) 0;">
                            <i class="fas fa-balance-scale"></i>
                            配送会社比較（Zone 5A: 日本向け）
                        </h4>
                        
                        <table class="shipping__region-table">
                            <thead>
                                <tr>
                                    <th>配送会社</th>
                                    <th>エコノミー</th>
                                    <th>エクスペディテッド</th>
                                    <th>配送日数</th>
                                    <th>推奨</th>
                                </tr>
                            </thead>
                            <tbody id="comparisonTableBody">
                                <!-- 比較結果はJavaScriptで動的に生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- 地域別送料-->
    <section class="container">
        <!-- ページヘッダー -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-globe page-icon"></i>
                地域別送料表 - 全18配送会社対応
            </h1>
            <p class="page-subtitle">
                Zone別・重量階級別・配送会社別の詳細料金表示 | リアルタイムAPI連携・燃油サーチャージ自動適用・最適配送会社推奨システム
            </p>
            <div class="page-actions">
                <button class="btn btn--primary" onclick="refreshRates()">
                    <i class="fas fa-sync-alt"></i>
                    料金データ更新
                </button>
                <button class="btn btn--secondary" onclick="exportRates('csv')">
                    <i class="fas fa-file-csv"></i>
                    CSV出力
                </button>
                <button class="btn btn--secondary" onclick="exportRates('excel')">
                    <i class="fas fa-file-excel"></i>
                    Excel出力
                </button>
                <button class="btn btn--warning" onclick="printRates()">
                    <i class="fas fa-print"></i>
                    印刷
                </button>
                <button class="btn btn--info" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i>
                    送料計算に戻る
                </button>
            </div>
        </div>

        <!-- 統計・分析セクション -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon stat-icon--primary">
                        <i class="fas fa-truck"></i>
                    </div>
                    <h3 class="stat-title">対応配送会社</h3>
                </div>
                <div class="stat-value">18社</div>
                <div class="stat-description">FedEx・DHL・UPS・日本郵便・USPSほか全18社の料金を網羅</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon stat-icon--success">
                        <i class="fas fa-globe"></i>
                    </div>
                    <h3 class="stat-title">対応地域</h3>
                </div>
                <div class="stat-value">192ヶ国</div>
                <div class="stat-description">Zone 1-8まで全世界をカバー。地域別最適化済み</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon stat-icon--warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h3 class="stat-title">データ更新</h3>
                </div>
                <div class="stat-value">リアルタイム</div>
                <div class="stat-description">最終更新: 2024/06/29 14:30 | 燃油サーチャージ自動適用</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon stat-icon--info">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3 class="stat-title">計算精度</h3>
                </div>
                <div class="stat-value">99.8%</div>
                <div class="stat-description">実際の配送料金との誤差平均1.2%以内を実現</div>
            </div>
        </div>

        <!-- フィルター・検索セクション -->
        <div class="filter-section">
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label">配送地域</label>
                    <select class="filter-select" id="zoneFilter" onchange="filterTable()">
                        <option value="all">全地域表示</option>
                        <option value="zone1">Zone 1: アメリカ国内</option>
                        <option value="zone2">Zone 2: カナダ</option>
                        <option value="zone3">Zone 3: 中南米</option>
                        <option value="zone4">Zone 4: ヨーロッパ</option>
                        <option value="zone5" selected>Zone 5: アジア・オセアニア</option>
                        <option value="zone6">Zone 6: オセアニア</option>
                        <option value="zone7">Zone 7: 中東・アフリカ</option>
                        <option value="zone8">Zone 8: 離島・特別地域</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">配送会社</label>
                    <select class="filter-select" id="carrierFilter" onchange="filterTable()">
                        <option value="all">全配送会社</option>
                        <option value="fedex">FedEx関連</option>
                        <option value="dhl">DHL関連</option>
                        <option value="ups">UPS関連</option>
                        <option value="jppost">日本郵便</option>
                        <option value="usps">USPS</option>
                        <option value="cpass">CPA SS</option>
                        <option value="eloji">Eloji</option>
                        <option value="other">その他</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">重量階級</label>
                    <select class="filter-select" id="weightFilter" onchange="filterTable()">
                        <option value="all">全重量階級</option>
                        <option value="light">軽量（～500g）</option>
                        <option value="medium">中量（501-2000g）</option>
                        <option value="heavy">重量（2001g～）</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">配送方法</label>
                    <select class="filter-select" id="serviceFilter" onchange="filterTable()">
                        <option value="all">エコノミー＋エクスペディテッド</option>
                        <option value="economy">エコノミーのみ</option>
                        <option value="expedited">エクスペディテッドのみ</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">おすすめ表示</label>
                    <select class="filter-select" id="recommendFilter" onchange="filterTable()">
                        <option value="all">全て表示</option>
                        <option value="recommended">おすすめのみ</option>
                        <option value="cost-effective">コスパ重視</option>
                        <option value="fast-delivery">速達重視</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">検索</label>
                    <input type="text" class="filter-select" id="searchInput" placeholder="配送会社名・地域名で検索" onkeyup="filterTable()">
                </div>
            </div>

            <div class="page-actions">
                <button class="btn btn--secondary" onclick="resetFilters()">
                    <i class="fas fa-undo"></i>
                    フィルターリセット
                </button>
                <button class="btn btn--success" onclick="saveFilterSettings()">
                    <i class="fas fa-save"></i>
                    フィルター設定保存
                </button>
            </div>
        </div>

        <!-- 地域別料金表メインテーブル -->
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">地域別送料表 - 重量・サイズ階級別（全18配送会社対応）</h3>
                <div class="table-actions">
                    <button class="btn btn--small btn--secondary" onclick="toggleColumns('weight')">
                        <i class="fas fa-weight"></i>
                        重量列
                    </button>
                    <button class="btn btn--small btn--secondary" onclick="toggleColumns('size')">
                        <i class="fas fa-cube"></i>
                        サイズ列
                    </button>
                    <button class="btn btn--small btn--warning" onclick="updateRealTimeRates()">
                        <i class="fas fa-sync"></i>
                        リアルタイム更新
                    </button>
                </div>
            </div>
            <section>
            <div class="table-wrapper">
                <table class="rates-table" id="ratesTable">
                    <thead>
                        <tr>
                            <th rowspan="2" style="min-width: 220px;">配送地域 / 配送会社</th>
                            <th colspan="4" style="background: rgba(59, 130, 246, 0.1); text-align: center;">重量階級基本料金 (USD)</th>
                            <th colspan="3" style="background: rgba(139, 92, 246, 0.1); text-align: center;">サイズ追加料金 (USD)</th>
                            <th rowspan="2" style="text-align: center;">配送日数</th>
                            <th rowspan="2" style="text-align: center;">燃油率(%)</th>
                            <th rowspan="2" style="text-align: center;">推奨度</th>
                        </tr>
                        <tr>
                            <th style="background: rgba(59, 130, 246, 0.1); text-align: center;">～500g</th>
                            <th style="background: rgba(59, 130, 246, 0.1); text-align: center;">501-1000g</th>
                            <th style="background: rgba(59, 130, 246, 0.1); text-align: center;">1001-2000g</th>
                            <th style="background: rgba(59, 130, 246, 0.1); text-align: center;">2001g～</th>
                            <th style="background: rgba(139, 92, 246, 0.1); text-align: center;">～30cm</th>
                            <th style="background: rgba(139, 92, 246, 0.1); text-align: center;">31-50cm</th>
                            <th style="background: rgba(139, 92, 246, 0.1); text-align: center;">51cm～</th>
                        </tr>
                    </thead>
                    <tbody id="ratesTableBody">
                        <!-- Zone 1: アメリカ国内 -->
                        <tr class="zone-header" data-zone="zone1">
                            <td colspan="11" style="font-weight: bold; background: rgba(16, 185, 129, 0.1);">
                                <i class="fas fa-flag-usa"></i> Zone 1: アメリカ国内（本土48州）- 国内最安配送
                            </td>
                        </tr>
                        <tr data-zone="zone1" data-carrier="usps" class="recommended">
                            <td class="carrier-name">
                                <i class="fas fa-envelope" style="color: var(--color-primary);"></i>
                                <strong>USPS Priority Mail</strong>
                                <span style="margin-left: auto; background: var(--color-success); color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">推奨</span>
                            </td>
                            <td class="price-cell price-economy">$6.50</td>
                            <td class="price-cell price-economy">$8.50</td>
                            <td class="price-cell price-expedited">$11.50</td>
                            <td class="price-cell price-premium">$18.50</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$2</td>
                            <td class="price-cell">+$6</td>
                            <td class="delivery-days">2-3日</td>
                            <td class="fuel-rate">12%</td>
                            <td style="text-align: center; color: var(--color-success); font-weight: 600;">◎ 国内最安</td>
                        </tr>
                        <tr data-zone="zone1" data-carrier="fedex">
                            <td class="carrier-name">
                                <i class="fas fa-plane" style="color: var(--color-info);"></i>
                                <strong>FedEx Ground</strong>
                            </td>
                            <td class="price-cell price-expedited">$8.50</td>
                            <td class="price-cell price-expedited">$10.50</td>
                            <td class="price-cell price-expedited">$13.50</td>
                            <td class="price-cell price-premium">$20.50</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$3</td>
                            <td class="price-cell">+$8</td>
                            <td class="delivery-days">3-7日</td>
                            <td class="fuel-rate">15%</td>
                            <td style="text-align: center; color: var(--color-warning); font-weight: 600;">○ バランス良</td>
                        </tr>
                        <tr data-zone="zone1" data-carrier="ups">
                            <td class="carrier-name">
                                <i class="fas fa-truck" style="color: var(--color-warning);"></i>
                                <strong>UPS Ground</strong>
                            </td>
                            <td class="price-cell price-expedited">$9.20</td>
                            <td class="price-cell price-expedited">$11.20</td>
                            <td class="price-cell price-expedited">$14.20</td>
                            <td class="price-cell price-premium">$21.20</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$3</td>
                            <td class="price-cell">+$8</td>
                            <td class="delivery-days">3-7日</td>
                            <td class="fuel-rate">15%</td>
                            <td style="text-align: center; color: var(--text-secondary); font-weight: 600;">△ 平均的</td>
                        </tr>

                        <!-- Zone 5A: 日本・韓国・シンガポール -->
                        <tr class="zone-header" data-zone="zone5">
                            <td colspan="11" style="font-weight: bold; background: rgba(6, 182, 212, 0.1);">
                                <i class="fas fa-flag"></i> Zone 5A: 日本・韓国・シンガポール ⭐ 人気配送先
                            </td>
                        </tr>
                        <tr data-zone="zone5" data-carrier="jppost" class="recommended">
                            <td class="carrier-name">
                                <i class="fas fa-mail-bulk" style="color: var(--color-success);"></i>
                                <strong>日本郵便 EMS</strong>
                                <span style="margin-left: auto; background: var(--color-success); color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">最安・最速</span>
                            </td>
                            <td class="price-cell price-economy">$19.20</td>
                            <td class="price-cell price-economy">$21.20</td>
                            <td class="price-cell price-expedited">$24.20</td>
                            <td class="price-cell price-premium">$31.20</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$3</td>
                            <td class="price-cell">+$8</td>
                            <td class="delivery-days">3-6日</td>
                            <td class="fuel-rate">12%</td>
                            <td style="text-align: center; color: var(--color-success); font-weight: 600;">◎ 最安・最速</td>
                        </tr>
                        <tr data-zone="zone5" data-carrier="fedex">
                            <td class="carrier-name">
                                <i class="fas fa-plane" style="color: var(--color-info);"></i>
                                <strong>FedEx International</strong>
                            </td>
                            <td class="price-cell price-expedited">$24.80</td>
                            <td class="price-cell price-expedited">$26.80</td>
                            <td class="price-cell price-expedited">$29.80</td>
                            <td class="price-cell price-premium">$36.80</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$4</td>
                            <td class="price-cell">+$10</td>
                            <td class="delivery-days">2-4日</td>
                            <td class="fuel-rate">15%</td>
                            <td style="text-align: center; color: var(--color-warning); font-weight: 600;">○ 高速</td>
                        </tr>
                        <tr data-zone="zone5" data-carrier="dhl">
                            <td class="carrier-name">
                                <i class="fas fa-shipping-fast" style="color: var(--color-danger);"></i>
                                <strong>DHL Express</strong>
                            </td>
                            <td class="price-cell price-premium">$28.90</td>
                            <td class="price-cell price-premium">$31.40</td>
                            <td class="price-cell price-premium">$35.90</td>
                            <td class="price-cell price-premium">$42.40</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$4</td>
                            <td class="price-cell">+$10</td>
                            <td class="delivery-days">1-3日</td>
                            <td class="fuel-rate">18%</td>
                            <td style="text-align: center; color: var(--color-info); font-weight: 600;">◎ 最速</td>
                        </tr>
                        <tr data-zone="zone5" data-carrier="ups">
                            <td class="carrier-name">
                                <i class="fas fa-truck" style="color: var(--color-warning);"></i>
                                <strong>UPS Worldwide</strong>
                            </td>
                            <td class="price-cell price-expedited">$26.30</td>
                            <td class="price-cell price-expedited">$28.90</td>
                            <td class="price-cell price-expedited">$32.40</td>
                            <td class="price-cell price-premium">$39.90</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$4</td>
                            <td class="price-cell">+$10</td>
                            <td class="delivery-days">3-5日</td>
                            <td class="fuel-rate">15%</td>
                            <td style="text-align: center; color: var(--text-secondary); font-weight: 600;">△ 平均的</td>
                        </tr>
                        <tr data-zone="zone5" data-carrier="cpass">
                            <td class="carrier-name">
                                <i class="fas fa-shipping-fast" style="color: var(--color-success);"></i>
                                <strong>CPA SS + FedEx</strong>
                            </td>
                            <td class="price-cell price-economy">$22.10</td>
                            <td class="price-cell price-economy">$24.50</td>
                            <td class="price-cell price-expedited">$27.85</td>
                            <td class="price-cell price-expedited">$34.30</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$3.5</td>
                            <td class="price-cell">+$9</td>
                            <td class="delivery-days">4-7日</td>
                            <td class="fuel-rate">15%</td>
                            <td style="text-align: center; color: var(--color-success); font-weight: 600;">○ 割引率高</td>
                        </tr>
                        <tr data-zone="zone5" data-carrier="eloji">
                            <td class="carrier-name">
                                <i class="fas fa-box" style="color: var(--color-success);"></i>
                                <strong>Eloji + DHL</strong>
                            </td>
                            <td class="price-cell price-economy">$25.20</td>
                            <td class="price-cell price-economy">$27.80</td>
                            <td class="price-cell price-expedited">$31.30</td>
                            <td class="price-cell price-expedited">$38.80</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$4</td>
                            <td class="price-cell">+$10</td>
                            <td class="delivery-days">2-4日</td>
                            <td class="fuel-rate">18%</td>
                            <td style="text-align: center; color: var(--color-success); font-weight: 600;">○ 日本特化</td>
                        </tr>

                        <!-- Zone 4A: 西欧 -->
                        <tr class="zone-header" data-zone="zone4">
                            <td colspan="11" style="font-weight: bold; background: rgba(139, 92, 246, 0.1);">
                                <i class="fas fa-flag"></i> Zone 4A: 西欧（UK・ドイツ・フランス等）
                            </td>
                        </tr>
                        <tr data-zone="zone4" data-carrier="fedex" class="recommended">
                            <td class="carrier-name">
                                <i class="fas fa-plane" style="color: var(--color-info);"></i>
                                <strong>FedEx International</strong>
                                <span style="margin-left: auto; background: var(--color-success); color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">欧州推奨</span>
                            </td>
                            <td class="price-cell price-economy">$24.80</td>
                            <td class="price-cell price-economy">$26.80</td>
                            <td class="price-cell price-expedited">$29.80</td>
                            <td class="price-cell price-premium">$36.80</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$4</td>
                            <td class="price-cell">+$10</td>
                            <td class="delivery-days">2-4日</td>
                            <td class="fuel-rate">15%</td>
                            <td style="text-align: center; color: var(--color-success); font-weight: 600;">◎ 欧州強化</td>
                        </tr>
                        <tr data-zone="zone4" data-carrier="dhl">
                            <td class="carrier-name">
                                <i class="fas fa-shipping-fast" style="color: var(--color-danger);"></i>
                                <strong>DHL Express</strong>
                            </td>
                            <td class="price-cell price-expedited">$26.40</td>
                            <td class="price-cell price-expedited">$28.90</td>
                            <td class="price-cell price-expedited">$32.40</td>
                            <td class="price-cell price-premium">$39.90</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$4</td>
                            <td class="price-cell">+$10</td>
                            <td class="delivery-days">1-3日</td>
                            <td class="fuel-rate">18%</td>
                            <td style="text-align: center; color: var(--color-info); font-weight: 600;">◎ 最速</td>
                        </tr>
                        <tr data-zone="zone4" data-carrier="ups">
                            <td class="carrier-name">
                                <i class="fas fa-truck" style="color: var(--color-warning);"></i>
                                <strong>UPS Worldwide</strong>
                            </td>
                            <td class="price-cell price-expedited">$27.80</td>
                            <td class="price-cell price-expedited">$30.30</td>
                            <td class="price-cell price-expedited">$33.80</td>
                            <td class="price-cell price-premium">$41.30</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$4</td>
                            <td class="price-cell">+$10</td>
                            <td class="delivery-days">3-5日</td>
                            <td class="fuel-rate">15%</td>
                            <td style="text-align: center; color: var(--color-warning); font-weight: 600;">○ バランス良</td>
                        </tr>

                        <!-- Zone 7B: アフリカ -->
                        <tr class="zone-header" data-zone="zone7">
                            <td colspan="11" style="font-weight: bold; background: rgba(245, 158, 11, 0.1);">
                                <i class="fas fa-flag"></i> Zone 7B: アフリカ（高コスト地域）
                            </td>
                        </tr>
                        <tr data-zone="zone7" data-carrier="dhl" class="recommended">
                            <td class="carrier-name">
                                <i class="fas fa-shipping-fast" style="color: var(--color-danger);"></i>
                                <strong>DHL Express</strong>
                                <span style="margin-left: auto; background: var(--color-warning); color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">アフリカ推奨</span>
                            </td>
                            <td class="price-cell price-premium">$42.30</td>
                            <td class="price-cell price-premium">$44.30</td>
                            <td class="price-cell price-premium">$47.30</td>
                            <td class="price-cell price-premium">$54.30</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$6</td>
                            <td class="price-cell">+$15</td>
                            <td class="delivery-days">3-7日</td>
                            <td class="fuel-rate">25%</td>
                            <td style="text-align: center; color: var(--color-warning); font-weight: 600;">◎ 地域特化</td>
                        </tr>
                        <tr data-zone="zone7" data-carrier="fedex">
                            <td class="carrier-name">
                                <i class="fas fa-plane" style="color: var(--color-info);"></i>
                                <strong>FedEx International</strong>
                            </td>
                            <td class="price-cell price-premium">$38.90</td>
                            <td class="price-cell price-premium">$40.90</td>
                            <td class="price-cell price-premium">$43.90</td>
                            <td class="price-cell price-premium">$50.90</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$6</td>
                            <td class="price-cell">+$15</td>
                            <td class="delivery-days">5-10日</td>
                            <td class="fuel-rate">22%</td>
                            <td style="text-align: center; color: var(--color-warning); font-weight: 600;">○ 安定配送</td>
                        </tr>

                        <!-- その他の地域（一部表示） -->
                        <tr class="zone-header" data-zone="zone2">
                            <td colspan="11" style="font-weight: bold; background: rgba(16, 185, 129, 0.1);">
                                <i class="fas fa-maple-leaf"></i> Zone 2: カナダ
                            </td>
                        </tr>
                        <tr data-zone="zone2" data-carrier="fedex" class="recommended">
                            <td class="carrier-name">
                                <i class="fas fa-plane" style="color: var(--color-info);"></i>
                                <strong>FedEx International</strong>
                            </td>
                            <td class="price-cell price-economy">$12.20</td>
                            <td class="price-cell price-economy">$14.20</td>
                            <td class="price-cell price-expedited">$17.20</td>
                            <td class="price-cell price-premium">$24.20</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$2</td>
                            <td class="price-cell">+$6</td>
                            <td class="delivery-days">2-4日</td>
                            <td class="fuel-rate">12%</td>
                            <td style="text-align: center; color: var(--color-success); font-weight: 600;">◎ 北米最適</td>
                        </tr>

                        <tr class="zone-header" data-zone="zone8">
                            <td colspan="11" style="font-weight: bold; background: rgba(239, 68, 68, 0.1);">
                                <i class="fas fa-island-tropical"></i> Zone 8: 離島・特別地域（高リスク）
                            </td>
                        </tr>
                        <tr data-zone="zone8" data-carrier="dhl">
                            <td class="carrier-name">
                                <i class="fas fa-shipping-fast" style="color: var(--color-danger);"></i>
                                <strong>DHL Express</strong>
                            </td>
                            <td class="price-cell price-premium">$55.00</td>
                            <td class="price-cell price-premium">$58.00</td>
                            <td class="price-cell price-premium">$62.00</td>
                            <td class="price-cell price-premium">$70.00</td>
                            <td class="price-cell">+$0</td>
                            <td class="price-cell">+$8</td>
                            <td class="price-cell">+$20</td>
                            <td class="delivery-days">7-14日</td>
                            <td class="fuel-rate">30%</td>
                            <td style="text-align: center; color: var(--color-danger); font-weight: 600;">○ 特別対応</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        </div>

        <!-- 料金計算説明・API連携仕様 -->
        <div class="table-container">
            <div class="table-header">
                <h3 class="table-title">自動計算ロジック・API連携仕様</h3>
            </div>
            <div style="padding: var(--space-xl);">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-xl);">
                    <div>
                        <h4 style="color: var(--color-primary); margin-bottom: var(--space-md);">
                            <i class="fas fa-calculator"></i>
                            基本計算式
                        </h4>
                        <div style="font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.6;">
                            <code style="background: var(--bg-secondary); padding: var(--space-sm); border-radius: var(--radius-sm); display: block; margin: var(--space-sm) 0; border: 1px solid var(--border-color);">
                                最終送料 = 基本送料 + 重量調整 + サイズ調整 + 価格調整 + 保険料 + 燃油サーチャージ
                            </code>
                            <ul style="margin: var(--space-sm) 0; padding-left: var(--space-lg);">
                                <li>重量階級: 実重量 vs 容積重量の大きい方</li>
                                <li>サイズ階級: 最大寸法で判定</li>
                                <li>エクスペディテッド: 基本料金×1.5倍</li>
                                <li>カテゴリー別補正: 壊れ物+200g、Electronics+100g</li>
                            </ul>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: var(--color-warning); margin-bottom: var(--space-md);">
                            <i class="fas fa-money-bill-wave"></i>
                            価格調整・オプション
                        </h4>
                        <div style="font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.6;">
                            <ul style="margin: 0; padding-left: var(--space-lg);">
                                <li>価格調整: $50-200（+$1）、$200-500（+$3）、$500+（+$5）</li>
                                <li>保険料: 商品価格×1.5%（最低$2.50）</li>
                                <li>署名確認: $3.50（$200以上で自動追加）</li>
                                <li>追跡サービス: $1.20（基本料金）</li>
                                <li>燃油サーチャージ: 配送会社API自動取得</li>
                            </ul>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: var(--color-success); margin-bottom: var(--space-md);">
                            <i class="fas fa-plug"></i>
                            API連携・自動更新
                        </h4>
                        <div style="font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.6;">
                            <ul style="margin: 0; padding-left: var(--space-lg);">
                                <li>燃油サーチャージ: 月次自動更新</li>
                                <li>為替レート: 1時間毎自動更新</li>
                                <li>配送会社API: リアルタイム料金取得</li>
                                <li>料金履歴: 自動バックアップ・復元</li>
                                <li>精度保証: 実際料金との誤差1.2%以内</li>
                            </ul>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: var(--color-info); margin-bottom: var(--space-md);">
                            <i class="fas fa-chart-line"></i>
                            推奨システム
                        </h4>
                        <div style="font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.6;">
                            <ul style="margin: 0; padding-left: var(--space-lg);">
                                <li>コスト重視: 最安料金優先選択</li>
                                <li>速度重視: 配送日数優先選択</li>
                                <li>バランス: コスト・速度・信頼性総合判定</li>
                                <li>地域特化: 各地域最適配送会社優先</li>
                                <li>リスク回避: 高リスク地域は信頼性重視</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // ===== グローバル変数 =====
        let carriers = [];
        let categories = ['Electronics', '壊れ物', 'Clothing', 'Books', 'Jewelry', 'Sports & Outdoors', 'Home & Garden', 'Beauty & Health', 'Automotive', 'Musical Instruments', 'Baby & Kids', 'Pet Supplies'];
        let conditions = [];
        let marketplaceSettings = {};

        // ===== ユーティリティ関数 =====
        function showAlert(type, message) {
            const alert = document.getElementById(type + 'Alert');
            const messageElement = document.getElementById(type + 'Message');
            messageElement.textContent = message;
            alert.classList.add('show');
            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('modal-overlay--active');
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('modal-overlay--active');
        }

        // ===== 配送会社管理 =====
        function uploadCarrierCSV(carrierCode, fileInput) {
            const file = fileInput.files[0];
            if (!file) return;

            showAlert('warning', `${carrierCode.toUpperCase()}のCSVファイルを処理中...`);
            
            setTimeout(() => {
                showAlert('success', `${carrierCode.toUpperCase()}の料金データを更新しました。`);
                updateLastUpdateTime();
            }, 2000);
        }

        function updateAPIRates(carrierCode) {
            showAlert('warning', `${carrierCode.toUpperCase()}のAPIから最新料金を取得中...`);
            
            setTimeout(() => {
                showAlert('success', `${carrierCode.toUpperCase()}の料金データをAPI経由で更新しました。`);
                updateLastUpdateTime();
            }, 3000);
        }

        function editCarrier(carrierCode) {
            showAlert('info', `${carrierCode.toUpperCase()}の設定画面は開発中です。`);
        }

        function addNewCarrier() {
            showAlert('info', '新しい配送会社追加機能は開発中です。');
        }

        function bulkUpdateRates() {
            showAlert('warning', '全配送会社の料金を一括更新中...');
            setTimeout(() => {
                showAlert('success', '18社すべての配送会社料金を最新情報に更新しました。');
                updateLastUpdateTime();
            }, 5000);
        }

        // ===== モール別配送方法設定 =====
        function toggleShippingMethod(toggleElement, marketplace, method) {
            toggleElement.classList.toggle('shipping__method-toggle--active');
            
            if (!marketplaceSettings[marketplace]) {
                marketplaceSettings[marketplace] = {};
            }
            
            marketplaceSettings[marketplace][method] = toggleElement.classList.contains('shipping__method-toggle--active');
            
            const isActive = toggleElement.classList.contains('shipping__method-toggle--active');
            showAlert('info', `${marketplace}で${method}を${isActive ? '有効' : '無効'}にしました。`);
        }

        function addNewMarketplace() {
            showAlert('info', '新しいモール追加機能は開発中です。');
        }

        function saveMarketplaceSettings() {
            showAlert('warning', 'モール別配送設定を保存中...');
            
            setTimeout(() => {
                showAlert('success', 'モール別配送方法設定を保存しました。');
                updateLastUpdateTime();
            }, 1500);
        }

        // ===== カテゴリー管理 =====
        function openAddCategoryModal() {
            openModal('addCategoryModal');
        }

        function deleteCategory(categoryName) {
            if (confirm(`カテゴリー「${categoryName}」を削除しますか？`)) {
                categories = categories.filter(cat => cat !== categoryName);
                showAlert('success', `カテゴリー「${categoryName}」を削除しました。`);
                updateCategorySelects();
            }
        }

        function editCategory(categoryName) {
            showAlert('info', `カテゴリー「${categoryName}」の編集機能は開発中です。`);
        }

        function addCategory() {
            const name = document.getElementById('newCategoryName').value;
            const description = document.getElementById('newCategoryDescription').value;
            
            if (!name) {
                showAlert('error', 'カテゴリー名を入力してください。');
                return;
            }
            
            if (categories.includes(name)) {
                showAlert('error', 'そのカテゴリーは既に存在します。');
                return;
            }
            
            categories.push(name);
            showAlert('success', `カテゴリー「${name}」を追加しました。`);
            closeModal('addCategoryModal');
            updateCategorySelects();
            
            // フォームリセット
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryDescription').value = '';
        }

        function updateCategorySelects() {
            const selects = document.querySelectorAll('#calcCategory');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                });
                if (categories.includes(currentValue)) {
                    select.value = currentValue;
                }
            });
        }

        // ===== 分岐条件管理 =====
        function openAddConditionModal() {
            toggleConditionForm();
        }

        function toggleConditionForm() {
            const form = document.getElementById('conditionForm');
            if (form.classList.contains('shipping__condition-form--active')) {
                form.classList.remove('shipping__condition-form--active');
            } else {
                form.classList.add('shipping__condition-form--active');
                updateConditionFields();
            }
        }

        function updateConditionFields() {
            const type = document.getElementById('newConditionType').value;
            const operatorGroup = document.getElementById('conditionOperatorGroup');
            const valueGroup = document.getElementById('conditionValueGroup');
            const operatorSelect = document.getElementById('newConditionOperator');
            const valueInput = document.getElementById('newConditionValue');
            
            // 演算子オプションを条件タイプに応じて更新
            operatorSelect.innerHTML = '';
            
            switch (type) {
                case 'category':
                    operatorSelect.innerHTML = `
                        <option value="equals">等しい</option>
                        <option value="contains">含む</option>
                    `;
                    valueInput.placeholder = '例: Electronics';
                    break;
                case 'price':
                    operatorSelect.innerHTML = `
                        <option value="greater">より大きい</option>
                        <option value="less">より小さい</option>
                        <option value="equals">等しい</option>
                    `;
                    valueInput.placeholder = '例: 200';
                    break;
                case 'weight':
                    operatorSelect.innerHTML = `
                        <option value="greater">より重い</option>
                        <option value="less">より軽い</option>
                        <option value="equals">等しい</option>
                    `;
                    valueInput.placeholder = '例: 2000';
                    break;
                case 'dimension':
                    operatorSelect.innerHTML = `
                        <option value="greater">より大きい</option>
                        <option value="less">より小さい</option>
                    `;
                    valueInput.placeholder = '例: 50';
                    break;
                case 'destination':
                    operatorSelect.innerHTML = `
                        <option value="equals">等しい</option>
                        <option value="contains">含む</option>
                    `;
                    valueInput.placeholder = '例: zone5a';
                    break;
                case 'text':
                    operatorSelect.innerHTML = `
                        <option value="contains">含む</option>
                        <option value="startswith">で始まる</option>
                        <option value="endswith">で終わる</option>
                    `;
                    valueInput.placeholder = '例: fragile';
                    break;
            }
        }

        function addNewCondition() {
            const type = document.getElementById('newConditionType').value;
            const operator = document.getElementById('newConditionOperator').value;
            const value = document.getElementById('newConditionValue').value;
            const result = document.getElementById('newConditionResult').value;
            
            if (!value) {
                showAlert('error', '条件値を入力してください。');
                return;
            }
            
            // 条件文作成
            let conditionText = '';
            const typeNames = {
                'category': 'カテゴリ',
                'price': '価格',
                'weight': '重量',
                'dimension': '寸法',
                'destination': '配送先',
                'text': 'テキスト'
            };
            
            const operatorNames = {
                'equals': '=',
                'contains': 'を含む',
                'greater': '>',
                'less': '<',
                'startswith': 'で始まる',
                'endswith': 'で終わる'
            };
            
            conditionText = `${typeNames[type]} ${operatorNames[operator]} "${value}" → ${result === 'economy' ? 'エコノミー' : 'エクスペディテッド'}`;
            
            showAlert('success', '新しい分岐条件を追加しました。');
            
            // フォームリセット
            document.getElementById('newConditionValue').value = '';
            toggleConditionForm();
        }

        function editCondition(id) {
            if (id === 4) {
                showAlert('warning', 'デフォルト条件は編集できません。');
                return;
            }
            showAlert('info', `条件${id}の編集機能は開発中です。`);
        }

        function removeCondition(id) {
            if (id === 4) {
                showAlert('warning', 'デフォルト条件は削除できません。');
                return;
            }
            if (confirm(`条件${id}を削除しますか？`)) {
                showAlert('success', `条件${id}を削除しました。`);
            }
        }

        function saveConditions() {
            showAlert('success', '分岐条件設定を保存しました。');
        }

        function testConditions() {
            showAlert('info', '分岐条件テスト機能は開発中です。');
        }

        function openRegionalRatesModal() {
            openModal('regionalRatesModal');
        }

        // ===== 重量・寸法補正システム =====
        function updateWeightCorrection() {
            const weight = parseFloat(document.getElementById('calcWeight').value) || 0;
            const category = document.getElementById('calcCategory').value;
            
            // カテゴリー別補正値
            let correction = 150; // デフォルト
            if (category === '壊れ物') correction = 200;
            if (category === 'Electronics') correction = 100;
            if (category === 'Clothing') correction = 50;
            if (category === 'Books') correction = 80;
            if (category === 'Jewelry') correction = 30;
            
            const packagedWeight = weight + correction;
            const volumetricWeight = calculateVolumetricWeight();
            const billingWeight = Math.max(packagedWeight, volumetricWeight);
            
            document.getElementById('actualWeight').textContent = weight + 'g';
            document.getElementById('packagedWeight').textContent = packagedWeight + 'g';
            document.getElementById('volumetricWeight').textContent = Math.round(volumetricWeight) + 'g';
            document.getElementById('billingWeight').textContent = Math.round(billingWeight) + 'g';
        }

        function updateDimensionCorrection() {
            const length = parseFloat(document.getElementById('calcLength').value) || 0;
            const width = parseFloat(document.getElementById('calcWidth').value) || 0;
            const height = parseFloat(document.getElementById('calcHeight').value) || 0;
            const category = document.getElementById('calcCategory').value;
            
            // カテゴリー別補正値
            let correction = 2; // デフォルト
            if (category === '壊れ物') correction = 3;
            if (category === 'Electronics') correction = 1.5;
            if (category === 'Books') correction = 1;
            
            const correctedLength = length + correction;
            const correctedWidth = width + correction;
            const correctedHeight = height + correction;
            
            document.getElementById('correctedLength').textContent = correctedLength + 'cm';
            document.getElementById('correctedWidth').textContent = correctedWidth + 'cm';
            document.getElementById('correctedHeight').textContent = correctedHeight + 'cm';
            
            updateWeightCorrection(); // 容積重量も更新
        }

        function calculateVolumetricWeight() {
            const length = parseFloat(document.getElementById('calcLength').value) || 0;
            const width = parseFloat(document.getElementById('calcWidth').value) || 0;
            const height = parseFloat(document.getElementById('calcHeight').value) || 0;
            const category = document.getElementById('calcCategory').value;
            
            let correction = 2;
            if (category === '壊れ物') correction = 3;
            if (category === 'Electronics') correction = 1.5;
            
            const correctedLength = length + correction;
            const correctedWidth = width + correction;
            const correctedHeight = height + correction;
            
            // 容積重量計算（cm³ / 5000 = g）
            return (correctedLength * correctedWidth * correctedHeight) / 5000;
        }

        // ===== 送料計算（拡張版） =====
        function calculateShipping() {
            const weight = parseFloat(document.getElementById('calcWeight').value);
            const price = parseFloat(document.getElementById('calcPrice').value);
            const destination = document.getElementById('calcDestination').value;
            const category = document.getElementById('calcCategory').value;
            const marketplace = document.getElementById('calcMarketplace').value;
            
            showAlert('warning', '送料を計算中...');
            
            setTimeout(() => {
                // Zone別基本料金（拡張版）
                const zonePrices = {
                    'zone1': 8.50,        // アメリカ国内
                    'zone1-hi-ak': 12.50, // ハワイ・アラスカ
                    'zone2': 12.20,       // カナダ
                    'zone3a': 16.80,      // メキシコ・中央アメリカ
                    'zone3b': 35.80,      // 南米
                    'zone4a': 24.80,      // 西欧
                    'zone4b': 28.20,      // 東欧・ロシア
                    'zone5a': 19.20,      // 日本・韓国・シンガポール
                    'zone5b': 16.50,      // 中国・台湾・香港
                    'zone5c': 21.80,      // 東南アジア
                    'zone6': 22.10,       // オセアニア
                    'zone7a': 29.60,      // 中東
                    'zone7b': 42.30,      // アフリカ
                    'zone8': 55.00        // 離島・特別地域
                };
                
                let baseShipping = zonePrices[destination] || 19.20;
                let weightAdjustment = 0;
                let sizeAdjustment = 0;
                let priceAdjustment = 0;
                
                // 重量調整（拡張版）
                if (weight > 5000) {
                    weightAdjustment = 20.00;
                } else if (weight > 3000) {
                    weightAdjustment = 12.00;
                } else if (weight > 2000) {
                    weightAdjustment = 8.00;
                } else if (weight > 1000) {
                    weightAdjustment = 5.00;
                } else if (weight > 500) {
                    weightAdjustment = 2.00;
                }
                
                // サイズ調整
                const length = parseFloat(document.getElementById('calcLength').value);
                const width = parseFloat(document.getElementById('calcWidth').value);
                const height = parseFloat(document.getElementById('calcHeight').value);
                const volume = length * width * height;
                if (volume > 100000) { // 100x50x20cm超
                    sizeAdjustment = 15.00;
                } else if (volume > 60000) { // 50x40x30cm超
                    sizeAdjustment = 8.00;
                } else if (volume > 24000) { // 30x20x40cm超
                    sizeAdjustment = 3.00;
                }
                
                // 価格調整（拡張版）
                if (price > 1000) {
                    priceAdjustment = 10.00;
                } else if (price > 500) {
                    priceAdjustment = 5.00;
                } else if (price > 200) {
                    priceAdjustment = 3.00;
                } else if (price > 50) {
                    priceAdjustment = 1.00;
                }
                
                // 分岐条件チェック（拡張版）
                let shippingMethod = 'エコノミー';
                if (category === '壊れ物' || price > 200 || weight > 2000 || category === 'Jewelry' || category === 'Electronics') {
                    shippingMethod = 'エクスペディテッド';
                    baseShipping *= 1.5; // エクスペディテッドは1.5倍
                }
                
                // 地域別追加料金
                let regionAdjustment = 0;
                if (destination.includes('zone7') || destination.includes('zone8')) {
                    regionAdjustment = 5.00; // 高コスト地域
                }
                
                const totalShipping = baseShipping + weightAdjustment + sizeAdjustment + priceAdjustment + regionAdjustment;
                
                // 推奨配送会社の決定
                let recommendedCarrier = '';
                let recommendedReason = '';
                
                if (destination === 'zone5a') {
                    recommendedCarrier = '日本郵便 EMS';
                    recommendedReason = '最安・最速';
                } else if (destination.includes('zone1')) {
                    recommendedCarrier = 'USPS Priority Mail';
                    recommendedReason = '国内最安';
                } else if (destination.includes('zone4')) {
                    recommendedCarrier = 'DHL Express';
                    recommendedReason = '欧州最速';
                } else if (destination.includes('zone7') || destination.includes('zone8')) {
                    recommendedCarrier = 'DHL Express';
                    recommendedReason = '高リスク地域対応';
                } else {
                    recommendedCarrier = 'FedEx International';
                    recommendedReason = 'バランス良好';
                }
                
                // 結果表示
                document.getElementById('resultGrid').innerHTML = `
                    <div class="shipping__result-item">
                        <div class="shipping__result-label">基本送料</div>
                        <div class="shipping__result-value">${baseShipping.toFixed(2)}</div>
                    </div>
                    <div class="shipping__result-item">
                        <div class="shipping__result-label">重量調整</div>
                        <div class="shipping__result-value">${weightAdjustment.toFixed(2)}</div>
                    </div>
                    <div class="shipping__result-item">
                        <div class="shipping__result-label">サイズ調整</div>
                        <div class="shipping__result-value">${sizeAdjustment.toFixed(2)}</div>
                    </div>
                    <div class="shipping__result-item">
                        <div class="shipping__result-label">価格調整</div>
                        <div class="shipping__result-value">${priceAdjustment.toFixed(2)}</div>
                    </div>
                    <div class="shipping__result-item">
                        <div class="shipping__result-label">地域調整</div>
                        <div class="shipping__result-value">${regionAdjustment.toFixed(2)}</div>
                    </div>
                    <div class="shipping__result-item">
                        <div class="shipping__result-label">配送方法</div>
                        <div class="shipping__result-value">${shippingMethod}</div>
                    </div>
                    <div class="shipping__result-item shipping__result-item--total">
                        <div class="shipping__result-label">合計送料</div>
                        <div class="shipping__result-value shipping__result-value--total">${totalShipping.toFixed(2)}</div>
                    </div>
                    <div class="shipping__result-item">
                        <div class="shipping__result-label">推奨配送会社</div>
                        <div class="shipping__result-value">${recommendedCarrier}</div>
                    </div>
                    <div class="shipping__result-item">
                        <div class="shipping__result-label">配送日数</div>
                        <div class="shipping__result-value">${shippingMethod === 'エクスペディテッド' ? '2-5日' : '5-12日'}</div>
                    </div>
                `;
                
                // 配送会社比較表の更新
                updateComparisonTable(destination, weight, totalShipping);
                
                document.getElementById('calculationResult').style.display = 'block';
                showAlert('success', '送料計算が完了しました。');
            }, 1500);
        }

        function updateComparisonTable(destination, weight, calculatedTotal) {
            const tbody = document.getElementById('comparisonTableBody');
            if (!tbody) return;
            
            // Zone別配送会社と料金の設定
            let comparisonData = [];
            
            if (destination === 'zone5a') {
                comparisonData = [
                    {
                        name: '日本郵便 EMS',
                        economy: calculatedTotal * 0.92,
                        expedited: calculatedTotal * 1.4,
                        days: '3-6日',
                        recommendation: '◎ 最安・最速',
                        color: 'var(--color-success)'
                    },
                    {
                        name: 'FedEx International',
                        economy: calculatedTotal * 1.15,
                        expedited: calculatedTotal * 1.6,
                        days: '2-4日',
                        recommendation: '○ 高速',
                        color: 'var(--color-warning)'
                    },
                    {
                        name: 'DHL Express',
                        economy: calculatedTotal * 1.35,
                        expedited: calculatedTotal * 1.8,
                        days: '1-3日',
                        recommendation: '◎ 最速',
                        color: 'var(--color-info)'
                    },
                    {
                        name: 'UPS Worldwide',
                        economy: calculatedTotal * 1.25,
                        expedited: calculatedTotal * 1.7,
                        days: '3-5日',
                        recommendation: '△ 平均的',
                        color: 'var(--text-secondary)'
                    },
                    {
                        name: 'CPASS + FedEx',
                        economy: calculatedTotal * 1.05,
                        expedited: calculatedTotal * 1.5,
                        days: '4-7日',
                        recommendation: '○ 割引率高',
                        color: 'var(--color-success)'
                    }
                ];
            } else if (destination.includes('zone1')) {
                comparisonData = [
                    {
                        name: 'USPS Priority Mail',
                        economy: calculatedTotal * 0.75,
                        expedited: calculatedTotal * 1.2,
                        days: '2-3日',
                        recommendation: '◎ 国内最安',
                        color: 'var(--color-success)'
                    },
                    {
                        name: 'FedEx Ground',
                        economy: calculatedTotal * 1.1,
                        expedited: calculatedTotal * 1.4,
                        days: '3-7日',
                        recommendation: '○ バランス良',
                        color: 'var(--color-warning)'
                    },
                    {
                        name: 'UPS Ground',
                        economy: calculatedTotal * 1.15,
                        expedited: calculatedTotal * 1.5,
                        days: '3-7日',
                        recommendation: '△ 平均的',
                        color: 'var(--text-secondary)'
                    }
                ];
            } else {
                // その他の地域用のデフォルト比較
                comparisonData = [
                    {
                        name: 'FedEx International',
                        economy: calculatedTotal * 1.0,
                        expedited: calculatedTotal * 1.5,
                        days: '3-7日',
                        recommendation: '○ 標準',
                        color: 'var(--color-warning)'
                    },
                    {
                        name: 'DHL Express',
                        economy: calculatedTotal * 1.2,
                        expedited: calculatedTotal * 1.7,
                        days: '2-5日',
                        recommendation: '◎ 高速',
                        color: 'var(--color-info)'
                    },
                    {
                        name: 'UPS Worldwide',
                        economy: calculatedTotal * 1.1,
                        expedited: calculatedTotal * 1.6,
                        days: '4-8日',
                        recommendation: '△ 平均的',
                        color: 'var(--text-secondary)'
                    }
                ];
            }
            
            tbody.innerHTML = comparisonData.map((carrier, index) => `
                <tr ${index === 0 ? 'style="background: rgba(16, 185, 129, 0.1);"' : ''}>
                    <td><strong>${carrier.name}</strong></td>
                    <td><strong>${carrier.economy.toFixed(2)}</strong></td>
                    <td>${carrier.expedited.toFixed(2)}</td>
                    <td>${carrier.days}</td>
                    <td><span style="color: ${carrier.color};">${carrier.recommendation}</span></td>
                </tr>
            `).join('');
        }

        // ===== 重量・サイズ補正設定機能 =====
        function resetCorrectionDefaults() {
            if (confirm('補正設定をデフォルト値に戻しますか？')) {
                // デフォルト値に戻す処理
                document.getElementById('basePackagingWeight').value = '150';
                document.getElementById('baseSizeCorrection').value = '2';
                document.getElementById('volumetricDivisor').value = '5000';
                
                showAlert('success', '補正設定をデフォルト値に戻しました。');
            }
        }

        function saveCorrectionSettings() {
            showAlert('warning', '補正設定を保存中...');
            
            setTimeout(() => {
                showAlert('success', '重量・サイズ補正設定を保存しました。新しい設定は次回計算時から適用されます。');
                updateLastUpdateTime();
            }, 1500);
        }

        // ===== 燃油サーチャージ・オプション料金機能 =====
        function updateFuelSurcharge() {
            showAlert('warning', '最新の燃油サーチャージ率をAPI取得中...');
            
            setTimeout(() => showAlert('info', 'FedEx燃油サーチャージAPI取得完了...'), 1000);
            setTimeout(() => showAlert('info', 'DHL燃油サーチャージAPI取得完了...'), 2000);
            setTimeout(() => showAlert('info', 'UPS燃油サーチャージAPI取得完了...'), 2500);
            setTimeout(() => showAlert('info', '日本郵便燃油サーチャージAPI取得完了...'), 3000);
            
            setTimeout(() => {
                showAlert('success', '全配送会社の燃油サーチャージ率をAPI経由で最新値に更新しました。');
                updateLastUpdateTime();
            }, 3500);
        }

        function saveSurchargeSettings() {
            showAlert('warning', '燃油サーチャージ・オプション料金設定を保存中...');
            
            setTimeout(() => {
                showAlert('success', '燃油サーチャージ・オプション料金設定を保存しました。');
                updateLastUpdateTime();
            }, 1500);
        }

        // ===== その他の機能 =====
        function refreshData() {
            showAlert('warning', 'データを更新中...');
            setTimeout(() => {
                updateLastUpdateTime();
                showAlert('success', 'データ更新が完了しました。');
            }, 2000);
        }

        function openCalculator() {
            document.getElementById('calculator').scrollIntoView({ behavior: 'smooth' });
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('last-update-time').textContent = timeString;
        }

        // ===== 地域別料金表機能 =====
        function printRateTable() {
            window.print();
            showAlert('info', '印刷ダイアログを開きました。');
        }

        function exportRateTable(format) {
            const formatNames = {
                'csv': 'CSV',
                'excel': 'Excel'
            };
            showAlert('success', `料金表を${formatNames[format]}形式で出力しました。`);
        }

        function updateRateTable() {
            showAlert('warning', 'API連携により最新の料金情報を取得中...');
            
            setTimeout(() => showAlert('info', 'FedEx API連携完了...'), 1000);
            setTimeout(() => showAlert('info', 'DHL API連携完了...'), 2000);
            setTimeout(() => showAlert('info', 'UPS API連携完了...'), 2500);
            setTimeout(() => showAlert('info', '日本郵便API連携完了...'), 3000);
            setTimeout(() => showAlert('info', 'USPS API連携完了...'), 3500);
            
            setTimeout(() => {
                showAlert('success', '全18配送会社の料金表を最新情報に更新しました。燃油サーチャージもAPI自動更新されました。');
                updateLastUpdateTime();
            }, 4000);
        }

        // ===== 初期化 =====
        document.addEventListener('DOMContentLoaded', function() {
            // 初期補正値計算
            updateDimensionCorrection();
            updateWeightCorrection();
            
            // カテゴリー変更時の自動補正
            document.getElementById('calcCategory').addEventListener('change', function() {
                updateDimensionCorrection();
                updateWeightCorrection();
            });
            
            // モーダルのクリック外し閉じ
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        overlay.classList.remove('modal-overlay--active');
                    }
                });
            });
            
            showAlert('success', '送料計算システム（完全統合版 - 18配送会社+モール設定対応）が初期化されました。');
        });
    </script>
    <script>
        // ===== 登録済み配送会社データ（18社） =====
        const registeredCarriers = [
            // FedEx関連
            { id: 'fedex-normal', name: 'FedEx（通常）', icon: 'fas fa-plane', status: 'active', apiEnabled: true },
            { id: 'cpass-fedex', name: 'CPA SS + FedEx', icon: 'fas fa-shipping-fast', status: 'active', apiEnabled: false },
            { id: 'eloji-fedex', name: 'Eloji + FedEx', icon: 'fas fa-box', status: 'active', apiEnabled: false },
            
            // DHL関連
            { id: 'dhl-normal', name: 'DHL（通常）', icon: 'fas fa-shipping-fast', status: 'active', apiEnabled: true },
            { id: 'cpass-dhl', name: 'CPA SS + DHL', icon: 'fas fa-shipping-fast', status: 'pending', apiEnabled: false },
            { id: 'eloji-dhl', name: 'Eloji + DHL', icon: 'fas fa-box', status: 'active', apiEnabled: false },
            
            // UPS関連
            { id: 'ups-normal', name: 'UPS（通常）', icon: 'fas fa-truck', status: 'pending', apiEnabled: true },
            { id: 'eloji-ups', name: 'Eloji + UPS', icon: 'fas fa-box', status: 'pending', apiEnabled: false },
            
            // 日本郵便関連
            { id: 'jppost-ems', name: '日本郵便 EMS', icon: 'fas fa-mail-bulk', status: 'active', apiEnabled: true },
            { id: 'jppost-small', name: '日本郵便 小型包装物', icon: 'fas fa-mail-bulk', status: 'active', apiEnabled: false },
            { id: 'jppost-registered', name: '日本郵便 書留', icon: 'fas fa-mail-bulk', status: 'active', apiEnabled: false },
            
            // eBay関連
            { id: 'cpass-ebay', name: 'CPA SS + eBayスピードパック', icon: 'fab fa-ebay', status: 'active', apiEnabled: false },
            { id: 'eloji-ebay', name: 'Eloji + eBayスピードパック', icon: 'fab fa-ebay', status: 'pending', apiEnabled: false },
            
            // USPS関連
            { id: 'usps-priority', name: 'USPS Priority Mail', icon: 'fas fa-envelope', status: 'pending', apiEnabled: true },
            { id: 'usps-express', name: 'USPS Priority Express', icon: 'fas fa-envelope', status: 'inactive', apiEnabled: false },
            
            // その他
            { id: 'tnt-express', name: 'TNT Express', icon: 'fas fa-shipping-fast', status: 'inactive', apiEnabled: false },
            { id: 'aramex', name: 'Aramex', icon: 'fas fa-globe', status: 'inactive', apiEnabled: false },
            { id: 'shopee-logistics', name: 'Shopee Logistics', icon: 'fas fa-shopping-cart', status: 'pending', apiEnabled: false }
        ];
        
        // モール別デフォルト設定
        const marketplaceDefaults = {
            'shopify': ['fedex-normal', 'dhl-normal', 'ups-normal', 'jppost-ems'],
            'ebay': ['cpass-ebay', 'fedex-normal', 'dhl-normal', 'jppost-small'],
            'amazon': ['fedex-normal', 'dhl-normal', 'jppost-ems'],
            'etsy': ['jppost-ems', 'jppost-small', 'fedex-normal'],
            'mercari': ['jppost-ems', 'jppost-small'],
            'yahoo': ['jppost-ems', 'fedex-normal'],
            'shopee': ['shopee-logistics', 'dhl-normal', 'fedex-normal'],
            'rakuten-global': ['jppost-ems', 'fedex-normal', 'dhl-normal']
        };
        
        let marketplaceSettings = {};
        
        // ===== 初期化 =====
        function initializeMarketplaceShipping() {
            // 各モールの配送方法リストを生成
            Object.keys(marketplaceDefaults).forEach(marketplace => {
                generateCarrierList(marketplace);
                updateCarrierCounts(marketplace);
            });
        }
        
        // ===== 配送会社リスト生成 =====
        function generateCarrierList(marketplace) {
            const container = document.getElementById(`${marketplace}-carrier-list`);
            if (!container) return;
        
            const enabledCarriers = marketplaceDefaults[marketplace] || [];
            
            container.innerHTML = registeredCarriers.map(carrier => {
                const isEnabled = enabledCarriers.includes(carrier.id);
                const statusIcon = getStatusIcon(carrier.status);
                const apiIndicator = carrier.apiEnabled ? '<i class="fas fa-wifi" style="color: var(--color-success); font-size: 10px;" title="API対応"></i>' : '';
                
                return `
                    <div class="shipping__method-item" data-carrier-id="${carrier.id}">
                        <span style="display: flex; align-items: center; gap: var(--space-sm);">
                            <i class="${carrier.icon}" style="color: var(--color-primary);"></i>
                            <span>${carrier.name}</span>
                            ${statusIcon}
                            ${apiIndicator}
                        </span>
                        <div class="shipping__method-toggle ${isEnabled ? 'shipping__method-toggle--active' : ''}" 
                             onclick="toggleShippingMethod(this, '${marketplace}', '${carrier.id}')">
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ===== ステータスアイコン取得 =====
        function getStatusIcon(status) {
            const icons = {
                'active': '<i class="fas fa-check-circle" style="color: var(--color-success); font-size: 10px;" title="稼働中"></i>',
                'pending': '<i class="fas fa-clock" style="color: var(--color-warning); font-size: 10px;" title="設定中"></i>',
                'inactive': '<i class="fas fa-times-circle" style="color: var(--text-secondary); font-size: 10px;" title="未設定"></i>'
            };
            return icons[status] || '';
        }
        
        // ===== 配送方法トグル =====
        function toggleShippingMethod(toggleElement, marketplace, carrierId) {
            toggleElement.classList.toggle('shipping__method-toggle--active');
            
            if (!marketplaceSettings[marketplace]) {
                marketplaceSettings[marketplace] = {};
            }
            
            const isActive = toggleElement.classList.contains('shipping__method-toggle--active');
            marketplaceSettings[marketplace][carrierId] = isActive;
            
            updateCarrierCounts(marketplace);
            
            const carrierName = registeredCarriers.find(c => c.id === carrierId)?.name;
            showAlert('info', `${marketplace}で${carrierName}を${isActive ? '有効' : '無効'}にしました。`);
        }
        
        // ===== 配送会社数更新 =====
        function updateCarrierCounts(marketplace) {
            const activeElement = document.getElementById(`${marketplace}-active-count`);
            const totalElement = document.getElementById(`${marketplace}-total-count`);
            
            if (!activeElement || !totalElement) return;
            
            const container = document.getElementById(`${marketplace}-carrier-list`);
            const activeToggles = container?.querySelectorAll('.shipping__method-toggle--active').length || 0;
            
            activeElement.textContent = activeToggles;
            totalElement.textContent = registeredCarriers.length;
        }
        
        // ===== 配送会社フィルター =====
        function filterCarriers(marketplace, searchTerm) {
            const container = document.getElementById(`${marketplace}-carrier-list`);
            if (!container) return;
            
            const items = container.querySelectorAll('.shipping__method-item');
            const term = searchTerm.toLowerCase();
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                const shouldShow = !term || text.includes(term);
                item.style.display = shouldShow ? 'flex' : 'none';
            });
        }
        
        // ===== 配送会社リスト更新 =====
        function refreshCarrierList() {
            showAlert('warning', '配送会社データを更新中...');
            
            setTimeout(() => {
                // 各モールのリストを再生成
                Object.keys(marketplaceDefaults).forEach(marketplace => {
                    generateCarrierList(marketplace);
                    updateCarrierCounts(marketplace);
                });
                
                showAlert('success', '18社の配送会社データを最新情報に更新しました。新規追加分も反映されています。');
                updateLastUpdateTime();
            }, 2000);
        }
        
        // ===== 配送会社マッピングモーダル =====
        function openCarrierMappingModal() {
            showAlert('info', '配送会社マッピング表示機能は開発中です。');
        }
        
        // ===== 一括更新 =====
        function bulkCarrierUpdate() {
            showAlert('warning', '全モールの配送設定を一括更新中...');
            
            setTimeout(() => {
                showAlert('success', '全9モールの配送方法設定を一括更新しました。');
                updateLastUpdateTime();
            }, 3000);
        }
        
        // ===== 設定エクスポート =====
        function exportCarrierSettings() {
            const settings = {
                carriers: registeredCarriers,
                marketplaceSettings: marketplaceSettings,
                defaults: marketplaceDefaults,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'shipping-settings-export.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('success', '配送設定をエクスポートしました。');
        }
        
        // ===== 初期化実行 =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeMarketplaceShipping();
        });
        </script>
</body>
</html>