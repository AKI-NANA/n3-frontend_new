<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBay手数料カテゴリーマッチング</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #2563eb, #06b6d4); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .form-textarea { min-height: 300px; }
        .btn { background: #2563eb; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #1d4ed8; }
        .results { display: none; }
        .match-item { border: 1px solid #e5e7eb; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .confidence-high { background: #d1fae5; }
        .confidence-medium { background: #fef3c7; }
        .confidence-low { background: #fee2e2; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🏷️ eBay手数料カテゴリーマッチング</h1>
            <p>手数料テキストデータとCSVカテゴリーを自動照合</p>
        </div>

        <div class="grid">
            <div class="card">
                <h3>📝 手数料テキストデータ</h3>
                <div class="form-group">
                    <label class="form-label">eBay公式手数料データ</label>
                    <textarea id="feeText" class="form-input form-textarea" placeholder="**Most categories**
* 13.6% on total amount of the sale up to $7,500

**Books & Magazines**  
* 15.3% on total amount of the sale up to $7,500

**Clothing, Shoes & Accessories**
* 13.6% if total amount is $2,000 or less
* 9% if total amount is over $2,000">**Most categories**
* 13.6% on total amount of the sale up to $7,500 calculated per item
* 2.35% on the portion of the sale over $7,500

**Books & Magazines**
**Movies & TV**
**Music**
* 15.3% on total amount of the sale up to $7,500 calculated per item
* 2.35% on the portion of the sale over $7,500

**Coins & Paper Money**
* 13.25% on total amount of the sale up to $7,500 calculated per item
* 2.35% on the portion of the sale over $7,500

**Clothing, Shoes & Accessories**
* 13.6% if total amount of the sale is $2,000 or less
* 9% if total amount of the sale is over $2,000

**Jewelry & Watches**
* 15% if total amount of the sale is $5,000 or less
* 9% if total amount of the sale is over $5,000</textarea>
                </div>
                
                <button class="btn" onclick="processMatching()">🤖 マッチング実行</button>
            </div>

            <div class="card">
                <h3>📊 処理結果</h3>
                <div id="processingStatus">「マッチング実行」ボタンをクリックしてください</div>
                
                <div id="results" class="results">
                    <h4>マッチング結果</h4>
                    <div id="summary"></div>
                    <div id="matchList"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>📈 マッチング統計</h3>
            <div id="statistics" style="display: none;">
                <canvas id="matchChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        async function processMatching() {
            const feeText = document.getElementById('feeText').value;
            const statusDiv = document.getElementById('processingStatus');
            
            if (!feeText.trim()) {
                alert('手数料テキストを入力してください');
                return;
            }
            
            statusDiv.innerHTML = '🔄 処理中...';
            
            try {
                // フロントエンドでテキスト解析
                const parsedRules = parseFeeStructure(feeText);
                
                // サンプルカテゴリーデータでマッチングテスト
                const sampleCategories = [
                    { id: '1', path: 'Books & Magazines > Fiction Books', fvf: '15.30%' },
                    { id: '2', path: 'Clothing, Shoes & Accessories > Women > Tops', fvf: '13.60%' },
                    { id: '3', path: 'Electronics > Cell Phones & Accessories', fvf: '12.90%' },
                    { id: '4', path: 'Jewelry & Watches > Fine Jewelry > Rings', fvf: '15.00%' },
                    { id: '5', path: 'Movies & TV > DVDs & Blu-ray Discs', fvf: '15.30%' },
                    { id: '6', path: 'Music > CDs', fvf: '15.30%' },
                    { id: '7', path: 'Coins & Paper Money > Coins', fvf: '13.25%' },
                    { id: '8', path: 'Toys & Hobbies > Action Figures', fvf: '13.60%' },
                    { id: '9', path: 'Collectibles > Trading Cards', fvf: '13.25%' },
                    { id: '10', path: 'Home & Garden > Kitchen, Dining & Bar', fvf: '13.60%' }
                ];
                
                const matches = performMatching(sampleCategories, parsedRules);
                displayResults(matches, parsedRules);
                
            } catch (error) {
                console.error('Processing error:', error);
                statusDiv.innerHTML = '❌ 処理エラー: ' + error.message;
            }
        }

        function parseFeeStructure(text) {
            const rules = [];
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            
            let currentCategories = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // カテゴリー名検出
                const categoryMatch = line.match(/\*\*([^*]+)\*\*/g);
                if (categoryMatch) {
                    currentCategories = categoryMatch.map(m => m.replace(/\*\*/g, '').trim());
                    continue;
                }
                
                // パーセンテージ検出
                const percentMatch = line.match(/(\d+\.?\d*)\s*%/);
                if (percentMatch && currentCategories.length > 0) {
                    const percent = parseFloat(percentMatch[1]);
                    
                    // 基本手数料のみ保存（2.35%のような追加手数料は除外）
                    if (percent > 5) {
                        currentCategories.forEach(category => {
                            const existingRule = rules.find(r => r.category === category);
                            if (!existingRule) {
                                rules.push({
                                    category: category,
                                    fee_percent: percent,
                                    conditions: line,
                                    keywords: category.toLowerCase().split(/[\s&,]+/)
                                });
                            }
                        });
                    }
                }
            }
            
            return rules;
        }

        function performMatching(categories, rules) {
            const matches = [];
            
            categories.forEach(category => {
                let bestMatch = null;
                let bestScore = 0;
                
                rules.forEach(rule => {
                    const score = calculateMatchScore(category.path.toLowerCase(), rule);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = {
                            rule: rule,
                            score: score,
                            confidence: Math.min(score, 100)
                        };
                    }
                });
                
                if (bestScore > 30) {
                    matches.push({
                        category_id: category.id,
                        category_path: category.path,
                        existing_fvf: category.fvf,
                        matched_fee: bestMatch.rule.fee_percent,
                        confidence: bestMatch.confidence,
                        match_reason: `"${bestMatch.rule.category}" キーワードマッチ`
                    });
                }
            });
            
            return matches;
        }

        function calculateMatchScore(categoryPath, rule) {
            let score = 0;
            
            // 完全カテゴリー名マッチング
            if (categoryPath.includes(rule.category.toLowerCase())) {
                score += 90;
            }
            
            // キーワード個別マッチング
            rule.keywords.forEach(keyword => {
                if (keyword.length >= 3 && categoryPath.includes(keyword)) {
                    score += 40;
                }
            });
            
            // 特殊ルール
            if (rule.category === 'Most categories' && score === 0) {
                score = 50; // デフォルトマッチ
            }
            
            return score;
        }

        function displayResults(matches, rules) {
            document.getElementById('processingStatus').innerHTML = '✅ 処理完了';
            document.getElementById('results').style.display = 'block';
            
            // サマリー表示
            const summary = document.getElementById('summary');
            const highConf = matches.filter(m => m.confidence >= 80).length;
            const medConf = matches.filter(m => m.confidence >= 60 && m.confidence < 80).length;
            const lowConf = matches.filter(m => m.confidence < 60).length;
            
            summary.innerHTML = `
                <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div>解析ルール: <strong>${rules.length}</strong></div>
                    <div>マッチ数: <strong>${matches.length}</strong></div>
                    <div>高信頼度: <strong>${highConf}</strong></div>
                    <div>中信頼度: <strong>${medConf}</strong></div>
                    <div>低信頼度: <strong>${lowConf}</strong></div>
                </div>
            `;
            
            // マッチリスト表示
            const matchList = document.getElementById('matchList');
            matchList.innerHTML = matches.map(match => {
                const confidenceClass = 
                    match.confidence >= 80 ? 'confidence-high' :
                    match.confidence >= 60 ? 'confidence-medium' : 'confidence-low';
                
                return `
                    <div class="match-item ${confidenceClass}">
                        <strong>${match.category_path}</strong><br>
                        既存FVF: ${match.existing_fvf} → 新FVF: <strong>${match.matched_fee}%</strong><br>
                        信頼度: ${match.confidence}% | ${match.match_reason}
                    </div>
                `;
            }).join('');
            
            document.getElementById('statistics').style.display = 'block';
        }

        console.log('🏷️ eBay手数料マッチングシステム初期化完了');
    </script>
</body>
</html>