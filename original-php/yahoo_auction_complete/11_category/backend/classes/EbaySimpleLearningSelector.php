<?php
/**
 * Á∞°ÊòìÁâàËá™Â∑±Â≠¶ÁøíÂûã„Ç´„ÉÜ„Ç¥„É™„ÉºÈÅ∏Êäû„Ç∑„Çπ„ÉÜ„É† - ‰æùÂ≠òÈñ¢‰øÇ„Å™„Åó
 * „Éï„Ç°„Ç§„É´: EbaySimpleLearningSelector.php
 */

class EbaySimpleLearningSelector {
    private $pdo;
    private $apiCallCount = 0;
    
    public function __construct($dbConnection) {
        $this->pdo = $dbConnection;
        $this->initializeSimpleTables();
        echo "‚úÖ „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü\n";
    }
    
    /**
     * ‰æùÂ≠òÈñ¢‰øÇ„ÅÆ„Å™„ÅÑ„ÉÜ„Éº„Éñ„É´ÂàùÊúüÂåñ
     */
    private function initializeSimpleTables() {
        try {
            // Â≠¶Áøí„ÉÜ„Éº„Éñ„É´‰ΩúÊàêÔºàPostgreSQLÊ®ôÊ∫ñÊ©üËÉΩ„ÅÆ„ÅøÔºâ
            $this->pdo->exec("
                CREATE TABLE IF NOT EXISTS ebay_simple_learning (
                    id SERIAL PRIMARY KEY,
                    title_hash VARCHAR(64) UNIQUE,
                    title TEXT NOT NULL,
                    brand VARCHAR(100),
                    yahoo_category VARCHAR(200),
                    price_jpy INTEGER DEFAULT 0,
                    
                    learned_category_id VARCHAR(20),
                    learned_category_name VARCHAR(200),
                    confidence INTEGER DEFAULT 0,
                    
                    usage_count INTEGER DEFAULT 0,
                    success_count INTEGER DEFAULT 0,
                    created_at TIMESTAMP DEFAULT NOW()
                )
            ");
            
            echo "üìä Â≠¶Áøí„ÉÜ„Éº„Éñ„É´‰ΩúÊàêÂÆå‰∫Ü\n";
            
        } catch (Exception $e) {
            echo "‚ùå „ÉÜ„Éº„Éñ„É´‰ΩúÊàê„Ç®„É©„Éº: " . $e->getMessage() . "\n";
        }
    }
    
    /**
     * „Ç∑„É≥„Éó„É´Â≠¶ÁøíÊ§úÁ¥¢
     */
    public function selectOptimalCategory($productInfo) {
        $startTime = microtime(true);
        $title = $productInfo['title'] ?? '';
        $brand = $productInfo['brand'] ?? '';
        $yahooCategory = $productInfo['yahoo_category'] ?? '';
        $price = intval($productInfo['price_jpy'] ?? 0);
        
        echo "\nüîç ÂïÜÂìÅÂàÜÊûê: {$title}\n";
        
        try {
            // 1Ô∏è‚É£ Â≠¶Áøí„Éá„Éº„Çø„Éô„Éº„ÇπÊ§úÁ¥¢
            $learned = $this->searchSimpleLearning($title, $brand, $yahooCategory);
            
            if ($learned) {
                echo "‚úÖ Â≠¶Áøí„Éá„Éº„Çø„Éô„Éº„Çπ„Éí„ÉÉ„Éà\n";
                $this->incrementUsage($learned['id']);
                
                return [
                    'success' => true,
                    'category' => [
                        'category_id' => $learned['learned_category_id'],
                        'category_name' => $learned['learned_category_name'],
                        'confidence' => $learned['confidence'],
                        'usage_count' => $learned['usage_count'] + 1
                    ],
                    'method' => 'learned_database',
                    'processing_time_ms' => round((microtime(true) - $startTime) * 1000)
                ];
            }
            
            // 2Ô∏è‚É£ Êñ∞„Åó„ÅÑÂïÜÂìÅ - Â≠¶ÁøíÂØæË±°
            echo "üìö Êñ∞ÂïÜÂìÅ - Â≠¶Áøí„Éá„Éº„Çø‰ΩúÊàê\n";
            $predicted = $this->predictAndLearn($productInfo);
            
            return [
                'success' => true,
                'category' => $predicted,
                'method' => 'predicted_and_learned',
                'processing_time_ms' => round((microtime(true) - $startTime) * 1000)
            ];
            
        } catch (Exception $e) {
            echo "‚ùå „Ç®„É©„Éº: " . $e->getMessage() . "\n";
            return [
                'success' => false,
                'error' => $e->getMessage()
            ];
        }
    }
    
    /**
     * Â≠¶Áøí„Éá„Éº„ÇøÊ§úÁ¥¢
     */
    private function searchSimpleLearning($title, $brand, $yahooCategory) {
        // ÂÆåÂÖ®‰∏ÄËá¥Ê§úÁ¥¢
        $titleHash = hash('md5', strtolower($title));
        
        $stmt = $this->pdo->prepare("
            SELECT * FROM ebay_simple_learning 
            WHERE title_hash = ? 
            ORDER BY usage_count DESC 
            LIMIT 1
        ");
        $stmt->execute([$titleHash]);
        $exact = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if ($exact) {
            echo "üéØ ÂÆåÂÖ®‰∏ÄËá¥: {$exact['learned_category_name']}\n";
            return $exact;
        }
        
        // ÈÉ®ÂàÜ‰∏ÄËá¥Ê§úÁ¥¢
        $titleWords = explode(' ', strtolower($title));
        $mainWords = array_filter($titleWords, function($word) {
            return strlen($word) >= 3;
        });
        
        if (!empty($mainWords)) {
            $likeConditions = [];
            $params = [];
            
            foreach (array_slice($mainWords, 0, 3) as $word) { // ‰∏ªË¶Å3Ë™û„ÅßÊ§úÁ¥¢
                $likeConditions[] = "LOWER(title) LIKE ?";
                $params[] = '%' . $word . '%';
            }
            
            $sql = "
                SELECT *, usage_count + success_count as score 
                FROM ebay_simple_learning 
                WHERE " . implode(' OR ', $likeConditions) . "
                ORDER BY score DESC 
                LIMIT 1
            ";
            
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute($params);
            $partial = $stmt->fetch(PDO::FETCH_ASSOC);
            
            if ($partial && $partial['score'] >= 3) {
                echo "üîç ÈÉ®ÂàÜ‰∏ÄËá¥: {$partial['learned_category_name']}\n";
                return $partial;
            }
        }
        
        return null;
    }
    
    /**
     * ‰∫àÊ∏¨„ÉªÂ≠¶Áøí
     */
    private function predictAndLearn($productInfo) {
        $title = strtolower($productInfo['title'] ?? '');
        $brand = strtolower($productInfo['brand'] ?? '');
        
        // „Ç∑„É≥„Éó„É´„Å™„É´„Éº„É´„Éô„Éº„Çπ‰∫àÊ∏¨
        $predictions = [
            // „Çπ„Éû„Éº„Éà„Éï„Ç©„É≥
            ['keywords' => ['iphone', 'android', 'smartphone', '„Çπ„Éû„Éõ', 'galaxy'], 
             'category' => ['293', 'Cell Phones & Smartphones'], 'confidence' => 90],
            
            // „Ç´„É°„É©
            ['keywords' => ['camera', 'canon', 'nikon', 'sony', '„Ç´„É°„É©', '„É¨„É≥„Ç∫'], 
             'category' => ['625', 'Cameras & Photo'], 'confidence' => 85],
            
            // „Éñ„ÉÉ„ÇØ„ÉªÊº´Áîª
            ['keywords' => ['book', 'Êú¨', 'manga', '„Éû„É≥„Ç¨', 'Êº´Áîª', 'Â∑ª'], 
             'category' => ['267', 'Books & Magazines'], 'confidence' => 80],
            
            // Êúç„Éª„Éï„Ç°„ÉÉ„Ç∑„Éß„É≥
            ['keywords' => ['shirt', 'dress', 'Êúç', 'fashion', 'clothing'], 
             'category' => ['11450', 'Clothing & Accessories'], 'confidence' => 75],
            
            // ÊôÇË®à
            ['keywords' => ['watch', 'ÊôÇË®à', 'rolex', 'omega', 'casio'], 
             'category' => ['14324', 'Watches'], 'confidence' => 80]
        ];
        
        $bestMatch = null;
        $bestScore = 0;
        
        foreach ($predictions as $prediction) {
            $score = 0;
            $matchedKeywords = [];
            
            foreach ($prediction['keywords'] as $keyword) {
                if (strpos($title, $keyword) !== false || strpos($brand, $keyword) !== false) {
                    $score += 20;
                    $matchedKeywords[] = $keyword;
                }
            }
            
            if ($score > $bestScore) {
                $bestScore = $score;
                $bestMatch = [
                    'category_id' => $prediction['category'][0],
                    'category_name' => $prediction['category'][1],
                    'confidence' => min(100, ($score / 20) * ($prediction['confidence'] / 100) * 100),
                    'matched_keywords' => $matchedKeywords
                ];
            }
        }
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        if (!$bestMatch || $bestMatch['confidence'] < 30) {
            $bestMatch = [
                'category_id' => '99999',
                'category_name' => 'Other',
                'confidence' => 25,
                'matched_keywords' => []
            ];
        }
        
        // Â≠¶Áøí„Éá„Éº„Çø„Å®„Åó„Å¶‰øùÂ≠ò
        $this->saveToLearning($productInfo, $bestMatch);
        
        echo "üí° ‰∫àÊ∏¨ÁµêÊûú: {$bestMatch['category_name']} ({$bestMatch['confidence']}%)\n";
        
        return $bestMatch;
    }
    
    /**
     * Â≠¶Áøí„Éá„Éº„Çø‰øùÂ≠ò
     */
    private function saveToLearning($productInfo, $prediction) {
        $titleHash = hash('md5', strtolower($productInfo['title'] ?? ''));
        
        $sql = "
            INSERT INTO ebay_simple_learning (
                title_hash, title, brand, yahoo_category, price_jpy,
                learned_category_id, learned_category_name, confidence,
                usage_count, success_count
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 1, 1)
            ON CONFLICT (title_hash) DO UPDATE SET
                usage_count = ebay_simple_learning.usage_count + 1
        ";
        
        $stmt = $this->pdo->prepare($sql);
        $stmt->execute([
            $titleHash,
            $productInfo['title'] ?? '',
            $productInfo['brand'] ?? '',
            $productInfo['yahoo_category'] ?? '',
            intval($productInfo['price_jpy'] ?? 0),
            $prediction['category_id'],
            $prediction['category_name'],
            $prediction['confidence']
        ]);
        
        echo "üíæ Â≠¶Áøí„Éá„Éº„Çø‰øùÂ≠òÂÆå‰∫Ü\n";
    }
    
    /**
     * ‰ΩøÁî®ÂõûÊï∞Â¢óÂä†
     */
    private function incrementUsage($learningId) {
        $sql = "UPDATE ebay_simple_learning SET usage_count = usage_count + 1 WHERE id = ?";
        $stmt = $this->pdo->prepare($sql);
        $stmt->execute([$learningId]);
    }
    
    /**
     * Â≠¶ÁøíÁä∂Ê≥ÅË°®Á§∫
     */
    public function showLearningStats() {
        try {
            $stmt = $this->pdo->query("
                SELECT 
                    COUNT(*) as total_patterns,
                    AVG(confidence) as avg_confidence,
                    SUM(usage_count) as total_usage,
                    COUNT(CASE WHEN usage_count >= 5 THEN 1 END) as mature_patterns
                FROM ebay_simple_learning
            ");
            $stats = $stmt->fetch(PDO::FETCH_ASSOC);
            
            echo "\nüìä Â≠¶Áøí„Ç∑„Çπ„ÉÜ„É†Áµ±Ë®à:\n";
            echo "  - Â≠¶Áøí„Éë„Çø„Éº„É≥Êï∞: {$stats['total_patterns']}\n";
            echo "  - Âπ≥Âùá‰ø°È†ºÂ∫¶: " . round($stats['avg_confidence'], 1) . "%\n";  
            echo "  - Á∑è‰ΩøÁî®ÂõûÊï∞: {$stats['total_usage']}\n";
            echo "  - ÊàêÁÜü„Éë„Çø„Éº„É≥Êï∞: {$stats['mature_patterns']}\n";
            
            // „Éà„ÉÉ„Éó„Éë„Çø„Éº„É≥Ë°®Á§∫
            $stmt = $this->pdo->query("
                SELECT title, learned_category_name, usage_count, confidence
                FROM ebay_simple_learning 
                ORDER BY usage_count DESC 
                LIMIT 5
            ");
            
            echo "\nüèÜ „Çà„Åè‰Ωø„Çè„Çå„Çã„Éë„Çø„Éº„É≥:\n";
            while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
                echo "  - " . substr($row['title'], 0, 30) . "... ‚Üí {$row['learned_category_name']} (‰ΩøÁî®{$row['usage_count']}Âõû)\n";
            }
            
        } catch (Exception $e) {
            echo "Áµ±Ë®àÂèñÂæó„Ç®„É©„Éº: " . $e->getMessage() . "\n";
        }
    }
}

// ÂÆüË°å„ÉÜ„Çπ„Éà
if (__FILE__ === $_SERVER['SCRIPT_FILENAME']) {
    echo "üöÄ Á∞°ÊòìÁâàÂ≠¶Áøí„Ç∑„Çπ„ÉÜ„É† „ÉÜ„Çπ„ÉàÈñãÂßã\n";
    echo "================================\n";
    
    try {
        $pdo = new PDO('pgsql:host=localhost;dbname=nagano3_db', 'aritahiroaki', '');
        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        
        $selector = new EbaySimpleLearningSelector($pdo);
        
        // „ÉÜ„Çπ„ÉàÂïÜÂìÅ
        $testProducts = [
            [
                'title' => 'iPhone 14 Pro 128GB Space Black ÁæéÂìÅ',
                'brand' => 'Apple',
                'price_jpy' => 120000,
                'yahoo_category' => 'Êê∫Â∏ØÈõªË©±'
            ],
            [
                'title' => 'Canon EOS R6 Mark II „Éü„É©„Éº„É¨„Çπ‰∏ÄÁúº',
                'brand' => 'Canon',
                'price_jpy' => 280000,
                'yahoo_category' => '„Éá„Ç∏„Çø„É´„Ç´„É°„É©'
            ],
            [
                'title' => '„ÉØ„É≥„Éî„Éº„Çπ 107Â∑ª ÊúÄÊñ∞Âàä',
                'brand' => 'ÈõÜËã±Á§æ',
                'price_jpy' => 528,
                'yahoo_category' => '„Ç≥„Éü„ÉÉ„ÇØ'
            ],
            [
                'title' => 'iPhone 15 Pro 256GB Blue Êñ∞ÂìÅ',
                'brand' => 'Apple',
                'price_jpy' => 160000,
                'yahoo_category' => 'Êê∫Â∏ØÈõªË©±'
            ]
        ];
        
        foreach ($testProducts as $i => $product) {
            echo "\n" . str_repeat("=", 50) . "\n";
            echo "„ÉÜ„Çπ„Éà " . ($i + 1) . "/4\n";
            
            $result = $selector->selectOptimalCategory($product);
            
            if ($result['success']) {
                $cat = $result['category'];
                echo "üéØ ÊúÄÁµÇÁµêÊûú:\n";
                echo "  „Ç´„ÉÜ„Ç¥„É™„Éº: {$cat['category_name']}\n";
                echo "  ‰ø°È†ºÂ∫¶: {$cat['confidence']}%\n";
                echo "  Âà§ÂÆöÊñπÊ≥ï: {$result['method']}\n";
                echo "  Âá¶ÁêÜÊôÇÈñì: {$result['processing_time_ms']}ms\n";
                
                if (isset($cat['usage_count'])) {
                    echo "  ‰ΩøÁî®ÂõûÊï∞: {$cat['usage_count']}Âõû\n";
                }
            } else {
                echo "‚ùå Âá¶ÁêÜÂ§±Êïó: {$result['error']}\n";
            }
        }
        
        // Â≠¶ÁøíÁµ±Ë®àË°®Á§∫
        echo "\n" . str_repeat("=", 50) . "\n";
        $selector->showLearningStats();
        
        echo "\nüéâ „ÉÜ„Çπ„ÉàÂÆå‰∫Ü!\n";
        echo "4ÂõûÁõÆ„ÅÆiPhone„ÉÜ„Çπ„Éà„ÅßÂ≠¶ÁøíÂäπÊûú„ÇíÁ¢∫Ë™ç„Åß„Åç„Çã„ÅØ„Åö„Åß„Åô„ÄÇ\n";
        
    } catch (Exception $e) {
        echo "‚ùå „Éá„Éº„Çø„Éô„Éº„Çπ„Ç®„É©„Éº: " . $e->getMessage() . "\n";
        echo "\nüîß Ëß£Ê±∫ÊñπÊ≥ï:\n";
        echo "1. PostgreSQLËµ∑ÂãïÁ¢∫Ë™ç: brew services start postgresql\n";
        echo "2. „Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂öÁ¢∫Ë™ç: psql -h localhost -U aritahiroaki -d nagano3_db\n";
    }
}
?>