        
        // テストクリア
        function clearTest() {
            const logContainer = document.getElementById('testLog');
            logContainer.innerHTML = '<div>[クリア完了] テスト準備完了</div>';
            addTestLog('テストログをクリアしました', 'info');
            
            // 既存のモーダルを全て削除
            const existingModals = document.querySelectorAll('div[style*="position: fixed"]');
            existingModals.forEach(modal => modal.remove());
            addTestLog('既存モーダルを削除しました', 'success');
        }
        
        // テーブルデータから商品詳細モーダル作成（editing.jsからコピー）
        function createProductDetailsModalFromTable(product) {
            addTestLog(`テーブルデータでモーダル作成: ${product.title}`, 'info');
            
            const qualityScore = 85; // デフォルト品質スコア
            const accuracyColor = '#28a745'; // 緑色
            
            // 画像URLの処理
            let imageUrl = product.picture_url || product.active_image_url || '';
            if (!imageUrl || imageUrl.includes('placehold')) {
                imageUrl = 'https://placehold.co/300x200/725CAD/FFFFFF/png?text=No+Image';
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto;
                padding: 20px; box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 900px; margin: 0 auto; position: relative;">
                    <div style="display: flex; align-items: center; justify-content: between; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1f2937;">📋 商品詳細情報 - ${product.item_id || product.id}</h3>
                        <button onclick="this.closest('div').parentElement.parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px;">×</button>
                    </div>
                    
                    <!-- テーブルデータ表示メッセージ -->
                    <div class="notification success" style="margin-bottom: 20px; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; background: #d4edda; border: 1px solid #c3e6cb; color: #155724;">
                        <i class="fas fa-table"></i>
                        <span>📊 テーブルデータから詳細表示（テスト版）</span>
                    </div>
                    
                    <!-- 精度バー -->
                    <div class="accuracy-bar" style="width: 100%; height: 30px; background: #e9ecef; border-radius: 15px; overflow: hidden; margin: 15px 0; position: relative;">
                        <div class="accuracy-fill" style="height: 100%; width: ${qualityScore}%; background: ${accuracyColor}; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 14px;">
                            ${qualityScore}%
                        </div>
                    </div>
                    
                    <!-- 基本情報 -->
                    <div class="product-basic-info" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #1f2937;">📋 基本情報</h4>
                                <p style="margin: 5px 0;"><strong>タイトル:</strong> ${product.title || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>価格:</strong> ¥${(product.current_price || product.price || 0).toLocaleString()}</p>
                                <p style="margin: 5px 0;"><strong>状態:</strong> ${product.condition_name || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>カテゴリ:</strong> ${product.category_name || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>プラットフォーム:</strong> ${product.platform || 'Yahoo'}</p>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #1f2937;">🔑 データベース情報</h4>
                                <p style="margin: 5px 0;"><strong>Item ID:</strong> ${product.item_id || product.id || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>SKU:</strong> ${product.master_sku || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>ステータス:</strong> ${product.listing_status || 'not_listed'}</p>
                                <p style="margin: 5px 0;"><strong>在庫:</strong> ${product.current_stock || '1'}</p>
                                <p style="margin: 5px 0;"><strong>更新日:</strong> ${formatDateTime(product.updated_at)}</p>
                            </div>
                        </div>
                        
                        <!-- 画像表示 -->
                        ${imageUrl && !imageUrl.includes('undefined') ? `
                        <div style="margin-top: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #1f2937;">🖼️ 商品画像</h4>
                            <div style="text-align: center;">
                                <img src="${imageUrl}" alt="商品画像" style="max-width: 300px; max-height: 200px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; cursor: pointer;" onclick="openImagePreview('${imageUrl}')" onerror="this.src='https://placehold.co/300x200/725CAD/FFFFFF/png?text=No+Image'">
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <button class="btn btn-primary" onclick="editProductModalEditing('${product.item_id || product.id}')" style="margin: 5px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-edit"></i> 詳細編集
                            </button>
                            ${product.source_url ? `
                            <button class="btn btn-info" onclick="window.open('${product.source_url}', '_blank')" style="margin: 5px; padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-external-link-alt"></i> 元ページ
                            </button>
                            ` : ''}
                            <button class="btn btn-danger" onclick="deleteProduct('${product.id || product.item_id}', '${(product.title || '').replace(/'/g, "\\'")}')">  
                                <i class="fas fa-trash"></i> 削除
                            </button>
                        </div>
                    </div>
                    
                    <!-- 詳細データ -->
                    <details style="margin-top: 20px;">
                        <summary style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 4px;"><strong>🔍 全データ表示</strong></summary>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 11px; max-height: 300px; overflow-y: auto; margin-top: 10px;">${JSON.stringify(product, null, 2)}</pre>
                    </details>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 現在の商品データをグローバルに保存（編集用）
            window.currentProductData = {
                item_id: product.item_id || product.id,
                title: product.title || '',
                current_price: product.current_price || product.price || 0,
                condition: product.condition_name || '',
                category: product.category_name || '',
                description: '',
                data_quality: qualityScore,
                scraping_method: 'Table Data'
            };
            
            addTestLog(`テーブルデータモーダル表示完了: ${product.title}`, 'success');
        }
        
        // API版モーダル作成
        function createProductDetailsModal(product) {
            addTestLog(`API版モーダル作成: ${product.title}`, 'info');
            
            const qualityScore = product.data_quality || 85;
            const accuracyColor = qualityScore >= 90 ? '#28a745' : (qualityScore >= 75 ? '#ffc107' : '#dc3545');
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto;
                padding: 20px; box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 900px; margin: 0 auto; position: relative;">
                    <div style="display: flex; align-items: center; justify-content: between; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1f2937;">📋 商品詳細情報（API版） - ${product.item_id}</h3>
                        <button onclick="this.closest('div').parentElement.parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px;">×</button>
                    </div>
                    
                    <!-- Emergency Parser 成功メッセージ -->
                    <div style="margin-bottom: 20px; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460;">
                        <i class="fas fa-check-circle"></i>
                        <span>🎉 Emergency Parser API データ表示成功！</span>
                    </div>
                    
                    <!-- 精度バー -->
                    <div style="width: 100%; height: 30px; background: #e9ecef; border-radius: 15px; overflow: hidden; margin: 15px 0; position: relative;">
                        <div style="height: 100%; width: ${qualityScore}%; background: ${accuracyColor}; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 14px;">
                            ${qualityScore}%
                        </div>
                    </div>
                    
                    <!-- 基本情報 -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin: 15px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #1f2937;">📋 基本情報</h4>
                                <p style="margin: 5px 0;"><strong>タイトル:</strong> ${product.title || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>価格:</strong> ¥${(product.current_price || 0).toLocaleString()}</p>
                                <p style="margin: 5px 0;"><strong>状態:</strong> ${product.condition || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>カテゴリ:</strong> ${product.category || 'N/A'}</p>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 10px 0; color: #1f2937;">🔑 データベース情報</h4>
                                <p style="margin: 5px 0;"><strong>Item ID:</strong> ${product.item_id || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>SKU:</strong> ${product.sku || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>ソース:</strong> ヤフオク</p>
                                <p style="margin: 5px 0;"><strong>品質スコア:</strong> ${qualityScore}%</p>
                                <p style="margin: 5px 0;"><strong>抽出方法:</strong> ${product.scraping_method || 'Emergency Parser'}</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; text-align: center;">
                            <button onclick="editProductModalEditing('${product.item_id}')" style="margin: 5px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-edit"></i> 詳細編集
                            </button>
                        </div>
                    </div>
                    
                    <!-- 詳細データ -->
                    <details style="margin-top: 20px;">
                        <summary style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 4px;"><strong>🔍 全データ表示</strong></summary>
                        <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 11px; max-height: 300px; overflow-y: auto; margin-top: 10px;">${JSON.stringify(product, null, 2)}</pre>
                    </details>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentProductData = product;
            
            addTestLog(`API版モーダル表示完了: ${product.title}`, 'success');
        }
        
        // ユーティリティ関数
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ja-JP');
            } catch (e) {
                return dateString;
            }
        }
        
        function openImagePreview(imageUrl) {
        // URLエンコードエラーを防ぐ
    if (!imageUrl || imageUrl === 'undefined' || imageUrl.includes('%7B')) {
        addTestLog('無効な画像URL: ' + imageUrl, 'error');
        return;
    }
    
    addTestLog(`画像プレビューを開く: ${imageUrl}`, 'info');
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); z-index: 10001; display: flex; 
                align-items: center; justify-content: center; cursor: pointer;
            `;
            
            modal.innerHTML = `
                <div style="position: relative; max-width: 90%; max-height: 90%;">
                    <img src="${imageUrl}" style="max-width: 100%; max-height: 100%; border-radius: 8px;" alt="商品画像">
                    <div style="position: absolute; top: -40px; right: 0; color: white; font-size: 24px; cursor: pointer;" onclick="this.closest('div').parentElement.remove()">×</div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }
        
        function editProductModalEditing(itemId) {
            addTestLog(`編集モーダル起動: ${itemId}`, 'warning');
            alert(`編集モーダル起動テスト\nItem ID: ${itemId}\n実際の編集機能は editing.php で実装済みです`);
        }
        
        function deleteProduct(productId, productTitle) {
            addTestLog(`削除機能テスト: ${productId}`, 'warning');
            alert(`削除機能テスト\nProduct ID: ${productId}\nTitle: ${productTitle}\n実際の削除機能は editing.php で実装済みです`);
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            addTestLog('モーダルテストシステム起動完了', 'success');
            addTestLog('各ボタンをクリックして機能をテストしてください', 'info');
        });
    </script>
</body>
</html>
