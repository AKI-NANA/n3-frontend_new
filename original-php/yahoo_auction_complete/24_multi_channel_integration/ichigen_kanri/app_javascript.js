
// CAIDS character_limit Hook
// CAIDS character_limit Hook - Âü∫Êú¨ÂÆüË£Ö
console.log('‚úÖ character_limit Hook loaded');

// CAIDS ajax_integration Hook
// CAIDS ajax_integration Hook - Âü∫Êú¨ÂÆüË£Ö
console.log('‚úÖ ajax_integration Hook loaded');

// CAIDS error_handling Hook

// CAIDS „Ç®„É©„ÉºÂá¶ÁêÜHook - ÂÆåÂÖ®ÂÆüË£Ö
window.CAIDS_ERROR_HANDLER = {
    isActive: true,
    errorCount: 0,
    errorHistory: [],
    
    initialize: function() {
        this.setupGlobalErrorHandler();
        this.setupUnhandledPromiseRejection();
        this.setupNetworkErrorHandler();
        console.log('‚ö†Ô∏è CAIDS „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†ÂÆåÂÖ®ÂàùÊúüÂåñ');
    },
    
    setupGlobalErrorHandler: function() {
        window.addEventListener('error', (event) => {
            this.handleError({
                type: 'JavaScript Error',
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack
            });
        });
    },
    
    setupUnhandledPromiseRejection: function() {
        window.addEventListener('unhandledrejection', (event) => {
            this.handleError({
                type: 'Unhandled Promise Rejection',
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack
            });
        });
    },
    
    setupNetworkErrorHandler: function() {
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                if (!response.ok) {
                    window.CAIDS_ERROR_HANDLER.handleError({
                        type: 'Network Error',
                        message: `HTTP ${response.status}: ${response.statusText}`,
                        url: args[0]
                    });
                }
                return response;
            } catch (error) {
                window.CAIDS_ERROR_HANDLER.handleError({
                    type: 'Network Fetch Error',
                    message: error.message,
                    url: args[0]
                });
                throw error;
            }
        };
    },
    
    handleError: function(errorInfo) {
        this.errorCount++;
        this.errorHistory.push({...errorInfo, timestamp: new Date().toISOString()});
        
        console.error('üö® CAIDS Error Handler:', errorInfo);
        this.showErrorNotification(errorInfo);
        this.reportError(errorInfo);
    },
    
    showErrorNotification: function(errorInfo) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 10px; right: 10px; z-index: 999999;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 350px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            border: 2px solid #ff6666; animation: caids-error-shake 0.5s ease-in-out;
        `;
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">üö®</span>
                <div>
                    <strong>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</strong><br>
                    <small style="opacity: 0.9;">${errorInfo.type}: ${errorInfo.message}</small>
                </div>
            </div>
        `;
        
        // CSS Animation
        if (!document.getElementById('caids-error-styles')) {
            const style = document.createElement('style');
            style.id = 'caids-error-styles';
            style.textContent = `
                @keyframes caids-error-shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 7000);
    },
    
    reportError: function(errorInfo) {
        // „Ç®„É©„Éº„É¨„Éù„Éº„ÉàÁîüÊàê„ÉªÈÄÅ‰ø°ÔºàÂ∞ÜÊù•„ÅÆÊã°ÂºµÁî®Ôºâ
        const report = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            errorCount: this.errorCount,
            sessionId: this.getSessionId(),
            ...errorInfo
        };
        
        console.log('üìã CAIDS Error Report:', report);
        localStorage.setItem('caids_last_error', JSON.stringify(report));
    },
    
    getSessionId: function() {
        let sessionId = sessionStorage.getItem('caids_session_id');
        if (!sessionId) {
            sessionId = 'caids_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('caids_session_id', sessionId);
        }
        return sessionId;
    },
    
    getErrorStats: function() {
        return {
            totalErrors: this.errorCount,
            recentErrors: this.errorHistory.slice(-10),
            sessionId: this.getSessionId()
        };
    }
};

window.CAIDS_ERROR_HANDLER.initialize();

/**
 * Emverze SaaS - ÂÖ±ÈÄöJavaScript„É©„Ç§„Éñ„É©„É™
 * ÂÖ®„Éö„Éº„Ç∏„Åß‰ΩøÁî®„Åï„Çå„ÇãÂÖ±ÈÄöÊ©üËÉΩ„ÇíÊèê‰æõ
 */

(function() {
    'use strict';

    // EmverzeAppÂêçÂâçÁ©∫Èñì
    window.EmverzeApp = {
        // Ë®≠ÂÆö
        config: {
            apiBaseUrl: '/api/v1',
            csrfToken: document.querySelector('meta[name="csrf-token"]')?.content,
            debug: false
        },

        // ÂàùÊúüÂåñ
        init: function() {
            this.setupCSRF();
            this.setupErrorHandling();
            this.setupFormValidation();
            this.setupModals();
            this.setupTooltips();
            this.setupConfirmDialogs();

            if (this.config.debug) {
                console.log('EmverzeApp initialized');
            }
        },

        // CSRFË®≠ÂÆöÔºàÂøÖÈ†àÔºâ
        setupCSRF: function() {
            // fetch API„ÅÆCSRFË®≠ÂÆö
            const originalFetch = window.fetch;
            window.fetch = function(url, options = {}) {
                if (EmverzeApp.config.csrfToken) {
                    options.headers = options.headers || {};
                    options.headers['X-CSRFToken'] = EmverzeApp.config.csrfToken;
                }
                return originalFetch(url, options);
            };
        },

        // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞Ë®≠ÂÆöÔºàÂøÖÈ†àÔºâ
        setupErrorHandling: function() {
            // „Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº„Éè„É≥„Éâ„É©„Éº
            window.addEventListener('error', function(e) {
                EmverzeApp.logError('JavaScript Error', e.error);
            });

            // PromiseÊãíÂê¶„Éè„É≥„Éâ„É©„Éº
            window.addEventListener('unhandledrejection', function(e) {
                EmverzeApp.logError('Unhandled Promise Rejection', e.reason);
            });
        },

        // „Éï„Ç©„Éº„É†„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Ë®≠ÂÆöÔºàÂøÖÈ†àÔºâ
        setupFormValidation: function() {
            document.addEventListener('submit', function(e) {
                const form = e.target;
                if (form.tagName !== 'FORM') return;

                // „Ç´„Çπ„Çø„É†„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
                const isValid = EmverzeApp.validateForm(form);
                if (!isValid) {
                    e.preventDefault();
                    return false;
                }

                // ‰∫åÈáçÈÄÅ‰ø°Èò≤Ê≠¢
                const submitBtn = form.querySelector('button[type="submit"]');
                if (submitBtn && !submitBtn.disabled) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Âá¶ÁêÜ‰∏≠...';

                    // 3ÁßíÂæå„Å´ÂÜçÊúâÂäπÂåñÔºà„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÂØæÁ≠ñÔºâ
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.textContent = submitBtn.dataset.originalText || 'ÈÄÅ‰ø°';
                    }, 3000);
                }
            });
        },

        // „Éï„Ç©„Éº„É†„Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÂÆüË°å
        validateForm: function(form) {
            let isValid = true;

            // ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    this.showFieldError(field, '„Åì„ÅÆÈ†ÖÁõÆ„ÅØÂøÖÈ†à„Åß„Åô');
                    isValid = false;
                } else {
                    this.clearFieldError(field);
                }
            });

            // „É°„Éº„É´„Éï„Ç£„Éº„É´„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
            const emailFields = form.querySelectorAll('input[type="email"]');
            emailFields.forEach(field => {
                if (field.value && !this.isValidEmail(field.value)) {
                    this.showFieldError(field, 'ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    isValid = false;
                }
            });

            return isValid;
        },

        // „Éï„Ç£„Éº„É´„Éâ„Ç®„É©„ÉºË°®Á§∫
        showFieldError: function(field, message) {
            field.classList.add('form-control--error');

            // Êó¢Â≠ò„ÅÆ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§
            const existingError = field.parentNode.querySelector('.form-error');
            if (existingError) {
                existingError.remove();
            }

            // Êñ∞„Åó„ÅÑ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
            const errorElement = document.createElement('span');
            errorElement.className = 'form-error';
            errorElement.textContent = message;
            field.parentNode.appendChild(errorElement);
        },

        // „Éï„Ç£„Éº„É´„Éâ„Ç®„É©„Éº„ÇØ„É™„Ç¢
        clearFieldError: function(field) {
            field.classList.remove('form-control--error');
            const errorElement = field.parentNode.querySelector('.form-error');
            if (errorElement) {
                errorElement.remove();
            }
        },

        // „É°„Éº„É´„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
        isValidEmail: function(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        },

        // „É¢„Éº„ÉÄ„É´Ë®≠ÂÆö
        setupModals: function() {
            // „É¢„Éº„ÉÄ„É´Èñã„Åè
            document.addEventListener('click', function(e) {
                if (e.target.matches('[data-modal-target]')) {
                    e.preventDefault();
                    const modalId = e.target.dataset.modalTarget;
                    EmverzeApp.openModal(modalId);
                }
            });

            // „É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã
            document.addEventListener('click', function(e) {
                if (e.target.matches('[data-modal-close]') || e.target.matches('.modal-backdrop')) {
                    EmverzeApp.closeModal();
                }
            });

            // ESC„Ç≠„Éº„Åß„É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    EmverzeApp.closeModal();
                }
            });
        },

        // „É¢„Éº„ÉÄ„É´Èñã„Åè
        openModal: function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                document.body.classList.add('modal-open');
            }
        },

        // „É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã
        closeModal: function() {
            const activeModal = document.querySelector('.modal.show');
            if (activeModal) {
                activeModal.classList.remove('show');
                document.body.classList.remove('modal-open');
            }
        },

        // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞Ë®≠ÂÆö
        setupConfirmDialogs: function() {
            document.addEventListener('click', function(e) {
                if (e.target.matches('[data-confirm]')) {
                    const message = e.target.dataset.confirm;
                    if (!confirm(message)) {
                        e.preventDefault();
                        return false;
                    }
                }
            });
        },

        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóË®≠ÂÆö
        setupTooltips: function() {
            // Á∞°Êòì„ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÂÆüË£Ö
            document.addEventListener('mouseenter', function(e) {
                if (e.target.matches('[data-tooltip]')) {
                    EmverzeApp.showTooltip(e.target);
                }
            });

            document.addEventListener('mouseleave', function(e) {
                if (e.target.matches('[data-tooltip]')) {
                    EmverzeApp.hideTooltip();
                }
            });
        },

        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóË°®Á§∫
        showTooltip: function(element) {
            const tooltipText = element.dataset.tooltip;
            if (!tooltipText) return;

            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = tooltipText;
            tooltip.id = 'active-tooltip';

            document.body.appendChild(tooltip);

            // ‰ΩçÁΩÆË™øÊï¥
            const rect = element.getBoundingClientRect();
            tooltip.style.position = 'absolute';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + 'px';
            tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
        },

        // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÈùûË°®Á§∫
        hideTooltip: function() {
            const tooltip = document.getElementById('active-tooltip');
            if (tooltip) {
                tooltip.remove();
            }
        },

        // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        showSuccess: function(message) {
            this.showToast(message, 'success');
        },

        // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        showError: function(message) {
            this.showToast(message, 'error');
        },

        // Ë≠¶Âëä„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        showWarning: function(message) {
            this.showToast(message, 'warning');
        },

        // ÊÉÖÂ†±„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        showInfo: function(message) {
            this.showToast(message, 'info');
        },

        // ÈÄöÁü•Ë°®Á§∫Ôºà„Éö„Éº„Ç∏Ê®™Êñ≠„Åß‰ΩøÁî®„Åï„Çå„Çã‰∏≠Ê†∏Ê©üËÉΩÔºâ
        showToast: function(message, type = 'info') {
            // Êó¢Â≠ò„ÅÆÈÄöÁü•„Çí„ÇØ„É™„Ç¢
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // „Éà„Éº„Çπ„Éà„Ç≥„É≥„ÉÜ„Éä„ÇíÁ¢∫Ë™ç„Éª‰ΩúÊàê
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }

            // Êñ∞„Åó„ÅÑÈÄöÁü•„Çí‰ΩúÊàê
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-message">${message}</span>
                <button class="toast-close" type="button">&times;</button>
            `;

            // ÈÄöÁü•„Çí„Éö„Éº„Ç∏„Å´ËøΩÂä†
            container.appendChild(toast);

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë°®Á§∫
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // Èñâ„Åò„Çã„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
            const closeBtn = toast.querySelector('.toast-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                });
            }

            // Ëá™ÂãïÁöÑ„Å´5ÁßíÂæå„Å´Èñâ„Åò„Çã
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, 5000);
        },

        // „Ç®„É©„Éº„É≠„Ç∞
        logError: function(type, error) {
            if (this.config.debug) {
                console.error(`[${type}]`, error);
            }

            // Êú¨Áï™Áí∞Â¢É„Åß„ÅØÂ§ñÈÉ®„É≠„Ç∞„Çµ„Éº„Éì„Çπ„Å´ÈÄÅ‰ø°
            if (!this.config.debug && window.location.hostname !== 'localhost') {
                // „Åì„ÅÆÈÉ®ÂàÜ„ÅßÂ§ñÈÉ®„É≠„Ç∞„Çµ„Éº„Éì„ÇπÔºàSentryÁ≠âÔºâ„Å´ÈÄÅ‰ø°
            }
        },

        // APIÂëº„Å≥Âá∫„Åó„Éò„É´„Éë„Éº
        api: {
            get: function(endpoint) {
                return EmverzeApp.request('GET', endpoint);
            },

            post: function(endpoint, data) {
                return EmverzeApp.request('POST', endpoint, data);
            },

            put: function(endpoint, data) {
                return EmverzeApp.request('PUT', endpoint, data);
            },

            delete: function(endpoint) {
                return EmverzeApp.request('DELETE', endpoint);
            }
        },

        // HTTP „É™„ÇØ„Ç®„Çπ„Éà
        request: function(method, endpoint, data = null) {
            const url = this.config.apiBaseUrl + endpoint;
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.config.csrfToken
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            return fetch(url, options)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    this.logError('API Request Error', error);
                    throw error;
                });
        },

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        utils: {
            // Êï∞ÂÄ§„Éï„Ç©„Éº„Éû„ÉÉ„Éà
            formatNumber: function(num, decimals = 0) {
                return new Intl.NumberFormat('ja-JP', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                }).format(num);
            },

            // ÈÄöË≤®„Éï„Ç©„Éº„Éû„ÉÉ„Éà
            formatCurrency: function(amount, currency = 'JPY') {
                return new Intl.NumberFormat('ja-JP', {
                    style: 'currency',
                    currency: currency
                }).format(amount);
            },

            // Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„Éà
            formatDate: function(date, options = {}) {
                const defaultOptions = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                };
                return new Intl.DateTimeFormat('ja-JP', { ...defaultOptions, ...options }).format(new Date(date));
            },

            // Áõ∏ÂØæÊôÇÈñì„Éï„Ç©„Éº„Éû„ÉÉ„Éà
            formatRelativeTime: function(date) {
                const now = new Date();
                const targetDate = new Date(date);
                const diffMs = now - targetDate;
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                if (diffMinutes < 1) {
                    return '„Åü„Å£„Åü‰ªä';
                } else if (diffMinutes < 60) {
                    return `${diffMinutes}ÂàÜÂâç`;
                } else if (diffHours < 24) {
                    return `${diffHours}ÊôÇÈñìÂâç`;
                } else if (diffDays < 7) {
                    return `${diffDays}Êó•Ââç`;
                } else {
                    return this.formatDate(date);
                }
            },

            // ÊñáÂ≠óÂàóÁúÅÁï•
            truncate: function(str, length = 50) {
                if (str.length <= length) return str;
                return str.substring(0, length) + '...';
            },

            // „É©„É≥„ÉÄ„É†IDÁîüÊàê
            generateId: function(prefix = 'id') {
                return prefix + '_' + Math.random().toString(36).substr(2, 9);
            }
        }
    };

    // DOMContentLoadedÊôÇ„Å´ÂàùÊúüÂåñ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            EmverzeApp.init();
        });
    } else {
        EmverzeApp.init();
    }

})();