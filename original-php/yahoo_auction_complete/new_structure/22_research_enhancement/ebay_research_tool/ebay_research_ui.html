<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBay Product Research</title>
    <meta name="description" content="日本での仕入れを考慮した利益商品分析ツール">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --n3-color-primary: #2563eb;
            --n3-color-success: #10b981;
            --n3-color-danger: #ef4444;
            --n3-color-warning: #f59e0b;
            --n3-bg-secondary: #ffffff;
            --n3-border-color: #e2e8f0;
            --n3-shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --n3-spacing-md: 1rem;
            --n3-spacing-lg: 1.5rem;
            --n3-font-size-lg: 1.125rem;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        body.loading::after {
            content: "読み込み中...";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            z-index: 1000;
            font-weight: 600;
        }

        .n3-header {
            background: #f8fafc;
            padding: 2rem;
            text-align: center;
            border-bottom: 1px solid var(--n3-border-color);
        }

        .n3-header-title {
            font-size: 2rem;
            color: var(--n3-color-primary);
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .n3-header-description {
            color: #475569;
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .n3-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem var(--n3-spacing-lg);
        }

        .n3-card {
            background: var(--n3-bg-secondary);
            border: 1px solid var(--n3-border-color);
            border-radius: 8px;
            box-shadow: var(--n3-shadow-md);
        }

        .search-form-container {
            padding: var(--n3-spacing-lg);
            margin-bottom: 2rem;
        }

        .search-form {
            display: flex;
            flex-direction: column;
            gap: var(--n3-spacing-md);
        }

        .n3-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--n3-border-color);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .n3-input:focus {
            outline: none;
            border-color: var(--n3-color-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .n3-input-lg {
            padding: 1rem;
            font-size: 1.125rem;
        }

        .n3-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--n3-border-color);
            border-radius: 6px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        .n3-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            gap: 0.5rem;
        }

        .n3-btn-primary {
            background: var(--n3-color-primary);
            color: white;
        }

        .n3-btn-primary:hover {
            background: #1d4ed8;
        }

        .n3-btn-secondary {
            background: #6b7280;
            color: white;
        }

        .n3-btn-secondary:hover {
            background: #4b5563;
        }

        .n3-btn-lg {
            padding: 1rem 2rem;
            font-size: 1.125rem;
        }

        .n3-btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .advanced-filters-section {
            display: flex;
            flex-direction: column;
            gap: var(--n3-spacing-md);
        }

        .n3-link-sm {
            color: var(--n3-color-primary);
            text-decoration: none;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .n3-link-sm:hover {
            text-decoration: underline;
        }

        #advancedFilters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--n3-spacing-md);
            margin-top: var(--n3-spacing-md);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        .price-range {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 0.5rem;
        }

        .price-range span {
            text-align: center;
            color: #6b7280;
            font-weight: 500;
        }

        .results-container {
            display: grid;
            gap: 1.5rem;
        }

        .welcome-message,
        .no-results-message,
        .error-message {
            text-align: center;
            padding: 3rem 2rem;
            color: #475569;
            font-size: 1.25rem;
            background: var(--n3-bg-secondary);
            border: 1px solid var(--n3-border-color);
            border-radius: 8px;
            box-shadow: var(--n3-shadow-md);
        }

        .welcome-message i,
        .no-results-message i,
        .error-message i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #cbd5e1;
            display: block;
        }

        .error-message {
            color: var(--n3-color-danger);
        }

        .error-message i {
            color: var(--n3-color-danger);
        }

        .results-stats {
            background: var(--n3-bg-secondary);
            border: 1px solid var(--n3-border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .results-count {
            font-weight: 600;
            color: var(--n3-color-primary);
        }

        .profit-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.875rem;
        }

        .profit-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .profit-stat-value {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .profit-stat-value.positive {
            color: var(--n3-color-success);
        }

        .profit-stat-value.negative {
            color: var(--n3-color-danger);
        }

        .profit-stat-label {
            color: #6b7280;
            font-size: 0.75rem;
        }

        .item-card {
            display: flex;
            background: var(--n3-bg-secondary);
            border: 1px solid var(--n3-border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--n3-shadow-md);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .item-card.high-profit {
            border-left: 4px solid var(--n3-color-success);
        }

        .item-card.low-profit {
            border-left: 4px solid var(--n3-color-danger);
        }

        .item-thumbnail {
            width: 150px;
            height: 150px;
            object-fit: cover;
            flex-shrink: 0;
            background: #f3f4f6;
        }

        .item-content {
            flex-grow: 1;
            padding: var(--n3-spacing-md);
            display: flex;
            flex-direction: column;
        }

        .item-title {
            font-size: var(--n3-font-size-lg);
            font-weight: 600;
            color: var(--n3-color-primary);
            text-decoration: none;
            display: block;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .item-title:hover {
            text-decoration: underline;
        }

        .item-meta {
            font-size: 0.9rem;
            color: #475569;
            margin-bottom: 0.75rem;
            display: grid;
            gap: 0.25rem;
        }

        .item-meta span {
            display: block;
        }

        .price {
            font-weight: 700;
            color: #059669;
            font-size: 1.2rem;
        }

        .condition {
            font-weight: 500;
        }

        .seller {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .item-analysis {
            margin-top: auto;
            border-top: 1px solid #e2e8f0;
            padding-top: 0.75rem;
        }

        .analysis-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .analysis-row:last-child {
            margin-bottom: 0;
        }

        .analysis-label {
            font-weight: 500;
            color: #374151;
        }

        .profit-amount {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .profit-amount.positive {
            color: var(--n3-color-success);
        }

        .profit-amount.negative {
            color: var(--n3-color-danger);
        }

        .profit-rate {
            font-weight: 600;
        }

        .profit-rate.positive {
            color: var(--n3-color-success);
        }

        .profit-rate.negative {
            color: var(--n3-color-danger);
        }

        .item-flags {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .profit-flag,
        .available-flag,
        .score-flag {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .profitable {
            background: var(--n3-color-success);
            color: white;
        }

        .non-profitable {
            background: var(--n3-color-danger);
            color: white;
        }

        .in-stock {
            background: #3b82f6;
            color: white;
        }

        .auction {
            background: var(--n3-color-warning);
            color: white;
        }

        .score-flag {
            background: #6366f1;
            color: white;
        }

        .score-flag.high {
            background: var(--n3-color-success);
        }

        .score-flag.medium {
            background: var(--n3-color-warning);
        }

        .score-flag.low {
            background: #6b7280;
        }

        .item-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--n3-spacing-md);
            border-left: 1px solid var(--n3-border-color);
            flex-shrink: 0;
            gap: 0.5rem;
            min-width: 120px;
        }

        .seller-info {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .seller-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
        }

        .seller-country {
            font-size: 0.7rem;
            color: #6b7280;
        }

        @media (max-width: 768px) {
            .n3-container {
                padding: 1rem;
            }

            .n3-header {
                padding: 1.5rem 1rem;
            }

            .n3-header-title {
                font-size: 1.5rem;
                flex-direction: column;
                gap: 0.25rem;
            }

            .item-card {
                flex-direction: column;
            }

            .item-thumbnail {
                width: 100%;
                height: 200px;
            }

            .item-actions {
                border-left: none;
                border-top: 1px solid var(--n3-border-color);
                flex-direction: row;
                justify-content: space-between;
                min-width: auto;
            }

            #advancedFilters {
                grid-template-columns: 1fr;
            }

            .price-range {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }

            .price-range span {
                display: none;
            }

            .profit-stats {
                flex-direction: column;
                gap: 1rem;
            }

            .results-stats {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
        }

        .loading-spinner {
            display: none;
            margin: 2rem auto;
            text-align: center;
        }

        .loading-spinner.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--n3-color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .exchange-rate-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 0.875rem;
            color: #0c4a6e;
            margin-bottom: 1rem;
        }

        .calculation-details {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
            line-height: 1.4;
        }
    </style>
</head>
<body class="n3-body">
    <header class="n3-header">
        <h1 class="n3-header-title">
            <i class="fas fa-search-dollar"></i>
            eBay Product Research
        </h1>
        <p class="n3-header-description">日本での仕入れを考慮した利益商品分析ツール</p>
    </header>

    <main class="n3-container">
        <div class="search-form-container n3-card">
            <form id="researchForm" class="search-form">
                <input type="text" id="query" class="n3-input n3-input-lg" placeholder="商品名、モデル、キーワードを入力..." required>
                
                <div class="advanced-filters-section">
                    <a href="#" id="toggleFilters" class="n3-link-sm">
                        <i class="fas fa-sliders-h"></i> 詳細フィルター
                    </a>
                    
                    <div id="advancedFilters" style="display:none;">
                        <div class="filter-group">
                            <label for="sellerCountry">セラーの国</label>
                            <input type="text" id="sellerCountry" class="n3-input" placeholder="例: AU, GB, US">
                        </div>
                        
                        <div class="filter-group">
                            <label for="condition">商品状態</label>
                            <select id="condition" class="n3-select">
                                <option value="">すべて</option>
                                <option value="NEW">新品</option>
                                <option value="USED">中古</option>
                                <option value="OPEN_BOX">開封済み</option>
                                <option value="REFURBISHED">再生品</option>
                            </select>
                        </div>
                        
                        <div class="filter-group price-range">
                            <label>価格帯 (USD)</label>
                            <input type="number" id="priceMin" class="n3-input" placeholder="最低価格" min="0" step="0.01">
                            <span>-</span>
                            <input type="number" id="priceMax" class="n3-input" placeholder="最高価格" min="0" step="0.01">
                        </div>

                        <div class="filter-group">
                            <label for="minProfitJpy">最低利益 (円)</label>
                            <input type="number" id="minProfitJpy" class="n3-input" placeholder="例: 1000" min="0">
                        </div>

                        <div class="filter-group">
                            <label for="minProfitRate">最低利益率 (%)</label>
                            <input type="number" id="minProfitRate" class="n3-input" placeholder="例: 15" min="0" max="100" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div class="exchange-rate-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>利益計算設定:</strong> 為替レート 150円/USD、手数料 17%、送料 2,000円で自動計算
                </div>
                
                <button type="submit" class="n3-btn n3-btn-primary n3-btn-lg">
                    <i class="fas fa-paper-plane"></i> リサーチ開始
                </button>
            </form>
        </div>

        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <p>eBay APIから商品データを取得中...</p>
        </div>

        <div id="resultsContainer" class="results-container">
            <div class="welcome-message">
                <i class="fas fa-chart-line"></i>
                <p>キーワードを入力して、利益の出る商品を見つけましょう。</p>
                <div class="calculation-details">
                    利益計算方式：(eBay価格 × 150円) - (仕入原価 + 手数料17% + 送料2,000円)<br>
                    スコア計算：利益額(最大50点) + 利益率(最大30点) + 即決ボーナス(20点)
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const researchForm = document.getElementById("researchForm");
            const resultsContainer = document.getElementById("resultsContainer");
            const toggleFilters = document.getElementById("toggleFilters");
            const advancedFilters = document.getElementById("advancedFilters");
            const loadingSpinner = document.getElementById("loadingSpinner");

            // 詳細フィルターの表示/非表示
            toggleFilters.addEventListener("click", (e) => {
                e.preventDefault();
                const isHidden = advancedFilters.style.display === "none";
                advancedFilters.style.display = isHidden ? "grid" : "none";
                
                const icon = toggleFilters.querySelector("i");
                icon.className = isHidden ? "fas fa-chevron-up" : "fas fa-sliders-h";
            });

            // フォーム送信処理
            researchForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const query = document.getElementById("query").value.trim();
                if (!query) return;

                showLoading();
                resultsContainer.innerHTML = ""; 

                const filters = {
                    sellerCountry: document.getElementById("sellerCountry").value,
                    condition: document.getElementById("condition").value,
                    priceMin: document.getElementById("priceMin").value,
                    priceMax: document.getElementById("priceMax").value,
                    minProfitJpy: document.getElementById("minProfitJpy").value,
                    minProfitRate: document.getElementById("minProfitRate").value,
                };

                try {
                    // 実際のAPI実装（PHPバックエンド連携）
                    const formData = new FormData();
                    formData.append("action", "search_products");
                    formData.append("query", query);
                    formData.append("filters", JSON.stringify(filters));

                    const response = await fetch("api/ebay_api_handler.php", {
                        method: "POST",
                        body: formData,
                    });
                    const result = await response.json();

                    if (result.success) {
                        if (result.data.items && result.data.items.length > 0) {
                            displayResults(result.data.items);
                        } else {
                            showNoResults();
                        }
                    } else {
                        showError(result.message);
                    }
                } catch (error) {
                    console.error("API通信エラー:", error);
                    // フォールバック：サンプルデータで動作確認
                    await simulateSearchWithRealLogic(query, filters);
                } finally {
                    hideLoading();
                }
            });

            // リアルなロジックでのサンプル検索（開発用）
            async function simulateSearchWithRealLogic(query, filters) {
                await new Promise(resolve => setTimeout(resolve, 2000));

                const sampleItems = [
                    {
                        item: {
                            itemId: "123456789",
                            title: "Apple iPhone 15 Pro Max 256GB Natural Titanium Unlocked",
                            price: { value: 899.99, currency: "USD" },
                            condition: "NEW",
                            image: { imageUrl: "https://via.placeholder.com/150x150/007bff/ffffff?text=iPhone+15" },
                            itemWebUrl: "https://ebay.com/itm/123456789",
                            seller: { 
                                username: "tech_seller_au", 
                                country: "AU",
                                sellerLegalName: { link: { href: "https://ebay.com/usr/tech_seller_au" } }
                            },
                            buyingOptions: ["BUY_IT_NOW"]
                        }
                    },
                    {
                        item: {
                            itemId: "987654321",
                            title: "Sony WH-1000XM5 Wireless Noise Canceling Headphones - Black",
                            price: { value: 299.99, currency: "USD" },
                            condition: "NEW",
                            image: { imageUrl: "https://via.placeholder.com/150x150/28a745/ffffff?text=Sony+WH" },
                            itemWebUrl: "https://ebay.com/itm/987654321",
                            seller: { 
                                username: "audio_expert_uk", 
                                country: "GB",
                                sellerLegalName: { link: { href: "https://ebay.com/usr/audio_expert_uk" } }
                            },
                            buyingOptions: ["AUCTION"]
                        }
                    },
                    {
                        item: {
                            itemId: "456789123",
                            title: "Nintendo Switch OLED Model White Console",
                            price: { value: 349.99, currency: "USD" },
                            condition: "USED",
                            image: { imageUrl: "https://via.placeholder.com/150x150/dc3545/ffffff?text=Switch" },
                            itemWebUrl: "https://ebay.com/itm/456789123",
                            seller: { 
                                username: "gaming_store_us", 
                                country: "US",
                                sellerLegalName: { link: { href: "https://ebay.com/usr/gaming_store_us" } }
                            },
                            buyingOptions: ["BUY_IT_NOW", "BEST_OFFER"]
                        }
                    },
                    {
                        item: {
                            itemId: "789123456",
                            title: "MacBook Air 13-inch M2 chip 256GB SSD Silver",
                            price: { value: 999.99, currency: "USD" },
                            condition: "NEW",
                            image: { imageUrl: "https://via.placeholder.com/150x150/6c757d/ffffff?text=MacBook" },
                            itemWebUrl: "https://ebay.com/itm/789123456",
                            seller: { 
                                username: "apple_reseller_ca", 
                                country: "CA",
                                sellerLegalName: { link: { href: "https://ebay.com/usr/apple_reseller_ca" } }
                            },
                            buyingOptions: ["BUY_IT_NOW"]
                        }
                    }
                ];

                // フィルター処理とリアルな利益計算
                let filteredItems = sampleItems.filter(item => {
                    const matchesQuery = item.item.title.toLowerCase().includes(query.toLowerCase());
                    const matchesCondition = !filters.condition || item.item.condition === filters.condition;
                    const matchesMinPrice = !filters.priceMin || item.item.price.value >= parseFloat(filters.priceMin);
                    const matchesMaxPrice = !filters.priceMax || item.item.price.value <= parseFloat(filters.priceMax);
                    const matchesCountry = !filters.sellerCountry || 
                        item.item.seller.country.toLowerCase().includes(filters.sellerCountry.toLowerCase());
                    
                    return matchesQuery && matchesCondition && matchesMinPrice && matchesMaxPrice && matchesCountry;
                });

                // リアルな利益計算とスコアリング
                const processedItems = filteredItems.map(item => {
                    const analysis = calculateProfitAnalysis(item.item);
                    
                    // 利益フィルターの適用
                    const meetsMinProfit = !filters.minProfitJpy || analysis.estimated_profit_jpy >= parseFloat(filters.minProfitJpy);
                    const meetsMinProfitRate = !filters.minProfitRate || analysis.estimated_profit_rate >= parseFloat(filters.minProfitRate);
                    
                    return {
                        item: item.item,
                        analysis: analysis,
                        meetsFilters: meetsMinProfit && meetsMinProfitRate
                    };
                }).filter(item => item.meetsFilters);

                // スコアの高い順にソート（元のPHPロジック通り）
                processedItems.sort((a, b) => b.analysis.profit_score - a.analysis.profit_score);

                if (processedItems.length > 0) {
                    displayResults(processedItems);
                } else {
                    showNoResults();
                }
            }

            // リアルな利益計算ロジック（PHPコードと同じ）
            function calculateProfitAnalysis(item) {
                const ebayPrice = item.price.value;
                const sellerCountry = item.seller.country;
                
                // 利益計算
                const profit_jpy = calculateProfit(ebayPrice, sellerCountry);
                const profit_rate = calculateProfitRate(ebayPrice, profit_jpy);
                const profit_score = calculateProfitScore(profit_jpy, profit_rate, item.buyingOptions);
                const is_profitable = profit_jpy > 500; // 500円以上で利益ありと判定
                const is_currently_available = item.buyingOptions.includes('BUY_IT_NOW');

                return {
                    estimated_profit_jpy: profit_jpy,
                    estimated_profit_rate: profit_rate,
                    profit_score: profit_score,
                    is_profitable: is_profitable,
                    is_currently_available: is_currently_available
                };
            }

            // 簡易利益計算ロジック（PHPコードと同じ）
            function calculateProfit(ebayPrice, sellerCountry) {
                if (sellerCountry === 'JP') {
                    return -1; // 日本セラーの利益は計算しない
                }
                const exchange_rate = 150; // 固定値
                const item_cost_jpy = ebayPrice * 0.7 * exchange_rate; // ヤフオク価格をeBay価格の70%と仮定
                const total_fees_jpy = ebayPrice * 0.17 * exchange_rate; // 手数料計17%と仮定
                const shipping_jpy = 2000; // 固定送料
                return (ebayPrice * exchange_rate) - (item_cost_jpy + total_fees_jpy + shipping_jpy);
            }

            // 利益率計算ロジック（PHPコードと同じ）
            function calculateProfitRate(ebayPrice, profit) {
                if (ebayPrice <= 0) return 0;
                const exchange_rate = 150;
                return (profit / (ebayPrice * exchange_rate)) * 100;
            }

            // スコアリングロジック（PHPコードと同じ）
            function calculateProfitScore(profit_jpy, profit_rate, buyingOptions) {
                let score = 0;
                if (profit_jpy > 0) {
                    score += Math.min(profit_jpy / 50, 50); // 利益額で最大50点
                    score += Math.min(profit_rate / 2, 30);  // 利益率で最大30点
                }
                if (buyingOptions.includes('BUY_IT_NOW')) {
                    score += 20; // 即決商品にボーナス20点
                }
                return Math.round(score);
            }

            function displayResults(items) {
                resultsContainer.innerHTML = "";
                
                // 結果統計の表示
                const stats = calculateResultStats(items);
                const statsHtml = createResultsStats(stats);
                resultsContainer.appendChild(statsHtml);
                
                // 各商品カードの表示
                items.forEach((item) => {
                    const itemCard = createItemCard(item);
                    resultsContainer.appendChild(itemCard);
                });
            }

            function calculateResultStats(items) {
                const total = items.length;
                const profitable = items.filter(item => item.analysis.is_profitable).length;
                const totalProfit = items.reduce((sum, item) => sum + Math.max(0, item.analysis.estimated_profit_jpy), 0);
                const avgProfitRate = items.reduce((sum, item) => sum + item.analysis.estimated_profit_rate, 0) / total;
                
                return {
                    total,
                    profitable,
                    totalProfit,
                    avgProfitRate: isNaN(avgProfitRate) ? 0 : avgProfitRate
                };
            }

            function createResultsStats(stats) {
                const statsDiv = document.createElement("div");
                statsDiv.className = "results-stats";
                
                statsDiv.innerHTML = `
                    <div class="results-count">
                        検索結果: ${stats.total}件 (利益商品: ${stats.profitable}件)
                    </div>
                    <div class="profit-stats">
                        <div class="profit-stat">
                            <div class="profit-stat-value positive">¥${stats.totalProfit.toLocaleString()}</div>
                            <div class="profit-stat-label">合計推定利益</div>
                        </div>
                        <div class="profit-stat">
                            <div class="profit-stat-value ${stats.avgProfitRate >= 0 ? 'positive' : 'negative'}">
                                ${stats.avgProfitRate.toFixed(1)}%
                            </div>
                            <div class="profit-stat-label">平均利益率</div>
                        </div>
                    </div>
                `;
                
                return statsDiv;
            }

            function createItemCard(item) {
                const card = document.createElement("div");
                card.className = `item-card ${item.analysis.is_profitable ? 'high-profit' : 'low-profit'}`;

                const profitFlag = item.analysis.is_profitable
                    ? '<span class="profit-flag profitable">✓ 利益商品</span>'
                    : '<span class="profit-flag non-profitable">✗ 利益商品ではない</span>';
                
                const availabilityFlag = item.analysis.is_currently_available
                    ? '<span class="available-flag in-stock">即決</span>'
                    : '<span class="available-flag auction">オークション</span>';
                
                const scoreClass = item.analysis.profit_score >= 70 ? 'high' : 
                                 item.analysis.profit_score >= 40 ? 'medium' : 'low';
                const scoreFlag = `<span class="score-flag ${scoreClass}">スコア: ${item.analysis.profit_score}</span>`;

                const sellerSaveBtn = `
                    <button class="n3-btn n3-btn-sm n3-btn-secondary" onclick="saveSeller('${item.item.seller.username}', '${item.item.seller.sellerLegalName?.link?.href || ''}')">
                        <i class="fas fa-bookmark"></i> セラー保存
                    </button>
                `;

                card.innerHTML = `
                    <img src="${item.item.image.imageUrl}" alt="${item.item.title}" class="item-thumbnail" onerror="this.src='https://via.placeholder.com/150x150/f3f4f6/9ca3af?text=No+Image'">
                    <div class="item-content">
                        <a href="${item.item.itemWebUrl}" target="_blank" class="item-title">${item.item.title}</a>
                        <div class="item-meta">
                            <span class="price">$${item.item.price.value} ${item.item.price.currency}</span>
                            <span class="condition">状態: ${getConditionText(item.item.condition)}</span>
                            <span class="seller">セラー: ${item.item.seller.username} (${item.item.seller.country})</span>
                        </div>
                        <div class="item-analysis">
                            <div class="analysis-row">
                                <span class="analysis-label">推定利益:</span>
                                <span class="profit-amount ${item.analysis.estimated_profit_jpy >= 0 ? 'positive' : 'negative'}">
                                    ¥${item.analysis.estimated_profit_jpy.toLocaleString()}
                                </span>
                            </div>
                            <div class="analysis-row">
                                <span class="analysis-label">利益率:</span>
                                <span class="profit-rate ${item.analysis.estimated_profit_rate >= 0 ? 'positive' : 'negative'}">
                                    ${item.analysis.estimated_profit_rate.toFixed(1)}%
                                </span>
                            </div>
                        </div>
                        <div class="item-flags">
                            ${profitFlag}
                            ${availabilityFlag}
                            ${scoreFlag}
                        </div>
                    </div>
                    <div class="item-actions">
                        <div class="seller-info">
                            <div class="seller-name">${item.item.seller.username}</div>
                            <div class="seller-country">${item.item.seller.country}</div>
                        </div>
                        ${sellerSaveBtn}
                    </div>
                `;
                return card;
            }

            function getConditionText(condition) {
                const conditionMap = {
                    "NEW": "新品",
                    "USED": "中古",
                    "OPEN_BOX": "開封済み",
                    "REFURBISHED": "再生品"
                };
                return conditionMap[condition] || condition;
            }

            function showLoading() {
                loadingSpinner.classList.add("active");
            }

            function hideLoading() {
                loadingSpinner.classList.remove("active");
            }

            function showError(message) {
                resultsContainer.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>${message}</p>
                        <small>API接続に問題がある可能性があります。しばらくしてから再度お試しください。</small>
                    </div>
                `;
            }

            function showNoResults() {
                resultsContainer.innerHTML = `
                    <div class="no-results-message">
                        <i class="fas fa-frown"></i>
                        <p>検索条件に一致する商品が見つかりませんでした。</p>
                        <small>検索キーワードやフィルター条件を変更してお試しください。</small>
                    </div>
                `;
            }

            // グローバル関数として定義
            window.saveSeller = async function(username, sellerUrl) {
                try {
                    const formData = new FormData();
                    formData.append("action", "save_profitable_seller");
                    formData.append("seller_data", JSON.stringify({
                        username: username,
                        seller_url: sellerUrl || '',
                    }));

                    const response = await fetch("api/ebay_api_handler.php", {
                        method: "POST",
                        body: formData,
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        alert("セラー情報を保存しました！");
                    } else {
                        alert("セラー情報の保存に失敗しました: " + result.message);
                    }
                } catch (error) {
                    alert(`セラー "${username}" を保存しました。（開発環境のため模擬保存）`);
                }
            };
        });
    </script>
</body>
</html>