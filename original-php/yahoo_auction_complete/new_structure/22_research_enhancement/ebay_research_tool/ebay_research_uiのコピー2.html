<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBay Product Research</title>
    <meta name="description" content="日本での仕入れを考慮した利益商品分析ツール">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/n3-core.css">
    <link rel="stylesheet" href="../assets/css/n3-components.css">
    
    <link rel="stylesheet" href="ebay_research.css">
</head>
<body class="n3-body">
    <header class="n3-header">
        <h1 class="n3-header-title">
            <i class="fas fa-search-dollar"></i>
            eBay Product Research
        </h1>
        <p class="n3-header-description">日本での仕入れを考慮した利益商品分析ツール</p>
    </header>

    <main class="n3-container">
        <!-- 検索モード選択 -->
        <div class="search-mode-container n3-card">
            <div class="search-mode-tabs">
                <button class="search-mode-tab active" data-mode="keyword">
                    <i class="fas fa-search"></i> キーワード検索
                </button>
                <button class="search-mode-tab" data-mode="seller">
                    <i class="fas fa-user"></i> セラーリサーチ
                </button>
                <button class="search-mode-tab" data-mode="category">
                    <i class="fas fa-tags"></i> カテゴリー分析
                </button>
            </div>
        </div>

        <!-- キーワード検索フォーム -->
        <div id="keywordSearchForm" class="search-form-container n3-card">
            <form id="researchForm" class="search-form">
                <input type="text" id="query" class="n3-input n3-input-lg" placeholder="商品名、モデル、キーワードを入力..." required>
                <div class="advanced-filters-section">
                    <a href="#" id="toggleFilters" class="n3-link-sm">
                        <i class="fas fa-sliders-h"></i> 詳細フィルター
                    </a>
                    <div id="advancedFilters" style="display:none;">
                        <div class="filter-group">
                            <label for="sellerCountry">セラーの国</label>
                            <select id="sellerCountry" class="n3-select">
                                <option value="">すべて</option>
                                <option value="JP">日本</option>
                                <option value="US">米国</option>
                                <option value="GB">イギリス</option>
                                <option value="AU">オーストラリア</option>
                                <option value="CA">カナダ</option>
                                <option value="DE">ドイツ</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="condition">商品状態</label>
                            <select id="condition" class="n3-select">
                                <option value="">すべて</option>
                                <option value="NEW">新品</option>
                                <option value="USED">中古</option>
                            </select>
                        </div>
                        <div class="filter-group price-range">
                            <label>価格帯 (USD)</label>
                            <input type="number" id="priceMin" class="n3-input" placeholder="最低価格">
                            <span>-</span>
                            <input type="number" id="priceMax" class="n3-input" placeholder="最高価格">
                        </div>
                        <div class="filter-group">
                            <label for="dataScope">データ範囲</label>
                            <select id="dataScope" class="n3-select">
                                <option value="all">すべて（売り切れ+販売中）</option>
                                <option value="sold">売り切れのみ</option>
                                <option value="active">販売中のみ</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="sortBy">並び順</label>
                            <select id="sortBy" class="n3-select">
                                <option value="profit_score">利益スコア順</option>
                                <option value="sold_quantity">売れた数順</option>
                                <option value="view_count">閲覧数順</option>
                                <option value="watcher_count">ウォッチ数順</option>
                                <option value="price_low">価格安い順</option>
                                <option value="price_high">価格高い順</option>
                                <option value="listing_date">出品日順</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button type="submit" class="n3-btn n3-btn-primary n3-btn-lg">
                    <i class="fas fa-paper-plane"></i> リサーチ開始
                </button>
            </form>
        </div>

        <!-- セラーリサーチフォーム -->
        <div id="sellerSearchForm" class="search-form-container n3-card" style="display:none;">
            <form id="sellerResearchForm" class="search-form">
                <div class="seller-input-section">
                    <div class="filter-group">
                        <label for="sellerUrl">セラーURL / セラーID</label>
                        <input type="text" id="sellerUrl" class="n3-input n3-input-lg" placeholder="https://www.ebay.com/usr/seller_name または seller_name" required>
                        <small>セラーのプロフィールページURLまたはセラーIDを入力してください</small>
                    </div>
                    <div class="filter-group">
                        <label for="sellerDataScope">取得データ</label>
                        <select id="sellerDataScope" class="n3-select">
                            <option value="all">すべての出品（売り切れ+販売中）</option>
                            <option value="sold">売り切れ商品のみ</option>
                            <option value="active">販売中商品のみ</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="n3-btn n3-btn-primary n3-btn-lg">
                    <i class="fas fa-user-search"></i> セラー分析開始
                </button>
            </form>
        </div>

        <!-- カテゴリー分析フォーム -->
        <div id="categorySearchForm" class="search-form-container n3-card" style="display:none;">
            <form id="categoryResearchForm" class="search-form">
                <div class="category-selection">
                    <div class="filter-group">
                        <label for="mainCategory">メインカテゴリー</label>
                        <select id="mainCategory" class="n3-select" onchange="updateSubCategories()">
                            <option value="">カテゴリーを選択</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Fashion">Fashion</option>
                            <option value="Home & Garden">Home & Garden</option>
                            <option value="Sports & Outdoors">Sports & Outdoors</option>
                            <option value="Toys & Hobbies">Toys & Hobbies</option>
                            <option value="Collectibles">Collectibles</option>
                            <option value="Motors">Motors</option>
                            <option value="Health & Beauty">Health & Beauty</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="subCategory">サブカテゴリー</label>
                        <select id="subCategory" class="n3-select">
                            <option value="">サブカテゴリーを選択</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="categoryCountry">対象国</label>
                        <select id="categoryCountry" class="n3-select">
                            <option value="">すべて</option>
                            <option value="JP">日本</option>
                            <option value="US">米国</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="n3-btn n3-btn-primary n3-btn-lg">
                    <i class="fas fa-chart-bar"></i> カテゴリー分析開始
                </button>
            </form>
        </div>

        <!-- 結果表示形式切り替え -->
        <div id="displayControls" class="display-controls n3-card" style="display:none;">
            <div class="display-mode-tabs">
                <button class="display-mode-tab active" data-display="card">
                    <i class="fas fa-th-large"></i> カード表示
                </button>
                <button class="display-mode-tab" data-display="table">
                    <i class="fas fa-table"></i> Excel表示
                </button>
            </div>
            <div class="display-actions">
                <button class="n3-btn n3-btn-sm" onclick="translateTitles()">
                    <i class="fas fa-language"></i> 日本語翻訳
                </button>
                <button class="n3-btn n3-btn-sm" onclick="downloadCSV()">
                    <i class="fas fa-download"></i> CSV出力
                </button>
                <button class="n3-btn n3-btn-sm" onclick="showCrossAnalysis()">
                    <i class="fas fa-chart-line"></i> クロス集計
                </button>
            </div>
        </div>

        <!-- 分析サマリー -->
        <div id="analysisSummary" class="analysis-summary" style="display:none;"></div>

        <!-- セラー情報保存ダイアログ -->
        <div id="sellerSaveDialog" class="seller-save-dialog" style="display:none;">
            <div class="dialog-content">
                <h3>セラー情報保存</h3>
                <div class="filter-group">
                    <label for="sellerName">お店の名前</label>
                    <input type="text" id="sellerName" class="n3-input" placeholder="覚えやすい名前を入力">
                </div>
                <div class="filter-group">
                    <label for="sellerMemo">特徴・メモ</label>
                    <textarea id="sellerMemo" class="n3-input" rows="3" placeholder="どんな特徴がある店舗か、メモを入力"></textarea>
                </div>
                <div class="dialog-actions">
                    <button class="n3-btn n3-btn-primary" onclick="saveSeller()">保存</button>
                    <button class="n3-btn n3-btn-secondary" onclick="closeSellerDialog()">キャンセル</button>
                </div>
            </div>
        </div>

        <!-- クロス集計ダイアログ -->
        <div id="crossAnalysisDialog" class="cross-analysis-dialog" style="display:none;">
            <div class="dialog-content">
                <h3>クロス集計分析</h3>
                <div class="cross-analysis-options">
                    <div class="filter-group">
                        <label for="crossAxisX">X軸（横軸）</label>
                        <select id="crossAxisX" class="n3-select">
                            <option value="category">カテゴリー</option>
                            <option value="seller_country">セラーの国</option>
                            <option value="condition">商品状態</option>
                            <option value="price_range">価格帯</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="crossAxisY">Y軸（縦軸）</label>
                        <select id="crossAxisY" class="n3-select">
                            <option value="sold_count">売上数</option>
                            <option value="avg_price">平均価格</option>
                            <option value="total_views">総閲覧数</option>
                            <option value="avg_profit">平均利益</option>
                        </select>
                    </div>
                </div>
                <div class="dialog-actions">
                    <button class="n3-btn n3-btn-primary" onclick="generateCrossAnalysis()">分析実行</button>
                    <button class="n3-btn n3-btn-secondary" onclick="closeCrossAnalysisDialog()">閉じる</button>
                </div>
                <div id="crossAnalysisResult"></div>
            </div>
        </div>

        <div id="resultsContainer" class="results-container">
            <div class="welcome-message">
                <i class="fas fa-chart-line"></i>
                <p>キーワードを入力して、利益の出る商品を見つけましょう。</p>
            </div>
        </div>
    </main>

    <script src="ebay_research.js"></script>
    <script>
        // 検索モード切り替え
        document.addEventListener("DOMContentLoaded", () => {
            const modeButtons = document.querySelectorAll('.search-mode-tab');
            const searchForms = {
                keyword: document.getElementById('keywordSearchForm'),
                seller: document.getElementById('sellerSearchForm'),
                category: document.getElementById('categorySearchForm')
            };

            modeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const mode = button.getAttribute('data-mode');
                    
                    // タブの状態更新
                    modeButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // フォームの表示切り替え
                    Object.keys(searchForms).forEach(key => {
                        searchForms[key].style.display = key === mode ? 'block' : 'none';
                    });
                });
            });

            // 表示形式切り替え
            const displayButtons = document.querySelectorAll('.display-mode-tab');
            displayButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const displayMode = button.getAttribute('data-display');
                    
                    displayButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    switchDisplayMode(displayMode);
                });
            });

            // 詳細フィルターの表示/非表示
            const toggleFilters = document.getElementById("toggleFilters");
            const advancedFilters = document.getElementById("advancedFilters");
            
            if (toggleFilters && advancedFilters) {
                toggleFilters.addEventListener("click", (e) => {
                    e.preventDefault();
                    advancedFilters.style.display = 
                        advancedFilters.style.display === "none" ? "grid" : "none";
                });
            }

            // フォーム送信処理
            setupFormHandlers();
        });

        // フォームハンドラー設定
        function setupFormHandlers() {
            // キーワード検索
            const researchForm = document.getElementById("researchForm");
            if (researchForm) {
                researchForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const query = document.getElementById("query").value.trim();
                    if (!query) return;

                    const filters = {
                        sellerCountry: document.getElementById("sellerCountry").value,
                        condition: document.getElementById("condition").value,
                        priceMin: document.getElementById("priceMin").value,
                        priceMax: document.getElementById("priceMax").value,
                        dataScope: document.getElementById("dataScope").value,
                        sortBy: document.getElementById("sortBy").value
                    };

                    await performKeywordSearch(query, filters);
                });
            }

            // セラーリサーチ
            const sellerForm = document.getElementById("sellerResearchForm");
            if (sellerForm) {
                sellerForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const sellerUrl = document.getElementById("sellerUrl").value.trim();
                    if (!sellerUrl) return;

                    const dataScope = document.getElementById("sellerDataScope").value;
                    await performSellerResearch(sellerUrl, dataScope);
                });
            }

            // カテゴリー分析
            const categoryForm = document.getElementById("categoryResearchForm");
            if (categoryForm) {
                categoryForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const mainCategory = document.getElementById("mainCategory").value;
                    const subCategory = document.getElementById("subCategory").value;
                    const country = document.getElementById("categoryCountry").value;

                    await performCategoryAnalysis(mainCategory, subCategory, country);
                });
            }
        }

        // サブカテゴリー更新
        function updateSubCategories() {
            const mainCategory = document.getElementById("mainCategory").value;
            const subCategorySelect = document.getElementById("subCategory");
            
            const subCategories = {
                "Electronics": [
                    "Smartphones & Cell Phones",
                    "Computers/Tablets & Networking",
                    "Cameras & Photo",
                    "TV, Audio & Surveillance",
                    "Video Games & Consoles"
                ],
                "Fashion": [
                    "Women's Clothing",
                    "Men's Clothing",
                    "Shoes",
                    "Handbags",
                    "Jewelry & Watches"
                ],
                "Home & Garden": [
                    "Home Décor",
                    "Kitchen, Dining & Bar",
                    "Tools & Home Improvement",
                    "Yard, Garden & Outdoor Living"
                ],
                "Sports & Outdoors": [
                    "Sporting Goods",
                    "Outdoor Sports",
                    "Team Sports",
                    "Exercise & Fitness"
                ],
                "Toys & Hobbies": [
                    "Action Figures",
                    "Dolls & Bears",
                    "Games",
                    "Model Trains"
                ],
                "Collectibles": [
                    "Antiques",
                    "Art",
                    "Coins & Paper Money",
                    "Comics"
                ]
            };

            subCategorySelect.innerHTML = '<option value="">サブカテゴリーを選択</option>';
            
            if (subCategories[mainCategory]) {
                subCategories[mainCategory].forEach(sub => {
                    const option = document.createElement("option");
                    option.value = sub;
                    option.textContent = sub;
                    subCategorySelect.appendChild(option);
                });
            }
        }

        // キーワード検索実行
        async function performKeywordSearch(query, filters) {
            showLoading();
            document.getElementById("displayControls").style.display = "block";
            
            try {
                const formData = new FormData();
                formData.append("action", "search_products");
                formData.append("query", query);
                formData.append("filters", JSON.stringify(filters));

                const response = await fetch("api/ebay_api_handler.php", {
                    method: "POST",
                    body: formData,
                });
                const result = await response.json();

                if (result.success) {
                    displayResults(result.data.items, 'keyword');
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error("API通信エラー:", error);
                // フォールバック：サンプルデータ
                await simulateKeywordSearch(query, filters);
            } finally {
                hideLoading();
            }
        }

        // セラーリサーチ実行
        async function performSellerResearch(sellerUrl, dataScope) {
            showLoading();
            document.getElementById("displayControls").style.display = "block";
            
            try {
                const formData = new FormData();
                formData.append("action", "get_seller_items");
                formData.append("seller_url", sellerUrl);
                formData.append("data_scope", dataScope);

                const response = await fetch("api/ebay_api_handler.php", {
                    method: "POST",
                    body: formData,
                });
                const result = await response.json();

                if (result.success) {
                    displayResults(result.data.items, 'seller');
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error("API通信エラー:", error);
                await simulateSellerResearch(sellerUrl, dataScope);
            } finally {
                hideLoading();
            }
        }

        // カテゴリー分析実行
        async function performCategoryAnalysis(mainCategory, subCategory, country) {
            showLoading();
            document.getElementById("displayControls").style.display = "block";
            
            try {
                const formData = new FormData();
                formData.append("action", "analyze_category");
                formData.append("main_category", mainCategory);
                formData.append("sub_category", subCategory);
                formData.append("country", country);

                const response = await fetch("api/ebay_api_handler.php", {
                    method: "POST",
                    body: formData,
                });
                const result = await response.json();

                if (result.success) {
                    displayResults(result.data.items, 'category');
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error("API通信エラー:", error);
                await simulateCategoryAnalysis(mainCategory, subCategory, country);
            } finally {
                hideLoading();
            }
        }

        // 結果表示
        function displayResults(items, searchType) {
            const resultsContainer = document.getElementById("resultsContainer");
            resultsContainer.innerHTML = "";

            // 分析サマリー表示
            displayAnalysisSummary(items, searchType);

            // 現在の表示モードに応じて表示
            const activeDisplayMode = document.querySelector('.display-mode-tab.active');
            const displayMode = activeDisplayMode ? activeDisplayMode.getAttribute('data-display') : 'card';
            
            if (displayMode === 'card') {
                displayCardView(items);
            } else {
                displayTableView(items);
            }
        }

        // 分析サマリー表示
        function displayAnalysisSummary(items, searchType) {
            const summaryContainer = document.getElementById("analysisSummary");
            summaryContainer.style.display = "block";

            const totalItems = items.length;
            const soldItems = items.filter(item => item.analysis?.sold_quantity > 0 || item.isSold).length;
            const totalViews = items.reduce((sum, item) => sum + (item.viewCount || 0), 0);
            const totalWatchers = items.reduce((sum, item) => sum + (item.watchCount || 0), 0);
            const avgPrice = items.reduce((sum, item) => sum + (item.price?.value || 0), 0) / totalItems;
            const totalValue = items.reduce((sum, item) => sum + (item.price?.value || 0), 0);

            summaryContainer.innerHTML = `
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="summary-value">${totalItems.toLocaleString()}</div>
                        <div class="summary-label">総商品数</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${soldItems.toLocaleString()}</div>
                        <div class="summary-label">売り切れ商品</div>
                        <div class="summary-rate">${((soldItems/totalItems)*100).toFixed(1)}%</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">$${totalValue.toLocaleString()}</div>
                        <div class="summary-label">市場総額</div>
                        <div class="summary-rate">約${Math.round(totalValue * 150).toLocaleString()}円</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${totalViews.toLocaleString()}</div>
                        <div class="summary-label">総閲覧数</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${totalWatchers.toLocaleString()}</div>
                        <div class="summary-label">総ウォッチ数</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">$${avgPrice.toFixed(0)}</div>
                        <div class="summary-label">平均価格</div>
                    </div>
                </div>
            `;
        }

        // カード表示
        function displayCardView(items) {
            const resultsContainer = document.getElementById("resultsContainer");
            
            items.forEach((item) => {
                const itemCard = createItemCard(item);
                resultsContainer.appendChild(itemCard);
            });
        }

        // テーブル表示
        function displayTableView(items) {
            const resultsContainer = document.getElementById("resultsContainer");
            
            const table = document.createElement("table");
            table.className = "data-table";
            table.innerHTML = `
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">商品情報</th>
                        <th onclick="sortTable(1)">価格</th>
                        <th onclick="sortTable(2)">販売数</th>
                        <th onclick="sortTable(3)">閲覧数</th>
                        <th onclick="sortTable(4)">ウォッチ数</th>
                        <th onclick="sortTable(5)">出品日</th>
                        <th onclick="sortTable(6)">販売期間</th>
                        <th onclick="sortTable(7)">セラー</th>
                        <th onclick="sortTable(8)">利益予測</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${items.map(item => createTableRow(item)).join('')}
                </tbody>
            `;
            
            resultsContainer.appendChild(table);
        }

        // 商品カード作成
        function createItemCard(item) {
            const card = document.createElement("div");
            card.className = "item-card";

            const profitFlag = item.analysis?.is_profitable
                ? '<span class="profit-flag profitable">✓ 利益商品</span>'
                : '<span class="profit-flag non-profitable">✗ 利益商品ではない</span>';
            
            const availabilityFlag = item.analysis?.is_currently_available
                ? '<span class="available-flag in-stock">即決</span>'
                : '<span class="available-flag auction">オークション</span>';
            
            const scoreFlag = `<span class="score-flag">スコア: ${item.analysis?.profit_score || 0}</span>`;

            card.innerHTML = `
                <img src="${item.item?.image?.imageUrl || item.image?.imageUrl}" alt="${item.item?.title || item.title}" class="item-thumbnail">
                <div class="item-content">
                    <a href="${item.item?.itemWebUrl || item.itemWebUrl}" target="_blank" class="item-title" data-original-title="${item.item?.title || item.title}">
                        ${item.item?.title || item.title}
                    </a>
                    <div class="item-meta">
                        <span class="price">$${(item.item?.price?.value || item.price?.value || 0).toFixed(2)} ${item.item?.price?.currency || item.price?.currency || 'USD'}</span>
                        <span class="condition">状態: ${item.item?.condition || item.condition || 'N/A'}</span>
                        <span class="seller">セラー: ${item.item?.seller?.username || item.seller?.username || 'N/A'} (${item.item?.seller?.country || item.seller?.country || 'N/A'})</span>
                        <div class="performance-stats">
                            <span><i class="fas fa-eye"></i> 閲覧: ${(item.viewCount || 0).toLocaleString()}</span>
                            <span><i class="fas fa-heart"></i> ウォッチ: ${(item.watchCount || 0).toLocaleString()}</span>
                            <span><i class="fas fa-shopping-cart"></i> 販売: ${(item.soldQuantity || 0).toLocaleString()}</span>
                        </div>
                        <div class="timing-info">
                            <span>出品: ${item.listingDate || 'N/A'}</span>
                            ${item.soldDate ? `<span>売切: ${item.soldDate}</span>` : ''}
                            ${item.sellingDuration ? `<span>期間: ${item.sellingDuration}日</span>` : ''}
                        </div>
                    </div>
                    <div class="item-analysis">
                        <div class="analysis-row">
                            <span>推定利益:</span>
                            <span class="profit-amount">¥${(item.analysis?.estimated_profit_jpy || 0).toLocaleString()}</span>
                        </div>
                        <div class="analysis-row">
                            <span>利益率:</span>
                            <span class="profit-rate">${(item.analysis?.estimated_profit_rate || 0).toFixed(1)}%</span>
                        </div>
                    </div>
                    <div class="item-flags">
                        ${profitFlag}
                        ${availabilityFlag}
                        ${scoreFlag}
                    </div>
                </div>
                <div class="item-actions">
                    <button class="n3-btn n3-btn-sm n3-btn-secondary" onclick="openSellerSaveDialog('${item.item?.seller?.username || item.seller?.username}', '${item.item?.seller?.sellerLegalName?.link?.href || ''}')">
                        <i class="fas fa-bookmark"></i> セラー保存
                    </button>
                </div>
            `;
            return card;
        }

        // テーブル行作成
        function createTableRow(item) {
            const price = item.item?.price?.value || item.price?.value || 0;
            const soldQty = item.soldQuantity || 0;
            const viewCount = item.viewCount || 0;
            const watchCount = item.watchCount || 0;
            const listingDate = item.listingDate || 'N/A';
            const sellingDuration = item.sellingDuration || 'N/A';
            const sellerName = item.item?.seller?.username || item.seller?.username || 'N/A';
            const sellerCountry = item.item?.seller?.country || item.seller?.country || 'N/A';
            const estimatedProfit = item.analysis?.estimated_profit_jpy || 0;

            return `
                <tr>
                    <td>
                        <div class="table-product-info">
                            <img src="${item.item?.image?.imageUrl || item.image?.imageUrl}" alt="${item.item?.title || item.title}" style="width: 40px; height: 40px; object-fit: cover; margin-right: 8px;">
                            <div>
                                <div class="product-title-table" data-original-title="${item.item?.title || item.title}">${(item.item?.title || item.title || '').substring(0, 50)}...</div>
                                <small>${item.item?.condition || item.condition || 'N/A'}</small>
                            </div>
                        </div>
                    </td>
                    <td>$${price.toFixed(2)}</td>
                    <td>${soldQty.toLocaleString()}</td>
                    <td>${viewCount.toLocaleString()}</td>
                    <td>${watchCount.toLocaleString()}</td>
                    <td>${listingDate}</td>
                    <td>${sellingDuration}日</td>
                    <td>${sellerName} (${sellerCountry})</td>
                    <td>¥${estimatedProfit.toLocaleString()}</td>
                    <td>
                        <button class="n3-btn n3-btn-sm" onclick="openSellerSaveDialog('${sellerName}', '')">
                            <i class="fas fa-bookmark"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        // 表示モード切り替え
        function switchDisplayMode(mode) {
            // 現在の結果を取得して再表示
            const existingCards = document.querySelectorAll('.item-card');
            const existingTable = document.querySelector('.data-table');
            
            if (existingCards.length > 0 || existingTable) {
                // 結果が存在する場合は再表示
                const items = getCurrentResults();
                if (items.length > 0) {
                    const resultsContainer = document.getElementById("resultsContainer");
                    resultsContainer.innerHTML = "";
                    
                    if (mode === 'card') {
                        displayCardView(items);
                    } else {
                        displayTableView(items);
                    }
                }
            }
        }

        // 現在の結果を取得
        function getCurrentResults() {
            // 実際の実装では、現在表示されている結果を保持する変数から取得
            return window.currentResults || [];
        }

        // タイトル翻訳
        async function translateTitles() {
            const titleElements = document.querySelectorAll('[data-original-title]');
            titleElements.forEach(async (element) => {
                const originalTitle = element.getAttribute('data-original-title');
                try {
                    // 実際の翻訳API呼び出し
                    const translatedTitle = await translateText(originalTitle);
                    element.textContent = translatedTitle;
                    element.setAttribute('title', originalTitle); // オリジナルをツールチップに
                } catch (error) {
                    console.error('翻訳エラー:', error);
                }
            });
        }

        // 翻訳API呼び出し（プレースホルダー）
        async function translateText(text) {
            // 実際の翻訳APIとの連携が必要
            // 例: Google Translate API, DeepL API等
            return `[翻訳] ${text}`;
        }

        // CSV出力
        function downloadCSV() {
            const items = getCurrentResults();
            if (items.length === 0) {
                alert('出力する結果がありません。');
                return;
            }

            const headers = [
                'タイトル', '価格(USD)', '販売数', '閲覧数', 'ウォッチ数', 
                '出品日', '販売期間', 'セラー名', 'セラー国', '推定利益(円)'
            ];

            const csvContent = [
                headers.join(','),
                ...items.map(item => [
                    `"${(item.item?.title || item.title || '').replace(/"/g, '""')}"`,
                    item.item?.price?.value || item.price?.value || 0,
                    item.soldQuantity || 0,
                    item.viewCount || 0,
                    item.watchCount || 0,
                    item.listingDate || '',
                    item.sellingDuration || '',
                    item.item?.seller?.username || item.seller?.username || '',
                    item.item?.seller?.country || item.seller?.country || '',
                    item.analysis?.estimated_profit_jpy || 0
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ebay_research_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // セラー保存ダイアログ
        function openSellerSaveDialog(sellerName, sellerUrl) {
            document.getElementById('sellerName').value = sellerName;
            document.getElementById('sellerSaveDialog').style.display = 'flex';
            window.currentSellerData = { username: sellerName, url: sellerUrl };
        }

        function closeSellerDialog() {
            document.getElementById('sellerSaveDialog').style.display = 'none';
        }

        async function saveSeller() {
            const sellerName = document.getElementById('sellerName').value;
            const sellerMemo = document.getElementById('sellerMemo').value;
            
            try {
                const formData = new FormData();
                formData.append("action", "save_profitable_seller");
                formData.append("seller_data", JSON.stringify({
                    username: window.currentSellerData.username,
                    seller_url: window.currentSellerData.url,
                    display_name: sellerName,
                    memo: sellerMemo
                }));

                const response = await fetch("api/ebay_api_handler.php", {
                    method: "POST",
                    body: formData,
                });
                const result = await response.json();
                
                if (result.success) {
                    alert("セラー情報を保存しました！");
                    closeSellerDialog();
                } else {
                    alert("セラー情報の保存に失敗しました: " + result.message);
                }
            } catch (error) {
                alert("セラー情報を保存しました。（開発環境）");
                closeSellerDialog();
            }
        }

        // クロス集計表示
        function showCrossAnalysis() {
            document.getElementById('crossAnalysisDialog').style.display = 'flex';
        }

        function closeCrossAnalysisDialog() {
            document.getElementById('crossAnalysisDialog').style.display = 'none';
        }

        function generateCrossAnalysis() {
            const xAxis = document.getElementById('crossAxisX').value;
            const yAxis = document.getElementById('crossAxisY').value;
            const items = getCurrentResults();
            
            if (items.length === 0) {
                alert('分析する結果がありません。');
                return;
            }

            // クロス集計ロジック実装
            const crossData = performCrossAnalysis(items, xAxis, yAxis);
            displayCrossAnalysisResult(crossData, xAxis, yAxis);
        }

        function performCrossAnalysis(items, xAxis, yAxis) {
            // クロス集計の実装
            const result = {};
            
            items.forEach(item => {
                const xValue = getValueByAxis(item, xAxis);
                const yValue = getValueByAxis(item, yAxis);
                
                if (!result[xValue]) {
                    result[xValue] = { count: 0, total: 0, average: 0 };
                }
                
                result[xValue].count++;
                result[xValue].total += yValue;
                result[xValue].average = result[xValue].total / result[xValue].count;
            });
            
            return result;
        }

        function getValueByAxis(item, axis) {
            switch (axis) {
                case 'category':
                    return item.category || 'Unknown';
                case 'seller_country':
                    return item.item?.seller?.country || item.seller?.country || 'Unknown';
                case 'condition':
                    return item.item?.condition || item.condition || 'Unknown';
                case 'price_range':
                    const price = item.item?.price?.value || item.price?.value || 0;
                    if (price < 50) return '~$50';
                    if (price < 100) return '$50-100';
                    if (price < 500) return '$100-500';
                    return '$500+';
                case 'sold_count':
                    return item.soldQuantity || 0;
                case 'avg_price':
                    return item.item?.price?.value || item.price?.value || 0;
                case 'total_views':
                    return item.viewCount || 0;
                case 'avg_profit':
                    return item.analysis?.estimated_profit_jpy || 0;
                default:
                    return 'Unknown';
            }
        }

        function displayCrossAnalysisResult(crossData, xAxis, yAxis) {
            const resultDiv = document.getElementById('crossAnalysisResult');
            
            let html = `<h4>${xAxis} × ${yAxis} クロス集計結果</h4><table class="cross-analysis-table">`;
            html += `<thead><tr><th>${xAxis}</th><th>件数</th><th>${yAxis}合計</th><th>${yAxis}平均</th></tr></thead><tbody>`;
            
            Object.keys(crossData).forEach(key => {
                const data = crossData[key];
                html += `<tr>
                    <td>${key}</td>
                    <td>${data.count}</td>
                    <td>${data.total.toLocaleString()}</td>
                    <td>${data.average.toFixed(2)}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            resultDiv.innerHTML = html;
        }

        // サンプルデータ生成（開発用）
        async function simulateKeywordSearch(query, filters) {
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const sampleItems = generateSampleData(50, 'keyword');
            window.currentResults = sampleItems;
            displayResults(sampleItems, 'keyword');
        }

        async function simulateSellerResearch(sellerUrl, dataScope) {
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const sampleItems = generateSampleData(30, 'seller');
            window.currentResults = sampleItems;
            displayResults(sampleItems, 'seller');
        }

        async function simulateCategoryAnalysis(mainCategory, subCategory, country) {
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const sampleItems = generateSampleData(40, 'category');
            window.currentResults = sampleItems;
            displayResults(sampleItems, 'category');
        }

        function generateSampleData(count, type) {
            const categories = ['Electronics', 'Fashion', 'Home & Garden', 'Sports'];
            const countries = ['US', 'GB', 'AU', 'CA', 'DE', 'JP'];
            const conditions = ['NEW', 'USED'];
            const sellers = ['tech_seller_us', 'fashion_store_uk', 'sports_gear_au', 'electronics_ca'];

            const items = [];
            for (let i = 0; i < count; i++) {
                const price = Math.random() * 500 + 10;
                const soldQty = Math.floor(Math.random() * 50);
                const viewCount = Math.floor(Math.random() * 1000) + 100;
                const watchCount = Math.floor(Math.random() * 50) + 5;
                
                items.push({
                    item: {
                        itemId: `item_${i}`,
                        title: `Sample Product ${i + 1} - High Quality Item`,
                        price: { value: price, currency: 'USD' },
                        condition: conditions[Math.floor(Math.random() * conditions.length)],
                        image: { imageUrl: `https://via.placeholder.com/150x150?text=Item${i+1}` },
                        itemWebUrl: `https://ebay.com/itm/item_${i}`,
                        seller: {
                            username: sellers[Math.floor(Math.random() * sellers.length)],
                            country: countries[Math.floor(Math.random() * countries.length)]
                        }
                    },
                    category: categories[Math.floor(Math.random() * categories.length)],
                    soldQuantity: soldQty,
                    viewCount: viewCount,
                    watchCount: watchCount,
                    listingDate: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    sellingDuration: Math.floor(Math.random() * 30) + 1,
                    analysis: {
                        estimated_profit_jpy: Math.floor((price * 150) * 0.2),
                        estimated_profit_rate: Math.random() * 30,
                        profit_score: Math.floor(Math.random() * 100),
                        is_profitable: Math.random() > 0.5,
                        is_currently_available: Math.random() > 0.4
                    }
                });
            }
            return items;
        }

        function showLoading() {
            document.body.classList.add("loading");
        }

        function hideLoading() {
            document.body.classList.remove("loading");
        }

        function showError(message) {
            const resultsContainer = document.getElementById("resultsContainer");
            resultsContainer.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i><p>${message}</p></div>`;
        }
    </script>
</body>
</html>