<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBay AI Research Tool - Next Generation</title>
    <meta name="description" content="AI駆動の次世代eBayリサーチツール - 仕入先自動検出・利益計算・リスク分析">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <style>
        :root {
            --primary-color: #3D74B6;
            --primary-light: #FBF5DE;
            --primary-accent: #EAC8A6;
            --danger-color: #DC3C22;
            --success-color: #7AE2CF;
            --dark-color: #077A7D;
            --darker-color: #06202B;
            --neutral-light: #F5EEDD;
            --ai-color: #6366F1;
            --ai-light: #E0E7FF;
            
            --n3-color-primary: var(--primary-color);
            --n3-color-success: var(--success-color);
            --n3-color-danger: var(--danger-color);
            --n3-bg-primary: #ffffff;
            --n3-bg-secondary: var(--neutral-light);
            --n3-bg-tertiary: var(--primary-light);
            --n3-border-color: #e2e8f0;
            --n3-shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --n3-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --n3-spacing-md: 1rem;
            --n3-spacing-lg: 1.5rem;
            --n3-font-size-lg: 1.125rem;
            --n3-text-primary: var(--darker-color);
            --n3-text-secondary: var(--dark-color);
            --n3-text-muted: #64748b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--n3-bg-secondary);
            color: var(--n3-text-primary);
            line-height: 1.6;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(6, 32, 43, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Header */
        .n3-header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            padding: 2rem;
            text-align: center;
            color: white;
            box-shadow: var(--n3-shadow-lg);
            position: relative;
        }

        .ai-badge {
            position: absolute;
            top: 1rem;
            right: 2rem;
            background: var(--ai-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .n3-header-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .n3-header-description {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Main Container */
        .n3-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: var(--n3-spacing-lg);
        }

        /* Enhanced Search Form */
        .search-form-container {
            background: var(--n3-bg-primary);
            border: 1px solid var(--n3-border-color);
            border-radius: 12px;
            box-shadow: var(--n3-shadow-md);
            padding: var(--n3-spacing-lg);
            margin-bottom: 2rem;
            position: relative;
        }

        .search-form-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--ai-color), var(--primary-color));
            border-radius: 12px;
            z-index: -1;
            opacity: 0.1;
        }

        .search-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--primary-accent);
        }

        .search-tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            font-size: 1rem;
            color: var(--n3-text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .search-tab:hover {
            background: var(--primary-light);
            color: var(--primary-color);
        }

        .search-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: var(--primary-light);
            font-weight: 600;
        }

        .search-form {
            display: none;
        }

        .search-form.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--n3-spacing-md);
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--n3-text-primary);
        }

        .n3-input, .n3-select {
            padding: 0.75rem;
            border: 1px solid var(--n3-border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: var(--n3-bg-primary);
        }

        .n3-input:focus, .n3-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(61, 116, 182, 0.1);
        }

        .main-search-input {
            grid-column: 1 / -1;
        }

        .main-search-input .n3-input {
            padding: 1rem;
            font-size: 1.2rem;
            border: 2px solid var(--primary-accent);
        }

        .n3-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .n3-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .n3-btn-primary {
            background: var(--primary-color);
            color: white;
            grid-column: 1 / -1;
            justify-self: center;
            max-width: 300px;
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }

        .n3-btn-primary:hover:not(:disabled) {
            background: var(--dark-color);
            transform: translateY(-1px);
            box-shadow: var(--n3-shadow-md);
        }

        .n3-btn-ai {
            background: var(--ai-color);
            color: white;
        }

        .n3-btn-ai:hover:not(:disabled) {
            background: #5B5CF6;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        .n3-btn-secondary {
            background: var(--primary-accent);
            color: var(--n3-text-primary);
            border: 1px solid var(--n3-border-color);
        }

        .n3-btn-secondary:hover:not(:disabled) {
            background: var(--primary-light);
        }

        /* AI Analysis Panel Enhanced */
        .ai-analysis-panel {
            background: linear-gradient(135deg, var(--ai-light), var(--n3-bg-primary));
            border: 2px solid var(--ai-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .ai-analysis-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--ai-color), var(--primary-color), var(--ai-color));
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .ai-analysis-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .ai-analysis-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--ai-color);
        }

        .ai-analysis-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .ai-tab {
            padding: 0.5rem 1rem;
            background: var(--n3-bg-primary);
            border: 1px solid var(--n3-border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .ai-tab:hover {
            background: var(--ai-light);
            border-color: var(--ai-color);
        }

        .ai-tab.active {
            background: var(--ai-color);
            color: white;
            border-color: var(--ai-color);
        }

        .ai-tab-content {
            display: none;
            background: var(--n3-bg-primary);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--ai-color);
        }

        .ai-tab-content.active {
            display: block;
        }

        /* Enhanced Statistics Dashboard */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--primary-light);
            border-radius: 12px;
            border: 1px solid var(--primary-accent);
        }

        .stat-card {
            background: var(--n3-bg-primary);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: var(--n3-shadow-md);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--n3-text-secondary);
        }

        .stat-change {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* Enhanced Product Cards */
        .results-section {
            margin-top: 2rem;
        }

        .results-header {
            background: var(--n3-bg-primary);
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
            border: 1px solid var(--n3-border-color);
            border-bottom: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .results-stats {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .view-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .view-toggle {
            display: flex;
            background: var(--n3-bg-primary);
            border: 1px solid var(--n3-border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .view-btn {
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--n3-text-secondary);
        }

        .view-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.75rem 1rem;
            background: var(--n3-bg-primary);
            border: 1px solid var(--n3-border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            color: var(--n3-text-primary);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .action-btn.ai-btn {
            background: var(--ai-light);
            border-color: var(--ai-color);
            color: var(--ai-color);
        }

        .action-btn.ai-btn:hover {
            background: var(--ai-color);
            color: white;
        }

        /* Results Container */
        .results-container {
            background: var(--n3-bg-primary);
            border: 1px solid var(--n3-border-color);
            border-radius: 0 0 12px 12px;
            min-height: 400px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
        }

        .product-card {
            background: var(--n3-bg-primary);
            border: 1px solid var(--n3-border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: var(--n3-shadow-md);
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--n3-shadow-lg);
        }

        .product-card.ai-analyzed::before {
            content: 'AI';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--ai-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 10;
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .product-content {
            padding: 1.5rem;
        }

        .product-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            color: var(--n3-text-primary);
        }

        .product-title-ja {
            font-size: 0.9rem;
            color: var(--n3-text-secondary);
            margin-bottom: 0.75rem;
            font-style: italic;
        }

        .product-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--n3-text-secondary);
        }

        .product-price {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .product-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-sold {
            background: rgba(122, 226, 207, 0.2);
            color: var(--success-color);
        }

        .badge-active {
            background: rgba(61, 116, 182, 0.2);
            color: var(--primary-color);
        }

        .badge-ai {
            background: var(--ai-light);
            color: var(--ai-color);
        }

        .badge-profit-high {
            background: rgba(122, 226, 207, 0.2);
            color: var(--success-color);
        }

        .badge-profit-medium {
            background: rgba(234, 200, 166, 0.8);
            color: var(--dark-color);
        }

        .badge-profit-low {
            background: rgba(220, 60, 34, 0.2);
            color: var(--danger-color);
        }

        /* AI Insights Panel */
        .ai-insights-panel {
            background: var(--ai-light);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--ai-color);
        }

        .insight-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }

        .insight-item:last-child {
            margin-bottom: 0;
        }

        .insight-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--ai-color);
            white-space: nowrap;
        }

        .insight-value {
            font-size: 0.85rem;
            color: var(--n3-text-primary);
            text-align: right;
            flex: 1;
        }

        .insight-value.high {
            color: var(--success-color);
            font-weight: 600;
        }

        .insight-value.medium {
            color: var(--primary-color);
            font-weight: 600;
        }

        .insight-value.low {
            color: var(--danger-color);
            font-weight: 600;
        }

        /* Supplier Quick Access */
        .supplier-quick-access {
            margin-bottom: 1rem;
        }

        .supplier-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .supplier-btn:hover {
            background: var(--dark-color);
            transform: translateY(-1px);
        }

        .analyzing {
            font-size: 0.8rem;
            color: var(--n3-text-muted);
            font-style: italic;
        }

        /* Enhanced Memo Section */
        .enhanced-memo-section {
            margin-bottom: 1rem;
        }

        .memo-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .memo-tab {
            padding: 0.25rem 0.75rem;
            background: var(--n3-bg-secondary);
            border: 1px solid var(--n3-border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .memo-tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .enhanced-memo {
            display: none;
            width: 100%;
            min-height: 60px;
            padding: 0.5rem;
            border: 1px solid var(--n3-border-color);
            border-radius: 6px;
            font-size: 0.8rem;
            resize: vertical;
            background: var(--n3-bg-primary);
        }

        .enhanced-memo.active {
            display: block;
        }

        .enhanced-memo:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Product Stats */
        .product-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            padding: 1rem;
            background: var(--primary-light);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        .stat-text {
            font-size: 0.75rem;
            color: var(--n3-text-secondary);
        }

        /* Card Actions Enhanced */
        .card-actions-enhanced {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .card-btn {
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .card-btn-primary {
            background: var(--primary-color);
            color: white;
            grid-column: 1 / -1;
        }

        .card-btn-primary:hover {
            background: var(--dark-color);
        }

        .card-btn-ai {
            background: var(--ai-color);
            color: white;
        }

        .card-btn-ai:hover {
            background: #5B5CF6;
        }

        .card-btn-suppliers {
            background: var(--success-color);
            color: white;
        }

        .card-btn-suppliers:hover {
            background: var(--dark-color);
        }

        .card-btn-secondary {
            background: var(--primary-accent);
            color: var(--n3-text-primary);
        }

        .card-btn-secondary:hover {
            background: var(--primary-light);
        }

        /* Loading and Empty States */
        .loading-state {
            text-align: center;
            padding: 3rem;
            color: var(--n3-text-secondary);
        }

        .loading-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
            color: var(--primary-color);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--n3-text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--primary-accent);
        }

        /* Advanced Filters */
        .filters-section {
            background: var(--primary-light);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 12px;
            border: 1px solid var(--primary-accent);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--n3-bg-primary);
            border: 1px solid var(--n3-border-color);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--n3-shadow-lg);
            z-index: 1000;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            border-left: 4px solid var(--success-color);
        }

        .notification.error {
            border-left: 4px solid var(--danger-color);
        }

        .notification.info {
            border-left: 4px solid var(--ai-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .n3-container {
                padding: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            .results-header {
                flex-direction: column;
                align-items: stretch;
            }

            .results-stats {
                justify-content: center;
            }

            .view-controls {
                justify-content: center;
            }

            .stats-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }

            .product-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .ai-analysis-tabs {
                flex-direction: column;
            }

            .card-actions-enhanced {
                grid-template-columns: 1fr;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .profit-positive {
            color: var(--success-color);
            font-weight: 600;
        }

        .profit-negative {
            color: var(--danger-color);
            font-weight: 600;
        }

        .country-flag {
            font-size: 1.1rem;
            margin-right: 0.5rem;
        }

        .seller-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .seller-details {
            flex: 1;
        }

        .seller-name {
            font-weight: 600;
            color: var(--primary-color);
        }

        .seller-rating {
            font-size: 0.8rem;
            color: var(--n3-text-secondary);
        }

        .profit-analysis {
            background: var(--primary-light);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .profit-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .profit-value {
            font-weight: 600;
            color: var(--success-color);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>AI分析実行中...</h3>
            <p id="loading-message">eBayデータを取得・分析しています</p>
        </div>
    </div>

    <!-- Header -->
    <header class="n3-header">
        <div class="ai-badge">
            <i class="fas fa-robot"></i> AI搭載
        </div>
        <h1 class="n3-header-title">
            <i class="fas fa-chart-line"></i>
            eBay AI Research Tool
        </h1>
        <p class="n3-header-description">AI駆動の次世代リサーチツール - 仕入先自動検出・利益計算・リスク分析</p>
    </header>

    <main class="n3-container">
        <!-- Search Form Container -->
        <div class="search-form-container">
            <!-- Search Tabs -->
            <div class="search-tabs">
                <button class="search-tab active" data-tab="product">
                    <i class="fas fa-search"></i> 商品リサーチ
                </button>
                <button class="search-tab" data-tab="seller">
                    <i class="fas fa-user"></i> セラーリサーチ
                </button>
                <button class="search-tab" data-tab="ai-suggestions">
                    <i class="fas fa-robot"></i> AI提案
                </button>
            </div>

            <!-- Product Research Form -->
            <form class="search-form active" id="product-form">
                <div class="form-grid">
                    <div class="form-group main-search-input">
                        <label class="form-label">検索キーワード</label>
                        <input type="text" class="n3-input" id="keyword-query" placeholder="商品名、ブランド、モデル名を入力..." required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">カテゴリー</label>
                        <select class="n3-select" id="category">
                            <option value="">すべて</option>
                            <option value="293">Electronics</option>
                            <option value="11450">Clothing</option>
                            <option value="11700">Home & Garden</option>
                            <option value="888">Sports</option>
                            <option value="220">Toys</option>
                            <option value="1">Collectibles</option>
                            <option value="6000">Motors</option>
                            <option value="12576">Business</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">セラーの国</label>
                        <select class="n3-select" id="seller-country">
                            <option value="">すべて</option>
                            <option value="JP">日本</option>
                            <option value="US">アメリカ</option>
                            <option value="GB">イギリス</option>
                            <option value="AU">オーストラリア</option>
                            <option value="CA">カナダ</option>
                            <option value="DE">ドイツ</option>
                            <option value="FR">フランス</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">商品状態</label>
                        <select class="n3-select" id="condition">
                            <option value="">すべて</option>
                            <option value="1000">新品</option>
                            <option value="3000">中古</option>
                            <option value="2500">再生品</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">最低価格 (USD)</label>
                        <input type="number" class="n3-input" id="min-price" placeholder="0" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">最高価格 (USD)</label>
                        <input type="number" class="n3-input" id="max-price" placeholder="1000" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">最低Sold数</label>
                        <input type="number" class="n3-input" id="min-sold" placeholder="1" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">検索期間</label>
                        <select class="n3-select" id="search-period">
                            <option value="7">過去7日</option>
                            <option value="30" selected>過去30日</option>
                            <option value="90">過去90日</option>
                            <option value="180">過去6ヶ月</option>
                            <option value="365">過去1年</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">データ範囲</label>
                        <select class="n3-select" id="data-scope">
                            <option value="all">すべて（売切れ+販売中）</option>
                            <option value="sold">売切れのみ</option>
                            <option value="active">販売中のみ</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="n3-btn n3-btn-primary">
                        <i class="fas fa-search"></i> 
                        <span class="button-text">AIリサーチ開始</span>
                        <div class="loading-spinner" style="display: none; width: 20px; height: 20px; border-width: 2px;"></div>
                    </button>
                </div>
            </form>

            <!-- Seller Research Form -->
            <form class="search-form" id="seller-form">
                <div class="form-grid">
                    <div class="form-group main-search-input">
                        <label class="form-label">セラーURL / セラーID</label>
                        <input type="text" class="n3-input" id="seller-url" placeholder="https://www.ebay.com/usr/seller_name または seller_name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">取得データ</label>
                        <select class="n3-select" id="seller-data-scope">
                            <option value="all">すべての出品</option>
                            <option value="sold">売切れ商品のみ</option>
                            <option value="active">販売中商品のみ</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">期間</label>
                        <select class="n3-select" id="seller-period">
                            <option value="30">過去30日</option>
                            <option value="90">過去3ヶ月</option>
                            <option value="180">過去6ヶ月</option>
                            <option value="365">過去1年</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="n3-btn n3-btn-primary">
                        <i class="fas fa-user-search"></i> 
                        <span class="button-text">セラー分析開始</span>
                        <div class="loading-spinner" style="display: none; width: 20px; height: 20px; border-width: 2px;"></div>
                    </button>
                </div>
            </form>

            <!-- AI Suggestions Form -->
            <form class="search-form" id="ai-suggestions-form">
                <div class="form-grid">
                    <div class="form-group main-search-input">
                        <label class="form-label">AI関連キーワード生成</label>
                        <input type="text" class="n3-input" id="ai-base-keyword" placeholder="ベースとなるキーワードを入力..." required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">提案タイプ</label>
                        <select class="n3-select" id="suggestion-type">
                            <option value="accessories">アクセサリー関連</option>
                            <option value="alternatives">代替商品</option>
                            <option value="seasonal">季節商品</option>
                            <option value="bundles">セット商品</option>
                            <option value="niche">ニッチ市場</option>
                            <option value="all">すべて</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="n3-btn n3-btn-ai">
                        <i class="fas fa-robot"></i> 
                        <span class="button-text">AI提案生成</span>
                        <div class="loading-spinner" style="display: none; width: 20px; height: 20px; border-width: 2px;"></div>
                    </button>
                </div>
            </form>
        </div>

        <!-- AI Analysis Panel -->
        <div class="ai-analysis-panel hidden" id="ai-analysis">
            <div class="ai-analysis-header">
                <i class="fas fa-robot" style="color: var(--ai-color); font-size: 1.5rem;"></i>
                <h3 class="ai-analysis-title">AI市場分析レポート</h3>
                <div style="margin-left: auto;">
                    <span style="font-size: 0.8rem; color: var(--n3-text-muted);">信頼度: <span id="ai-confidence">-</span>%</span>
                </div>
            </div>
            
            <div class="ai-analysis-tabs">
                <button class="ai-tab active" data-tab="reasons">売れる理由</button>
                <button class="ai-tab" data-tab="suppliers">仕入れ先</button>
                <button class="ai-tab" data-tab="timing">タイミング</button>
                <button class="ai-tab" data-tab="keywords">関連キーワード</button>
                <button class="ai-tab" data-tab="risks">リスク分析</button>
            </div>
            
            <div class="ai-tab-content active" id="reasons-content">
                <!-- AI analysis will be populated here -->
            </div>
            
            <div class="ai-tab-content" id="suppliers-content">
                <!-- Supplier analysis will be populated here -->
            </div>
            
            <div class="ai-tab-content" id="timing-content">
                <!-- Timing analysis will be populated here -->
            </div>
            
            <div class="ai-tab-content" id="keywords-content">
                <!-- Keyword suggestions will be populated here -->
            </div>
            
            <div class="ai-tab-content" id="risks-content">
                <!-- Risk analysis will be populated here -->
            </div>
        </div>

        <!-- Statistics Dashboard -->
        <div class="stats-dashboard hidden" id="stats-dashboard">
            <!-- Stats will be populated here -->
        </div>

        <!-- Advanced Filters -->
        <div class="filters-section hidden" id="filters-section">
            <div class="filters-header">
                <h3>詳細フィルター</h3>
                <button class="n3-btn n3-btn-secondary" onclick="resetFilters()">リセット</button>
            </div>
            <div class="filters-grid">
                <div class="form-group">
                    <label class="form-label">最低閲覧数</label>
                    <input type="number" class="n3-input" id="filter-views" placeholder="100" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">最低ウォッチ数</label>
                    <input type="number" class="n3-input" id="filter-watchers" placeholder="5" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">AI推奨レベル</label>
                    <select class="n3-select" id="filter-ai-recommendation">
                        <option value="">すべて</option>
                        <option value="high">高推奨</option>
                        <option value="medium">中推奨</option>
                        <option value="low">低推奨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">無在庫適性</label>
                    <select class="n3-select" id="filter-dropshipping">
                        <option value="">すべて</option>
                        <option value="suitable">適している</option>
                        <option value="not-suitable">適さない</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">仕入れ先可用性</label>
                    <select class="n3-select" id="filter-supplier-availability">
                        <option value="">すべて</option>
                        <option value="available">在庫あり</option>
                        <option value="limited">在庫限定</option>
                        <option value="unavailable">在庫なし</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ブランド</label>
                    <input type="text" class="n3-input" id="filter-brand" placeholder="Sony, Apple, Nike...">
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <section id="results-section" class="results-section hidden">
            <!-- Results Header -->
            <div class="results-header">
                <div class="results-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="total-items">0</div>
                        <div class="stat-label">総商品数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="sold-items">0</div>
                        <div class="stat-label">売切れ商品</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avg-price">$0</div>
                        <div class="stat-label">平均価格</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-profit">¥0</div>
                        <div class="stat-label">推定総利益</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="ai-analyzed">0</div>
                        <div class="stat-label">AI分析済み</div>
                    </div>
                </div>

                <div class="view-controls">
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="card">
                            <i class="fas fa-th-large"></i> カード表示
                        </button>
                        <button class="view-btn" data-view="table">
                            <i class="fas fa-table"></i> テーブル表示
                        </button>
                    </div>

                    <div class="action-buttons">
                        <button class="action-btn ai-btn" onclick="runBatchAIAnalysis()">
                            <i class="fas fa-robot"></i> 一括AI分析
                        </button>
                        <button class="action-btn" onclick="translateTitles()">
                            <i class="fas fa-language"></i> 日本語翻訳
                        </button>
                        <button class="action-btn" onclick="downloadEnhancedCSV()">
                            <i class="fas fa-download"></i> 拡張CSV出力
                        </button>
                        <button class="action-btn" onclick="showFilters()">
                            <i class="fas fa-filter"></i> フィルター
                        </button>
                        <button class="action-btn" onclick="saveAllDataToDB()">
                            <i class="fas fa-database"></i> DB保存
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Container -->
            <div class="results-container" id="results-container">
                <!-- Results will be populated here -->
            </div>
        </section>

        <!-- Loading State -->
        <div id="loading" class="hidden">
            <div class="loading-state">
                <i class="fas fa-spinner"></i>
                <h3>データを取得中...</h3>
                <p>eBayからAI分析用データを収集しています</p>
            </div>
        </div>

        <!-- No Results -->
        <div id="no-results" class="hidden">
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>検索結果が見つかりませんでした</h3>
                <p>検索条件を変更してお試しください</p>
            </div>
        </div>
    </main>

    <script>
        // Global Configuration
        const API_BASE_URL = 'http://localhost:3000/api';
        const AI_ANALYSIS_URL = `${API_BASE_URL}/ai-analysis`;
        
        // Global variables
        let currentResults = [];
        let currentView = 'card';
        let currentSearchType = 'product';
        let translatedTitles = new Map();
        let aiAnalysisCache = new Map();
        let authToken = localStorage.getItem('auth_token') || null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            checkAuthStatus();
            loadCachedData();
            setupNotificationSystem();
        }

        function setupEventListeners() {
            // Search tab switching
            document.querySelectorAll('.search-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchSearchTab(this.dataset.tab);
                });
            });

            // View toggle
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchView(this.dataset.view);
                });
            });

            // AI tab switching
            document.querySelectorAll('.ai-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchAITab(this.dataset.tab);
                });
            });

            // Form submissions
            document.getElementById('product-form').addEventListener('submit', handleProductSearch);
            document.getElementById('seller-form').addEventListener('submit', handleSellerSearch);
            document.getElementById('ai-suggestions-form').addEventListener('submit', handleAISuggestions);

            // Filter event listeners
            document.querySelectorAll('#filters-section input, #filters-section select').forEach(input => {
                input.addEventListener('input', debounce(applyAdvancedFilters, 500));
                input.addEventListener('change', applyAdvancedFilters);
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        async function checkAuthStatus() {
            if (!authToken) {
                // For demo purposes, we'll generate a demo token
                authToken = 'demo_token_' + Date.now();
                localStorage.setItem('auth_token', authToken);
            }
        }

        function loadCachedData() {
            // Load any cached analysis results
            const cachedResults = localStorage.getItem('ebay_research_cache');
            if (cachedResults) {
                try {
                    const data = JSON.parse(cachedResults);
                    if (data.timestamp > Date.now() - 3600000) { // 1 hour cache
                        currentResults = data.results || [];
                        if (currentResults.length > 0) {
                            showResults();
                            updateStats(currentResults);
                            renderResults(currentResults);
                        }
                    }
                } catch (error) {
                    console.error('Failed to load cached data:', error);
                }
            }
        }

        function setupNotificationSystem() {
            // Setup notification container if not exists
            if (!document.querySelector('.notification-container')) {
                const container = document.createElement('div');
                container.className = 'notification-container';
                container.style.cssText = `
                    position: fixed;
                    top: 2rem;
                    right: 2rem;
                    z-index: 10000;
                    max-width: 400px;
                `;
                document.body.appendChild(container);
            }
        }

        function showNotification(message, type = 'info') {
            const container = document.querySelector('.notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="margin-left: auto; background: none; border: none; font-size: 1.2rem; cursor: pointer;">&times;</button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function switchSearchTab(tabName) {
            currentSearchType = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.search-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update forms
            document.querySelectorAll('.search-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(`${tabName}-form`).classList.add('active');
        }

        function switchView(viewType) {
            currentView = viewType;

            // Update buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view="${viewType}"]`).classList.add('active');

            // Re-render results
            if (currentResults.length > 0) {
                renderResults(currentResults);
            }
        }

        function switchAITab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.ai-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.ai-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        async function handleProductSearch(e) {
            e.preventDefault();
            
            const formData = {
                action: 'search_products',
                query: document.getElementById('keyword-query').value,
                category: document.getElementById('category').value,
                sellerCountry: document.getElementById('seller-country').value,
                condition: document.getElementById('condition').value,
                minPrice: document.getElementById('min-price').value,
                maxPrice: document.getElementById('max-price').value,
                minSold: document.getElementById('min-sold').value,
                period: document.getElementById('search-period').value,
                dataScope: document.getElementById('data-scope').value
            };

            await performSearch(formData);
        }

        async function handleSellerSearch(e) {
            e.preventDefault();
            
            const formData = {
                action: 'get_seller_items',
                sellerUrl: document.getElementById('seller-url').value,
                dataScope: document.getElementById('seller-data-scope').value,
                period: document.getElementById('seller-period').value
            };

            await performSearch(formData);
        }

        async function handleAISuggestions(e) {
            e.preventDefault();
            
            const baseKeyword = document.getElementById('ai-base-keyword').value;
            const suggestionType = document.getElementById('suggestion-type').value;

            try {
                showLoading('AI関連キーワードを生成中...');
                
                const response = await fetch(`${AI_ANALYSIS_URL}/generate-keywords`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        baseKeyword,
                        suggestionType
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    displayAISuggestions(data.suggestions);
                    showNotification('AI関連キーワードが生成されました', 'success');
                } else {
                    throw new Error(data.message || 'AI提案の生成に失敗しました');
                }
                
            } catch (error) {
                console.error('AI suggestions error:', error);
                showNotification('AI提案の生成に失敗しました: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function performSearch(searchData) {
            try {
                showLoading('eBayデータを検索中...');
                updateLoadingMessage('eBay APIに接続しています...');
                
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                updateLoadingMessage('商品データを分析中...');
                
                // In production, this would call the actual API
                const results = await mockAPICall(searchData);
                
                updateLoadingMessage('AI分析を実行中...');
                
                // Run AI analysis on results
                const enhancedResults = await runAIAnalysisOnResults(results);
                
                currentResults = enhancedResults;
                
                // Cache results
                cacheResults(enhancedResults);
                
                showResults();
                updateStats(enhancedResults);
                renderResults(enhancedResults);
                
                // Generate AI market analysis
                await generateAIMarketAnalysis(enhancedResults);
                
                showNotification(`${enhancedResults.length}件の商品を検索・分析しました`, 'success');
                
            } catch (error) {
                console.error('Search error:', error);
                showNotification('検索に失敗しました: ' + error.message, 'error');
                showNoResults();
            } finally {
                hideLoading();
            }
        }

        async function mockAPICall(searchData) {
            // Enhanced mock data generation
            const itemCount = Math.floor(Math.random() * 100) + 30;
            const results = [];

            const brands = ['Sony', 'Apple', 'Samsung', 'Nintendo', 'Nike', 'Adidas', 'Canon', 'Nikon', 'Panasonic', 'LG'];
            const countries = ['US', 'GB', 'AU', 'CA', 'DE', 'JP', 'FR'];
            const conditions = ['1000', '3000', '2500'];

            for (let i = 0; i < itemCount; i++) {
                const price = Math.random() * 800 + 50;
                const jpyPrice = price * 150;
                const sold = Math.floor(Math.random() * 300);
                const views = Math.floor(Math.random() * 8000) + 200;
                const watchers = Math.floor(Math.random() * 150) + 10;
                const brand = brands[Math.floor(Math.random() * brands.length)];
                const country = countries[Math.floor(Math.random() * countries.length)];
                const condition = conditions[Math.floor(Math.random() * conditions.length)];

                results.push({
                    id: `item_${i}`,
                    title: `${brand} ${generateProductName()} ${getConditionName(condition)}`,
                    titleJa: '', // Will be translated
                    brand: brand,
                    category: searchData.category || 'Electronics',
                    price: price,
                    jpyPrice: jpyPrice,
                    currency: 'USD',
                    condition: condition,
                    image: `https://picsum.photos/400/300?random=${i}`,
                    url: `https://ebay.com/itm/item_${i}`,
                    seller: {
                        name: `seller_${i % 25}_${country.toLowerCase()}`,
                        country: country,
                        rating: Math.floor(Math.random() * 5000) + 500,
                        positivePercent: 95 + Math.random() * 5
                    },
                    stats: {
                        sold: sold,
                        views: views,
                        watchers: watchers,
                        listingDate: new Date(Date.now() - Math.random() * 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        soldDate: new Date().toISOString().split('T')[0],
                        duration: Math.floor(Math.random() * 30) + 1
                    },
                    status: Math.random() > 0.4 ? 'sold' : 'active',
                    memo: '',
                    structuredData: {
                        supplierNotes: [],
                        strategyNotes: '',
                        riskNotes: ''
                    },
                    // AI analysis placeholders - will be populated
                    aiAnalysis: null,
                    needsAIAnalysis: true
                });
            }

            return results.sort((a, b) => b.stats.sold - a.stats.sold);
        }

        function generateProductName() {
            const types = ['Camera', 'Watch', 'Headphones', 'Mouse', 'Keyboard', 'Monitor', 'Speaker', 'Tablet', 'Phone Case', 'Charger'];
            const models = ['Pro', 'Max', 'Ultra', 'Elite', 'Premium', 'Deluxe', 'X1', 'V2', 'Plus', 'Air', 'Mini', 'Lite'];
            return `${types[Math.floor(Math.random() * types.length)]} ${models[Math.floor(Math.random() * models.length)]}`;
        }

        function getConditionName(conditionId) {
            const conditions = {
                '1000': 'New',
                '3000': 'Used',
                '2500': 'Refurbished'
            };
            return conditions[conditionId] || 'New';
        }

        async function runAIAnalysisOnResults(results) {
            const batchSize = 10;
            const batches = [];
            
            for (let i = 0; i < results.length; i += batchSize) {
                batches.push(results.slice(i, i + batchSize));
            }

            let processedCount = 0;
            
            for (const batch of batches) {
                const batchPromises = batch.map(async (item) => {
                    try {
                        const analysis = await runSingleAIAnalysis(item);
                        item.aiAnalysis = analysis;
                        item.needsAIAnalysis = false;
                        
                        // Translate title
                        item.titleJa = await translateTitle(item.title);
                        
                        processedCount++;
                        updateLoadingMessage(`AI分析中... (${processedCount}/${results.length})`);
                        
                        return item;
                    } catch (error) {
                        console.error('AI analysis failed for item:', item.id, error);
                        item.aiAnalysis = getDefaultAIAnalysis();
                        return item;
                    }
                });
                
                await Promise.all(batchPromises);
                
                // Small delay to prevent overwhelming the UI
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            return results;
        }

        async function runSingleAIAnalysis(productData) {
            try {
                const response = await fetch(`${AI_ANALYSIS_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        productData: productData,
                        options: {
                            analysisTypes: ['demand', 'price', 'risk', 'matching', 'trend']
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`AI Analysis API error: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    return transformAIAnalysisResponse(data.data.analysis);
                } else {
                    throw new Error(data.message || 'AI analysis failed');
                }
                
            } catch (error) {
                console.error('AI analysis error:', error);
                // Return mock analysis for demo
                return generateMockAIAnalysis(productData);
            }
        }

        function transformAIAnalysisResponse(analysisData) {
            return {
                primaryReason: analysisData.summary?.keyInsights?.[0] || '高い市場需要',
                purchaseRecommendation: {
                    level: analysisData.summary?.recommendation === 'strong_buy' ? 'high' : 
                           analysisData.summary?.recommendation === 'buy' ? 'medium' : 'low',
                    text: getRecommendationText(analysisData.summary?.recommendation),
                    confidence: analysisData.summary?.confidence || 0.7
                },
                optimalTiming: determineOptimalTiming(analysisData.results?.trend),
                topSuppliers: analysisData.results?.matching?.bestMatches?.overall?.slice(0, 3).map(match => ({
                    name: match.platform,
                    url: match.url || '#',
                    estimatedPrice: match.price || 0,
                    availability: match.availability || 'unknown'
                })) || [],
                dropshippingFeasibility: {
                    feasible: analysisData.summary?.overallScore > 6,
                    confidence: analysisData.summary?.confidence || 0.7,
                    reasoning: analysisData.recommendations?.[0]?.description || '市場分析に基づく判定'
                },
                riskLevel: analysisData.results?.risk?.riskLevel || 'medium',
                profitPotential: analysisData.summary?.profitPotential || 'medium'
            };
        }

        function generateMockAIAnalysis(productData) {
            const reasons = [
                '高い市場需要と安定した販売実績',
                'ブランド認知度による信頼性',
                '適正価格帯での競争優位',
                '季節性による需要増加',
                'アクセサリー市場の拡大'
            ];

            const suppliers = [
                { name: 'Amazon', url: '#', estimatedPrice: productData.price * 0.7 * 150, availability: 'available' },
                { name: '楽天市場', url: '#', estimatedPrice: productData.price * 0.75 * 150, availability: 'available' },
                { name: 'AliExpress', url: '#', estimatedPrice: productData.price * 0.5 * 150, availability: 'limited' }
            ];

            const dropshippingScore = Math.random();
            const riskScore = Math.random();

            return {
                primaryReason: reasons[Math.floor(Math.random() * reasons.length)],
                purchaseRecommendation: {
                    level: dropshippingScore > 0.7 ? 'high' : dropshippingScore > 0.4 ? 'medium' : 'low',
                    text: dropshippingScore > 0.7 ? '強く推奨' : dropshippingScore > 0.4 ? '条件付き推奨' : '要検討',
                    confidence: dropshippingScore
                },
                optimalTiming: '即座に実行可能',
                topSuppliers: suppliers,
                dropshippingFeasibility: {
                    feasible: dropshippingScore > 0.5,
                    confidence: dropshippingScore,
                    reasoning: dropshippingScore > 0.5 ? '供給安定性と市場規模が良好' : '供給リスクまたは市場制約あり'
                },
                riskLevel: riskScore > 0.7 ? 'low' : riskScore > 0.4 ? 'medium' : 'high',
                profitPotential: dropshippingScore > 0.6 ? 'high' : 'medium'
            };
        }

        function getRecommendationText(recommendation) {
            const texts = {
                'strong_buy': '強く推奨',
                'buy': '推奨',
                'hold_and_monitor': '要監視',
                'research_further': '要調査',
                'avoid': '非推奨'
            };
            return texts[recommendation] || '要検討';
        }

        function determineOptimalTiming(trendData) {
            if (!trendData) return '即座に実行可能';
            
            if (trendData.seasonality?.isCurrentSeason) {
                return 'シーズン最適期';
            } else if (trendData.growthRate > 0.2) {
                return '成長期につき即座実行推奨';
            } else {
                return '通常タイミング';
            }
        }

        function getDefaultAIAnalysis() {
            return {
                primaryReason: '分析中...',
                purchaseRecommendation: { level: 'medium', text: '分析中...', confidence: 0.5 },
                optimalTiming: '分析中...',
                topSuppliers: [],
                dropshippingFeasibility: { feasible: false, confidence: 0.5, reasoning: '分析中...' },
                riskLevel: 'medium',
                profitPotential: 'medium'
            };
        }

        async function translateTitle(englishTitle) {
            // Mock translation - in production, this would call Google Translate API
            const translations = {
                'Camera': 'カメラ', 'Watch': '時計', 'Headphones': 'ヘッドホン',
                'Mouse': 'マウス', 'Keyboard': 'キーボード', 'Monitor': 'モニター',
                'Speaker': 'スピーカー', 'Tablet': 'タブレット', 'Phone Case': 'ケース',
                'Charger': '充電器', 'Pro': 'プロ', 'Max': 'マックス', 'Ultra': 'ウルトラ',
                'Elite': 'エリート', 'Premium': 'プレミアム', 'New': '新品', 'Used': '中古',
                'Refurbished': '再生品'
            };

            let translated = englishTitle;
            Object.entries(translations).forEach(([en, ja]) => {
                translated = translated.replace(new RegExp(en, 'g'), ja);
            });

            return translated;
        }

        function cacheResults(results) {
            try {
                const cacheData = {
                    results: results,
                    timestamp: Date.now(),
                    searchParams: getCurrentSearchParams()
                };
                localStorage.setItem('ebay_research_cache', JSON.stringify(cacheData));
            } catch (error) {
                console.error('Failed to cache results:', error);
            }
        }

        function getCurrentSearchParams() {
            return {
                searchType: currentSearchType,
                keyword: document.getElementById('keyword-query')?.value || '',
                category: document.getElementById('category')?.value || '',
                sellerCountry: document.getElementById('seller-country')?.value || '',
                condition: document.getElementById('condition')?.value || '',
                minPrice: document.getElementById('min-price')?.value || '',
                maxPrice: document.getElementById('max-price')?.value || '',
                minSold: document.getElementById('min-sold')?.value || '',
                period: document.getElementById('search-period')?.value || '30',
                dataScope: document.getElementById('data-scope')?.value || 'all'
            };
        }

        async function generateAIMarketAnalysis(results) {
            try {
                const response = await fetch(`${AI_ANALYSIS_URL}/opportunities`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    displayAIMarketAnalysis(data.data.opportunities);
                } else {
                    // Fallback to mock analysis
                    displayMockMarketAnalysis(results);
                }
                
            } catch (error) {
                console.error('AI market analysis error:', error);
                displayMockMarketAnalysis(results);
            }
        }

        function displayMockMarketAnalysis(results) {
            const analysis = {
                sellingReasons: [
                    '電子機器カテゴリーの安定需要',
                    '平均価格帯での適正なポジショニング',
                    '高い視認性と検索上位表示',
                    'ブランド認知度による信頼性'
                ],
                supplierRecommendations: [
                    'Amazon.co.jpでの安定供給',
                    '楽天市場での複数ショップ選択肢',
                    'AliExpressでの価格競争力'
                ],
                timingAnalysis: [
                    '現在が最適な仕入れタイミング',
                    '年末商戦に向けた在庫確保推奨',
                    '円安基調による利益率向上'
                ],
                keywordSuggestions: [
                    'アクセサリー関連キーワード',
                    'セット商品の提案',
                    '関連ブランドの展開'
                ],
                riskFactors: [
                    '競合セラーの価格変動に注意',
                    '季節商品の場合は在庫リスクあり',
                    'ブランド正規品の仕入れ先確認必須'
                ]
            };

            displayAIAnalysisContent(analysis);
        }

        function displayAIAnalysisContent(analysis) {
            // Show AI panel
            document.getElementById('ai-analysis').classList.remove('hidden');
            
            // Update confidence score
            document.getElementById('ai-confidence').textContent = Math.floor(Math.random() * 20 + 80);

            // Populate content for each tab
            document.getElementById('reasons-content').innerHTML = `
                <h4>売れている理由の分析</h4>
                <ul>
                    ${analysis.sellingReasons.map(reason => `<li>${reason}</li>`).join('')}
                </ul>
            `;

            document.getElementById('suppliers-content').innerHTML = `
                <h4>推奨仕入れ先</h4>
                <ul>
                    ${analysis.supplierRecommendations.map(supplier => `<li>${supplier}</li>`).join('')}
                </ul>
            `;

            document.getElementById('timing-content').innerHTML = `
                <h4>最適タイミング分析</h4>
                <ul>
                    ${analysis.timingAnalysis.map(timing => `<li>${timing}</li>`).join('')}
                </ul>
            `;

            document.getElementById('keywords-content').innerHTML = `
                <h4>関連キーワード提案</h4>
                <ul>
                    ${analysis.keywordSuggestions.map(keyword => `<li>${keyword}</li>`).join('')}
                </ul>
            `;

            document.getElementById('risks-content').innerHTML = `
                <h4>リスク要因</h4>
                <ul>
                    ${analysis.riskFactors.map(risk => `<li>${risk}</li>`).join('')}
                </ul>
            `;
        }

        function displayAISuggestions(suggestions) {
            document.getElementById('keywords-content').innerHTML = `
                <h4>AI生成関連キーワード</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    ${Object.entries(suggestions).map(([category, keywords]) => `
                        <div>
                            <h5 style="color: var(--ai-color); margin-bottom: 0.5rem;">${category}</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${keywords.map(keyword => `
                                    <span style="background: var(--ai-light); color: var(--ai-color); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;" onclick="searchKeyword('${keyword}')">
                                        ${keyword}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Show AI panel and switch to keywords tab
            document.getElementById('ai-analysis').classList.remove('hidden');
            switchAITab('keywords');
        }

        function searchKeyword(keyword) {
            document.getElementById('keyword-query').value = keyword;
            document.getElementById('product-form').dispatchEvent(new Event('submit'));
        }

        function showLoading(message = 'データを取得中...') {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('no-results').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('loading').classList.add('hidden');
        }

        function updateLoadingMessage(message) {
            document.getElementById('loading-message').textContent = message;
        }

        function showResults() {
            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('no-results').classList.add('hidden');
            document.getElementById('stats-dashboard').classList.remove('hidden');
        }

        function showNoResults() {
            document.getElementById('no-results').classList.remove('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('ai-analysis').classList.add('hidden');
            document.getElementById('stats-dashboard').classList.add('hidden');
        }

        function updateStats(data) {
            const totalItems = data.length;
            const soldItems = data.filter(item => item.status === 'sold').length;
            const avgPrice = data.reduce((sum, item) => sum + item.price, 0) / totalItems;
            const totalProfit = data.reduce((sum, item) => {
                const profit = (item.price * 150) * 0.2; // Estimated 20% profit
                return sum + profit;
            }, 0);
            const aiAnalyzed = data.filter(item => item.aiAnalysis && !item.needsAIAnalysis).length;

            document.getElementById('total-items').textContent = totalItems.toLocaleString();
            document.getElementById('sold-items').textContent = soldItems.toLocaleString();
            document.getElementById('avg-price').textContent = ' + avgPrice.toFixed(0);
            document.getElementById('total-profit').textContent = '¥' + Math.round(totalProfit).toLocaleString();
            document.getElementById('ai-analyzed').textContent = aiAnalyzed.toLocaleString();

            // Update dashboard stats
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-value">${((soldItems/totalItems)*100).toFixed(1)}%</div>
                    <div class="stat-label">売上率</div>
                    <div class="stat-change positive">+2.3%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.filter(item => item.aiAnalysis?.purchaseRecommendation?.level === 'high').length}</div>
                    <div class="stat-label">AI高推奨商品</div>
                    <div class="stat-change positive">+5 件</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.reduce((sum, item) => sum + item.stats.views, 0).toLocaleString()}</div>
                    <div class="stat-label">総閲覧数</div>
                    <div class="stat-change positive">+15%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${data.filter(item => item.aiAnalysis?.dropshippingFeasibility?.feasible).length}</div>
                    <div class="stat-label">無在庫適合商品</div>
                    <div class="stat-change positive">+3 件</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${new Set(data.map(item => item.seller.name)).size}</div>
                    <div class="stat-label">ユニークセラー</div>
                    <div class="stat-change">±0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${Math.round(aiAnalyzed / totalItems * 100)}%</div>
                    <div class="stat-label">AI分析完了率</div>
                    <div class="stat-change positive">+${aiAnalyzed} 件</div>
                </div>
            `;

            document.getElementById('stats-dashboard').innerHTML = statsHtml;
        }

        function renderResults(data) {
            const container = document.getElementById('results-container');
            
            if (currentView === 'card') {
                container.innerHTML = '<div class="results-grid">' + 
                    data.map(item => createEnhancedProductCard(item)).join('') + 
                    '</div>';
            } else {
                container.innerHTML = '<div class="results-table" style="padding: 1.5rem; overflow-x: auto;">' + 
                    createEnhancedResultsTable(data) + 
                    '</div>';
            }
        }

        function createEnhancedProductCard(item) {
            const countryFlag = getCountryFlag(item.seller.country);
            const aiAnalysis = item.aiAnalysis || getDefaultAIAnalysis();
            const hasAI = item.aiAnalysis && !item.needsAIAnalysis;
            
            return `
                <div class="product-card ${hasAI ? 'ai-analyzed' : ''}" data-product-id="${item.id}">
                    <img src="${item.image}" alt="${item.title}" class="product-image" onerror="this.src='https://via.placeholder.com/400x300/e0e7ff/6366f1?text=No+Image'">
                    <div class="product-content">
                        <h3 class="product-title" title="${item.title}">${item.title}</h3>
                        ${item.titleJa ? `<div class="product-title-ja">${item.titleJa}</div>` : ''}
                        
                        <div class="product-meta">
                            <div class="product-price">${item.price.toFixed(2)}</div>
                            <div>約¥${Math.round(item.jpyPrice).toLocaleString()}</div>
                            <div>状態: ${getConditionName(item.condition)}</div>
                            <div>ブランド: ${item.brand}</div>
                        </div>

                        <div class="product-badges">
                            <span class="badge badge-${item.status}">${item.status === 'sold' ? '売切れ' : '販売中'}</span>
                            ${hasAI ? '<span class="badge badge-ai">AI分析済み</span>' : ''}
                            <span class="badge badge-profit-${aiAnalysis.profitPotential}">${getProfitLabel(aiAnalysis.profitPotential)}</span>
                        </div>

                        ${hasAI ? `
                        <div class="ai-insights-panel">
                            <div class="insight-item">
                                <span class="insight-label">🎯 売れる理由:</span>
                                <span class="insight-value">${aiAnalysis.primaryReason}</span>
                            </div>
                            
                            <div class="insight-item">
                                <span class="insight-label">🛒 仕入れ推奨:</span>
                                <span class="insight-value ${aiAnalysis.purchaseRecommendation.level}">
                                    ${aiAnalysis.purchaseRecommendation.text}
                                </span>
                            </div>
                            
                            <div class="insight-item">
                                <span class="insight-label">⏰ 最適タイミング:</span>
                                <span class="insight-value">${aiAnalysis.optimalTiming}</span>
                            </div>

                            <div class="insight-item">
                                <span class="insight-label">📦 無在庫適性:</span>
                                <span class="insight-value ${aiAnalysis.dropshippingFeasibility.feasible ? 'high' : 'low'}">
                                    ${aiAnalysis.dropshippingFeasibility.feasible ? '適している' : '要検討'}
                                </span>
                            </div>
                        </div>
                        ` : '<div class="ai-insights-panel"><div class="analyzing">AI分析中...</div></div>'}

                        <div class="product-stats">
                            <div class="stat-item">
                                <div class="stat-number">${item.stats.sold}</div>
                                <div class="stat-text">販売数</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${item.stats.views.toLocaleString()}</div>
                                <div class="stat-text">閲覧数</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${item.stats.watchers}</div>
                                <div class="stat-text">ウォッチ</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${item.stats.duration}</div>
                                <div class="stat-text">販売期間</div>
                            </div>
                        </div>

                        <div class="seller-info">
                            <span class="country-flag">${countryFlag}</span>
                            <div class="seller-details">
                                <div class="seller-name">${item.seller.name}</div>
                                <div class="seller-rating">評価: ${item.seller.rating} (${item.seller.positivePercent.toFixed(1)}%)</div>
                            </div>
                        </div>

                        ${hasAI && aiAnalysis.topSuppliers.length > 0 ? `
                        <div class="supplier-quick-access">
                            <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--ai-color);">🛍️ 仕入れ先候補:</div>
                            ${aiAnalysis.topSuppliers.map(supplier => `
                                <button class="supplier-btn" onclick="openSupplier('${supplier.url}')">
                                    <i class="fas fa-external-link-alt"></i>
                                    ${supplier.name} (¥${Math.round(supplier.estimatedPrice).toLocaleString()})
                                </button>
                            `).join('')}
                        </div>
                        ` : '<div class="supplier-quick-access"><span class="analyzing">仕入れ先分析中...</span></div>'}

                        <div class="enhanced-memo-section">
                            <div class="memo-tabs">
                                <button class="memo-tab active" data-memo-type="general" onclick="switchMemoTab('${item.id}', 'general')">一般</button>
                                <button class="memo-tab" data-memo-type="suppliers" onclick="switchMemoTab('${item.id}', 'suppliers')">仕入先</button>
                                <button class="memo-tab" data-memo-type="strategy" onclick="switchMemoTab('${item.id}', 'strategy')">戦略</button>
                            </div>
                            
                            <textarea class="enhanced-memo active" 
                                      data-memo-type="general"
                                      placeholder="一般的な分析メモ..."
                                      onchange="saveEnhancedMemo('${item.id}', 'general', this.value)">
                                ${item.memo || ''}
                            </textarea>
                            
                            <textarea class="enhanced-memo" 
                                      data-memo-type="suppliers"
                                      placeholder="仕入れ先情報・価格・在庫状況..."
                                      onchange="saveEnhancedMemo('${item.id}', 'suppliers', this.value)">
                                ${item.structuredData?.supplierNotes?.join('\\n') || ''}
                            </textarea>
                            
                            <textarea class="enhanced-memo" 
                                      data-memo-type="strategy"
                                      placeholder="販売戦略・マーケティング計画..."
                                      onchange="saveEnhancedMemo('${item.id}', 'strategy', this.value)">
                                ${item.structuredData?.strategyNotes || ''}
                            </textarea>
                        </div>

                        <div class="card-actions-enhanced">
                            <button class="card-btn card-btn-primary" onclick="window.open('${item.url}', '_blank')">
                                <i class="fas fa-external-link-alt"></i> eBayで見る
                            </button>
                            
                            <button class="card-btn card-btn-ai" onclick="runDetailedAIAnalysis('${item.id}')">
                                <i class="fas fa-robot"></i> AI詳細分析
                            </button>
                            
                            <button class="card-btn card-btn-suppliers" onclick="findAllSuppliers('${item.id}')">
                                <i class="fas fa-search"></i> 仕入れ先検索
                            </button>
                            
                            <button class="card-btn card-btn-secondary" onclick="saveSeller('${item.seller.name}', '${item.seller.country}')">
                                <i class="fas fa-bookmark"></i> セラー保存
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function createEnhancedResultsTable(data) {
            const headers = [
                '商品情報', 'AI分析', 'ブランド', '価格', '状態', '販売数', '閲覧数', 'ウォッチ', 
                'セラー', '仕入れ推奨', '無在庫適性', 'リスク', '仕入れ先', 'メモ', '操作'
            ];

            const rows = data.map(item => {
                const aiAnalysis = item.aiAnalysis || getDefaultAIAnalysis();
                const hasAI = item.aiAnalysis && !item.needsAIAnalysis;
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <img src="${item.image}" alt="${item.title}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">
                                <div style="min-width: 200px;">
                                    <div style="font-weight: 600; margin-bottom: 0.25rem; line-height: 1.3;">${item.title}</div>
                                    ${item.titleJa ? `<div style="font-size: 0.75rem; color: var(--n3-text-secondary); font-style: italic;">${item.titleJa}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td>
                            ${hasAI ? '<span class="badge badge-ai">完了</span>' : '<span class="analyzing">分析中</span>'}
                        </td>
                        <td>${item.brand}</td>
                        <td>${item.price.toFixed(2)}<br><small>¥${Math.round(item.jpyPrice).toLocaleString()}</small></td>
                        <td><span class="badge badge-${item.status}">${item.status === 'sold' ? '売切れ' : '販売中'}</span></td>
                        <td class="text-center">${item.stats.sold}</td>
                        <td class="text-center">${item.stats.views.toLocaleString()}</td>
                        <td class="text-center">${item.stats.watchers}</td>
                        <td>${getCountryFlag(item.seller.country)} ${item.seller.name}</td>
                        <td>
                            <span class="insight-value ${aiAnalysis.purchaseRecommendation?.level || 'medium'}">
                                ${aiAnalysis.purchaseRecommendation?.text || '分析中'}
                            </span>
                        </td>
                        <td>
                            <span class="${aiAnalysis.dropshippingFeasibility?.feasible ? 'profit-positive' : 'profit-negative'}">
                                ${aiAnalysis.dropshippingFeasibility?.feasible ? '適している' : '要検討'}
                            </span>
                        </td>
                        <td>
                            <span style="color: ${getRiskColor(aiAnalysis.riskLevel)}">${getRiskLabel(aiAnalysis.riskLevel)}</span>
                        </td>
                        <td style="font-size: 0.75rem;">
                            ${hasAI && aiAnalysis.topSuppliers?.length > 0 ? 
                                aiAnalysis.topSuppliers.map(s => s.name).join('<br>') : 
                                '分析中'
                            }
                        </td>
                        <td>
                            <textarea style="width: 150px; height: 60px; font-size: 0.75rem; padding: 4px;" 
                                      placeholder="メモ..." onchange="saveEnhancedMemo('${item.id}', 'general', this.value)">${item.memo}</textarea>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                <button class="n3-btn n3-btn-primary" onclick="window.open('${item.url}', '_blank')" style="font-size: 0.75rem; padding: 0.5rem;">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>
                                <button class="n3-btn n3-btn-ai" onclick="runDetailedAIAnalysis('${item.id}')" style="font-size: 0.75rem; padding: 0.5rem;">
                                    <i class="fas fa-robot"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <table style="width: 100%; border-collapse: collapse; background: var(--n3-bg-primary); min-width: 1400px;">
                    <thead>
                        <tr style="background: var(--ai-light);">
                            ${headers.map(h => `<th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--n3-border-color); font-weight: 600; color: var(--n3-text-primary); cursor: pointer;" onclick="sortTable('${h}')">${h} <i class="fas fa-sort"></i></th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        // Helper Functions
        function getCountryFlag(country) {
            const flags = {
                'US': '🇺🇸', 'GB': '🇬🇧', 'AU': '🇦🇺', 'CA': '🇨🇦',
                'DE': '🇩🇪', 'FR': '🇫🇷', 'IT': '🇮🇹', 'JP': '🇯🇵'
            };
            return flags[country] || '🌍';
        }

        function getProfitLabel(level) {
            const labels = {
                'high': '高利益',
                'medium': '中利益',
                'low': '低利益'
            };
            return labels[level] || '分析中';
        }

        function getRiskColor(level) {
            const colors = {
                'low': 'var(--success-color)',
                'medium': 'var(--primary-color)',
                'high': 'var(--danger-color)'
            };
            return colors[level] || 'var(--n3-text-secondary)';
        }

        function getRiskLabel(level) {
            const labels = {
                'low': '低リスク',
                'medium': '中リスク',
                'high': '高リスク'
            };
            return labels[level] || '分析中';
        }

        // Enhanced Functions
        function switchMemoTab(itemId, memoType) {
            const card = document.querySelector(`[data-product-id="${itemId}"]`);
            
            // Update tab buttons
            card.querySelectorAll('.memo-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            card.querySelector(`[data-memo-type="${memoType}"]`).classList.add('active');

            // Update memo textareas
            card.querySelectorAll('.enhanced-memo').forEach(memo => {
                memo.classList.remove('active');
            });
            card.querySelector(`.enhanced-memo[data-memo-type="${memoType}"]`).classList.add('active');
        }

        function saveEnhancedMemo(itemId, memoType, content) {
            const item = currentResults.find(item => item.id === itemId);
            if (item) {
                if (memoType === 'general') {
                    item.memo = content;
                } else if (memoType === 'suppliers') {
                    if (!item.structuredData) item.structuredData = {};
                    item.structuredData.supplierNotes = content.split('\n').filter(line => line.trim());
                } else if (memoType === 'strategy') {
                    if (!item.structuredData) item.structuredData = {};
                    item.structuredData.strategyNotes = content;
                }
                
                // Auto-save to backend
                debounce(() => saveItemToDatabase(item), 2000)();
            }
        }

        async function saveItemToDatabase(item) {
            try {
                const response = await fetch(`${API_BASE_URL}/research/save-item`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(item)
                });

                if (response.ok) {
                    console.log('Item saved to database:', item.id);
                } else {
                    console.error('Failed to save item to database');
                }
            } catch (error) {
                console.error('Database save error:', error);
            }
        }

        async function runDetailedAIAnalysis(itemId) {
            const item = currentResults.find(item => item.id === itemId);
            if (!item) return;

            try {
                showLoading('詳細AI分析を実行中...');
                
                const enhancedAnalysis = await runSingleAIAnalysis(item);
                item.aiAnalysis = enhancedAnalysis;
                item.needsAIAnalysis = false;
                
                // Re-render the specific card
                renderResults(currentResults);
                
                showNotification('詳細AI分析が完了しました', 'success');
                
            } catch (error) {
                console.error('Detailed AI analysis error:', error);
                showNotification('詳細AI分析に失敗しました', 'error');
            } finally {
                hideLoading();
            }
        }

        async function findAllSuppliers(itemId) {
            const item = currentResults.find(item => item.id === itemId);
            if (!item) return;

            try {
                showLoading('仕入れ先を検索中...');
                
                const response = await fetch(`${AI_ANALYSIS_URL}/find-suppliers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        productData: item,
                        options: {
                            platforms: ['amazon', 'rakuten', 'mercari', 'yahoo']
                        }
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    displaySupplierResults(data.suppliers, item);
                    showNotification('仕入れ先検索が完了しました', 'success');
                } else {
                    throw new Error(data.message || '仕入れ先検索に失敗しました');
                }
                
            } catch (error) {
                console.error('Supplier search error:', error);
                showNotification('仕入れ先検索に失敗しました', 'error');
            } finally {
                hideLoading();
            }
        }

        function displaySupplierResults(suppliers, item) {
            // Create and show supplier modal or panel
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.7); z-index: 10000; display: flex;
                justify-content: center; align-items: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>仕入れ先検索結果: ${item.title}</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    <div>
                        ${suppliers.map(supplier => `
                            <div style="border: 1px solid var(--n3-border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <h4>${supplier.platform}</h4>
                                    <span style="color: var(--success-color); font-weight: 600;">¥${Math.round(supplier.price * 150).toLocaleString()}</span>
                                </div>
                                <p>${supplier.title}</p>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <span>在庫: ${supplier.availability}</span>
                                    <span>信頼度: ${Math.round(supplier.reliability * 100)}%</span>
                                    <button class="n3-btn n3-btn-primary" onclick="window.open('${supplier.url}', '_blank')">
                                        <i class="fas fa-external-link-alt"></i> 詳細を見る
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function openSupplier(url) {
            if (url && url !== '#') {
                window.open(url, '_blank');
            } else {
                showNotification('仕入れ先URLが利用できません', 'error');
            }
        }

        function saveSeller(sellerName, country) {
            let savedSellers = JSON.parse(localStorage.getItem('ebay-saved-sellers') || '[]');
            
            const seller = {
                id: Date.now(),
                name: sellerName,
                country: country,
                savedDate: new Date().toISOString().split('T')[0],
                notes: ''
            };

            savedSellers.push(seller);
            localStorage.setItem('ebay-saved-sellers', JSON.stringify(savedSellers));
            
            showNotification(`セラー「${sellerName}」を保存しました`, 'success');
        }

        // Enhanced Action Functions
        async function runBatchAIAnalysis() {
            const unanalyzedItems = currentResults.filter(item => item.needsAIAnalysis);
            
            if (unanalyzedItems.length === 0) {
                showNotification('すべての商品がAI分析済みです', 'info');
                return;
            }

            try {
                showLoading('一括AI分析を実行中...');
                
                const batchResponse = await fetch(`${AI_ANALYSIS_URL}/batch-analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        products: unanalyzedItems,
                        options: {
                            analysisTypes: ['demand', 'price', 'risk', 'matching', 'trend'],
                            maxConcurrency: 3
                        }
                    })
                });

                const data = await batchResponse.json();
                
                if (data.success) {
                    // Update results with AI analysis
                    data.data.batchResult.results.forEach(analysisResult => {
                        const item = currentResults.find(item => item.id === analysisResult.productId);
                        if (item) {
                            item.aiAnalysis = transformAIAnalysisResponse(analysisResult);
                            item.needsAIAnalysis = false;
                        }
                    });

                    renderResults(currentResults);
                    updateStats(currentResults);
                    
                    showNotification(`${data.data.batchResult.results.length}件の一括AI分析が完了しました`, 'success');
                } else {
                    throw new Error(data.message || '一括AI分析に失敗しました');
                }
                
            } catch (error) {
                console.error('Batch AI analysis error:', error);
                showNotification('一括AI分析に失敗しました', 'error');
            } finally {
                hideLoading();
            }
        }

        async function translateTitles() {
            if (currentResults.length === 0) {
                showNotification('翻訳するデータがありません', 'info');
                return;
            }

            try {
                showLoading('タイトルを翻訳中...');
                
                let translatedCount = 0;
                for (const item of currentResults) {
                    if (!item.titleJa) {
                        item.titleJa = await translateTitle(item.title);
                        translatedCount++;
                        updateLoadingMessage(`翻訳中... (${translatedCount}/${currentResults.length})`);
                        
                        // Small delay to prevent overwhelming the translation service
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                renderResults(currentResults);
                showNotification(`${translatedCount}件のタイトルを翻訳しました`, 'success');
                
            } catch (error) {
                console.error('Translation error:', error);
                showNotification('翻訳に失敗しました', 'error');
            } finally {
                hideLoading();
            }
        }

        function downloadEnhancedCSV() {
            if (currentResults.length === 0) {
                showNotification('出力するデータがありません', 'info');
                return;
            }

            const headers = [
                'タイトル', '日本語タイトル', 'ブランド', 'カテゴリー', '価格(USD)', '価格(JPY)', 
                'AI分析済み', 'AI推奨レベル', 'AI推奨理由', '無在庫適性', '最適タイミング', 'リスクレベル',
                '販売数', '閲覧数', 'ウォッチ数', '販売期間', 'セラー名', 'セラー国', '商品状態', 
                '出品日', 'URL', '一般メモ', '仕入れ先メモ', '戦略メモ'
            ];

            const csvContent = [
                headers.join(','),
                ...currentResults.map(item => {
                    const aiAnalysis = item.aiAnalysis || getDefaultAIAnalysis();
                    const hasAI = item.aiAnalysis && !item.needsAIAnalysis;
                    
                    return [
                        `"${item.title.replace(/"/g, '""')}"`,
                        `"${(item.titleJa || '').replace(/"/g, '""')}"`,
                        item.brand,
                        item.category,
                        item.price,
                        Math.round(item.jpyPrice),
                        hasAI ? 'はい' : 'いいえ',
                        aiAnalysis.purchaseRecommendation?.level || '',
                        `"${aiAnalysis.primaryReason.replace(/"/g, '""')}"`,
                        aiAnalysis.dropshippingFeasibility?.feasible ? 'はい' : 'いいえ',
                        `"${aiAnalysis.optimalTiming.replace(/"/g, '""')}"`,
                        aiAnalysis.riskLevel,
                        item.stats.sold,
                        item.stats.views,
                        item.stats.watchers,
                        item.stats.duration,
                        item.seller.name,
                        item.seller.country,
                        getConditionName(item.condition),
                        item.stats.listingDate,
                        item.url,
                        `"${(item.memo || '').replace(/"/g, '""')}"`,
                        `"${(item.structuredData?.supplierNotes?.join(';') || '').replace(/"/g, '""')}"`,
                        `"${(item.structuredData?.strategyNotes || '').replace(/"/g, '""')}"`,
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ebay_ai_research_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            showNotification('拡張CSVファイルをダウンロードしました', 'success');
        }

        function showFilters() {
            const filtersSection = document.getElementById('filters-section');
            filtersSection.classList.toggle('hidden');
        }

        function resetFilters() {
            document.querySelectorAll('#filters-section input, #filters-section select').forEach(input => {
                input.value = '';
            });
            if (currentResults.length > 0) {
                renderResults(currentResults);
                updateStats(currentResults);
            }
        }

        async function saveAllDataToDB() {
            if (currentResults.length === 0) {
                showNotification('保存するデータがありません', 'info');
                return;
            }

            try {
                showLoading('データベースに保存中...');
                
                const response = await fetch(`${API_BASE_URL}/research/save-batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        searchDate: new Date().toISOString(),
                        searchParams: getCurrentSearchParams(),
                        results: currentResults,
                        totalCount: currentResults.length
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showNotification(`${currentResults.length}件のデータを保存しました`, 'success');
                } else {
                    throw new Error(data.message || 'データ保存に失敗しました');
                }
                
            } catch (error) {
                console.error('Database save error:', error);
                showNotification('データベース保存に失敗しました', 'error');
            } finally {
                hideLoading();
            }
        }

        function applyAdvancedFilters() {
            if (currentResults.length === 0) return;

            let filteredResults = [...currentResults];

            // 閲覧数フィルター
            const viewsFilter = document.getElementById('filter-views').value;
            if (viewsFilter) {
                filteredResults = filteredResults.filter(item => item.stats.views >= parseInt(viewsFilter));
            }

            // ウォッチ数フィルター
            const watchersFilter = document.getElementById('filter-watchers').value;
            if (watchersFilter) {
                filteredResults = filteredResults.filter(item => item.stats.watchers >= parseInt(watchersFilter));
            }

            // AI推奨レベルフィルター
            const aiRecommendationFilter = document.getElementById('filter-ai-recommendation').value;
            if (aiRecommendationFilter) {
                filteredResults = filteredResults.filter(item => {
                    const aiRec = item.aiAnalysis?.purchaseRecommendation?.level;
                    return aiRec === aiRecommendationFilter;
                });
            }

            // 無在庫適性フィルター
            const dropshippingFilter = document.getElementById('filter-dropshipping').value;
            if (dropshippingFilter === 'suitable') {
                filteredResults = filteredResults.filter(item => 
                    item.aiAnalysis?.dropshippingFeasibility?.feasible === true
                );
            } else if (dropshippingFilter === 'not-suitable') {
                filteredResults = filteredResults.filter(item => 
                    item.aiAnalysis?.dropshippingFeasibility?.feasible === false
                );
            }

            // 仕入れ先可用性フィルター
            const supplierAvailabilityFilter = document.getElementById('filter-supplier-availability').value;
            if (supplierAvailabilityFilter) {
                filteredResults = filteredResults.filter(item => {
                    const suppliers = item.aiAnalysis?.topSuppliers || [];
                    return suppliers.some(s => s.availability === supplierAvailabilityFilter);
                });
            }

            // ブランドフィルター
            const brandFilter = document.getElementById('filter-brand').value.toLowerCase();
            if (brandFilter) {
                filteredResults = filteredResults.filter(item => 
                    item.brand.toLowerCase().includes(brandFilter) ||
                    item.title.toLowerCase().includes(brandFilter)
                );
            }

            renderResults(filteredResults);
            updateStats(filteredResults);
        }

        function handleKeyboardShortcuts(e) {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'Enter':
                        e.preventDefault();
                        const activeForm = document.querySelector('.search-form.active');
                        if (activeForm) {
                            activeForm.dispatchEvent(new Event('submit'));
                        }
                        break;
                    case 'd':
                        e.preventDefault();
                        downloadEnhancedCSV();
                        break;
                    case 'f':
                        e.preventDefault();
                        showFilters();
                        break;
                    case 's':
                        e.preventDefault();
                        saveAllDataToDB();
                        break;
                }
            }
        }

        function sortTable(columnName) {
            console.log(`テーブルソート: ${columnName}`);
            // 実装時には列ごとのソート機能を追加
        }

        // Debounce utility function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        console.log('🚀 Enhanced eBay AI Research Tool initialized successfully');
    </script>
</body>
</html>