import React, { useState, useEffect } from 'react';
import { ChevronRight, ChevronLeft, Plus, X, Upload, Save, Eye, ShoppingCart, Package, ImageIcon, DollarSign, Tag, Layers } from 'lucide-react';

const EbayListingTool = () => {
  const [currentStep, setCurrentStep] = useState(1);
  const [listingData, setListingData] = useState({
    category: null,
    basicInfo: {
      title: '',
      description: '',
      brand: '',
      basePrice: ''
    },
    variations: {
      axes: [],
      items: []
    },
    bundles: [],
    images: [],
    templates: []
  });

  // ã‚«ãƒ†ã‚´ãƒªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
  const categoryTemplates = {
    trading_cards: {
      name: 'ãƒˆãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰',
      icon: 'ğŸƒ',
      recommended_axes: [
        { 
          code: 'series', 
          name: 'ã‚·ãƒªãƒ¼ã‚º', 
          required: true, 
          type: 'select',
          default_values: ['VSTARãƒ¦ãƒ‹ãƒãƒ¼ã‚¹', 'æ—§è£é¢', 'ãƒã‚±ãƒ¢ãƒ³GO', 'ã‚¹ãƒšãƒ¼ã‚¹ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼']
        },
        { 
          code: 'condition', 
          name: 'çŠ¶æ…‹', 
          required: true, 
          type: 'select',
          default_values: ['ãƒŸãƒ³ãƒˆ', 'ãƒ‹ã‚¢ãƒŸãƒ³ãƒˆ', 'ã‚¨ã‚¯ã‚»ãƒ¬ãƒ³ãƒˆ', 'ãƒ™ãƒªãƒ¼ã‚°ãƒƒãƒ‰', 'ã‚°ãƒƒãƒ‰']
        },
        { 
          code: 'grading', 
          name: 'ã‚°ãƒ¬ãƒ¼ãƒ‰', 
          required: false, 
          type: 'select',
          default_values: ['PSA 10', 'PSA 9', 'BGS 9.5', 'æœªé‘‘å®š']
        },
        { 
          code: 'language', 
          name: 'è¨€èª', 
          required: false, 
          type: 'select',
          default_values: ['æ—¥æœ¬èª', 'è‹±èª', 'éŸ“å›½èª']
        }
      ],
      pricing_rules: {
        condition: { mint: 1.0, near_mint: 0.9, excellent: 0.8, very_good: 0.7, good: 0.6 },
        grading: { psa_10: 3.0, psa_9: 2.0, bgs_95: 2.5, ungraded: 1.0 },
        language: { japanese: 1.0, english: 1.2, korean: 0.8 }
      }
    },
    clothing: {
      name: 'ã‚¢ãƒ‘ãƒ¬ãƒ«',
      icon: 'ğŸ‘•',
      recommended_axes: [
        { 
          code: 'size', 
          name: 'ã‚µã‚¤ã‚º', 
          required: true, 
          type: 'select',
          default_values: ['XS', 'S', 'M', 'L', 'XL', 'XXL']
        },
        { 
          code: 'color', 
          name: 'ã‚«ãƒ©ãƒ¼', 
          required: true, 
          type: 'color',
          default_values: ['ãƒ›ãƒ¯ã‚¤ãƒˆ', 'ãƒ–ãƒ©ãƒƒã‚¯', 'ãƒ¬ãƒƒãƒ‰', 'ãƒ–ãƒ«ãƒ¼', 'ã‚°ãƒ¬ãƒ¼']
        },
        { 
          code: 'material', 
          name: 'ç´ æ', 
          required: false, 
          type: 'select',
          default_values: ['ã‚³ãƒƒãƒˆãƒ³100%', 'ãƒãƒªã‚¨ã‚¹ãƒ†ãƒ«', 'ç¶¿ãƒãƒªæ··åˆ']
        }
      ],
      pricing_rules: {
        size: { xs: 1.0, s: 1.0, m: 1.0, l: 1.0, xl: 1.1, xxl: 1.2 },
        color: { white: 1.0, black: 1.0, red: 1.05, blue: 1.05 }
      }
    },
    electronics: {
      name: 'é›»å­æ©Ÿå™¨',
      icon: 'ğŸ“±',
      recommended_axes: [
        { 
          code: 'capacity', 
          name: 'å®¹é‡', 
          required: true, 
          type: 'select',
          default_values: ['64GB', '128GB', '256GB', '512GB', '1TB']
        },
        { 
          code: 'color', 
          name: 'ã‚«ãƒ©ãƒ¼', 
          required: true, 
          type: 'select',
          default_values: ['ã‚¹ãƒšãƒ¼ã‚¹ã‚°ãƒ¬ã‚¤', 'ã‚·ãƒ«ãƒãƒ¼', 'ã‚´ãƒ¼ãƒ«ãƒ‰', 'ãƒ–ãƒ«ãƒ¼']
        },
        { 
          code: 'condition', 
          name: 'çŠ¶æ…‹', 
          required: true, 
          type: 'select',
          default_values: ['æ–°å“', 'ä¸­å¤ç¾å“', 'ä¸­å¤è‰¯å“', 'ä¸­å¤å¯']
        }
      ],
      pricing_rules: {
        capacity: { '64gb': 1.0, '128gb': 1.3, '256gb': 1.6, '512gb': 2.0, '1tb': 2.5 },
        condition: { new: 1.0, like_new: 0.9, very_good: 0.8, good: 0.7 }
      }
    }
  };

  // ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©
  const steps = [
    { id: 1, title: 'ã‚«ãƒ†ã‚´ãƒªé¸æŠ', icon: <Tag className="w-4 h-4" /> },
    { id: 2, title: 'åŸºæœ¬æƒ…å ±', icon: <ShoppingCart className="w-4 h-4" /> },
    { id: 3, title: 'ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³', icon: <Layers className="w-4 h-4" /> },
    { id: 4, title: 'ä¾¡æ ¼ãƒ»åœ¨åº«', icon: <DollarSign className="w-4 h-4" /> },
    { id: 5, title: 'ç”»åƒãƒ»èª¬æ˜', icon: <ImageIcon className="w-4 h-4" /> },
    { id: 6, title: 'ã‚»ãƒƒãƒˆå“', icon: <Package className="w-4 h-4" /> },
    { id: 7, title: 'ç¢ºèªãƒ»å‡ºå“', icon: <Eye className="w-4 h-4" /> }
  ];

  // ä¾¡æ ¼è¨ˆç®—é–¢æ•°
  const calculateVariationPrice = (basePrice, attributes, category) => {
    let price = parseFloat(basePrice) || 0;
    const rules = categoryTemplates[category]?.pricing_rules || {};
    
    Object.entries(attributes).forEach(([axis, value]) => {
      const axisRules = rules[axis] || {};
      const multiplier = axisRules[value.toLowerCase().replace(/\s+/g, '_')] || 1.0;
      price *= multiplier;
    });
    
    return Math.round(price);
  };

  // SKUç”Ÿæˆé–¢æ•°
  const generateSKU = (title, attributes) => {
    const titlePart = title.replace(/\s+/g, '').substring(0, 4).toUpperCase();
    const attrPart = Object.values(attributes).map(v => 
      v.replace(/\s+/g, '').substring(0, 2).toUpperCase()
    ).join('_');
    return `${titlePart}_${attrPart}`;
  };

  // ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³çµ„ã¿åˆã‚ã›ç”Ÿæˆ
  const generateVariationCombinations = (axes) => {
    if (axes.length === 0 || axes.some(axis => axis.values.length === 0)) {
      return [];
    }

    const combinations = axes.reduce((acc, axis) => {
      if (acc.length === 0) {
        return axis.values.map(value => ({ [axis.code]: value }));
      }
      
      const newCombinations = [];
      acc.forEach(combo => {
        axis.values.forEach(value => {
          newCombinations.push({ ...combo, [axis.code]: value });
        });
      });
      return newCombinations;
    }, []);

    return combinations.map((combo, index) => ({
      id: `var_${index}`,
      attributes: combo,
      displayName: Object.values(combo).join(' / '),
      sku: generateSKU(listingData.basicInfo.title, combo),
      price: calculateVariationPrice(listingData.basicInfo.basePrice, combo, listingData.category),
      quantity: 0,
      images: []
    }));
  };

  // ã‚¹ãƒ†ãƒƒãƒ—1: ã‚«ãƒ†ã‚´ãƒªé¸æŠ
  const CategorySelectionStep = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold text-gray-800">å•†å“ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        {Object.entries(categoryTemplates).map(([code, template]) => (
          <div
            key={code}
            className={`p-6 border-2 rounded-lg cursor-pointer transition-all hover:shadow-lg ${
              listingData.category === code 
                ? 'border-blue-500 bg-blue-50' 
                : 'border-gray-200 hover:border-gray-300'
            }`}
            onClick={() => setListingData({...listingData, category: code})}
          >
            <div className="text-center">
              <div className="text-4xl mb-3">{template.icon}</div>
              <h3 className="text-lg font-semibold">{template.name}</h3>
              <p className="text-sm text-gray-600 mt-2">
                æ¨å¥¨è»¸: {template.recommended_axes.length}å€‹
              </p>
            </div>
          </div>
        ))}
      </div>

      {listingData.category && (
        <div className="bg-blue-50 p-4 rounded-lg">
          <h3 className="font-semibold mb-2">
            {categoryTemplates[listingData.category].name} ã®æ¨å¥¨ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³
          </h3>
          <div className="flex flex-wrap gap-2">
            {categoryTemplates[listingData.category].recommended_axes.map(axis => (
              <span key={axis.code} className={`px-3 py-1 rounded text-sm ${
                axis.required ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'
              }`}>
                {axis.name} {axis.required && '(å¿…é ˆ)'}
              </span>
            ))}
          </div>
        </div>
      )}
    </div>
  );

  // ã‚¹ãƒ†ãƒƒãƒ—2: åŸºæœ¬æƒ…å ±
  const BasicInfoStep = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold text-gray-800">åŸºæœ¬æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            å•†å“ã‚¿ã‚¤ãƒˆãƒ« *
          </label>
          <input
            type="text"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={listingData.basicInfo.title}
            onChange={(e) => setListingData({
              ...listingData,
              basicInfo: {...listingData.basicInfo, title: e.target.value}
            })}
            placeholder="ä¾‹: ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰ ãƒªã‚¶ãƒ¼ãƒ‰ãƒ³"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            ãƒ–ãƒ©ãƒ³ãƒ‰
          </label>
          <input
            type="text"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={listingData.basicInfo.brand}
            onChange={(e) => setListingData({
              ...listingData,
              basicInfo: {...listingData.basicInfo, brand: e.target.value}
            })}
            placeholder="ä¾‹: ãƒã‚±ãƒ¢ãƒ³"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            åŸºæº–ä¾¡æ ¼ (å††) *
          </label>
          <input
            type="number"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={listingData.basicInfo.basePrice}
            onChange={(e) => setListingData({
              ...listingData,
              basicInfo: {...listingData.basicInfo, basePrice: e.target.value}
            })}
            placeholder="ä¾‹: 5000"
          />
        </div>

        <div className="md:col-span-2">
          <label className="block text-sm font-medium text-gray-700 mb-2">
            å•†å“èª¬æ˜
          </label>
          <textarea
            rows={4}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={listingData.basicInfo.description}
            onChange={(e) => setListingData({
              ...listingData,
              basicInfo: {...listingData.basicInfo, description: e.target.value}
            })}
            placeholder="å•†å“ã®è©³ç´°èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
          />
        </div>
      </div>
    </div>
  );

  // ã‚¹ãƒ†ãƒƒãƒ—3: ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
  const VariationSetupStep = () => {
    const [activeAxes, setActiveAxes] = useState(listingData.variations.axes || []);
    const categoryTemplate = categoryTemplates[listingData.category];

    const addAxis = (axisTemplate) => {
      const newAxis = {
        ...axisTemplate,
        id: Date.now(),
        values: axisTemplate.default_values || []
      };
      const updatedAxes = [...activeAxes, newAxis];
      setActiveAxes(updatedAxes);
      
      // ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³é …ç›®ã‚’ç”Ÿæˆ
      const combinations = generateVariationCombinations(updatedAxes);
      setListingData({
        ...listingData,
        variations: {
          axes: updatedAxes,
          items: combinations
        }
      });
    };

    const removeAxis = (axisId) => {
      const updatedAxes = activeAxes.filter(axis => axis.id !== axisId);
      setActiveAxes(updatedAxes);
      
      const combinations = generateVariationCombinations(updatedAxes);
      setListingData({
        ...listingData,
        variations: {
          axes: updatedAxes,
          items: combinations
        }
      });
    };

    const updateAxisValues = (axisId, newValues) => {
      const updatedAxes = activeAxes.map(axis => 
        axis.id === axisId ? {...axis, values: newValues} : axis
      );
      setActiveAxes(updatedAxes);
      
      const combinations = generateVariationCombinations(updatedAxes);
      setListingData({
        ...listingData,
        variations: {
          axes: updatedAxes,
          items: combinations
        }
      });
    };

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-800">ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã—ã¦ãã ã•ã„</h2>
        
        {/* æ¨å¥¨è»¸ */}
        <div>
          <h3 className="text-lg font-semibold mb-3">æ¨å¥¨ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è»¸</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            {categoryTemplate?.recommended_axes.map(axis => {
              const isActive = activeAxes.some(active => active.code === axis.code);
              return (
                <button
                  key={axis.code}
                  className={`p-3 border rounded-md text-left transition-colors ${
                    isActive 
                      ? 'bg-green-50 border-green-500 text-green-800' 
                      : 'bg-white border-gray-300 hover:border-blue-500'
                  }`}
                  onClick={() => !isActive && addAxis(axis)}
                  disabled={isActive}
                >
                  <div className="font-medium">{axis.name}</div>
                  <div className="text-sm text-gray-600">
                    {axis.required && 'å¿…é ˆ â€¢ '}
                    ä¾‹: {axis.default_values?.slice(0, 2).join(', ')}
                  </div>
                </button>
              );
            })}
          </div>
        </div>

        {/* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè»¸ã®ç·¨é›† */}
        {activeAxes.length > 0 && (
          <div>
            <h3 className="text-lg font-semibold mb-3">è¨­å®šä¸­ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è»¸</h3>
            {activeAxes.map(axis => (
              <AxisEditor
                key={axis.id}
                axis={axis}
                onValuesChange={(values) => updateAxisValues(axis.id, values)}
                onRemove={() => removeAxis(axis.id)}
              />
            ))}
          </div>
        )}

        {/* ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ */}
        {listingData.variations.items.length > 0 && (
          <div>
            <h3 className="text-lg font-semibold mb-3">
              ç”Ÿæˆã•ã‚ŒãŸãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ ({listingData.variations.items.length}å€‹)
            </h3>
            <div className="bg-gray-50 p-4 rounded-lg max-h-60 overflow-y-auto">
              {listingData.variations.items.map(item => (
                <div key={item.id} className="flex justify-between items-center py-2 border-b last:border-b-0">
                  <span className="font-medium">{item.displayName}</span>
                  <div className="text-right">
                    <div className="text-sm text-gray-600">SKU: {item.sku}</div>
                    <div className="font-semibold">Â¥{item.price.toLocaleString()}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    );
  };

  // è»¸ã‚¨ãƒ‡ã‚£ã‚¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
  const AxisEditor = ({ axis, onValuesChange, onRemove }) => {
    const [values, setValues] = useState(axis.values || []);
    const [newValue, setNewValue] = useState('');

    const addValue = () => {
      if (newValue.trim()) {
        const updatedValues = [...values, newValue.trim()];
        setValues(updatedValues);
        onValuesChange(updatedValues);
        setNewValue('');
      }
    };

    const removeValue = (index) => {
      const updatedValues = values.filter((_, i) => i !== index);
      setValues(updatedValues);
      onValuesChange(updatedValues);
    };

    return (
      <div className="border border-gray-200 rounded-lg p-4 mb-4">
        <div className="flex justify-between items-center mb-3">
          <h4 className="font-semibold">{axis.name}</h4>
          {!axis.required && (
            <button
              onClick={onRemove}
              className="text-red-500 hover:text-red-700"
            >
              <X className="w-4 h-4" />
            </button>
          )}
        </div>

        <div className="space-y-2">
          <div className="flex flex-wrap gap-2">
            {values.map((value, index) => (
              <span
                key={index}
                className="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm"
              >
                {value}
                <button
                  onClick={() => removeValue(index)}
                  className="hover:text-blue-600"
                >
                  <X className="w-3 h-3" />
                </button>
              </span>
            ))}
          </div>

          <div className="flex gap-2">
            <input
              type="text"
              value={newValue}
              onChange={(e) => setNewValue(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && addValue()}
              className="flex-1 px-3 py-1 border border-gray-300 rounded text-sm"
              placeholder="æ–°ã—ã„å€¤ã‚’è¿½åŠ ..."
            />
            <button
              onClick={addValue}
              className="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600"
            >
              è¿½åŠ 
            </button>
          </div>
        </div>
      </div>
    );
  };

  // ã‚¹ãƒ†ãƒƒãƒ—4: ä¾¡æ ¼ãƒ»åœ¨åº«è¨­å®š
  const PricingInventoryStep = () => {
    const updateVariationItem = (itemId, field, value) => {
      const updatedItems = listingData.variations.items.map(item =>
        item.id === itemId ? { ...item, [field]: value } : item
      );
      setListingData({
        ...listingData,
        variations: { ...listingData.variations, items: updatedItems }
      });
    };

    const setBulkQuantity = (quantity) => {
      const updatedItems = listingData.variations.items.map(item => ({
        ...item,
        quantity: parseInt(quantity) || 0
      }));
      setListingData({
        ...listingData,
        variations: { ...listingData.variations, items: updatedItems }
      });
    };

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-800">ä¾¡æ ¼ã¨åœ¨åº«ã‚’è¨­å®šã—ã¦ãã ã•ã„</h2>
        
        {/* ä¸€æ‹¬è¨­å®š */}
        <div className="bg-blue-50 p-4 rounded-lg">
          <h3 className="font-semibold mb-3">ä¸€æ‹¬è¨­å®š</h3>
          <div className="flex gap-4">
            <button
              onClick={() => setBulkQuantity(10)}
              className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >
              å…¨ã¦åœ¨åº«10ã«è¨­å®š
            </button>
            <button
              onClick={() => setBulkQuantity(5)}
              className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
            >
              å…¨ã¦åœ¨åº«5ã«è¨­å®š
            </button>
          </div>
        </div>

        {/* ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³åˆ¥è¨­å®š */}
        <div className="space-y-3">
          {listingData.variations.items.map(item => (
            <div key={item.id} className="flex items-center gap-4 p-4 border border-gray-200 rounded-lg">
              <div className="flex-1">
                <div className="font-medium">{item.displayName}</div>
                <div className="text-sm text-gray-600">SKU: {item.sku}</div>
              </div>
              
              <div className="flex items-center gap-2">
                <label className="text-sm">ä¾¡æ ¼:</label>
                <input
                  type="number"
                  value={item.price}
                  onChange={(e) => updateVariationItem(item.id, 'price', parseInt(e.target.value))}
                  className="w-24 px-2 py-1 border border-gray-300 rounded text-sm"
                />
                <span className="text-sm">å††</span>
              </div>
              
              <div className="flex items-center gap-2">
                <label className="text-sm">åœ¨åº«:</label>
                <input
                  type="number"
                  value={item.quantity}
                  onChange={(e) => updateVariationItem(item.id, 'quantity', parseInt(e.target.value))}
                  className="w-16 px-2 py-1 border border-gray-300 rounded text-sm"
                />
                <span className="text-sm">å€‹</span>
              </div>
            </div>
          ))}
        </div>

        {/* çµ±è¨ˆ */}
        <div className="grid grid-cols-3 gap-4 bg-gray-50 p-4 rounded-lg">
          <div className="text-center">
            <div className="text-2xl font-bold text-blue-600">
              {listingData.variations.items.length}
            </div>
            <div className="text-sm text-gray-600">ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æ•°</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold text-green-600">
              {listingData.variations.items.reduce((sum, item) => sum + (item.quantity || 0), 0)}
            </div>
            <div className="text-sm text-gray-600">ç·åœ¨åº«æ•°</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold text-purple-600">
              Â¥{Math.round(listingData.variations.items.reduce((sum, item) => sum + (item.price || 0), 0) / listingData.variations.items.length || 0).toLocaleString()}
            </div>
            <div className="text-sm text-gray-600">å¹³å‡ä¾¡æ ¼</div>
          </div>
        </div>
      </div>
    );
  };

  // ã‚¹ãƒ†ãƒƒãƒ—5: ç”»åƒãƒ»èª¬æ˜
  const ImageDescriptionStep = () => {
    const [images, setImages] = useState(listingData.images || []);

    const addImage = () => {
      const newImage = {
        id: Date.now(),
        url: `https://via.placeholder.com/300x300?text=å•†å“ç”»åƒ${images.length + 1}`,
        alt: `å•†å“ç”»åƒ${images.length + 1}`
      };
      const updatedImages = [...images, newImage];
      setImages(updatedImages);
      setListingData({ ...listingData, images: updatedImages });
    };

    const removeImage = (imageId) => {
      const updatedImages = images.filter(img => img.id !== imageId);
      setImages(updatedImages);
      setListingData({ ...listingData, images: updatedImages });
    };

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-800">ç”»åƒã¨èª¬æ˜ã‚’è¨­å®šã—ã¦ãã ã•ã„</h2>
        
        {/* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */}
        <div>
          <h3 className="text-lg font-semibold mb-3">å•†å“ç”»åƒ</h3>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {images.map(image => (
              <div key={image.id} className="relative group">
                <img
                  src={image.url}
                  alt={image.alt}
                  className="w-full h-32 object-cover border border-gray-300 rounded-lg"
                />
                <button
                  onClick={() => removeImage(image.id)}
                  className="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  <X className="w-4 h-4" />
                </button>
              </div>
            ))}
            
            <button
              onClick={addImage}
              className="w-full h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center hover:border-blue-500 transition-colors"
            >
              <div className="text-center text-gray-500">
                <Upload className="w-8 h-8 mx-auto mb-2" />
                <div className="text-sm">ç”»åƒã‚’è¿½åŠ </div>
              </div>
            </button>
          </div>
        </div>

        {/* èª¬æ˜æ–‡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ */}
        <div>
          <h3 className="text-lg font-semibold mb-3">å•†å“èª¬æ˜ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button className="p-4 border border-gray-300 rounded-lg text-left hover:border-blue-500">
              <div className="font-medium">åŸºæœ¬ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>
              <div className="text-sm text-gray-600">å•†å“ã®åŸºæœ¬æƒ…å ±ã‚’å«ã‚€æ¨™æº–çš„ãªèª¬æ˜æ–‡</div>
            </button>
            <button className="p-4 border border-gray-300 rounded-lg text-left hover:border-blue-500">
              <div className="font-medium">è©³ç´°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>
              <div className="text-sm text-gray-600">è©³ç´°ãªå•†å“èª¬æ˜ã¨ã‚¹ãƒšãƒƒã‚¯æƒ…å ±</div>
            </button>
          </div>
        </div>

        {/* èª¬æ˜æ–‡ç·¨é›† */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            eBayå•†å“èª¬æ˜æ–‡
          </label>
          <textarea
            rows={8}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={listingData.basicInfo.description}
            onChange={(e) => setListingData({
              ...listingData,
              basicInfo: { ...listingData.basicInfo, description: e.target.value }
            })}
            placeholder="eBayã«è¡¨ç¤ºã•ã‚Œã‚‹å•†å“èª¬æ˜æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
          />
        </div>
      </div>
    );
  };

  // ã‚¹ãƒ†ãƒƒãƒ—6: ã‚»ãƒƒãƒˆå“è¨­å®š
  const BundleSetupStep = () => {
    const [bundles, setBundles] = useState(listingData.bundles || []);
    const [newBundle, setNewBundle] = useState({
      name: '',
      description: '',
      components: [],
      discountRate: 10
    });

    const addBundle = () => {
      if (newBundle.name) {
        const bundle = {
          ...newBundle,
          id: Date.now(),
          price: calculateBundlePrice()
        };
        const updatedBundles = [...bundles, bundle];
        setBundles(updatedBundles);
        setListingData({ ...listingData, bundles: updatedBundles });
        setNewBundle({ name: '', description: '', components: [], discountRate: 10 });
      }
    };

    const calculateBundlePrice = () => {
      const totalPrice = newBundle.components.reduce((sum, comp) => {
        const item = listingData.variations.items.find(v => v.id === comp.itemId);
        return sum + (item?.price || 0) * comp.quantity;
      }, 0);
      return Math.round(totalPrice * (1 - newBundle.discountRate / 100));
    };

    const addComponentToBundle = (itemId) => {
      const existingComp = newBundle.components.find(c => c.itemId === itemId);
      if (existingComp) {
        setNewBundle({
          ...newBundle,
          components: newBundle.components.map(c =>
            c.itemId === itemId ? { ...c, quantity: c.quantity + 1 } : c
          )
        });
      } else {
        setNewBundle({
          ...newBundle,
          components: [...newBundle.components, { itemId, quantity: 1 }]
        });
      }
    };

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-800">ã‚»ãƒƒãƒˆå“ã‚’ä½œæˆã—ã¦ãã ã•ã„</h2>
        
        {/* æ–°è¦ã‚»ãƒƒãƒˆå“ä½œæˆ */}
        <div className="border border-gray-300 rounded-lg p-6">
          <h3 className="text-lg font-semibold mb-4">æ–°ã—ã„ã‚»ãƒƒãƒˆå“</h3>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                ã‚»ãƒƒãƒˆå“å
              </label>
              <input
                type="text"
                value={newBundle.name}
                onChange={(e) => setNewBundle({ ...newBundle, name: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-md"
                placeholder="ä¾‹: ãƒªã‚¶ãƒ¼ãƒ‰ãƒ³ã‚»ãƒƒãƒˆ"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                å‰²å¼•ç‡ (%)
              </label>
              <input
                type="number"
                value={newBundle.discountRate}
                onChange={(e) => setNewBundle({ ...newBundle, discountRate: parseInt(e.target.value) })}
                className="w-full px-3 py-2 border border-gray-300 rounded-md"
                placeholder="10"
              />
            </div>
          </div>

          {/* å•†å“é¸æŠ */}
          <div className="mb-4">
            <h4 className="font-medium mb-2">æ§‹æˆå•†å“ã‚’é¸æŠ</h4>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-40 overflow-y-auto">
              {listingData.variations.items.map(item => (
                <button
                  key={item.id}
                  onClick={() => addComponentToBundle(item.id)}
                  className="text-left p-2 border border-gray-200 rounded hover:bg-blue-50"
                >
                  <div className="font-medium text-sm">{item.displayName}</div>
                  <div className="text-xs text-gray-600">Â¥{item.price?.toLocaleString()}</div>
                </button>
              ))}
            </div>
          </div>

          {/* é¸æŠæ¸ˆã¿å•†å“ */}
          {newBundle.components.length > 0 && (
            <div className="mb-4">
              <h4 className="font-medium mb-2">é¸æŠæ¸ˆã¿å•†å“</h4>
              <div className="space-y-2">
                {newBundle.components.map(comp => {
                  const item = listingData.variations.items.find(v => v.id === comp.itemId);
                  return (
                    <div key={comp.itemId} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                      <span className="text-sm">{item?.displayName} Ã— {comp.quantity}</span>
                      <span className="text-sm font-medium">Â¥{((item?.price || 0) * comp.quantity).toLocaleString()}</span>
                    </div>
                  );
                })}
                <div className="border-t pt-2">
                  <div className="flex justify-between items-center font-semibold">
                    <span>ã‚»ãƒƒãƒˆä¾¡æ ¼ ({newBundle.discountRate}% å‰²å¼•)</span>
                    <span className="text-green-600">Â¥{calculateBundlePrice().toLocaleString()}</span>
                  </div>
                </div>
              </div>
            </div>
          )}

          <button
            onClick={addBundle}
            disabled={!newBundle.name || newBundle.components.length === 0}
            className="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300"
          >
            ã‚»ãƒƒãƒˆå“ã‚’è¿½åŠ 
          </button>
        </div>

        {/* ä½œæˆæ¸ˆã¿ã‚»ãƒƒãƒˆå“ */}
        {bundles.length > 0 && (
          <div>
            <h3 className="text-lg font-semibold mb-3">ä½œæˆæ¸ˆã¿ã‚»ãƒƒãƒˆå“</h3>
            <div className="space-y-3">
              {bundles.map(bundle => (
                <div key={bundle.id} className="border border-gray-200 rounded-lg p-4">
                  <div className="flex justify-between items-start mb-2">
                    <h4 className="font-semibold">{bundle.name}</h4>
                    <span className="text-lg font-bold text-green-600">Â¥{bundle.price?.toLocaleString()}</span>
                  </div>
                  <div className="text-sm text-gray-600">
                    {bundle.components.length}å€‹ã®å•†å“, {bundle.discountRate}% å‰²å¼•
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    );
  };

  // ã‚¹ãƒ†ãƒƒãƒ—7: ç¢ºèªãƒ»å‡ºå“
  const ReviewSubmitStep = () => {
    const handleSubmit = async () => {
      // å®Ÿéš›ã®APIå‘¼ã³å‡ºã—å‡¦ç†ã‚’ã“ã“ã«å®Ÿè£…
      alert('å‡ºå“ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ä¸­...');
      
      // ãƒ‡ãƒ¢ç”¨ã®é…å»¶
      setTimeout(() => {
        alert('eBayã¸ã®å‡ºå“ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
      }, 2000);
    };

    const totalInventory = listingData.variations.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
    const avgPrice = listingData.variations.items.length > 0 
      ? Math.round(listingData.variations.items.reduce((sum, item) => sum + (item.price || 0), 0) / listingData.variations.items.length)
      : 0;

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-800">å‡ºå“å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„</h2>
        
        {/* åŸºæœ¬æƒ…å ±ã‚µãƒãƒªãƒ¼ */}
        <div className="bg-white border border-gray-200 rounded-lg p-6">
          <h3 className="text-lg font-semibold mb-4">åŸºæœ¬æƒ…å ±</h3>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <span className="text-sm text-gray-600">å•†å“ã‚¿ã‚¤ãƒˆãƒ«:</span>
              <div className="font-medium">{listingData.basicInfo.title}</div>
            </div>
            <div>
              <span className="text-sm text-gray-600">ã‚«ãƒ†ã‚´ãƒª:</span>
              <div className="font-medium">{categoryTemplates[listingData.category]?.name}</div>
            </div>
            <div>
              <span className="text-sm text-gray-600">ãƒ–ãƒ©ãƒ³ãƒ‰:</span>
              <div className="font-medium">{listingData.basicInfo.brand || 'æœªè¨­å®š'}</div>
            </div>
            <div>
              <span className="text-sm text-gray-600">åŸºæº–ä¾¡æ ¼:</span>
              <div className="font-medium">Â¥{parseInt(listingData.basicInfo.basePrice || 0).toLocaleString()}</div>
            </div>
          </div>
        </div>

        {/* ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³çµ±è¨ˆ */}
        <div className="grid grid-cols-3 gap-4">
          <div className="bg-blue-50 p-4 rounded-lg text-center">
            <div className="text-2xl font-bold text-blue-600">{listingData.variations.items.length}</div>
            <div className="text-sm text-blue-800">ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æ•°</div>
          </div>
          <div className="bg-green-50 p-4 rounded-lg text-center">
            <div className="text-2xl font-bold text-green-600">{totalInventory}</div>
            <div className="text-sm text-green-800">ç·åœ¨åº«æ•°</div>
          </div>
          <div className="bg-purple-50 p-4 rounded-lg text-center">
            <div className="text-2xl font-bold text-purple-600">Â¥{avgPrice.toLocaleString()}</div>
            <div className="text-sm text-purple-800">å¹³å‡ä¾¡æ ¼</div>
          </div>
        </div>

        {/* ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ */}
        <div className="bg-white border border-gray-200 rounded-lg p-6">
          <h3 className="text-lg font-semibold mb-4">ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§</h3>
          <div className="max-h-60 overflow-y-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b">
                  <th className="text-left py-2">ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³</th>
                  <th className="text-left py-2">SKU</th>
                  <th className="text-right py-2">ä¾¡æ ¼</th>
                  <th className="text-right py-2">åœ¨åº«</th>
                </tr>
              </thead>
              <tbody>
                {listingData.variations.items.map(item => (
                  <tr key={item.id} className="border-b">
                    <td className="py-2">{item.displayName}</td>
                    <td className="py-2 text-gray-600">{item.sku}</td>
                    <td className="py-2 text-right font-medium">Â¥{item.price?.toLocaleString()}</td>
                    <td className="py-2 text-right">{item.quantity}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        {/* ã‚»ãƒƒãƒˆå“ã‚µãƒãƒªãƒ¼ */}
        {listingData.bundles.length > 0 && (
          <div className="bg-white border border-gray-200 rounded-lg p-6">
            <h3 className="text-lg font-semibold mb-4">ã‚»ãƒƒãƒˆå“ ({listingData.bundles.length}å€‹)</h3>
            <div className="space-y-2">
              {listingData.bundles.map(bundle => (
                <div key={bundle.id} className="flex justify-between items-center p-3 bg-gray-50 rounded">
                  <span className="font-medium">{bundle.name}</span>
                  <span className="text-green-600 font-semibold">Â¥{bundle.price?.toLocaleString()}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* å‡ºå“ãƒœã‚¿ãƒ³ */}
        <div className="flex gap-4">
          <button className="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
            <Save className="w-5 h-5 inline mr-2" />
            ä¸‹æ›¸ãä¿å­˜
          </button>
          <button 
            onClick={handleSubmit}
            className="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
          >
            <Upload className="w-5 h-5 inline mr-2" />
            eBayã«å‡ºå“
          </button>
        </div>
      </div>
    );
  };

  // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
  const canProceed = () => {
    switch(currentStep) {
      case 1: return !!listingData.category;
      case 2: return listingData.basicInfo.title && listingData.basicInfo.basePrice;
      case 3: return listingData.variations.items.length > 0;
      case 4: return listingData.variations.items.every(item => item.quantity >= 0);
      default: return true;
    }
  };

  // ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒ¼
  return (
    <div className="max-w-6xl mx-auto p-6 bg-gray-50 min-h-screen">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h1 className="text-3xl font-bold text-gray-800 mb-2">eBayå‡ºå“ãƒ„ãƒ¼ãƒ«</h1>
        <p className="text-gray-600">ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚»ãƒƒãƒˆå“å¯¾å¿œã®ç·åˆå‡ºå“ã‚·ã‚¹ãƒ†ãƒ </p>
      </div>

      {/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */}
      <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div className="flex items-center justify-between">
          {steps.map((step, index) => (
            <div key={step.id} className="flex items-center">
              <div className={`flex items-center justify-center w-10 h-10 rounded-full border-2 ${
                currentStep >= step.id 
                  ? 'bg-blue-500 border-blue-500 text-white' 
                  : 'border-gray-300 text-gray-400'
              }`}>
                {step.icon}
              </div>
              <div className="ml-2 hidden md:block">
                <div className={`text-sm font-medium ${
                  currentStep >= step.id ? 'text-blue-600' : 'text-gray-400'
                }`}>
                  {step.title}
                </div>
              </div>
              {index < steps.length - 1 && (
                <ChevronRight className="w-5 h-5 text-gray-400 mx-4" />
              )}
            </div>
          ))}
        </div>
      </div>

      {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
        {currentStep === 1 && <CategorySelectionStep />}
        {currentStep === 2 && <BasicInfoStep />}
        {currentStep === 3 && <VariationSetupStep />}
        {currentStep === 4 && <PricingInventoryStep />}
        {currentStep === 5 && <ImageDescriptionStep />}
        {currentStep === 6 && <BundleSetupStep />}
        {currentStep === 7 && <ReviewSubmitStep />}
      </div>

      {/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */}
      <div className="flex justify-between">
        <button
          onClick={() => setCurrentStep(Math.max(1, currentStep - 1))}
          disabled={currentStep === 1}
          className="flex items-center px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <ChevronLeft className="w-5 h-5 mr-2" />
          æˆ»ã‚‹
        </button>
        
        <button
          onClick={() => setCurrentStep(Math.min(7, currentStep + 1))}
          disabled={currentStep === 7 || !canProceed()}
          className="flex items-center px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          æ¬¡ã¸
          <ChevronRight className="w-5 h-5 ml-2" />
        </button>
      </div>
    </div>
  );
};

export default EbayListingTool;