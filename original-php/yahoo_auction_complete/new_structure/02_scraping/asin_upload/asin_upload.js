
// CAIDS timeout_management Hook
// CAIDS timeout_management Hook - Âü∫Êú¨ÂÆüË£Ö
console.log('‚úÖ timeout_management Hook loaded');

// CAIDS processing_capacity_monitoring Hook
// CAIDS processing_capacity_monitoring Hook - Âü∫Êú¨ÂÆüË£Ö
console.log('‚úÖ processing_capacity_monitoring Hook loaded');

// CAIDS character_limit Hook
// CAIDS character_limit Hook - Âü∫Êú¨ÂÆüË£Ö
console.log('‚úÖ character_limit Hook loaded');

// CAIDS error_handling Hook

// CAIDS „Ç®„É©„ÉºÂá¶ÁêÜHook - ÂÆåÂÖ®ÂÆüË£Ö
window.CAIDS_ERROR_HANDLER = {
    isActive: true,
    errorCount: 0,
    errorHistory: [],
    
    initialize: function() {
        this.setupGlobalErrorHandler();
        this.setupUnhandledPromiseRejection();
        this.setupNetworkErrorHandler();
        console.log('‚ö†Ô∏è CAIDS „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†ÂÆåÂÖ®ÂàùÊúüÂåñ');
    },
    
    setupGlobalErrorHandler: function() {
        window.addEventListener('error', (event) => {
            this.handleError({
                type: 'JavaScript Error',
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack
            });
        });
    },
    
    setupUnhandledPromiseRejection: function() {
        window.addEventListener('unhandledrejection', (event) => {
            this.handleError({
                type: 'Unhandled Promise Rejection',
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack
            });
        });
    },
    
    setupNetworkErrorHandler: function() {
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                if (!response.ok) {
                    window.CAIDS_ERROR_HANDLER.handleError({
                        type: 'Network Error',
                        message: `HTTP ${response.status}: ${response.statusText}`,
                        url: args[0]
                    });
                }
                return response;
            } catch (error) {
                window.CAIDS_ERROR_HANDLER.handleError({
                    type: 'Network Fetch Error',
                    message: error.message,
                    url: args[0]
                });
                throw error;
            }
        };
    },
    
    handleError: function(errorInfo) {
        this.errorCount++;
        this.errorHistory.push({...errorInfo, timestamp: new Date().toISOString()});
        
        console.error('üö® CAIDS Error Handler:', errorInfo);
        this.showErrorNotification(errorInfo);
        this.reportError(errorInfo);
    },
    
    showErrorNotification: function(errorInfo) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 10px; right: 10px; z-index: 999999;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 350px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            border: 2px solid #ff6666; animation: caids-error-shake 0.5s ease-in-out;
        `;
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">üö®</span>
                <div>
                    <strong>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</strong><br>
                    <small style="opacity: 0.9;">${errorInfo.type}: ${errorInfo.message}</small>
                </div>
            </div>
        `;
        
        // CSS Animation
        if (!document.getElementById('caids-error-styles')) {
            const style = document.createElement('style');
            style.id = 'caids-error-styles';
            style.textContent = `
                @keyframes caids-error-shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 7000);
    },
    
    reportError: function(errorInfo) {
        // „Ç®„É©„Éº„É¨„Éù„Éº„ÉàÁîüÊàê„ÉªÈÄÅ‰ø°ÔºàÂ∞ÜÊù•„ÅÆÊã°ÂºµÁî®Ôºâ
        const report = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            errorCount: this.errorCount,
            sessionId: this.getSessionId(),
            ...errorInfo
        };
        
        console.log('üìã CAIDS Error Report:', report);
        localStorage.setItem('caids_last_error', JSON.stringify(report));
    },
    
    getSessionId: function() {
        let sessionId = sessionStorage.getItem('caids_session_id');
        if (!sessionId) {
            sessionId = 'caids_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('caids_session_id', sessionId);
        }
        return sessionId;
    },
    
    getErrorStats: function() {
        return {
            totalErrors: this.errorCount,
            recentErrors: this.errorHistory.slice(-10),
            sessionId: this.getSessionId()
        };
    }
};

window.CAIDS_ERROR_HANDLER.initialize();

console.log("üöÄ ASIN/URL„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ∞ÇÁî®JavaScriptÈñãÂßã");

// ===== „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ =====
let asinUploadData = {
    processedItems: [],
    currentFile: null,
    isProcessing: false
};

// ===== DOMContentLoadedÊôÇ„ÅÆÂàùÊúüÂåñ =====
document.addEventListener("DOMContentLoaded", function () {
    console.log("‚úÖ ASIN/URL„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü");

    // ===== „Çø„ÉñÂàá„ÇäÊõø„ÅàÊ©üËÉΩ =====
    initializeTabs();
    
    // ===== „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ©üËÉΩ =====
    initializeFileUpload();
    
    // ===== ÊâãÂãïÂÖ•ÂäõÊ©üËÉΩ =====
    initializeManualInput();
    
    // ===== ‰∏ÄÊã¨ÂÖ•ÂäõÊ©üËÉΩ =====
    initializeBulkInput();
    
    // ===== „Åù„ÅÆ‰ªñ„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö =====
    initializeOtherEvents();
    
    console.log("‚úÖ ASIN/URL„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂàùÊúüÂåñÂÆå‰∫Ü");
});

// ===== „Çø„ÉñÂàá„ÇäÊõø„ÅàÊ©üËÉΩ =====
function initializeTabs() {
    const tabButtons = document.querySelectorAll('.asin-upload__tab-button');
    const tabContents = document.querySelectorAll('.asin-upload__tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Éú„Çø„É≥„Åã„Çâ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÇØ„É©„Çπ„ÇíÂâäÈô§
            tabButtons.forEach(btn => btn.classList.remove('asin-upload__tab-button--active'));
            
            // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
            tabContents.forEach(content => content.classList.remove('asin-upload__tab-content--active'));
            
            // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Çø„Éñ„Éú„Çø„É≥„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
            this.classList.add('asin-upload__tab-button--active');
            
            // ÂØæÂøú„Åô„Çã„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫
            const targetContent = document.getElementById(targetTab);
            if (targetContent) {
                targetContent.classList.add('asin-upload__tab-content--active');
            }
            
            console.log(`üîÑ „Çø„ÉñÂàá„ÇäÊõø„Åà: ${targetTab}`);
        });
    });
}

// ===== „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ©üËÉΩ =====
function initializeFileUpload() {
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('csvFile');
    const processCsvBtn = document.getElementById('processCsvBtn');

    if (!fileUploadArea || !fileInput || !processCsvBtn) {
        console.error("‚ùå „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
        return;
    }

    // „Éï„Ç°„Ç§„É´„Ç®„É™„Ç¢„ÇØ„É™„ÉÉ„ÇØ
    fileUploadArea.addEventListener('click', function() {
        fileInput.click();
    });

    // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            handleFileSelection(file);
        }
    });

    // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
    fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('asin-upload__file-upload-area--dragover');
    });

    fileUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('asin-upload__file-upload-area--dragover');
    });

    fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('asin-upload__file-upload-area--dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            handleFileSelection(file);
        }
    });

    // CSVÂá¶ÁêÜ„Éú„Çø„É≥
    processCsvBtn.addEventListener('click', function() {
        if (asinUploadData.currentFile) {
            processCsvFile();
        } else {
            showAlert('„Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ', 'error');
        }
    });
}

// ===== „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÂá¶ÁêÜ =====
function handleFileSelection(file) {
    console.log(`üìÅ „Éï„Ç°„Ç§„É´ÈÅ∏Êäû: ${file.name}`);
    
    // „Éï„Ç°„Ç§„É´ÂΩ¢Âºè„ÉÅ„Çß„ÉÉ„ÇØ
    const allowedTypes = [
        'text/csv',
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    ];
    
    const allowedExtensions = ['.csv', '.xlsx', '.xls'];
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    
    if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
        showAlert('„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô„ÄÇCSV„ÄÅXLS„ÄÅXLSX„Éï„Ç°„Ç§„É´„ÅÆ„Åø„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂèØËÉΩ„Åß„Åô„ÄÇ', 'error');
        return;
    }
    
    // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ (10MB)
    if (file.size > 10 * 1024 * 1024) {
        showAlert('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô„ÄÇ10MB‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
        return;
    }
    
    asinUploadData.currentFile = file;
    showAlert(`„Éï„Ç°„Ç§„É´ "${file.name}" „ÅåÈÅ∏Êäû„Åï„Çå„Åæ„Åó„Åü„ÄÇÂá¶ÁêÜ„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Á∂öË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`, 'success');
}

// ===== CSVÂá¶ÁêÜÂÆüË°å =====
function processCsvFile() {
    if (asinUploadData.isProcessing) {
        console.log("‚ö†Ô∏è Êó¢„Å´Âá¶ÁêÜ‰∏≠„Åß„Åô");
        return;
    }
    
    console.log("üîÑ CSVÂá¶ÁêÜÈñãÂßã");
    asinUploadData.isProcessing = true;
    
    showProgress(true);
    updateProgress(0, '„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const csvContent = e.target.result;
            const parsedData = parseCSV(csvContent);
            
            if (parsedData.length === 0) {
                throw new Error('ÊúâÂäπ„Å™„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ');
            }
            
            processDataArray(parsedData);
        } catch (error) {
            console.error("‚ùå CSVËß£Êûê„Ç®„É©„Éº:", error);
            showAlert(`„Éï„Ç°„Ç§„É´„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}`, 'error');
            showProgress(false);
            asinUploadData.isProcessing = false;
        }
    };
    
    reader.onerror = function() {
        console.error("‚ùå „Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº");
        showAlert('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
        showProgress(false);
        asinUploadData.isProcessing = false;
    };
    
    reader.readAsText(asinUploadData.currentFile);
}

// ===== CSVËß£Êûê =====
function parseCSV(csvContent) {
    const lines = csvContent.split('\n').filter(line => line.trim());
    
    if (lines.length === 0) {
        throw new Error('Á©∫„ÅÆ„Éï„Ç°„Ç§„É´„Åß„Åô„ÄÇ');
    }
    
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        
        if (values.length >= headers.length) {
            const row = {};
            headers.forEach((header, index) => {
                row[header] = values[index] || '';
            });
            data.push(row);
        }
    }
    
    console.log(`üìä CSVËß£ÊûêÂÆå‰∫Ü: ${data.length}Ë°å`);
    return data;
}

// CSVË°åËß£ÊûêÔºàÂºïÁî®Á¨¶ÂØæÂøúÔºâ
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    result.push(current.trim());
    return result;
}

// ===== ÊâãÂãïÂÖ•ÂäõÊ©üËÉΩ =====
function initializeManualInput() {
    const addManualBtn = document.getElementById('addManualBtn');
    const clearManualBtn = document.getElementById('clearManualBtn');

    if (addManualBtn) {
        addManualBtn.addEventListener('click', function() {
            processManualInput();
        });
    }

    if (clearManualBtn) {
        clearManualBtn.addEventListener('click', function() {
            clearManualForm();
        });
    }
}

function processManualInput() {
    const asin = document.getElementById('asinInput')?.value.trim() || '';
    const url = document.getElementById('urlInput')?.value.trim() || '';
    const keyword = document.getElementById('keywordInput')?.value.trim() || '';
    const sku = document.getElementById('skuInput')?.value.trim() || '';

    if (!asin && !url) {
        showAlert('ASIN„Åæ„Åü„ÅØURL„ÅÆ„ÅÑ„Åö„Çå„Åã„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
        return;
    }

    const inputData = [{
        ASIN: asin,
        URL: url,
        „Ç≠„Éº„ÉØ„Éº„Éâ: keyword,
        SKU: sku
    }];

    processDataArray(inputData);
}

function clearManualForm() {
    const inputs = ['asinInput', 'urlInput', 'keywordInput', 'skuInput'];
    inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
    });
    
    showAlert('„Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ', 'info');
}

// ===== ‰∏ÄÊã¨ÂÖ•ÂäõÊ©üËÉΩ =====
function initializeBulkInput() {
    const processBulkBtn = document.getElementById('processBulkBtn');
    const clearBulkBtn = document.getElementById('clearBulkBtn');

    if (processBulkBtn) {
        processBulkBtn.addEventListener('click', function() {
            processBulkInput();
        });
    }

    if (clearBulkBtn) {
        clearBulkBtn.addEventListener('click', function() {
            clearBulkInput();
        });
    }
}

function processBulkInput() {
    const bulkText = document.getElementById('bulkInput')?.value.trim() || '';
    
    if (!bulkText) {
        showAlert('ASIN„ÉªURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
        return;
    }

    const lines = bulkText.split('\n').filter(line => line.trim());
    
    if (lines.length > 1000) {
        showAlert('‰∏ÄÂ∫¶„Å´Âá¶ÁêÜ„Åß„Åç„Çã„ÅÆ„ÅØ1,000Ë°å„Åæ„Åß„Åß„Åô„ÄÇ', 'error');
        return;
    }

    const inputData = lines.map(line => {
        const value = line.trim();
        // ASIN„ÅãURL„Åã„ÇíÂà§ÂÆö
        if (value.startsWith('http')) {
            return { ASIN: '', URL: value, „Ç≠„Éº„ÉØ„Éº„Éâ: '', SKU: '' };
        } else {
            return { ASIN: value, URL: '', „Ç≠„Éº„ÉØ„Éº„Éâ: '', SKU: '' };
        }
    });

    processDataArray(inputData);
}

function clearBulkInput() {
    const bulkInput = document.getElementById('bulkInput');
    if (bulkInput) {
        bulkInput.value = '';
    }
    
    showAlert('‰∏ÄÊã¨ÂÖ•Âäõ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ', 'info');
}

// ===== „Éá„Éº„ÇøÈÖçÂàóÂá¶ÁêÜ =====
async function processDataArray(dataArray) {
    if (!dataArray || dataArray.length === 0) {
        showAlert('Âá¶ÁêÜ„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
        return;
    }

    if (asinUploadData.isProcessing) {
        console.log("‚ö†Ô∏è Êó¢„Å´Âá¶ÁêÜ‰∏≠„Åß„Åô");
        return;
    }

    console.log(`üîÑ „Éá„Éº„ÇøÂá¶ÁêÜÈñãÂßã: ${dataArray.length}‰ª∂`);
    asinUploadData.isProcessing = true;
    asinUploadData.processedItems = [];

    showProgress(true);

    for (let i = 0; i < dataArray.length; i++) {
        const item = dataArray[i];
        const progress = ((i + 1) / dataArray.length) * 100;
        
        updateProgress(progress, `${i + 1}/${dataArray.length} ‰ª∂Âá¶ÁêÜ‰∏≠...`);

        try {
            const result = await processItem(item);
            asinUploadData.processedItems.push(result);
        } catch (error) {
            console.error(`‚ùå „Ç¢„Ç§„ÉÜ„É†Âá¶ÁêÜ„Ç®„É©„Éº:`, error);
            asinUploadData.processedItems.push({
                input: item.ASIN || item.URL || '‰∏çÊòé',
                type: 'Âá¶ÁêÜ„Ç®„É©„Éº',
                status: 'error',
                productName: '',
                price: '',
                details: error.message,
                keyword: item.„Ç≠„Éº„ÉØ„Éº„Éâ || '',
                sku: item.SKU || ''
            });
        }

        // UI„ÅÆÂøúÁ≠îÊÄß„Çí‰øù„Å§„Åü„ÇÅÂ∞ë„ÅóÂæÖÊ©ü
        await new Promise(resolve => setTimeout(resolve, 50));
    }

    updateProgress(100, 'Âá¶ÁêÜÂÆå‰∫Ü');
    setTimeout(() => {
        showProgress(false);
        displayResults();
        asinUploadData.isProcessing = false;
    }, 500);

    console.log("‚úÖ „Éá„Éº„ÇøÂá¶ÁêÜÂÆå‰∫Ü");
}

// ===== ÂÄãÂà•„Ç¢„Ç§„ÉÜ„É†Âá¶ÁêÜ =====
async function processItem(item) {
    const input = item.ASIN || item.URL || '';

    // ASIN„ÅÆÊ§úË®º
    if (item.ASIN && !/^[B][0-9A-Z]{9}$/.test(item.ASIN)) {
        throw new Error('ÁÑ°Âäπ„Å™ASINÂΩ¢Âºè');
    }

    // URL„ÅÆÊ§úË®º
    if (item.URL) {
        try {
            new URL(item.URL);
        } catch {
            throw new Error('ÁÑ°Âäπ„Å™URLÂΩ¢Âºè');
        }
    }

    // ÂÆüÈöõ„ÅÆÂá¶ÁêÜ„Çí„Ç∑„Éü„É•„É¨„Éº„ÉàÔºàÂÆüË£ÖÊôÇ„ÅØAPIÂëº„Å≥Âá∫„Åó„Å´ÁΩÆ„ÅçÊèõ„ÅàÔºâ
    await new Promise(resolve => setTimeout(resolve, Math.random() * 500 + 200));

    // „Çµ„É≥„Éó„É´ÁµêÊûú„ÇíËøî„Åô
    const mockProducts = [
        { name: 'Echo Dot (Á¨¨4‰∏ñ‰ª£) - „Çπ„Éû„Éº„Éà„Çπ„Éî„Éº„Ç´„Éº with Alexa', price: '¬•5,980' },
        { name: 'Fire TV Stick 4K Max - AlexaÂØæÂøúÈü≥Â£∞Ë™çË≠ò„É™„É¢„Ç≥„É≥‰ªòÂ±û', price: '¬•6,980' },
        { name: 'Kindle Paperwhite (8GB) 6.8„Ç§„É≥„ÉÅ„Éá„Ç£„Çπ„Éó„É¨„Ç§ Èò≤Ê∞¥Ê©üËÉΩÊê≠Ëºâ', price: '¬•14,980' },
        { name: 'Echo Show 5 (Á¨¨3‰∏ñ‰ª£) - „Çπ„Éû„Éº„Éà„Éá„Ç£„Çπ„Éó„É¨„Ç§ with Alexa', price: '¬•8,980' },
        { name: 'Fire HD 10 „Çø„Éñ„É¨„ÉÉ„Éà 10.1„Ç§„É≥„ÉÅHD„Éá„Ç£„Çπ„Éó„É¨„Ç§ 32GB', price: '¬•15,980' },
        { name: 'Amazon Echo Buds (Á¨¨2‰∏ñ‰ª£) „ÉØ„Ç§„É§„É¨„Çπ„Ç§„É§„Éõ„É≥', price: '¬•12,980' }
    ];

    const randomProduct = mockProducts[Math.floor(Math.random() * mockProducts.length)];

    return {
        input: input,
        type: item.ASIN ? 'ASIN' : 'URL',
        status: 'success',
        productName: randomProduct.name,
        price: randomProduct.price,
        details: 'AmazonÂïÜÂìÅ„Éá„Éº„ÇøÂèñÂæóÊàêÂäü',
        keyword: item.„Ç≠„Éº„ÉØ„Éº„Éâ || '',
        sku: item.SKU || ''
    };
}

// ===== ÁµêÊûúË°®Á§∫ =====
function displayResults() {
    const resultSection = document.getElementById('resultSection');
    const resultSummary = document.getElementById('resultSummary');
    const tableBody = document.getElementById('resultTableBody');

    if (!resultSection || !tableBody) {
        console.error("‚ùå ÁµêÊûúË°®Á§∫Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
        return;
    }

    // ÁµêÊûú„Çµ„Éû„É™„Éº‰ΩúÊàê
    const successCount = asinUploadData.processedItems.filter(r => r.status === 'success').length;
    const errorCount = asinUploadData.processedItems.filter(r => r.status === 'error').length;
    const totalCount = asinUploadData.processedItems.length;

    if (resultSummary) {
        resultSummary.innerHTML = `
            <div class="asin-upload__summary-item">
                <div class="asin-upload__summary-value asin-upload__summary-value--total">${totalCount}</div>
                <div class="asin-upload__summary-label">ÂêàË®à</div>
            </div>
            <div class="asin-upload__summary-item">
                <div class="asin-upload__summary-value asin-upload__summary-value--success">${successCount}</div>
                <div class="asin-upload__summary-label">ÊàêÂäü</div>
            </div>
            <div class="asin-upload__summary-item">
                <div class="asin-upload__summary-value asin-upload__summary-value--error">${errorCount}</div>
                <div class="asin-upload__summary-label">„Ç®„É©„Éº</div>
            </div>
        `;
    }

    // „ÉÜ„Éº„Éñ„É´ÂÜÖÂÆπ„ÇØ„É™„Ç¢
    tableBody.innerHTML = '';

    // ÁµêÊûú„ÇíË°®Á§∫
    asinUploadData.processedItems.forEach((result, index) => {
        const row = document.createElement('tr');
        
        const statusClass = result.status === 'success' ? 'success' : 'error';
        const statusText = result.status === 'success' ? 'ÊàêÂäü' : '„Ç®„É©„Éº';

        row.innerHTML = `
            <td>${escapeHtml(result.input)}</td>
            <td>${escapeHtml(result.type)}</td>
            <td>
                <span class="asin-upload__status-badge asin-upload__status-badge--${statusClass}">
                    ${statusText}
                </span>
            </td>
            <td>${escapeHtml(result.productName)}</td>
            <td>${escapeHtml(result.price)}</td>
            <td>${escapeHtml(result.details)}</td>
        `;
        
        tableBody.appendChild(row);
    });

    // ÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
    resultSection.style.display = 'block';
    resultSection.scrollIntoView({ behavior: 'smooth' });

    // „Ç¢„É©„Éº„ÉàË°®Á§∫
    const alertType = successCount > 0 ? 'success' : 'error';
    const alertMessage = `Âá¶ÁêÜÂÆå‰∫Ü: ÊàêÂäü ${successCount}‰ª∂, „Ç®„É©„Éº ${errorCount}‰ª∂`;
    showAlert(alertMessage, alertType);

    console.log(`üìä ÁµêÊûúË°®Á§∫ÂÆå‰∫Ü: ÊàêÂäü ${successCount}‰ª∂, „Ç®„É©„Éº ${errorCount}‰ª∂`);
}

// ===== „Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫Âà∂Âæ° =====
function showProgress(show) {
    const progressSection = document.getElementById('progressSection');
    if (progressSection) {
        progressSection.style.display = show ? 'block' : 'none';
    }
}

function updateProgress(percentage, text) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    if (progressFill) {
        progressFill.style.width = Math.min(100, Math.max(0, percentage)) + '%';
    }
    
    if (progressText) {
        progressText.textContent = text;
    }
}

// ===== „Ç¢„É©„Éº„ÉàË°®Á§∫ =====
function showAlert(message, type = 'info') {
    // Êó¢Â≠ò„ÅÆ„Ç¢„É©„Éº„Éà„ÇíÂâäÈô§
    const existingAlert = document.querySelector('.asin-upload__alert');
    if (existingAlert) {
        existingAlert.remove();
    }

    const alert = document.createElement('div');
    alert.className = `asin-upload__alert asin-upload__alert--${type}`;
    alert.textContent = message;

    // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÂÖàÈ†≠„Å´ÊåøÂÖ•
    const content = document.querySelector('.content');
    if (content) {
        content.insertBefore(alert, content.firstChild);
    }

    // 5ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);

    console.log(`üì¢ „Ç¢„É©„Éº„ÉàË°®Á§∫: [${type.toUpperCase()}] ${message}`);
}

// ===== „Åù„ÅÆ‰ªñ„ÅÆ„Ç§„Éô„É≥„ÉàË®≠ÂÆö =====
function initializeOtherEvents() {
    // ÁµêÊûú„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥
    const downloadBtn = document.getElementById('downloadResultsBtn');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
            downloadResults();
        });
    }

    // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥
    const resetBtn = document.getElementById('resetFormBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            resetForm();
        });
    }

    // Áµ±Ë®à„Ç´„Éº„Éâ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    const statCards = document.querySelectorAll('.dashboard__stat-card[data-modal]');
    statCards.forEach(card => {
        card.addEventListener('click', function() {
            const modalType = this.getAttribute('data-modal');
            showStatCardModal(modalType);
        });
    });
}

// ===== ÁµêÊûú„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ =====
function downloadResults() {
    if (asinUploadData.processedItems.length === 0) {
        showAlert('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åß„Åç„ÇãÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
        return;
    }

    const csvContent = generateCSV(asinUploadData.processedItems);
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `asin_upload_results_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('ÁµêÊûú„ÇíCSV„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇ', 'success');
    console.log("üíæ ÁµêÊûú„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂÆå‰∫Ü");
}

function generateCSV(data) {
    const headers = ['ÂÖ•ÂäõÂÄ§', 'Á®ÆÂà•', '„Çπ„ÉÜ„Éº„Çø„Çπ', 'ÂïÜÂìÅÂêç', '‰æ°Ê†º', 'Ë©≥Á¥∞', '„Ç≠„Éº„ÉØ„Éº„Éâ', 'SKU'];
    const csvRows = [headers.join(',')];

    data.forEach(row => {
        const values = [
            `"${row.input.replace(/"/g, '""')}"`,
            `"${row.type.replace(/"/g, '""')}"`,
            `"${(row.status === 'success' ? 'ÊàêÂäü' : '„Ç®„É©„Éº').replace(/"/g, '""')}"`,
            `"${row.productName.replace(/"/g, '""')}"`,
            `"${row.price.replace(/"/g, '""')}"`,
            `"${row.details.replace(/"/g, '""')}"`,
            `"${row.keyword.replace(/"/g, '""')}"`,
            `"${row.sku.replace(/"/g, '""')}"`
        ];
        csvRows.push(values.join(','));
    });

    return '\uFEFF' + csvRows.join('\n'); // UTF-8 BOM‰ªò„Åç
}

// ===== „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà =====
function resetForm() {
    // „Éá„Éº„Çø„ÇØ„É™„Ç¢
    asinUploadData.processedItems = [];
    asinUploadData.currentFile = null;
    asinUploadData.isProcessing = false;

    // „Éï„Ç©„Éº„É†Ë¶ÅÁ¥†„ÇØ„É™„Ç¢
    const fileInput = document.getElementById('csvFile');
    if (fileInput) fileInput.value = '';

    clearManualForm();
    clearBulkInput();

    // UIÁä∂ÊÖã„É™„Çª„ÉÉ„Éà
    const resultSection = document.getElementById('resultSection');
    if (resultSection) resultSection.style.display = 'none';

    showProgress(false);

    // ÊúÄÂàù„ÅÆ„Çø„Éñ„Å´Êàª„Åô
    const firstTab = document.querySelector('.asin-upload__tab-button[data-tab="csv-upload"]');
    if (firstTab) {
        firstTab.click();
    }

    showAlert('„Éï„Ç©„Éº„É†„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„Åü„ÄÇ', 'success');
    console.log("üîÑ „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„ÉàÂÆå‰∫Ü");
}

// ===== Áµ±Ë®à„Ç´„Éº„Éâ„É¢„Éº„ÉÄ„É´ =====
function showStatCardModal(modalType) {
    const modalData = {
        processed: { title: 'Âá¶ÁêÜÊ∏à„Åø„Éá„Éº„ÇøË©≥Á¥∞', content: 'Âá¶ÁêÜÊ∏à„Åø„ÅÆÂïÜÂìÅ„Éá„Éº„Çø‰∏ÄË¶ß„ÇíË°®Á§∫„Åó„Åæ„Åô' },
        pending: { title: 'Âá¶ÁêÜÂæÖ„Å°„Éá„Éº„ÇøË©≥Á¥∞', content: 'Âá¶ÁêÜÂæÖ„Å°„ÅÆÂïÜÂìÅ„Éá„Éº„Çø‰∏ÄË¶ß„ÇíË°®Á§∫„Åó„Åæ„Åô' },
        errors: { title: '„Ç®„É©„Éº„Éá„Éº„ÇøË©≥Á¥∞', content: '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„ÅüÂïÜÂìÅ„Éá„Éº„Çø‰∏ÄË¶ß„ÇíË°®Á§∫„Åó„Åæ„Åô' },
        total: { title: 'ÂÖ®„Éá„Éº„ÇøË©≥Á¥∞', content: 'ÂÖ®„Å¶„ÅÆÂïÜÂìÅ„Éá„Éº„Çø‰∏ÄË¶ß„ÇíË°®Á§∫„Åó„Åæ„Åô' }
    };

    const data = modalData[modalType];
    if (data) {
        showModal(data.title, data.content, modalType);
    }
}

// ===== Á∞°Êòì„É¢„Éº„ÉÄ„É´Ë°®Á§∫ =====
function showModal(title, content, type = '') {
    const existingModal = document.querySelector('.asin-upload__modal');
    if (existingModal) {
        existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.className = 'asin-upload__modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(4px);
    `;

    const modalContent = document.createElement('div');
    modalContent.className = 'asin-upload__modal-content';
    modalContent.style.cssText = `
        background: var(--bg-secondary);
        padding: 3rem;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        text-align: left;
        transform: scale(0.9);
        transition: transform 0.3s ease;
        border: 1px solid var(--shadow-dark);
        overflow-y: auto;
    `;

    modalContent.innerHTML = `
        <div class="asin-upload__modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid var(--shadow-dark); padding-bottom: 1rem;">
            <h3 class="asin-upload__modal-title" style="margin: 0; color: var(--text-primary); font-size: 1.5rem;">${escapeHtml(title)}</h3>
            <button class="asin-upload__modal-close" style="width: 32px; height: 32px; border-radius: 50%; background: var(--bg-primary); border: 1px solid var(--shadow-dark); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">√ó</button>
        </div>
        <div class="asin-upload__modal-body" style="margin-bottom: 2rem;">
            <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 1.5rem;">${escapeHtml(content)}</p>
            <div style="background: var(--bg-primary); padding: 2rem; border-radius: var(--radius-lg); margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: var(--text-primary);">„Éá„Éº„ÇøË©≥Á¥∞</h4>
                <div style="display: grid; gap: 1rem;">
                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--shadow-dark);">ASIN/URL„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç∑„Çπ„ÉÜ„É†Ë©≥Á¥∞„Éá„Éº„Çø</div>
                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--shadow-dark);">Âá¶ÁêÜ„Çπ„ÉÜ„Éº„Çø„Çπ: ${type}</div>
                </div>
            </div>
        </div>
        <div class="asin-upload__modal-actions" style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button class="btn asin-upload__modal-close" style="background: var(--bg-primary); border: 1px solid var(--shadow-dark);">„Ç≠„É£„É≥„Çª„É´</button>
            <button class="btn btn--primary">Á¢∫Ë™ç</button>
        </div>
    `;

    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    setTimeout(() => {
        modal.style.opacity = '1';
        modalContent.style.transform = 'scale(1)';
    }, 10);

    const closeBtns = modalContent.querySelectorAll('.asin-upload__modal-close');
    closeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            modal.style.opacity = '0';
            modalContent.style.transform = 'scale(0.9)';
            setTimeout(() => modal.remove(), 300);
        });
    });

    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.opacity = '0';
            modalContent.style.transform = 'scale(0.9)';
            setTimeout(() => modal.remove(), 300);
        }
    });

    console.log(`üìã „É¢„Éº„ÉÄ„É´Ë°®Á§∫: ${title}`);
}

// ===== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞ =====
function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') {
        return '';
    }
    
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// ===== „Éá„Éê„ÉÉ„Ç∞Áî®Èñ¢Êï∞ =====
window.asinUploadDebug = {
    getData: () => asinUploadData,
    clearData: () => {
        asinUploadData.processedItems = [];
        asinUploadData.currentFile = null;
        asinUploadData.isProcessing = false;
        console.log("üóëÔ∏è „Éá„Éê„ÉÉ„Ç∞: „Éá„Éº„Çø„ÇØ„É™„Ç¢ÂÆå‰∫Ü");
    },
    testProcessing: () => {
        const testData = [
            { ASIN: 'B08N5WRWNW', URL: '', „Ç≠„Éº„ÉØ„Éº„Éâ: 'Echo Dot', SKU: 'TEST-001' },
            { ASIN: '', URL: 'https://amazon.co.jp/dp/B09B8RRQT5', „Ç≠„Éº„ÉØ„Éº„Éâ: 'Fire TV', SKU: 'TEST-002' }
        ];
        processDataArray(testData);
        console.log("üß™ „Éá„Éê„ÉÉ„Ç∞: „ÉÜ„Çπ„ÉàÂá¶ÁêÜÂÆüË°å");
    }
};

console.log("‚úÖ ASIN/URL„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ∞ÇÁî®JavaScriptÂàùÊúüÂåñÂÆå‰∫Ü");