<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBayæ‰‹æ•°æ–™ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒãƒƒãƒãƒ³ã‚°</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #2563eb, #06b6d4); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .form-textarea { min-height: 300px; }
        .btn { background: #2563eb; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #1d4ed8; }
        .results { display: none; }
        .match-item { border: 1px solid #e5e7eb; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .confidence-high { background: #d1fae5; }
        .confidence-medium { background: #fef3c7; }
        .confidence-low { background: #fee2e2; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ·ï¸ eBayæ‰‹æ•°æ–™ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒãƒƒãƒãƒ³ã‚°</h1>
            <p>æ‰‹æ•°æ–™ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¨CSVã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è‡ªå‹•ç…§åˆ</p>
        </div>

        <div class="grid">
            <div class="card">
                <h3>ğŸ“ æ‰‹æ•°æ–™ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿</h3>
                <div class="form-group">
                    <label class="form-label">eBayå…¬å¼æ‰‹æ•°æ–™ãƒ‡ãƒ¼ã‚¿</label>
                    <textarea id="feeText" class="form-input form-textarea" placeholder="**Most categories**
* 13.6% on total amount of the sale up to $7,500

**Books & Magazines**  
* 15.3% on total amount of the sale up to $7,500

**Clothing, Shoes & Accessories**
* 13.6% if total amount is $2,000 or less
* 9% if total amount is over $2,000">**Most categories**
* 13.6% on total amount of the sale up to $7,500 calculated per item
* 2.35% on the portion of the sale over $7,500

**Books & Magazines**
**Movies & TV**
**Music**
* 15.3% on total amount of the sale up to $7,500 calculated per item
* 2.35% on the portion of the sale over $7,500

**Coins & Paper Money**
* 13.25% on total amount of the sale up to $7,500 calculated per item
* 2.35% on the portion of the sale over $7,500

**Clothing, Shoes & Accessories**
* 13.6% if total amount of the sale is $2,000 or less
* 9% if total amount of the sale is over $2,000

**Jewelry & Watches**
* 15% if total amount of the sale is $5,000 or less
* 9% if total amount of the sale is over $5,000</textarea>
                </div>
                
                <button class="btn" onclick="processMatching()">ğŸ¤– ãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œ</button>
            </div>

            <div class="card">
                <h3>ğŸ“Š å‡¦ç†çµæœ</h3>
                <div id="processingStatus">ã€Œãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>
                
                <div id="results" class="results">
                    <h4>ãƒãƒƒãƒãƒ³ã‚°çµæœ</h4>
                    <div id="summary"></div>
                    <div id="matchList"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ˆ ãƒãƒƒãƒãƒ³ã‚°çµ±è¨ˆ</h3>
            <div id="statistics" style="display: none;">
                <canvas id="matchChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        async function processMatching() {
            const feeText = document.getElementById('feeText').value;
            const statusDiv = document.getElementById('processingStatus');
            
            if (!feeText.trim()) {
                alert('æ‰‹æ•°æ–™ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            statusDiv.innerHTML = 'ğŸ”„ å‡¦ç†ä¸­...';
            
            try {
                // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ãƒ†ã‚­ã‚¹ãƒˆè§£æ
                const parsedRules = parseFeeStructure(feeText);
                
                // ã‚µãƒ³ãƒ—ãƒ«ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ãƒãƒƒãƒãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
                const sampleCategories = [
                    { id: '1', path: 'Books & Magazines > Fiction Books', fvf: '15.30%' },
                    { id: '2', path: 'Clothing, Shoes & Accessories > Women > Tops', fvf: '13.60%' },
                    { id: '3', path: 'Electronics > Cell Phones & Accessories', fvf: '12.90%' },
                    { id: '4', path: 'Jewelry & Watches > Fine Jewelry > Rings', fvf: '15.00%' },
                    { id: '5', path: 'Movies & TV > DVDs & Blu-ray Discs', fvf: '15.30%' },
                    { id: '6', path: 'Music > CDs', fvf: '15.30%' },
                    { id: '7', path: 'Coins & Paper Money > Coins', fvf: '13.25%' },
                    { id: '8', path: 'Toys & Hobbies > Action Figures', fvf: '13.60%' },
                    { id: '9', path: 'Collectibles > Trading Cards', fvf: '13.25%' },
                    { id: '10', path: 'Home & Garden > Kitchen, Dining & Bar', fvf: '13.60%' }
                ];
                
                const matches = performMatching(sampleCategories, parsedRules);
                displayResults(matches, parsedRules);
                
            } catch (error) {
                console.error('Processing error:', error);
                statusDiv.innerHTML = 'âŒ å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + error.message;
            }
        }

        function parseFeeStructure(text) {
            const rules = [];
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            
            let currentCategories = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // ã‚«ãƒ†ã‚´ãƒªãƒ¼åæ¤œå‡º
                const categoryMatch = line.match(/\*\*([^*]+)\*\*/g);
                if (categoryMatch) {
                    currentCategories = categoryMatch.map(m => m.replace(/\*\*/g, '').trim());
                    continue;
                }
                
                // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸æ¤œå‡º
                const percentMatch = line.match(/(\d+\.?\d*)\s*%/);
                if (percentMatch && currentCategories.length > 0) {
                    const percent = parseFloat(percentMatch[1]);
                    
                    // åŸºæœ¬æ‰‹æ•°æ–™ã®ã¿ä¿å­˜ï¼ˆ2.35%ã®ã‚ˆã†ãªè¿½åŠ æ‰‹æ•°æ–™ã¯é™¤å¤–ï¼‰
                    if (percent > 5) {
                        currentCategories.forEach(category => {
                            const existingRule = rules.find(r => r.category === category);
                            if (!existingRule) {
                                rules.push({
                                    category: category,
                                    fee_percent: percent,
                                    conditions: line,
                                    keywords: category.toLowerCase().split(/[\s&,]+/)
                                });
                            }
                        });
                    }
                }
            }
            
            return rules;
        }

        function performMatching(categories, rules) {
            const matches = [];
            
            categories.forEach(category => {
                let bestMatch = null;
                let bestScore = 0;
                
                rules.forEach(rule => {
                    const score = calculateMatchScore(category.path.toLowerCase(), rule);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = {
                            rule: rule,
                            score: score,
                            confidence: Math.min(score, 100)
                        };
                    }
                });
                
                if (bestScore > 30) {
                    matches.push({
                        category_id: category.id,
                        category_path: category.path,
                        existing_fvf: category.fvf,
                        matched_fee: bestMatch.rule.fee_percent,
                        confidence: bestMatch.confidence,
                        match_reason: `"${bestMatch.rule.category}" ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒ`
                    });
                }
            });
            
            return matches;
        }

        function calculateMatchScore(categoryPath, rule) {
            let score = 0;
            
            // å®Œå…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼åãƒãƒƒãƒãƒ³ã‚°
            if (categoryPath.includes(rule.category.toLowerCase())) {
                score += 90;
            }
            
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å€‹åˆ¥ãƒãƒƒãƒãƒ³ã‚°
            rule.keywords.forEach(keyword => {
                if (keyword.length >= 3 && categoryPath.includes(keyword)) {
                    score += 40;
                }
            });
            
            // ç‰¹æ®Šãƒ«ãƒ¼ãƒ«
            if (rule.category === 'Most categories' && score === 0) {
                score = 50; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒƒãƒ
            }
            
            return score;
        }

        function displayResults(matches, rules) {
            document.getElementById('processingStatus').innerHTML = 'âœ… å‡¦ç†å®Œäº†';
            document.getElementById('results').style.display = 'block';
            
            // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            const summary = document.getElementById('summary');
            const highConf = matches.filter(m => m.confidence >= 80).length;
            const medConf = matches.filter(m => m.confidence >= 60 && m.confidence < 80).length;
            const lowConf = matches.filter(m => m.confidence < 60).length;
            
            summary.innerHTML = `
                <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                    <div>è§£æãƒ«ãƒ¼ãƒ«: <strong>${rules.length}</strong></div>
                    <div>ãƒãƒƒãƒæ•°: <strong>${matches.length}</strong></div>
                    <div>é«˜ä¿¡é ¼åº¦: <strong>${highConf}</strong></div>
                    <div>ä¸­ä¿¡é ¼åº¦: <strong>${medConf}</strong></div>
                    <div>ä½ä¿¡é ¼åº¦: <strong>${lowConf}</strong></div>
                </div>
            `;
            
            // ãƒãƒƒãƒãƒªã‚¹ãƒˆè¡¨ç¤º
            const matchList = document.getElementById('matchList');
            matchList.innerHTML = matches.map(match => {
                const confidenceClass = 
                    match.confidence >= 80 ? 'confidence-high' :
                    match.confidence >= 60 ? 'confidence-medium' : 'confidence-low';
                
                return `
                    <div class="match-item ${confidenceClass}">
                        <strong>${match.category_path}</strong><br>
                        æ—¢å­˜FVF: ${match.existing_fvf} â†’ æ–°FVF: <strong>${match.matched_fee}%</strong><br>
                        ä¿¡é ¼åº¦: ${match.confidence}% | ${match.match_reason}
                    </div>
                `;
            }).join('');
            
            document.getElementById('statistics').style.display = 'block';
        }

        console.log('ğŸ·ï¸ eBayæ‰‹æ•°æ–™ãƒãƒƒãƒãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
    </script>
</body>
</html>