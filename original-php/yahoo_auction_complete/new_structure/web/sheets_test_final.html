<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Google Sheets実データ取得テスト - 完全修正版</title>
</head>
<body style="font-family: Arial, sans-serif; margin: 20px; background-color: #f8f9fa; padding: 0;">
    <div style="max-width: 1000px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        
        <!-- ヘッダー -->
        <h1 style="color: #333; text-align: center; margin-bottom: 10px; font-size: 28px;">📊 Google Sheets実データ取得テスト</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px; font-size: 16px;">完全修正版 - インラインCSS使用</p>
        
        <!-- 成功メッセージ -->
        <div style="background-color: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 5px solid #007bff;">
            <strong style="color: #0056b3;">✅ API接続確認済み</strong><br>
            <span style="color: #333;">Google Sheets APIとの接続が確認できました。修正版で再テストします。</span>
        </div>
        
        <!-- ボタンエリア -->
        <div style="text-align: center; margin-bottom: 30px;">
            <button onclick="getSheetsData()" style="padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; background-color: #007bff; color: white; transition: background-color 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);" onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#007bff'">
                📥 Sheetsデータ取得
            </button>
            <button onclick="writeToSheets()" style="padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; background-color: #28a745; color: white; transition: background-color 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);" onmouseover="this.style.backgroundColor='#1e7e34'" onmouseout="this.style.backgroundColor='#28a745'">
                📤 Sheetsにデータ書き込み
            </button>
        </div>
        
        <!-- ローディング表示 -->
        <div id="loading" style="display: none; color: #007bff; font-weight: bold; text-align: center; font-size: 18px; margin: 20px 0;">
            🔄 処理中...
        </div>
        
        <!-- 結果表示エリア -->
        <div id="result" style="margin-top: 25px; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; border: 2px solid #ddd; background-color: #f8f9fa; font-size: 12px; line-height: 1.4;"></div>
        
        <!-- データ表示エリア -->
        <div id="data-display" style="margin-top: 25px;"></div>
    </div>

    <script>
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        async function makeRequest(action) {
            try {
                const formData = new FormData();
                formData.append('action', action);
                
                const response = await fetch('google_sheets_fixed.php', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                
                try {
                    return JSON.parse(text);
                } catch (e) {
                    return {
                        success: false,
                        error: 'レスポンスの解析に失敗しました',
                        raw_response: text.substring(0, 500)
                    };
                }
            } catch (error) {
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        function displayResult(result) {
            const resultElement = document.getElementById('result');
            
            if (result.success) {
                resultElement.style.backgroundColor = '#d4edda';
                resultElement.style.color = '#155724';
                resultElement.style.borderColor = '#c3e6cb';
                resultElement.style.borderWidth = '2px';
            } else {
                resultElement.style.backgroundColor = '#f8d7da';
                resultElement.style.color = '#721c24';
                resultElement.style.borderColor = '#f5c6cb';
                resultElement.style.borderWidth = '2px';
            }
            
            resultElement.innerHTML = JSON.stringify(result, null, 2);
        }
        
        function displayDataTable(values) {
            const dataDisplay = document.getElementById('data-display');
            
            if (!values || values.length === 0) {
                dataDisplay.innerHTML = '<p style="color: #666; text-align: center; font-size: 16px; padding: 20px;">データがありません</p>';
                return;
            }
            
            let html = '<h3 style="color: #333; margin-bottom: 15px; font-size: 20px; text-align: center;">📋 取得したデータ</h3>';
            html += '<div style="max-height: 350px; overflow-y: auto; border: 2px solid #007bff; border-radius: 8px; background-color: white;">';
            html += '<table style="width: 100%; border-collapse: collapse; margin: 0;">';
            
            // データ行
            html += '<tbody>';
            values.forEach((row, rowIndex) => {
                html += '<tr style="' + (rowIndex % 2 === 0 ? 'background-color: #f8f9fa;' : 'background-color: white;') + '">';
                row.forEach((cell, cellIndex) => {
                    const isHeader = rowIndex === 0;
                    const style = isHeader 
                        ? "border: 1px solid #dee2e6; padding: 12px 8px; text-align: left; background-color: #007bff; color: white; font-weight: bold; font-size: 14px;"
                        : "border: 1px solid #dee2e6; padding: 10px 8px; text-align: left; font-size: 13px;";
                    html += `<${isHeader ? 'th' : 'td'} style="${style}">${cell || '<span style="color: #999; font-style: italic;">空</span>'}</${isHeader ? 'th' : 'td'}>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            html += `<p style="margin-top: 15px; color: #666; font-size: 14px; text-align: center;"><strong>※ ${values.length}行のデータを表示中</strong></p>`;
            
            dataDisplay.innerHTML = html;
        }
        
        async function getSheetsData() {
            showLoading();
            const result = await makeRequest('get_sheets_data');
            hideLoading();
            
            displayResult(result);
            
            if (result.success && result.values) {
                displayDataTable(result.values);
            }
        }
        
        async function writeToSheets() {
            showLoading();
            const result = await makeRequest('write_to_sheets');
            hideLoading();
            
            displayResult(result);
            
            if (result.success) {
                // 書き込み後、データを再取得して表示
                setTimeout(() => {
                    getSheetsData();
                }, 1500);
            }
        }
        
        // ページ読み込み時の初期化
        window.onload = function() {
            console.log('🚀 Google Sheets完全修正版テスト起動完了');
            
            // 起動メッセージ表示
            const resultElement = document.getElementById('result');
            resultElement.style.backgroundColor = '#e7f3ff';
            resultElement.style.color = '#0c5460';
            resultElement.style.borderColor = '#bee5eb';
            resultElement.innerHTML = '🎉 システム起動完了！\n\n上記のボタンをクリックしてGoogle Sheetsとの連携をテストしてください。';
        };
    </script>
</body>
</html>
