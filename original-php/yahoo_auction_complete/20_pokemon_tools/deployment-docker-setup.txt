# docker-compose.yml - é–‹ç™ºç’°å¢ƒ
version: '3.8'

services:
  # PostgreSQL ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: pokemon_content_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis (Celery ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼)
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Django ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
  web:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - media_files:/app/media
      - static_files:/app/staticfiles
    environment:
      - DEBUG=True
      - SECRET_KEY=your-development-secret-key
      - DB_HOST=db
      - DB_NAME=pokemon_content_db
      - DB_USER=postgres
      - DB_PASSWORD=password
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - YOUTUBE_CLIENT_ID=${YOUTUBE_CLIENT_ID}
      - YOUTUBE_CLIENT_SECRET=${YOUTUBE_CLIENT_SECRET}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      sh -c "python manage.py migrate &&
             python manage.py collectstatic --noinput &&
             python manage.py runserver 0.0.0.0:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Celery ãƒ¯ãƒ¼ã‚«ãƒ¼
  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    volumes:
      - ./backend:/app
      - media_files:/app/media
    environment:
      - DEBUG=True
      - SECRET_KEY=your-development-secret-key
      - DB_HOST=db
      - DB_NAME=pokemon_content_db
      - DB_USER=postgres
      - DB_PASSWORD=password
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
    depends_on:
      - db
      - redis
    command: celery -A pokemon_content_system worker -l info -Q default,high_priority,content_generation
    healthcheck:
      test: ["CMD", "celery", "-A", "pokemon_content_system", "inspect", "ping"]
      interval: 60s
      timeout: 30s
      retries: 3

  # Celery Beat (ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼)
  beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    volumes:
      - ./backend:/app
    environment:
      - DEBUG=True
      - SECRET_KEY=your-development-secret-key
      - DB_HOST=db
      - DB_NAME=pokemon_content_db
      - DB_USER=postgres
      - DB_PASSWORD=password
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - db
      - redis
    command: celery -A pokemon_content_system beat -l info

  # React ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
    environment:
      - REACT_APP_API_URL=http://localhost:8000/api/v1
      - CHOKIDAR_USEPOLLING=true
    depends_on:
      - web
    command: npm start
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx (æœ¬ç•ªç’°å¢ƒç”¨ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·)
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - static_files:/var/www/static
      - media_files:/var/www/media
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - web
      - frontend
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  media_files:
  static_files:

---
# docker-compose.prod.yml - æœ¬ç•ªç’°å¢ƒ
version: '3.8'

services:
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  web:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    expose:
      - "8000"
    volumes:
      - media_files:/app/media
      - static_files:/app/staticfiles
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY}
      - DB_HOST=db
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - YOUTUBE_CLIENT_ID=${YOUTUBE_CLIENT_ID}
      - YOUTUBE_CLIENT_SECRET=${YOUTUBE_CLIENT_SECRET}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    command: >
      sh -c "python manage.py migrate &&
             python manage.py collectstatic --noinput &&
             gunicorn pokemon_content_system.wsgi:application --bind 0.0.0.0:8000 --workers 4"

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    volumes:
      - media_files:/app/media
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY}
      - DB_HOST=db
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
    depends_on:
      - db
      - redis
    restart: unless-stopped
    command: celery -A pokemon_content_system worker -l info -Q default,high_priority,content_generation --concurrency=4

  beat:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    volumes:
      - media_files:/app/media
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY}
      - DB_HOST=db
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
    depends_on:
      - db
      - redis
    restart: unless-stopped
    command: celery -A pokemon_content_system beat -l info

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        - REACT_APP_API_URL=${FRONTEND_API_URL}
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf
      - ./nginx/prod.conf:/etc/nginx/conf.d/default.conf
      - static_files:/var/www/static
      - media_files:/var/www/media
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - web
      - frontend
    restart: unless-stopped

  # ç›£è¦–ãƒ»ãƒ­ã‚°ç®¡ç†
  flower:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
    depends_on:
      - redis
    restart: unless-stopped
    command: celery -A pokemon_content_system flower --port=5555

volumes:
  postgres_data:
  redis_data:
  media_files:
  static_files:

---
# backend/Dockerfile
FROM python:3.11-slim

WORKDIR /app

# ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    ffmpeg \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY requirements/base.txt requirements/development.txt ./
RUN pip install --no-cache-dir -r development.txt

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
COPY . .

# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
RUN mkdir -p /app/staticfiles /app/media

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
RUN useradd --create-home --shell /bin/bash app
RUN chown -R app:app /app
USER app

EXPOSE 8000

CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]

---
# backend/Dockerfile.prod
FROM python:3.11-slim

WORKDIR /app

# ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    ffmpeg \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY requirements/base.txt requirements/production.txt ./
RUN pip install --no-cache-dir -r production.txt

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
COPY . .

# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
RUN mkdir -p /app/staticfiles /app/media

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
RUN useradd --create-home --shell /bin/bash app
RUN chown -R app:app /app
USER app

EXPOSE 8000

CMD ["gunicorn", "pokemon_content_system.wsgi:application", "--bind", "0.0.0.0:8000"]

---
# frontend/Dockerfile
FROM node:18-alpine

WORKDIR /app

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼
COPY package*.json ./

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm ci

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
COPY . .

EXPOSE 3000

CMD ["npm", "start"]

---
# frontend/Dockerfile.prod
FROM node:18-alpine AS build

WORKDIR /app

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼
COPY package*.json ./

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm ci

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
COPY . .

# æœ¬ç•ªãƒ“ãƒ«ãƒ‰
ARG REACT_APP_API_URL
ENV REACT_APP_API_URL=$REACT_APP_API_URL
RUN npm run build

# Nginxæœ¬ç•ªç’°å¢ƒ
FROM nginx:alpine
COPY --from=build /app/build /usr/share/nginx/html
COPY nginx/frontend.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]

---
# nginx/nginx.conf
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ãƒ­ã‚°å½¢å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    # Gzipåœ§ç¸®
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        application/atom+xml
        application/javascript
        application/json
        application/ld+json
        application/manifest+json
        application/rss+xml
        application/vnd.geo+json
        application/vnd.ms-fontobject
        application/x-font-ttf
        application/x-web-app-manifest+json
        application/xhtml+xml
        application/xml
        font/opentype
        image/bmp
        image/svg+xml
        image/x-icon
        text/cache-manifest
        text/css
        text/plain
        text/vcard
        text/vnd.rim.location.xloc
        text/vtt
        text/x-component
        text/x-cross-domain-policy;

    include /etc/nginx/conf.d/*.conf;
}

---
# nginx/default.conf - é–‹ç™ºç’°å¢ƒ
upstream backend {
    server web:8000;
}

upstream frontend {
    server frontend:3000;
}

server {
    listen 80;
    server_name localhost;

    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # API ãƒ—ãƒ­ã‚­ã‚·
    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30;
        proxy_send_timeout 30;
        proxy_read_timeout 30;
    }

    # Django Admin
    location /admin/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«
    location /static/ {
        alias /var/www/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«
    location /media/ {
        alias /var/www/media/;
        expires 1y;
        add_header Cache-Control "public";
    }

    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆReactï¼‰
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket ã‚µãƒãƒ¼ãƒˆï¼ˆHMRç”¨ï¼‰
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

---
# .env.example
# Djangoè¨­å®š
SECRET_KEY=your-super-secret-key-here
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1,your-domain.com

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
DB_NAME=pokemon_content_db
DB_USER=postgres
DB_PASSWORD=your-db-password
DB_HOST=db
DB_PORT=5432

# Redisè¨­å®š
REDIS_PASSWORD=your-redis-password

# å¤–éƒ¨APIè¨­å®š
OPENAI_API_KEY=your-openai-api-key
ELEVENLABS_API_KEY=your-elevenlabs-api-key
YOUTUBE_CLIENT_ID=your-youtube-client-id
YOUTUBE_CLIENT_SECRET=your-youtube-client-secret

# WordPressè¨­å®š
WORDPRESS_URL=https://your-site.com
WORDPRESS_USERNAME=your-username
WORDPRESS_PASSWORD=your-app-password

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­å®š
FRONTEND_API_URL=https://your-api-domain.com/api/v1

# AWSè¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
AWS_ACCESS_KEY_ID=your-aws-access-key
AWS_SECRET_ACCESS_KEY=your-aws-secret-key
AWS_STORAGE_BUCKET_NAME=your-s3-bucket

---
# scripts/start-dev.sh
#!/bin/bash

# é–‹ç™ºç’°å¢ƒèµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

echo "ğŸš€ ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è‡ªå‹•ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ  é–‹ç™ºç’°å¢ƒèµ·å‹•ä¸­..."

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
if [ ! -f .env ]; then
    echo "âŒ .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚.env.example ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è¨­å®šã—ã¦ãã ã•ã„ã€‚"
    exit 1
fi

# Docker Composeèµ·å‹•
echo "ğŸ“¦ Docker ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ä¸­..."
docker-compose up -d --build

# ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å¾…æ©Ÿ
echo "â³ ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å¾…æ©Ÿä¸­..."
sleep 30

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
echo "ğŸ” ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª..."
docker-compose exec -T web python manage.py check --database default

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ..."
docker-compose exec -T web python manage.py migrate

# åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
echo "åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥..."
docker-compose exec -T web python manage.py loaddata fixtures/initial_data.json

# ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆåˆå›ã®ã¿ï¼‰
echo "ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰..."
docker-compose exec -T web python manage.py shell -c "
from django.contrib.auth import get_user_model
User = get_user_model()
if not User.objects.filter(username='admin').exists():
    User.objects.create_superuser('admin', 'admin@example.com', 'admin')
    print('ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå®Œäº†: admin/admin')
else:
    print('ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™')
"

# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«åé›†
echo "é™çš„ãƒ•ã‚¡ã‚¤ãƒ«åé›†..."
docker-compose exec -T web python manage.py collectstatic --noinput

echo "âœ… é–‹ç™ºç’°å¢ƒèµ·å‹•å®Œäº†ï¼"
echo ""
echo "ğŸŒ ã‚¢ã‚¯ã‚»ã‚¹URL:"
echo "   ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: http://localhost:3000"
echo "   API: http://localhost:8000/api/v1/"
echo "   Django Admin: http://localhost:8000/admin/ (admin/admin)"
echo "   Flower (Celeryç›£è¦–): http://localhost:5555"
echo ""
echo "ğŸ“š æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
echo "   1. ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®åé›†è¨­å®š"
echo "   2. OpenAI API ã‚­ãƒ¼ã®è¨­å®šç¢ºèª"
echo "   3. WordPressé€£æºã®è¨­å®š"
echo ""

---
# scripts/deploy-prod.sh
#!/bin/bash

# æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

echo "ğŸš€ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹..."

# ç’°å¢ƒç¢ºèª
if [ ! -f .env.prod ]; then
    echo "âŒ .env.prod ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
    exit 1
fi

# æœ¬ç•ªç’°å¢ƒãƒ“ãƒ«ãƒ‰
echo "ğŸ“¦ æœ¬ç•ªç’°å¢ƒãƒ“ãƒ«ãƒ‰ä¸­..."
docker-compose -f docker-compose.prod.yml build --no-cache

# æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢
echo "ğŸ”„ æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ä¸­..."
docker-compose -f docker-compose.prod.yml down

# æœ¬ç•ªç’°å¢ƒèµ·å‹•
echo "ğŸš€ æœ¬ç•ªç’°å¢ƒèµ·å‹•ä¸­..."
docker-compose -f docker-compose.prod.yml up -d

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ..."
docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate

# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«åé›†
echo "ğŸ“ é™çš„ãƒ•ã‚¡ã‚¤ãƒ«åé›†..."
docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
echo "ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯..."
sleep 60

if curl -f http://localhost/api/v1/health/; then
    echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"
    echo "ğŸŒ ã‚µã‚¤ãƒˆURL: https://your-domain.com"
else
    echo "âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—ã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    docker-compose -f docker-compose.prod.yml logs
fi