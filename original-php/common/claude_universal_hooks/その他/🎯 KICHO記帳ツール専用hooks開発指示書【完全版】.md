# üéØ KICHOË®òÂ∏≥„ÉÑ„Éº„É´Â∞ÇÁî®hooksÈñãÁô∫ÊåáÁ§∫Êõ∏„ÄêÂÆåÂÖ®Áâà„Äë

## üìä **ÂØæË±°„Ç∑„Çπ„ÉÜ„É†Ê¶ÇË¶Å**

### **Âü∫Êú¨ÊÉÖÂ†±**
- **„É¢„Ç∏„É•„Éº„É´Âêç**: KICHOË®òÂ∏≥„ÉÑ„Éº„É´
- **ÂØæË±°„Éï„Ç°„Ç§„É´**: `modules/kicho/kicho_content.php`
- **AjaxÂá¶ÁêÜ**: `modules/kicho/kicho_ajax_handler.php`
- **data-action„Éú„Çø„É≥Êï∞**: 40ÂÄã
- **ÂÆüË£ÖÊñπÂºè**: Ë®≠ÂÆö„Éï„Ç°„Ç§„É´ËøΩË®òÊñπÂºèÔºàÊâãÂãïËøΩÂä†„ÉªÂÆåÂÖ®Âà∂Âæ°Ôºâ

### **hooksÈÅ©Áî®ÁØÑÂõ≤**
```javascript
// Â∞ÇÁî®hooksÔºàKICHOË®òÂ∏≥„ÉÑ„Éº„É´Â∞ÇÁî®Ôºâ
const KICHO_SPECIFIC_ACTIONS = [
    'execute-integrated-ai-learning',    // AIÂ≠¶ÁøíÔºàË®òÂ∏≥ÁâπÂåñÔºâ
    'execute-mf-import',                 // MF„ÇØ„É©„Ç¶„ÉâÈÄ£Êê∫ÔºàË®òÂ∏≥ÁâπÂåñÔºâ
    'bulk-approve-transactions',         // ÂèñÂºïÊâøË™çÔºàË®òÂ∏≥ÁâπÂåñÔºâ
    'download-rules-csv',                // „É´„Éº„É´ÁÆ°ÁêÜÔºàË®òÂ∏≥ÁâπÂåñÔºâ
    'download-pending-csv',              // ÊâøË™çÂæÖ„Å°CSVÔºàË®òÂ∏≥ÁâπÂåñÔºâ
    'save-uploaded-rules-as-database',   // „É´„Éº„É´‰øùÂ≠òÔºàË®òÂ∏≥ÁâπÂåñÔºâ
];

// Ê±éÁî®hooksÔºà‰ªñ„É¢„Ç∏„É•„Éº„É´„Åß„ÇÇ‰ΩøÁî®‰∫àÂÆöÔºâ
const COMMON_ACTIONS = [
    'delete-data-item',                  // „Éá„Éº„ÇøÂâäÈô§
    'select-all-imported-data',          // ‰∏ÄÊã¨ÈÅ∏Êäû
    'refresh-all',                       // ÁîªÈù¢Êõ¥Êñ∞
    'process-csv-upload',                // CSVÂá¶ÁêÜ
    'execute-full-backup'                // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
];
```

---

## üìÅ **„Éï„Ç°„Ç§„É´ÊßãÈÄ†„Éª‰øùÂ≠òÂ†¥ÊâÄ**

### **hooksË®≠ÂÆö„Éï„Ç°„Ç§„É´ÈÖçÁΩÆ**
```
NAGANO3_PROJECT/
‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ kicho_hooks.json         ‚Üê KICHOÂ∞ÇÁî®hooksË®≠ÂÆö
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common_hooks.json        ‚Üê ÂÖ±ÈÄöhooksË®≠ÂÆöÔºàÂ∞ÜÊù•Áî®Ôºâ
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ui_animations.json       ‚Üê UI„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ modules_config.php           ‚Üê Êó¢Â≠ò„ÅÆ„É¢„Ç∏„É•„Éº„É´Ë®≠ÂÆö
‚îÇ   ‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ kicho_hooks_engine.js    ‚Üê KICHO hooksÂÆüË°å„Ç®„É≥„Ç∏„É≥
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ui_controller.js         ‚Üê UIÂà∂Âæ°Â∞ÇÁî®
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ error_handler.js         ‚Üê „Ç®„É©„ÉºÂá¶ÁêÜÂ∞ÇÁî®
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ kicho.js                 ‚Üê Êó¢Â≠òKICHO JavaScript
‚îî‚îÄ‚îÄ modules/kicho/
    ‚îú‚îÄ‚îÄ kicho_content.php                ‚Üê „É°„Ç§„É≥HTMLÔºà40ÂÄã„Éú„Çø„É≥Ôºâ
    ‚îú‚îÄ‚îÄ kicho_ajax_handler.php           ‚Üê AjaxÂá¶ÁêÜ
    ‚îî‚îÄ‚îÄ kicho_hooks_override.json        ‚Üê KICHOÂÄãÂà•„Ç´„Çπ„Çø„Éû„Ç§„Ç∫
```

### **JSONË®≠ÂÆö„Éá„Éº„ÇøÊßãÈÄ†**
```json
// common/config/hooks/kicho_hooks.json
{
  "module_name": "kicho",
  "version": "1.0.0",
  "hooks_engine": "kicho_hooks_engine.js",
  "ui_patterns": {
    "delete_animation": {
      "duration": "300ms",
      "easing": "ease-out",
      "css_class": "kicho__delete-animation"
    },
    "add_animation": {
      "duration": "400ms", 
      "easing": "ease-in",
      "css_class": "kicho__add-animation"
    },
    "loading_animation": {
      "duration": "infinite",
      "css_class": "kicho__loading-spinner"
    }
  },
  "error_handling": {
    "notification_type": "toast",
    "position": "top-right",
    "duration": 5000,
    "retry_enabled": true
  },
  "mf_integration": {
    "backup_before_send": true,
    "approval_required": true,
    "dry_run_mode": false
  },
  "actions": {
    "delete-data-item": {
      "ui_update": "delete_animation",
      "success_message": "„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü",
      "error_retry": true,
      "backup_required": true
    },
    "execute-mf-import": {
      "ui_update": "loading_animation",
      "success_message": "MF„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü",
      "backup_before": true,
      "approval_flow": true
    },
    "execute-integrated-ai-learning": {
      "ui_update": "ai_learning_complete",
      "success_message": "AIÂ≠¶Áøí„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü",
      "clear_input": "#aiTextInput",
      "show_results": true
    }
  }
}
```

---

## üîß **ÂÆüË£ÖÊâãÈ†ÜÔºàÊÆµÈöéÁöÑÔºâ**

### **Phase 1: Âü∫Êú¨hooks‰ΩúÊàê**

#### **Step 1-1: hooksË®≠ÂÆö„Éï„Ç°„Ç§„É´‰ΩúÊàê**
```bash
# „Éá„Ç£„É¨„ÇØ„Éà„É™‰ΩúÊàê
mkdir -p common/config/hooks
mkdir -p common/js/hooks

# Âü∫Êú¨Ë®≠ÂÆö„Éï„Ç°„Ç§„É´‰ΩúÊàê
touch common/config/hooks/kicho_hooks.json
touch common/config/hooks/ui_animations.json
```

#### **Step 1-2: hooksÂÆüË°å„Ç®„É≥„Ç∏„É≥‰ΩúÊàê**
```javascript
// common/js/hooks/kicho_hooks_engine.js
class KichoHooksEngine {
    constructor() {
        this.config = null;
        this.uiController = new UIController();
        this.errorHandler = new ErrorHandler();
        this.loadConfig();
    }
    
    async loadConfig() {
        try {
            const response = await fetch('/common/config/hooks/kicho_hooks.json');
            this.config = await response.json();
            console.log('‚úÖ KICHO HooksË®≠ÂÆöË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
        } catch (error) {
            console.error('‚ùå KICHO HooksË®≠ÂÆöË™≠„ÅøËæº„ÅøÂ§±Êïó:', error);
        }
    }
    
    executeAction(actionName, target, data = {}) {
        const actionConfig = this.config?.actions?.[actionName];
        
        if (!actionConfig) {
            console.warn(`‚ö†Ô∏è Êú™ÂÆöÁæ©„Ç¢„ÇØ„Ç∑„Éß„É≥: ${actionName}`);
            return;
        }
        
        // 1. „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈñãÂßã
        if (actionConfig.ui_update === 'loading_animation') {
            this.uiController.showLoading(target);
        }
        
        // 2. AjaxÂÆüË°å
        this.executeAjax(actionName, data)
            .then(result => this.handleSuccess(result, actionConfig, target))
            .catch(error => this.handleError(error, actionConfig, target));
    }
    
    async executeAjax(action, data) {
        const formData = new FormData();
        formData.append('action', action);
        formData.append('csrf_token', this.getCSRFToken());
        
        Object.entries(data).forEach(([key, value]) => {
            formData.append(key, value);
        });
        
        const response = await fetch(window.location.pathname, {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            body: formData
        });
        
        return await response.json();
    }
    
    handleSuccess(result, actionConfig, target) {
        // 1. „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁµÇ‰∫Ü
        this.uiController.hideLoading(target);
        
        // 2. UIÊõ¥Êñ∞ÂÆüË°å
        if (actionConfig.ui_update) {
            this.uiController.executeUIUpdate(actionConfig.ui_update, result, target);
        }
        
        // 3. ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        if (actionConfig.success_message) {
            this.uiController.showNotification(actionConfig.success_message, 'success');
        }
    }
    
    handleError(error, actionConfig, target) {
        this.uiController.hideLoading(target);
        this.errorHandler.handleError(error, actionConfig, target);
    }
    
    getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]')?.content || '';
    }
}
```

### **Phase 2: UIÂà∂Âæ°ÂÆüË£Ö**

#### **Step 2-1: UIÂà∂Âæ°„ÇØ„É©„Çπ‰ΩúÊàê**
```javascript
// common/js/hooks/ui_controller.js
class UIController {
    constructor() {
        this.loadingElements = new Map();
        this.animationQueue = [];
    }
    
    showLoading(target) {
        const element = typeof target === 'string' ? document.querySelector(target) : target;
        if (!element) return;
        
        const loadingSpinner = document.createElement('div');
        loadingSpinner.className = 'kicho__loading-spinner';
        loadingSpinner.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        element.style.position = 'relative';
        element.appendChild(loadingSpinner);
        
        this.loadingElements.set(element, loadingSpinner);
    }
    
    hideLoading(target) {
        const element = typeof target === 'string' ? document.querySelector(target) : target;
        if (!element) return;
        
        const spinner = this.loadingElements.get(element);
        if (spinner && spinner.parentNode) {
            spinner.parentNode.removeChild(spinner);
            this.loadingElements.delete(element);
        }
    }
    
    executeUIUpdate(updateType, result, target) {
        switch (updateType) {
            case 'delete_animation':
                this.executeDeleteAnimation(result, target);
                break;
            case 'ai_learning_complete':
                this.executeAILearningComplete(result, target);
                break;
            case 'add_animation':
                this.executeAddAnimation(result, target);
                break;
            default:
                console.warn(`‚ö†Ô∏è Êú™ÂØæÂøúUIÊõ¥Êñ∞„Çø„Ç§„Éó: ${updateType}`);
        }
    }
    
    executeDeleteAnimation(result, originalElement) {
        const itemId = result.data?.deleted_id;
        const targetRow = document.querySelector(`[data-item-id="${itemId}"]`);
        
        if (targetRow) {
            // ÂâäÈô§„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆüË°å
            targetRow.style.transition = 'all 0.3s ease';
            targetRow.style.backgroundColor = '#ffebee';
            targetRow.style.opacity = '0.5';
            targetRow.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                targetRow.style.transform = 'translateX(-100%)';
                targetRow.style.opacity = '0';
                
                setTimeout(() => {
                    if (targetRow.parentNode) {
                        targetRow.parentNode.removeChild(targetRow);
                    }
                    
                    // „Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
                    this.updateCounters(-1);
                    
                    // Á©∫Áä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ
                    this.checkEmptyState();
                    
                }, 200);
            }, 100);
        }
    }
    
    executeAILearningComplete(result, originalElement) {
        // 1. ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇØ„É™„Ç¢
        const textInput = document.querySelector('#aiTextInput');
        if (textInput) {
            textInput.value = '';
            textInput.style.borderColor = '#4caf50';
            setTimeout(() => textInput.style.borderColor = '', 2000);
        }
        
        // 2. AIÁµêÊûúË°®Á§∫
        this.displayAIResults(result.data);
        
        // 3. AIÂ±•Ê≠¥Êõ¥Êñ∞
        this.updateAIHistory(result.data);
    }
    
    displayAIResults(aiData) {
        let resultsContainer = document.getElementById('ai-learning-results');
        
        if (!resultsContainer) {
            resultsContainer = document.createElement('div');
            resultsContainer.id = 'ai-learning-results';
            resultsContainer.className = 'ai-learning-results';
            
            const aiSection = document.querySelector('#aiTextInput').closest('.kicho__card');
            if (aiSection) {
                aiSection.appendChild(resultsContainer);
            }
        }
        
        const resultHTML = `
            <div class="ai-result-header">
                <h4>ü§ñ AIÂ≠¶ÁøíÂÆå‰∫Ü: ${aiData.session_id}</h4>
                <div class="ai-metrics">
                    <span><strong>Á≤æÂ∫¶:</strong> ${(aiData.accuracy * 100).toFixed(1)}%</span>
                    <span><strong>‰ø°È†ºÂ∫¶:</strong> ${(aiData.confidence * 100).toFixed(1)}%</span>
                </div>
            </div>
            <div class="ai-visualization">
                ${aiData.visualization || ''}
            </div>
        `;
        
        resultsContainer.innerHTML = resultHTML;
        resultsContainer.style.opacity = '0';
        resultsContainer.style.transform = 'translateY(-20px)';
        
        requestAnimationFrame(() => {
            resultsContainer.style.transition = 'all 0.5s ease';
            resultsContainer.style.opacity = '1';
            resultsContainer.style.transform = 'translateY(0)';
        });
    }
    
    updateCounters(delta) {
        const counters = document.querySelectorAll('[data-counter]');
        counters.forEach(counter => {
            const current = parseInt(counter.textContent) || 0;
            const newCount = Math.max(0, current + delta);
            
            // „Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            counter.style.transform = 'scale(1.2)';
            counter.style.color = delta > 0 ? '#4caf50' : '#f44336';
            
            setTimeout(() => {
                counter.textContent = newCount;
                counter.style.transform = 'scale(1)';
                counter.style.color = '';
            }, 150);
        });
    }
    
    checkEmptyState() {
        const containers = document.querySelectorAll('[data-container]');
        containers.forEach(container => {
            const items = container.querySelectorAll('[data-item-id]');
            let emptyMessage = container.querySelector('.empty-state');
            
            if (items.length === 0) {
                if (!emptyMessage) {
                    emptyMessage = document.createElement('div');
                    emptyMessage.className = 'empty-state';
                    emptyMessage.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                            <p>„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                        </div>
                    `;
                    container.appendChild(emptyMessage);
                }
            } else {
                if (emptyMessage) {
                    emptyMessage.remove();
                }
            }
        });
    }
    
    showNotification(message, type = 'info', duration = 5000) {
        // ËªΩÈáèÈÄöÁü•ÔºàToastÔºâ„ÅÆÂÆüË£Ö
        let container = document.getElementById('kicho-notifications');
        
        if (!container) {
            container = document.createElement('div');
            container.id = 'kicho-notifications';
            container.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 400px;
                pointer-events: none;
            `;
            document.body.appendChild(container);
        }
        
        const notification = document.createElement('div');
        notification.className = `kicho__notification kicho__notification--${type}`;
        notification.style.cssText = `
            background: ${this.getNotificationColor(type)};
            color: white;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            pointer-events: auto;
            cursor: pointer;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>${message}</span>
                <button style="background: none; border: none; color: white; cursor: pointer; margin-left: 8px;">√ó</button>
            </div>
        `;
        
        container.appendChild(notification);
        
        // Ë°®Á§∫„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        requestAnimationFrame(() => {
            notification.style.transform = 'translateX(0)';
        });
        
        // Ëá™ÂãïÂâäÈô§
        if (duration > 0) {
            setTimeout(() => {
                this.hideNotification(notification);
            }, duration);
        }
        
        // „ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        notification.addEventListener('click', () => {
            this.hideNotification(notification);
        });
    }
    
    hideNotification(notification) {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }
    
    getNotificationColor(type) {
        const colors = {
            'success': '#4caf50',
            'error': '#f44336',
            'warning': '#ff9800', 
            'info': '#2196f3'
        };
        return colors[type] || colors.info;
    }
}
```

### **Phase 3: „Ç®„É©„ÉºÂá¶ÁêÜÂÆüË£Ö**

#### **Step 3-1: „Ç®„É©„Éº„Éè„É≥„Éâ„É©„Éº‰ΩúÊàê**
```javascript
// common/js/hooks/error_handler.js
class ErrorHandler {
    constructor() {
        this.retryAttempts = new Map();
        this.maxRetries = 3;
    }
    
    handleError(error, actionConfig, target) {
        console.error('‚ùå KICHO Hooks „Ç®„É©„Éº:', error);
        
        // „Ç®„É©„ÉºÂàÜÈ°û
        const errorType = this.classifyError(error);
        
        // „Ç®„É©„Éº„Çø„Ç§„ÉóÂà•Âá¶ÁêÜ
        switch (errorType) {
            case 'network':
                this.handleNetworkError(error, actionConfig, target);
                break;
            case 'database':
                this.handleDatabaseError(error, actionConfig, target);
                break;
            case 'validation':
                this.handleValidationError(error, actionConfig, target);
                break;
            case 'permission':
                this.handlePermissionError(error, actionConfig, target);
                break;
            default:
                this.handleGenericError(error, actionConfig, target);
        }
    }
    
    classifyError(error) {
        const message = error.message || '';
        
        if (message.includes('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ') || message.includes('ÈÄö‰ø°')) {
            return 'network';
        } else if (message.includes('„Éá„Éº„Çø„Éô„Éº„Çπ') || message.includes('SQL')) {
            return 'database';
        } else if (message.includes('„Éê„É™„Éá„Éº„Ç∑„Éß„É≥') || message.includes('ÂÖ•Âäõ')) {
            return 'validation';
        } else if (message.includes('Ê®©Èôê') || message.includes('403')) {
            return 'permission';
        }
        
        return 'generic';
    }
    
    handleNetworkError(error, actionConfig, target) {
        const ui = new UIController();
        
        // „É™„Éà„É©„Ç§ÂèØËÉΩ„Å™Â†¥Âêà
        if (actionConfig.error_retry && this.canRetry(target)) {
            ui.showNotification(
                '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÂÜçË©¶Ë°å„Åó„Å¶„ÅÑ„Åæ„Åô...', 
                'warning'
            );
            
            setTimeout(() => {
                this.retryAction(target, actionConfig);
            }, 2000);
        } else {
            ui.showNotification(
                '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæå„Å´ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                'error'
            );
        }
    }
    
    handleDatabaseError(error, actionConfig, target) {
        const ui = new UIController();
        ui.showNotification(
            '„Éá„Éº„Çø„Éô„Éº„Çπ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ',
            'error'
        );
    }
    
    handleValidationError(error, actionConfig, target) {
        const ui = new UIController();
        ui.showNotification(
            error.message || 'ÂÖ•ÂäõÂÜÖÂÆπ„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
            'warning'
        );
    }
    
    handlePermissionError(error, actionConfig, target) {
        const ui = new UIController();
        ui.showNotification(
            '„Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ',
            'error'
        );
    }
    
    handleGenericError(error, actionConfig, target) {
        const ui = new UIController();
        ui.showNotification(
            error.message || '‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ',
            'error'
        );
    }
    
    canRetry(target) {
        const currentAttempts = this.retryAttempts.get(target) || 0;
        return currentAttempts < this.maxRetries;
    }
    
    retryAction(target, actionConfig) {
        const currentAttempts = this.retryAttempts.get(target) || 0;
        this.retryAttempts.set(target, currentAttempts + 1);
        
        // ÂÖÉ„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂÜçÂÆüË°å
        const action = target.getAttribute('data-action');
        if (action) {
            window.KICHO_HOOKS_ENGINE?.executeAction(action, target);
        }
    }
}
```

### **Phase 4: MFÈÄ£Êê∫ÂÆüË£Ö**

#### **Step 4-1: MFÈÄ£Êê∫Ë®≠ÂÆö**
```php
// modules/kicho/kicho_mf_integration.php
<?php
/**
 * MF„ÇØ„É©„Ç¶„ÉâÈÄ£Êê∫Ë®≠ÂÆö„ÉªAPIÊé•Á∂öÊÉÖÂ†±ÂèñÂæó
 */

class KichoMFIntegration {
    
    /**
     * MF APIÊé•Á∂öÊÉÖÂ†±„ÇíÂèñÂæó
     * ÂÑ™ÂÖàÈ†Ü: .envÈö†„Åó„Éï„Ç°„Ç§„É´ ‚Üí „Éá„Éº„Çø„Éô„Éº„Çπ ‚Üí Ë®≠ÂÆö„Éï„Ç°„Ç§„É´
     */
    public static function getMFConfig() {
        // 1. Áí∞Â¢ÉÂ§âÊï∞„Åã„ÇâÂèñÂæóÔºàÈö†„Åó„Éï„Ç°„Ç§„É´Ôºâ
        $envFile = __DIR__ . '/../../.env';
        if (file_exists($envFile)) {
            $envVars = parse_ini_file($envFile);
            if (isset($envVars['MF_API_KEY']) && isset($envVars['MF_CLIENT_ID'])) {
                return [
                    'api_key' => $envVars['MF_API_KEY'],
                    'client_id' => $envVars['MF_CLIENT_ID'],
                    'client_secret' => $envVars['MF_CLIENT_SECRET'] ?? '',
                    'environment' => $envVars['ENVIRONMENT'] ?? 'production',
                    'source' => 'env_file'
                ];
            }
        }
        
        // 2. „Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÂèñÂæó
        try {
            $pdo = getKichoDatabase();
            $stmt = $pdo->prepare("SELECT * FROM api_settings WHERE service = 'mf_cloud' AND active = 1 LIMIT 1");
            $stmt->execute();
            $dbConfig = $stmt->fetch();
            
            if ($dbConfig) {
                return [
                    'api_key' => $dbConfig['api_key'],
                    'client_id' => $dbConfig['client_id'],
                    'client_secret' => $dbConfig['client_secret'] ?? '',
                    'environment' => $dbConfig['environment'] ?? 'production',
                    'source' => 'database'
                ];
            }
        } catch (Exception $e) {
            error_log('MFË®≠ÂÆö„Éá„Éº„Çø„Éô„Éº„ÇπÂèñÂæóÂ§±Êïó: ' . $e->getMessage());
        }
        
        // 3. Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„Åã„ÇâÂèñÂæóÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
        $configFile = __DIR__ . '/../../common/config/mf_config.php';
        if (file_exists($configFile)) {
            $fileConfig = include $configFile;
            return [
                'api_key' => $fileConfig['api_key'] ?? '',
                'client_id' => $fileConfig['client_id'] ?? '',
                'client_secret' => $fileConfig['client_secret'] ?? '',
                'environment' => $fileConfig['environment'] ?? 'production',
                'source' => 'config_file'
            ];
        }
        
        throw new Exception('MF APIË®≠ÂÆö„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
    }
    
    /**
     * MFÈÄÅ‰ø°Ââç„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆüË°å
     */
    public static function createBackupBeforeMFSend($data) {
        $backupData = [
            'timestamp' => date('Y-m-d H:i:s'),
            'data_type' => 'mf_send_backup',
            'data' => $data,
            'user_id' => $_SESSION['user_id'] ?? 'system'
        ];
        
        $backupFile = __DIR__ . '/../../data/backups/mf_backup_' . date('Ymd_His') . '.json';
        
        // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éá„Ç£„É¨„ÇØ„Éà„É™‰ΩúÊàê
        $backupDir = dirname($backupFile);
        if (!is_dir($backupDir)) {
            mkdir($backupDir, 0755, true);
        }
        
        file_put_contents($backupFile, json_encode($backupData, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
        
        return $backupFile;
    }
    
    /**
     * MFÈÄÅ‰ø°ÂÆüË°åÔºàÊâøË™ç„Éï„É≠„Éº‰ªò„ÅçÔºâ
     */
    public static function executeMFSend($data, $requireApproval = true) {
        // 1. „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàê
        $backupFile = self::createBackupBeforeMFSend($data);
        
        // 2. ÊâøË™ç„Éï„É≠„ÉºÔºàË®≠ÂÆö„ÅßÊúâÂäπ„Å™Â†¥ÂêàÔºâ
        if ($requireApproval) {
            // ÊâøË™çÂæÖ„Å°Áä∂ÊÖã„Çí„Éá„Éº„Çø„Éô„Éº„Çπ„Å´Ë®òÈå≤
            $pdo = getKichoDatabase();
            $stmt = $pdo->prepare("INSERT INTO mf_send_approvals (data, backup_file, status, created_at) VALUES (?, ?, 'pending', NOW())");
            $stmt->execute([json_encode($data), $backupFile]);
            
            return [
                'status' => 'approval_required',
                'message' => 'MFÈÄÅ‰ø°„ÅÆÊâøË™çÂæÖ„Å°„Åß„Åô„ÄÇÁÆ°ÁêÜËÄÖ„ÅÆÊâøË™çÂæå„Å´ÈÄÅ‰ø°„Åï„Çå„Åæ„Åô„ÄÇ',
                'approval_id' => $pdo->lastInsertId(),
                'backup_file' => $backupFile
            ];
        }
        
        // 3. ÂÆüÈöõ„ÅÆMFÈÄÅ‰ø°ÂÆüË°å
        return self::sendToMFCloud($data);
    }
    
    /**
     * MF„ÇØ„É©„Ç¶„Éâ„Å∏„ÅÆÂÆüÈöõ„ÅÆÈÄÅ‰ø°
     */
    private static function sendToMFCloud($data) {
        $config = self::getMFConfig();
        
        // ÈñãÁô∫Áí∞Â¢É„ÉÅ„Çß„ÉÉ„ÇØ
        if ($config['environment'] === 'development') {
            // ÈñãÁô∫Áí∞Â¢ÉÔºö„É≠„Ç∞Ë®òÈå≤„ÅÆ„Åø
            error_log('MFÈÄÅ‰ø°ÔºàÈñãÁô∫Áí∞Â¢ÉÔºâ: ' . json_encode($data));
            return [
                'status' => 'development_mode',
                'message' => 'ÈñãÁô∫Áí∞Â¢É„ÅÆ„Åü„ÇÅ„ÄÅÂÆüÈöõ„ÅÆÈÄÅ‰ø°„ÅØË°å„Çè„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ',
                'logged_data' => $data
            ];
        }
        
        // ÂÆüÈöõ„ÅÆMF APIÈÄÅ‰ø°Âá¶ÁêÜ
        $mfApiUrl = 'https://api.moneyforward.com/v1/journals';
        
        $headers = [
            'Authorization: Bearer ' . $config['api_key'],
            'Content-Type: application/json'
        ];
        
        $options = [
            'http' => [
                'header' => implode("\r\n", $headers),
                'method' => 'POST',
                'content' => json_encode($data)
            ]
        ];
        
        $context = stream_context_create($options);
        $response = file_get_contents($mfApiUrl, false, $context);
        
        if ($response === FALSE) {
            throw new Exception('MF„ÇØ„É©„Ç¶„Éâ„Å®„ÅÆÈÄö‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }
        
        $result = json_decode($response, true);
        
        return [
            'status' => 'success',
            'message' => 'MF„ÇØ„É©„Ç¶„Éâ„Å´Ê≠£Â∏∏„Å´ÈÄÅ‰ø°„Åï„Çå„Åæ„Åó„Åü„ÄÇ',
            'mf_response' => $result
        ];
    }
}
?>
```

---

## üß™ **Âãï‰ΩúÁ¢∫Ë™ç„Éª„ÉÜ„Çπ„ÉàÊâãÈ†Ü**

### **„ÉÜ„Çπ„ÉàÁí∞Â¢ÉÊ∫ñÂÇô**
```bash
# 1. „ÉÜ„Çπ„ÉàÁî®„Éá„Ç£„É¨„ÇØ„Éà„É™‰ΩúÊàê
mkdir -p test/kicho_hooks

# 2. „ÉÜ„Çπ„ÉàÂÆüË°å„Çπ„ÇØ„É™„Éó„Éà‰ΩúÊàê
cat > test/kicho_hooks/run_tests.js << 'EOF'
/**
 * KICHO HooksÂãï‰ΩúÁ¢∫Ë™ç„ÉÜ„Çπ„Éà
 */
console.log('üß™ KICHO Hooks „ÉÜ„Çπ„ÉàÈñãÂßã');

// Âü∫Êú¨Ê©üËÉΩ„ÉÜ„Çπ„Éà
testBasicHooksEngine();
testUIController();
testErrorHandler();
testMFIntegration();

console.log('‚úÖ KICHO Hooks „ÉÜ„Çπ„ÉàÂÆå‰∫Ü');
EOF
```

### **ÂêÑ„Éú„Çø„É≥Âãï‰Ωú„ÉÜ„Çπ„Éà**
```javascript
// „ÉÜ„Çπ„ÉàÂØæË±°40ÂÄã„Éú„Çø„É≥„ÅÆÂãï‰ΩúÁ¢∫Ë™ç
const KICHO_TEST_ACTIONS = [
    // „Ç∑„Çπ„ÉÜ„É†Âü∫Êú¨Ê©üËÉΩ
    'refresh-all',
    'toggle-auto-refresh', 
    'health-check',
    
    // „Éá„Éº„ÇøÂèñ„ÇäËæº„ÅøÊ©üËÉΩ
    'execute-mf-import',
    'process-csv-upload',
    'add-text-to-learning',
    
    // „Éá„Éº„ÇøÊìç‰ΩúÊ©üËÉΩ
    'delete-data-item',
    'select-all-imported-data',
    'select-by-source',
    
    // AIÂ≠¶ÁøíÊ©üËÉΩ
    'execute-integrated-ai-learning',
    
    // „É´„Éº„É´ÁÆ°ÁêÜÊ©üËÉΩ
    'download-rules-csv',
    'save-uploaded-rules-as-database',
    
    // ÊâøË™ç„ÉªÂèñÂºïÁÆ°ÁêÜ
    'bulk-approve-transactions',
    'download-pending-csv',
    
    // „Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÉªÈÄÅ‰ø°
    'export-to-mf',
    'execute-full-backup'
];

// ÂêÑ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅÆÂãï‰Ωú„ÉÜ„Çπ„Éà
KICHO_TEST_ACTIONS.forEach(action => {
    console.log(`üß™ „ÉÜ„Çπ„ÉàÂÆüË°å: ${action}`);
    
    // 1. „Éú„Çø„É≥Ë¶ÅÁ¥†ÂèñÂæó
    const button = document.querySelector(`[data-action="${action}"]`);
    
    if (!button) {
        console.warn(`‚ö†Ô∏è „Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${action}`);
        return;
    }
    
    // 2. hooksÂÆüË°å„ÉÜ„Çπ„Éà
    try {
        window.KICHO_HOOKS_ENGINE?.executeAction(action, button, {test: true});
        console.log(`‚úÖ ${action} - hooksÂÆüË°åÊàêÂäü`);
    } catch (error) {
        console.error(`‚ùå ${action} - hooksÂÆüË°åÂ§±Êïó:`, error);
    }
});
```

---

## üîó **Áµ±Âêà„ÉªÂàùÊúüÂåñ**

### **„É°„Ç§„É≥„Ç®„É≥„Éà„É™„Éº„Éù„Ç§„É≥„Éà**
```javascript
// common/js/pages/kicho.jsÔºàÊó¢Â≠ò„Éï„Ç°„Ç§„É´„Å´ËøΩÂä†Ôºâ

// KICHO Hooks Engine „ÅÆÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ KICHO Hooks „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÈñãÂßã');
    
    // Hooks EngineÂàùÊúüÂåñ
    window.KICHO_HOOKS_ENGINE = new KichoHooksEngine();
    
    // ÂÖ®data-action„Éú„Çø„É≥„Å´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
    document.addEventListener('click', function(event) {
        const target = event.target.closest('[data-action]');
        if (!target) return;
        
        const action = target.getAttribute('data-action');
        
        // KICHOÂ∞ÇÁî®„Ç¢„ÇØ„Ç∑„Éß„É≥Âà§ÂÆö
        if (KICHO_ACTIONS.includes(action)) {
            event.stopImmediatePropagation();
            event.preventDefault();
            
            // „Éá„Éº„ÇøÊäΩÂá∫
            const data = extractDataFromTarget(target);
            
            // HooksÂÆüË°å
            window.KICHO_HOOKS_ENGINE.executeAction(action, target, data);
            
            return false;
        }
    }, true);
    
    console.log('‚úÖ KICHO Hooks „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
});

// data-action ‚Üí PHPÁî®„Éá„Éº„ÇøÂ§âÊèõ
function extractDataFromTarget(target) {
    const data = {};
    
    Object.entries(target.dataset).forEach(([key, value]) => {
        if (key !== 'action') {
            const phpKey = key.replace(/([A-Z])/g, '_$1').toLowerCase();
            data[phpKey] = value;
        }
    });
    
    return data;
}

// KICHOÂ∞ÇÁî®„Ç¢„ÇØ„Ç∑„Éß„É≥‰∏ÄË¶ß
const KICHO_ACTIONS = [
    'refresh-all', 'toggle-auto-refresh', 'health-check',
    'execute-mf-import', 'process-csv-upload', 'add-text-to-learning',
    'show-import-history', 'show-mf-history', 'execute-mf-recovery',
    'show-duplicate-history', 'show-ai-learning-history', 'show-optimization-suggestions',
    'select-all-imported-data', 'select-by-date-range', 'select-by-source',
    'delete-selected-data', 'delete-data-item',
    'execute-integrated-ai-learning',
    'download-rules-csv', 'create-new-rule', 'download-all-rules-csv',
    'rules-csv-upload', 'save-uploaded-rules-as-database',
    'edit-saved-rule', 'delete-saved-rule',
    'download-pending-csv', 'download-pending-transactions-csv',
    'approval-csv-upload', 'bulk-approve-transactions',
    'view-transaction-details', 'delete-approved-transaction',
    'refresh-ai-history', 'load-more-sessions',
    'execute-full-backup', 'export-to-mf', 'create-manual-backup',
    'generate-advanced-report', 'get_statistics', 'get-ai-status', 'get-ai-history'
];
```

---

## üìã **ÂÆüË£Ö„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà**

### **Phase 1ÂÆå‰∫ÜÁ¢∫Ë™ç**
- [ ] `common/config/hooks/kicho_hooks.json` ‰ΩúÊàê
- [ ] `common/config/hooks/ui_animations.json` ‰ΩúÊàê  
- [ ] `common/js/hooks/kicho_hooks_engine.js` ‰ΩúÊàê
- [ ] Âü∫Êú¨Ë®≠ÂÆöË™≠„ÅøËæº„ÅøÂãï‰ΩúÁ¢∫Ë™ç

### **Phase 2ÂÆå‰∫ÜÁ¢∫Ë™ç**
- [ ] `common/js/hooks/ui_controller.js` ‰ΩúÊàê
- [ ] ÂâäÈô§„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âãï‰ΩúÁ¢∫Ë™ç
- [ ] AIÂ≠¶ÁøíÁµêÊûúË°®Á§∫Âãï‰ΩúÁ¢∫Ë™ç
- [ ] ÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†Âãï‰ΩúÁ¢∫Ë™ç

### **Phase 3ÂÆå‰∫ÜÁ¢∫Ë™ç**
- [ ] `common/js/hooks/error_handler.js` ‰ΩúÊàê
- [ ] „Ç®„É©„ÉºÂàÜÈ°û„Ç∑„Çπ„ÉÜ„É†Âãï‰ΩúÁ¢∫Ë™ç
- [ ] „É™„Éà„É©„Ç§Ê©üËÉΩÂãï‰ΩúÁ¢∫Ë™ç
- [ ] „Ç®„É©„ÉºÈÄöÁü•Ë°®Á§∫Á¢∫Ë™ç

### **Phase 4ÂÆå‰∫ÜÁ¢∫Ë™ç**
- [ ] `modules/kicho/kicho_mf_integration.php` ‰ΩúÊàê
- [ ] MF APIË®≠ÂÆöÂèñÂæóÂãï‰ΩúÁ¢∫Ë™ç
- [ ] „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóËá™ÂãïÁîüÊàêÁ¢∫Ë™ç
- [ ] ÊâøË™ç„Éï„É≠„ÉºÂãï‰ΩúÁ¢∫Ë™ç

### **Áµ±Âêà„ÉÜ„Çπ„ÉàÁ¢∫Ë™ç**
- [ ] 40ÂÄãdata-action„Éú„Çø„É≥ÂÖ®Âãï‰ΩúÁ¢∫Ë™ç
- [ ] UIÊõ¥Êñ∞„Éª„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Á¢∫Ë™ç
- [ ] „Ç®„É©„ÉºÂá¶ÁêÜ„ÉªÂæ©ÊóßÁ¢∫Ë™ç
- [ ] MFÈÄ£Êê∫„Éª„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÁ¢∫Ë™ç

---

## üöÄ **Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó**

### **Êú¨ÊåáÁ§∫Êõ∏ÂÆåÊàêÂæå„ÅÆ‰ΩúÊ•≠**
1. **Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà„ÅßÂÆüË£ÖÂÆüË°å**
2. **Âãï‰ΩúÁ¢∫Ë™ç„Éª„Éá„Éê„ÉÉ„Ç∞**
3. **ÂÖ±ÈÄöhooksÊäΩÂá∫‰ΩúÊ•≠**
4. **‰ªñ„É¢„Ç∏„É•„Éº„É´Â±ïÈñãÊ∫ñÂÇô**

### **ÊàêÂäüÂü∫Ê∫ñ**
- 40ÂÄãdata-action„Éú„Çø„É≥„ÅÆ95%‰ª•‰∏ä„ÅåÊ≠£Â∏∏Âãï‰Ωú
- UIÊõ¥Êñ∞„Éª„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅåÊúüÂæÖÈÄö„ÇäÂãï‰Ωú
- „Ç®„É©„ÉºÂá¶ÁêÜ„ÅåÈÅ©Âàá„Å´Ê©üËÉΩ
- MFÈÄ£Êê∫„ÅåÂÆâÂÖ®„Å´Âãï‰ΩúÔºà„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÉªÊâøË™ç‰ªò„ÅçÔºâ

**„Åì„ÅÆÊåáÁ§∫Êõ∏„Å´Âü∫„Å•„ÅÑ„Å¶„ÄÅÂÆüÁî®ÁöÑ„ÅßÂÆâÂÖ®„Å™KICHOË®òÂ∏≥„ÉÑ„Éº„É´Â∞ÇÁî®hooks„Ç∑„Çπ„ÉÜ„É†„ÇíÊßãÁØâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ**