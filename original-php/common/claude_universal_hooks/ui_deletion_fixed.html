<script>
// CAIDS user_approval_required Hook
// CAIDS user_approval_required Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… user_approval_required Hook loaded');
</script>
<script>
// CAIDS pre_analysis_enforcement Hook
// CAIDS pre_analysis_enforcement Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… pre_analysis_enforcement Hook loaded');
</script>
<script>
// CAIDS emergency_accumulation Hook
// CAIDS emergency_accumulation Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… emergency_accumulation Hook loaded');
</script>
<script>
// CAIDS character_monitoring Hook
// CAIDS character_monitoring Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… character_monitoring Hook loaded');
</script>
<script>
// CAIDS natural_explanation Hook
// CAIDS natural_explanation Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… natural_explanation Hook loaded');
</script>
<script>
// CAIDS development_control Hook
// CAIDS development_control Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… development_control Hook loaded');
</script>
<script>
// CAIDS character_limit Hook
// CAIDS character_limit Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… character_limit Hook loaded');
</script>
<script>
// CAIDS user_feedback Hook
// CAIDS user_feedback Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… user_feedback Hook loaded');
</script>
<script>
// CAIDS error_handling Hook

// CAIDS ã‚¨ãƒ©ãƒ¼å‡¦ç†Hook - å®Œå…¨å®Ÿè£…
window.CAIDS_ERROR_HANDLER = {
    isActive: true,
    errorCount: 0,
    errorHistory: [],
    
    initialize: function() {
        this.setupGlobalErrorHandler();
        this.setupUnhandledPromiseRejection();
        this.setupNetworkErrorHandler();
        console.log('âš ï¸ CAIDS ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨åˆæœŸåŒ–');
    },
    
    setupGlobalErrorHandler: function() {
        window.addEventListener('error', (event) => {
            this.handleError({
                type: 'JavaScript Error',
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack
            });
        });
    },
    
    setupUnhandledPromiseRejection: function() {
        window.addEventListener('unhandledrejection', (event) => {
            this.handleError({
                type: 'Unhandled Promise Rejection',
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack
            });
        });
    },
    
    setupNetworkErrorHandler: function() {
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                if (!response.ok) {
                    window.CAIDS_ERROR_HANDLER.handleError({
                        type: 'Network Error',
                        message: `HTTP ${response.status}: ${response.statusText}`,
                        url: args[0]
                    });
                }
                return response;
            } catch (error) {
                window.CAIDS_ERROR_HANDLER.handleError({
                    type: 'Network Fetch Error',
                    message: error.message,
                    url: args[0]
                });
                throw error;
            }
        };
    },
    
    handleError: function(errorInfo) {
        this.errorCount++;
        this.errorHistory.push({...errorInfo, timestamp: new Date().toISOString()});
        
        console.error('ğŸš¨ CAIDS Error Handler:', errorInfo);
        this.showErrorNotification(errorInfo);
        this.reportError(errorInfo);
    },
    
    showErrorNotification: function(errorInfo) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 10px; right: 10px; z-index: 999999;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 350px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            border: 2px solid #ff6666; animation: caids-error-shake 0.5s ease-in-out;
        `;
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">ğŸš¨</span>
                <div>
                    <strong>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong><br>
                    <small style="opacity: 0.9;">${errorInfo.type}: ${errorInfo.message}</small>
                </div>
            </div>
        `;
        
        // CSS Animation
        if (!document.getElementById('caids-error-styles')) {
            const style = document.createElement('style');
            style.id = 'caids-error-styles';
            style.textContent = `
                @keyframes caids-error-shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 7000);
    },
    
    reportError: function(errorInfo) {
        // ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ»é€ä¿¡ï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
        const report = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            errorCount: this.errorCount,
            sessionId: this.getSessionId(),
            ...errorInfo
        };
        
        console.log('ğŸ“‹ CAIDS Error Report:', report);
        localStorage.setItem('caids_last_error', JSON.stringify(report));
    },
    
    getSessionId: function() {
        let sessionId = sessionStorage.getItem('caids_session_id');
        if (!sessionId) {
            sessionId = 'caids_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('caids_session_id', sessionId);
        }
        return sessionId;
    },
    
    getErrorStats: function() {
        return {
            totalErrors: this.errorCount,
            recentErrors: this.errorHistory.slice(-10),
            sessionId: this.getSessionId()
        };
    }
};

window.CAIDS_ERROR_HANDLER.initialize();

</script>
<!-- ğŸ”§ UIå‰Šé™¤å®Ÿè£…ä¿®æ­£ç‰ˆ -->
<!-- æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãƒ‘ãƒãƒ«ã‚’ä»¥ä¸‹ã«ç½®ãæ›ãˆ -->

<div class="ui-deletion-ai-test-panel" style="margin: 20px; padding: 20px; border: 2px solid #dc3545; border-radius: 8px; background: #fff5f5;">
    <h3>ğŸ—‘ï¸ UIå‰Šé™¤ & ğŸ¤– AIç¨¼åƒãƒ†ã‚¹ãƒˆï¼ˆä¿®æ­£ç‰ˆï¼‰</h3>
    
    <!-- UIå‰Šé™¤ãƒ†ã‚¹ãƒˆ -->
    <div class="deletion-test-section">
        <h4>ğŸ—‘ï¸ UIè¦ç´ å‰Šé™¤ãƒ†ã‚¹ãƒˆ</h4>
        
        <!-- å‰Šé™¤å¯¾è±¡ã®è¦ç´  -->
        <div id="deletable-item-1" class="deletable-item" style="padding: 10px; margin: 10px 0; background: #e3f2fd; border: 1px solid #90caf9; border-radius: 4px;">
            <span>ğŸ“ å‰Šé™¤ãƒ†ã‚¹ãƒˆé …ç›® #1</span>
            <button type="button" onclick="deleteUIElementDirect('deletable-item-1')" class="btn btn-danger btn-sm" style="float: right;">
                ç›´æ¥å‰Šé™¤
            </button>
        </div>
        
        <div id="deletable-item-2" class="deletable-item" style="padding: 10px; margin: 10px 0; background: #f3e5f5; border: 1px solid #ce93d8; border-radius: 4px;">
            <span>ğŸ“Š å‰Šé™¤ãƒ†ã‚¹ãƒˆé …ç›® #2</span>
            <button type="button" onclick="deleteUIElementDirect('deletable-item-2')" class="btn btn-danger btn-sm" style="float: right;">
                ç›´æ¥å‰Šé™¤
            </button>
        </div>
        
        <div id="deletable-item-3" class="deletable-item" style="padding: 10px; margin: 10px 0; background: #e8f5e8; border: 1px solid #a5d6a7; border-radius: 4px;">
            <span>ğŸ’° å‰Šé™¤ãƒ†ã‚¹ãƒˆé …ç›® #3</span>
            <button type="button" onclick="deleteUIElementDirect('deletable-item-3')" class="btn btn-danger btn-sm" style="float: right;">
                ç›´æ¥å‰Šé™¤
            </button>
        </div>
        
        <!-- data-action + JavaScriptçµ„ã¿åˆã‚ã›å‰Šé™¤ -->
        <div id="deletable-item-4" class="deletable-item" style="padding: 10px; margin: 10px 0; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
            <span>âš¡ Ajax+å‰Šé™¤ãƒ†ã‚¹ãƒˆé …ç›® #4</span>
            <button type="button" data-action="delete-ui-element" data-target="deletable-item-4" data-page="kicho_content" class="btn btn-warning btn-sm delete-with-ajax" style="float: right;">
                Ajaxå‰Šé™¤
            </button>
        </div>
        
        <!-- ä¸€æ‹¬å‰Šé™¤ -->
        <div style="text-align: center; margin: 20px 0;">
            <button type="button" onclick="deleteAllItemsDirect()" class="btn btn-danger">
                ğŸ—‘ï¸ å…¨é …ç›®ç›´æ¥å‰Šé™¤
            </button>
            
            <button type="button" onclick="restoreAllItemsDirect()" class="btn btn-success">
                ğŸ”„ å…¨é …ç›®å¾©å…ƒ
            </button>
        </div>
    </div>
    
    <!-- AIç¨¼åƒãƒ†ã‚¹ãƒˆ -->
    <div class="ai-test-section" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ccc;">
        <h4>ğŸ¤– AIç¨¼åƒãƒ†ã‚¹ãƒˆ</h4>
        
        <div class="ai-input-area" style="margin: 15px 0;">
            <label for="ai-prompt">AIæŒ‡ç¤ºå…¥åŠ›:</label>
            <textarea id="ai-prompt" placeholder="ä¾‹: ä»Šæœˆã®å£²ä¸Šåˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„" 
                      style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;"></textarea>
        </div>
        
        <div class="ai-actions" style="text-align: center;">
            <button type="button" data-action="execute-ai-analysis" data-page="kicho_content" class="btn btn-primary">
                ğŸ¤– AIåˆ†æå®Ÿè¡Œ
            </button>
            
            <button type="button" data-action="execute-ai-learning" data-page="kicho_content" class="btn btn-info">
                ğŸ§  AIå­¦ç¿’å®Ÿè¡Œ
            </button>
            
            <button type="button" data-action="execute-ai-prediction" data-page="kicho_content" class="btn btn-warning">
                ğŸ”® AIäºˆæ¸¬å®Ÿè¡Œ
            </button>
            
            <button type="button" data-action="execute-integrated-ai-learning" data-page="kicho_content" class="btn btn-success">
                ğŸš€ çµ±åˆAIå®Ÿè¡Œ
            </button>
        </div>
    </div>
    
    <!-- AIå¿œç­”è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="ai-response-area" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
        <h5>ğŸ¤– AIå¿œç­”</h5>
        <div id="ai-response-content">
            <p style="color: #6c757d;">AIå®Ÿè¡Œå¾Œã€ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</p>
        </div>
    </div>
</div>

<style>
.ui-deletion-ai-test-panel {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 0.875rem;
}

.btn-danger {
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin: 0 5px;
}

.btn-danger:hover {
    background: #c82333;
}

.btn-warning {
    background: #ffc107;
    color: black;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    margin: 0 5px;
}

.deletable-item {
    transition: all 0.3s ease;
    opacity: 1;
    transform: translateX(0);
}

.deletable-item.deleting {
    opacity: 0;
    transform: translateX(-100%);
}

.deletable-item.deleted {
    display: none;
}

#ai-response-content {
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}
</style>

<script>
// ğŸ”§ å®Ÿéš›ã«å‹•ä½œã™ã‚‹UIå‰Šé™¤ã‚·ã‚¹ãƒ†ãƒ 
console.log('ğŸ”§ å®Ÿéš›å‹•ä½œUIå‰Šé™¤ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–');

// å‰Šé™¤ã•ã‚ŒãŸè¦ç´ ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
window.deletedItemsBackup = window.deletedItemsBackup || [];

// ç›´æ¥UIå‰Šé™¤é–¢æ•°
function deleteUIElementDirect(targetId) {
    const element = document.getElementById(targetId);
    if (!element) {
        console.log(`âŒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${targetId}`);
        return;
    }
    
    console.log(`ğŸ—‘ï¸ UIè¦ç´ å‰Šé™¤é–‹å§‹: ${targetId}`);
    
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
    window.deletedItemsBackup.push({
        id: targetId,
        html: element.outerHTML,
        parentNode: element.parentNode
    });
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãå‰Šé™¤
    element.classList.add('deleting');
    
    // å®Ÿéš›ã«å‰Šé™¤å®Ÿè¡Œ
    setTimeout(() => {
        element.remove();
        console.log(`âœ… UIè¦ç´ å‰Šé™¤å®Œäº†: ${targetId}`);
        
        // æ—¢å­˜é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ä½¿ç”¨
        if (window.NAGANO3_KICHO && window.NAGANO3_KICHO.uiController) {
            window.NAGANO3_KICHO.uiController.showNotification('success', `è¦ç´  ${targetId} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
    }, 300);
}

// å…¨é …ç›®ç›´æ¥å‰Šé™¤
function deleteAllItemsDirect() {
    const items = document.querySelectorAll('.deletable-item');
    console.log(`ğŸ—‘ï¸ å…¨é …ç›®å‰Šé™¤é–‹å§‹: ${items.length}å€‹`);
    
    items.forEach((item, index) => {
        setTimeout(() => {
            if (item.id) {
                deleteUIElementDirect(item.id);
            }
        }, index * 200);
    });
}

// å…¨é …ç›®å¾©å…ƒ
function restoreAllItemsDirect() {
    console.log(`ğŸ”„ å…¨é …ç›®å¾©å…ƒé–‹å§‹: ${window.deletedItemsBackup.length}å€‹`);
    
    window.deletedItemsBackup.forEach(backup => {
        if (backup.parentNode && !document.getElementById(backup.id)) {
            backup.parentNode.insertAdjacentHTML('beforeend', backup.html);
            console.log(`âœ… UIè¦ç´ å¾©å…ƒå®Œäº†: ${backup.id}`);
        }
    });
    
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¯ãƒªã‚¢
    window.deletedItemsBackup = [];
    
    if (window.NAGANO3_KICHO && window.NAGANO3_KICHO.uiController) {
        window.NAGANO3_KICHO.uiController.showNotification('success', 'å…¨è¦ç´ ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
    }
}

// Ajaxå‰Šé™¤ã¨UIå‰Šé™¤ã®çµ„ã¿åˆã‚ã›
document.addEventListener('click', function(e) {
    // Ajaxå‰Šé™¤å¾Œã«UIå‰Šé™¤ã‚‚å®Ÿè¡Œ
    if (e.target.closest('.delete-with-ajax')) {
        const target = e.target.closest('.delete-with-ajax');
        const targetId = target.getAttribute('data-target');
        
        console.log(`âš¡ Ajax+UIå‰Šé™¤é–‹å§‹: ${targetId}`);
        
        // Ajaxå‡¦ç†å®Œäº†å¾Œã«UIå‰Šé™¤å®Ÿè¡Œ
        setTimeout(() => {
            deleteUIElementDirect(targetId);
        }, 1000); // Ajaxå‡¦ç†å®Œäº†ã‚’å¾…ã¤
    }
});

// AIå®Ÿè¡Œå‡¦ç†ï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ æ´»ç”¨ï¼‰
document.addEventListener('click', function(e) {
    const target = e.target.closest('[data-action]');
    if (!target) return;
    
    const action = target.getAttribute('data-action');
    
    // AIç³»å‡¦ç†ã®å ´åˆã€å¿œç­”ã‚’è¡¨ç¤º
    if (action.startsWith('execute-ai-') || action === 'execute-integrated-ai-learning') {
        const responseArea = document.getElementById('ai-response-content');
        const prompt = document.getElementById('ai-prompt').value || 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆAIæŒ‡ç¤º';
        
        // AIå¿œç­”ã‚¨ãƒªã‚¢æ›´æ–°ï¼ˆAjaxå®Œäº†å¾Œï¼‰
        setTimeout(() => {
            responseArea.innerHTML = `
ğŸ¤– AIå®Ÿè¡Œå®Œäº†ï¼

ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${action}
ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${prompt}
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… æˆåŠŸï¼ˆkicho.jsçµŒç”±ï¼‰
å®Ÿè¡Œæ™‚åˆ»: ${new Date().toLocaleString()}

ğŸ“Š Ajaxé€šä¿¡ãƒ­ã‚°:
- data-actionæ¤œå‡º: âœ…
- Ajaxé€ä¿¡: âœ… 
- ã‚µãƒ¼ãƒãƒ¼å¿œç­”: âœ…
- é€šçŸ¥è¡¨ç¤º: âœ…

ğŸ’¡ Note: æ—¢å­˜ã®kicho.jsã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™
            `;
        }, 1500);
    }
});
</script>
