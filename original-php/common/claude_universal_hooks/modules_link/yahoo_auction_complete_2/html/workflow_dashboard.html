<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¤ãƒ•ã‚ªã‚¯â†’eBayå®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç®¡ç†</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 1rem;
        }
        
        .dashboard {
            max-width: 1400px; margin: 0 auto; background: white;
            border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.1); 
            overflow: hidden; display: grid; grid-template-rows: auto 1fr;
        }
        
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white; padding: 2rem; text-align: center;
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        
        .workflow-status {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white; padding: 1rem; display: flex;
            justify-content: center; align-items: center; gap: 2rem;
        }
        
        .status-item {
            text-align: center;
        }
        .status-value {
            font-size: 1.8rem; font-weight: 700; line-height: 1;
        }
        .status-label {
            font-size: 0.8rem; opacity: 0.9; margin-top: 0.25rem;
        }
        
        .main-content {
            display: grid; grid-template-columns: 300px 1fr; min-height: 600px;
        }
        
        .sidebar {
            background: #f8fafc; border-right: 1px solid #e2e8f0; padding: 1.5rem;
        }
        
        .workflow-steps {
            list-style: none;
        }
        
        .workflow-step {
            margin-bottom: 1rem; padding: 1rem; border-radius: 8px;
            border: 1px solid #e2e8f0; background: white;
            cursor: pointer; transition: all 0.3s ease;
        }
        .workflow-step:hover { transform: translateX(4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .workflow-step.active { border-color: #3b82f6; background: #eff6ff; }
        .workflow-step.completed { border-color: #10b981; background: #ecfdf5; }
        
        .step-number {
            display: inline-flex; align-items: center; justify-content: center;
            width: 24px; height: 24px; background: #e2e8f0; color: #64748b;
            border-radius: 50%; font-size: 0.8rem; font-weight: 600;
            margin-right: 0.75rem;
        }
        .workflow-step.active .step-number { background: #3b82f6; color: white; }
        .workflow-step.completed .step-number { background: #10b981; color: white; }
        
        .content-area {
            padding: 2rem; overflow-y: auto;
        }
        
        .step-content {
            display: none;
        }
        .step-content.active {
            display: block;
        }
        
        .action-buttons {
            display: flex; gap: 1rem; margin-top: 1.5rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem; border: none; border-radius: 8px;
            font-size: 0.9rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3); }
        
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); }
        
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3); }
        
        .form-section {
            background: #f8fafc; border-radius: 8px; padding: 1.5rem; margin: 1rem 0;
        }
        
        .url-input {
            width: 100%; padding: 0.75rem; border: 1px solid #d1d5db;
            border-radius: 6px; font-size: 1rem; margin: 0.5rem 0;
        }
        
        .data-table {
            width: 100%; border-collapse: collapse; margin: 1rem 0;
            background: white; border-radius: 8px; overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .data-table th, .data-table td {
            padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0;
        }
        .data-table th {
            background: #f1f5f9; font-weight: 600; color: #374151;
        }
        .data-table tbody tr:hover { background: #f8fafc; }
        
        .status-badge {
            padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;
            font-weight: 600; text-transform: uppercase;
        }
        .status-scraped { background: #dbeafe; color: #1e40af; }
        .status-edited { background: #fef3c7; color: #92400e; }
        .status-listed { background: #d1fae5; color: #065f46; }
        .status-sold_out { background: #fee2e2; color: #991b1b; }
        .status-error { background: #fce7f3; color: #be185d; }
        
        .log-section {
            background: #1e293b; color: #e2e8f0; border-radius: 8px; padding: 1rem;
            max-height: 300px; overflow-y: auto; font-family: 'Courier New', monospace;
            font-size: 0.8rem; line-height: 1.4; margin-top: 1rem;
        }
        .log-entry { margin-bottom: 0.5rem; }
        .log-timestamp { color: #9ca3af; margin-right: 1rem; }
        
        .csv-preview {
            max-height: 400px; overflow: auto; border: 1px solid #e2e8f0;
            border-radius: 8px; background: white;
        }
        
        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; }
            .sidebar { border-right: none; border-bottom: 1px solid #e2e8f0; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1><i class="fas fa-sync-alt"></i> ãƒ¤ãƒ•ã‚ªã‚¯â†’eBayå®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</h1>
            <p>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° â†’ CSVç·¨é›† â†’ UIç¢ºèª â†’ eBayå‡ºå“ â†’ åœ¨åº«ç®¡ç†</p>
        </div>
        
        <div class="workflow-status" id="workflowStatus">
            <div class="status-item">
                <div class="status-value" id="scrapedCount">-</div>
                <div class="status-label">ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æ¸ˆã¿</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="editedCount">-</div>
                <div class="status-label">ç·¨é›†æ¸ˆã¿</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="listedCount">-</div>
                <div class="status-label">eBayå‡ºå“æ¸ˆã¿</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="totalCount">-</div>
                <div class="status-label">ç·å•†å“æ•°</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <h3 style="margin-bottom: 1rem; color: #1e293b;">ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ‰‹é †</h3>
                <ul class="workflow-steps">
                    <li class="workflow-step active" data-step="scraping">
                        <span class="step-number">1</span>
                        <div>
                            <strong>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°</strong>
                            <div style="font-size: 0.8rem; color: #64748b;">ãƒ¤ãƒ•ã‚ªã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—</div>
                        </div>
                    </li>
                    <li class="workflow-step" data-step="csv-edit">
                        <span class="step-number">2</span>
                        <div>
                            <strong>CSVç·¨é›†</strong>
                            <div style="font-size: 0.8rem; color: #64748b;">äººé–“ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ç·¨é›†</div>
                        </div>
                    </li>
                    <li class="workflow-step" data-step="confirmation">
                        <span class="step-number">3</span>
                        <div>
                            <strong>ç¢ºèª</strong>
                            <div style="font-size: 0.8rem; color: #64748b;">UIå†…å®¹ç¢ºèª</div>
                        </div>
                    </li>
                    <li class="workflow-step" data-step="ebay-listing">
                        <span class="step-number">4</span>
                        <div>
                            <strong>eBayå‡ºå“</strong>
                            <div style="font-size: 0.8rem; color: #64748b;">è‡ªå‹•å‡ºå“å®Ÿè¡Œ</div>
                        </div>
                    </li>
                    <li class="workflow-step" data-step="inventory">
                        <span class="step-number">5</span>
                        <div>
                            <strong>åœ¨åº«ç®¡ç†</strong>
                            <div style="font-size: 0.8rem; color: #64748b;">æ—¥æ¬¡åœ¨åº«ç›£è¦–</div>
                        </div>
                    </li>
                </ul>
            </div>
            
            <div class="content-area">
                <!-- Step 1: ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° -->
                <div id="scraping" class="step-content active">
                    <h2><i class="fas fa-search"></i> Step 1: ãƒ¤ãƒ•ã‚ªã‚¯ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°</h2>
                    <p>ãƒ¤ãƒ•ã‚ªã‚¯URLã‹ã‚‰å•†å“æƒ…å ±ã‚’è‡ªå‹•å–å¾—ã—ã¾ã™</p>
                    
                    <div class="form-section">
                        <h4>URLå…¥åŠ›ï¼ˆè¤‡æ•°å¯ï¼‰</h4>
                        <textarea id="urlInput" class="url-input" rows="4" 
                                  placeholder="https://auctions.yahoo.co.jp/jp/auction/xxxxx&#10;https://auctions.yahoo.co.jp/jp/auction/yyyyy&#10;..."></textarea>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="startScraping()">
                                <i class="fas fa-play"></i>
                                ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹
                            </button>
                            <button class="btn btn-warning" onclick="loadExistingData()">
                                <i class="fas fa-folder-open"></i>
                                æ—¢å­˜ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                            </button>
                        </div>
                    </div>
                    
                    <div id="scrapingResults">
                        <!-- ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°çµæœãŒã“ã“ã«è¡¨ç¤º -->
                    </div>
                </div>
                
                <!-- Step 2: CSVç·¨é›† -->
                <div id="csv-edit" class="step-content">
                    <h2><i class="fas fa-edit"></i> Step 2: CSVç·¨é›†</h2>
                    <p>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†ç”¨CSVã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™</p>
                    
                    <div class="form-section">
                        <h4>ç·¨é›†å¯¾è±¡ãƒ‡ãƒ¼ã‚¿</h4>
                        <div id="editableDataCount">ç·¨é›†å¯¾è±¡: 0ä»¶</div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="createEditingCSV()">
                                <i class="fas fa-file-csv"></i>
                                ç·¨é›†ç”¨CSVä½œæˆ
                            </button>
                            <button class="btn btn-primary" onclick="processEditedCSV()">
                                <i class="fas fa-upload"></i>
                                ç·¨é›†æ¸ˆã¿CSVèª­ã¿è¾¼ã¿
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4>ç·¨é›†æ‰‹é †</h4>
                        <ol style="line-height: 1.6;">
                            <li><strong>products_for_ebay.csv</strong> ã‚’Excelã‚„Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§é–‹ã</li>
                            <li><strong>EDIT_ã§å§‹ã¾ã‚‹åˆ—</strong>ã‚’ç·¨é›†ï¼š
                                <ul style="margin: 0.5rem 0;">
                                    <li>EDIT_title_en: è‹±èªã‚¿ã‚¤ãƒˆãƒ«</li>
                                    <li>EDIT_description_en: è‹±èªèª¬æ˜</li>
                                    <li>EDIT_ebay_category_id: eBayã‚«ãƒ†ã‚´ãƒªID</li>
                                    <li>EDIT_ebay_price_usd: USDä¾¡æ ¼</li>
                                    <li>EDIT_shipping_cost_usd: é€æ–™USD</li>
                                </ul>
                            </li>
                            <li>ä¿å­˜å¾Œã€ã€Œç·¨é›†æ¸ˆã¿CSVèª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</li>
                        </ol>
                    </div>
                    
                    <div class="csv-preview" id="csvPreview">
                        <!-- CSVå†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤º -->
                    </div>
                </div>
                
                <!-- Step 3: ç¢ºèª -->
                <div id="confirmation" class="step-content">
                    <h2><i class="fas fa-eye"></i> Step 3: å†…å®¹ç¢ºèª</h2>
                    <p>eBayå‡ºå“å‰ã®æœ€çµ‚ç¢ºèªã‚’è¡Œã„ã¾ã™</p>
                    
                    <div class="form-section">
                        <h4>å‡ºå“æº–å‚™å®Œäº†å•†å“</h4>
                        <div id="readyProductsTable">
                            <!-- å‡ºå“æº–å‚™å®Œäº†å•†å“ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã“ã“ã«è¡¨ç¤º -->
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="confirmAllProducts()">
                                <i class="fas fa-check"></i>
                                å…¨å•†å“ç¢ºèªå®Œäº†
                            </button>
                            <button class="btn btn-warning" onclick="editSelectedProducts()">
                                <i class="fas fa-edit"></i>
                                é¸æŠå•†å“ã‚’å†ç·¨é›†
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Step 4: eBayå‡ºå“ -->
                <div id="ebay-listing" class="step-content">
                    <h2><i class="fas fa-store"></i> Step 4: eBayå‡ºå“</h2>
                    <p>ç¢ºèªæ¸ˆã¿å•†å“ã‚’eBayã«è‡ªå‹•å‡ºå“ã—ã¾ã™</p>
                    
                    <div class="form-section">
                        <h4>å‡ºå“è¨­å®š</h4>
                        <label><input type="checkbox" id="testMode" checked> ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã«ã¯å‡ºå“ã—ãªã„ï¼‰</label>
                        <label><input type="checkbox" id="autoPrice"> ä¾¡æ ¼è‡ªå‹•èª¿æ•´</label>
                        <label><input type="checkbox" id="bulkListing"> ä¸€æ‹¬å‡ºå“</label>
                        
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="startEbayListing()">
                                <i class="fas fa-rocket"></i>
                                eBayå‡ºå“é–‹å§‹
                            </button>
                            <button class="btn btn-warning" onclick="retryFailedListings()">
                                <i class="fas fa-redo"></i>
                                å¤±æ•—å•†å“å†è©¦è¡Œ
                            </button>
                        </div>
                    </div>
                    
                    <div id="listingProgress">
                        <!-- å‡ºå“é€²æ—ãŒã“ã“ã«è¡¨ç¤º -->
                    </div>
                </div>
                
                <!-- Step 5: åœ¨åº«ç®¡ç† -->
                <div id="inventory" class="step-content">
                    <h2><i class="fas fa-boxes"></i> Step 5: åœ¨åº«ç®¡ç†</h2>
                    <p>eBayå‡ºå“æ¸ˆã¿å•†å“ã®åœ¨åº«ã‚’è‡ªå‹•ç›£è¦–ã—ã¾ã™</p>
                    
                    <div class="form-section">
                        <h4>åœ¨åº«ç›£è¦–è¨­å®š</h4>
                        <label><input type="checkbox" id="autoInventoryCheck" checked> è‡ªå‹•åœ¨åº«ãƒã‚§ãƒƒã‚¯</label>
                        <label><input type="checkbox" id="ebaySync"> eBayåœ¨åº«åŒæœŸ</label>
                        <label><input type="checkbox" id="notifyStockOut" checked> åœ¨åº«åˆ‡ã‚Œé€šçŸ¥</label>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="runInventoryCheck()">
                                <i class="fas fa-sync"></i>
                                åœ¨åº«ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
                            </button>
                            <button class="btn btn-success" onclick="viewInventoryReport()">
                                <i class="fas fa-chart-bar"></i>
                                åœ¨åº«ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
                            </button>
                        </div>
                    </div>
                    
                    <div id="inventoryStatus">
                        <!-- åœ¨åº«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã“ã“ã«è¡¨ç¤º -->
                    </div>
                </div>
                
                <!-- ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="log-section" id="logSection">
                    <div class="log-entry">
                        <span class="log-timestamp">[åˆæœŸåŒ–]</span>
                        ãƒ¤ãƒ•ã‚ªã‚¯â†’eBayå®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentStep = 'scraping';
        let workflowData = {
            scraped: [],
            edited: [],
            ready: [],
            listed: [],
            inventory: []
        };
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeWorkflow();
            updateWorkflowStatus();
        });
        
        // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆæœŸåŒ–
        function initializeWorkflow() {
            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¹ãƒ†ãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯
            document.querySelectorAll('.workflow-step').forEach(step => {
                step.addEventListener('click', function() {
                    const stepName = this.dataset.step;
                    switchStep(stepName);
                });
            });
            
            addLog('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—åˆ‡ã‚Šæ›¿ãˆ
        function switchStep(stepName) {
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°
            document.querySelectorAll('.workflow-step').forEach(step => {
                step.classList.remove('active');
            });
            document.querySelector(`[data-step="${stepName}"]`).classList.add('active');
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(stepName).classList.add('active');
            
            currentStep = stepName;
            addLog(`ã‚¹ãƒ†ãƒƒãƒ—åˆ‡ã‚Šæ›¿ãˆ: ${stepName}`);
        }
        
        // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹
        async function startScraping() {
            const urls = document.getElementById('urlInput').value.trim().split('\n').filter(url => url.trim());
            
            if (urls.length === 0) {
                alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            addLog(`ğŸ“¡ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹: ${urls.length}ä»¶ã®URL`);
            
            const resultsDiv = document.getElementById('scrapingResults');
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #3b82f6;"></i>
                    <p>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œä¸­...</p>
                </div>
            `;
            
            try {
                // å®Ÿéš›ã®ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å‡¦ç†ï¼ˆPythonãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã®é€šä¿¡ï¼‰
                const response = await fetch('/scrape_yahoo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls: urls })
                });
                
                if (!response.ok) throw new Error('ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é€šä¿¡ã‚¨ãƒ©ãƒ¼');
                
                const result = await response.json();
                
                if (result.success) {
                    workflowData.scraped = result.data;
                    displayScrapingResults(result.data);
                    updateWorkflowStatus();
                    addLog(`âœ… ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†: ${result.data.length}ä»¶æˆåŠŸ`);
                    
                    // Step 2ã‚’æœ‰åŠ¹åŒ–
                    document.querySelector('[data-step="csv-edit"]').classList.add('completed');
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                addLog(`âŒ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                resultsDiv.innerHTML = `
                    <div class="form-section" style="background: #fee2e2; color: #991b1b;">
                        <h4>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-warning" onclick="startScraping()">å†è©¦è¡Œ</button>
                    </div>
                `;
            }
        }
        
        // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°çµæœè¡¨ç¤º
        function displayScrapingResults(data) {
            const resultsDiv = document.getElementById('scrapingResults');
            
            if (data.length === 0) {
                resultsDiv.innerHTML = '<p>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            let html = `
                <h4>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°çµæœ (${data.length}ä»¶)</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>å•†å“ID</th>
                            <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                            <th>ä¾¡æ ¼(Â¥)</th>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <th>å–å¾—æ™‚åˆ»</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.product_id}</td>
                        <td>${item.title_jp.substring(0, 50)}...</td>
                        <td>Â¥${item.price_jpy.toLocaleString()}</td>
                        <td><span class="status-badge status-${item.status}">${item.status}</span></td>
                        <td>${item.scrape_timestamp}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
        }
        
        // CSVç·¨é›†ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        async function createEditingCSV() {
            addLog('ğŸ“ ç·¨é›†ç”¨CSVä½œæˆä¸­...');
            
            try {
                const response = await fetch('/create_editing_csv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: workflowData.scraped })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(`âœ… ç·¨é›†ç”¨CSVä½œæˆå®Œäº†: ${result.filename}`);
                    alert(`ç·¨é›†ç”¨CSVã‚’ä½œæˆã—ã¾ã—ãŸ:\n${result.filename}\n\nExcelã§é–‹ã„ã¦ç·¨é›†ã—ã¦ãã ã•ã„`);
                    
                    // ç·¨é›†å¯¾è±¡ä»¶æ•°è¡¨ç¤º
                    document.getElementById('editableDataCount').textContent = `ç·¨é›†å¯¾è±¡: ${result.count}ä»¶`;
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                addLog(`âŒ CSVä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                alert(`CSVä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // ç·¨é›†æ¸ˆã¿CSVå‡¦ç†
        async function processEditedCSV() {
            addLog('ğŸ”„ ç·¨é›†æ¸ˆã¿CSVå‡¦ç†ä¸­...');
            
            try {
                const response = await fetch('/process_edited_csv', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    workflowData.edited = result.data;
                    addLog(`âœ… ç·¨é›†å‡¦ç†å®Œäº†: ${result.updated_count}ä»¶æ›´æ–°`);
                    updateWorkflowStatus();
                    
                    // Step 3ã‚’æœ‰åŠ¹åŒ–
                    document.querySelector('[data-step="confirmation"]').classList.add('completed');
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                addLog(`âŒ CSVå‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                alert(`CSVå‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // eBayå‡ºå“é–‹å§‹
        async function startEbayListing() {
            const testMode = document.getElementById('testMode').checked;
            
            addLog(`ğŸš€ eBayå‡ºå“é–‹å§‹${testMode ? 'ï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰' : ''}`);
            
            try {
                const response = await fetch('/start_ebay_listing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        test_mode: testMode,
                        products: workflowData.edited 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(`âœ… eBayå‡ºå“å®Œäº†: ${result.listed_count}ä»¶æˆåŠŸ`);
                    workflowData.listed = result.data;
                    updateWorkflowStatus();
                    
                    // Step 5ã‚’æœ‰åŠ¹åŒ–
                    document.querySelector('[data-step="inventory"]').classList.add('completed');
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                addLog(`âŒ eBayå‡ºå“ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                alert(`eBayå‡ºå“ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // åœ¨åº«ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        async function runInventoryCheck() {
            addLog('ğŸ“Š åœ¨åº«ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­...');
            
            try {
                const response = await fetch('/run_inventory_check', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(`âœ… åœ¨åº«ãƒã‚§ãƒƒã‚¯å®Œäº†: ${result.checked_count}ä»¶ç¢ºèª`);
                    displayInventoryStatus(result.inventory_data);
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                addLog(`âŒ åœ¨åº«ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                alert(`åœ¨åº«ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // åœ¨åº«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function displayInventoryStatus(inventoryData) {
            const statusDiv = document.getElementById('inventoryStatus');
            
            let html = `
                <h4>åœ¨åº«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>å•†å“ID</th>
                            <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                            <th>åœ¨åº«æ•°</th>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <th>æœ€çµ‚ãƒã‚§ãƒƒã‚¯</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            inventoryData.forEach(item => {
                html += `
                    <tr>
                        <td>${item.product_id}</td>
                        <td>${item.title_en || item.title_jp}</td>
                        <td>${item.stock_quantity}</td>
                        <td><span class="status-badge status-${item.status}">${item.status}</span></td>
                        <td>${item.last_stock_check}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            statusDiv.innerHTML = html;
        }
        
        // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateWorkflowStatus() {
            document.getElementById('scrapedCount').textContent = workflowData.scraped.length;
            document.getElementById('editedCount').textContent = workflowData.edited.length;
            document.getElementById('listedCount').textContent = workflowData.listed.length;
            
            const total = workflowData.scraped.length + workflowData.edited.length + workflowData.listed.length;
            document.getElementById('totalCount').textContent = total;
        }
        
        // ãƒ­ã‚°è¿½åŠ 
        function addLog(message) {
            const logSection = document.getElementById('logSection');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                ${message}
            `;
            
            logSection.appendChild(logEntry);
            logSection.scrollTop = logSection.scrollHeight;
            
            // ãƒ­ã‚°åˆ¶é™ï¼ˆ100ã‚¨ãƒ³ãƒˆãƒªï¼‰
            const entries = logSection.querySelectorAll('.log-entry');
            if (entries.length > 100) {
                entries[0].remove();
            }
        }
        
        // æœªå®Ÿè£…æ©Ÿèƒ½ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰
        function loadExistingData() { addLog('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ©Ÿèƒ½ï¼ˆé–‹ç™ºä¸­ï¼‰'); }
        function confirmAllProducts() { addLog('å•†å“ç¢ºèªæ©Ÿèƒ½ï¼ˆé–‹ç™ºä¸­ï¼‰'); }
        function editSelectedProducts() { addLog('é¸æŠç·¨é›†æ©Ÿèƒ½ï¼ˆé–‹ç™ºä¸­ï¼‰'); }
        function retryFailedListings() { addLog('å†å‡ºå“æ©Ÿèƒ½ï¼ˆé–‹ç™ºä¸­ï¼‰'); }
        function viewInventoryReport() { addLog('åœ¨åº«ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆé–‹ç™ºä¸­ï¼‰'); }
        
        console.log('âœ… ãƒ¤ãƒ•ã‚ªã‚¯â†’eBayå®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ UIåˆæœŸåŒ–å®Œäº†');
    </script>
</body>
</html>
