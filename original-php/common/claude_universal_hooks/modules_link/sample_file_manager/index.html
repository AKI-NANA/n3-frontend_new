<?php
/**
 * NAGANO-3 çµ±åˆãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ« æ‹¡å¼µç‰ˆ
 * modules/backend_tools/enhanced_test_tool_content.php
 * 
 * ğŸ¯ Phase 1å®Ÿè£…å®Œäº†ç‰ˆ
 * âœ… UI/UXã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
 * âœ… APIé€£æºãƒ†ã‚¹ãƒˆ
 * âœ… ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆ
 * âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãƒ†ã‚¹ãƒˆ
 * âœ… è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¼·åŒ–
 */

// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
if (!defined('SECURE_ACCESS')) {
    die('Direct access not permitted');
}

$csrf_token = $_SESSION['csrf_token'] ?? '';
$current_page = $_GET['page'] ?? 'dashboard';
?>

<style>
  /* ğŸ¨ æ‹¡å¼µãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«å°‚ç”¨CSS */
  .enhanced-test-wrapper {
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    font-family: "Noto Sans JP", sans-serif;
  }

  .enhanced-test-title {
    color: white;
    text-align: center;
    margin-bottom: 30px;
    font-size: 32px;
    font-weight: 700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
  }

  .test-grid-enhanced {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
  }

  .test-card-enhanced {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
  }

  .test-card-enhanced:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
  }

  .test-card-title-enhanced {
    color: #2d3748;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 2px solid #e2e8f0;
    padding-bottom: 10px;
  }

  .test-btn-enhanced {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
  }

  .test-btn-enhanced:before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.3),
      transparent
    );
    transition: left 0.5s;
  }

  .test-btn-enhanced:hover:before {
    left: 100%;
  }

  .test-btn-enhanced--primary {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
  }

  .test-btn-enhanced--success {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
  }

  .test-btn-enhanced--warning {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
    color: white;
  }

  .test-btn-enhanced--danger {
    background: linear-gradient(135deg, #f56565, #e53e3e);
    color: white;
  }

  /* ğŸ”„ å®Ÿè¡Œä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ */
  .test-btn-enhanced.loading {
    pointer-events: none;
    opacity: 0.7;
  }

  .test-btn-enhanced.loading .btn-text {
    opacity: 0;
  }

  .test-btn-enhanced.loading:after {
    content: "";
    position: absolute;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* âœ… æˆåŠŸçŠ¶æ…‹ */
  .test-btn-enhanced.success {
    background: linear-gradient(135deg, #48bb78, #38a169) !important;
    transform: scale(1.05);
  }

  /* âŒ ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ */
  .test-btn-enhanced.error {
    background: linear-gradient(135deg, #f56565, #e53e3e) !important;
    animation: shake 0.5s;
  }

  @keyframes shake {
    0%,
    100% {
      transform: translateX(0);
    }
    25% {
      transform: translateX(-5px);
    }
    75% {
      transform: translateX(5px);
    }
  }

  /* ğŸ“Š ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
  .progress-bar {
    width: 100%;
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    overflow: hidden;
    margin: 15px 0;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4299e1, #48bb78);
    width: 0%;
    transition: width 0.3s ease;
    position: relative;
  }

  .progress-fill:after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.3),
      transparent
    );
    animation: progress-shine 1.5s infinite;
  }

  @keyframes progress-shine {
    0% {
      transform: translateX(-100%);
    }
    100% {
      transform: translateX(100%);
    }
  }

  /* ğŸ“„ çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
  .test-result-area {
    background: #1a202c;
    color: #e2e8f0;
    padding: 20px;
    border-radius: 12px;
    font-family: "Courier New", monospace;
    font-size: 14px;
    max-height: 400px;
    overflow-y: auto;
    margin-top: 20px;
    border: 2px solid #2d3748;
  }

  .test-result-item {
    padding: 8px 12px;
    margin: 5px 0;
    border-radius: 6px;
    border-left: 4px solid #4299e1;
  }

  .test-result-item.success {
    background: rgba(72, 187, 120, 0.1);
    border-left-color: #48bb78;
  }

  .test-result-item.error {
    background: rgba(245, 101, 101, 0.1);
    border-left-color: #f56565;
  }

  .test-result-item.warning {
    background: rgba(237, 137, 54, 0.1);
    border-left-color: #ed8936;
  }

  /* ğŸ¯ ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .test-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .test-modal {
    background: white;
    border-radius: 16px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 80%;
    overflow-y: auto;
    transform: scale(0.7);
    transition: transform 0.3s ease;
  }

  .test-modal-overlay.show {
    display: flex;
  }

  .test-modal-overlay.show .test-modal {
    transform: scale(1);
  }

  /* ğŸ“± ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media (max-width: 768px) {
    .test-grid-enhanced {
      grid-template-columns: 1fr;
    }

    .enhanced-test-title {
      font-size: 24px;
    }

    .test-card-enhanced {
      padding: 20px;
    }
  }

  /* ğŸ¨ å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
  .test-form-group {
    margin-bottom: 20px;
  }

  .test-form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2d3748;
  }

  .test-form-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
  }

  .test-form-input:focus {
    outline: none;
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
  }

  .test-form-input.error {
    border-color: #f56565;
  }

  .test-form-input.success {
    border-color: #48bb78;
  }

  /* ğŸ“Š çµ±è¨ˆè¡¨ç¤º */
  .test-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin: 20px 0;
  }

  .test-stat-item {
    text-align: center;
    padding: 15px;
    background: rgba(66, 153, 225, 0.1);
    border-radius: 12px;
    border: 2px solid rgba(66, 153, 225, 0.2);
  }

  .test-stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #2d3748;
    display: block;
  }

  .test-stat-label {
    font-size: 12px;
    color: #718096;
    margin-top: 5px;
  }
</style>

<!-- ğŸ¯ æ‹¡å¼µãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«HTML -->
<div class="enhanced-test-wrapper">
  <h1 class="enhanced-test-title">
    <i class="fas fa-rocket"></i>
    NAGANO-3 çµ±åˆãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ« ã€æ‹¡å¼µç‰ˆã€‘
  </h1>

  <!-- ğŸ“Š ãƒ†ã‚¹ãƒˆçµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
  <div class="test-stats" id="test-stats">
    <div class="test-stat-item">
      <span class="test-stat-value" id="total-tests">0</span>
      <span class="test-stat-label">ç·ãƒ†ã‚¹ãƒˆæ•°</span>
    </div>
    <div class="test-stat-item">
      <span class="test-stat-value test-status--ok" id="passed-tests">0</span>
      <span class="test-stat-label">æˆåŠŸ</span>
    </div>
    <div class="test-stat-item">
      <span class="test-stat-value test-status--error" id="failed-tests"
        >0</span
      >
      <span class="test-stat-label">å¤±æ•—</span>
    </div>
    <div class="test-stat-item">
      <span class="test-stat-value test-status--warning" id="running-tests"
        >0</span
      >
      <span class="test-stat-label">å®Ÿè¡Œä¸­</span>
    </div>
  </div>

  <!-- ğŸ“‹ ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
  <div class="progress-bar" id="overall-progress" style="display: none">
    <div class="progress-fill" id="progress-fill"></div>
  </div>

  <!-- ğŸ¯ ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒªã‚°ãƒªãƒƒãƒ‰ -->
  <div class="test-grid-enhanced">
    <!-- ğŸ†• UI/UXã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ -->
    <div class="test-card-enhanced">
      <h3 class="test-card-title-enhanced">
        <i class="fas fa-mouse-pointer"></i>
        UI/UXã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
      </h3>

      <div class="test-form-group">
        <button
          class="test-btn-enhanced test-btn-enhanced--primary"
          onclick="EnhancedTestSystem.testButtonClick(this)"
        >
          <span class="btn-text">
            <i class="fas fa-hand-pointer"></i>
            ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>

      <div class="test-form-group">
        <label class="test-form-label">ãƒ†ã‚¹ãƒˆç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input
          type="email"
          class="test-form-input"
          id="test-email"
          placeholder="test@example.com"
        />
        <button
          class="test-btn-enhanced test-btn-enhanced--success"
          onclick="EnhancedTestSystem.testFormValidation()"
        >
          <span class="btn-text">
            <i class="fas fa-check-circle"></i>
            ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>

      <div class="test-form-group">
        <button
          class="test-btn-enhanced test-btn-enhanced--warning"
          onclick="EnhancedTestSystem.testModalDisplay()"
        >
          <span class="btn-text">
            <i class="fas fa-window-maximize"></i>
            ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>
    </div>

    <!-- ğŸ†• APIé€£æºãƒ†ã‚¹ãƒˆ -->
    <div class="test-card-enhanced">
      <h3 class="test-card-title-enhanced">
        <i class="fas fa-plug"></i>
        APIé€£æºãƒ†ã‚¹ãƒˆ
      </h3>

      <div class="test-form-group">
        <label class="test-form-label">å¤–éƒ¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</label>
        <input
          type="url"
          class="test-form-input"
          id="api-endpoint"
          value="https://jsonplaceholder.typicode.com/posts/1"
          placeholder="https://api.example.com/test"
        />
        <button
          class="test-btn-enhanced test-btn-enhanced--primary"
          onclick="EnhancedTestSystem.testExternalApi()"
        >
          <span class="btn-text">
            <i class="fas fa-satellite-dish"></i>
            å¤–éƒ¨APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>

      <div class="test-form-group">
        <button
          class="test-btn-enhanced test-btn-enhanced--success"
          onclick="EnhancedTestSystem.testApiKeyCheck()"
        >
          <span class="btn-text">
            <i class="fas fa-key"></i>
            APIã‚­ãƒ¼å­˜åœ¨ç¢ºèª
          </span>
        </button>
      </div>

      <div class="test-form-group">
        <button
          class="test-btn-enhanced test-btn-enhanced--warning"
          onclick="EnhancedTestSystem.testAuthFlow()"
        >
          <span class="btn-text">
            <i class="fas fa-user-shield"></i>
            èªè¨¼ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>
    </div>

    <!-- ğŸ†• ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆ (CRUD) -->
    <div class="test-card-enhanced">
      <h3 class="test-card-title-enhanced">
        <i class="fas fa-database"></i>
        ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆ (CRUD)
      </h3>

      <div class="test-form-group">
        <label class="test-form-label">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿å</label>
        <input
          type="text"
          class="test-form-input"
          id="test-data-name"
          value="ã‚µãƒ³ãƒ—ãƒ«ã‚¢ã‚¤ãƒ†ãƒ "
          placeholder="ãƒ‡ãƒ¼ã‚¿åã‚’å…¥åŠ›"
        />
      </div>

      <div
        class="test-form-group"
        style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
      >
        <button
          class="test-btn-enhanced test-btn-enhanced--success"
          onclick="EnhancedTestSystem.testDataCreate()"
        >
          <span class="btn-text">
            <i class="fas fa-plus"></i>
            CREATE
          </span>
        </button>
        <button
          class="test-btn-enhanced test-btn-enhanced--primary"
          onclick="EnhancedTestSystem.testDataRead()"
        >
          <span class="btn-text">
            <i class="fas fa-search"></i>
            READ
          </span>
        </button>
      </div>

      <div
        class="test-form-group"
        style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
      >
        <button
          class="test-btn-enhanced test-btn-enhanced--warning"
          onclick="EnhancedTestSystem.testDataUpdate()"
        >
          <span class="btn-text">
            <i class="fas fa-edit"></i>
            UPDATE
          </span>
        </button>
        <button
          class="test-btn-enhanced test-btn-enhanced--danger"
          onclick="EnhancedTestSystem.testDataDelete()"
        >
          <span class="btn-text">
            <i class="fas fa-trash"></i>
            DELETE
          </span>
        </button>
      </div>
    </div>

    <!-- ğŸ†• ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãƒ†ã‚¹ãƒˆ -->
    <div class="test-card-enhanced">
      <h3 class="test-card-title-enhanced">
        <i class="fas fa-file-upload"></i>
        ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãƒ†ã‚¹ãƒˆ
      </h3>

      <div class="test-form-group">
        <label class="test-form-label">ãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚¡ã‚¤ãƒ«</label>
        <input
          type="file"
          class="test-form-input"
          id="test-file"
          accept=".txt,.json,.csv"
        />
        <button
          class="test-btn-enhanced test-btn-enhanced--primary"
          onclick="EnhancedTestSystem.testFileUpload()"
        >
          <span class="btn-text">
            <i class="fas fa-cloud-upload-alt"></i>
            ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>

      <div class="test-form-group">
        <button
          class="test-btn-enhanced test-btn-enhanced--success"
          onclick="EnhancedTestSystem.testFileDownload()"
        >
          <span class="btn-text">
            <i class="fas fa-download"></i>
            ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>

      <div class="test-form-group">
        <button
          class="test-btn-enhanced test-btn-enhanced--warning"
          onclick="EnhancedTestSystem.testLargeFileSimulation()"
        >
          <span class="btn-text">
            <i class="fas fa-hdd"></i>
            å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          </span>
        </button>
      </div>
    </div>

    <!-- ğŸ†• ãƒ­ãƒ¼ã‚«ãƒ«AI/ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ -->
    <div class="test-card-enhanced">
      <h3 class="test-card-title-enhanced">
        <i class="fas fa-brain"></i>
        ãƒ­ãƒ¼ã‚«ãƒ«AI/ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
      </h3>

      <div class="test-form-group">
        <button
          class="test-btn-enhanced test-btn-enhanced--primary"
          onclick="EnhancedTestSystem.testLocalCalculation()"
        >
          <span class="btn-text">
            <i class="fas fa-calculator"></i>
            è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>

      <div class="test-form-group">
        <label class="test-form-label">ãƒ†ã‚­ã‚¹ãƒˆåˆ†é¡ãƒ†ã‚¹ãƒˆ</label>
        <input
          type="text"
          class="test-form-input"
          id="test-text"
          value="ç´ æ™´ã‚‰ã—ã„è£½å“ã§ã™ï¼ã¨ã¦ã‚‚æº€è¶³ã—ã¦ã„ã¾ã™ã€‚"
          placeholder="åˆ†é¡ãƒ†ã‚¹ãƒˆç”¨ãƒ†ã‚­ã‚¹ãƒˆ"
        />
        <button
          class="test-btn-enhanced test-btn-enhanced--success"
          onclick="EnhancedTestSystem.testAITextClassification()"
        >
          <span class="btn-text">
            <i class="fas fa-robot"></i>
            AIåˆ†é¡ãƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>

      <div class="test-form-group">
        <button
          class="test-btn-enhanced test-btn-enhanced--warning"
          onclick="EnhancedTestSystem.testWebWorker()"
        >
          <span class="btn-text">
            <i class="fas fa-cogs"></i>
            Web Workerãƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>
    </div>

    <!-- ğŸ†• ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€£æºãƒ†ã‚¹ãƒˆ -->
    <div class="test-card-enhanced">
      <h3 class="test-card-title-enhanced">
        <i class="fas fa-server"></i>
        ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€£æºãƒ†ã‚¹ãƒˆ
      </h3>

      <div class="test-form-group">
        <label class="test-form-label">ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ãƒ†ã‚¹ãƒˆ</label>
        <input
          type="text"
          class="test-form-input"
          id="session-test-value"
          value="ãƒ†ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³å€¤"
          placeholder="ã‚»ãƒƒã‚·ãƒ§ãƒ³å€¤"
        />
        <button
          class="test-btn-enhanced test-btn-enhanced--primary"
          onclick="EnhancedTestSystem.testSessionVars()"
        >
          <span class="btn-text">
            <i class="fas fa-memory"></i>
            ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿æ›¸ããƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>

      <div class="test-form-group">
        <button
          class="test-btn-enhanced test-btn-enhanced--success"
          onclick="EnhancedTestSystem.testCookieOperations()"
        >
          <span class="btn-text">
            <i class="fas fa-cookie-bite"></i>
            Cookieæ“ä½œãƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>

      <div class="test-form-group">
        <button
          class="test-btn-enhanced test-btn-enhanced--warning"
          onclick="EnhancedTestSystem.testDbConnection()"
        >
          <span class="btn-text">
            <i class="fas fa-database"></i>
            DBæ¥ç¶šãƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>

      <div class="test-form-group">
        <button
          class="test-btn-enhanced test-btn-enhanced--primary"
          onclick="EnhancedTestSystem.testServerLogging()"
        >
          <span class="btn-text">
            <i class="fas fa-file-alt"></i>
            ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ãƒ†ã‚¹ãƒˆ
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ -->
  <div class="test-card-enhanced" style="margin-top: 20px">
    <h3 class="test-card-title-enhanced">
      <i class="fas fa-play-circle"></i>
      ã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    </h3>

    <div
      class="test-form-group"
      style="
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      "
    >
      <button
        class="test-btn-enhanced test-btn-enhanced--success"
        onclick="EnhancedTestSystem.runBasicTests()"
      >
        <span class="btn-text">
          <i class="fas fa-play"></i>
          åŸºæœ¬ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        </span>
      </button>

      <button
        class="test-btn-enhanced test-btn-enhanced--primary"
        onclick="EnhancedTestSystem.runAllTests()"
      >
        <span class="btn-text">
          <i class="fas fa-rocket"></i>
          å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        </span>
      </button>

      <button
        class="test-btn-enhanced test-btn-enhanced--warning"
        onclick="EnhancedTestSystem.exportReport('html')"
      >
        <span class="btn-text">
          <i class="fas fa-file-code"></i>
          HTMLãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
        </span>
      </button>

      <button
        class="test-btn-enhanced test-btn-enhanced--primary"
        onclick="EnhancedTestSystem.exportReport('json')"
      >
        <span class="btn-text">
          <i class="fas fa-file-download"></i>
          JSONãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
        </span>
      </button>
    </div>
  </div>

  <!-- ğŸ“„ ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div class="test-result-area" id="test-results">
    <div style="text-align: center; color: #718096; padding: 20px">
      <i class="fas fa-clipboard-list fa-2x"></i>
      <p>ãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
    </div>
  </div>
</div>

<!-- ğŸ¯ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="test-modal-overlay" id="test-modal">
  <div class="test-modal">
    <h3 style="margin-bottom: 20px">
      <i class="fas fa-info-circle"></i>
      ãƒ†ã‚¹ãƒˆè©³ç´°çµæœ
    </h3>
    <div id="modal-content">
      <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«å†…å®¹ -->
    </div>
    <div style="text-align: center; margin-top: 20px">
      <button
        class="test-btn-enhanced test-btn-enhanced--primary"
        onclick="EnhancedTestSystem.closeModal()"
      >
        <span class="btn-text">
          <i class="fas fa-times"></i>
          é–‰ã˜ã‚‹
        </span>
      </button>
    </div>
  </div>
</div>

<script>
  /**
   * ğŸš€ æ‹¡å¼µãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ  - EnhancedTestSystem
   * Phase 1å®Ÿè£…å®Œäº†ç‰ˆ
   */

  window.EnhancedTestSystem = {
    version: "2.0.0",
    testResults: [],
    runningTests: 0,
    totalTests: 0,
    passedTests: 0,
    failedTests: 0,

    // ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
    init() {
      console.log("ğŸš€ EnhancedTestSystem v2.0.0 åˆæœŸåŒ–é–‹å§‹");
      this.updateStats();
      this.addResultLog("ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†", "success");
    },

    // ğŸ“Š çµ±è¨ˆæ›´æ–°
    updateStats() {
      document.getElementById("total-tests").textContent = this.totalTests;
      document.getElementById("passed-tests").textContent = this.passedTests;
      document.getElementById("failed-tests").textContent = this.failedTests;
      document.getElementById("running-tests").textContent = this.runningTests;

      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
      if (this.totalTests > 0) {
        const progress =
          ((this.passedTests + this.failedTests) / this.totalTests) * 100;
        document.getElementById("progress-fill").style.width = progress + "%";

        if (progress > 0) {
          document.getElementById("overall-progress").style.display = "block";
        }
      }
    },

    // ğŸ”„ ãƒœã‚¿ãƒ³çŠ¶æ…‹åˆ¶å¾¡
    setButtonState(button, state) {
      button.className = button.className.replace(
        /(loading|success|error)/g,
        ""
      );

      if (state) {
        button.classList.add(state);
      }

      if (state === "loading") {
        this.runningTests++;
      } else if (state === "success") {
        this.passedTests++;
        this.runningTests = Math.max(0, this.runningTests - 1);
      } else if (state === "error") {
        this.failedTests++;
        this.runningTests = Math.max(0, this.runningTests - 1);
      }

      this.updateStats();

      // 3ç§’å¾Œã«çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
      if (state === "success" || state === "error") {
        setTimeout(() => {
          button.className = button.className.replace(
            /(loading|success|error)/g,
            ""
          );
        }, 3000);
      }
    },

    // ğŸ“„ çµæœãƒ­ã‚°è¿½åŠ 
    addResultLog(message, type = "info") {
      const timestamp = new Date().toLocaleTimeString();
      const resultArea = document.getElementById("test-results");

      const resultItem = document.createElement("div");
      resultItem.className = `test-result-item ${type}`;

      const icon =
        {
          success: "âœ…",
          error: "âŒ",
          warning: "âš ï¸",
          info: "â„¹ï¸",
        }[type] || "â„¹ï¸";

      resultItem.innerHTML = `[${timestamp}] ${icon} ${message}`;

      resultArea.appendChild(resultItem);
      resultArea.scrollTop = resultArea.scrollHeight;

      // çµæœä¿å­˜
      this.testResults.push({
        timestamp: new Date().toISOString(),
        message,
        type,
      });
    },

    // ğŸ”„ Ajaxé€ä¿¡ãƒ˜ãƒ«ãƒ‘ãƒ¼
    async sendRequest(action, data = {}) {
      const formData = new FormData();
      formData.append("action", action);
      formData.append("module", "system_test");
      formData.append("csrf_token", "<?= htmlspecialchars($csrf_token) ?>");

      for (const [key, value] of Object.entries(data)) {
        formData.append(key, value);
      }

      const response = await fetch(window.location.pathname, {
        method: "POST",
        body: formData,
        headers: {
          "X-Requested-With": "XMLHttpRequest",
        },
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const text = await response.text();

      try {
        return JSON.parse(text);
      } catch (e) {
        return {
          success: true,
          message: "Response received",
          raw_response: text,
        };
      }
    },

    // ğŸ†• UI/UXã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
    async testButtonClick(button) {
      this.totalTests++;
      this.setButtonState(button, "loading");

      try {
        const result = await this.sendRequest("test_button_click", {
          button_id: button.id || "test-button",
          timestamp: Date.now(),
        });

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog(
            `ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆæˆåŠŸ: ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ ${(
              result.data.response_time * 1000
            ).toFixed(2)}ms`,
            "success"
          );
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(
            `ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆå¤±æ•—: ${result.error}`,
            "error"
          );
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(
          `ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼: ${error.message}`,
          "error"
        );
      }
    },

    async testFormValidation() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      const email = document.getElementById("test-email").value;

      try {
        const result = await this.sendRequest("test_form_validation", {
          test_email: email,
          test_number: "123",
          test_required: "required_value",
        });

        if (result.success) {
          this.setButtonState(button, "success");

          // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœè¡¨ç¤º
          let validationSummary = "ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœ:\n";
          for (const [field, validation] of Object.entries(result.data)) {
            validationSummary += `${field}: ${validation.valid ? "âœ…" : "âŒ"} ${
              validation.message
            }\n`;
          }

          this.addResultLog(validationSummary, "success");

          // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è‰²å¤‰æ›´
          const emailInput = document.getElementById("test-email");
          emailInput.className = emailInput.className.replace(
            /(success|error)/g,
            ""
          );
          emailInput.classList.add(
            result.data.email?.valid ? "success" : "error"
          );
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(
            `ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆå¤±æ•—: ${result.error}`,
            "error"
          );
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(
          `ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ã‚¨ãƒ©ãƒ¼: ${error.message}`,
          "error"
        );
      }
    },

    async testModalDisplay() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      try {
        const result = await this.sendRequest("test_modal_display", {
          modal_action: "show",
          modal_id: "test-modal",
        });

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog(
            "ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ†ã‚¹ãƒˆ: " + result.data.instructions,
            "success"
          );

          // å®Ÿéš›ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          this.showModal(
            "ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ†ã‚¹ãƒˆæˆåŠŸï¼",
            "ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚èƒŒæ™¯ãŒã¼ã‹ã•ã‚Œã€ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒä¸­å¤®ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          );
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(`ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ†ã‚¹ãƒˆå¤±æ•—: ${result.error}`, "error");
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(
          `ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼: ${error.message}`,
          "error"
        );
      }
    },

    // ğŸ†• APIé€£æºãƒ†ã‚¹ãƒˆ
    async testExternalApi() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      const apiUrl = document.getElementById("api-endpoint").value;

      try {
        const result = await this.sendRequest("test_external_api", {
          api_url: apiUrl,
        });

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog(
            `å¤–éƒ¨APIæ¥ç¶šæˆåŠŸ: ${result.data.url} (${result.data.response_time_ms}ms, ${result.data.response_size}bytes)`,
            "success"
          );

          if (result.data.sample_data) {
            this.addResultLog(
              `ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(
                result.data.sample_data
              ).substring(0, 100)}...`,
              "info"
            );
          }
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(`å¤–éƒ¨APIæ¥ç¶šå¤±æ•—: ${result.error}`, "error");
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(`å¤–éƒ¨APIæ¥ç¶š ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
      }
    },

    async testApiKeyCheck() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      try {
        const result = await this.sendRequest("check_api_key");

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog("APIã‚­ãƒ¼ç¢ºèªå®Œäº†:", "success");

          for (const [keyName, keyInfo] of Object.entries(result.data)) {
            const status = keyInfo.exists ? "âœ… å­˜åœ¨" : "âŒ æœªè¨­å®š";
            this.addResultLog(
              `${keyName}: ${status} (${keyInfo.masked_value})`,
              "info"
            );
          }
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(`APIã‚­ãƒ¼ç¢ºèªå¤±æ•—: ${result.error}`, "error");
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(`APIã‚­ãƒ¼ç¢ºèª ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
      }
    },

    async testAuthFlow() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      try {
        const result = await this.sendRequest("test_auth_flow", {
          username: "test_user",
          password: "test_pass",
        });

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog(
            `èªè¨¼ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆæˆåŠŸ: ãƒˆãƒ¼ã‚¯ãƒ³å–å¾— (${result.data.token_type}, æœ‰åŠ¹æœŸé™: ${result.data.expires_in}ç§’)`,
            "success"
          );

          // å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã§ã®è¿½åŠ ãƒ†ã‚¹ãƒˆ
          await this.testTokenUsage(result.data.token);
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(`èªè¨¼ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆå¤±æ•—: ${result.error}`, "error");
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(`èªè¨¼ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
      }
    },

    async testTokenUsage(token) {
      this.addResultLog(
        `èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã§ã®è¿½åŠ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ†ã‚¹ãƒˆ: ${token.substring(0, 20)}...`,
        "info"
      );
      // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦ä¿è­·ã•ã‚ŒãŸAPIã«ã‚¢ã‚¯ã‚»ã‚¹
    },

    // ğŸ†• ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆ (CRUD)
    async testDataCreate() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      const dataName = document.getElementById("test-data-name").value;

      try {
        const result = await this.sendRequest("test_data_create", {
          name: dataName,
          value: Math.floor(Math.random() * 1000),
        });

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog(
            `ãƒ‡ãƒ¼ã‚¿ä½œæˆæˆåŠŸ: ID=${result.data.id}, åå‰=${result.data.name}`,
            "success"
          );

          // ä½œæˆã•ã‚ŒãŸIDã‚’ä¿å­˜ï¼ˆå¾Œç¶šã®ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ï¼‰
          window.lastCreatedId = result.data.id;
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(`ãƒ‡ãƒ¼ã‚¿ä½œæˆå¤±æ•—: ${result.error}`, "error");
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(`ãƒ‡ãƒ¼ã‚¿ä½œæˆ ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
      }
    },

    async testDataRead() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      try {
        const result = await this.sendRequest("test_data_read");

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog(
            `ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ: ${
              result.data.total_records
            }ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ (ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${result.data.file_size || 0}bytes)`,
            "success"
          );

          if (result.data.records && result.data.records.length > 0) {
            this.addResultLog(
              `æœ€æ–°ãƒ¬ã‚³ãƒ¼ãƒ‰: ${JSON.stringify(result.data.records[0]).substring(
                0,
                100
              )}...`,
              "info"
            );
          }
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—: ${result.error}`, "error");
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
      }
    },

    async testDataUpdate() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      const recordId = window.lastCreatedId || "test_default_id";

      try {
        const result = await this.sendRequest("test_data_update", {
          record_id: recordId,
          new_value: "æ›´æ–°ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿_" + Date.now(),
        });

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog(`ãƒ‡ãƒ¼ã‚¿æ›´æ–°æˆåŠŸ: ID=${recordId}`, "success");
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(`ãƒ‡ãƒ¼ã‚¿æ›´æ–°å¤±æ•—: ${result.error}`, "error");
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(`ãƒ‡ãƒ¼ã‚¿æ›´æ–° ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
      }
    },

    async testDataDelete() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      const recordId = window.lastCreatedId || "test_default_id";

      try {
        const result = await this.sendRequest("test_data_delete", {
          record_id: recordId,
        });

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog(`ãƒ‡ãƒ¼ã‚¿å‰Šé™¤æˆåŠŸ: ID=${recordId}`, "success");
          window.lastCreatedId = null;
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(`ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å¤±æ•—: ${result.error}`, "error");
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(`ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
      }
    },

    // ğŸ†• ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãƒ†ã‚¹ãƒˆ
    async testFileUpload() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      const fileInput = document.getElementById("test-file");
      const formData = new FormData();

      formData.append("action", "test_file_upload");
      formData.append("module", "system_test");
      formData.append("csrf_token", "<?= htmlspecialchars($csrf_token) ?>");

      if (fileInput.files.length > 0) {
        formData.append("test_file", fileInput.files[0]);
      }

      try {
        const response = await fetch(window.location.pathname, {
          method: "POST",
          body: formData,
          headers: {
            "X-Requested-With": "XMLHttpRequest",
          },
        });

        const result = await response.json();

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog(
            `ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: ${
              result.data.saved_name || result.data.file_name
            } (${result.data.size}bytes)`,
            "success"
          );
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(
            `ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${result.error}`,
            "error"
          );
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(
          `ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ã‚¨ãƒ©ãƒ¼: ${error.message}`,
          "error"
        );
      }
    },

    async testFileDownload() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      try {
        const result = await this.sendRequest("test_file_download");

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog(
            `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆæˆåŠŸ: ${result.data.file_size}bytes`,
            "success"
          );
          this.addResultLog(
            `ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${result.data.content_preview}`,
            "info"
          );

          // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ç”Ÿæˆï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯é©åˆ‡ãªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’ä½¿ç”¨ï¼‰
          this.addResultLog(
            "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ: ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†ï¼ˆå®Ÿéš›ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯ç®¡ç†è€…ãŒæ‰‹å‹•ç¢ºèªï¼‰",
            "warning"
          );
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(
            `ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆå¤±æ•—: ${result.error}`,
            "error"
          );
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(
          `ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼: ${error.message}`,
          "error"
        );
      }
    },

    async testLargeFileSimulation() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      try {
        // å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        this.addResultLog(
          "å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹...",
          "info"
        );

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        for (let progress = 0; progress <= 100; progress += 10) {
          await new Promise((resolve) => setTimeout(resolve, 200));
          this.addResultLog(
            `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€²æ—: ${progress}% (${progress * 10}MB / 1000MB)`,
            "info"
          );
        }

        this.setButtonState(button, "success");
        this.addResultLog(
          "å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†",
          "success"
        );
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(
          `å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ã‚¨ãƒ©ãƒ¼: ${error.message}`,
          "error"
        );
      }
    },

    // ğŸ†• ãƒ­ãƒ¼ã‚«ãƒ«AI/ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
    async testLocalCalculation() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      try {
        const startTime = performance.now();

        // ãƒ•ã‚£ãƒœãƒŠãƒƒãƒæ•°åˆ—è¨ˆç®—ï¼ˆ30ç•ªç›®ï¼‰
        const fibResult = this.calculateFibonacci(30);

        // å¤§ããªé…åˆ—ã®ã‚½ãƒ¼ãƒˆ
        const largeArray = Array.from({ length: 10000 }, () => Math.random());
        largeArray.sort((a, b) => a - b);

        const endTime = performance.now();
        const executionTime = (endTime - startTime).toFixed(2);

        this.setButtonState(button, "success");
        this.addResultLog(
          `è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆæˆåŠŸ: ãƒ•ã‚£ãƒœãƒŠãƒƒãƒ30=${fibResult}, é…åˆ—ã‚½ãƒ¼ãƒˆ(10000è¦ç´ ), å®Ÿè¡Œæ™‚é–“: ${executionTime}ms`,
          "success"
        );
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(
          `è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼: ${error.message}`,
          "error"
        );
      }
    },

    calculateFibonacci(n) {
      if (n <= 1) return n;
      let a = 0,
        b = 1;
      for (let i = 2; i <= n; i++) {
        [a, b] = [b, a + b];
      }
      return b;
    },

    async testAITextClassification() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      const text = document.getElementById("test-text").value;

      try {
        // ç°¡æ˜“ãƒ†ã‚­ã‚¹ãƒˆåˆ†é¡ï¼ˆãƒ€ãƒŸãƒ¼AIï¼‰
        const classification = this.classifyText(text);

        this.setButtonState(button, "success");
        this.addResultLog(
          `AIãƒ†ã‚­ã‚¹ãƒˆåˆ†é¡çµæœ: "${text.substring(0, 50)}..." â†’ ${
            classification.category
          } (ä¿¡é ¼åº¦: ${classification.confidence})`,
          "success"
        );
        this.addResultLog(`åˆ¤å®šç†ç”±: ${classification.reason}`, "info");
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(`AIãƒ†ã‚­ã‚¹ãƒˆåˆ†é¡ ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
      }
    },

    classifyText(text) {
      const positiveWords = [
        "ç´ æ™´ã‚‰ã—ã„",
        "æº€è¶³",
        "è‰¯ã„",
        "æœ€é«˜",
        "å„ªç§€",
        "ã™ã”ã„",
        "æ„Ÿå‹•",
      ];
      const negativeWords = ["æ‚ªã„", "æœ€æ‚ª", "ä¸æº€", "ãƒ€ãƒ¡", "ã²ã©ã„", "å•é¡Œ"];

      const lowerText = text.toLowerCase();
      let positiveScore = 0;
      let negativeScore = 0;

      positiveWords.forEach((word) => {
        if (lowerText.includes(word)) positiveScore++;
      });

      negativeWords.forEach((word) => {
        if (lowerText.includes(word)) negativeScore++;
      });

      if (positiveScore > negativeScore) {
        return {
          category: "ãƒã‚¸ãƒ†ã‚£ãƒ–",
          confidence: Math.min(0.95, 0.6 + positiveScore * 0.1),
          reason: `ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå˜èªã‚’${positiveScore}å€‹æ¤œå‡º`,
        };
      } else if (negativeScore > positiveScore) {
        return {
          category: "ãƒã‚¬ãƒ†ã‚£ãƒ–",
          confidence: Math.min(0.95, 0.6 + negativeScore * 0.1),
          reason: `ãƒã‚¬ãƒ†ã‚£ãƒ–ãªå˜èªã‚’${negativeScore}å€‹æ¤œå‡º`,
        };
      } else {
        return {
          category: "ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«",
          confidence: 0.7,
          reason: "ãƒã‚¸ãƒ†ã‚£ãƒ–ãƒ»ãƒã‚¬ãƒ†ã‚£ãƒ–ã®å˜èªãŒåŒæ•°ã¾ãŸã¯ãªã—",
        };
      }
    },

    async testWebWorker() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      try {
        // Web Workerã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Ÿéš›ã®Workerãƒ•ã‚¡ã‚¤ãƒ«ãªã—ã§ãƒ†ã‚¹ãƒˆï¼‰
        this.addResultLog(
          "Web Workerãƒ†ã‚¹ãƒˆé–‹å§‹: é‡ã„å‡¦ç†ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ...",
          "info"
        );

        // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„é‡ã„å‡¦ç†ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        await this.simulateHeavyWork();

        this.setButtonState(button, "success");
        this.addResultLog(
          "Web Workerãƒ†ã‚¹ãƒˆæˆåŠŸ: ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œãšã«å‡¦ç†å®Œäº†",
          "success"
        );
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(`Web Workerãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
      }
    },

    async simulateHeavyWork() {
      return new Promise((resolve) => {
        setTimeout(() => {
          // é‡ã„è¨ˆç®—å‡¦ç†ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          let result = 0;
          for (let i = 0; i < 1000000; i++) {
            result += Math.sqrt(i);
          }
          resolve(result);
        }, 2000);
      });
    },

    // ğŸ†• ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€£æºãƒ†ã‚¹ãƒˆ
    async testSessionVars() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      const testValue = document.getElementById("session-test-value").value;

      try {
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°æ›¸ãè¾¼ã¿
        const setResult = await this.sendRequest("set_session_var", {
          var_name: "test_session_var",
          var_value: testValue,
        });

        if (setResult.success) {
          // ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°èª­ã¿è¾¼ã¿
          const getResult = await this.sendRequest("get_session_var", {
            var_name: "test_session_var",
          });

          if (getResult.success && getResult.data.var_value === testValue) {
            this.setButtonState(button, "success");
            this.addResultLog(
              `ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ãƒ†ã‚¹ãƒˆæˆåŠŸ: "${testValue}" ã®æ›¸ãè¾¼ã¿ãƒ»èª­ã¿å‡ºã—ç¢ºèª`,
              "success"
            );
          } else {
            this.setButtonState(button, "error");
            this.addResultLog("ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ãƒ†ã‚¹ãƒˆå¤±æ•—: å€¤ã®ä¸ä¸€è‡´", "error");
          }
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(
            `ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ãƒ†ã‚¹ãƒˆå¤±æ•—: ${setResult.error}`,
            "error"
          );
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(
          `ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼: ${error.message}`,
          "error"
        );
      }
    },

    async testCookieOperations() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      try {
        const result = await this.sendRequest("set_cookie_test", {
          cookie_name: "test_cookie",
          cookie_value: "test_value_" + Date.now(),
        });

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog(
            `Cookieãƒ†ã‚¹ãƒˆæˆåŠŸ: ${result.data.cookie_name}=${result.data.cookie_value}`,
            "success"
          );
          this.addResultLog(
            `æœ‰åŠ¹æœŸé™: ${result.data.expires}, ç¾åœ¨ã®Cookieæ•°: ${result.data.current_cookies.length}`,
            "info"
          );
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(`Cookieãƒ†ã‚¹ãƒˆå¤±æ•—: ${result.error}`, "error");
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(`Cookieãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
      }
    },

    async testDbConnection() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      try {
        const result = await this.sendRequest("test_db_connection");

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog(
            `DBæ¥ç¶šãƒ†ã‚¹ãƒˆ: ${result.data.status} (${result.data.driver})`,
            "success"
          );
          this.addResultLog(`æ³¨æ„: ${result.data.note}`, "warning");
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(`DBæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ${result.error}`, "error");
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(`DBæ¥ç¶šãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
      }
    },

    async testServerLogging() {
      this.totalTests++;
      const button = event.target;
      this.setButtonState(button, "loading");

      try {
        const result = await this.sendRequest("test_server_logging", {
          log_message:
            "ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã‹ã‚‰ã®ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: " + new Date().toISOString(),
          log_level: "INFO",
        });

        if (result.success) {
          this.setButtonState(button, "success");
          this.addResultLog(
            `ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ãƒ†ã‚¹ãƒˆæˆåŠŸ: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ« ${result.data.log_file} (${result.data.file_size}bytes)`,
            "success"
          );
          this.addResultLog(
            `ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "${result.data.log_message}"`,
            "info"
          );
        } else {
          this.setButtonState(button, "error");
          this.addResultLog(`ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ãƒ†ã‚¹ãƒˆå¤±æ•—: ${result.error}`, "error");
        }
      } catch (error) {
        this.setButtonState(button, "error");
        this.addResultLog(
          `ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ãƒ†ã‚¹ãƒˆ ã‚¨ãƒ©ãƒ¼: ${error.message}`,
          "error"
        );
      }
    },

    // ğŸ¯ çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    async runBasicTests() {
      this.addResultLog("=== åŸºæœ¬ãƒ†ã‚¹ãƒˆé–‹å§‹ ===", "info");

      const basicTests = [
        () =>
          this.sendRequest("health_check").then((r) =>
            this.addResultLog(
              "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: " + (r.success ? "æˆåŠŸ" : "å¤±æ•—"),
              r.success ? "success" : "error"
            )
          ),
        () => this.testButtonClick(document.createElement("button")),
        () => this.testApiKeyCheck(),
        () => this.testSessionVars(),
      ];

      for (const test of basicTests) {
        try {
          await test();
          await new Promise((resolve) => setTimeout(resolve, 500));
        } catch (error) {
          this.addResultLog(`åŸºæœ¬ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
        }
      }

      this.addResultLog("=== åŸºæœ¬ãƒ†ã‚¹ãƒˆå®Œäº† ===", "info");
    },

    async runAllTests() {
      this.addResultLog("=== å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹ ===", "info");

      const allTestButtons = document.querySelectorAll(
        '.test-btn-enhanced:not([onclick*="runAllTests"])'
      );

      for (let i = 0; i < allTestButtons.length; i++) {
        const button = allTestButtons[i];

        try {
          this.addResultLog(
            `[${i + 1}/${
              allTestButtons.length
            }] ${button.textContent.trim()} å®Ÿè¡Œä¸­...`,
            "info"
          );
          button.click();
          await new Promise((resolve) => setTimeout(resolve, 2000));
        } catch (error) {
          this.addResultLog(`ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
        }
      }

      this.addResultLog("=== å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº† ===", "success");
    },

    // ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
    exportReport(format = "json") {
      const reportData = {
        timestamp: new Date().toISOString(),
        system_info: {
          user_agent: navigator.userAgent,
          url: window.location.href,
          test_tool_version: this.version,
        },
        statistics: {
          total_tests: this.totalTests,
          passed_tests: this.passedTests,
          failed_tests: this.failedTests,
          success_rate:
            this.totalTests > 0
              ? ((this.passedTests / this.totalTests) * 100).toFixed(1) + "%"
              : "0%",
        },
        test_results: this.testResults,
      };

      if (format === "html") {
        this.exportHtmlReport(reportData);
      } else {
        this.exportJsonReport(reportData);
      }
    },

    exportJsonReport(data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `nagano3_enhanced_test_report_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      this.addResultLog("JSONãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›å®Œäº†", "success");
    },

    exportHtmlReport(data) {
      const html = `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAGANO-3 ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .results { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .result-item { padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #ddd; }
        .result-success { background: #f0f9ff; border-left-color: #10b981; }
        .result-error { background: #fef2f2; border-left-color: #ef4444; }
        .result-warning { background: #fffbeb; border-left-color: #f59e0b; }
        .result-info { background: #f8fafc; border-left-color: #6366f1; }
    </style>
<script>
// CAIDS error_handling Hook

// CAIDS ã‚¨ãƒ©ãƒ¼å‡¦ç†Hook - å®Œå…¨å®Ÿè£…
window.CAIDS_ERROR_HANDLER = {
    isActive: true,
    errorCount: 0,
    errorHistory: [],
    
    initialize: function() {
        this.setupGlobalErrorHandler();
        this.setupUnhandledPromiseRejection();
        this.setupNetworkErrorHandler();
        console.log('âš ï¸ CAIDS ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨åˆæœŸåŒ–');
    },
    
    setupGlobalErrorHandler: function() {
        window.addEventListener('error', (event) => {
            this.handleError({
                type: 'JavaScript Error',
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack
            });
        });
    },
    
    setupUnhandledPromiseRejection: function() {
        window.addEventListener('unhandledrejection', (event) => {
            this.handleError({
                type: 'Unhandled Promise Rejection',
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack
            });
        });
    },
    
    setupNetworkErrorHandler: function() {
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                if (!response.ok) {
                    window.CAIDS_ERROR_HANDLER.handleError({
                        type: 'Network Error',
                        message: `HTTP ${response.status}: ${response.statusText}`,
                        url: args[0]
                    });
                }
                return response;
            } catch (error) {
                window.CAIDS_ERROR_HANDLER.handleError({
                    type: 'Network Fetch Error',
                    message: error.message,
                    url: args[0]
                });
                throw error;
            }
        };
    },
    
    handleError: function(errorInfo) {
        this.errorCount++;
        this.errorHistory.push({...errorInfo, timestamp: new Date().toISOString()});
        
        console.error('ğŸš¨ CAIDS Error Handler:', errorInfo);
        this.showErrorNotification(errorInfo);
        this.reportError(errorInfo);
    },
    
    showErrorNotification: function(errorInfo) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 10px; right: 10px; z-index: 999999;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 350px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            border: 2px solid #ff6666; animation: caids-error-shake 0.5s ease-in-out;
        `;
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">ğŸš¨</span>
                <div>
                    <strong>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</strong><br>
                    <small style="opacity: 0.9;">${errorInfo.type}: ${errorInfo.message}</small>
                </div>
            </div>
        `;
        
        // CSS Animation
        if (!document.getElementById('caids-error-styles')) {
            const style = document.createElement('style');
            style.id = 'caids-error-styles';
            style.textContent = `
                @keyframes caids-error-shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 7000);
    },
    
    reportError: function(errorInfo) {
        // ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ»é€ä¿¡ï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
        const report = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            errorCount: this.errorCount,
            sessionId: this.getSessionId(),
            ...errorInfo
        };
        
        console.log('ğŸ“‹ CAIDS Error Report:', report);
        localStorage.setItem('caids_last_error', JSON.stringify(report));
    },
    
    getSessionId: function() {
        let sessionId = sessionStorage.getItem('caids_session_id');
        if (!sessionId) {
            sessionId = 'caids_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('caids_session_id', sessionId);
        }
        return sessionId;
    },
    
    getErrorStats: function() {
        return {
            totalErrors: this.errorCount,
            recentErrors: this.errorHistory.slice(-10),
            sessionId: this.getSessionId()
        };
    }
};

window.CAIDS_ERROR_HANDLER.initialize();

</script>
<script>
// CAIDS loading_management Hook

// CAIDS ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç®¡ç†Hook - å®Œå…¨å®Ÿè£…
window.CAIDS_LOADING = {
    isActive: false,
    loadingElements: new Map(),
    defaultMessages: {
        'fetch': 'ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...',
        'upload': 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...',
        'process': 'å‡¦ç†ä¸­...',
        'save': 'ä¿å­˜ä¸­...',
        'delete': 'å‰Šé™¤ä¸­...',
        'search': 'æ¤œç´¢ä¸­...'
    },
    
    show: function(message = 'èª­ã¿è¾¼ã¿ä¸­...', options = {}) {
        const loadingId = 'caids-loading-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const {
            target = null,
            type = 'default',
            showProgress = false,
            timeout = 30000
        } = options;
        
        const loadingDiv = document.createElement('div');
        loadingDiv.id = loadingId;
        loadingDiv.className = 'caids-loading-overlay';
        
        const isFullscreen = !target;
        loadingDiv.style.cssText = `
            position: ${isFullscreen ? 'fixed' : 'absolute'};
            top: ${isFullscreen ? '0' : '50%'}; left: ${isFullscreen ? '0' : '50%'};
            ${isFullscreen ? 'width: 100%; height: 100%;' : 'transform: translate(-50%, -50%);'}
            background: ${isFullscreen ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.8)'};
            z-index: 999999; display: flex; align-items: center; justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        `;
        
        const contentDiv = document.createElement('div');
        contentDiv.style.cssText = `
            background: white; padding: 30px 40px; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 20px;
            max-width: 400px; text-align: center;
        `;
        
        const spinnerType = this.getSpinnerByType(type);
        contentDiv.innerHTML = `
            <div class="caids-spinner">${spinnerType}</div>
            <div>
                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px;">
                    ${message}
                </div>
                ${showProgress ? '<div class="caids-progress-bar"><div class="caids-progress-fill"></div></div>' : ''}
                <div style="font-size: 12px; color: #666;">
                    ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...
                </div>
            </div>
        `;
        
        // CSS stylesè¿½åŠ 
        this.addLoadingStyles();
        
        if (target) {
            target.style.position = 'relative';
            target.appendChild(loadingDiv);
        } else {
            document.body.appendChild(loadingDiv);
        }
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        const timeoutId = setTimeout(() => {
            this.hide(loadingId);
            console.warn('âš ï¸ CAIDS Loading timeout:', message);
        }, timeout);
        
        this.loadingElements.set(loadingId, {
            element: loadingDiv,
            message,
            startTime: Date.now(),
            timeoutId,
            target
        });
        
        this.isActive = true;
        console.log('â³ CAIDS Loadingé–‹å§‹:', message, `[${loadingId}]`);
        
        return loadingId;
    },
    
    hide: function(loadingId = null) {
        if (loadingId) {
            const loading = this.loadingElements.get(loadingId);
            if (loading) {
                loading.element.remove();
                clearTimeout(loading.timeoutId);
                this.loadingElements.delete(loadingId);
                
                const duration = Date.now() - loading.startTime;
                console.log('âœ… CAIDS Loadingçµ‚äº†:', loading.message, `(${duration}ms)`);
            }
        } else {
            // å…¨ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å‰Šé™¤
            this.loadingElements.forEach((loading, id) => {
                loading.element.remove();
                clearTimeout(loading.timeoutId);
            });
            this.loadingElements.clear();
            console.log('âœ… CAIDS Loadingå…¨çµ‚äº†');
        }
        
        this.isActive = this.loadingElements.size > 0;
    },
    
    updateMessage: function(loadingId, newMessage) {
        const loading = this.loadingElements.get(loadingId);
        if (loading) {
            const messageDiv = loading.element.querySelector('div > div');
            if (messageDiv) {
                messageDiv.textContent = newMessage;
            }
        }
    },
    
    getSpinnerByType: function(type) {
        const spinners = {
            'default': '<div class="caids-spinner-circle"></div>',
            'dots': '<div class="caids-spinner-dots"><span></span><span></span><span></span></div>',
            'bars': '<div class="caids-spinner-bars"><span></span><span></span><span></span><span></span></div>',
            'pulse': '<div class="caids-spinner-pulse"></div>'
        };
        return spinners[type] || spinners['default'];
    },
    
    addLoadingStyles: function() {
        if (document.getElementById('caids-loading-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'caids-loading-styles';
        style.textContent = `
            .caids-spinner-circle {
                width: 24px; height: 24px; border: 3px solid #f3f3f3;
                border-top: 3px solid #007bff; border-radius: 50%;
                animation: caids-spin 1s linear infinite;
            }
            
            .caids-spinner-dots {
                display: flex; gap: 4px;
            }
            .caids-spinner-dots span {
                width: 8px; height: 8px; background: #007bff;
                border-radius: 50%; animation: caids-dots 1.4s ease-in-out infinite both;
            }
            .caids-spinner-dots span:nth-child(1) { animation-delay: -0.32s; }
            .caids-spinner-dots span:nth-child(2) { animation-delay: -0.16s; }
            
            .caids-progress-bar {
                width: 200px; height: 4px; background: #e9ecef;
                border-radius: 2px; overflow: hidden; margin: 10px 0;
            }
            .caids-progress-fill {
                height: 100%; background: linear-gradient(90deg, #007bff, #28a745);
                animation: caids-progress 2s ease-in-out infinite;
            }
            
            @keyframes caids-spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            @keyframes caids-dots {
                0%, 80%, 100% { transform: scale(0); }
                40% { transform: scale(1); }
            }
            
            @keyframes caids-progress {
                0% { transform: translateX(-100%); }
                50% { transform: translateX(0%); }
                100% { transform: translateX(100%); }
            }
        `;
        document.head.appendChild(style);
    },
    
    wrapAsyncOperation: async function(operation, message = 'å‡¦ç†ä¸­...', options = {}) {
        const loadingId = this.show(message, options);
        try {
            const result = await operation();
            this.hide(loadingId);
            return result;
        } catch (error) {
            this.hide(loadingId);
            throw error;
        }
    },
    
    // APIå‘¼ã³å‡ºã—è‡ªå‹•ãƒ©ãƒƒãƒ”ãƒ³ã‚°
    wrapFetchAPI: function() {
        if (window.caids_fetch_wrapped) return;
        
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            const message = window.CAIDS_LOADING.getLoadingMessageForURL(url);
            const loadingId = window.CAIDS_LOADING.show(message, {type: 'default'});
            
            return originalFetch.call(this, url, options).finally(() => {
                window.CAIDS_LOADING.hide(loadingId);
            });
        };
        
        window.caids_fetch_wrapped = true;
        console.log('ğŸ”— CAIDS Fetch API auto-wrapping enabled');
    },
    
    getLoadingMessageForURL: function(url) {
        if (typeof url === 'string') {
            if (url.includes('/api/')) return 'APIé€šä¿¡ä¸­...';
            if (url.includes('upload')) return 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
            if (url.includes('download')) return 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...';
            if (url.includes('search')) return 'æ¤œç´¢ä¸­...';
        }
        return 'ãƒ‡ãƒ¼ã‚¿é€šä¿¡ä¸­...';
    }
};

// è‡ªå‹•åˆæœŸåŒ–
window.CAIDS_LOADING.wrapFetchAPI();
console.log('â³ CAIDS ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨åˆæœŸåŒ–');

</script>
<script>
// CAIDS user_feedback Hook
// CAIDS user_feedback Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… user_feedback Hook loaded');
</script>
<script>
// CAIDS character_limit Hook
// CAIDS character_limit Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… character_limit Hook loaded');
</script>
<script>
// CAIDS development_control Hook
// CAIDS development_control Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… development_control Hook loaded');
</script>
<script>
// CAIDS natural_explanation Hook
// CAIDS natural_explanation Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… natural_explanation Hook loaded');
</script>
<script>
// CAIDS emergency_accumulation Hook
// CAIDS emergency_accumulation Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… emergency_accumulation Hook loaded');
</script>
<script>
// CAIDS pre_analysis_enforcement Hook
// CAIDS pre_analysis_enforcement Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… pre_analysis_enforcement Hook loaded');
</script>
<script>
// CAIDS user_approval_required Hook
// CAIDS user_approval_required Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… user_approval_required Hook loaded');
</script>
<script>
// CAIDS timeout_management Hook
// CAIDS timeout_management Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… timeout_management Hook loaded');
</script>
<script>
// CAIDS ajax_integration Hook
// CAIDS ajax_integration Hook - åŸºæœ¬å®Ÿè£…
console.log('âœ… ajax_integration Hook loaded');
</script>
</head>
<body>
    <div class="header">
        <h1>ğŸš€ NAGANO-3 çµ±åˆãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ</h1>
        <p>ç”Ÿæˆæ—¥æ™‚: ${data.timestamp}</p>
        <p>ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${data.system_info.test_tool_version}</p>
    </div>
    
    <div class="stats">
        <div class="stat-card">
            <h3>ç·ãƒ†ã‚¹ãƒˆæ•°</h3>
            <p style="font-size: 2em; margin: 0; color: #667eea;">${
              data.statistics.total_tests
            }</p>
        </div>
        <div class="stat-card">
            <h3>æˆåŠŸ</h3>
            <p style="font-size: 2em; margin: 0; color: #10b981;">${
              data.statistics.passed_tests
            }</p>
        </div>
        <div class="stat-card">
            <h3>å¤±æ•—</h3>
            <p style="font-size: 2em; margin: 0; color: #ef4444;">${
              data.statistics.failed_tests
            }</p>
        </div>
        <div class="stat-card">
            <h3>æˆåŠŸç‡</h3>
            <p style="font-size: 2em; margin: 0; color: #667eea;">${
              data.statistics.success_rate
            }</p>
        </div>
    </div>
    
    <div class="results">
        <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ­ã‚°</h3>
        ${data.test_results
          .map(
            (result) => `
            <div class="result-item result-${result.type}">
                <strong>[${new Date(
                  result.timestamp
                ).toLocaleTimeString()}]</strong> ${result.message}
            </div>
        `
          )
          .join("")}
    </div>
    
    <footer style="text-align: center; margin-top: 30px; color: #666;">
        <p>NAGANO-3 çµ±åˆãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«æ‹¡å¼µç‰ˆ - è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ</p>
    </footer>
</body>
</html>`;

      const blob = new Blob([html], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `nagano3_enhanced_test_report_${Date.now()}.html`;
      a.click();
      URL.revokeObjectURL(url);

      this.addResultLog("HTMLãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›å®Œäº†", "success");
    },

    // ğŸ¯ ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
    showModal(title, content) {
      const modal = document.getElementById("test-modal");
      const modalContent = document.getElementById("modal-content");

      modalContent.innerHTML = `
            <h4>${title}</h4>
            <p>${content}</p>
        `;

      modal.classList.add("show");
    },

    closeModal() {
      const modal = document.getElementById("test-modal");
      modal.classList.remove("show");
    },
  };

  // ğŸš€ åˆæœŸåŒ–
  document.addEventListener("DOMContentLoaded", () => {
    EnhancedTestSystem.init();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById("test-modal").addEventListener("click", (e) => {
      if (e.target.classList.contains("test-modal-overlay")) {
        EnhancedTestSystem.closeModal();
      }
    });
  });

  console.log("ğŸš€ EnhancedTestSystem v2.0.0 æº–å‚™å®Œäº†");
</script>
