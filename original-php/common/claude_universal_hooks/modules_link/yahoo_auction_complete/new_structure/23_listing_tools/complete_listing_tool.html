import React, { useState, useEffect } from 'react';
import { ChevronRight, ChevronLeft, Plus, X, Upload, Save, Eye, ShoppingCart, Package, ImageIcon, DollarSign, Tag, Layers } from 'lucide-react';

const EbayListingTool = () => {
  const [currentStep, setCurrentStep] = useState(1);
  const [listingData, setListingData] = useState({
    category: null,
    basicInfo: {
      title: '',
      description: '',
      brand: '',
      basePrice: ''
    },
    variations: {
      axes: [],
      items: []
    },
    bundles: [],
    images: [],
    templates: []
  });

  // カテゴリテンプレート
  const categoryTemplates = {
    trading_cards: {
      name: 'トレーディングカード',
      icon: '🃏',
      recommended_axes: [
        { 
          code: 'series', 
          name: 'シリーズ', 
          required: true, 
          type: 'select',
          default_values: ['VSTARユニバース', '旧裏面', 'ポケモンGO', 'スペースジャグラー']
        },
        { 
          code: 'condition', 
          name: '状態', 
          required: true, 
          type: 'select',
          default_values: ['ミント', 'ニアミント', 'エクセレント', 'ベリーグッド', 'グッド']
        },
        { 
          code: 'grading', 
          name: 'グレード', 
          required: false, 
          type: 'select',
          default_values: ['PSA 10', 'PSA 9', 'BGS 9.5', '未鑑定']
        },
        { 
          code: 'language', 
          name: '言語', 
          required: false, 
          type: 'select',
          default_values: ['日本語', '英語', '韓国語']
        }
      ],
      pricing_rules: {
        condition: { mint: 1.0, near_mint: 0.9, excellent: 0.8, very_good: 0.7, good: 0.6 },
        grading: { psa_10: 3.0, psa_9: 2.0, bgs_95: 2.5, ungraded: 1.0 },
        language: { japanese: 1.0, english: 1.2, korean: 0.8 }
      }
    },
    clothing: {
      name: 'アパレル',
      icon: '👕',
      recommended_axes: [
        { 
          code: 'size', 
          name: 'サイズ', 
          required: true, 
          type: 'select',
          default_values: ['XS', 'S', 'M', 'L', 'XL', 'XXL']
        },
        { 
          code: 'color', 
          name: 'カラー', 
          required: true, 
          type: 'color',
          default_values: ['ホワイト', 'ブラック', 'レッド', 'ブルー', 'グレー']
        },
        { 
          code: 'material', 
          name: '素材', 
          required: false, 
          type: 'select',
          default_values: ['コットン100%', 'ポリエステル', '綿ポリ混合']
        }
      ],
      pricing_rules: {
        size: { xs: 1.0, s: 1.0, m: 1.0, l: 1.0, xl: 1.1, xxl: 1.2 },
        color: { white: 1.0, black: 1.0, red: 1.05, blue: 1.05 }
      }
    },
    electronics: {
      name: '電子機器',
      icon: '📱',
      recommended_axes: [
        { 
          code: 'capacity', 
          name: '容量', 
          required: true, 
          type: 'select',
          default_values: ['64GB', '128GB', '256GB', '512GB', '1TB']
        },
        { 
          code: 'color', 
          name: 'カラー', 
          required: true, 
          type: 'select',
          default_values: ['スペースグレイ', 'シルバー', 'ゴールド', 'ブルー']
        },
        { 
          code: 'condition', 
          name: '状態', 
          required: true, 
          type: 'select',
          default_values: ['新品', '中古美品', '中古良品', '中古可']
        }
      ],
      pricing_rules: {
        capacity: { '64gb': 1.0, '128gb': 1.3, '256gb': 1.6, '512gb': 2.0, '1tb': 2.5 },
        condition: { new: 1.0, like_new: 0.9, very_good: 0.8, good: 0.7 }
      }
    }
  };

  // ステップ定義
  const steps = [
    { id: 1, title: 'カテゴリ選択', icon: <Tag className="w-4 h-4" /> },
    { id: 2, title: '基本情報', icon: <ShoppingCart className="w-4 h-4" /> },
    { id: 3, title: 'バリエーション', icon: <Layers className="w-4 h-4" /> },
    { id: 4, title: '価格・在庫', icon: <DollarSign className="w-4 h-4" /> },
    { id: 5, title: '画像・説明', icon: <ImageIcon className="w-4 h-4" /> },
    { id: 6, title: 'セット品', icon: <Package className="w-4 h-4" /> },
    { id: 7, title: '確認・出品', icon: <Eye className="w-4 h-4" /> }
  ];

  // 価格計算関数
  const calculateVariationPrice = (basePrice, attributes, category) => {
    let price = parseFloat(basePrice) || 0;
    const rules = categoryTemplates[category]?.pricing_rules || {};
    
    Object.entries(attributes).forEach(([axis, value]) => {
      const axisRules = rules[axis] || {};
      const multiplier = axisRules[value.toLowerCase().replace(/\s+/g, '_')] || 1.0;
      price *= multiplier;
    });
    
    return Math.round(price);
  };

  // SKU生成関数
  const generateSKU = (title, attributes) => {
    const titlePart = title.replace(/\s+/g, '').substring(0, 4).toUpperCase();
    const attrPart = Object.values(attributes).map(v => 
      v.replace(/\s+/g, '').substring(0, 2).toUpperCase()
    ).join('_');
    return `${titlePart}_${attrPart}`;
  };

  // バリエーション組み合わせ生成
  const generateVariationCombinations = (axes) => {
    if (axes.length === 0 || axes.some(axis => axis.values.length === 0)) {
      return [];
    }

    const combinations = axes.reduce((acc, axis) => {
      if (acc.length === 0) {
        return axis.values.map(value => ({ [axis.code]: value }));
      }
      
      const newCombinations = [];
      acc.forEach(combo => {
        axis.values.forEach(value => {
          newCombinations.push({ ...combo, [axis.code]: value });
        });
      });
      return newCombinations;
    }, []);

    return combinations.map((combo, index) => ({
      id: `var_${index}`,
      attributes: combo,
      displayName: Object.values(combo).join(' / '),
      sku: generateSKU(listingData.basicInfo.title, combo),
      price: calculateVariationPrice(listingData.basicInfo.basePrice, combo, listingData.category),
      quantity: 0,
      images: []
    }));
  };

  // ステップ1: カテゴリ選択
  const CategorySelectionStep = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold text-gray-800">商品カテゴリを選択してください</h2>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        {Object.entries(categoryTemplates).map(([code, template]) => (
          <div
            key={code}
            className={`p-6 border-2 rounded-lg cursor-pointer transition-all hover:shadow-lg ${
              listingData.category === code 
                ? 'border-blue-500 bg-blue-50' 
                : 'border-gray-200 hover:border-gray-300'
            }`}
            onClick={() => setListingData({...listingData, category: code})}
          >
            <div className="text-center">
              <div className="text-4xl mb-3">{template.icon}</div>
              <h3 className="text-lg font-semibold">{template.name}</h3>
              <p className="text-sm text-gray-600 mt-2">
                推奨軸: {template.recommended_axes.length}個
              </p>
            </div>
          </div>
        ))}
      </div>

      {listingData.category && (
        <div className="bg-blue-50 p-4 rounded-lg">
          <h3 className="font-semibold mb-2">
            {categoryTemplates[listingData.category].name} の推奨バリエーション
          </h3>
          <div className="flex flex-wrap gap-2">
            {categoryTemplates[listingData.category].recommended_axes.map(axis => (
              <span key={axis.code} className={`px-3 py-1 rounded text-sm ${
                axis.required ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'
              }`}>
                {axis.name} {axis.required && '(必須)'}
              </span>
            ))}
          </div>
        </div>
      )}
    </div>
  );

  // ステップ2: 基本情報
  const BasicInfoStep = () => (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold text-gray-800">基本情報を入力してください</h2>
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            商品タイトル *
          </label>
          <input
            type="text"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={listingData.basicInfo.title}
            onChange={(e) => setListingData({
              ...listingData,
              basicInfo: {...listingData.basicInfo, title: e.target.value}
            })}
            placeholder="例: ポケモンカード リザードン"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            ブランド
          </label>
          <input
            type="text"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={listingData.basicInfo.brand}
            onChange={(e) => setListingData({
              ...listingData,
              basicInfo: {...listingData.basicInfo, brand: e.target.value}
            })}
            placeholder="例: ポケモン"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            基準価格 (円) *
          </label>
          <input
            type="number"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={listingData.basicInfo.basePrice}
            onChange={(e) => setListingData({
              ...listingData,
              basicInfo: {...listingData.basicInfo, basePrice: e.target.value}
            })}
            placeholder="例: 5000"
          />
        </div>

        <div className="md:col-span-2">
          <label className="block text-sm font-medium text-gray-700 mb-2">
            商品説明
          </label>
          <textarea
            rows={4}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={listingData.basicInfo.description}
            onChange={(e) => setListingData({
              ...listingData,
              basicInfo: {...listingData.basicInfo, description: e.target.value}
            })}
            placeholder="商品の詳細説明を入力してください..."
          />
        </div>
      </div>
    </div>
  );

  // ステップ3: バリエーション設定
  const VariationSetupStep = () => {
    const [activeAxes, setActiveAxes] = useState(listingData.variations.axes || []);
    const categoryTemplate = categoryTemplates[listingData.category];

    const addAxis = (axisTemplate) => {
      const newAxis = {
        ...axisTemplate,
        id: Date.now(),
        values: axisTemplate.default_values || []
      };
      const updatedAxes = [...activeAxes, newAxis];
      setActiveAxes(updatedAxes);
      
      // バリエーション項目を生成
      const combinations = generateVariationCombinations(updatedAxes);
      setListingData({
        ...listingData,
        variations: {
          axes: updatedAxes,
          items: combinations
        }
      });
    };

    const removeAxis = (axisId) => {
      const updatedAxes = activeAxes.filter(axis => axis.id !== axisId);
      setActiveAxes(updatedAxes);
      
      const combinations = generateVariationCombinations(updatedAxes);
      setListingData({
        ...listingData,
        variations: {
          axes: updatedAxes,
          items: combinations
        }
      });
    };

    const updateAxisValues = (axisId, newValues) => {
      const updatedAxes = activeAxes.map(axis => 
        axis.id === axisId ? {...axis, values: newValues} : axis
      );
      setActiveAxes(updatedAxes);
      
      const combinations = generateVariationCombinations(updatedAxes);
      setListingData({
        ...listingData,
        variations: {
          axes: updatedAxes,
          items: combinations
        }
      });
    };

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-800">バリエーションを設定してください</h2>
        
        {/* 推奨軸 */}
        <div>
          <h3 className="text-lg font-semibold mb-3">推奨バリエーション軸</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            {categoryTemplate?.recommended_axes.map(axis => {
              const isActive = activeAxes.some(active => active.code === axis.code);
              return (
                <button
                  key={axis.code}
                  className={`p-3 border rounded-md text-left transition-colors ${
                    isActive 
                      ? 'bg-green-50 border-green-500 text-green-800' 
                      : 'bg-white border-gray-300 hover:border-blue-500'
                  }`}
                  onClick={() => !isActive && addAxis(axis)}
                  disabled={isActive}
                >
                  <div className="font-medium">{axis.name}</div>
                  <div className="text-sm text-gray-600">
                    {axis.required && '必須 • '}
                    例: {axis.default_values?.slice(0, 2).join(', ')}
                  </div>
                </button>
              );
            })}
          </div>
        </div>

        {/* アクティブな軸の編集 */}
        {activeAxes.length > 0 && (
          <div>
            <h3 className="text-lg font-semibold mb-3">設定中のバリエーション軸</h3>
            {activeAxes.map(axis => (
              <AxisEditor
                key={axis.id}
                axis={axis}
                onValuesChange={(values) => updateAxisValues(axis.id, values)}
                onRemove={() => removeAxis(axis.id)}
              />
            ))}
          </div>
        )}

        {/* バリエーション一覧 */}
        {listingData.variations.items.length > 0 && (
          <div>
            <h3 className="text-lg font-semibold mb-3">
              生成されたバリエーション ({listingData.variations.items.length}個)
            </h3>
            <div className="bg-gray-50 p-4 rounded-lg max-h-60 overflow-y-auto">
              {listingData.variations.items.map(item => (
                <div key={item.id} className="flex justify-between items-center py-2 border-b last:border-b-0">
                  <span className="font-medium">{item.displayName}</span>
                  <div className="text-right">
                    <div className="text-sm text-gray-600">SKU: {item.sku}</div>
                    <div className="font-semibold">¥{item.price.toLocaleString()}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    );
  };

  // 軸エディタコンポーネント
  const AxisEditor = ({ axis, onValuesChange, onRemove }) => {
    const [values, setValues] = useState(axis.values || []);
    const [newValue, setNewValue] = useState('');

    const addValue = () => {
      if (newValue.trim()) {
        const updatedValues = [...values, newValue.trim()];
        setValues(updatedValues);
        onValuesChange(updatedValues);
        setNewValue('');
      }
    };

    const removeValue = (index) => {
      const updatedValues = values.filter((_, i) => i !== index);
      setValues(updatedValues);
      onValuesChange(updatedValues);
    };

    return (
      <div className="border border-gray-200 rounded-lg p-4 mb-4">
        <div className="flex justify-between items-center mb-3">
          <h4 className="font-semibold">{axis.name}</h4>
          {!axis.required && (
            <button
              onClick={onRemove}
              className="text-red-500 hover:text-red-700"
            >
              <X className="w-4 h-4" />
            </button>
          )}
        </div>

        <div className="space-y-2">
          <div className="flex flex-wrap gap-2">
            {values.map((value, index) => (
              <span
                key={index}
                className="inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm"
              >
                {value}
                <button
                  onClick={() => removeValue(index)}
                  className="hover:text-blue-600"
                >
                  <X className="w-3 h-3" />
                </button>
              </span>
            ))}
          </div>

          <div className="flex gap-2">
            <input
              type="text"
              value={newValue}
              onChange={(e) => setNewValue(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && addValue()}
              className="flex-1 px-3 py-1 border border-gray-300 rounded text-sm"
              placeholder="新しい値を追加..."
            />
            <button
              onClick={addValue}
              className="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600"
            >
              追加
            </button>
          </div>
        </div>
      </div>
    );
  };

  // ステップ4: 価格・在庫設定
  const PricingInventoryStep = () => {
    const updateVariationItem = (itemId, field, value) => {
      const updatedItems = listingData.variations.items.map(item =>
        item.id === itemId ? { ...item, [field]: value } : item
      );
      setListingData({
        ...listingData,
        variations: { ...listingData.variations, items: updatedItems }
      });
    };

    const setBulkQuantity = (quantity) => {
      const updatedItems = listingData.variations.items.map(item => ({
        ...item,
        quantity: parseInt(quantity) || 0
      }));
      setListingData({
        ...listingData,
        variations: { ...listingData.variations, items: updatedItems }
      });
    };

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-800">価格と在庫を設定してください</h2>
        
        {/* 一括設定 */}
        <div className="bg-blue-50 p-4 rounded-lg">
          <h3 className="font-semibold mb-3">一括設定</h3>
          <div className="flex gap-4">
            <button
              onClick={() => setBulkQuantity(10)}
              className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >
              全て在庫10に設定
            </button>
            <button
              onClick={() => setBulkQuantity(5)}
              className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
            >
              全て在庫5に設定
            </button>
          </div>
        </div>

        {/* バリエーション別設定 */}
        <div className="space-y-3">
          {listingData.variations.items.map(item => (
            <div key={item.id} className="flex items-center gap-4 p-4 border border-gray-200 rounded-lg">
              <div className="flex-1">
                <div className="font-medium">{item.displayName}</div>
                <div className="text-sm text-gray-600">SKU: {item.sku}</div>
              </div>
              
              <div className="flex items-center gap-2">
                <label className="text-sm">価格:</label>
                <input
                  type="number"
                  value={item.price}
                  onChange={(e) => updateVariationItem(item.id, 'price', parseInt(e.target.value))}
                  className="w-24 px-2 py-1 border border-gray-300 rounded text-sm"
                />
                <span className="text-sm">円</span>
              </div>
              
              <div className="flex items-center gap-2">
                <label className="text-sm">在庫:</label>
                <input
                  type="number"
                  value={item.quantity}
                  onChange={(e) => updateVariationItem(item.id, 'quantity', parseInt(e.target.value))}
                  className="w-16 px-2 py-1 border border-gray-300 rounded text-sm"
                />
                <span className="text-sm">個</span>
              </div>
            </div>
          ))}
        </div>

        {/* 統計 */}
        <div className="grid grid-cols-3 gap-4 bg-gray-50 p-4 rounded-lg">
          <div className="text-center">
            <div className="text-2xl font-bold text-blue-600">
              {listingData.variations.items.length}
            </div>
            <div className="text-sm text-gray-600">バリエーション数</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold text-green-600">
              {listingData.variations.items.reduce((sum, item) => sum + (item.quantity || 0), 0)}
            </div>
            <div className="text-sm text-gray-600">総在庫数</div>
          </div>
          <div className="text-center">
            <div className="text-2xl font-bold text-purple-600">
              ¥{Math.round(listingData.variations.items.reduce((sum, item) => sum + (item.price || 0), 0) / listingData.variations.items.length || 0).toLocaleString()}
            </div>
            <div className="text-sm text-gray-600">平均価格</div>
          </div>
        </div>
      </div>
    );
  };

  // ステップ5: 画像・説明
  const ImageDescriptionStep = () => {
    const [images, setImages] = useState(listingData.images || []);

    const addImage = () => {
      const newImage = {
        id: Date.now(),
        url: `https://via.placeholder.com/300x300?text=商品画像${images.length + 1}`,
        alt: `商品画像${images.length + 1}`
      };
      const updatedImages = [...images, newImage];
      setImages(updatedImages);
      setListingData({ ...listingData, images: updatedImages });
    };

    const removeImage = (imageId) => {
      const updatedImages = images.filter(img => img.id !== imageId);
      setImages(updatedImages);
      setListingData({ ...listingData, images: updatedImages });
    };

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-800">画像と説明を設定してください</h2>
        
        {/* 画像アップロード */}
        <div>
          <h3 className="text-lg font-semibold mb-3">商品画像</h3>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {images.map(image => (
              <div key={image.id} className="relative group">
                <img
                  src={image.url}
                  alt={image.alt}
                  className="w-full h-32 object-cover border border-gray-300 rounded-lg"
                />
                <button
                  onClick={() => removeImage(image.id)}
                  className="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  <X className="w-4 h-4" />
                </button>
              </div>
            ))}
            
            <button
              onClick={addImage}
              className="w-full h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center hover:border-blue-500 transition-colors"
            >
              <div className="text-center text-gray-500">
                <Upload className="w-8 h-8 mx-auto mb-2" />
                <div className="text-sm">画像を追加</div>
              </div>
            </button>
          </div>
        </div>

        {/* 説明文テンプレート */}
        <div>
          <h3 className="text-lg font-semibold mb-3">商品説明テンプレート</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button className="p-4 border border-gray-300 rounded-lg text-left hover:border-blue-500">
              <div className="font-medium">基本テンプレート</div>
              <div className="text-sm text-gray-600">商品の基本情報を含む標準的な説明文</div>
            </button>
            <button className="p-4 border border-gray-300 rounded-lg text-left hover:border-blue-500">
              <div className="font-medium">詳細テンプレート</div>
              <div className="text-sm text-gray-600">詳細な商品説明とスペック情報</div>
            </button>
          </div>
        </div>

        {/* 説明文編集 */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            eBay商品説明文
          </label>
          <textarea
            rows={8}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={listingData.basicInfo.description}
            onChange={(e) => setListingData({
              ...listingData,
              basicInfo: { ...listingData.basicInfo, description: e.target.value }
            })}
            placeholder="eBayに表示される商品説明文を入力してください..."
          />
        </div>
      </div>
    );
  };

  // ステップ6: セット品設定
  const BundleSetupStep = () => {
    const [bundles, setBundles] = useState(listingData.bundles || []);
    const [newBundle, setNewBundle] = useState({
      name: '',
      description: '',
      components: [],
      discountRate: 10
    });

    const addBundle = () => {
      if (newBundle.name) {
        const bundle = {
          ...newBundle,
          id: Date.now(),
          price: calculateBundlePrice()
        };
        const updatedBundles = [...bundles, bundle];
        setBundles(updatedBundles);
        setListingData({ ...listingData, bundles: updatedBundles });
        setNewBundle({ name: '', description: '', components: [], discountRate: 10 });
      }
    };

    const calculateBundlePrice = () => {
      const totalPrice = newBundle.components.reduce((sum, comp) => {
        const item = listingData.variations.items.find(v => v.id === comp.itemId);
        return sum + (item?.price || 0) * comp.quantity;
      }, 0);
      return Math.round(totalPrice * (1 - newBundle.discountRate / 100));
    };

    const addComponentToBundle = (itemId) => {
      const existingComp = newBundle.components.find(c => c.itemId === itemId);
      if (existingComp) {
        setNewBundle({
          ...newBundle,
          components: newBundle.components.map(c =>
            c.itemId === itemId ? { ...c, quantity: c.quantity + 1 } : c
          )
        });
      } else {
        setNewBundle({
          ...newBundle,
          components: [...newBundle.components, { itemId, quantity: 1 }]
        });
      }
    };

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-800">セット品を作成してください</h2>
        
        {/* 新規セット品作成 */}
        <div className="border border-gray-300 rounded-lg p-6">
          <h3 className="text-lg font-semibold mb-4">新しいセット品</h3>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                セット品名
              </label>
              <input
                type="text"
                value={newBundle.name}
                onChange={(e) => setNewBundle({ ...newBundle, name: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-md"
                placeholder="例: リザードンセット"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                割引率 (%)
              </label>
              <input
                type="number"
                value={newBundle.discountRate}
                onChange={(e) => setNewBundle({ ...newBundle, discountRate: parseInt(e.target.value) })}
                className="w-full px-3 py-2 border border-gray-300 rounded-md"
                placeholder="10"
              />
            </div>
          </div>

          {/* 商品選択 */}
          <div className="mb-4">
            <h4 className="font-medium mb-2">構成商品を選択</h4>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-40 overflow-y-auto">
              {listingData.variations.items.map(item => (
                <button
                  key={item.id}
                  onClick={() => addComponentToBundle(item.id)}
                  className="text-left p-2 border border-gray-200 rounded hover:bg-blue-50"
                >
                  <div className="font-medium text-sm">{item.displayName}</div>
                  <div className="text-xs text-gray-600">¥{item.price?.toLocaleString()}</div>
                </button>
              ))}
            </div>
          </div>

          {/* 選択済み商品 */}
          {newBundle.components.length > 0 && (
            <div className="mb-4">
              <h4 className="font-medium mb-2">選択済み商品</h4>
              <div className="space-y-2">
                {newBundle.components.map(comp => {
                  const item = listingData.variations.items.find(v => v.id === comp.itemId);
                  return (
                    <div key={comp.itemId} className="flex justify-between items-center p-2 bg-gray-50 rounded">
                      <span className="text-sm">{item?.displayName} × {comp.quantity}</span>
                      <span className="text-sm font-medium">¥{((item?.price || 0) * comp.quantity).toLocaleString()}</span>
                    </div>
                  );
                })}
                <div className="border-t pt-2">
                  <div className="flex justify-between items-center font-semibold">
                    <span>セット価格 ({newBundle.discountRate}% 割引)</span>
                    <span className="text-green-600">¥{calculateBundlePrice().toLocaleString()}</span>
                  </div>
                </div>
              </div>
            </div>
          )}

          <button
            onClick={addBundle}
            disabled={!newBundle.name || newBundle.components.length === 0}
            className="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-300"
          >
            セット品を追加
          </button>
        </div>

        {/* 作成済みセット品 */}
        {bundles.length > 0 && (
          <div>
            <h3 className="text-lg font-semibold mb-3">作成済みセット品</h3>
            <div className="space-y-3">
              {bundles.map(bundle => (
                <div key={bundle.id} className="border border-gray-200 rounded-lg p-4">
                  <div className="flex justify-between items-start mb-2">
                    <h4 className="font-semibold">{bundle.name}</h4>
                    <span className="text-lg font-bold text-green-600">¥{bundle.price?.toLocaleString()}</span>
                  </div>
                  <div className="text-sm text-gray-600">
                    {bundle.components.length}個の商品, {bundle.discountRate}% 割引
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    );
  };

  // ステップ7: 確認・出品
  const ReviewSubmitStep = () => {
    const handleSubmit = async () => {
      // 実際のAPI呼び出し処理をここに実装
      alert('出品データを送信中...');
      
      // デモ用の遅延
      setTimeout(() => {
        alert('eBayへの出品が完了しました！');
      }, 2000);
    };

    const totalInventory = listingData.variations.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
    const avgPrice = listingData.variations.items.length > 0 
      ? Math.round(listingData.variations.items.reduce((sum, item) => sum + (item.price || 0), 0) / listingData.variations.items.length)
      : 0;

    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-800">出品内容を確認してください</h2>
        
        {/* 基本情報サマリー */}
        <div className="bg-white border border-gray-200 rounded-lg p-6">
          <h3 className="text-lg font-semibold mb-4">基本情報</h3>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <span className="text-sm text-gray-600">商品タイトル:</span>
              <div className="font-medium">{listingData.basicInfo.title}</div>
            </div>
            <div>
              <span className="text-sm text-gray-600">カテゴリ:</span>
              <div className="font-medium">{categoryTemplates[listingData.category]?.name}</div>
            </div>
            <div>
              <span className="text-sm text-gray-600">ブランド:</span>
              <div className="font-medium">{listingData.basicInfo.brand || '未設定'}</div>
            </div>
            <div>
              <span className="text-sm text-gray-600">基準価格:</span>
              <div className="font-medium">¥{parseInt(listingData.basicInfo.basePrice || 0).toLocaleString()}</div>
            </div>
          </div>
        </div>

        {/* バリエーション統計 */}
        <div className="grid grid-cols-3 gap-4">
          <div className="bg-blue-50 p-4 rounded-lg text-center">
            <div className="text-2xl font-bold text-blue-600">{listingData.variations.items.length}</div>
            <div className="text-sm text-blue-800">バリエーション数</div>
          </div>
          <div className="bg-green-50 p-4 rounded-lg text-center">
            <div className="text-2xl font-bold text-green-600">{totalInventory}</div>
            <div className="text-sm text-green-800">総在庫数</div>
          </div>
          <div className="bg-purple-50 p-4 rounded-lg text-center">
            <div className="text-2xl font-bold text-purple-600">¥{avgPrice.toLocaleString()}</div>
            <div className="text-sm text-purple-800">平均価格</div>
          </div>
        </div>

        {/* バリエーション一覧 */}
        <div className="bg-white border border-gray-200 rounded-lg p-6">
          <h3 className="text-lg font-semibold mb-4">バリエーション一覧</h3>
          <div className="max-h-60 overflow-y-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b">
                  <th className="text-left py-2">バリエーション</th>
                  <th className="text-left py-2">SKU</th>
                  <th className="text-right py-2">価格</th>
                  <th className="text-right py-2">在庫</th>
                </tr>
              </thead>
              <tbody>
                {listingData.variations.items.map(item => (
                  <tr key={item.id} className="border-b">
                    <td className="py-2">{item.displayName}</td>
                    <td className="py-2 text-gray-600">{item.sku}</td>
                    <td className="py-2 text-right font-medium">¥{item.price?.toLocaleString()}</td>
                    <td className="py-2 text-right">{item.quantity}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        {/* セット品サマリー */}
        {listingData.bundles.length > 0 && (
          <div className="bg-white border border-gray-200 rounded-lg p-6">
            <h3 className="text-lg font-semibold mb-4">セット品 ({listingData.bundles.length}個)</h3>
            <div className="space-y-2">
              {listingData.bundles.map(bundle => (
                <div key={bundle.id} className="flex justify-between items-center p-3 bg-gray-50 rounded">
                  <span className="font-medium">{bundle.name}</span>
                  <span className="text-green-600 font-semibold">¥{bundle.price?.toLocaleString()}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* 出品ボタン */}
        <div className="flex gap-4">
          <button className="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
            <Save className="w-5 h-5 inline mr-2" />
            下書き保存
          </button>
          <button 
            onClick={handleSubmit}
            className="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
          >
            <Upload className="w-5 h-5 inline mr-2" />
            eBayに出品
          </button>
        </div>
      </div>
    );
  };

  // ナビゲーション
  const canProceed = () => {
    switch(currentStep) {
      case 1: return !!listingData.category;
      case 2: return listingData.basicInfo.title && listingData.basicInfo.basePrice;
      case 3: return listingData.variations.items.length > 0;
      case 4: return listingData.variations.items.every(item => item.quantity >= 0);
      default: return true;
    }
  };

  // メインレンダー
  return (
    <div className="max-w-6xl mx-auto p-6 bg-gray-50 min-h-screen">
      {/* ヘッダー */}
      <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h1 className="text-3xl font-bold text-gray-800 mb-2">eBay出品ツール</h1>
        <p className="text-gray-600">バリエーション・セット品対応の総合出品システム</p>
      </div>

      {/* プログレスインジケータ */}
      <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div className="flex items-center justify-between">
          {steps.map((step, index) => (
            <div key={step.id} className="flex items-center">
              <div className={`flex items-center justify-center w-10 h-10 rounded-full border-2 ${
                currentStep >= step.id 
                  ? 'bg-blue-500 border-blue-500 text-white' 
                  : 'border-gray-300 text-gray-400'
              }`}>
                {step.icon}
              </div>
              <div className="ml-2 hidden md:block">
                <div className={`text-sm font-medium ${
                  currentStep >= step.id ? 'text-blue-600' : 'text-gray-400'
                }`}>
                  {step.title}
                </div>
              </div>
              {index < steps.length - 1 && (
                <ChevronRight className="w-5 h-5 text-gray-400 mx-4" />
              )}
            </div>
          ))}
        </div>
      </div>

      {/* メインコンテンツ */}
      <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
        {currentStep === 1 && <CategorySelectionStep />}
        {currentStep === 2 && <BasicInfoStep />}
        {currentStep === 3 && <VariationSetupStep />}
        {currentStep === 4 && <PricingInventoryStep />}
        {currentStep === 5 && <ImageDescriptionStep />}
        {currentStep === 6 && <BundleSetupStep />}
        {currentStep === 7 && <ReviewSubmitStep />}
      </div>

      {/* ナビゲーションボタン */}
      <div className="flex justify-between">
        <button
          onClick={() => setCurrentStep(Math.max(1, currentStep - 1))}
          disabled={currentStep === 1}
          className="flex items-center px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <ChevronLeft className="w-5 h-5 mr-2" />
          戻る
        </button>
        
        <button
          onClick={() => setCurrentStep(Math.min(7, currentStep + 1))}
          disabled={currentStep === 7 || !canProceed()}
          className="flex items-center px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          次へ
          <ChevronRight className="w-5 h-5 ml-2" />
        </button>
      </div>
    </div>
  );
};

export default EbayListingTool;