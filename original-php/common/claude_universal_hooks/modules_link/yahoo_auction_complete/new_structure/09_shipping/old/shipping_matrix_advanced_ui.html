<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€æ–™è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ  - å®Ÿãƒ‡ãƒ¼ã‚¿ãƒãƒˆãƒªãƒƒã‚¯ã‚¹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb;
            --emoji-color: #ff6b35;
            --cpass-color: #4ecdc4;
            --jppost-color: #e74c3c;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: var(--space-lg);
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--success-color));
            color: white;
            padding: var(--space-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-lg);
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: var(--space-sm);
        }

        .controls-panel {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 200px 150px 200px 150px auto;
            gap: var(--space-md);
            align-items: end;
            margin-bottom: var(--space-md);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: var(--space-xs);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .calculate-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .calculate-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .matrix-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 4px;
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .matrix-tab {
            flex: 1;
            padding: var(--space-md);
            border: none;
            background: transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
        }

        .matrix-tab.active {
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .matrix-tab.emoji.active { background: var(--emoji-color); }
        .matrix-tab.cpass.active { background: var(--cpass-color); }
        .matrix-tab.jppost.active { background: var(--jppost-color); }
        .matrix-tab.comparison.active { 
            background: linear-gradient(135deg, var(--emoji-color), var(--cpass-color), var(--jppost-color));
        }

        .matrix-tab:hover:not(.active) {
            background: var(--bg-tertiary);
        }

        .matrix-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            min-height: 500px;
        }

        .matrix-grid {
            display: grid;
            grid-template-columns: 180px repeat(auto-fit, minmax(120px, 1fr));
            gap: 1px;
            background: var(--border-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .matrix-cell {
            background: white;
            padding: 12px 8px;
            text-align: center;
            position: relative;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .matrix-cell.header {
            background: var(--bg-tertiary);
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--border-color);
        }

        .matrix-cell.service-name {
            background: var(--bg-tertiary);
            text-align: left;
            font-weight: 600;
            padding-left: var(--space-md);
        }

        .matrix-cell.price {
            cursor: pointer;
            position: relative;
        }

        .matrix-cell.price:hover {
            background: #f0f9ff;
            transform: scale(1.02);
            z-index: 5;
            box-shadow: var(--shadow-md);
        }

        .matrix-cell.best-price {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            font-weight: 700;
            color: #166534;
        }

        .matrix-cell.fast-delivery {
            background: linear-gradient(135deg, #dbeafe, #93c5fd);
            color: #1e40af;
        }

        .price-breakdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            box-shadow: var(--shadow-lg);
            z-index: 20;
            min-width: 250px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .matrix-cell.price:hover .price-breakdown {
            opacity: 1;
            pointer-events: auto;
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--space-sm);
        }

        .breakdown-table td {
            padding: 4px 8px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.8rem;
        }

        .breakdown-table .total {
            font-weight: 700;
            border-top: 2px solid var(--border-color);
        }

        .delivery-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .delivery-info p {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            color: var(--text-secondary);
        }

        .comparison-view {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
        }

        .carrier-comparison {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .carrier-comparison.emoji { border-top: 4px solid var(--emoji-color); }
        .carrier-comparison.cpass { border-top: 4px solid var(--cpass-color); }
        .carrier-comparison.jppost { border-top: 4px solid var(--jppost-color); }

        .carrier-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .carrier-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .carrier-icon.emoji { background: var(--emoji-color); }
        .carrier-icon.cpass { background: var(--cpass-color); }
        .carrier-icon.jppost { background: var(--jppost-color); }

        .service-cards {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .service-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            transition: all 0.2s;
            cursor: pointer;
        }

        .service-card:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }

        .service-card.recommended {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border: 2px solid var(--success-color);
        }

        .service-name {
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .service-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-sm);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .price-display {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--success-color);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .summary-stats {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-lg);
        }

        .stat-item {
            text-align: center;
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }

        .export-controls {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        .export-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #059669;
        }

        @media (max-width: 1200px) {
            .controls-grid {
                grid-template-columns: 1fr 1fr;
                gap: var(--space-sm);
            }
            
            .matrix-grid {
                font-size: 0.75rem;
            }
            
            .comparison-view {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--space-md);
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .matrix-tabs {
                flex-direction: column;
            }
            
            .matrix-grid {
                grid-template-columns: 120px repeat(2, 1fr);
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <h1><i class="fas fa-shipping-fast"></i> é€æ–™è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>å®Ÿãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¯¾å¿œ - Emoji/CPass/æ—¥æœ¬éƒµä¾¿ ãƒãƒˆãƒªãƒƒã‚¯ã‚¹æ¯”è¼ƒ</p>
            <p><strong>é‡é‡æ®µéšåˆ¥å®Ÿæ–™é‡‘ãƒ»æ‰‹æ•°æ–™è¾¼ã¿æ­£ç¢ºè¨ˆç®—</strong></p>
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="controls-panel">
            <div class="controls-grid">
                <div class="form-group">
                    <label class="form-label">å•†å“é‡é‡</label>
                    <input type="number" id="weightInput" class="form-input" placeholder="500" min="1" max="30000" value="500">
                    <small style="color: var(--text-secondary);">ã‚°ãƒ©ãƒ å˜ä½ï¼ˆ1-30,000gï¼‰</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é…é€å…ˆå›½</label>
                    <select id="destinationSelect" class="form-select">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="US">ğŸ‡ºğŸ‡¸ ã‚¢ãƒ¡ãƒªã‚«</option>
                        <option value="SG">ğŸ‡¸ğŸ‡¬ ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«</option>
                        <option value="MY">ğŸ‡²ğŸ‡¾ ãƒãƒ¬ãƒ¼ã‚·ã‚¢</option>
                        <option value="TH">ğŸ‡¹ğŸ‡­ ã‚¿ã‚¤</option>
                        <option value="VN">ğŸ‡»ğŸ‡³ ãƒ™ãƒˆãƒŠãƒ </option>
                        <option value="ID">ğŸ‡®ğŸ‡© ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢</option>
                        <option value="PH">ğŸ‡µğŸ‡­ ãƒ•ã‚£ãƒªãƒ”ãƒ³</option>
                        <option value="TW">ğŸ‡¹ğŸ‡¼ å°æ¹¾</option>
                        <option value="HK">ğŸ‡­ğŸ‡° é¦™æ¸¯</option>
                        <option value="GB">ğŸ‡¬ğŸ‡§ ã‚¤ã‚®ãƒªã‚¹</option>
                        <option value="DE">ğŸ‡©ğŸ‡ª ãƒ‰ã‚¤ãƒ„</option>
                        <option value="FR">ğŸ‡«ğŸ‡· ãƒ•ãƒ©ãƒ³ã‚¹</option>
                        <option value="KR">ğŸ‡°ğŸ‡· éŸ“å›½</option>
                        <option value="CN">ğŸ‡¨ğŸ‡³ ä¸­å›½</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ã‚µãƒ¼ãƒ“ã‚¹ã‚¿ã‚¤ãƒ—</label>
                    <select id="serviceTypeSelect" class="form-select">
                        <option value="">å…¨ã¦è¡¨ç¤º</option>
                        <option value="express">ã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ã‚¹</option>
                        <option value="standard">æ¨™æº–é…é€</option>
                        <option value="economy">ã‚¨ã‚³ãƒãƒŸãƒ¼</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
                    <select id="displayModeSelect" class="form-select">
                        <option value="price">æ–™é‡‘é †</option>
                        <option value="speed">é€Ÿã•é †</option>
                        <option value="carrier">æ¥­è€…åˆ¥</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <button class="calculate-btn" onclick="calculateShippingMatrix()">
                        <i class="fas fa-calculator"></i>
                        <span id="btnText">è¨ˆç®—å®Ÿè¡Œ</span>
                        <span id="btnSpinner" class="loading" style="display: none;"></span>
                    </button>
                </div>
            </div>
            
            <div class="export-controls">
                <button class="export-btn" onclick="exportToCSV()">
                    <i class="fas fa-download"></i> CSVå‡ºåŠ›
                </button>
                <button class="export-btn" onclick="saveAsImage()">
                    <i class="fas fa-image"></i> ç”»åƒä¿å­˜
                </button>
                <button class="export-btn" onclick="printMatrix()">
                    <i class="fas fa-print"></i> å°åˆ·
                </button>
            </div>
        </div>

        <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
        <div id="summaryStats" class="summary-stats" style="display: none;">
            <h3 style="margin-bottom: var(--space-md);">è¨ˆç®—çµæœã‚µãƒãƒªãƒ¼</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalServicesCount">0</div>
                    <div class="stat-label">åˆ©ç”¨å¯èƒ½ã‚µãƒ¼ãƒ“ã‚¹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cheapestPrice">Â¥0</div>
                    <div class="stat-label">æœ€å®‰æ–™é‡‘</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="fastestDelivery">0æ—¥</div>
                    <div class="stat-label">æœ€é€Ÿé…é€</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgPrice">Â¥0</div>
                    <div class="stat-label">å¹³å‡æ–™é‡‘</div>
                </div>
            </div>
        </div>

        <!-- ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã‚¿ãƒ– -->
        <div class="matrix-tabs">
            <button class="matrix-tab comparison active" data-tab="comparison">
                <i class="fas fa-balance-scale"></i>
                å…¨æ¥­è€…æ¯”è¼ƒ
            </button>
            <button class="matrix-tab emoji" data-tab="emoji">
                <i class="fas fa-rocket"></i>
                Emojié…é€
            </button>
            <button class="matrix-tab cpass" data-tab="cpass">
                <i class="fas fa-plane"></i>
                CPassé…é€
            </button>
            <button class="matrix-tab jppost" data-tab="jppost">
                <i class="fas fa-mail-bulk"></i>
                æ—¥æœ¬éƒµä¾¿
            </button>
        </div>

        <!-- ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="matrix-container">
            <!-- æ¯”è¼ƒãƒ“ãƒ¥ãƒ¼ -->
            <div id="comparisonView" class="comparison-view">
                <p style="text-align: center; color: var(--text-secondary); margin-top: var(--space-xl);">
                    é‡é‡ã¨é…é€å…ˆã‚’é¸æŠã—ã¦ã€Œè¨ˆç®—å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„
                </p>
            </div>

            <!-- å€‹åˆ¥æ¥­è€…ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ -->
            <div id="emojiMatrix" class="matrix-grid" style="display: none;"></div>
            <div id="cpassMatrix" class="matrix-grid" style="display: none;"></div>
            <div id="jppostMatrix" class="matrix-grid" style="display: none;"></div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentTab = 'comparison';
        let lastCalculationData = null;
        let currentShippingData = [];

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
        document.querySelectorAll('.matrix-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            // ã‚¿ãƒ–ã®çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.matrix-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // ãƒ“ãƒ¥ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ
            const views = ['comparisonView', 'emojiMatrix', 'cpassMatrix', 'jppostMatrix'];
            views.forEach(viewId => {
                const element = document.getElementById(viewId);
                if (element) {
                    element.style.display = 'none';
                }
            });

            if (tabName === 'comparison') {
                document.getElementById('comparisonView').style.display = 'grid';
            } else {
                document.getElementById(tabName + 'Matrix').style.display = 'grid';
            }

            currentTab = tabName;

            // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å†è¡¨ç¤º
            if (currentShippingData.length > 0) {
                displayCalculationResults(currentShippingData);
            }
        }

        // é€æ–™è¨ˆç®—ãƒ¡ã‚¤ãƒ³é–¢æ•°
        async function calculateShippingMatrix() {
            const weight = parseInt(document.getElementById('weightInput').value);
            const destination = document.getElementById('destinationSelect').value;
            const serviceType = document.getElementById('serviceTypeSelect').value || null;
            const displayMode = document.getElementById('displayModeSelect').value;

            if (!weight || !destination) {
                alert('é‡é‡ã¨é…é€å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (weight < 1 || weight > 30000) {
                alert('é‡é‡ã¯1gã€œ30,000gã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
            setLoadingState(true);

            try {
                // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«é€æ–™è¨ˆç®—ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const response = await fetch('api/shipping_calculator_realdata.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'calculate_shipping_matrix',
                        weight_g: weight,
                        destination_country: destination,
                        service_type: serviceType,
                        display_mode: displayMode
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success) {
                    currentShippingData = data.shipping_options;
                    displayCalculationResults(data.shipping_options);
                    updateSummaryStats(data.shipping_options);
                    
                    // çµ±è¨ˆè¡¨ç¤º
                    document.getElementById('summaryStats').style.display = 'block';
                } else {
                    throw new Error(data.error || 'è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                console.error('é€æ–™è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
                alert('é€æ–™è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                setLoadingState(false);
            }
        }

        // è¨ˆç®—çµæœè¡¨ç¤º
        function displayCalculationResults(shippingOptions) {
            if (currentTab === 'comparison') {
                displayComparisonView(shippingOptions);
            } else {
                displayCarrierMatrix(shippingOptions, currentTab);
            }
        }

        // æ¯”è¼ƒãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        function displayComparisonView(shippingOptions) {
            const comparisonView = document.getElementById('comparisonView');
            
            // æ¥­è€…åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const carrierGroups = groupByCarrier(shippingOptions);
            
            let html = '';
            
            Object.keys(carrierGroups).forEach(carrierCode => {
                const services = carrierGroups[carrierCode];
                const carrierName = getCarrierDisplayName(carrierCode);
                const carrierClass = carrierCode.toLowerCase();
                
                html += `
                    <div class="carrier-comparison ${carrierClass}">
                        <div class="carrier-header">
                            <div class="carrier-icon ${carrierClass}">${carrierCode.charAt(0)}</div>
                            ${carrierName}
                        </div>
                        <div class="service-cards">
                `;
                
                services.forEach((service, index) => {
                    const isRecommended = index === 0; // æœ€åˆã®é …ç›®ã‚’æ¨å¥¨ã¨ã™ã‚‹
                    
                    html += `
                        <div class="service-card ${isRecommended ? 'recommended' : ''}" 
                             onclick="showServiceDetails('${service.carrier_code}', '${service.service_code}')">
                            <div class="service-name">${service.service_name}</div>
                            <div class="price-display">Â¥${service.total_price_jpy.toLocaleString()}</div>
                            <div class="service-details">
                                <div><i class="fas fa-clock"></i> ${service.delivery_days_min}-${service.delivery_days_max}æ—¥</div>
                                <div><i class="fas fa-box"></i> ${service.service_type}</div>
                                <div><i class="fas fa-shield-alt"></i> ${service.insurance_included ? 'ä¿é™ºä»˜' : 'ä¿é™ºãªã—'}</div>
                                <div><i class="fas fa-search"></i> ${service.tracking_available ? 'è¿½è·¡å¯' : 'è¿½è·¡ä¸å¯'}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            comparisonView.innerHTML = html;
        }

        // æ¥­è€…åˆ¥ãƒãƒˆãƒªãƒƒã‚¯ã‚¹è¡¨ç¤º
        function displayCarrierMatrix(shippingOptions, carrierCode) {
            const matrixElement = document.getElementById(carrierCode + 'Matrix');
            
            // æŒ‡å®šæ¥­è€…ã®ã‚µãƒ¼ãƒ“ã‚¹ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const carrierServices = shippingOptions.filter(option => 
                option.carrier_code.toLowerCase() === carrierCode.toLowerCase() ||
                (carrierCode === 'jppost' && option.carrier_code === 'JPPOST')
            );
            
            if (carrierServices.length === 0) {
                matrixElement.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: var(--space-xl); color: var(--text-secondary);">
                        é¸æŠã—ãŸæ¡ä»¶ã«è©²å½“ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“
                    </div>
                `;
                return;
            }
            
            // ãƒãƒˆãƒªãƒƒã‚¯ã‚¹å½¢å¼ã§HTMLç”Ÿæˆ
            let matrixHTML = generateMatrixHTML(carrierServices);
            matrixElement.innerHTML = matrixHTML;
        }

        // ãƒãƒˆãƒªãƒƒã‚¯ã‚¹HTMLç”Ÿæˆ
        function generateMatrixHTML(services) {
            const headers = ['ã‚µãƒ¼ãƒ“ã‚¹', 'æ–™é‡‘', 'ç‡ƒæ–™ä»£', 'åˆè¨ˆ', 'é…é€æ—¥æ•°', 'è¿½è·¡', 'ä¿é™º'];
            
            let html = '';
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
            headers.forEach(header => {
                html += `<div class="matrix-cell header">${header}</div>`;
            });
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            services.forEach((service, index) => {
                html += `
                    <div class="matrix-cell service-name">${service.service_name}</div>
                    <div class="matrix-cell price ${index === 0 ? 'best-price' : ''}" 
                         onclick="showPriceBreakdown(this, ${JSON.stringify(service).replace(/"/g, '&quot;')})">
                        Â¥${service.base_price_jpy.toLocaleString()}
                        <div class="price-breakdown">
                            <h4>${service.service_name}</h4>
                            <table class="breakdown-table">
                                <tr><td>åŸºæœ¬æ–™é‡‘:</td><td>Â¥${service.base_price_jpy.toLocaleString()}</td></tr>
                                <tr><td>ç‡ƒæ–™ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸:</td><td>Â¥${service.fuel_surcharge_jpy.toLocaleString()}</td></tr>
                                <tr><td>æ‰‹æ•°æ–™:</td><td>Â¥${(service.total_price_jpy - service.base_price_jpy - service.fuel_surcharge_jpy).toLocaleString()}</td></tr>
                                <tr class="total"><td><strong>åˆè¨ˆ:</strong></td><td><strong>Â¥${service.total_price_jpy.toLocaleString()}</strong></td></tr>
                            </table>
                            <div class="delivery-info">
                                <p><i class="fas fa-clock"></i> é…é€æ—¥æ•°: ${service.delivery_days_min}-${service.delivery_days_max}æ—¥</p>
                                <p><i class="fas fa-shield-alt"></i> ä¿é™º: ${service.insurance_included ? 'ä»˜å¸¯' : 'ãªã—'}</p>
                                <p><i class="fas fa-search"></i> è¿½è·¡: ${service.tracking_available ? 'å¯èƒ½' : 'ä¸å¯'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="matrix-cell">Â¥${service.fuel_surcharge_jpy.toLocaleString()}</div>
                    <div class="matrix-cell price ${index === 0 ? 'best-price' : ''}">Â¥${service.total_price_jpy.toLocaleString()}</div>
                    <div class="matrix-cell ${service.delivery_days_max <= 5 ? 'fast-delivery' : ''}">${service.delivery_days_min}-${service.delivery_days_max}æ—¥</div>
                    <div class="matrix-cell">${service.tracking_available ? 'âœ“' : 'âœ—'}</div>
                    <div class="matrix-cell">${service.insurance_included ? 'âœ“' : 'âœ—'}</div>
                `;
            });
            
            return html;
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateSummaryStats(shippingOptions) {
            if (shippingOptions.length === 0) return;
            
            const totalServices = shippingOptions.length;
            const prices = shippingOptions.map(option => option.total_price_jpy);
            const deliveryTimes = shippingOptions.map(option => option.delivery_days_min);
            
            const cheapestPrice = Math.min(...prices);
            const fastestDelivery = Math.min(...deliveryTimes);
            const avgPrice = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);
            
            document.getElementById('totalServicesCount').textContent = totalServices;
            document.getElementById('cheapestPrice').textContent = 'Â¥' + cheapestPrice.toLocaleString();
            document.getElementById('fastestDelivery').textContent = fastestDelivery + 'æ—¥';
            document.getElementById('avgPrice').textContent = 'Â¥' + avgPrice.toLocaleString();
        }

        // è£œåŠ©é–¢æ•°ç¾¤
        function groupByCarrier(shippingOptions) {
            const grouped = {};
            shippingOptions.forEach(option => {
                if (!grouped[option.carrier_code]) {
                    grouped[option.carrier_code] = [];
                }
                grouped[option.carrier_code].push(option);
            });
            
            // å„æ¥­è€…å†…ã§æ–™é‡‘é †ã«ã‚½ãƒ¼ãƒˆ
            Object.keys(grouped).forEach(carrier => {
                grouped[carrier].sort((a, b) => a.total_price_jpy - b.total_price_jpy);
            });
            
            return grouped;
        }

        function getCarrierDisplayName(carrierCode) {
            const names = {
                'EMOJI': 'Emojié…é€',
                'CPASS': 'CPass',
                'JPPOST': 'æ—¥æœ¬éƒµä¾¿'
            };
            return names[carrierCode] || carrierCode;
        }

        function showServiceDetails(carrierCode, serviceCode) {
            const service = currentShippingData.find(s => 
                s.carrier_code === carrierCode && s.service_code === serviceCode
            );
            
            if (!service) return;
            
            const modal = createServiceDetailModal(service);
            document.body.appendChild(modal);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.querySelector('.modal-content').style.transform = 'scale(1)';
            }, 10);
        }

        function createServiceDetailModal(service) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s;
            `;
            
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    border-radius: var(--radius-lg);
                    padding: var(--space-xl);
                    max-width: 500px;
                    width: 90%;
                    transform: scale(0.9);
                    transition: transform 0.3s;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3>${service.service_name}</h3>
                        <button onclick="this.closest('.modal').remove()" style="
                            background: none;
                            border: none;
                            font-size: 1.5rem;
                            cursor: pointer;
                            color: var(--text-secondary);
                        ">&times;</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div>
                            <strong>åŸºæœ¬æ–™é‡‘</strong><br>
                            Â¥${service.base_price_jpy.toLocaleString()}
                        </div>
                        <div>
                            <strong>ç‡ƒæ–™ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸</strong><br>
                            Â¥${service.fuel_surcharge_jpy.toLocaleString()}
                        </div>
                        <div>
                            <strong>é…é€æ—¥æ•°</strong><br>
                            ${service.delivery_days_min}-${service.delivery_days_max}æ—¥
                        </div>
                        <div>
                            <strong>ã‚µãƒ¼ãƒ“ã‚¹ã‚¿ã‚¤ãƒ—</strong><br>
                            ${service.service_type}
                        </div>
                    </div>
                    
                    <div style="padding: var(--space-md); background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--success-color);">
                            åˆè¨ˆæ–™é‡‘: Â¥${service.total_price_jpy.toLocaleString()}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: var(--space-md);">
                        <div style="flex: 1;">
                            <i class="fas fa-shield-alt"></i>
                            ä¿é™º: ${service.insurance_included ? 'ä»˜å¸¯' : 'ãªã—'}
                        </div>
                        <div style="flex: 1;">
                            <i class="fas fa-search"></i>
                            è¿½è·¡: ${service.tracking_available ? 'å¯èƒ½' : 'ä¸å¯'}
                        </div>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            
            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            return modal;
        }

        function setLoadingState(loading) {
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            const btn = document.querySelector('.calculate-btn');
            
            if (loading) {
                btnText.style.display = 'none';
                btnSpinner.style.display = 'inline-block';
                btn.disabled = true;
            } else {
                btnText.style.display = 'inline';
                btnSpinner.style.display = 'none';
                btn.disabled = false;
            }
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function exportToCSV() {
            if (currentShippingData.length === 0) {
                alert('è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšé€æ–™è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const headers = ['æ¥­è€…', 'ã‚µãƒ¼ãƒ“ã‚¹å', 'ã‚µãƒ¼ãƒ“ã‚¹ã‚¿ã‚¤ãƒ—', 'åŸºæœ¬æ–™é‡‘', 'ç‡ƒæ–™ä»£', 'åˆè¨ˆæ–™é‡‘', 'æœ€çŸ­æ—¥æ•°', 'æœ€é•·æ—¥æ•°', 'è¿½è·¡', 'ä¿é™º'];
            const csvData = [headers];
            
            currentShippingData.forEach(service => {
                csvData.push([
                    service.carrier_code,
                    service.service_name,
                    service.service_type,
                    service.base_price_jpy,
                    service.fuel_surcharge_jpy,
                    service.total_price_jpy,
                    service.delivery_days_min,
                    service.delivery_days_max,
                    service.tracking_available ? 'ã‚ã‚Š' : 'ãªã—',
                    service.insurance_included ? 'ã‚ã‚Š' : 'ãªã—'
                ]);
            });
            
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `shipping_rates_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function saveAsImage() {
            // HTML2Canvas ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ï¼ˆå®Ÿè£…æ™‚ã«è¿½åŠ ï¼‰
            alert('ç”»åƒä¿å­˜æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
        }

        function printMatrix() {
            const printWindow = window.open('', '_blank');
            const matrixContent = document.querySelector('.matrix-container').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>é€æ–™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹å°åˆ·</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .matrix-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1px; border: 1px solid #ccc; }
                        .matrix-cell { padding: 8px; border: 1px solid #eee; text-align: center; font-size: 12px; }
                        .matrix-cell.header { background: #f5f5f5; font-weight: bold; }
                        .matrix-cell.service-name { text-align: left; font-weight: 600; }
                        .matrix-cell.best-price { background: #dcfce7; font-weight: bold; }
                        .price-breakdown { display: none; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <h1>é€æ–™è¨ˆç®—ãƒãƒˆãƒªãƒƒã‚¯ã‚¹</h1>
                    <p>è¨ˆç®—æ—¥æ™‚: ${new Date().toLocaleString()}</p>
                    <p>é‡é‡: ${document.getElementById('weightInput').value}g</p>
                    <p>é…é€å…ˆ: ${document.getElementById('destinationSelect').selectedOptions[0]?.text || ''}</p>
                    ${matrixContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é€æ–™è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ç‰ˆï¼‰åˆæœŸåŒ–å®Œäº†');
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
            document.getElementById('weightInput').value = '500';
            document.getElementById('destinationSelect').value = 'US';
            
            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    calculateShippingMatrix();
                }
            });
            
            // å…¥åŠ›å€¤ã®è‡ªå‹•æ¤œè¨¼
            document.getElementById('weightInput').addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value > 30000) {
                    this.value = 30000;
                } else if (value < 1) {
                    this.value = 1;
                }
            });
        });
    </script>
</body>
</html>