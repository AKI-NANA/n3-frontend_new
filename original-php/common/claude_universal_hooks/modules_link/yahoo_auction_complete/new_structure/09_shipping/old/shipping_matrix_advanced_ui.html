<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>送料計算システム - 実データマトリックス</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb;
            --emoji-color: #ff6b35;
            --cpass-color: #4ecdc4;
            --jppost-color: #e74c3c;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: var(--space-lg);
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--success-color));
            color: white;
            padding: var(--space-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-lg);
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: var(--space-sm);
        }

        .controls-panel {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 200px 150px 200px 150px auto;
            gap: var(--space-md);
            align-items: end;
            margin-bottom: var(--space-md);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: var(--space-xs);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .calculate-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .calculate-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .matrix-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 4px;
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .matrix-tab {
            flex: 1;
            padding: var(--space-md);
            border: none;
            background: transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
        }

        .matrix-tab.active {
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .matrix-tab.emoji.active { background: var(--emoji-color); }
        .matrix-tab.cpass.active { background: var(--cpass-color); }
        .matrix-tab.jppost.active { background: var(--jppost-color); }
        .matrix-tab.comparison.active { 
            background: linear-gradient(135deg, var(--emoji-color), var(--cpass-color), var(--jppost-color));
        }

        .matrix-tab:hover:not(.active) {
            background: var(--bg-tertiary);
        }

        .matrix-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            min-height: 500px;
        }

        .matrix-grid {
            display: grid;
            grid-template-columns: 180px repeat(auto-fit, minmax(120px, 1fr));
            gap: 1px;
            background: var(--border-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .matrix-cell {
            background: white;
            padding: 12px 8px;
            text-align: center;
            position: relative;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .matrix-cell.header {
            background: var(--bg-tertiary);
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--border-color);
        }

        .matrix-cell.service-name {
            background: var(--bg-tertiary);
            text-align: left;
            font-weight: 600;
            padding-left: var(--space-md);
        }

        .matrix-cell.price {
            cursor: pointer;
            position: relative;
        }

        .matrix-cell.price:hover {
            background: #f0f9ff;
            transform: scale(1.02);
            z-index: 5;
            box-shadow: var(--shadow-md);
        }

        .matrix-cell.best-price {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            font-weight: 700;
            color: #166534;
        }

        .matrix-cell.fast-delivery {
            background: linear-gradient(135deg, #dbeafe, #93c5fd);
            color: #1e40af;
        }

        .price-breakdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            box-shadow: var(--shadow-lg);
            z-index: 20;
            min-width: 250px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .matrix-cell.price:hover .price-breakdown {
            opacity: 1;
            pointer-events: auto;
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--space-sm);
        }

        .breakdown-table td {
            padding: 4px 8px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.8rem;
        }

        .breakdown-table .total {
            font-weight: 700;
            border-top: 2px solid var(--border-color);
        }

        .delivery-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .delivery-info p {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            color: var(--text-secondary);
        }

        .comparison-view {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
        }

        .carrier-comparison {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .carrier-comparison.emoji { border-top: 4px solid var(--emoji-color); }
        .carrier-comparison.cpass { border-top: 4px solid var(--cpass-color); }
        .carrier-comparison.jppost { border-top: 4px solid var(--jppost-color); }

        .carrier-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .carrier-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .carrier-icon.emoji { background: var(--emoji-color); }
        .carrier-icon.cpass { background: var(--cpass-color); }
        .carrier-icon.jppost { background: var(--jppost-color); }

        .service-cards {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .service-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            transition: all 0.2s;
            cursor: pointer;
        }

        .service-card:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }

        .service-card.recommended {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            border: 2px solid var(--success-color);
        }

        .service-name {
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .service-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-sm);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .price-display {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--success-color);
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .summary-stats {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-lg);
        }

        .stat-item {
            text-align: center;
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }

        .export-controls {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        .export-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #059669;
        }

        @media (max-width: 1200px) {
            .controls-grid {
                grid-template-columns: 1fr 1fr;
                gap: var(--space-sm);
            }
            
            .matrix-grid {
                font-size: 0.75rem;
            }
            
            .comparison-view {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--space-md);
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .matrix-tabs {
                flex-direction: column;
            }
            
            .matrix-grid {
                grid-template-columns: 120px repeat(2, 1fr);
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <div class="header">
            <h1><i class="fas fa-shipping-fast"></i> 送料計算システム</h1>
            <p>実データベース対応 - Emoji/CPass/日本郵便 マトリックス比較</p>
            <p><strong>重量段階別実料金・手数料込み正確計算</strong></p>
        </div>

        <!-- コントロールパネル -->
        <div class="controls-panel">
            <div class="controls-grid">
                <div class="form-group">
                    <label class="form-label">商品重量</label>
                    <input type="number" id="weightInput" class="form-input" placeholder="500" min="1" max="30000" value="500">
                    <small style="color: var(--text-secondary);">グラム単位（1-30,000g）</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">配送先国</label>
                    <select id="destinationSelect" class="form-select">
                        <option value="">選択してください</option>
                        <option value="US">🇺🇸 アメリカ</option>
                        <option value="SG">🇸🇬 シンガポール</option>
                        <option value="MY">🇲🇾 マレーシア</option>
                        <option value="TH">🇹🇭 タイ</option>
                        <option value="VN">🇻🇳 ベトナム</option>
                        <option value="ID">🇮🇩 インドネシア</option>
                        <option value="PH">🇵🇭 フィリピン</option>
                        <option value="TW">🇹🇼 台湾</option>
                        <option value="HK">🇭🇰 香港</option>
                        <option value="GB">🇬🇧 イギリス</option>
                        <option value="DE">🇩🇪 ドイツ</option>
                        <option value="FR">🇫🇷 フランス</option>
                        <option value="KR">🇰🇷 韓国</option>
                        <option value="CN">🇨🇳 中国</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">サービスタイプ</label>
                    <select id="serviceTypeSelect" class="form-select">
                        <option value="">全て表示</option>
                        <option value="express">エクスプレス</option>
                        <option value="standard">標準配送</option>
                        <option value="economy">エコノミー</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">表示モード</label>
                    <select id="displayModeSelect" class="form-select">
                        <option value="price">料金順</option>
                        <option value="speed">速さ順</option>
                        <option value="carrier">業者別</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <button class="calculate-btn" onclick="calculateShippingMatrix()">
                        <i class="fas fa-calculator"></i>
                        <span id="btnText">計算実行</span>
                        <span id="btnSpinner" class="loading" style="display: none;"></span>
                    </button>
                </div>
            </div>
            
            <div class="export-controls">
                <button class="export-btn" onclick="exportToCSV()">
                    <i class="fas fa-download"></i> CSV出力
                </button>
                <button class="export-btn" onclick="saveAsImage()">
                    <i class="fas fa-image"></i> 画像保存
                </button>
                <button class="export-btn" onclick="printMatrix()">
                    <i class="fas fa-print"></i> 印刷
                </button>
            </div>
        </div>

        <!-- 統計サマリー -->
        <div id="summaryStats" class="summary-stats" style="display: none;">
            <h3 style="margin-bottom: var(--space-md);">計算結果サマリー</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="totalServicesCount">0</div>
                    <div class="stat-label">利用可能サービス</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cheapestPrice">¥0</div>
                    <div class="stat-label">最安料金</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="fastestDelivery">0日</div>
                    <div class="stat-label">最速配送</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgPrice">¥0</div>
                    <div class="stat-label">平均料金</div>
                </div>
            </div>
        </div>

        <!-- マトリックスタブ -->
        <div class="matrix-tabs">
            <button class="matrix-tab comparison active" data-tab="comparison">
                <i class="fas fa-balance-scale"></i>
                全業者比較
            </button>
            <button class="matrix-tab emoji" data-tab="emoji">
                <i class="fas fa-rocket"></i>
                Emoji配送
            </button>
            <button class="matrix-tab cpass" data-tab="cpass">
                <i class="fas fa-plane"></i>
                CPass配送
            </button>
            <button class="matrix-tab jppost" data-tab="jppost">
                <i class="fas fa-mail-bulk"></i>
                日本郵便
            </button>
        </div>

        <!-- マトリックスコンテナ -->
        <div class="matrix-container">
            <!-- 比較ビュー -->
            <div id="comparisonView" class="comparison-view">
                <p style="text-align: center; color: var(--text-secondary); margin-top: var(--space-xl);">
                    重量と配送先を選択して「計算実行」ボタンを押してください
                </p>
            </div>

            <!-- 個別業者マトリックス -->
            <div id="emojiMatrix" class="matrix-grid" style="display: none;"></div>
            <div id="cpassMatrix" class="matrix-grid" style="display: none;"></div>
            <div id="jppostMatrix" class="matrix-grid" style="display: none;"></div>
        </div>
    </div>

    <script>
        // グローバル変数
        let currentTab = 'comparison';
        let lastCalculationData = null;
        let currentShippingData = [];

        // タブ切り替え処理
        document.querySelectorAll('.matrix-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        function switchTab(tabName) {
            // タブの状態更新
            document.querySelectorAll('.matrix-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // ビューの切り替え
            const views = ['comparisonView', 'emojiMatrix', 'cpassMatrix', 'jppostMatrix'];
            views.forEach(viewId => {
                const element = document.getElementById(viewId);
                if (element) {
                    element.style.display = 'none';
                }
            });

            if (tabName === 'comparison') {
                document.getElementById('comparisonView').style.display = 'grid';
            } else {
                document.getElementById(tabName + 'Matrix').style.display = 'grid';
            }

            currentTab = tabName;

            // データがある場合は再表示
            if (currentShippingData.length > 0) {
                displayCalculationResults(currentShippingData);
            }
        }

        // 送料計算メイン関数
        async function calculateShippingMatrix() {
            const weight = parseInt(document.getElementById('weightInput').value);
            const destination = document.getElementById('destinationSelect').value;
            const serviceType = document.getElementById('serviceTypeSelect').value || null;
            const displayMode = document.getElementById('displayModeSelect').value;

            if (!weight || !destination) {
                alert('重量と配送先を選択してください');
                return;
            }

            if (weight < 1 || weight > 30000) {
                alert('重量は1g〜30,000gの範囲で入力してください');
                return;
            }

            // ローディング状態
            setLoadingState(true);

            try {
                // APIエンドポイントに送料計算リクエスト
                const response = await fetch('api/shipping_calculator_realdata.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'calculate_shipping_matrix',
                        weight_g: weight,
                        destination_country: destination,
                        service_type: serviceType,
                        display_mode: displayMode
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success) {
                    currentShippingData = data.shipping_options;
                    displayCalculationResults(data.shipping_options);
                    updateSummaryStats(data.shipping_options);
                    
                    // 統計表示
                    document.getElementById('summaryStats').style.display = 'block';
                } else {
                    throw new Error(data.error || '計算に失敗しました');
                }

            } catch (error) {
                console.error('送料計算エラー:', error);
                alert('送料計算中にエラーが発生しました: ' + error.message);
            } finally {
                setLoadingState(false);
            }
        }

        // 計算結果表示
        function displayCalculationResults(shippingOptions) {
            if (currentTab === 'comparison') {
                displayComparisonView(shippingOptions);
            } else {
                displayCarrierMatrix(shippingOptions, currentTab);
            }
        }

        // 比較ビュー表示
        function displayComparisonView(shippingOptions) {
            const comparisonView = document.getElementById('comparisonView');
            
            // 業者別にグループ化
            const carrierGroups = groupByCarrier(shippingOptions);
            
            let html = '';
            
            Object.keys(carrierGroups).forEach(carrierCode => {
                const services = carrierGroups[carrierCode];
                const carrierName = getCarrierDisplayName(carrierCode);
                const carrierClass = carrierCode.toLowerCase();
                
                html += `
                    <div class="carrier-comparison ${carrierClass}">
                        <div class="carrier-header">
                            <div class="carrier-icon ${carrierClass}">${carrierCode.charAt(0)}</div>
                            ${carrierName}
                        </div>
                        <div class="service-cards">
                `;
                
                services.forEach((service, index) => {
                    const isRecommended = index === 0; // 最初の項目を推奨とする
                    
                    html += `
                        <div class="service-card ${isRecommended ? 'recommended' : ''}" 
                             onclick="showServiceDetails('${service.carrier_code}', '${service.service_code}')">
                            <div class="service-name">${service.service_name}</div>
                            <div class="price-display">¥${service.total_price_jpy.toLocaleString()}</div>
                            <div class="service-details">
                                <div><i class="fas fa-clock"></i> ${service.delivery_days_min}-${service.delivery_days_max}日</div>
                                <div><i class="fas fa-box"></i> ${service.service_type}</div>
                                <div><i class="fas fa-shield-alt"></i> ${service.insurance_included ? '保険付' : '保険なし'}</div>
                                <div><i class="fas fa-search"></i> ${service.tracking_available ? '追跡可' : '追跡不可'}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            comparisonView.innerHTML = html;
        }

        // 業者別マトリックス表示
        function displayCarrierMatrix(shippingOptions, carrierCode) {
            const matrixElement = document.getElementById(carrierCode + 'Matrix');
            
            // 指定業者のサービスのみフィルター
            const carrierServices = shippingOptions.filter(option => 
                option.carrier_code.toLowerCase() === carrierCode.toLowerCase() ||
                (carrierCode === 'jppost' && option.carrier_code === 'JPPOST')
            );
            
            if (carrierServices.length === 0) {
                matrixElement.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: var(--space-xl); color: var(--text-secondary);">
                        選択した条件に該当するサービスがありません
                    </div>
                `;
                return;
            }
            
            // マトリックス形式でHTML生成
            let matrixHTML = generateMatrixHTML(carrierServices);
            matrixElement.innerHTML = matrixHTML;
        }

        // マトリックスHTML生成
        function generateMatrixHTML(services) {
            const headers = ['サービス', '料金', '燃料代', '合計', '配送日数', '追跡', '保険'];
            
            let html = '';
            
            // ヘッダー行
            headers.forEach(header => {
                html += `<div class="matrix-cell header">${header}</div>`;
            });
            
            // データ行
            services.forEach((service, index) => {
                html += `
                    <div class="matrix-cell service-name">${service.service_name}</div>
                    <div class="matrix-cell price ${index === 0 ? 'best-price' : ''}" 
                         onclick="showPriceBreakdown(this, ${JSON.stringify(service).replace(/"/g, '&quot;')})">
                        ¥${service.base_price_jpy.toLocaleString()}
                        <div class="price-breakdown">
                            <h4>${service.service_name}</h4>
                            <table class="breakdown-table">
                                <tr><td>基本料金:</td><td>¥${service.base_price_jpy.toLocaleString()}</td></tr>
                                <tr><td>燃料サーチャージ:</td><td>¥${service.fuel_surcharge_jpy.toLocaleString()}</td></tr>
                                <tr><td>手数料:</td><td>¥${(service.total_price_jpy - service.base_price_jpy - service.fuel_surcharge_jpy).toLocaleString()}</td></tr>
                                <tr class="total"><td><strong>合計:</strong></td><td><strong>¥${service.total_price_jpy.toLocaleString()}</strong></td></tr>
                            </table>
                            <div class="delivery-info">
                                <p><i class="fas fa-clock"></i> 配送日数: ${service.delivery_days_min}-${service.delivery_days_max}日</p>
                                <p><i class="fas fa-shield-alt"></i> 保険: ${service.insurance_included ? '付帯' : 'なし'}</p>
                                <p><i class="fas fa-search"></i> 追跡: ${service.tracking_available ? '可能' : '不可'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="matrix-cell">¥${service.fuel_surcharge_jpy.toLocaleString()}</div>
                    <div class="matrix-cell price ${index === 0 ? 'best-price' : ''}">¥${service.total_price_jpy.toLocaleString()}</div>
                    <div class="matrix-cell ${service.delivery_days_max <= 5 ? 'fast-delivery' : ''}">${service.delivery_days_min}-${service.delivery_days_max}日</div>
                    <div class="matrix-cell">${service.tracking_available ? '✓' : '✗'}</div>
                    <div class="matrix-cell">${service.insurance_included ? '✓' : '✗'}</div>
                `;
            });
            
            return html;
        }

        // 統計情報更新
        function updateSummaryStats(shippingOptions) {
            if (shippingOptions.length === 0) return;
            
            const totalServices = shippingOptions.length;
            const prices = shippingOptions.map(option => option.total_price_jpy);
            const deliveryTimes = shippingOptions.map(option => option.delivery_days_min);
            
            const cheapestPrice = Math.min(...prices);
            const fastestDelivery = Math.min(...deliveryTimes);
            const avgPrice = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);
            
            document.getElementById('totalServicesCount').textContent = totalServices;
            document.getElementById('cheapestPrice').textContent = '¥' + cheapestPrice.toLocaleString();
            document.getElementById('fastestDelivery').textContent = fastestDelivery + '日';
            document.getElementById('avgPrice').textContent = '¥' + avgPrice.toLocaleString();
        }

        // 補助関数群
        function groupByCarrier(shippingOptions) {
            const grouped = {};
            shippingOptions.forEach(option => {
                if (!grouped[option.carrier_code]) {
                    grouped[option.carrier_code] = [];
                }
                grouped[option.carrier_code].push(option);
            });
            
            // 各業者内で料金順にソート
            Object.keys(grouped).forEach(carrier => {
                grouped[carrier].sort((a, b) => a.total_price_jpy - b.total_price_jpy);
            });
            
            return grouped;
        }

        function getCarrierDisplayName(carrierCode) {
            const names = {
                'EMOJI': 'Emoji配送',
                'CPASS': 'CPass',
                'JPPOST': '日本郵便'
            };
            return names[carrierCode] || carrierCode;
        }

        function showServiceDetails(carrierCode, serviceCode) {
            const service = currentShippingData.find(s => 
                s.carrier_code === carrierCode && s.service_code === serviceCode
            );
            
            if (!service) return;
            
            const modal = createServiceDetailModal(service);
            document.body.appendChild(modal);
            
            // モーダル表示
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.querySelector('.modal-content').style.transform = 'scale(1)';
            }, 10);
        }

        function createServiceDetailModal(service) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s;
            `;
            
            modal.innerHTML = `
                <div class="modal-content" style="
                    background: white;
                    border-radius: var(--radius-lg);
                    padding: var(--space-xl);
                    max-width: 500px;
                    width: 90%;
                    transform: scale(0.9);
                    transition: transform 0.3s;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3>${service.service_name}</h3>
                        <button onclick="this.closest('.modal').remove()" style="
                            background: none;
                            border: none;
                            font-size: 1.5rem;
                            cursor: pointer;
                            color: var(--text-secondary);
                        ">&times;</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div>
                            <strong>基本料金</strong><br>
                            ¥${service.base_price_jpy.toLocaleString()}
                        </div>
                        <div>
                            <strong>燃料サーチャージ</strong><br>
                            ¥${service.fuel_surcharge_jpy.toLocaleString()}
                        </div>
                        <div>
                            <strong>配送日数</strong><br>
                            ${service.delivery_days_min}-${service.delivery_days_max}日
                        </div>
                        <div>
                            <strong>サービスタイプ</strong><br>
                            ${service.service_type}
                        </div>
                    </div>
                    
                    <div style="padding: var(--space-md); background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--success-color);">
                            合計料金: ¥${service.total_price_jpy.toLocaleString()}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: var(--space-md);">
                        <div style="flex: 1;">
                            <i class="fas fa-shield-alt"></i>
                            保険: ${service.insurance_included ? '付帯' : 'なし'}
                        </div>
                        <div style="flex: 1;">
                            <i class="fas fa-search"></i>
                            追跡: ${service.tracking_available ? '可能' : '不可'}
                        </div>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            
            // 背景クリックで閉じる
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            return modal;
        }

        function setLoadingState(loading) {
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            const btn = document.querySelector('.calculate-btn');
            
            if (loading) {
                btnText.style.display = 'none';
                btnSpinner.style.display = 'inline-block';
                btn.disabled = true;
            } else {
                btnText.style.display = 'inline';
                btnSpinner.style.display = 'none';
                btn.disabled = false;
            }
        }

        // エクスポート機能
        function exportToCSV() {
            if (currentShippingData.length === 0) {
                alert('計算結果がありません。まず送料計算を実行してください。');
                return;
            }
            
            const headers = ['業者', 'サービス名', 'サービスタイプ', '基本料金', '燃料代', '合計料金', '最短日数', '最長日数', '追跡', '保険'];
            const csvData = [headers];
            
            currentShippingData.forEach(service => {
                csvData.push([
                    service.carrier_code,
                    service.service_name,
                    service.service_type,
                    service.base_price_jpy,
                    service.fuel_surcharge_jpy,
                    service.total_price_jpy,
                    service.delivery_days_min,
                    service.delivery_days_max,
                    service.tracking_available ? 'あり' : 'なし',
                    service.insurance_included ? 'あり' : 'なし'
                ]);
            });
            
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `shipping_rates_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function saveAsImage() {
            // HTML2Canvas ライブラリが必要（実装時に追加）
            alert('画像保存機能は開発中です。CSVエクスポートをご利用ください。');
        }

        function printMatrix() {
            const printWindow = window.open('', '_blank');
            const matrixContent = document.querySelector('.matrix-container').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>送料マトリックス印刷</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .matrix-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1px; border: 1px solid #ccc; }
                        .matrix-cell { padding: 8px; border: 1px solid #eee; text-align: center; font-size: 12px; }
                        .matrix-cell.header { background: #f5f5f5; font-weight: bold; }
                        .matrix-cell.service-name { text-align: left; font-weight: 600; }
                        .matrix-cell.best-price { background: #dcfce7; font-weight: bold; }
                        .price-breakdown { display: none; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <h1>送料計算マトリックス</h1>
                    <p>計算日時: ${new Date().toLocaleString()}</p>
                    <p>重量: ${document.getElementById('weightInput').value}g</p>
                    <p>配送先: ${document.getElementById('destinationSelect').selectedOptions[0]?.text || ''}</p>
                    ${matrixContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('送料計算システム（実データ版）初期化完了');
            
            // デフォルト値設定
            document.getElementById('weightInput').value = '500';
            document.getElementById('destinationSelect').value = 'US';
            
            // キーボードショートカット
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    calculateShippingMatrix();
                }
            });
            
            // 入力値の自動検証
            document.getElementById('weightInput').addEventListener('input', function() {
                const value = parseInt(this.value);
                if (value > 30000) {
                    this.value = 30000;
                } else if (value < 1) {
                    this.value = 1;
                }
            });
        });
    </script>
</body>
</html>