<?php
/**
 * Yahoo Auction Tool - ç·Šæ€¥ä¿®å¾©ç‰ˆ
 * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆãƒ»å•†å“æ‰¿èªã‚·ã‚¹ãƒ†ãƒ ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç®¡ç†ãƒ»åœ¨åº«ç®¡ç† çµ±åˆç‰ˆ
 * ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ä¿®å¾©å¯¾å¿œ
 * ä½œæˆæ—¥: 2025-09-12
 */

// ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆè¨­å®š
error_reporting(E_ALL);
ini_set('display_errors', 1);

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªãƒãƒ³ãƒ‰ãƒ©ãƒ¼èª­ã¿è¾¼ã¿
require_once __DIR__ . '/database_query_handler.php';

// ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

// CSRFå¯¾ç­–
if (!isset($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å‡¦ç†
$action = $_POST['action'] ?? $_GET['action'] ?? '';
$response = null;

// JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šé–¢æ•°
function sendJsonResponse($data) {
    header('Content-Type: application/json');
    echo json_encode($data);
    exit;
}

switch ($action) {
    // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å‡¦ç†ï¼ˆAPIã‚µãƒ¼ãƒãƒ¼é€£æºï¼‰
    case 'scrape':
        $url = $_POST['url'] ?? '';
        if ($url) {
            $result = executeScrapingWithAPI($url);
            sendJsonResponse($result);
        } else {
            $response = generateApiResponse('scrape', [], false, 'URLãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            sendJsonResponse($response);
        }
        break;
        
    // ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šç¢ºèª
    case 'test_connection':
        $connection = checkScrapingServerConnection();
        sendJsonResponse($connection);
        break;
        
    // æ‰¿èªå¾…ã¡å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—
    case 'get_approval_queue':
        $filters = $_GET['filters'] ?? [];
        $data = getApprovalQueueData($filters);
        $response = generateApiResponse('get_approval_queue', $data, true);
        sendJsonResponse($response);
        break;
        
    // å•†å“æ¤œç´¢
    case 'search_products':
        $query = $_GET['query'] ?? '';
        $filters = $_GET['filters'] ?? [];
        $data = searchProducts($query, $filters);
        $response = generateApiResponse('search_products', $data, true);
        sendJsonResponse($response);
        break;
        
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆå–å¾—
    case 'get_dashboard_stats':
        $data = getDashboardStats();
        $response = generateApiResponse('get_dashboard_stats', $data, true);
        sendJsonResponse($response);
        break;
        
    // ç¦æ­¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç®¡ç†
    case 'get_prohibited_keywords':
        $data = getProhibitedKeywords();
        $response = generateApiResponse('get_prohibited_keywords', $data, true);
        sendJsonResponse($response);
        break;
        
    case 'check_title':
        $title = $_POST['title'] ?? '';
        if (empty($title)) {
            $response = generateApiResponse('check_title', [], false, 'ã‚¿ã‚¤ãƒˆãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        } else {
            $result = checkTitleForProhibitedKeywords($title);
            $response = generateApiResponse('check_title', $result, true);
        }
        sendJsonResponse($response);
        break;
        
    // === Phase 1 æ–°æ©Ÿèƒ½: CSVå‡ºåŠ›ãƒ»å…¥åŠ›ãƒ»é€æ–™è¨ˆç®— ===
    
    // CSVå‡ºåŠ›
    case 'export_csv':
        $filters = $_POST['filters'] ?? [];
        $type = $_POST['type'] ?? 'all';
        if (is_string($filters)) {
            $filters = json_decode($filters, true) ?? [];
        }
        $result = handleCSVExport($filters, $type);
        sendJsonResponse($result);
        break;
        
    // CSVå…¥åŠ›
    case 'import_csv':
        if (!isset($_FILES['csvFile']) || $_FILES['csvFile']['error'] !== UPLOAD_ERR_OK) {
            $response = generateApiResponse('import_csv', [], false, 'CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            sendJsonResponse($response);
            break;
        }
        
        $uploadedFile = $_FILES['csvFile']['tmp_name'];
        $options = $_POST['options'] ?? [];
        if (is_string($options)) {
            $options = json_decode($options, true) ?? [];
        }
        $result = handleCSVImport($uploadedFile, $options);
        sendJsonResponse($result);
        break;
        
    // é€æ–™ãƒ»åˆ©ç›Šè¨ˆç®—
    case 'calculate_profit':
        $product_id = $_POST['product_id'] ?? '';
        $options = $_POST['options'] ?? [];
        if (is_string($options)) {
            $options = json_decode($options, true) ?? [];
        }
        
        if (empty($product_id)) {
            $response = generateApiResponse('calculate_profit', [], false, 'å•†å“IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        } else {
            $result = handleProfitCalculation($product_id, $options);
            $response = generateApiResponse('calculate_profit', $result, $result['success'] ?? false);
        }
        sendJsonResponse($response);
        break;
        
    // é€æ–™å€™è£œè¨ˆç®—
    case 'calculate_shipping':
        $weight = $_POST['weight'] ?? 0;
        $dimensions = $_POST['dimensions'] ?? '20,15,10';
        $country = $_POST['country'] ?? 'US';
        
        if (empty($weight) || $weight <= 0) {
            $response = generateApiResponse('calculate_shipping', [], false, 'é‡é‡ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        } else {
            $result = handleShippingCalculation($weight, $dimensions, $country);
            $response = generateApiResponse('calculate_shipping', $result, $result['success'] ?? false);
        }
        sendJsonResponse($response);
        break;
        
    default:
        // é€šå¸¸ã®ãƒšãƒ¼ã‚¸è¡¨ç¤º
        break;
}

// ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆå–å¾—
$dashboard_stats = getDashboardStats();

?>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Yahooâ†’eBayçµ±åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä¿®å¾©ç‰ˆï¼‰</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1e40af;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #0ea5e9;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-lg);
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: var(--space-xl);
        }

        .dashboard-header h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: var(--space-sm);
        }

        .dashboard-header p {
            color: var(--text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-input {
            padding: var(--space-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);
        }

        .btn-success { background: var(--success-color); }
        .btn-warning { background: var(--warning-color); }
        .btn-danger { background: var(--danger-color); }
        .btn-info { background: var(--info-color); }

        .notification {
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin: var(--space-md) 0;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .notification.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .notification.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }

        .notification.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }

        .notification.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .system-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
            margin-top: var(--space-lg);
        }

        .status-item {
            background: var(--bg-tertiary);
            padding: var(--space-md);
            border-radius: var(--radius-md);
        }

        .status-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
        }

        .status-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .log-section {
            background: var(--bg-tertiary);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin-top: var(--space-lg);
        }

        .log-entry {
            font-family: monospace;
            font-size: 0.75rem;
            padding: var(--space-xs);
            border-bottom: 1px solid var(--border-color);
        }

        .log-timestamp {
            color: var(--text-muted);
        }

        .log-level {
            font-weight: 600;
            padding: 0 var(--space-xs);
        }

        .log-level.info { color: var(--info-color); }
        .log-level.success { color: var(--success-color); }
        .log-level.warning { color: var(--warning-color); }
        .log-level.error { color: var(--danger-color); }
    </style>
</head>

<body>
    <div class="container">
        <div class="dashboard-header">
            <h1><i class="fas fa-sync-alt"></i> Yahooâ†’eBayçµ±åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆä¿®å¾©ç‰ˆï¼‰</h1>
            <p>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ç·Šæ€¥ä¿®å¾©ç‰ˆ - APIã‚µãƒ¼ãƒãƒ¼é€£æºå¯¾å¿œ</p>
        </div>

        <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalRecords"><?= number_format($dashboard_stats['total_records'] ?? 0) ?></div>
                <div class="stat-label">ç·ãƒ‡ãƒ¼ã‚¿æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="scrapedCount"><?= number_format($dashboard_stats['scraped_count'] ?? 0) ?></div>
                <div class="stat-label">ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æ¸ˆã¿</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="calculatedCount"><?= number_format($dashboard_stats['calculated_count'] ?? 0) ?></div>
                <div class="stat-label">è¨ˆç®—æ¸ˆã¿</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="readyCount"><?= number_format($dashboard_stats['ready_count'] ?? 0) ?></div>
                <div class="stat-label">å‡ºå“æº–å‚™å®Œäº†</div>
            </div>
        </div>

        <!-- APIã‚µãƒ¼ãƒãƒ¼æ¥ç¶šç¢ºèª -->
        <div class="section">
            <div class="section-header">
                <i class="fas fa-server"></i>
                <h3 class="section-title">APIã‚µãƒ¼ãƒãƒ¼æ¥ç¶šçŠ¶æ…‹</h3>
            </div>
            <div id="serverStatus" class="notification info">
                <i class="fas fa-spinner fa-spin"></i>
                <span>APIã‚µãƒ¼ãƒãƒ¼æ¥ç¶šç¢ºèªä¸­...</span>
            </div>
        </div>

        <!-- ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ -->
        <div class="section">
            <div class="section-header">
                <i class="fas fa-download"></i>
                <h3 class="section-title">Yahoo ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—</h3>
            </div>

            <form onsubmit="testScraping(event)">
                <div class="form-group">
                    <label class="form-label">Yahoo ã‚ªãƒ¼ã‚¯ã‚·ãƒ§ãƒ³ URL</label>
                    <input type="url" id="scrapingUrl" class="form-input" 
                           placeholder="https://auctions.yahoo.co.jp/jp/auction/xxxxx"
                           value="https://auctions.yahoo.co.jp/jp/auction/b1198242011">
                </div>

                <div style="display: flex; gap: var(--space-sm);">
                    <button type="submit" class="btn">
                        <i class="fas fa-play"></i> ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
                    </button>
                    <button type="button" class="btn btn-info" onclick="testConnection()">
                        <i class="fas fa-link"></i> æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    </button>
                </div>
            </form>

            <div id="scrapingResult" style="margin-top: var(--space-md);"></div>
        </div>
        
        <!-- CSVå‡ºåŠ›ãƒ»å…¥åŠ›æ©Ÿèƒ½ï¼ˆPhase 1æ–°æ©Ÿèƒ½ï¼‰ -->
        <div class="section">
            <div class="section-header">
                <i class="fas fa-file-csv"></i>
                <h3 class="section-title">CSVå‡ºåŠ›ãƒ»å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ </h3>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
                <!-- CSVå‡ºåŠ› -->
                <div>
                    <h4 style="margin-bottom: var(--space-sm);">ğŸ“¥ eBayå‡ºå“ç”¨CSVå‡ºåŠ›</h4>
                    <div class="form-group">
                        <label class="form-label">å‡ºåŠ›ã‚¿ã‚¤ãƒ—</label>
                        <select id="csvExportType" class="form-input">
                            <option value="all">å…¨ãƒ‡ãƒ¼ã‚¿</option>
                            <option value="yahoo_only">Yahooé™å®š</option>
                            <option value="high_value">é«˜ä¾¡æ ¼å•†å“ï¼ˆ50USDä»¥ä¸Šï¼‰</option>
                            <option value="category_specific">ã‚«ãƒ†ã‚´ãƒªæŒ‡å®š</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="categoryFilter" style="display: none;">
                        <label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
                        <input type="text" id="csvFilterCategory" class="form-input" placeholder="ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ‹ã‚¯ã‚¹">
                    </div>
                    
                    <button class="btn btn-success" onclick="exportToCSV()">
                        <i class="fas fa-download"></i> CSVå‡ºåŠ›
                    </button>
                    
                    <div id="csvExportResult" style="margin-top: var(--space-sm);"></div>
                </div>
                
                <!-- CSVå…¥åŠ› -->
                <div>
                    <h4 style="margin-bottom: var(--space-sm);">ğŸ“¤ ç·¨é›†æ¸ˆã¿CSVå–ã‚Šè¾¼ã¿</h4>
                    <form id="csvImportForm" onsubmit="importFromCSV(event)">
                        <div class="form-group">
                            <label class="form-label">CSVãƒ•ã‚¡ã‚¤ãƒ«</label>
                            <input type="file" id="csvImportFile" class="form-input" accept=".csv" required>
                        </div>
                        
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-upload"></i> CSVå–ã‚Šè¾¼ã¿
                        </button>
                    </form>
                    
                    <div id="csvImportResult" style="margin-top: var(--space-sm);"></div>
                </div>
            </div>
        </div>
        
        <!-- é€æ–™ãƒ»åˆ©ç›Šè¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ï¼ˆPhase 1æ–°æ©Ÿèƒ½ï¼‰ -->
        <div class="section">
            <div class="section-header">
                <i class="fas fa-calculator"></i>
                <h3 class="section-title">é€æ–™ãƒ»åˆ©ç›Šè¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ </h3>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
                <!-- è¨ˆç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ -->
                <div>
                    <h4 style="margin-bottom: var(--space-sm);">ğŸ“Š è¨ˆç®—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h4>
                    
                    <div class="form-group">
                        <label class="form-label">å•†å“IDï¼ˆè¨ˆç®—å¯¾è±¡ï¼‰</label>
                        <input type="text" id="calcProductId" class="form-input" placeholder="ä¾‹: b1198242011">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è²©å£²ä¾¡æ ¼ï¼ˆUSDï¼‰</label>
                        <input type="number" id="calcSellingPrice" class="form-input" placeholder="29.99" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é‡é‡ï¼ˆkgï¼‰</label>
                        <input type="number" id="calcWeight" class="form-input" placeholder="0.5" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ã‚µã‚¤ã‚ºï¼ˆé•·ã•,å¹…,é«˜ã• cmï¼‰</label>
                        <input type="text" id="calcDimensions" class="form-input" placeholder="20,15,10">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é…é€å…ˆå›½</label>
                        <select id="calcCountry" class="form-input">
                            <option value="US">ã‚¢ãƒ¡ãƒªã‚«</option>
                            <option value="CA">ã‚«ãƒŠãƒ€</option>
                            <option value="AU">ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢</option>
                            <option value="GB">ã‚¤ã‚®ãƒªã‚¹</option>
                            <option value="DE">ãƒ‰ã‚¤ãƒ„</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" onclick="calculateProfit()">
                        <i class="fas fa-chart-line"></i> åˆ©ç›Šè¨ˆç®—å®Ÿè¡Œ
                    </button>
                </div>
                
                <!-- è¨ˆç®—çµæœ -->
                <div>
                    <h4 style="margin-bottom: var(--space-sm);">ğŸ’° è¨ˆç®—çµæœ</h4>
                    <div id="profitCalculationResult">
                        <div class="notification info">
                            <i class="fas fa-info-circle"></i>
                            <span>å·¦å´ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ã€Œåˆ©ç›Šè¨ˆç®—å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤º -->
        <div class="system-status">
            <div class="status-item">
                <div class="status-label">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š</div>
                <div class="status-value" id="dbStatus">ç¢ºèªä¸­...</div>
            </div>
            <div class="status-item">
                <div class="status-label">APIã‚µãƒ¼ãƒãƒ¼</div>
                <div class="status-value" id="apiStatus">ç¢ºèªä¸­...</div>
            </div>
            <div class="status-item">
                <div class="status-label">æœ€çµ‚æ›´æ–°</div>
                <div class="status-value" id="lastUpdate"><?= date('Y-m-d H:i:s') ?></div>
            </div>
        </div>

        <!-- ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="log-section">
            <h4 style="color: var(--info-color); margin-bottom: var(--space-sm);">
                <i class="fas fa-history"></i> ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°
            </h4>
            <div id="logSection">
                <div class="log-entry">
                    <span class="log-timestamp">[<?= date('H:i:s') ?>]</span>
                    <span class="log-level info">INFO</span>
                    <span>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä¿®å¾©ç‰ˆã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
        const API_BASE_URL = window.location.pathname;
        const CSRF_TOKEN = '<?= htmlspecialchars($_SESSION['csrf_token']); ?>';

        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Yahoo Auction Tool ä¿®å¾©ç‰ˆ åˆæœŸåŒ–é–‹å§‹');
            
            // APIã‚µãƒ¼ãƒãƒ¼æ¥ç¶šç¢ºèª
            testConnection();
            
            addLogEntry('info', 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        });

        // APIã‚µãƒ¼ãƒãƒ¼æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testConnection() {
            const statusDiv = document.getElementById('serverStatus');
            const apiStatusDiv = document.getElementById('apiStatus');
            
            try {
                statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>æ¥ç¶šç¢ºèªä¸­...</span>';
                
                const response = await fetch('http://localhost:5002/health', {
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    statusDiv.className = 'notification success';
                    statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> <span>APIã‚µãƒ¼ãƒãƒ¼æ¥ç¶šæˆåŠŸ (ãƒãƒ¼ãƒˆ: ${data.port}, DB: ${data.database})</span>`;
                    apiStatusDiv.textContent = 'æ¥ç¶šæ¸ˆã¿';
                    addLogEntry('success', `APIã‚µãƒ¼ãƒãƒ¼æ¥ç¶šæˆåŠŸ: ${data.status}, ã‚»ãƒƒã‚·ãƒ§ãƒ³: ${data.session_id}`);
                } else {
                    statusDiv.className = 'notification error';
                    statusDiv.innerHTML = `<i class="fas fa-times-circle"></i> <span>APIã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå¤±æ•—: HTTPã‚¨ãƒ©ãƒ¼ ${response.status}</span>`;
                    apiStatusDiv.textContent = 'æ¥ç¶šå¤±æ•—';
                    addLogEntry('error', `APIã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå¤±æ•—: HTTP ${response.status}`);
                }
            } catch (error) {
                statusDiv.className = 'notification error';
                statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span>æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}</span>`;
                apiStatusDiv.textContent = 'ã‚¨ãƒ©ãƒ¼';
                addLogEntry('error', `æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
        async function testScraping(event) {
            event.preventDefault();
            
            const url = document.getElementById('scrapingUrl').value;
            const resultDiv = document.getElementById('scrapingResult');
            
            if (!url) {
                showNotification('error', 'URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            try {
                resultDiv.innerHTML = '<div class="notification info"><i class="fas fa-spinner fa-spin"></i> <span>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œä¸­...</span></div>';
                addLogEntry('info', `ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹: ${url}`);
                
                const postData = {
                    urls: [url],
                    options: {
                        save_to_db: true,
                        extract_images: true,
                        convert_currency: true
                    }
                };
                
                const response = await fetch('http://localhost:5002/api/scrape_yahoo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(postData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="notification success">
                            <i class="fas fa-check-circle"></i>
                            <div>
                                <strong>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æˆåŠŸ!</strong><br>
                                ${data.message}<br>
                                å–å¾—ãƒ‡ãƒ¼ã‚¿æ•°: ${data.data?.success_count || 1}ä»¶<br>
                                <small>ãƒ‡ãƒ¼ã‚¿ã¯APIã‚µãƒ¼ãƒãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ</small>
                            </div>
                        </div>
                    `;
                    addLogEntry('success', `ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æˆåŠŸ: ${data.data?.success_count || 1}ä»¶å–å¾—`);
                } else {
                    resultDiv.innerHTML = `
                        <div class="notification error">
                            <i class="fas fa-times-circle"></i>
                            <div>
                                <strong>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¤±æ•—</strong><br>
                                ${data.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}
                            </div>
                        </div>
                    `;
                    addLogEntry('error', `ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¤±æ•—: ${data.error}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="notification error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼</strong><br>
                            ${error.message}
                        </div>
                    </div>
                `;
                addLogEntry('error', `ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // é€šçŸ¥è¡¨ç¤º
        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<i class="fas fa-info-circle"></i> <span>${message}</span>`;
            
            document.querySelector('.container').insertBefore(notification, document.querySelector('.stats-grid'));
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªè¿½åŠ 
        function addLogEntry(level, message) {
            const logSection = document.getElementById('logSection');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-level ${level}">${level.toUpperCase()}</span>
                <span>${message}</span>
            `;
            
            logSection.insertBefore(logEntry, logSection.firstChild);
            
            // ãƒ­ã‚°ãŒå¤šããªã‚Šã™ããªã„ã‚ˆã†åˆ¶é™
            const entries = logSection.querySelectorAll('.log-entry');
            if (entries.length > 20) {
                entries[entries.length - 1].remove();
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèª
        const dbStatusDiv = document.getElementById('dbStatus');
        dbStatusDiv.textContent = '<?= $dashboard_stats ? "æ¥ç¶šæ¸ˆã¿" : "æ¥ç¶šå¤±æ•—" ?>';
        
        // *** Phase 1æ–°æ©Ÿèƒ½: CSVãƒ»è¨ˆç®—æ©Ÿèƒ½ ***
        
        // CSVå‡ºåŠ›ã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®å‡¦ç†
        const csvExportType = document.getElementById('csvExportType');
        if (csvExportType) {
            csvExportType.addEventListener('change', function() {
                const categoryFilter = document.getElementById('categoryFilter');
                if (this.value === 'category_specific') {
                    categoryFilter.style.display = 'block';
                } else {
                    categoryFilter.style.display = 'none';
                }
            });
        }
    });
        
    // CSVå‡ºåŠ›å®Ÿè¡Œ
    async function exportToCSV() {
        const type = document.getElementById('csvExportType').value;
        const category = document.getElementById('csvFilterCategory').value;
        const resultDiv = document.getElementById('csvExportResult');
        
        const filters = type === 'category_specific' ? { category: category } : {};
        
        try {
            resultDiv.innerHTML = '<div class="notification info"><i class="fas fa-spinner fa-spin"></i> CSVå‡ºåŠ›ä¸­...</div>';
            
            const formData = new FormData();
            formData.append('action', 'export_csv');
            formData.append('type', type);
            formData.append('filters', JSON.stringify(filters));
            
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                resultDiv.innerHTML = `
                    <div class="notification success">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>CSVå‡ºåŠ›å®Œäº†!</strong><br>
                            ${result.message}<br>
                            å‡ºåŠ›ä»¶æ•°: ${result.count}ä»¶<br>
                            <a href="${result.download_url}" target="_blank" class="btn btn-sm btn-secondary">
                                <i class="fas fa-download"></i> ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </a>
                        </div>
                    </div>
                `;
                addLogEntry('success', `CSVå‡ºåŠ›å®Œäº†: ${result.count}ä»¶`);
            } else {
                resultDiv.innerHTML = `
                    <div class="notification error">
                        <i class="fas fa-times-circle"></i>
                        <div><strong>CSVå‡ºåŠ›å¤±æ•—</strong><br>${result.message}</div>
                    </div>
                `;
                addLogEntry('error', `CSVå‡ºåŠ›å¤±æ•—: ${result.message}`);
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="notification error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div><strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼</strong><br>${error.message}</div>
                </div>
            `;
            addLogEntry('error', `CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }
    
    // CSVå…¥åŠ›å®Ÿè¡Œ
    async function importFromCSV(event) {
        event.preventDefault();
        
        const fileInput = document.getElementById('csvImportFile');
        const file = fileInput.files[0];
        const resultDiv = document.getElementById('csvImportResult');
        
        if (!file) {
            resultDiv.innerHTML = '<div class="notification error"><i class="fas fa-times-circle"></i> CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
            return;
        }
        
        try {
            resultDiv.innerHTML = '<div class="notification info"><i class="fas fa-spinner fa-spin"></i> CSVå–ã‚Šè¾¼ã¿ä¸­...</div>';
            
            const formData = new FormData();
            formData.append('action', 'import_csv');
            formData.append('csvFile', file);
            formData.append('options', JSON.stringify({}));
            
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                resultDiv.innerHTML = `
                    <div class="notification success">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>CSVå–ã‚Šè¾¼ã¿å®Œäº†!</strong><br>
                            ${result.message}<br>
                            å‡¦ç†ä»¶æ•°: ${result.processed}ä»¶<br>
                            ${result.error_count > 0 ? `ã‚¨ãƒ©ãƒ¼: ${result.error_count}ä»¶` : ''}
                        </div>
                    </div>
                `;
                addLogEntry('success', `CSVå–ã‚Šè¾¼ã¿å®Œäº†: ${result.processed}ä»¶`);
            } else {
                resultDiv.innerHTML = `
                    <div class="notification error">
                        <i class="fas fa-times-circle"></i>
                        <div><strong>CSVå–ã‚Šè¾¼ã¿å¤±æ•—</strong><br>${result.message}</div>
                    </div>
                `;
                addLogEntry('error', `CSVå–ã‚Šè¾¼ã¿å¤±æ•—: ${result.message}`);
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="notification error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div><strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼</strong><br>${error.message}</div>
                </div>
            `;
            addLogEntry('error', `CSVå–ã‚Šè¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }
    
    // åˆ©ç›Šè¨ˆç®—å®Ÿè¡Œ
    async function calculateProfit() {
        const productId = document.getElementById('calcProductId')?.value;
        const sellingPrice = document.getElementById('calcSellingPrice')?.value;
        const weight = document.getElementById('calcWeight')?.value;
        const dimensions = document.getElementById('calcDimensions')?.value;
        const country = document.getElementById('calcCountry')?.value;
        const resultDiv = document.getElementById('profitCalculationResult');
        
        if (!productId) {
            resultDiv.innerHTML = '<div class="notification error"><i class="fas fa-times-circle"></i> å•†å“IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
            return;
        }
        
        try {
            resultDiv.innerHTML = '<div class="notification info"><i class="fas fa-spinner fa-spin"></i> åˆ©ç›Šè¨ˆç®—ä¸­...</div>';
            
            const formData = new FormData();
            formData.append('action', 'calculate_profit');
            formData.append('product_id', productId);
            formData.append('options', JSON.stringify({
                selling_price_usd: sellingPrice,
                weight_kg: weight,
                dimensions: dimensions ? dimensions.split(',') : ['20','15','10'],
                destination_country: country
            }));
            
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success && result.data?.success) {
                const calc = result.data;
                const profitColor = calc.profit_margin_percent >= 30 ? '#10b981' : 
                                  calc.profit_margin_percent >= 20 ? '#f59e0b' : '#ef4444';
                
                resultDiv.innerHTML = `
                    <div class="notification success">
                        <i class="fas fa-check-circle"></i>
                        <div><strong>åˆ©ç›Šè¨ˆç®—å®Œäº†</strong></div>
                    </div>
                    
                    <div style="background: var(--bg-tertiary); padding: var(--space-md); border-radius: var(--radius-md); margin-top: var(--space-sm);">
                        <h5>ğŸ“Š è¨ˆç®—çµæœã‚µãƒãƒªãƒ¼</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm); margin-top: var(--space-sm);">
                            <div><strong>ä»•å…¥ä¾¡æ ¼:</strong> Â¥${calc.purchase_price_jpy ? calc.purchase_price_jpy.toLocaleString() : '0'}</div>
                            <div><strong>è²©å£²ä¾¡æ ¼:</strong> ${calc.selling_price_usd}</div>
                            <div><strong>ç·ã‚³ã‚¹ãƒˆ:</strong> ${calc.total_cost_usd}</div>
                            <div style="color: ${profitColor};"><strong>åˆ©ç›Š:</strong> ${calc.profit_usd}</div>
                        </div>
                        <div style="margin-top: var(--space-sm); padding: var(--space-sm); background: ${profitColor}; color: white; border-radius: var(--radius-sm); text-align: center;">
                            <strong>åˆ©ç›Šç‡: ${calc.profit_margin_percent}%</strong><br>
                            <small>${calc.recommendation?.message || 'è¨ˆç®—å®Œäº†'}</small>
                        </div>
                    </div>
                `;
                
                addLogEntry('success', `åˆ©ç›Šè¨ˆç®—å®Œäº†: åˆ©ç›Šç‡${calc.profit_margin_percent}%`);
            } else {
                resultDiv.innerHTML = `
                    <div class="notification error">
                        <i class="fas fa-times-circle"></i>
                        <div><strong>åˆ©ç›Šè¨ˆç®—å¤±æ•—</strong><br>${result.data?.error || result.message}</div>
                    </div>
                `;
                addLogEntry('error', `åˆ©ç›Šè¨ˆç®—å¤±æ•—: ${result.data?.error}`);
            }
        } catch (error) {
            resultDiv.innerHTML = `
                <div class="notification error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div><strong>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼</strong><br>${error.message}</div>
                </div>
            `;
            addLogEntry('error', `åˆ©ç›Šè¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }
    </script>
</body>
</html>
