/**
 * eBay„Ç´„ÉÜ„Ç¥„É™Ëá™ÂãïÂà§ÂÆö„Ç∑„Çπ„ÉÜ„É† - „Éï„É≠„É≥„Éà„Ç®„É≥„ÉâJavaScript
 * Yahoo Auction ToolÁµ±ÂêàÁâà
 */

console.log('üè∑Ô∏è eBay„Ç´„ÉÜ„Ç¥„É™„Ç∑„Çπ„ÉÜ„É† JavaScriptË™≠„ÅøËæº„ÅøÈñãÂßã');

// eBay„Ç´„ÉÜ„Ç¥„É™„Ç∑„Çπ„ÉÜ„É† - „É°„Ç§„É≥„ÇØ„É©„Çπ
class EbayCategorySystem {
    constructor() {
        this.config = {
            API_BASE_URL: window.location.pathname,
            DEBUG_MODE: true,
            MAX_FILE_SIZE: 5 * 1024 * 1024, // 5MB
            MAX_ROWS: 10000
        };
        
        this.state = {
            isProcessing: false,
            uploadedData: null,
            processedResults: null,
            selectedItems: new Set()
        };
        
        this.templates = {
            resultRow: null,
            progressModal: null
        };
        
        this.init();
    }
    
    // ÂàùÊúüÂåñ
    init() {
        console.log('üöÄ eBay„Ç´„ÉÜ„Ç¥„É™„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÈñãÂßã');
        
        this.setupEventListeners();
        this.setupDragAndDrop();
        this.setupTemplates();
        
        console.log('‚úÖ eBay„Ç´„ÉÜ„Ç¥„É™„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
    }
    
    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
    setupEventListeners() {
        // CSV„Éï„Ç°„Ç§„É´ÈÅ∏Êäû
        const csvFileInput = document.getElementById('csvFileInput');
        if (csvFileInput) {
            csvFileInput.addEventListener('change', (e) => this.handleFileSelect(e));
        }
        
        // Âçò‰∏ÄÂïÜÂìÅ„ÉÜ„Çπ„Éà
        const singleTestBtn = document.querySelector('.btn[onclick="testSingleProduct()"]');
        if (singleTestBtn) {
            singleTestBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.testSingleProduct();
            });
        }
        
        // ÂÖ®ÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ
        const selectAllCheckbox = document.getElementById('selectAllResults');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', (e) => this.toggleAllSelection(e.target.checked));
        }
        
        // „Éò„É´„Éó„Éú„Çø„É≥
        const helpBtn = document.querySelector('.btn[onclick="showEbayCategoryHelp()"]');
        if (helpBtn) {
            helpBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.showHelp();
            });
        }
        
        // „Çµ„É≥„Éó„É´CSV„Éú„Çø„É≥
        const sampleBtn = document.querySelector('.btn[onclick="showSampleCSV()"]');
        if (sampleBtn) {
            sampleBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.downloadSampleCSV();
            });
        }
        
        console.log('üìã eBay„Ç´„ÉÜ„Ç¥„É™„Ç∑„Çπ„ÉÜ„É† „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆöÂÆå‰∫Ü');
    }
    
    // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóË®≠ÂÆö
    setupDragAndDrop() {
        const uploadContainer = document.getElementById('csvUploadContainer');
        if (!uploadContainer) return;
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadContainer.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadContainer.addEventListener(eventName, () => {
                uploadContainer.classList.add('drag-over');
            });
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadContainer.addEventListener(eventName, () => {
                uploadContainer.classList.remove('drag-over');
            });
        });
        
        uploadContainer.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'text/csv') {
                this.processCSVFile(files[0]);
            } else {
                this.showMessage('CSV„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warning');
            }
        });
        
        console.log('üìÇ „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÊ©üËÉΩË®≠ÂÆöÂÆå‰∫Ü');
    }
    
    // „ÉÜ„É≥„Éó„É¨„Éº„ÉàË®≠ÂÆö
    setupTemplates() {
        // ÁµêÊûúË°å„ÉÜ„É≥„Éó„É¨„Éº„Éà
        this.templates.resultRow = (item, index) => `
            <tr data-index="${index}">
                <td><input type="checkbox" class="row-select" data-index="${index}"></td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.title}">
                    ${item.title}
                </td>
                <td>$${parseFloat(item.price || 0).toFixed(2)}</td>
                <td>
                    <span class="category-badge category-badge--${this.getConfidenceLevel(item.confidence)}-confidence">
                        ${item.category}
                    </span>
                </td>
                <td>
                    <div class="confidence-meter">
                        <div class="confidence-bar">
                            <div class="confidence-fill confidence-fill--${this.getConfidenceLevel(item.confidence)}" 
                                 style="width: ${item.confidence}%; background: ${this.getConfidenceColor(item.confidence)};"></div>
                        </div>
                        <span>${item.confidence}%</span>
                    </div>
                </td>
                <td>
                    <div class="item-specifics-container" title="${item.itemSpecifics}">
                        ${item.itemSpecifics.replace(/‚ñ†/g, ' | ').substring(0, 50)}${item.itemSpecifics.length > 50 ? '...' : ''}
                    </div>
                </td>
                <td>
                    <span class="category-badge category-badge--medium-confidence">
                        ÊâøË™çÂæÖ„Å°
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-edit btn-xs" title="Á∑®ÈõÜ" onclick="ebayCategorySystem.editItem(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-approve btn-xs" title="ÊâøË™ç" onclick="ebayCategorySystem.approveItem(${index})">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-reject btn-xs" title="Âê¶Ë™ç" onclick="ebayCategorySystem.rejectItem(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }
    
    // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÂá¶ÁêÜ
    handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            this.processCSVFile(file);
        }
    }
    
    // CSV„Éï„Ç°„Ç§„É´Âá¶ÁêÜ
    async processCSVFile(file) {
        console.log('üìä CSV„Éï„Ç°„Ç§„É´Âá¶ÁêÜÈñãÂßã:', file.name);
        
        // „Éï„Ç°„Ç§„É´Ê§úË®º
        if (!this.validateFile(file)) {
            return;
        }
        
        try {
            this.state.isProcessing = true;
            this.showProgress(true);
            
            // „Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
            const csvText = await this.readFileAsText(file);
            
            // CSVËß£Êûê
            const data = this.parseCSV(csvText);
            
            if (data.length === 0) {
                throw new Error('CSV„Éï„Ç°„Ç§„É´„Å´„Éá„Éº„Çø„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            }
            
            console.log('üìã CSV„Éá„Éº„ÇøËß£ÊûêÂÆå‰∫Ü:', data.length, '‰ª∂');
            
            // eBay„Ç´„ÉÜ„Ç¥„É™Âà§ÂÆöÂá¶ÁêÜÔºà„É¢„ÉÉ„ÇØ„Éá„Éº„ÇøÁîüÊàêÔºâ
            const results = await this.processEbayCategories(data);
            
            // ÁµêÊûúË°®Á§∫
            this.displayResults(results);
            
            this.showMessage(`${results.length}‰ª∂„ÅÆÂïÜÂìÅ„ÅÆ„Ç´„ÉÜ„Ç¥„É™Âà§ÂÆö„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü`, 'success');
            
        } catch (error) {
            console.error('‚ùå CSV„Éï„Ç°„Ç§„É´Âá¶ÁêÜ„Ç®„É©„Éº:', error);
            this.showMessage(`Âá¶ÁêÜ„Ç®„É©„Éº: ${error.message}`, 'error');
        } finally {
            this.state.isProcessing = false;
            this.showProgress(false);
        }
    }
    
    // „Éï„Ç°„Ç§„É´Ê§úË®º
    validateFile(file) {
        // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ
        if (file.size > this.config.MAX_FILE_SIZE) {
            this.showMessage('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„Åå5MB„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô', 'error');
            return false;
        }
        
        // „Éï„Ç°„Ç§„É´„Çø„Ç§„Éó„ÉÅ„Çß„ÉÉ„ÇØ
        if (file.type !== 'text/csv' && !file.name.toLowerCase().endsWith('.csv')) {
            this.showMessage('CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
            return false;
        }
        
        return true;
    }
    
    // „Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
    readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(new Error('„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº'));
            reader.readAsText(file, 'UTF-8');
        });
    }
    
    // CSVËß£Êûê
    parseCSV(csvText) {
        try {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length && i <= this.config.MAX_ROWS; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length >= headers.length) {
                    const item = {};
                    headers.forEach((header, index) => {
                        item[header] = values[index] || '';
                    });
                    
                    // ÂøÖÈ†à„Éï„Ç£„Éº„É´„ÉâÁ¢∫Ë™ç
                    if (item.title && item.title.length > 0) {
                        data.push(item);
                    }
                }
            }
            
            return data;
            
        } catch (error) {
            throw new Error('CSVÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
        }
    }
    
    // eBay„Ç´„ÉÜ„Ç¥„É™Âà§ÂÆöÂá¶ÁêÜÔºà„É¢„ÉÉ„ÇØÔºâ
    async processEbayCategories(data) {
        const results = [];
        
        for (let i = 0; i < data.length; i++) {
            const item = data[i];
            
            // „Éó„É≠„Ç∞„É¨„ÇπÊõ¥Êñ∞
            this.updateProgress(((i + 1) / data.length) * 100);
            
            // Ê®°Êì¨ÁöÑ„Å™Âá¶ÁêÜÈÅÖÂª∂
            await this.sleep(100);
            
            // „É¢„ÉÉ„ÇØ„Ç´„ÉÜ„Ç¥„É™Âà§ÂÆö
            const categoryResult = this.mockCategoryDetection(item);
            
            results.push({
                ...item,
                ...categoryResult,
                index: i,
                status: 'pending'
            });
        }
        
        return results;
    }
    
    // „É¢„ÉÉ„ÇØ„Ç´„ÉÜ„Ç¥„É™Âà§ÂÆö
    mockCategoryDetection(item) {
        const title = (item.title || '').toLowerCase();
        const price = parseFloat(item.price || 0);
        
        // „Ç´„ÉÜ„Ç¥„É™„Éû„ÉÉ„Éî„É≥„Ç∞
        let category = '„Åù„ÅÆ‰ªñ';
        let confidence = Math.floor(Math.random() * 30) + 40; // 40-70%
        let itemSpecifics = 'Brand=Unknown‚ñ†Condition=Used';
        
        if (title.includes('iphone') || title.includes('„Ç¢„Ç§„Éï„Ç©„É≥')) {
            category = 'Cell Phones & Smartphones';
            confidence = Math.floor(Math.random() * 20) + 80; // 80-100%
            itemSpecifics = 'Brand=Apple‚ñ†Model=iPhone‚ñ†Storage=128GB‚ñ†Color=Space Black‚ñ†Condition=Used';
        } else if (title.includes('camera') || title.includes('„Ç´„É°„É©') || title.includes('canon') || title.includes('nikon')) {
            category = 'Cameras & Photo';
            confidence = Math.floor(Math.random() * 25) + 75; // 75-100%
            itemSpecifics = 'Brand=Canon‚ñ†Type=Digital SLR‚ñ†Model=EOS R6‚ñ†Condition=Used';
        } else if (title.includes('pokemon') || title.includes('„Éù„Ç±„É¢„É≥') || title.includes('card') || title.includes('„Ç´„Éº„Éâ')) {
            category = 'Trading Card Games';
            confidence = Math.floor(Math.random() * 30) + 70; // 70-100%
            itemSpecifics = 'Game=Pok√©mon‚ñ†Card Type=Promo‚ñ†Character=Pikachu‚ñ†Condition=Near Mint';
        } else if (title.includes('watch') || title.includes('ÊôÇË®à') || title.includes('rolex') || title.includes('seiko')) {
            category = 'Watches, Parts & Accessories';
            confidence = Math.floor(Math.random() * 25) + 65; // 65-90%
            itemSpecifics = 'Brand=Seiko‚ñ†Type=Wristwatch‚ñ†Movement=Automatic‚ñ†Condition=Pre-owned';
        } else if (title.includes('game') || title.includes('„Ç≤„Éº„É†') || title.includes('nintendo') || title.includes('playstation')) {
            category = 'Video Games & Consoles';
            confidence = Math.floor(Math.random() * 30) + 60; // 60-90%
            itemSpecifics = 'Platform=Nintendo Switch‚ñ†Game Title=Unknown‚ñ†Condition=Good';
        }
        
        // ‰æ°Ê†º„Å´„Çà„Çã‰ø°È†ºÂ∫¶Ë™øÊï¥
        if (price > 1000) {
            confidence = Math.min(100, confidence + 10);
        } else if (price > 100) {
            confidence = Math.min(100, confidence + 5);
        }
        
        return {
            category,
            confidence,
            itemSpecifics,
            detectedAt: new Date().toISOString()
        };
    }
    
    // ÁµêÊûúË°®Á§∫
    displayResults(results) {
        // ÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫
        const resultsSection = document.getElementById('resultsSection');
        if (resultsSection) {
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Áµ±Ë®àÊõ¥Êñ∞
        this.updateResultStats(results);
        
        // „ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞
        this.updateResultsTable(results);
        
        // ‰∏ÄÊã¨Êìç‰Ωú„Éë„Éç„É´ÊúâÂäπÂåñ
        this.enableBulkOperations();
        
        // Áä∂ÊÖã‰øùÂ≠ò
        this.state.processedResults = results;
    }
    
    // Áµ±Ë®àÊõ¥Êñ∞
    updateResultStats(results) {
        const totalProcessed = results.length;
        const highConfidence = results.filter(r => r.confidence >= 80).length;
        const mediumConfidence = results.filter(r => r.confidence >= 50 && r.confidence < 80).length;
        const lowConfidence = results.filter(r => r.confidence < 50).length;
        
        const elements = {
            totalProcessed: document.getElementById('totalProcessed'),
            highConfidence: document.getElementById('highConfidence'),
            mediumConfidence: document.getElementById('mediumConfidence'),
            lowConfidence: document.getElementById('lowConfidence')
        };
        
        Object.keys(elements).forEach(key => {
            if (elements[key]) {
                elements[key].textContent = eval(key);
            }
        });
    }
    
    // ÁµêÊûú„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞
    updateResultsTable(results) {
        const tbody = document.getElementById('resultsTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = results.map((item, index) => this.templates.resultRow(item, index)).join('');
        
        // Ë°åÈÅ∏Êäû„Ç§„Éô„É≥„ÉàË®≠ÂÆö
        this.setupRowSelectionEvents();
    }
    
    // Ë°åÈÅ∏Êäû„Ç§„Éô„É≥„ÉàË®≠ÂÆö
    setupRowSelectionEvents() {
        const checkboxes = document.querySelectorAll('.row-select');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const index = parseInt(e.target.dataset.index);
                if (e.target.checked) {
                    this.state.selectedItems.add(index);
                } else {
                    this.state.selectedItems.delete(index);
                }
                this.updateSelectionCount();
            });
        });
    }
    
    // Âçò‰∏ÄÂïÜÂìÅ„ÉÜ„Çπ„Éà
    async testSingleProduct() {
        const titleInput = document.getElementById('singleTestTitle');
        const priceInput = document.getElementById('singleTestPrice');
        
        if (!titleInput || !priceInput) return;
        
        const title = titleInput.value.trim();
        const price = parseFloat(priceInput.value) || 0;
        
        if (!title) {
            this.showMessage('ÂïÜÂìÅ„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warning');
            return;
        }
        
        console.log('üß™ Âçò‰∏ÄÂïÜÂìÅ„ÉÜ„Çπ„Éà:', title, price);
        
        const resultDiv = document.getElementById('singleTestResult');
        const contentDiv = document.getElementById('singleTestResultContent');
        
        if (!resultDiv || !contentDiv) return;
        
        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
        resultDiv.style.display = 'block';
        contentDiv.innerHTML = `
            <div style="text-align: center; padding: var(--space-lg);">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color); margin-bottom: var(--space-sm);"></i><br>
                „Ç´„ÉÜ„Ç¥„É™„Éº„ÇíÂà§ÂÆö‰∏≠...
            </div>
        `;
        
        try {
            // Ê®°Êì¨ÁöÑ„Å™Âá¶ÁêÜÈÅÖÂª∂
            await this.sleep(2000);
            
            // „É¢„ÉÉ„ÇØÂà§ÂÆöÂÆüË°å
            const result = this.mockCategoryDetection({ title, price });
            
            // ÁµêÊûúË°®Á§∫
            contentDiv.innerHTML = this.generateSingleTestResult(title, price, result);
            
            console.log('‚úÖ Âçò‰∏ÄÂïÜÂìÅ„ÉÜ„Çπ„ÉàÂÆå‰∫Ü:', result);
            
        } catch (error) {
            console.error('‚ùå Âçò‰∏ÄÂïÜÂìÅ„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', error);
            contentDiv.innerHTML = `
                <div class="notification error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>„ÉÜ„Çπ„ÉàÂá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</span>
                </div>
            `;
        }
    }
    
    // Âçò‰∏Ä„ÉÜ„Çπ„ÉàÁµêÊûúÁîüÊàê
    generateSingleTestResult(title, price, result) {
        const confidenceColor = this.getConfidenceColor(result.confidence);
        
        return `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">
                <div>
                    <h6 style="color: var(--text-secondary); margin-bottom: var(--space-xs);">Âà§ÂÆö„Ç´„ÉÜ„Ç¥„É™„Éº</h6>
                    <div style="padding: 0.25rem 0.5rem; background: #dcfce7; color: #166534; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; display: inline-block;">
                        ${result.category}
                    </div>
                </div>
                
                <div>
                    <h6 style="color: var(--text-secondary); margin-bottom: var(--space-xs);">Âà§ÂÆöÁ≤æÂ∫¶</h6>
                    <div style="display: flex; align-items: center; gap: 0.25rem;">
                        <div style="width: 80px; height: 6px; background: #f1f5f9; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${result.confidence}%; height: 100%; background: ${confidenceColor}; border-radius: 3px;"></div>
                        </div>
                        <span style="font-weight: 600;">${result.confidence}%</span>
                    </div>
                </div>
            </div>
            
            <div>
                <h6 style="color: var(--text-secondary); margin-bottom: var(--space-xs);">ÁîüÊàê„Åï„Çå„ÅüÂøÖÈ†àÈ†ÖÁõÆ</h6>
                <div style="background: var(--bg-tertiary); border-radius: var(--radius-md); padding: var(--space-sm); font-family: monospace; font-size: 0.75rem; color: var(--text-secondary);">
                    ${result.itemSpecifics.replace(/‚ñ†/g, ' | ')}
                </div>
            </div>
            
            <div class="notification success" style="margin-top: var(--space-md);">
                <i class="fas fa-check-circle"></i>
                <span><strong>Âà§ÂÆöÂÆå‰∫Ü:</strong> „Ç∑„Çπ„ÉÜ„É†„ÅåÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</span>
            </div>
        `;
    }
    
    // „Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫/ÈùûË°®Á§∫
    showProgress(show) {
        const progressDiv = document.getElementById('processingProgress');
        if (progressDiv) {
            progressDiv.style.display = show ? 'block' : 'none';
        }
    }
    
    // „Éó„É≠„Ç∞„É¨„ÇπÊõ¥Êñ∞
    updateProgress(percentage) {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        if (progressBar) {
            progressBar.style.width = `${percentage}%`;
        }
        
        if (progressText) {
            progressText.textContent = `Âá¶ÁêÜ‰∏≠... ${Math.round(percentage)}%`;
        }
    }
    
    // „Éò„É´„ÉóË°®Á§∫
    showHelp() {
        const helpMessage = `
eBay„Ç´„ÉÜ„Ç¥„É™„ÉºËá™ÂãïÂà§ÂÆö„Ç∑„Çπ„ÉÜ„É†

„ÄêÊ©üËÉΩÊ¶ÇË¶Å„Äë
ÂïÜÂìÅ„Çø„Ç§„Éà„É´„Åã„ÇâÊúÄÈÅ©„Å™eBay„Ç´„ÉÜ„Ç¥„É™„Éº„ÇíËá™ÂãïÂà§ÂÆö„Åó„ÄÅÂøÖÈ†àÈ†ÖÁõÆÔºàItem SpecificsÔºâ„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ

„Äê‰ΩøÁî®ÊñπÊ≥ï„Äë
1. CSV„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åô„Çã„Åã„ÄÅ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
2. „Ç∑„Çπ„ÉÜ„É†„ÅåËá™ÂãïÁöÑ„Å´„Ç´„ÉÜ„Ç¥„É™„Éº„ÇíÂà§ÂÆö
3. ÁµêÊûú„ÇíÁ¢∫Ë™ç„Åó„ÄÅÂøÖË¶Å„Å´Âøú„Åò„Å¶Á∑®ÈõÜ
4. ÊâøË™ç„Åæ„Åü„ÅØÂê¶Ë™ç„ÇíÊ±∫ÂÆö

„ÄêCSV„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Äë
title,price,description,yahoo_category,image_url

„ÄêÂØæÂøú„Ç´„ÉÜ„Ç¥„É™„Éº„Äë
- Cell Phones & Smartphones
- Cameras & Photo
- Trading Card Games
- Watches, Parts & Accessories
- Video Games & Consoles
- „Åù„ÅÆ‰ªñÂ§öÊï∞

„Ç∑„Çπ„ÉÜ„É†„ÅØÁèæÂú®„Éá„É¢„É¢„Éº„Éâ„ÅßÂãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
        `.trim();
        
        alert(helpMessage);
    }
    
    // „Çµ„É≥„Éó„É´CSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    downloadSampleCSV() {
        const sampleContent = `title,price,description,yahoo_category,image_url
"iPhone 14 Pro 128GB Space Black",999.99,"ÁæéÂìÅ„ÅÆiPhone 14 Pro","Êê∫Â∏ØÈõªË©±","https://example.com/iphone.jpg"
"Canon EOS R6 „Éü„É©„Éº„É¨„Çπ„Ç´„É°„É©",2499.99,"„Åª„ÅºÊñ∞ÂìÅ„ÅÆ„Éü„É©„Éº„É¨„Çπ„Ç´„É°„É©","„Ç´„É°„É©","https://example.com/camera.jpg"
"„Éù„Ç±„É¢„É≥„Ç´„Éº„Éâ „Éî„Ç´„ÉÅ„É•„Ç¶ „Éó„É≠„É¢„Ç´„Éº„Éâ",50.00,"ÈôêÂÆö„Éó„É≠„É¢„Ç´„Éº„Éâ","„Éà„É¨„Éº„Éá„Ç£„É≥„Ç∞„Ç´„Éº„Éâ","https://example.com/pokemon.jpg"
"Rolex Submariner ËÖïÊôÇË®à",8500.00,"Ê≠£Ë¶èÂìÅ„ÅÆÈ´òÁ¥öËÖïÊôÇË®à","ËÖïÊôÇË®à","https://example.com/rolex.jpg"
"Nintendo Switch Êú¨‰Ωì",299.99,"‰ªªÂ§©Â†ÇSwitchÊú¨‰Ωì„Çª„ÉÉ„Éà","„Ç≤„Éº„É†","https://example.com/switch.jpg"`;
        
        const blob = new Blob([sampleContent], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ebay_category_sample.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        this.showMessage('„Çµ„É≥„Éó„É´CSV„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü', 'success');
    }
    
    // ÂÖ®ÈÅ∏ÊäûÂàá„ÇäÊõø„Åà
    toggleAllSelection(checked) {
        const checkboxes = document.querySelectorAll('.row-select');
        checkboxes.forEach(checkbox => {
            checkbox.checked = checked;
            const index = parseInt(checkbox.dataset.index);
            if (checked) {
                this.state.selectedItems.add(index);
            } else {
                this.state.selectedItems.delete(index);
            }
        });
        this.updateSelectionCount();
    }
    
    // ÈÅ∏ÊäûÊï∞Êõ¥Êñ∞
    updateSelectionCount() {
        const selectedCountEl = document.getElementById('selectedCount');
        if (selectedCountEl) {
            selectedCountEl.textContent = this.state.selectedItems.size;
        }
        
        // ‰∏ÄÊã¨Êìç‰Ωú„Éú„Çø„É≥Áä∂ÊÖãÊõ¥Êñ∞
        const bulkOperations = document.getElementById('bulkOperations');
        if (bulkOperations) {
            if (this.state.selectedItems.size > 0) {
                bulkOperations.classList.add('active');
            } else {
                bulkOperations.classList.remove('active');
            }
        }
    }
    
    // ‰∏ÄÊã¨Êìç‰ΩúÊúâÂäπÂåñ
    enableBulkOperations() {
        const bulkApproveBtn = document.getElementById('bulkApproveBtn');
        const bulkRejectBtn = document.getElementById('bulkRejectBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        
        if (bulkApproveBtn) {
            bulkApproveBtn.addEventListener('click', () => this.bulkApprove());
        }
        
        if (bulkRejectBtn) {
            bulkRejectBtn.addEventListener('click', () => this.bulkReject());
        }
        
        if (exportCsvBtn) {
            exportCsvBtn.addEventListener('click', () => this.exportCSV());
        }
    }
    
    // „Ç¢„Ç§„ÉÜ„É†Á∑®ÈõÜ
    editItem(index) {
        console.log('‚úèÔ∏è „Ç¢„Ç§„ÉÜ„É†Á∑®ÈõÜ:', index);
        this.showMessage('Á∑®ÈõÜÊ©üËÉΩ„ÅØÈñãÁô∫‰∏≠„Åß„Åô', 'info');
    }
    
    // „Ç¢„Ç§„ÉÜ„É†ÊâøË™ç
    approveItem(index) {
        console.log('‚úÖ „Ç¢„Ç§„ÉÜ„É†ÊâøË™ç:', index);
        this.showMessage('ÂïÜÂìÅ„ÇíÊâøË™ç„Åó„Åæ„Åó„Åü', 'success');
    }
    
    // „Ç¢„Ç§„ÉÜ„É†Âê¶Ë™ç
    rejectItem(index) {
        console.log('‚ùå „Ç¢„Ç§„ÉÜ„É†Âê¶Ë™ç:', index);
        this.showMessage('ÂïÜÂìÅ„ÇíÂê¶Ë™ç„Åó„Åæ„Åó„Åü', 'warning');
    }
    
    // ‰∏ÄÊã¨ÊâøË™ç
    bulkApprove() {
        const count = this.state.selectedItems.size;
        if (count === 0) return;
        
        console.log('‚úÖ ‰∏ÄÊã¨ÊâøË™ç:', count, '‰ª∂');
        this.showMessage(`${count}‰ª∂„ÅÆÂïÜÂìÅ„ÇíÊâøË™ç„Åó„Åæ„Åó„Åü`, 'success');
        this.clearSelection();
    }
    
    // ‰∏ÄÊã¨Âê¶Ë™ç
    bulkReject() {
        const count = this.state.selectedItems.size;
        if (count === 0) return;
        
        console.log('‚ùå ‰∏ÄÊã¨Âê¶Ë™ç:', count, '‰ª∂');
        this.showMessage(`${count}‰ª∂„ÅÆÂïÜÂìÅ„ÇíÂê¶Ë™ç„Åó„Åæ„Åó„Åü`, 'warning');
        this.clearSelection();
    }
    
    // CSVÂá∫Âäõ
    exportCSV() {
        if (!this.state.processedResults || this.state.processedResults.length === 0) {
            this.showMessage('Âá∫Âäõ„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'warning');
            return;
        }
        
        const selectedData = this.state.selectedItems.size > 0 
            ? this.state.processedResults.filter((_, index) => this.state.selectedItems.has(index))
            : this.state.processedResults;
        
        const csvContent = this.generateCSVContent(selectedData);
        this.downloadCSV(csvContent, 'ebay_category_results.csv');
        
        this.showMessage(`${selectedData.length}‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíÂá∫Âäõ„Åó„Åæ„Åó„Åü`, 'success');
    }
    
    // CSVÂÜÖÂÆπÁîüÊàê
    generateCSVContent(data) {
        const headers = ['title', 'price', 'category', 'confidence', 'itemSpecifics', 'status'];
        const csvRows = [headers.join(',')];
        
        data.forEach(item => {
            const row = headers.map(header => {
                let value = item[header] || '';
                if (typeof value === 'string' && (value.includes(',') || value.includes('\n'))) {
                    value = `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            });
            csvRows.push(row.join(','));
        });
        
        return csvRows.join('\n');
    }
    
    // CSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    downloadCSV(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // ÈÅ∏Êäû„ÇØ„É™„Ç¢
    clearSelection() {
        this.state.selectedItems.clear();
        const checkboxes = document.querySelectorAll('.row-select');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        this.updateSelectionCount();
        
        const selectAllCheckbox = document.getElementById('selectAllResults');
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = false;
        }
    }
    
    // ‰ø°È†ºÂ∫¶„É¨„Éô„É´ÂèñÂæó
    getConfidenceLevel(confidence) {
        if (confidence >= 80) return 'high';
        if (confidence >= 50) return 'medium';
        return 'low';
    }
    
    // ‰ø°È†ºÂ∫¶Ëâ≤ÂèñÂæó
    getConfidenceColor(confidence) {
        if (confidence >= 80) return '#10b981';
        if (confidence >= 50) return '#f59e0b';
        return '#ef4444';
    }
    
    // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
    showMessage(message, type = 'info') {
        console.log(`${type.toUpperCase()}: ${message}`);
        
        // Á∞°Êòì„Ç¢„É©„Éº„ÉàË°®Á§∫ÔºàÂÆüÈöõ„ÅÆ„Ç∑„Çπ„ÉÜ„É†„Åß„ÅØ„Éà„Éº„Çπ„ÉàÈÄöÁü•„Å™„Å©Ôºâ
        const alertClass = {
            success: '‚úÖ',
            warning: '‚ö†Ô∏è',
            error: '‚ùå',
            info: '‚ÑπÔ∏è'
        };
        
        alert(`${alertClass[type]} ${message}`);
    }
    
    // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£: „Çπ„É™„Éº„Éó
    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// „Ç∞„É≠„Éº„Éê„É´„Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàê
let ebayCategorySystem;

// DOMË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÊôÇ„ÅÆÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    // Yahoo Auction Tool„ÅÆ„Çø„Éñ„Ç∑„Çπ„ÉÜ„É†„Å®„ÅÆÁµ±Âêà„ÉÅ„Çß„ÉÉ„ÇØ
    if (typeof YahooAuctionTool !== 'undefined') {
        console.log('üîó Yahoo Auction ToolÁµ±Âêà„É¢„Éº„Éâ');
    }
    
    // eBay„Ç´„ÉÜ„Ç¥„É™„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
    ebayCategorySystem = new EbayCategorySystem();
    
    console.log('üöÄ eBay„Ç´„ÉÜ„Ç¥„É™„Ç∑„Çπ„ÉÜ„É†Áµ±ÂêàÂÆå‰∫Ü');
});

// „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞Ôºà‰∏ã‰Ωç‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
function showEbayCategoryHelp() {
    if (ebayCategorySystem) {
        ebayCategorySystem.showHelp();
    }
}

function showSampleCSV() {
    if (ebayCategorySystem) {
        ebayCategorySystem.downloadSampleCSV();
    }
}

function testSingleProduct() {
    if (ebayCategorySystem) {
        ebayCategorySystem.testSingleProduct();
    }
}

function processEbayCsvFile(file) {
    if (ebayCategorySystem) {
        ebayCategorySystem.processCSVFile(file);
    }
}

// „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÔºà„É¢„Ç∏„É•„Éº„É´‰ΩøÁî®ÊôÇÔºâ
if (typeof module !== 'undefined' && module.exports) {
    module.exports = EbayCategorySystem;
}

console.log('‚úÖ eBay„Ç´„ÉÜ„Ç¥„É™„Ç∑„Çπ„ÉÜ„É† JavaScriptË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
