<body>
    <div class="container">
        <div class="main-dashboard">
            <div class="dashboard-header">
                <h1><i class="fas fa-sync-alt"></i> Yahoo→eBay統合ワークフロー完全版（eBayカテゴリー統合版）</h1>
                <p>N3デザイン適用・データベース統合・送料計算エディター・禁止品フィルター管理・eBay出品支援・在庫分析・商品承認システム・eBayカテゴリー自動判定</p>
            </div>

            <div class="caids-constraints-bar">
                <div class="constraint-item">
                    <div class="constraint-value" id="totalRecords">{{TOTAL_RECORDS}}</div>
                    <div class="constraint-label">総データ数</div>
                </div>
                <div class="constraint-item">
                    <div class="constraint-value" id="scrapedCount">{{SCRAPED_COUNT}}</div>
                    <div class="constraint-label">取得済</div>
                </div>
                <div class="constraint-item">
                    <div class="constraint-value" id="calculatedCount">{{CALCULATED_COUNT}}</div>
                    <div class="constraint-label">計算済</div>
                </div>
                <div class="constraint-item">
                    <div class="constraint-value" id="filteredCount">{{FILTERED_COUNT}}</div>
                    <div class="constraint-label">フィルター済</div>
                </div>
                <div class="constraint-item">
                    <div class="constraint-value" id="readyCount">{{READY_COUNT}}</div>
                    <div class="constraint-label">出品準備完了</div>
                </div>
                <div class="constraint-item">
                    <div class="constraint-value" id="listedCount">{{LISTED_COUNT}}</div>
                    <div class="constraint-label">出品済</div>
                </div>
            </div>

            <div class="tab-navigation">
                <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    ダッシュボード
                </button>
                <button class="tab-btn" data-tab="approval" onclick="switchTab('approval')">
                    <i class="fas fa-check-circle"></i>
                    商品承認
                </button>
                <button class="tab-btn" data-tab="analysis" onclick="switchTab('analysis')">
                    <i class="fas fa-chart-bar"></i>
                    承認分析
                </button>
                <button class="tab-btn" data-tab="scraping" onclick="switchTab('scraping')">
                    <i class="fas fa-spider"></i>
                    データ取得
                </button>
                <button class="tab-btn" data-tab="editing" onclick="switchTab('editing')">
                    <i class="fas fa-edit"></i>
                    データ編集
                </button>
                <button class="tab-btn" data-tab="calculation" onclick="switchTab('calculation')">
                    <i class="fas fa-calculator"></i>
                    送料計算
                </button>
                <button class="tab-btn" data-tab="filters" onclick="switchTab('filters')">
                    <i class="fas fa-filter"></i>
                    フィルター
                </button>
                <button class="tab-btn" data-tab="listing" onclick="switchTab('listing')">
                    <i class="fas fa-store"></i>
                    出品管理
                </button>
                <button class="tab-btn" data-tab="inventory-mgmt" onclick="switchTab('inventory-mgmt')">
                    <i class="fas fa-warehouse"></i>
                    在庫管理
                </button>
                <!-- 🆕 eBayカテゴリータブ追加 -->
                <button class="tab-btn" data-tab="ebay-category" onclick="switchTab('ebay-category')">
                    <i class="fas fa-tags"></i>
                    eBayカテゴリー
                </button>
            </div>

            <!-- ダッシュボードタブ -->
            <div id="dashboard" class="tab-content active fade-in">
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-search"></i>
                        <h3 class="section-title">商品検索</h3>
                        <div style="margin-left: auto; display: flex; gap: var(--space-sm);">
                            <input type="text" id="searchQuery" placeholder="検索キーワード" style="padding: 0.4rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8rem;">
                            <button class="btn btn-primary" onclick="searchDatabase()">
                                <i class="fas fa-search"></i> 検索
                            </button>
                        </div>
                    </div>
                    <div id="searchResults">
                        <div class="notification info">
                            <i class="fas fa-info-circle"></i>
                            <span>検索条件を入力して「検索」ボタンを押してください</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 商品承認タブ -->
            <div id="approval" class="tab-content fade-in">
                <div class="approval-system">
                    <!-- AI推奨表示バー -->
                    <div style="background: linear-gradient(135deg, #8b5cf6, #06b6d4); color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                                <i class="fas fa-brain"></i>
                                AI推奨: データベースから商品読み込み中
                            </h2>
                            <p style="margin: 0; font-size: 0.8rem; opacity: 0.9;">
                                データベースから承認待ち商品を取得しています。<span id="totalProductCount">0</span>件の商品を読み込み中です。
                            </p>
                        </div>
                        <button class="btn" style="background: white; color: var(--primary-color); font-weight: 700; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer;" onclick="openNewProductModal()">
                            <i class="fas fa-plus-circle"></i> 新規商品登録
                        </button>
                    </div>

                    <!-- 統計表示 -->
                    <div class="approval-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="pendingCount">-</div>
                            <div class="stat-label">承認待ち</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="autoApprovedCount">-</div>
                            <div class="stat-label">自動承認済み</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="highRiskCount">-</div>
                            <div class="stat-label">高リスク</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="mediumRiskCount">-</div>
                            <div class="stat-label">中リスク</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="avgProcessTime">-</div>
                            <div class="stat-label">平均処理時間</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalRegistered">-</div>
                            <div class="stat-label">登録済商品</div>
                        </div>
                    </div>

                    <!-- フィルターコントロール -->
                    <div class="approval-filters">
                        <div class="filter-group">
                            <span class="filter-label">表示:</span>
                            <button class="filter-btn active" data-filter="all" onclick="applyFilter('all')">
                                すべて <span id="filterAllCount">0</span>
                            </button>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">AI判定:</span>
                            <button class="filter-btn" data-filter="ai-approved" onclick="applyFilter('ai-approved')">
                                AI承認済み <span id="filterApprovedCount">0</span>
                            </button>
                            <button class="filter-btn" data-filter="ai-rejected" onclick="applyFilter('ai-rejected')">
                                AI非承認 <span id="filterRejectedCount">0</span>
                            </button>
                            <button class="filter-btn" data-filter="ai-pending" onclick="applyFilter('ai-pending')">
                                AI判定待ち <span id="filterPendingCount">0</span>
                            </button>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">リスク:</span>
                            <button class="filter-btn" data-filter="high-risk" onclick="applyFilter('high-risk')">
                                高リスク <span id="filterHighRiskCount">0</span>
                            </button>
                            <button class="filter-btn" data-filter="medium-risk" onclick="applyFilter('medium-risk')">
                                中リスク <span id="filterMediumRiskCount">0</span>
                            </button>
                            <button class="filter-btn" data-filter="low-risk" onclick="applyFilter('low-risk')">
                                低リスク <span id="filterLowRiskCount">0</span>
                            </button>
                        </div>
                    </div>

                    <!-- 一括操作バー -->
                    <div class="bulk-actions" id="bulkActions" style="display: none;">
                        <div class="bulk-info">
                            <i class="fas fa-check-square"></i>
                            <span id="selectedCount">0</span>件 を選択中
                        </div>
                        <div class="bulk-buttons">
                            <button class="bulk-btn bulk-btn-approve" onclick="bulkApprove()">
                                <i class="fas fa-check"></i> 一括承認
                            </button>
                            <button class="bulk-btn bulk-btn-reject" onclick="bulkReject()">
                                <i class="fas fa-ban"></i> 一括否認
                            </button>
                            <button class="bulk-btn" onclick="clearSelection()">
                                <i class="fas fa-times"></i> 選択クリア
                            </button>
                        </div>
                    </div>

                    <!-- 商品グリッド（データベースから動的読み込み） -->
                    <div class="approval-grid" id="approval-product-grid">
                        <!-- 初期ローディング表示 -->
                        <div class="loading-container" id="loadingContainer">
                            <div class="loading-spinner"></div>
                            <p>データベースから承認待ち商品を読み込み中...</p>
                        </div>
                        
                        <!-- データがない場合の表示 -->
                        <div class="no-data-container" id="noDataContainer" style="display: none;">
                            <div class="no-data-icon">
                                <i class="fas fa-inbox"></i>
                            </div>
                            <h3>承認待ち商品がありません</h3>
                            <p>現在、承認が必要な商品はありません。新しいデータを取得するか、商品を手動で追加してください。</p>
                            <div class="no-data-actions">
                                <button class="btn btn-primary" onclick="loadApprovalData()">
                                    <i class="fas fa-sync"></i> データを再読み込み
                                </button>
                                <button class="btn btn-success" onclick="openNewProductModal()">
                                    <i class="fas fa-plus"></i> 新規商品追加
                                </button>
                            </div>
                        </div>
                        
                        <!-- エラー表示 -->
                        <div class="error-container" id="errorContainer" style="display: none;">
                            <div class="error-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3>データ読み込みエラー</h3>
                            <p id="errorMessage">データベースからの商品読み込みに失敗しました。</p>
                            <div class="error-actions">
                                <button class="btn btn-primary" onclick="loadApprovalData()">
                                    <i class="fas fa-redo"></i> 再試行
                                </button>
                                <button class="btn btn-secondary" onclick="checkDatabaseConnection()">
                                    <i class="fas fa-database"></i> 接続確認
                                </button>
                            </div>
                        </div>
                        
                        <!-- 実際の商品データ表示エリア -->
                        <div class="products-container" id="productsContainer" style="display: none;">
                            <!-- JavaScriptでデータベースから取得した商品を動的生成 -->
                        </div>
                    </div>

                    <!-- メインアクション -->
                    <div class="main-actions">
                        <div class="action-group">
                            <button class="action-btn action-btn-primary" onclick="selectAllVisible()">
                                <i class="fas fa-check-square"></i> 全選択
                            </button>
                            <button class="action-btn action-btn-secondary" onclick="deselectAll()">
                                <i class="fas fa-square"></i> 全解除
                            </button>
                            <button class="action-btn action-btn-info" onclick="loadApprovalData()">
                                <i class="fas fa-sync"></i> 更新
                            </button>
                        </div>
                        <div class="action-group">
                            <button class="action-btn action-btn-success" onclick="bulkApprove()" disabled>
                                <i class="fas fa-check"></i> 承認
                            </button>
                            <button class="action-btn action-btn-danger" onclick="bulkReject()" disabled>
                                <i class="fas fa-times"></i> 否認
                            </button>
                            <button class="action-btn action-btn-warning" onclick="exportSelectedProducts()" disabled>
                                <i class="fas fa-download"></i> CSV出力
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 承認分析タブ -->
            <div id="analysis" class="tab-content fade-in">
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-chart-bar"></i>
                        <h3 class="section-title">承認分析ダッシュボード</h3>
                        <div style="margin-left: auto;">
                            <button class="btn btn-info" onclick="loadAnalysisData()">
                                <i class="fas fa-sync"></i> データ更新
                            </button>
                        </div>
                    </div>
                    <div id="analysis-content">
                        <div class="notification info">
                            <i class="fas fa-info-circle"></i>
                            <span>承認データの分析機能は開発中です。今後の更新で詳細な分析機能を追加予定です。</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- データ取得タブ -->
            <div id="scraping" class="tab-content fade-in">
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-download"></i>
                        <h3 class="section-title">Yahoo オークションデータ取得</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
                        <div>
                            <form action="yahoo_auction_tool_content_working.php" method="POST">
                                <input type="hidden" name="action" value="scrape">
                                <div style="margin-bottom: var(--space-sm);">
                                    <label style="display: block; margin-bottom: 0.3rem; font-size: 0.8rem; font-weight: 600;">Yahoo オークション URL</label>
                                    <textarea name="url" id="yahooUrls" placeholder="https://auctions.yahoo.co.jp/jp/auction/xxxxx" style="width: 100%; height: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8rem;"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-play"></i> スクレイピング開始
                                </button>
                                <button type="button" class="btn btn-info" onclick="testConnection()">
                                    <i class="fas fa-link"></i> 接続テスト
                                </button>
                            </form>
                        </div>
                        <div>
                            <form action="yahoo_auction_tool_content_working.php" method="POST" enctype="multipart/form-data">
                                <input type="hidden" name="action" value="process_edited">
                                <div style="margin-bottom: var(--space-sm);">
                                    <label style="display: block; margin-bottom: 0.3rem; font-size: 0.8rem; font-weight: 600;">CSVファイル選択</label>
                                    <input type="file" name="csvFile" id="csvFile" accept=".csv" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8rem;">
                                </div>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-upload"></i> CSV取込
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- データ編集タブ -->
            <div id="editing" class="tab-content fade-in">
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-edit"></i>
                        <h3 class="section-title">データ編集 & 検証</h3>
                        <div style="margin-left: auto; display: flex; gap: var(--space-sm);">
                            <button class="btn btn-info" onclick="loadEditingData()">
                                <i class="fas fa-sync"></i> データ読込
                            </button>
                            <button class="btn btn-secondary" onclick="downloadEditingCSV()">
                                <i class="fas fa-download"></i> CSV出力
                            </button>
                            <button class="btn btn-success" onclick="uploadEditedCSV()">
                                <i class="fas fa-upload"></i> 編集済CSV
                            </button>
                            <button class="btn btn-warning" onclick="saveAllEdits()">
                                <i class="fas fa-save"></i> 全保存
                            </button>
                        </div>
                    </div>
                    
                    <div class="data-table-container">
                        <table class="data-table" id="editingTable">
                            <thead>
                                <tr>
                                    <th>操作</th>
                                    <th>モール</th>
                                    <th>画像</th>
                                    <th>商品ID</th>
                                    <th>取得タイトル</th>
                                    <th>取得カテゴリ</th>
                                    <th>価格(円)</th>
                                    <th>仕入価格</th>
                                    <th>国内送料</th>
                                    <th>計算価格($)</th>
                                    <th>ステータス</th>
                                    <th>販売形式</th>
                                    <th>URL</th>
                                </tr>
                            </thead>
                            <tbody id="editingTableBody">
                                <tr>
                                    <td colspan="13" style="text-align: center; padding: var(--space-lg); color: var(--text-muted);">
                                        「データ読込」ボタンを押してデータを表示してください。
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="display: flex; justify-content: center; align-items: center; margin-top: var(--space-md); gap: var(--space-md);">
                        <button class="btn btn-secondary" onclick="changePage(-1)">
                            <i class="fas fa-chevron-left"></i> 前へ
                        </button>
                        <span id="pageInfo" style="color: var(--text-secondary); font-size: 0.8rem;">ページ 1/1</span>
                        <button class="btn btn-secondary" onclick="changePage(1)">
                            次へ <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 送料計算タブ -->
            <div id="calculation" class="tab-content fade-in">
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-calculator"></i>
                        <h3 class="section-title">送料計算 & 最適候補提示</h3>
                        <div style="margin-left: auto; display: flex; gap: var(--space-sm);">
                            <button class="btn btn-success" onclick="calculateShippingCandidates()">
                                <i class="fas fa-search"></i> 候補検索
                            </button>
                            <button class="btn btn-info" onclick="clearCalculationForm()">
                                <i class="fas fa-undo"></i> クリア
                            </button>
                        </div>
                    </div>
                    
                    <div class="notification info">
                        <i class="fas fa-info-circle"></i>
                        <span>重さ・大きさ・国を入力して最適な配送方法5候補を表示します</span>
                    </div>

                    <!-- 計算フォーム -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div style="background: var(--bg-tertiary); padding: var(--space-md); border-radius: var(--radius-lg);">
                            <h5 style="margin-bottom: var(--space-sm); color: var(--text-primary); display: flex; align-items: center; gap: var(--space-xs);">
                                <i class="fas fa-weight-hanging"></i>
                                重量
                            </h5>
                            <div>
                                <label style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.3rem; display: block;">重さ (kg)</label>
                                <input type="number" id="shippingWeight" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8rem;" placeholder="1.5" step="0.1" min="0.1" max="30">
                            </div>
                        </div>

                        <div style="background: var(--bg-tertiary); padding: var(--space-md); border-radius: var(--radius-lg);">
                            <h5 style="margin-bottom: var(--space-sm); color: var(--text-primary); display: flex; align-items: center; gap: var(--space-xs);">
                                <i class="fas fa-cube"></i>
                                大きさ
                            </h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-xs);">
                                <div>
                                    <label style="font-size: 0.7rem; color: var(--text-secondary);">幅 (cm)</label>
                                    <input type="number" id="shippingWidth" style="width: 100%; padding: 0.3rem; border: 1px solid var(--border-color); border-radius: 2px; font-size: 0.7rem;" placeholder="20" min="1" max="200">
                                </div>
                                <div>
                                    <label style="font-size: 0.7rem; color: var(--text-secondary);">高さ (cm)</label>
                                    <input type="number" id="shippingHeight" style="width: 100%; padding: 0.3rem; border: 1px solid var(--border-color); border-radius: 2px; font-size: 0.7rem;" placeholder="15" min="1" max="200">
                                </div>
                                <div>
                                    <label style="font-size: 0.7rem; color: var(--text-secondary);">奥行 (cm)</label>
                                    <input type="number" id="shippingDepth" style="width: 100%; padding: 0.3rem; border: 1px solid var(--border-color); border-radius: 2px; font-size: 0.7rem;" placeholder="10" min="1" max="200">
                                </div>
                            </div>
                        </div>

                        <div style="background: var(--bg-tertiary); padding: var(--space-md); border-radius: var(--radius-lg);">
                            <h5 style="margin-bottom: var(--space-sm); color: var(--text-primary); display: flex; align-items: center; gap: var(--space-xs);">
                                <i class="fas fa-globe-americas"></i>
                                出荷国
                            </h5>
                            <div>
                                <label style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.3rem; display: block;">配送先国</label>
                                <select id="shippingCountry" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8rem;">
                                    <option value="">配送先を選択</option>
                                    <option value="US">アメリカ合衆国</option>
                                    <option value="CA">カナダ</option>
                                    <option value="AU">オーストラリア</option>
                                    <option value="GB">英国</option>
                                    <option value="DE">ドイツ</option>
                                    <option value="FR">フランス</option>
                                    <option value="IT">イタリア</option>
                                    <option value="ES">スペイン</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 候補表示エリア -->
                    <div id="candidatesContainer" style="display: none;">
                        <h4 style="margin-bottom: var(--space-md); color: var(--text-primary); display: flex; align-items: center; gap: var(--space-xs);">
                            <i class="fas fa-medal"></i>
                            最適配送候補（安い順）
                        </h4>
                        <div id="candidatesList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-md);">
                            <!-- カードはJavaScriptで動的生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- フィルタータブ（禁止キーワード管理システム） -->
            <div id="filters" class="tab-content fade-in">
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-filter"></i>
                        <h3 class="section-title">禁止キーワード管理システム</h3>
                        <div style="margin-left: auto; display: flex; gap: var(--space-sm);">
                            <button class="btn btn-success" onclick="uploadProhibitedCSV()">
                                <i class="fas fa-upload"></i> CSV アップロード
                            </button>
                            <button class="btn btn-info" onclick="addNewKeyword()">
                                <i class="fas fa-plus"></i> キーワード追加
                            </button>
                            <button class="btn btn-warning" onclick="exportKeywordCSV()">
                                <i class="fas fa-download"></i> CSV エクスポート
                            </button>
                        </div>
                    </div>

                    <!-- 統計ダッシュボード -->
                    <div class="prohibited-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center;">
                            <div class="stat-value" id="totalKeywords" style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">1,247</div>
                            <div class="stat-label" style="font-size: 0.75rem; color: var(--text-secondary);">登録キーワード</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center;">
                            <div class="stat-value" id="highRiskKeywords" style="font-size: 1.5rem; font-weight: 700; color: var(--danger-color);">89</div>
                            <div class="stat-label" style="font-size: 0.75rem; color: var(--text-secondary);">高リスク</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center;">
                            <div class="stat-value" id="detectedToday" style="font-size: 1.5rem; font-weight: 700; color: var(--warning-color);">23</div>
                            <div class="stat-label" style="font-size: 0.75rem; color: var(--text-secondary);">今日の検出</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center;">
                            <div class="stat-value" id="lastUpdate" style="font-size: 1.5rem; font-weight: 700; color: var(--info-color);">2分前</div>
                            <div class="stat-label" style="font-size: 0.75rem; color: var(--text-secondary);">最終更新</div>
                        </div>
                    </div>

                    <!-- CSVドラッグ&ドロップエリア -->
                    <div class="csv-upload-area" id="csvUploadArea" style="margin-bottom: var(--space-lg);">
                        <div class="drag-drop-area" onclick="document.getElementById('csvFileInput').click();" ondrop="handleCSVDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary-color); margin-bottom: 0.5rem;"></i>
                            <div class="drag-drop-text">
                                <strong>CSVファイルをドラッグ&ドロップ</strong><br>
                                またはクリックしてファイルを選択
                            </div>
                            <div class="upload-requirements" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                対応形式: CSV | 最大サイズ: 5MB | 最大行数: 10,000行
                            </div>
                        </div>
                    </div>

                    <!-- キーワードテーブル -->
                    <div class="keyword-table-container">
                        <div class="table-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
                            <div class="selection-controls" style="display: flex; align-items: center; gap: var(--space-sm);">
                                <input type="checkbox" id="selectAllKeywords" onchange="toggleAllKeywords()">
                                <label for="selectAllKeywords" style="font-size: 0.875rem;">全選択</label>
                                <span id="selectedKeywordCount" class="selection-count" style="font-size: 0.75rem; color: var(--text-muted);">0件選択中</span>
                            </div>
                        </div>

                        <div class="data-table-container">
                            <table class="data-table keyword-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" id="selectAllTableKeywords"></th>
                                        <th style="width: 60px;">ID</th>
                                        <th style="width: 200px;">キーワード</th>
                                        <th style="width: 120px;">カテゴリ</th>
                                        <th style="width: 80px;">重要度</th>
                                        <th style="width: 80px;">検出回数</th>
                                        <th style="width: 100px;">登録日</th>
                                        <th style="width: 100px;">最終検出</th>
                                        <th style="width: 80px;">ステータス</th>
                                        <th style="width: 120px;">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="keywordTableBody">
                                    <tr>
                                        <td><input type="checkbox" class="keyword-checkbox" data-id="1"></td>
                                        <td>001</td>
                                        <td class="keyword-text">偽物</td>
                                        <td><span class="category-badge category-brand" style="background: var(--danger-color); color: white; padding: 0.125rem 0.375rem; border-radius: var(--radius-sm); font-size: 0.625rem;">ブランド</span></td>
                                        <td><span class="priority-badge priority-high" style="background: var(--danger-color); color: white; padding: 0.125rem 0.375rem; border-radius: var(--radius-sm); font-size: 0.625rem;">高</span></td>
                                        <td>127</td>
                                        <td>2025-09-01</td>
                                        <td>2025-09-10</td>
                                        <td><span class="status-badge status-active" style="background: var(--success-color); color: white; padding: 0.125rem 0.375rem; border-radius: var(--radius-sm); font-size: 0.625rem;">有効</span></td>
                                        <td>
                                            <button class="btn-sm btn-warning" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;" onclick="editKeyword(1)">編集</button>
                                            <button class="btn-sm btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;" onclick="deleteKeyword(1)">削除</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><input type="checkbox" class="keyword-checkbox" data-id="2"></td>
                                        <td>002</td>
                                        <td class="keyword-text">コピー品</td>
                                        <td><span class="category-badge category-brand" style="background: var(--danger-color); color: white; padding: 0.125rem 0.375rem; border-radius: var(--radius-sm); font-size: 0.625rem;">ブランド</span></td>
                                        <td><span class="priority-badge priority-medium" style="background: var(--warning-color); color: white; padding: 0.125rem 0.375rem; border-radius: var(--radius-sm); font-size: 0.625rem;">中</span></td>
                                        <td>89</td>
                                        <td>2025-09-02</td>
                                        <td>2025-09-09</td>
                                        <td><span class="status-badge status-active" style="background: var(--success-color); color: white; padding: 0.125rem 0.375rem; border-radius: var(--radius-sm); font-size: 0.625rem;">有効</span></td>
                                        <td>
                                            <button class="btn-sm btn-warning" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;" onclick="editKeyword(2)">編集</button>
                                            <button class="btn-sm btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.7rem;" onclick="deleteKeyword(2)">削除</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- リアルタイムタイトルチェック -->
                    <div class="title-check-section" style="background: var(--bg-tertiary); padding: var(--space-lg); border-radius: var(--radius-lg); margin-top: var(--space-lg);">
                        <div class="section-header">
                            <i class="fas fa-shield-alt"></i>
                            <h4>リアルタイムタイトルチェック</h4>
                        </div>
                        <div class="title-check-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
                            <textarea 
                                id="titleCheckInput" 
                                placeholder="商品タイトルを入力してリアルタイムチェック..."
                                class="title-input"
                                oninput="checkTitleRealtime()"
                                style="min-height: 80px; padding: var(--space-sm); border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 0.875rem;"
                            ></textarea>
                            <div class="check-result" id="titleCheckResult" style="background: var(--bg-secondary); padding: var(--space-sm); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                                <div class="result-placeholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); text-align: center;">
                                    <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: var(--space-sm);"></i>
                                    商品タイトルを入力すると、禁止キーワードをリアルタイムでチェックします
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 出品管理タブ -->
            <div id="listing" class="tab-content fade-in">
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-store"></i>
                        <h3 class="section-title">出品・管理</h3>
                    </div>
                    
                    <div class="drag-drop-area" onclick="document.getElementById('listingCsvInput').click();" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <input type="file" id="listingCsvInput" style="display: none;" accept=".csv" onchange="handleCSVUpload(event)">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 0.5rem;"></i>
                        <div class="drag-drop-text">
                            <strong>編集済みCSVをドラッグ&ドロップ</strong><br>
                            または、クリックしてファイルを選択
                        </div>
                    </div>
                    
                    <div class="notification info">
                        <i class="fas fa-info-circle"></i>
                        <span>編集済みCSVをアップロードしてeBay出品データを準備します</span>
                    </div>
                </div>
            </div>

            <!-- 在庫管理タブ -->
            <div id="inventory-mgmt" class="tab-content fade-in">
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-chart-line"></i>
                        <h3 class="section-title">在庫・売上分析ダッシュボード</h3>
                        <div style="margin-left: auto;">
                            <button class="btn btn-info" onclick="loadInventoryData()">
                                <i class="fas fa-sync"></i> データ更新
                            </button>
                        </div>
                    </div>
                    
                    <div id="inventory-content">
                        <!-- 分析カード -->
                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <div class="card-header">
                                    <i class="fas fa-dollar-sign"></i>
                                    <h4>今月の売上</h4>
                                </div>
                                <div class="card-value">$12,450</div>
                                <div class="card-change positive">+15.3%</div>
                            </div>
                            
                            <div class="analytics-card">
                                <div class="card-header">
                                    <i class="fas fa-box"></i>
                                    <h4>在庫商品数</h4>
                                </div>
                                <div class="card-value">1,247</div>
                                <div class="card-change negative">-3.2%</div>
                            </div>
                            
                            <div class="analytics-card">
                                <div class="card-header">
                                    <i class="fas fa-percentage"></i>
                                    <h4>平均利益率</h4>
                                </div>
                                <div class="card-value">28.5%</div>
                                <div class="card-change positive">+2.1%</div>
                            </div>
                            
                            <div class="analytics-card">
                                <div class="card-header">
                                    <i class="fas fa-shopping-cart"></i>
                                    <h4>今月の販売数</h4>
                                </div>
                                <div class="card-value">156</div>
                                <div class="card-change positive">+8.7%</div>
                            </div>
                        </div>
                        
                        <!-- 価格監視 -->
                        <div class="price-monitoring" style="margin-bottom: var(--space-lg);">
                            <h4>💰 価格監視アラート</h4>
                            <div class="monitoring-table">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>商品ID</th>
                                            <th>商品名</th>
                                            <th>現在価格</th>
                                            <th>価格変動</th>
                                            <th>推奨アクション</th>
                                        </tr>
                                    </thead>
                                    <tbody id="priceMonitoringBody">
                                        <tr>
                                            <td colspan="5" style="text-align: center; padding: var(--space-lg); color: var(--text-muted);">
                                                価格監視データを読み込み中...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- 在庫アラート -->
                        <div class="inventory-alerts">
                            <h4>⚠️ 在庫アラート</h4>
                            <div class="alert-list" id="inventoryAlerts">
                                <div class="notification warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>在庫監視システムを設定してください</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 🆕 eBayカテゴリー自動判定タブ -->
            <div id="ebay-category" class="tab-content fade-in">
                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-tags"></i>
                        <h3 class="section-title">eBayカテゴリー自動判定システム</h3>
                        <div style="margin-left: auto; display: flex; gap: var(--space-sm);">
                            <button class="btn btn-info" onclick="updateEbayCategoryStats()">
                                <i class="fas fa-sync"></i> 統計更新
                            </button>
                            <button class="btn btn-success" onclick="showCategoryHelp()">
                                <i class="fas fa-question-circle"></i> ヘルプ
                            </button>
                        </div>
                    </div>

                    <!-- 🆕 eBayカテゴリー統計ダッシュボード -->
                    <div class="ebay-category-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center;">
                            <div class="stat-value" id="ebayCategoriesTotal" style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">50,000</div>
                            <div class="stat-label" style="font-size: 0.75rem; color: var(--text-secondary);">総カテゴリー数</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center;">
                            <div class="stat-value" id="ebayProcessedToday" style="font-size: 1.5rem; font-weight: 700; color: var(--success-color);">245</div>
                            <div class="stat-label" style="font-size: 0.75rem; color: var(--text-secondary);">今日の判定数</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center;">
                            <div class="stat-value" id="ebayAccuracyRate" style="font-size: 1.5rem; font-weight: 700; color: var(--warning-color);">87.5%</div>
                            <div class="stat-label" style="font-size: 0.75rem; color: var(--text-secondary);">平均判定精度</div>
                        </div>
                        <div class="stat-card" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center;">
                            <div class="stat-value" id="ebayTopCategories" style="font-size: 1.5rem; font-weight: 700; color: var(--info-color);">5</div>
                            <div class="stat-label" style="font-size: 0.75rem; color: var(--text-secondary);">人気カテゴリー</div>
                        </div>
                    </div>

                    <!-- 🆕 単一商品テストツール -->
                    <div class="single-category-test" style="background: var(--bg-tertiary); padding: var(--space-lg); border-radius: var(--radius-lg); margin-bottom: var(--space-lg);">
                        <h4 style="margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-xs);">
                            <i class="fas fa-search"></i>
                            単一商品カテゴリー判定テスト
                        </h4>
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: var(--space-md); margin-bottom: var(--space-md);">
                            <div>
                                <label style="display: block; margin-bottom: 0.3rem; font-size: 0.8rem; font-weight: 600;">商品タイトル</label>
                                <input type="text" id="testCategoryTitle" placeholder="例: iPhone 14 Pro 128GB Silver" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8rem;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.3rem; font-size: 0.8rem; font-weight: 600;">価格 (USD)</label>
                                <input type="number" id="testCategoryPrice" placeholder="999.00" step="0.01" min="0" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8rem;">
                            </div>
                            <div style="display: flex; align-items: end;">
                                <button class="btn btn-primary" onclick="testSingleCategoryDetection()" style="width: 100%; height: 40px;">
                                    <i class="fas fa-play"></i> 判定実行
                                </button>
                            </div>
                        </div>
                        <div id="singleCategoryResult" style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--border-color); min-height: 80px;">
                            <div class="result-placeholder" style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                                <i class="fas fa-info-circle" style="margin-right: var(--space-xs);"></i>
                                商品タイトルを入力して「判定実行」ボタンを押してください
                            </div>
                        </div>
                    </div>

                    <!-- 🆕 CSVバッチ処理 -->
                    <div class="csv-category-batch" style="background: var(--bg-tertiary); padding: var(--space-lg); border-radius: var(--radius-lg); margin-bottom: var(--space-lg);">
                        <h4 style="margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-xs);">
                            <i class="fas fa-file-csv"></i>
                            CSV一括カテゴリー判定
                        </h4>
                        <div class="drag-drop-area" onclick="document.getElementById('categoryBatchCsvInput').click();" ondrop="handleCategoryCSVDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <input type="file" id="categoryBatchCsvInput" accept=".csv" style="display: none;" onchange="handleCategoryBatchCSV(event)">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--primary-color); margin-bottom: 0.5rem;"></i>
                            <div class="drag-drop-text">
                                <strong>商品CSVファイルをドラッグ&ドロップ</strong><br>
                                またはクリックしてファイルを選択
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                必要な列: Title, Price (オプション: Description) | 最大: 1,000行
                            </div>
                        </div>
                        <div id="categoryBatchProgress" style="display: none; margin-top: var(--space-md);">
                            <div class="progress-bar" style="width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                                <div class="progress-fill" id="categoryBatchProgressFill" style="height: 100%; background: var(--success-color); width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">
                                <span id="categoryBatchProgressText">処理中...</span>
                            </div>
                        </div>
                        <div id="categoryBatchResults" style="display: none; margin-top: var(--space-md);">
                            <!-- バッチ処理結果はJavaScriptで動的生成 -->
                        </div>
                    </div>

                    <!-- 🆕 人気カテゴリー表示 -->
                    <div class="popular-categories" style="background: var(--bg-tertiary); padding: var(--space-lg); border-radius: var(--radius-lg); margin-bottom: var(--space-lg);">
                        <h4 style="margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-xs);">
                            <i class="fas fa-trophy"></i>
                            人気カテゴリー（今月）
                        </h4>
                        <div id="popularCategoriesList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md);">
                            <!-- 人気カテゴリーはJavaScriptで動的生成 -->
                            <div class="category-item" style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                                <div class="category-name" style="font-weight: 700; margin-bottom: var(--space-xs);">Cameras & Photo</div>
                                <div class="category-count" style="color: var(--primary-color); font-weight: 600;">45件</div>
                                <div class="category-id" style="font-size: 0.75rem; color: var(--text-muted);">カテゴリーID: 625</div>
                            </div>
                            <div class="category-item" style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                                <div class="category-name" style="font-weight: 700; margin-bottom: var(--space-xs);">Wristwatches</div>
                                <div class="category-count" style="color: var(--primary-color); font-weight: 600;">34件</div>
                                <div class="category-id" style="font-size: 0.75rem; color: var(--text-muted);">カテゴリーID: 31387</div>
                            </div>
                            <div class="category-item" style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                                <div class="category-name" style="font-weight: 700; margin-bottom: var(--space-xs);">Toys & Hobbies</div>
                                <div class="category-count" style="color: var(--primary-color); font-weight: 600;">28件</div>
                                <div class="category-id" style="font-size: 0.75rem; color: var(--text-muted);">カテゴリーID: 220</div>
                            </div>
                        </div>
                    </div>

                    <!-- 🆕 手動カテゴリー検索システム -->
                    <div class="manual-category-search" style="background: var(--bg-tertiary); padding: var(--space-lg); border-radius: var(--radius-lg);">
                        <h4 style="margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-xs);">
                            <i class="fas fa-search"></i>
                            手動カテゴリー検索
                        </h4>
                        <div style="display: flex; gap: var(--space-sm); margin-bottom: var(--space-md);">
                            <input type="text" id="manualCategorySearch" placeholder="カテゴリー名を検索..." style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.8rem;">
                            <button class="btn btn-primary" onclick="searchEbayCategories()">
                                <i class="fas fa-search"></i> 検索
                            </button>
                        </div>
                        <div id="manualCategoryResults" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-md); max-height: 300px; overflow-y: auto;">
                            <div class="result-placeholder" style="display: flex; align-items: center; justify-content: center; height: 150px; color: var(--text-muted);">
                                <i class="fas fa-info-circle" style="margin-right: var(--space-xs);"></i>
                                カテゴリー名を検索してください
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- システムログ -->
        <div class="log-area">
            <h4 style="color: var(--info-color); margin-bottom: var(--space-xs); font-size: 0.8rem;">
                <i class="fas fa-history"></i> システムログ
            </h4>
            <div id="logSection">
                <div class="log-entry">
                    <span class="log-timestamp">[09:15:32]</span>
                    <span class="log-level info">INFO</span>
                    <span>システムが正常に起動しました（eBayカテゴリー統合版）。</span>
                </div>
                <div class="log-entry">
                    <span class="log-timestamp">[09:15:33]</span>
                    <span class="log-level info">INFO</span>
                    <span>データベース接続確認完了。</span>
                </div>
                <div class="log-entry">
                    <span class="log-timestamp">[09:15:34]</span>
                    <span class="log-level success">SUCCESS</span>
                    <span>eBayカテゴリー自動判定システム初期化完了。</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 🆕 JavaScript機能追加（eBayカテゴリー機能） -->
    <script>
        // eBayカテゴリー判定関数群
        
        // 単一商品カテゴリー判定テスト
        async function testSingleCategoryDetection() {
            const title = document.getElementById('testCategoryTitle').value;
            const price = document.getElementById('testCategoryPrice').value;
            
            if (!title.trim()) {
                showNotification('商品タイトルを入力してください', 'warning');
                return;
            }
            
            const resultContainer = document.getElementById('singleCategoryResult');
            resultContainer.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> 判定中...</div>';
            
            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams({
                        action: 'detect_ebay_category',
                        title: title,
                        price: price || 0,
                        csrf_token: CSRF_TOKEN
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const result = data.data;
                    resultContainer.innerHTML = `
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: var(--space-md);">
                            <div>
                                <h5 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">判定結果</h5>
                                <div style="font-weight: 700; margin-bottom: 0.25rem;">${result.category_name}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">カテゴリーID: ${result.category_id}</div>
                            </div>
                            <div>
                                <h5 style="margin: 0 0 0.5rem 0; color: var(--success-color);">信頼度</h5>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-color);">${result.confidence}%</div>
                            </div>
                            <div>
                                <h5 style="margin: 0 0 0.5rem 0; color: var(--info-color);">必須項目</h5>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.3;">${result.item_specifics ? result.item_specifics.replace(/■/g, '<br>') : '生成中...'}</div>
                            </div>
                        </div>
                    `;
                    addLogEntry('success', `カテゴリー判定完了: ${result.category_name} (${result.confidence}%)`);
                } else {
                    resultContainer.innerHTML = `
                        <div style="color: var(--danger-color); text-align: center;">
                            <i class="fas fa-exclamation-triangle"></i> ${data.message}
                        </div>
                    `;
                    addLogEntry('error', `カテゴリー判定エラー: ${data.message}`);
                }
            } catch (error) {
                resultContainer.innerHTML = `
                    <div style="color: var(--danger-color); text-align: center;">
                        <i class="fas fa-exclamation-triangle"></i> 判定処理でエラーが発生しました
                    </div>
                `;
                addLogEntry('error', `カテゴリー判定システムエラー: ${error.message}`);
            }
        }
        
        // CSV一括カテゴリー判定
        function handleCategoryBatchCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification('CSVファイルを選択してください', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                processCategoryBatchCSV(csvText);
            };
            reader.readAsText(file);
        }
        
        async function processCategoryBatchCSV(csvText) {
            const progressContainer = document.getElementById('categoryBatchProgress');
            const resultsContainer = document.getElementById('categoryBatchResults');
            const progressFill = document.getElementById('categoryBatchProgressFill');
            const progressText = document.getElementById('categoryBatchProgressText');
            
            progressContainer.style.display = 'block';
            resultsContainer.style.display = 'none';
            
            try {
                // CSV解析（簡易版）
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const csvData = [];
                
                for (let i = 1; i < Math.min(lines.length, 51); i++) { // 最大50行まで処理
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.toLowerCase()] = values[index] || '';
                    });
                    if (row.title) csvData.push(row);
                }
                
                if (csvData.length === 0) {
                    showNotification('有効なデータが見つかりませんでした', 'warning');
                    progressContainer.style.display = 'none';
                    return;
                }
                
                progressText.textContent = `${csvData.length}件のデータを処理中...`;
                
                // バッチ処理実行
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        action: 'process_ebay_category_csv',
                        csv_data: csvData,
                        csrf_token: CSRF_TOKEN
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const results = data.data;
                    progressFill.style.width = '100%';
                    progressText.textContent = `処理完了: ${results.processed_items}/${results.total_items}件`;
                    
                    // 結果表示
                    setTimeout(() => {
                        resultsContainer.innerHTML = `
                            <div style="margin-bottom: var(--space-md);">
                                <h5>処理結果サマリー</h5>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md);">
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-color);">${results.processed_items}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">処理成功</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">${results.success_rate}%</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">成功率</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--info-color);">${results.total_items}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">総件数</div>
                                    </div>
                                </div>
                            </div>
                            <div style="background: var(--bg-secondary); border-radius: var(--radius-md); padding: var(--space-md); max-height: 200px; overflow-y: auto;">
                                ${results.results.slice(0, 10).map(item => `
                                    <div style="border-bottom: 1px solid var(--border-color); padding: 0.5rem 0; display: flex; justify-content: space-between;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; font-size: 0.8rem;">${item.original.title}</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">${item.category_result.category_name}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 700; color: var(--success-color); font-size: 0.8rem;">${item.category_result.confidence}%</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">${item.category_result.category_id}</div>
                                        </div>
                                    </div>
                                `).join('')}
                                ${results.results.length > 10 ? `<div style="text-align: center; padding: 1rem; color: var(--text-muted);">... 他${results.results.length - 10}件</div>` : ''}
                            </div>
                        `;
                        resultsContainer.style.display = 'block';
                        progressContainer.style.display = 'none';
                        
                        addLogEntry('success', `CSV一括判定完了: ${results.processed_items}件処理`);
                    }, 1000);
                    
                } else {
                    progressText.textContent = 'エラー: ' + data.message;
                    addLogEntry('error', `CSV一括判定エラー: ${data.message}`);
                }
                
            } catch (error) {
                progressText.textContent = 'エラー: 処理に失敗しました';
                addLogEntry('error', `CSV処理エラー: ${error.message}`);
            }
        }
        
        // eBayカテゴリー統計更新
        async function updateEbayCategoryStats() {
            try {
                const response = await fetch(API_BASE_URL + '?action=get_ebay_category_stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.data;
                    safeUpdateElement('ebayCategoriesTotal', formatNumber(stats.total_categories));
                    safeUpdateElement('ebayProcessedToday', formatNumber(stats.processed_today));
                    safeUpdateElement('ebayAccuracyRate', stats.avg_confidence + '%');
                    safeUpdateElement('ebayTopCategories', stats.top_categories.length);
                    
                    addLogEntry('success', `eBayカテゴリー統計更新完了: ${stats.processed_today}件`);
                }
            } catch (error) {
                addLogEntry('error', `eBayカテゴリー統計更新エラー: ${error.message}`);
            }
        }
        
        // 手動カテゴリー検索
        async function searchEbayCategories() {
            const query = document.getElementById('manualCategorySearch').value;
            const resultsContainer = document.getElementById('manualCategoryResults');
            
            if (!query.trim()) {
                showNotification('検索キーワードを入力してください', 'warning');
                return;
            }
            
            resultsContainer.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> 検索中...</div>';
            
            // 模擬検索結果（実際にはAPIを呼び出し）
            setTimeout(() => {
                const mockResults = [
                    { id: '9355', name: 'Cell Phones & Smartphones', parent: 'Electronics' },
                    { id: '625', name: 'Cameras & Photo', parent: 'Electronics' },
                    { id: '31387', name: 'Wristwatches', parent: 'Jewelry & Watches' }
                ].filter(cat => cat.name.toLowerCase().includes(query.toLowerCase()));
                
                if (mockResults.length === 0) {
                    resultsContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">検索結果が見つかりませんでした</div>';
                } else {
                    resultsContainer.innerHTML = mockResults.map(cat => `
                        <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="selectEbayCategory('${cat.id}', '${cat.name}')">
                            <div style="font-weight: 600;">${cat.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">ID: ${cat.id} | 親カテゴリー: ${cat.parent}</div>
                        </div>
                    `).join('');
                }
                
                addLogEntry('info', `カテゴリー検索実行: "${query}" - ${mockResults.length}件ヒット`);
            }, 500);
        }
        
        // カテゴリー選択
        function selectEbayCategory(categoryId, categoryName) {
            showNotification(`カテゴリーを選択しました: ${categoryName} (ID: ${categoryId})`, 'success');
            addLogEntry('info', `カテゴリー選択: ${categoryName} (${categoryId})`);
        }
        
        // eBayカテゴリーヘルプ表示
        function showCategoryHelp() {
            showNotification('eBayカテゴリー自動判定システムは、商品タイトルから最適なeBayカテゴリーを自動判定し、必須項目も自動生成します。', 'info');
        }
        
        // 通知表示関数
        function showNotification(message, type = 'info') {
            // 既存の通知があれば削除
            const existing = document.querySelector('.notification-popup');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification-popup notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem;
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-xl);
                z-index: 1000;
                max-width: 400px;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            `;
            
            const typeColors = {
                success: 'var(--success-color)',
                error: 'var(--danger-color)',
                warning: 'var(--warning-color)',
                info: 'var(--info-color)'
            };
            
            const typeIcons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            notification.innerHTML = `
                <i class="${typeIcons[type]}" style="color: ${typeColors[type]};"></i>
                <span style="flex: 1;">${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            // 5秒後に自動削除
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
</body>--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                                <div class="category-name" style="font-weight: 700; margin-bottom: var(--space-xs);">Cell Phones & Smartphones</div>
                                <div class="category-count" style="color: var(--primary-color); font-weight: 600;">89件</div>
                                <div class="category-id" style="font-size: 0.75rem; color: var(--text-muted);">カテゴリーID: 9355</div>
                            </div>
                            <div class="category-item" style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                                <div class="category-name" style="font-weight: 700; margin-bottom: var(--space-xs);">Trading Card Games</div>
                                <div class="category-count" style="color: var(--primary-color); font-weight: 600;">67件</div>
                                <div class="category-id" style="font-size: 0.75rem; color: var(--text-muted);">カテゴリーID: 2536</div>
                            </div>
                            <div class="category-item" style="background: var(