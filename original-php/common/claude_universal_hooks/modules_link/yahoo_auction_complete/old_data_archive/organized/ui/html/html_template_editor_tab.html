<!-- ğŸ¨ HTMLä¿å­˜ãƒ»å·®ã—è¾¼ã¿ç®¡ç†UI -->
<div id="html-template-editor" class="tab-content fade-in">
    <div class="section">
        <div class="section-header">
            <i class="fas fa-code"></i>
            <h3 class="section-title">HTML ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†ãƒ»ä¿å­˜</h3>
            <div style="margin-left: auto; display: flex; gap: var(--space-sm);">
                <button class="btn btn-success" onclick="saveCurrentTemplate()">
                    <i class="fas fa-save"></i> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜
                </button>
                <button class="btn btn-info" onclick="previewHTML()">
                    <i class="fas fa-eye"></i> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </button>
                <button class="btn btn-warning" onclick="resetTemplate()">
                    <i class="fas fa-undo"></i> ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>
        </div>

        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ -->
        <div class="template-selector-section">
            <div class="template-selector">
                <label class="form-label">
                    <i class="fas fa-palette"></i>
                    ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ
                </label>
                <select id="baseTemplateSelect" class="form-select" onchange="loadBaseTemplate(this.value)">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    <option value="premium">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆé«˜ç´šå•†å“å‘ã‘ï¼‰</option>
                    <option value="standard">ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆä¸€èˆ¬å•†å“å‘ã‘ï¼‰</option>
                    <option value="minimal">ãƒŸãƒ‹ãƒãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰</option>
                    <option value="custom">ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆç©ºç™½ã‹ã‚‰ä½œæˆï¼‰</option>
                </select>
            </div>
        </div>

        <!-- å¤‰æ•°ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ -->
        <div class="variables-reference">
            <div class="variables-header" onclick="toggleVariablesList()">
                <h4><i class="fas fa-list"></i> ä½¿ç”¨å¯èƒ½ãªå·®ã—è¾¼ã¿å¤‰æ•° <span class="toggle-icon">â–¼</span></h4>
            </div>
            <div class="variables-list" id="variablesList" style="display: none;">
                <div class="variables-grid">
                    <div class="variable-category">
                        <h5>ğŸ“¦ åŸºæœ¬å•†å“æƒ…å ±</h5>
                        <div class="variable-item" onclick="insertVariable('{{TITLE}}')">
                            <code>{{TITLE}}</code> - å•†å“ã‚¿ã‚¤ãƒˆãƒ«
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{PRICE}}')">
                            <code>{{PRICE}}</code> - è²©å£²ä¾¡æ ¼
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{BRAND}}')">
                            <code>{{BRAND}}</code> - ãƒ–ãƒ©ãƒ³ãƒ‰å
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{CONDITION}}')">
                            <code>{{CONDITION}}</code> - å•†å“çŠ¶æ…‹
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{DESCRIPTION}}')">
                            <code>{{DESCRIPTION}}</code> - å•†å“èª¬æ˜
                        </div>
                    </div>

                    <div class="variable-category">
                        <h5>ğŸ–¼ï¸ ç”»åƒé–¢é€£</h5>
                        <div class="variable-item" onclick="insertVariable('{{MAIN_IMAGE}}')">
                            <code>{{MAIN_IMAGE}}</code> - ãƒ¡ã‚¤ãƒ³ç”»åƒ
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{IMAGE_GALLERY}}')">
                            <code>{{IMAGE_GALLERY}}</code> - ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{IMAGE_1}}')">
                            <code>{{IMAGE_1}}</code> - è¿½åŠ ç”»åƒ1
                        </div>
                    </div>

                    <div class="variable-category">
                        <h5>ğŸ“‹ è©³ç´°ä»•æ§˜</h5>
                        <div class="variable-item" onclick="insertVariable('{{SPECIFICATIONS}}')">
                            <code>{{SPECIFICATIONS}}</code> - ä»•æ§˜è¡¨
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{MODEL_NUMBER}}')">
                            <code>{{MODEL_NUMBER}}</code> - å‹ç•ª
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{COLOR}}')">
                            <code>{{COLOR}}</code> - è‰²
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{WEIGHT}}')">
                            <code>{{WEIGHT}}</code> - é‡é‡
                        </div>
                    </div>

                    <div class="variable-category">
                        <h5>ğŸšš é…é€ãƒ»è²©å£²æƒ…å ±</h5>
                        <div class="variable-item" onclick="insertVariable('{{SHIPPING_INFO}}')">
                            <code>{{SHIPPING_INFO}}</code> - é…é€æƒ…å ±
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{RETURN_POLICY}}')">
                            <code>{{RETURN_POLICY}}</code> - è¿”å“ãƒãƒªã‚·ãƒ¼
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{SELLER_INFO}}')">
                            <code>{{SELLER_INFO}}</code> - è²©å£²è€…æƒ…å ±
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HTMLã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ -->
        <div class="html-editor-container">
            <div class="editor-tabs">
                <button class="editor-tab active" data-tab="html" onclick="switchEditorTab('html')">
                    <i class="fas fa-code"></i> HTMLç·¨é›†
                </button>
                <button class="editor-tab" data-tab="preview" onclick="switchEditorTab('preview')">
                    <i class="fas fa-eye"></i> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </button>
            </div>

            <div class="editor-content">
                <div id="html-editor" class="editor-pane active">
                    <textarea id="htmlTemplateEditor" class="html-editor-textarea" placeholder="HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„...

ä¾‹:
<div class='product-listing'>
    <h1>{{TITLE}}</h1>
    <div class='price'>${{PRICE}}</div>
    <img src='{{MAIN_IMAGE}}' alt='{{TITLE}}'>
    <p>{{DESCRIPTION}}</p>
</div>"></textarea>
                </div>

                <div id="preview-pane" class="editor-pane">
                    <div class="preview-controls">
                        <label for="sampleDataSelect">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿é¸æŠ:</label>
                        <select id="sampleDataSelect" onchange="updatePreview()">
                            <option value="iphone">iPhone 15 Pro</option>
                            <option value="camera">ãƒ‡ã‚¸ã‚¿ãƒ«ã‚«ãƒ¡ãƒ©</option>
                            <option value="watch">è…•æ™‚è¨ˆ</option>
                            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿</option>
                        </select>
                        <button class="btn btn-sm btn-primary" onclick="updatePreview()">
                            <i class="fas fa-refresh"></i> æ›´æ–°
                        </button>
                    </div>
                    <div class="preview-frame" id="htmlPreviewFrame">
                        <p class="preview-placeholder">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç† -->
        <div class="template-management">
            <div class="section-header">
                <h4><i class="fas fa-folder"></i> ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h4>
                <button class="btn btn-sm btn-success" onclick="openNewTemplateModal()">
                    <i class="fas fa-plus"></i> æ–°è¦ä½œæˆ
                </button>
            </div>
            
            <div class="saved-templates-grid" id="savedTemplatesGrid">
                <!-- ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ï¼ˆJavaScript ã§å‹•çš„ç”Ÿæˆï¼‰ -->
                <div class="loading-placeholder">
                    ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ¨ å°‚ç”¨CSS -->
<style>
/* === ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ === */
.template-selector-section {
    background: var(--bg-tertiary, #f1f5f9);
    padding: var(--space-md, 1rem);
    border-radius: var(--radius-lg, 0.5rem);
    margin-bottom: var(--space-lg, 1.5rem);
}

.template-selector {
    display: flex;
    align-items: center;
    gap: var(--space-md, 1rem);
}

.template-selector .form-label {
    margin: 0;
    min-width: 200px;
    font-weight: 600;
}

.template-selector .form-select {
    flex: 1;
    max-width: 400px;
}

/* === å¤‰æ•°ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ === */
.variables-reference {
    background: var(--bg-secondary, #ffffff);
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-lg, 0.5rem);
    margin-bottom: var(--space-lg, 1.5rem);
    overflow: hidden;
}

.variables-header {
    background: var(--bg-tertiary, #f1f5f9);
    padding: var(--space-md, 1rem);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 600;
    transition: background-color 0.2s ease;
}

.variables-header:hover {
    background: var(--bg-hover, #e2e8f0);
}

.variables-list {
    padding: var(--space-md, 1rem);
    max-height: 400px;
    overflow-y: auto;
}

.variables-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-md, 1rem);
}

.variable-category h5 {
    color: var(--color-primary, #3b82f6);
    font-size: 0.875rem;
    font-weight: 700;
    margin-bottom: var(--space-sm, 0.5rem);
    padding-bottom: var(--space-xs, 0.25rem);
    border-bottom: 2px solid var(--color-primary, #3b82f6);
}

.variable-item {
    background: var(--bg-tertiary, #f1f5f9);
    padding: var(--space-sm, 0.5rem);
    border-radius: var(--radius-sm, 0.25rem);
    cursor: pointer;
    font-size: 0.75rem;
    line-height: 1.4;
    transition: all 0.2s ease;
    margin-bottom: var(--space-xs, 0.25rem);
}

.variable-item:hover {
    background: var(--color-primary, #3b82f6);
    color: white;
    transform: translateX(4px);
}

.variable-item code {
    background: rgba(0, 0, 0, 0.1);
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: 600;
    color: var(--color-primary, #3b82f6);
}

.variable-item:hover code {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

/* === HTMLã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ === */
.html-editor-container {
    background: var(--bg-secondary, #ffffff);
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-lg, 0.5rem);
    overflow: hidden;
    margin-bottom: var(--space-lg, 1.5rem);
}

.editor-tabs {
    display: flex;
    background: var(--bg-tertiary, #f1f5f9);
    border-bottom: 1px solid var(--border-color, #e2e8f0);
}

.editor-tab {
    padding: var(--space-sm, 0.5rem) var(--space-md, 1rem);
    border: none;
    background: none;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary, #475569);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: var(--space-xs, 0.25rem);
}

.editor-tab:hover {
    background: var(--bg-hover, #e2e8f0);
    color: var(--text-primary, #1e293b);
}

.editor-tab.active {
    background: var(--bg-secondary, #ffffff);
    color: var(--color-primary, #3b82f6);
    border-bottom: 2px solid var(--color-primary, #3b82f6);
}

.editor-content {
    position: relative;
    min-height: 500px;
}

.editor-pane {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    padding: var(--space-md, 1rem);
    display: none;
}

.editor-pane.active {
    display: block;
}

.html-editor-textarea {
    width: 100%;
    height: 460px;
    border: none;
    background: var(--bg-secondary, #ffffff);
    color: var(--text-primary, #1e293b);
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    resize: none;
    outline: none;
    padding: var(--space-sm, 0.5rem);
}

.preview-controls {
    display: flex;
    align-items: center;
    gap: var(--space-sm, 0.5rem);
    margin-bottom: var(--space-md, 1rem);
    padding-bottom: var(--space-sm, 0.5rem);
    border-bottom: 1px solid var(--border-color, #e2e8f0);
}

.preview-controls label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-secondary, #475569);
}

.preview-controls select {
    padding: 0.25rem 0.5rem;
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-sm, 0.25rem);
    font-size: 0.875rem;
}

.preview-frame {
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-md, 0.375rem);
    background: white;
    min-height: 400px;
    padding: var(--space-md, 1rem);
    overflow-y: auto;
}

.preview-placeholder {
    text-align: center;
    color: var(--text-muted, #64748b);
    font-style: italic;
    margin-top: 2rem;
}

/* === ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç† === */
.template-management {
    background: var(--bg-tertiary, #f1f5f9);
    border-radius: var(--radius-lg, 0.5rem);
    padding: var(--space-lg, 1.5rem);
}

.saved-templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-md, 1rem);
    margin-top: var(--space-md, 1rem);
}

.template-card {
    background: var(--bg-secondary, #ffffff);
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-md, 0.375rem);
    padding: var(--space-md, 1rem);
    transition: all 0.2s ease;
    cursor: pointer;
}

.template-card:hover {
    border-color: var(--color-primary, #3b82f6);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md, 0 4px 6px -1px rgba(0, 0, 0, 0.1));
}

.template-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: var(--space-sm, 0.5rem);
}

.template-name {
    font-weight: 600;
    color: var(--text-primary, #1e293b);
    margin: 0;
}

.template-actions {
    display: flex;
    gap: var(--space-xs, 0.25rem);
}

.template-actions button {
    padding: 0.25rem;
    border: none;
    background: none;
    color: var(--text-muted, #64748b);
    cursor: pointer;
    border-radius: var(--radius-sm, 0.25rem);
    transition: all 0.2s ease;
}

.template-actions button:hover {
    background: var(--bg-hover, #e2e8f0);
    color: var(--text-primary, #1e293b);
}

.template-description {
    font-size: 0.75rem;
    color: var(--text-secondary, #475569);
    margin-bottom: var(--space-sm, 0.5rem);
}

.template-meta {
    font-size: 0.75rem;
    color: var(--text-muted, #64748b);
    display: flex;
    justify-content: between;
}

.loading-placeholder {
    grid-column: 1 / -1;
    text-align: center;
    color: var(--text-muted, #64748b);
    font-style: italic;
    padding: var(--space-xl, 2rem);
}

/* === ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– === */
@media (max-width: 768px) {
    .variables-grid {
        grid-template-columns: 1fr;
    }
    
    .template-selector {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-sm, 0.5rem);
    }
    
    .template-selector .form-label {
        min-width: auto;
    }
    
    .saved-templates-grid {
        grid-template-columns: 1fr;
    }
    
    .html-editor-textarea {
        height: 300px;
    }
}

/* === ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ === */
.toggle-icon {
    transition: transform 0.2s ease;
}

.variables-header[aria-expanded="true"] .toggle-icon {
    transform: rotate(180deg);
}

/* === ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  === */
.form-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary, #1e293b);
    display: flex;
    align-items: center;
    gap: var(--space-xs, 0.25rem);
}

.form-select {
    padding: 0.5rem;
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-sm, 0.25rem);
    background: var(--bg-secondary, #ffffff);
    font-size: 0.875rem;
    color: var(--text-primary, #1e293b);
    transition: all 0.2s ease;
}

.form-select:focus {
    outline: none;
    border-color: var(--color-primary, #3b82f6);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
}
</style>

<script>
// ğŸ”§ HTMLå·®ã—è¾¼ã¿ã‚·ã‚¹ãƒ†ãƒ  JavaScript
let htmlTemplateProcessor = null;
let currentTemplate = '';

// ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¨ HTMLå·®ã—è¾¼ã¿ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...');
    
    // HTMLTemplateProcessorã‚’åˆæœŸåŒ–
    if (typeof HTMLTemplateProcessor !== 'undefined') {
        htmlTemplateProcessor = new HTMLTemplateProcessor();
        console.log('âœ… HTMLTemplateProcessor åˆæœŸåŒ–å®Œäº†');
    }
    
    // ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
    loadSavedTemplates();
});

// å¤‰æ•°ãƒªã‚¹ãƒˆè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
function toggleVariablesList() {
    const variablesList = document.getElementById('variablesList');
    const toggleIcon = document.querySelector('.toggle-icon');
    const header = document.querySelector('.variables-header');
    
    if (variablesList.style.display === 'none') {
        variablesList.style.display = 'block';
        header.setAttribute('aria-expanded', 'true');
    } else {
        variablesList.style.display = 'none';
        header.setAttribute('aria-expanded', 'false');
    }
}

// ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
function loadBaseTemplate(templateType) {
    if (!htmlTemplateProcessor) {
        console.error('HTMLTemplateProcessor ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    const templates = htmlTemplateProcessor.getTemplateExamples();
    const editor = document.getElementById('htmlTemplateEditor');
    
    switch(templateType) {
        case 'premium':
            editor.value = templates.premium;
            break;
        case 'standard':
            editor.value = templates.standard;
            break;
        case 'minimal':
            editor.value = templates.minimal;
            break;
        case 'custom':
            editor.value = '';
            break;
        default:
            return;
    }
    
    currentTemplate = templateType;
    console.log(`ğŸ“„ ${templateType}ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
}

// å¤‰æ•°æŒ¿å…¥
function insertVariable(variable) {
    const editor = document.getElementById('htmlTemplateEditor');
    const startPos = editor.selectionStart;
    const endPos = editor.selectionEnd;
    const currentValue = editor.value;
    
    const newValue = currentValue.substring(0, startPos) + variable + currentValue.substring(endPos);
    editor.value = newValue;
    
    // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å¤‰æ•°ã®å¾Œã«ç§»å‹•
    const newCursorPos = startPos + variable.length;
    editor.setSelectionRange(newCursorPos, newCursorPos);
    editor.focus();
    
    console.log(`ğŸ“ å¤‰æ•° ${variable} ã‚’æŒ¿å…¥ã—ã¾ã—ãŸ`);
}

// ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchEditorTab(tabName) {
    // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.editor-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒšã‚¤ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.editor-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    if (tabName === 'html') {
        document.getElementById('html-editor').classList.add('active');
    } else if (tabName === 'preview') {
        document.getElementById('preview-pane').classList.add('active');
        updatePreview(); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    }
}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
function updatePreview() {
    if (!htmlTemplateProcessor) {
        document.getElementById('htmlPreviewFrame').innerHTML = '<p class="preview-placeholder">HTMLTemplateProcessor ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
        return;
    }
    
    const templateHtml = document.getElementById('htmlTemplateEditor').value;
    const sampleDataType = document.getElementById('sampleDataSelect').value;
    
    if (!templateHtml.trim()) {
        document.getElementById('htmlPreviewFrame').innerHTML = '<p class="preview-placeholder">HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
        return;
    }
    
    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—
    const sampleData = getSampleProductData(sampleDataType);
    
    try {
        // HTMLç”Ÿæˆ
        const processedHtml = htmlTemplateProcessor.processTemplate(templateHtml, sampleData);
        document.getElementById('htmlPreviewFrame').innerHTML = processedHtml;
        console.log('ğŸ”„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
    } catch (error) {
        console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('htmlPreviewFrame').innerHTML = `<p style="color: red;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
    }
}

// ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—
function getSampleProductData(dataType) {
    const sampleData = {
        iphone: {
            title: 'iPhone 15 Pro 128GB Natural Titanium Unlocked',
            start_price: 650.00,
            brand: 'Apple',
            condition_id: 1000,
            description: 'Brand new iPhone 15 Pro in Natural Titanium. Factory unlocked, works with any carrier worldwide. Features the new A17 Pro chip with incredible performance.',
            pic_url: 'https://via.placeholder.com/400x400/333/fff?text=iPhone+15+Pro',
            mpn: 'A2848',
            color: 'Natural Titanium',
            weight_kg: 0.187,
            length_cm: 15.9,
            width_cm: 7.6,
            height_cm: 0.83,
            shipping_international_usd: 25.00
        },
        camera: {
            title: 'Canon EOS R6 Mark II Mirrorless Camera Body',
            start_price: 1200.00,
            brand: 'Canon',
            condition_id: 1000,
            description: 'Professional mirrorless camera with advanced features for photography and videography. Excellent condition, barely used.',
            pic_url: 'https://via.placeholder.com/400x400/222/fff?text=Canon+R6+II',
            mpn: 'EOS R6 Mark II',
            color: 'Black',
            weight_kg: 0.588,
            shipping_international_usd: 35.00
        },
        watch: {
            title: 'Rolex Submariner Date 116610LN Black Dial',
            start_price: 8500.00,
            brand: 'Rolex',
            condition_id: 3000,
            description: 'Authentic Rolex Submariner with box and papers. Excellent condition, serviced recently. A timeless classic.',
            pic_url: 'https://via.placeholder.com/400x400/000/fff?text=Rolex+Sub',
            mpn: '116610LN',
            color: 'Black',
            weight_kg: 0.15,
            shipping_international_usd: 50.00
        }
    };
    
    return sampleData[dataType] || sampleData.iphone;
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜
function saveCurrentTemplate() {
    const templateHtml = document.getElementById('htmlTemplateEditor').value;
    if (!templateHtml.trim()) {
        alert('ä¿å­˜ã™ã‚‹HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    const templateName = prompt('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', currentTemplate || 'ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ');
    if (!templateName) return;
    
    const templateData = {
        name: templateName,
        html_content: templateHtml,
        description: `ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ - ${new Date().toLocaleDateString()}`,
        category: 'custom'
    };
    
    // APIã§ä¿å­˜
    fetch('database_csv_handler_ebay_complete_v2.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=save_html_template&template_id=${encodeURIComponent(templateName)}&name=${encodeURIComponent(templateData.name)}&description=${encodeURIComponent(templateData.description)}&html_content=${encodeURIComponent(templateData.html_content)}&category=${templateData.category}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ');
            loadSavedTemplates(); // ä¸€è¦§æ›´æ–°
        } else {
            alert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
    })
    .catch(error => {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
function previewHTML() {
    updatePreview();
    switchEditorTab('preview');
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªã‚»ãƒƒãƒˆ
function resetTemplate() {
    if (confirm('ç¾åœ¨ã®ç·¨é›†å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        document.getElementById('htmlTemplateEditor').value = '';
        document.getElementById('baseTemplateSelect').value = '';
        currentTemplate = '';
        console.log('ğŸ”„ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    }
}

// ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
function loadSavedTemplates() {
    fetch('database_csv_handler_ebay_complete_v2.php?action=get_all_templates')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySavedTemplates(data.data);
            } else {
                console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', data.error);
                document.getElementById('savedTemplatesGrid').innerHTML = 
                    '<div class="loading-placeholder">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        })
        .catch(error => {
            console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('savedTemplatesGrid').innerHTML = 
                '<div class="loading-placeholder">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
}

// ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¡¨ç¤º
function displaySavedTemplates(templates) {
    const grid = document.getElementById('savedTemplatesGrid');
    
    if (!templates || templates.length === 0) {
        grid.innerHTML = '<div class="loading-placeholder">ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
    }
    
    const templateCards = templates.map(template => `
        <div class="template-card" onclick="loadSavedTemplate('${template.template_id}')">
            <div class="template-card-header">
                <h5 class="template-name">${template.name || template.template_id}</h5>
                <div class="template-actions">
                    <button onclick="event.stopPropagation(); editTemplate('${template.template_id}')" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteTemplate('${template.template_id}')" title="å‰Šé™¤">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="template-description">
                ${template.description || 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª¬æ˜ãªã—'}
            </div>
            <div class="template-meta">
                <span>æ›´æ–°: ${new Date(template.updated_at || template.created_at).toLocaleDateString()}</span>
            </div>
        </div>
    `).join('');
    
    grid.innerHTML = templateCards;
    console.log(`ğŸ“‹ ${templates.length}å€‹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
}

// ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
function loadSavedTemplate(templateId) {
    fetch(`database_csv_handler_ebay_complete_v2.php?action=get_html_template&template_id=${encodeURIComponent(templateId)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                document.getElementById('htmlTemplateEditor').value = data.data.html_content || '';
                document.getElementById('baseTemplateSelect').value = '';
                currentTemplate = templateId;
                console.log(`ğŸ“„ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ "${templateId}" ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            } else {
                alert('âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        })
        .catch(error => {
            console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            alert('âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        });
}

console.log('ğŸ¨ HTMLå·®ã—è¾¼ã¿UIåˆæœŸåŒ–å®Œäº†');
</script>