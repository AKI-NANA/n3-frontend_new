<!-- 🎨 HTML保存・差し込み管理UI -->
<div id="html-template-editor" class="tab-content fade-in">
    <div class="section">
        <div class="section-header">
            <i class="fas fa-code"></i>
            <h3 class="section-title">HTML テンプレート編集・保存</h3>
            <div style="margin-left: auto; display: flex; gap: var(--space-sm);">
                <button class="btn btn-success" onclick="saveCurrentTemplate()">
                    <i class="fas fa-save"></i> テンプレート保存
                </button>
                <button class="btn btn-info" onclick="previewHTML()">
                    <i class="fas fa-eye"></i> プレビュー
                </button>
                <button class="btn btn-warning" onclick="resetTemplate()">
                    <i class="fas fa-undo"></i> リセット
                </button>
            </div>
        </div>

        <!-- テンプレート選択 -->
        <div class="template-selector-section">
            <div class="template-selector">
                <label class="form-label">
                    <i class="fas fa-palette"></i>
                    ベーステンプレート選択
                </label>
                <select id="baseTemplateSelect" class="form-select" onchange="loadBaseTemplate(this.value)">
                    <option value="">選択してください</option>
                    <option value="premium">プレミアムテンプレート（高級商品向け）</option>
                    <option value="standard">スタンダードテンプレート（一般商品向け）</option>
                    <option value="minimal">ミニマルテンプレート（シンプル）</option>
                    <option value="custom">カスタムテンプレート（空白から作成）</option>
                </select>
            </div>
        </div>

        <!-- 変数リファレンス -->
        <div class="variables-reference">
            <div class="variables-header" onclick="toggleVariablesList()">
                <h4><i class="fas fa-list"></i> 使用可能な差し込み変数 <span class="toggle-icon">▼</span></h4>
            </div>
            <div class="variables-list" id="variablesList" style="display: none;">
                <div class="variables-grid">
                    <div class="variable-category">
                        <h5>📦 基本商品情報</h5>
                        <div class="variable-item" onclick="insertVariable('{{TITLE}}')">
                            <code>{{TITLE}}</code> - 商品タイトル
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{PRICE}}')">
                            <code>{{PRICE}}</code> - 販売価格
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{BRAND}}')">
                            <code>{{BRAND}}</code> - ブランド名
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{CONDITION}}')">
                            <code>{{CONDITION}}</code> - 商品状態
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{DESCRIPTION}}')">
                            <code>{{DESCRIPTION}}</code> - 商品説明
                        </div>
                    </div>

                    <div class="variable-category">
                        <h5>🖼️ 画像関連</h5>
                        <div class="variable-item" onclick="insertVariable('{{MAIN_IMAGE}}')">
                            <code>{{MAIN_IMAGE}}</code> - メイン画像
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{IMAGE_GALLERY}}')">
                            <code>{{IMAGE_GALLERY}}</code> - 画像ギャラリー
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{IMAGE_1}}')">
                            <code>{{IMAGE_1}}</code> - 追加画像1
                        </div>
                    </div>

                    <div class="variable-category">
                        <h5>📋 詳細仕様</h5>
                        <div class="variable-item" onclick="insertVariable('{{SPECIFICATIONS}}')">
                            <code>{{SPECIFICATIONS}}</code> - 仕様表
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{MODEL_NUMBER}}')">
                            <code>{{MODEL_NUMBER}}</code> - 型番
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{COLOR}}')">
                            <code>{{COLOR}}</code> - 色
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{WEIGHT}}')">
                            <code>{{WEIGHT}}</code> - 重量
                        </div>
                    </div>

                    <div class="variable-category">
                        <h5>🚚 配送・販売情報</h5>
                        <div class="variable-item" onclick="insertVariable('{{SHIPPING_INFO}}')">
                            <code>{{SHIPPING_INFO}}</code> - 配送情報
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{RETURN_POLICY}}')">
                            <code>{{RETURN_POLICY}}</code> - 返品ポリシー
                        </div>
                        <div class="variable-item" onclick="insertVariable('{{SELLER_INFO}}')">
                            <code>{{SELLER_INFO}}</code> - 販売者情報
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HTMLエディター -->
        <div class="html-editor-container">
            <div class="editor-tabs">
                <button class="editor-tab active" data-tab="html" onclick="switchEditorTab('html')">
                    <i class="fas fa-code"></i> HTML編集
                </button>
                <button class="editor-tab" data-tab="preview" onclick="switchEditorTab('preview')">
                    <i class="fas fa-eye"></i> プレビュー
                </button>
            </div>

            <div class="editor-content">
                <div id="html-editor" class="editor-pane active">
                    <textarea id="htmlTemplateEditor" class="html-editor-textarea" placeholder="HTMLテンプレートをここに入力してください...

例:
<div class='product-listing'>
    <h1>{{TITLE}}</h1>
    <div class='price'>${{PRICE}}</div>
    <img src='{{MAIN_IMAGE}}' alt='{{TITLE}}'>
    <p>{{DESCRIPTION}}</p>
</div>"></textarea>
                </div>

                <div id="preview-pane" class="editor-pane">
                    <div class="preview-controls">
                        <label for="sampleDataSelect">サンプルデータ選択:</label>
                        <select id="sampleDataSelect" onchange="updatePreview()">
                            <option value="iphone">iPhone 15 Pro</option>
                            <option value="camera">デジタルカメラ</option>
                            <option value="watch">腕時計</option>
                            <option value="custom">カスタムデータ</option>
                        </select>
                        <button class="btn btn-sm btn-primary" onclick="updatePreview()">
                            <i class="fas fa-refresh"></i> 更新
                        </button>
                    </div>
                    <div class="preview-frame" id="htmlPreviewFrame">
                        <p class="preview-placeholder">プレビューを表示するには「プレビュー」ボタンを押してください</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- テンプレート管理 -->
        <div class="template-management">
            <div class="section-header">
                <h4><i class="fas fa-folder"></i> 保存済みテンプレート</h4>
                <button class="btn btn-sm btn-success" onclick="openNewTemplateModal()">
                    <i class="fas fa-plus"></i> 新規作成
                </button>
            </div>
            
            <div class="saved-templates-grid" id="savedTemplatesGrid">
                <!-- 保存済みテンプレート一覧（JavaScript で動的生成） -->
                <div class="loading-placeholder">
                    テンプレート一覧を読み込み中...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 🎨 専用CSS -->
<style>
/* === テンプレート選択 === */
.template-selector-section {
    background: var(--bg-tertiary, #f1f5f9);
    padding: var(--space-md, 1rem);
    border-radius: var(--radius-lg, 0.5rem);
    margin-bottom: var(--space-lg, 1.5rem);
}

.template-selector {
    display: flex;
    align-items: center;
    gap: var(--space-md, 1rem);
}

.template-selector .form-label {
    margin: 0;
    min-width: 200px;
    font-weight: 600;
}

.template-selector .form-select {
    flex: 1;
    max-width: 400px;
}

/* === 変数リファレンス === */
.variables-reference {
    background: var(--bg-secondary, #ffffff);
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-lg, 0.5rem);
    margin-bottom: var(--space-lg, 1.5rem);
    overflow: hidden;
}

.variables-header {
    background: var(--bg-tertiary, #f1f5f9);
    padding: var(--space-md, 1rem);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 600;
    transition: background-color 0.2s ease;
}

.variables-header:hover {
    background: var(--bg-hover, #e2e8f0);
}

.variables-list {
    padding: var(--space-md, 1rem);
    max-height: 400px;
    overflow-y: auto;
}

.variables-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-md, 1rem);
}

.variable-category h5 {
    color: var(--color-primary, #3b82f6);
    font-size: 0.875rem;
    font-weight: 700;
    margin-bottom: var(--space-sm, 0.5rem);
    padding-bottom: var(--space-xs, 0.25rem);
    border-bottom: 2px solid var(--color-primary, #3b82f6);
}

.variable-item {
    background: var(--bg-tertiary, #f1f5f9);
    padding: var(--space-sm, 0.5rem);
    border-radius: var(--radius-sm, 0.25rem);
    cursor: pointer;
    font-size: 0.75rem;
    line-height: 1.4;
    transition: all 0.2s ease;
    margin-bottom: var(--space-xs, 0.25rem);
}

.variable-item:hover {
    background: var(--color-primary, #3b82f6);
    color: white;
    transform: translateX(4px);
}

.variable-item code {
    background: rgba(0, 0, 0, 0.1);
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: 600;
    color: var(--color-primary, #3b82f6);
}

.variable-item:hover code {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

/* === HTMLエディター === */
.html-editor-container {
    background: var(--bg-secondary, #ffffff);
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-lg, 0.5rem);
    overflow: hidden;
    margin-bottom: var(--space-lg, 1.5rem);
}

.editor-tabs {
    display: flex;
    background: var(--bg-tertiary, #f1f5f9);
    border-bottom: 1px solid var(--border-color, #e2e8f0);
}

.editor-tab {
    padding: var(--space-sm, 0.5rem) var(--space-md, 1rem);
    border: none;
    background: none;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary, #475569);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: var(--space-xs, 0.25rem);
}

.editor-tab:hover {
    background: var(--bg-hover, #e2e8f0);
    color: var(--text-primary, #1e293b);
}

.editor-tab.active {
    background: var(--bg-secondary, #ffffff);
    color: var(--color-primary, #3b82f6);
    border-bottom: 2px solid var(--color-primary, #3b82f6);
}

.editor-content {
    position: relative;
    min-height: 500px;
}

.editor-pane {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    padding: var(--space-md, 1rem);
    display: none;
}

.editor-pane.active {
    display: block;
}

.html-editor-textarea {
    width: 100%;
    height: 460px;
    border: none;
    background: var(--bg-secondary, #ffffff);
    color: var(--text-primary, #1e293b);
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    resize: none;
    outline: none;
    padding: var(--space-sm, 0.5rem);
}

.preview-controls {
    display: flex;
    align-items: center;
    gap: var(--space-sm, 0.5rem);
    margin-bottom: var(--space-md, 1rem);
    padding-bottom: var(--space-sm, 0.5rem);
    border-bottom: 1px solid var(--border-color, #e2e8f0);
}

.preview-controls label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-secondary, #475569);
}

.preview-controls select {
    padding: 0.25rem 0.5rem;
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-sm, 0.25rem);
    font-size: 0.875rem;
}

.preview-frame {
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-md, 0.375rem);
    background: white;
    min-height: 400px;
    padding: var(--space-md, 1rem);
    overflow-y: auto;
}

.preview-placeholder {
    text-align: center;
    color: var(--text-muted, #64748b);
    font-style: italic;
    margin-top: 2rem;
}

/* === テンプレート管理 === */
.template-management {
    background: var(--bg-tertiary, #f1f5f9);
    border-radius: var(--radius-lg, 0.5rem);
    padding: var(--space-lg, 1.5rem);
}

.saved-templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-md, 1rem);
    margin-top: var(--space-md, 1rem);
}

.template-card {
    background: var(--bg-secondary, #ffffff);
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-md, 0.375rem);
    padding: var(--space-md, 1rem);
    transition: all 0.2s ease;
    cursor: pointer;
}

.template-card:hover {
    border-color: var(--color-primary, #3b82f6);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md, 0 4px 6px -1px rgba(0, 0, 0, 0.1));
}

.template-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: var(--space-sm, 0.5rem);
}

.template-name {
    font-weight: 600;
    color: var(--text-primary, #1e293b);
    margin: 0;
}

.template-actions {
    display: flex;
    gap: var(--space-xs, 0.25rem);
}

.template-actions button {
    padding: 0.25rem;
    border: none;
    background: none;
    color: var(--text-muted, #64748b);
    cursor: pointer;
    border-radius: var(--radius-sm, 0.25rem);
    transition: all 0.2s ease;
}

.template-actions button:hover {
    background: var(--bg-hover, #e2e8f0);
    color: var(--text-primary, #1e293b);
}

.template-description {
    font-size: 0.75rem;
    color: var(--text-secondary, #475569);
    margin-bottom: var(--space-sm, 0.5rem);
}

.template-meta {
    font-size: 0.75rem;
    color: var(--text-muted, #64748b);
    display: flex;
    justify-content: between;
}

.loading-placeholder {
    grid-column: 1 / -1;
    text-align: center;
    color: var(--text-muted, #64748b);
    font-style: italic;
    padding: var(--space-xl, 2rem);
}

/* === レスポンシブ === */
@media (max-width: 768px) {
    .variables-grid {
        grid-template-columns: 1fr;
    }
    
    .template-selector {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-sm, 0.5rem);
    }
    
    .template-selector .form-label {
        min-width: auto;
    }
    
    .saved-templates-grid {
        grid-template-columns: 1fr;
    }
    
    .html-editor-textarea {
        height: 300px;
    }
}

/* === アニメーション === */
.toggle-icon {
    transition: transform 0.2s ease;
}

.variables-header[aria-expanded="true"] .toggle-icon {
    transform: rotate(180deg);
}

/* === フォーム要素 === */
.form-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary, #1e293b);
    display: flex;
    align-items: center;
    gap: var(--space-xs, 0.25rem);
}

.form-select {
    padding: 0.5rem;
    border: 1px solid var(--border-color, #e2e8f0);
    border-radius: var(--radius-sm, 0.25rem);
    background: var(--bg-secondary, #ffffff);
    font-size: 0.875rem;
    color: var(--text-primary, #1e293b);
    transition: all 0.2s ease;
}

.form-select:focus {
    outline: none;
    border-color: var(--color-primary, #3b82f6);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
}
</style>

<script>
// 🔧 HTML差し込みシステム JavaScript
let htmlTemplateProcessor = null;
let currentTemplate = '';

// システム初期化
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎨 HTML差し込みシステム初期化中...');
    
    // HTMLTemplateProcessorを初期化
    if (typeof HTMLTemplateProcessor !== 'undefined') {
        htmlTemplateProcessor = new HTMLTemplateProcessor();
        console.log('✅ HTMLTemplateProcessor 初期化完了');
    }
    
    // 保存済みテンプレート読み込み
    loadSavedTemplates();
});

// 変数リスト表示切り替え
function toggleVariablesList() {
    const variablesList = document.getElementById('variablesList');
    const toggleIcon = document.querySelector('.toggle-icon');
    const header = document.querySelector('.variables-header');
    
    if (variablesList.style.display === 'none') {
        variablesList.style.display = 'block';
        header.setAttribute('aria-expanded', 'true');
    } else {
        variablesList.style.display = 'none';
        header.setAttribute('aria-expanded', 'false');
    }
}

// ベーステンプレート読み込み
function loadBaseTemplate(templateType) {
    if (!htmlTemplateProcessor) {
        console.error('HTMLTemplateProcessor が初期化されていません');
        return;
    }
    
    const templates = htmlTemplateProcessor.getTemplateExamples();
    const editor = document.getElementById('htmlTemplateEditor');
    
    switch(templateType) {
        case 'premium':
            editor.value = templates.premium;
            break;
        case 'standard':
            editor.value = templates.standard;
            break;
        case 'minimal':
            editor.value = templates.minimal;
            break;
        case 'custom':
            editor.value = '';
            break;
        default:
            return;
    }
    
    currentTemplate = templateType;
    console.log(`📄 ${templateType}テンプレートを読み込みました`);
}

// 変数挿入
function insertVariable(variable) {
    const editor = document.getElementById('htmlTemplateEditor');
    const startPos = editor.selectionStart;
    const endPos = editor.selectionEnd;
    const currentValue = editor.value;
    
    const newValue = currentValue.substring(0, startPos) + variable + currentValue.substring(endPos);
    editor.value = newValue;
    
    // カーソル位置を変数の後に移動
    const newCursorPos = startPos + variable.length;
    editor.setSelectionRange(newCursorPos, newCursorPos);
    editor.focus();
    
    console.log(`📝 変数 ${variable} を挿入しました`);
}

// エディタータブ切り替え
function switchEditorTab(tabName) {
    // タブボタンのアクティブ状態切り替え
    document.querySelectorAll('.editor-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // エディターペインの表示切り替え
    document.querySelectorAll('.editor-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    if (tabName === 'html') {
        document.getElementById('html-editor').classList.add('active');
    } else if (tabName === 'preview') {
        document.getElementById('preview-pane').classList.add('active');
        updatePreview(); // プレビュー更新
    }
}

// プレビュー更新
function updatePreview() {
    if (!htmlTemplateProcessor) {
        document.getElementById('htmlPreviewFrame').innerHTML = '<p class="preview-placeholder">HTMLTemplateProcessor が初期化されていません</p>';
        return;
    }
    
    const templateHtml = document.getElementById('htmlTemplateEditor').value;
    const sampleDataType = document.getElementById('sampleDataSelect').value;
    
    if (!templateHtml.trim()) {
        document.getElementById('htmlPreviewFrame').innerHTML = '<p class="preview-placeholder">HTMLテンプレートを入力してください</p>';
        return;
    }
    
    // サンプルデータ取得
    const sampleData = getSampleProductData(sampleDataType);
    
    try {
        // HTML生成
        const processedHtml = htmlTemplateProcessor.processTemplate(templateHtml, sampleData);
        document.getElementById('htmlPreviewFrame').innerHTML = processedHtml;
        console.log('🔄 プレビューを更新しました');
    } catch (error) {
        console.error('プレビュー生成エラー:', error);
        document.getElementById('htmlPreviewFrame').innerHTML = `<p style="color: red;">プレビュー生成エラー: ${error.message}</p>`;
    }
}

// サンプルデータ取得
function getSampleProductData(dataType) {
    const sampleData = {
        iphone: {
            title: 'iPhone 15 Pro 128GB Natural Titanium Unlocked',
            start_price: 650.00,
            brand: 'Apple',
            condition_id: 1000,
            description: 'Brand new iPhone 15 Pro in Natural Titanium. Factory unlocked, works with any carrier worldwide. Features the new A17 Pro chip with incredible performance.',
            pic_url: 'https://via.placeholder.com/400x400/333/fff?text=iPhone+15+Pro',
            mpn: 'A2848',
            color: 'Natural Titanium',
            weight_kg: 0.187,
            length_cm: 15.9,
            width_cm: 7.6,
            height_cm: 0.83,
            shipping_international_usd: 25.00
        },
        camera: {
            title: 'Canon EOS R6 Mark II Mirrorless Camera Body',
            start_price: 1200.00,
            brand: 'Canon',
            condition_id: 1000,
            description: 'Professional mirrorless camera with advanced features for photography and videography. Excellent condition, barely used.',
            pic_url: 'https://via.placeholder.com/400x400/222/fff?text=Canon+R6+II',
            mpn: 'EOS R6 Mark II',
            color: 'Black',
            weight_kg: 0.588,
            shipping_international_usd: 35.00
        },
        watch: {
            title: 'Rolex Submariner Date 116610LN Black Dial',
            start_price: 8500.00,
            brand: 'Rolex',
            condition_id: 3000,
            description: 'Authentic Rolex Submariner with box and papers. Excellent condition, serviced recently. A timeless classic.',
            pic_url: 'https://via.placeholder.com/400x400/000/fff?text=Rolex+Sub',
            mpn: '116610LN',
            color: 'Black',
            weight_kg: 0.15,
            shipping_international_usd: 50.00
        }
    };
    
    return sampleData[dataType] || sampleData.iphone;
}

// テンプレート保存
function saveCurrentTemplate() {
    const templateHtml = document.getElementById('htmlTemplateEditor').value;
    if (!templateHtml.trim()) {
        alert('保存するHTMLテンプレートがありません');
        return;
    }
    
    const templateName = prompt('テンプレート名を入力してください:', currentTemplate || 'カスタムテンプレート');
    if (!templateName) return;
    
    const templateData = {
        name: templateName,
        html_content: templateHtml,
        description: `カスタムテンプレート - ${new Date().toLocaleDateString()}`,
        category: 'custom'
    };
    
    // APIで保存
    fetch('database_csv_handler_ebay_complete_v2.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=save_html_template&template_id=${encodeURIComponent(templateName)}&name=${encodeURIComponent(templateData.name)}&description=${encodeURIComponent(templateData.description)}&html_content=${encodeURIComponent(templateData.html_content)}&category=${templateData.category}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ テンプレートが保存されました');
            loadSavedTemplates(); // 一覧更新
        } else {
            alert('❌ 保存に失敗しました: ' + (data.error || '不明なエラー'));
        }
    })
    .catch(error => {
        console.error('保存エラー:', error);
        alert('❌ 保存に失敗しました');
    });
}

// プレビュー表示
function previewHTML() {
    updatePreview();
    switchEditorTab('preview');
}

// テンプレートリセット
function resetTemplate() {
    if (confirm('現在の編集内容をリセットしますか？')) {
        document.getElementById('htmlTemplateEditor').value = '';
        document.getElementById('baseTemplateSelect').value = '';
        currentTemplate = '';
        console.log('🔄 テンプレートをリセットしました');
    }
}

// 保存済みテンプレート読み込み
function loadSavedTemplates() {
    fetch('database_csv_handler_ebay_complete_v2.php?action=get_all_templates')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySavedTemplates(data.data);
            } else {
                console.error('テンプレート読み込みエラー:', data.error);
                document.getElementById('savedTemplatesGrid').innerHTML = 
                    '<div class="loading-placeholder">テンプレートの読み込みに失敗しました</div>';
            }
        })
        .catch(error => {
            console.error('テンプレート読み込みエラー:', error);
            document.getElementById('savedTemplatesGrid').innerHTML = 
                '<div class="loading-placeholder">テンプレートの読み込みに失敗しました</div>';
        });
}

// 保存済みテンプレート表示
function displaySavedTemplates(templates) {
    const grid = document.getElementById('savedTemplatesGrid');
    
    if (!templates || templates.length === 0) {
        grid.innerHTML = '<div class="loading-placeholder">保存されたテンプレートがありません</div>';
        return;
    }
    
    const templateCards = templates.map(template => `
        <div class="template-card" onclick="loadSavedTemplate('${template.template_id}')">
            <div class="template-card-header">
                <h5 class="template-name">${template.name || template.template_id}</h5>
                <div class="template-actions">
                    <button onclick="event.stopPropagation(); editTemplate('${template.template_id}')" title="編集">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteTemplate('${template.template_id}')" title="削除">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="template-description">
                ${template.description || 'テンプレートの説明なし'}
            </div>
            <div class="template-meta">
                <span>更新: ${new Date(template.updated_at || template.created_at).toLocaleDateString()}</span>
            </div>
        </div>
    `).join('');
    
    grid.innerHTML = templateCards;
    console.log(`📋 ${templates.length}個のテンプレートを表示しました`);
}

// 保存済みテンプレート読み込み
function loadSavedTemplate(templateId) {
    fetch(`database_csv_handler_ebay_complete_v2.php?action=get_html_template&template_id=${encodeURIComponent(templateId)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                document.getElementById('htmlTemplateEditor').value = data.data.html_content || '';
                document.getElementById('baseTemplateSelect').value = '';
                currentTemplate = templateId;
                console.log(`📄 テンプレート "${templateId}" を読み込みました`);
            } else {
                alert('❌ テンプレートの読み込みに失敗しました');
            }
        })
        .catch(error => {
            console.error('テンプレート読み込みエラー:', error);
            alert('❌ テンプレートの読み込みに失敗しました');
        });
}

console.log('🎨 HTML差し込みUI初期化完了');
</script>