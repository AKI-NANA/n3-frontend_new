<?php
/**
 * HTML„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éó„É≠„Çª„ÉÉ„Çµ„Éº - CSVÁµ±Âêà„Ç∑„Çπ„ÉÜ„É†
 * ‰ΩúÊàêÊó•: 2025-09-13
 * Ê©üËÉΩ: HTML„ÉÜ„É≥„Éó„É¨„Éº„Éà„Å®CSV„Éá„Éº„Çø„ÅÆÁµ±Âêà„ÉªÂá∫ÂìÅÊîØÊè¥
 */

class HTMLTemplateProcessor {
    private $pdo;
    private $templates = [];
    private $errors = [];
    
    public function __construct() {
        $this->pdo = getDatabaseConnection();
        $this->loadTemplates();
    }
    
    /**
     * ‰øùÂ≠òÊ∏à„ÅøHTML„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂèñÂæó
     */
    public function getTemplates($category = null, $active_only = true) {
        try {
            $sql = "SELECT * FROM product_html_templates WHERE 1=1";
            $params = [];
            
            if ($active_only) {
                $sql .= " AND is_active = TRUE";
            }
            
            if ($category) {
                $sql .= " AND category = ?";
                $params[] = $category;
            }
            
            $sql .= " ORDER BY usage_count DESC, created_at DESC";
            
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute($params);
            
            return $stmt->fetchAll(PDO::FETCH_ASSOC);
        } catch (Exception $e) {
            $this->errors[] = "„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂèñÂæó„Ç®„É©„Éº: " . $e->getMessage();
            return [];
        }
    }
    
    /**
     * HTML„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò
     */
    public function saveTemplate($templateData) {
        try {
            $sql = "INSERT INTO product_html_templates (
                template_name, category, display_name, description, 
                html_content, css_styles, javascript_code, 
                placeholder_fields, sample_data, created_by
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ON CONFLICT (template_name) 
            DO UPDATE SET
                category = EXCLUDED.category,
                display_name = EXCLUDED.display_name,
                description = EXCLUDED.description,
                html_content = EXCLUDED.html_content,
                css_styles = EXCLUDED.css_styles,
                javascript_code = EXCLUDED.javascript_code,
                placeholder_fields = EXCLUDED.placeholder_fields,
                sample_data = EXCLUDED.sample_data,
                updated_at = NOW()
            RETURNING template_id";
            
            $stmt = $this->pdo->prepare($sql);
            $result = $stmt->execute([
                $templateData['template_name'],
                $templateData['category'] ?? 'general',
                $templateData['display_name'] ?? $templateData['template_name'],
                $templateData['description'] ?? '',
                $templateData['html_content'],
                $templateData['css_styles'] ?? '',
                $templateData['javascript_code'] ?? '',
                json_encode($templateData['placeholder_fields'] ?? []),
                json_encode($templateData['sample_data'] ?? []),
                $templateData['created_by'] ?? 'user'
            ]);
            
            if ($result) {
                $templateId = $stmt->fetchColumn();
                return [
                    'success' => true,
                    'template_id' => $templateId,
                    'message' => '„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü'
                ];
            }
            
            return [
                'success' => false,
                'error' => '„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'
            ];
            
        } catch (Exception $e) {
            $this->errors[] = "„ÉÜ„É≥„Éó„É¨„Éº„Éà‰øùÂ≠ò„Ç®„É©„Éº: " . $e->getMessage();
            return [
                'success' => false,
                'error' => $e->getMessage()
            ];
        }
    }
    
    /**
     * üéØ „É°„Ç§„É≥Ê©üËÉΩ: CSV„Éá„Éº„Çø„Å®HTML„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÁµ±Âêà
     */
    public function processCSVWithTemplate($csvData, $templateId, $options = []) {
        try {
            // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÂèñÂæó
            $template = $this->getTemplateById($templateId);
            if (!$template) {
                throw new Exception("„ÉÜ„É≥„Éó„É¨„Éº„ÉàID {$templateId} „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
            }
            
            $processedItems = [];
            $successCount = 0;
            $errorCount = 0;
            
            foreach ($csvData as $index => $item) {
                try {
                    // HTMLË™¨ÊòéÊñá„ÇíÁîüÊàê
                    $htmlDescription = $this->mergeTemplateWithData($template, $item);
                    
                    // CSV„Ç¢„Ç§„ÉÜ„É†„Å´HTMLË™¨ÊòéÊñá„ÇíÁµ±Âêà
                    $processedItem = $item;
                    $processedItem['Description'] = $htmlDescription;
                    
                    // ËøΩÂä†„Éá„Éº„ÇøÂá¶ÁêÜ
                    if (isset($options['enhance_data']) && $options['enhance_data']) {
                        $processedItem = $this->enhanceItemData($processedItem);
                    }
                    
                    $processedItems[] = [
                        'index' => $index,
                        'original' => $item,
                        'processed' => $processedItem,
                        'success' => true
                    ];
                    
                    $successCount++;
                    
                } catch (Exception $e) {
                    $processedItems[] = [
                        'index' => $index,
                        'original' => $item,
                        'error' => $e->getMessage(),
                        'success' => false
                    ];
                    $errorCount++;
                }
            }
            
            // Áµ±Ë®àË®òÈå≤
            $this->recordTemplateUsage($templateId, $options['csv_filename'] ?? 'unknown', count($csvData), $successCount > 0);
            
            return [
                'success' => $errorCount < count($csvData),
                'total_items' => count($csvData),
                'success_count' => $successCount,
                'error_count' => $errorCount,
                'processed_items' => $processedItems,
                'template_used' => $template,
                'message' => "Âá¶ÁêÜÂÆå‰∫Ü: ÊàêÂäü {$successCount}‰ª∂„ÄÅÂ§±Êïó {$errorCount}‰ª∂"
            ];
            
        } catch (Exception $e) {
            $this->errors[] = "CSVÂá¶ÁêÜ„Ç®„É©„Éº: " . $e->getMessage();
            return [
                'success' => false,
                'error' => $e->getMessage(),
                'processed_items' => []
            ];
        }
    }
    
    /**
     * „ÉÜ„É≥„Éó„É¨„Éº„Éà„Å®„Éá„Éº„Çø„ÅÆ„Éû„Éº„Ç∏
     */
    private function mergeTemplateWithData($template, $itemData) {
        $html = $template['html_content'];
        $css = $template['css_styles'] ?? '';
        
        // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÁΩÆÊèõ
        $placeholders = json_decode($template['placeholder_fields'], true) ?? [];
        
        foreach ($placeholders as $placeholder) {
            $key = $this->placeholderToKey($placeholder);
            $value = $this->getDataValue($itemData, $key);
            
            // ÁâπÊÆäÂá¶ÁêÜ
            $value = $this->processSpecialPlaceholder($placeholder, $value, $itemData);
            
            $html = str_replace($placeholder, $value, $html);
        }
        
        // CSSÁµ±Âêà
        if (!empty($css)) {
            $html .= "\n<style>\n" . $css . "\n</style>";
        }
        
        return $html;
    }
    
    /**
     * „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Çí„Éá„Éº„Çø„Ç≠„Éº„Å´Â§âÊèõ
     */
    private function placeholderToKey($placeholder) {
        // {{TITLE}} -> Title, {{MAIN_IMAGE}} -> PictureURL etc.
        $key = str_replace(['{{', '}}'], '', $placeholder);
        
        $keyMappings = [
            'TITLE' => 'Title',
            'PRICE' => 'BuyItNowPrice',
            'CONDITION' => 'ConditionDescription',
            'BRAND' => 'Brand',
            'DESCRIPTION' => 'Description',
            'MAIN_IMAGE' => 'PictureURL',
            'ADDITIONAL_IMAGES' => 'PictureURL',
            'UPC' => 'UPC',
            'CATEGORY' => 'Category',
            'CURRENCY' => 'Currency',
            'LOCATION' => 'Location'
        ];
        
        return $keyMappings[$key] ?? $key;
    }
    
    /**
     * „Éá„Éº„Çø„Åã„ÇâÂÄ§ÂèñÂæó
     */
    private function getDataValue($itemData, $key) {
        if (isset($itemData[$key])) {
            return $itemData[$key];
        }
        
        // ‰ª£Êõø„Ç≠„Éº„Åß„ÅÆÊ§úÁ¥¢
        $alternativeKeys = [
            'Title' => ['title', 'name', 'product_name'],
            'BuyItNowPrice' => ['price', 'selling_price', 'current_price'],
            'Brand' => ['brand', 'manufacturer'],
            'Description' => ['description', 'details']
        ];
        
        if (isset($alternativeKeys[$key])) {
            foreach ($alternativeKeys[$key] as $altKey) {
                if (isset($itemData[$altKey])) {
                    return $itemData[$altKey];
                }
            }
        }
        
        return '';
    }
    
    /**
     * ÁâπÊÆä„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºÂá¶ÁêÜ
     */
    private function processSpecialPlaceholder($placeholder, $value, $itemData) {
        switch ($placeholder) {
            case '{{MAIN_IMAGE}}':
                return $this->generateMainImageHTML($value);
                
            case '{{ADDITIONAL_IMAGES}}':
                return $this->generateAdditionalImagesHTML($value);
                
            case '{{SPECIFICATIONS_TABLE}}':
                return $this->generateSpecificationsTable($itemData);
                
            case '{{PRICE}}':
                return $this->formatPrice($value, $itemData['Currency'] ?? 'USD');
                
            case '{{CONDITION}}':
                return $this->formatCondition($itemData['ConditionID'] ?? '', $value);
                
            case '{{SHIPPING_INFO}}':
                return $this->generateShippingInfo($itemData);
                
            case '{{WARRANTY_INFO}}':
                return $this->generateWarrantyInfo($itemData);
                
            case '{{SELLER_INFO}}':
                return $this->generateSellerInfo();
                
            default:
                return htmlspecialchars($value);
        }
    }
    
    /**
     * „É°„Ç§„É≥ÁîªÂÉèHTMLÁîüÊàê
     */
    private function generateMainImageHTML($imageUrl) {
        if (empty($imageUrl)) {
            return '<div class="no-image">ÁîªÂÉè„Å™„Åó</div>';
        }
        
        // Ë§áÊï∞URLÂØæÂøúÔºà|Âå∫Âàá„ÇäÔºâ
        $urls = explode('|', $imageUrl);
        $mainUrl = trim($urls[0]);
        
        if (filter_var($mainUrl, FILTER_VALIDATE_URL)) {
            return sprintf(
                '<img src="%s" alt="ÂïÜÂìÅÁîªÂÉè" style="width: 100%%; max-width: 500px; height: auto; border-radius: 8px;">',
                htmlspecialchars($mainUrl)
            );
        }
        
        return '<div class="no-image">ÁîªÂÉèURL„ÅåÁÑ°Âäπ„Åß„Åô</div>';
    }
    
    /**
     * ËøΩÂä†ÁîªÂÉèHTMLÁîüÊàê
     */
    private function generateAdditionalImagesHTML($imageUrl) {
        if (empty($imageUrl)) {
            return '';
        }
        
        $urls = explode('|', $imageUrl);
        array_shift($urls); // „É°„Ç§„É≥ÁîªÂÉè„ÇíÈô§Â§ñ
        
        if (empty($urls)) {
            return '';
        }
        
        $html = '<div class="additional-images" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">';
        
        foreach ($urls as $url) {
            $url = trim($url);
            if (filter_var($url, FILTER_VALIDATE_URL)) {
                $html .= sprintf(
                    '<img src="%s" alt="ËøΩÂä†ÁîªÂÉè" style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;">',
                    htmlspecialchars($url)
                );
            }
        }
        
        $html .= '</div>';
        return $html;
    }
    
    /**
     * ‰ªïÊßòË°®HTMLÁîüÊàê
     */
    private function generateSpecificationsTable($itemData) {
        $specs = [];
        
        // Âü∫Êú¨‰ªïÊßòÈ†ÖÁõÆ
        $specFields = [
            'Brand' => '„Éñ„É©„É≥„Éâ',
            'UPC' => 'UPC„Ç≥„Éº„Éâ',
            'ConditionID' => 'Áä∂ÊÖã„Ç≥„Éº„Éâ',
            'Category' => '„Ç´„ÉÜ„Ç¥„É™',
            'Location' => 'Áô∫ÈÄÅÂÖÉ'
        ];
        
        foreach ($specFields as $field => $label) {
            if (!empty($itemData[$field])) {
                $specs[] = sprintf(
                    '<tr><td style="font-weight: bold; padding: 8px; border-bottom: 1px solid #eee;">%s</td><td style="padding: 8px; border-bottom: 1px solid #eee;">%s</td></tr>',
                    $label,
                    htmlspecialchars($itemData[$field])
                );
            }
        }
        
        if (empty($specs)) {
            return '<p>‰ªïÊßòÊÉÖÂ†±„Å™„Åó</p>';
        }
        
        return '<table style="width: 100%; border-collapse: collapse;">' . implode('', $specs) . '</table>';
    }
    
    /**
     * ‰æ°Ê†º„Éï„Ç©„Éº„Éû„ÉÉ„Éà
     */
    private function formatPrice($price, $currency = 'USD') {
        if (empty($price)) {
            return '$0.00';
        }
        
        $numericPrice = floatval($price);
        
        $symbols = [
            'USD' => '$',
            'JPY' => '¬•',
            'EUR' => '‚Ç¨',
            'GBP' => '¬£'
        ];
        
        $symbol = $symbols[$currency] ?? '$';
        
        if ($currency === 'JPY') {
            return $symbol . number_format($numericPrice, 0);
        } else {
            return $symbol . number_format($numericPrice, 2);
        }
    }
    
    /**
     * Áä∂ÊÖã„Éï„Ç©„Éº„Éû„ÉÉ„Éà
     */
    private function formatCondition($conditionId, $description = '') {
        $conditions = [
            '1000' => 'New',
            '2000' => 'New with defects',
            '2500' => 'New without tags', 
            '3000' => 'Used',
            '4000' => 'Very Good',
            '5000' => 'Good',
            '6000' => 'Acceptable',
            '7000' => 'For parts or not working'
        ];
        
        $conditionText = $conditions[$conditionId] ?? 'Used';
        
        if (!empty($description)) {
            $conditionText .= ' - ' . htmlspecialchars($description);
        }
        
        return $conditionText;
    }
    
    /**
     * ÈÖçÈÄÅÊÉÖÂ†±ÁîüÊàê
     */
    private function generateShippingInfo($itemData) {
        $location = $itemData['Location'] ?? 'Japan';
        $shippingProfile = $itemData['ShippingProfile'] ?? 'Standard Shipping';
        
        return sprintf(
            '<div class="shipping-info">
                <p><strong>Áô∫ÈÄÅÂÖÉ:</strong> %s</p>
                <p><strong>ÈÖçÈÄÅÊñπÊ≥ï:</strong> %s</p>
                <p><strong>ÈÖçÈÄÅÊúüÈñì:</strong> ÈÄöÂ∏∏7-14Âñ∂Ê•≠Êó•</p>
                <p>ËøΩË∑°Áï™Âè∑‰ªò„Åç„ÅßÂÆâÂÖ®ÈÖçÈÄÅ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ</p>
            </div>',
            htmlspecialchars($location),
            htmlspecialchars($shippingProfile)
        );
    }
    
    /**
     * ‰øùË®ºÊÉÖÂ†±ÁîüÊàê
     */
    private function generateWarrantyInfo($itemData) {
        $returnProfile = $itemData['ReturnProfile'] ?? '30 Days Return';
        
        return sprintf(
            '<div class="warranty-info">
                <p><strong>ËøîÂìÅ„Éù„É™„Ç∑„Éº:</strong> %s</p>
                <p><strong>‰øùË®º:</strong> ÂïÜÂìÅ„Å´ÂïèÈ°å„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØËøÖÈÄü„Å´ÂØæÂøú„ÅÑ„Åü„Åó„Åæ„Åô</p>
                <p>„ÅäÂÆ¢ÊßòÊ∫ÄË∂≥Â∫¶99.8%%„ÅÆÂÆüÁ∏æ„ÅßÂÆâÂøÉ„Åó„Å¶„ÅäË≤∑„ÅÑÊ±Ç„ÇÅ„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
            </div>',
            htmlspecialchars($returnProfile)
        );
    }
    
    /**
     * Ë≤©Â£≤ËÄÖÊÉÖÂ†±ÁîüÊàê
     */
    private function generateSellerInfo() {
        return '
        <div class="seller-info">
            <p><strong>Mystical Japan Treasures</strong></p>
            <p>üáØüáµ Êó•Êú¨„Åã„Çâ„ÅÆÊ≠£Ë¶èÂìÅË≤©Â£≤</p>
            <p>‚≠ê „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË©ï‰æ°: 99.8% „Éù„Ç∏„ÉÜ„Ç£„Éñ</p>
            <p>üì¶ ËøÖÈÄüÁô∫ÈÄÅ„Éª‰∏ÅÂØßÊ¢±ÂåÖ„Çí„ÅäÁ¥ÑÊùü</p>
            <p>üí¨ Êó•Êú¨Ë™û„ÉªËã±Ë™û„Åß„ÅÆ„Çµ„Éù„Éº„ÉàÂØæÂøú</p>
        </div>';
    }
    
    /**
     * „Ç¢„Ç§„ÉÜ„É†„Éá„Éº„ÇøÊã°Âºµ
     */
    private function enhanceItemData($item) {
        // ÈÄöË≤®„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éá„Éï„Ç©„É´„Éà
        if (empty($item['Currency'])) {
            $item['Currency'] = 'USD';
        }
        
        // „Çµ„Ç§„ÉàID„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éá„Éï„Ç©„É´„Éà
        if (empty($item['SiteID'])) {
            $item['SiteID'] = '0'; // US
        }
        
        // Âá∫ÂìÅÂΩ¢Âºè„ÅÆ„Éá„Éï„Ç©„É´„Éà
        if (empty($item['Format'])) {
            $item['Format'] = 'FixedPriceItem';
        }
        
        // Âá∫ÂìÅÊúüÈñì„ÅÆ„Éá„Éï„Ç©„É´„Éà
        if (empty($item['Duration'])) {
            $item['Duration'] = 'GTC';
        }
        
        // Áô∫ÈÄÅÂõΩ„ÅÆ„Éá„Éï„Ç©„É´„Éà
        if (empty($item['Country'])) {
            $item['Country'] = 'JP';
        }
        
        return $item;
    }
    
    /**
     * „ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩøÁî®Áµ±Ë®àË®òÈå≤
     */
    private function recordTemplateUsage($templateId, $csvFilename, $itemCount, $success = true, $errorMessage = null) {
        try {
            $sql = "SELECT record_template_usage(?, ?, ?, ?, ?)";
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute([$templateId, $csvFilename, $itemCount, $success, $errorMessage]);
        } catch (Exception $e) {
            error_log("„ÉÜ„É≥„Éó„É¨„Éº„Éà‰ΩøÁî®Áµ±Ë®àË®òÈå≤„Ç®„É©„Éº: " . $e->getMessage());
        }
    }
    
    /**
     * „ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„Åø
     */
    private function loadTemplates() {
        $templates = $this->getTemplates();
        foreach ($templates as $template) {
            $this->templates[$template['template_id']] = $template;
        }
    }
    
    /**
     * IDÂà•„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂèñÂæó
     */
    private function getTemplateById($templateId) {
        if (isset($this->templates[$templateId])) {
            return $this->templates[$templateId];
        }
        
        try {
            $stmt = $this->pdo->prepare("SELECT * FROM product_html_templates WHERE template_id = ? AND is_active = TRUE");
            $stmt->execute([$templateId]);
            $template = $stmt->fetch(PDO::FETCH_ASSOC);
            
            if ($template) {
                $this->templates[$templateId] = $template;
                return $template;
            }
        } catch (Exception $e) {
            $this->errors[] = "„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂèñÂæó„Ç®„É©„Éº: " . $e->getMessage();
        }
        
        return null;
    }
    
    /**
     * „Ç®„É©„ÉºÂèñÂæó
     */
    public function getErrors() {
        return $this->errors;
    }
    
    /**
     * „ÉÜ„É≥„Éó„É¨„Éº„ÉàÂâäÈô§
     */
    public function deleteTemplate($templateId) {
        try {
            $stmt = $this->pdo->prepare("UPDATE product_html_templates SET is_active = FALSE WHERE template_id = ?");
            $result = $stmt->execute([$templateId]);
            
            return [
                'success' => $result,
                'message' => $result ? '„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü' : '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'
            ];
        } catch (Exception $e) {
            return [
                'success' => false,
                'error' => $e->getMessage()
            ];
        }
    }
    
    /**
     * Áµ±Ë®àÊÉÖÂ†±ÂèñÂæó
     */
    public function getUsageStats($templateId = null) {
        try {
            if ($templateId) {
                $sql = "SELECT t.template_name, t.usage_count, COUNT(u.id) as total_uses,
                              AVG(u.item_count) as avg_items_per_use,
                              COUNT(CASE WHEN u.success THEN 1 END) as success_count
                       FROM product_html_templates t
                       LEFT JOIN html_template_usage_stats u ON t.template_id = u.template_id
                       WHERE t.template_id = ?
                       GROUP BY t.template_id, t.template_name, t.usage_count";
                $stmt = $this->pdo->prepare($sql);
                $stmt->execute([$templateId]);
            } else {
                $sql = "SELECT t.template_name, t.usage_count, COUNT(u.id) as total_uses,
                              AVG(u.item_count) as avg_items_per_use,
                              COUNT(CASE WHEN u.success THEN 1 END) as success_count
                       FROM product_html_templates t
                       LEFT JOIN html_template_usage_stats u ON t.template_id = u.template_id
                       WHERE t.is_active = TRUE
                       GROUP BY t.template_id, t.template_name, t.usage_count
                       ORDER BY t.usage_count DESC";
                $stmt = $this->pdo->query($sql);
            }
            
            return $stmt->fetchAll(PDO::FETCH_ASSOC);
        } catch (Exception $e) {
            $this->errors[] = "Áµ±Ë®àÂèñÂæó„Ç®„É©„Éº: " . $e->getMessage();
            return [];
        }
    }
}
?>