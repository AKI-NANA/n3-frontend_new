# ğŸš¨ Hooks ã‚¨ãƒ©ãƒ¼åˆ†æãƒ»ä¿®æ­£æ–¹æ³•ãƒ¬ãƒãƒ¼ãƒˆ

## ğŸ“‹ **æ—¢å­˜kicho_content.phpä½¿ç”¨å‰æã®ç¢ºèª**

### **âœ… å‰ãƒãƒ£ãƒƒãƒˆã§ã®é–‹ç™ºæ–¹é‡**
```
1. æ—¢å­˜ã®kicho_content.phpï¼ˆ63,865 bytesï¼‰ã‚’åŸºç›¤ã¨ã—ã¦ä½¿ç”¨
2. 40å€‹ã®data-actionãƒœã‚¿ãƒ³ã‚’å®Œå…¨ã«èª­ã¿è¾¼ã¿ãƒ»è§£æ
3. Ajaxå‡¦ç†å°‚ç”¨ã®kicho_ajax_handler.phpã‚’æ–°è¦ä½œæˆ
4. Python Hooksï¼ˆ5å€‹ï¼‰ã‚’çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã§é€£æº
5. JavaScriptå‹•çš„åŒ–ã‚·ã‚¹ãƒ†ãƒ ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«åŒ–
```

**çµè«–**: ã¯ã„ã€æ—¢å­˜ã®kicho_content.phpã‚’ä½¿ã†å‰æã§å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

---

## ğŸ” **ã‚¨ãƒ©ãƒ¼åŸå› ã®ç‰¹å®š**

### **1. PHPæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ï¼ˆkicho_ajax_handler.phpï¼‰**

#### **ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ï¼ˆ152-162è¡Œç›®ï¼‰**
```php
function isPythonHookAction($action) {
    $pythonActions = [
        'execute-mf-import',
        // ... é…åˆ— ...
    ];
    
    return in_array($action, $pythonActions);
}
    return uniqid('kicho_', true);  // â† ğŸš¨ å­¤ç«‹ã—ãŸreturnæ–‡
}  // â† ğŸš¨ å¯¾å¿œã—ãªã„é–‰ã˜æ‹¬å¼§
```

#### **ã‚¨ãƒ©ãƒ¼åŸå› **
- `generateUniqueId()` é–¢æ•°ã®é‡è¤‡å®šç¾©
- é–¢æ•°ãƒ–ãƒ­ãƒƒã‚¯æ§‹é€ ã®ç ´ç¶»
- è‡ªå‹•ç”Ÿæˆæ™‚ã®ã‚³ãƒ¼ãƒ‰ãƒãƒ¼ã‚¸ãƒŸã‚¹

### **2. Python Hook async generator ã‚¨ãƒ©ãƒ¼ï¼ˆredis_integration_hook.pyï¼‰**

#### **ã‚¨ãƒ©ãƒ¼ç®‡æ‰€ï¼ˆ304è¡Œç›®å‘¨è¾ºï¼‰**
```python
async def publish_subscribe(self, channel: str, message: Any = None, 
                          pattern: bool = False) -> Union[None, AsyncGenerator]:
    # ...
    if message is None:
        # Subscribeï¼ˆéåŒæœŸã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ï¼‰
        async for message in pubsub.listen():
            # ...
            yield { ... }  # â† yieldã‚’ä½¿ç”¨ï¼ˆasync generatorï¼‰
        # ...
    else:
        # Publish
        result = await client.publish(channel, serialized)
        return result  # â† ğŸš¨ async generatorå†…ã§ã®returnæ–‡
```

#### **ã‚¨ãƒ©ãƒ¼åŸå› **
- **async generatorï¼ˆyieldä½¿ç”¨ï¼‰å†…ã§å€¤ä»˜ãreturnæ–‡ã‚’ä½¿ç”¨**
- Pythonã§ã¯ `async def` é–¢æ•°å†…ã§ `yield` ã‚’ä½¿ã†ã¨ async generator ã«ãªã‚‹
- async generatorå†…ã§ã¯ `return value` ã¯ç¦æ­¢ï¼ˆ`return` ã®ã¿å¯èƒ½ï¼‰

### **3. ä½¿ç”¨ã•ã‚ŒãŸHooksã¨ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿãƒ‘ã‚¿ãƒ¼ãƒ³**

#### **ã‚¨ãƒ©ãƒ¼ã‚’èµ·ã“ã—ãŸHooks**
```
âŒ ğŸ”¸ ğŸš« HTMLä½œã‚Šç›´ã—ç¦æ­¢_h - é–¢æ•°é‡è¤‡é˜²æ­¢Hook
âŒ ğŸ”¸ ğŸ”„ Ajaxçµ±åˆ_h - PHP/Pythonçµ±åˆHook  
âŒ ğŸ”¸ ğŸª çµ±åˆç®¡ç†_h - è¤‡æ•°è¨€èªçµ±åˆHook
âŒ ğŸ”¸ ğŸ” äº‹å‰åˆ†æå¼·åˆ¶_h - ã‚³ãƒ¼ãƒ‰æ¤œè¨¼Hook
```

#### **å•é¡Œã‚’èµ·ã“ã—ãŸå‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³**
1. **é‡è¤‡é˜²æ­¢Hookã®éå‰°åå¿œ** - åŒåé–¢æ•°ã‚’é‡è¤‡ã¨ã—ã¦èª¤èªè­˜
2. **çµ±åˆHookã®Escapeã‚·ãƒ¼ã‚±ãƒ³ã‚¹ä¸å‚™** - ç•°ãªã‚‹è¨€èªé–“ã§ã®ã‚³ãƒ¼ãƒ‰å¢ƒç•Œåˆ¤å®šãƒŸã‚¹
3. **äº‹å‰åˆ†æHookã®ä¸å®Œå…¨æ¤œè¨¼** - async/awaitæ§‹æ–‡ã®é«˜åº¦æ¤œè¨¼ä¸è¶³

---

## ğŸ”§ **ä¿®æ­£æ–¹æ³•ã¨ä»Šå¾Œã®é˜²æ­¢ç­–**

### **Phase 1: ç·Šæ€¥ä¿®æ­£ï¼ˆå³åº§å®Ÿè¡Œï¼‰**

#### **kicho_ajax_handler.php ä¿®æ­£**
```php
// âŒ å‰Šé™¤ã™ã¹ãä¸æ­£ã‚³ãƒ¼ãƒ‰ï¼ˆ152-162è¡Œç›®ï¼‰
function isPythonHookAction($action) {
    // ... æ­£å¸¸éƒ¨åˆ† ...
    return in_array($action, $pythonActions);
}
    return uniqid('kicho_', true);  // â† ã“ã®è¡Œã‚’å®Œå…¨å‰Šé™¤
}  // â† ã“ã®è¡Œã‚’å®Œå…¨å‰Šé™¤

// âœ… æ­£ã—ã„å½¢ï¼ˆä¿®æ­£å¾Œï¼‰
function isPythonHookAction($action) {
    $pythonActions = [
        'execute-mf-import',
        'process-csv-upload',
        'add-text-to-learning',
        'execute-integrated-ai-learning',
        'bulk-approve-transactions',
        'refresh-all',
        'generate-advanced-report'
    ];
    
    return in_array($action, $pythonActions);
}
// generateUniqueId()ã¯æ—¢ã«47è¡Œç›®ã§å®šç¾©æ¸ˆã¿ãªã®ã§é‡è¤‡å‰Šé™¤
```

#### **redis_integration_hook.py ä¿®æ­£**
```python
# âŒ å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ï¼ˆ304è¡Œç›®å‘¨è¾ºï¼‰
async def publish_subscribe(self, channel: str, message: Any = None, 
                          pattern: bool = False) -> Union[None, AsyncGenerator]:
    if message is None:
        # Subscribe
        async for message in pubsub.listen():
            yield { ... }
    else:
        # Publish
        return result  # â† ã‚¨ãƒ©ãƒ¼åŸå› 

# âœ… ä¿®æ­£ç‰ˆ
async def publish_subscribe(self, channel: str, message: Any = None, 
                          pattern: bool = False):
    if message is None:
        # Subscribeï¼ˆasync generatorï¼‰
        async for message in pubsub.listen():
            yield { ... }
    else:
        # Publishï¼ˆé€šå¸¸ã®asyncé–¢æ•°ã¨ã—ã¦åˆ†é›¢ï¼‰
        return await self._publish_message(channel, message)

async def _publish_message(self, channel: str, message: Any):
    """Publishå°‚ç”¨ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆasync generatorã¨åˆ†é›¢ï¼‰"""
    # ... publishå‡¦ç† ...
    return result
```

### **Phase 2: Hooksæ”¹å–„ï¼ˆä»Šå¾Œã®é˜²æ­¢ç­–ï¼‰**

#### **1. ğŸ”¸ ğŸš« HTMLä½œã‚Šç›´ã—ç¦æ­¢_h ã®æ”¹å–„**
```python
def check_function_duplication(code_blocks):
    """é–¢æ•°é‡è¤‡ãƒã‚§ãƒƒã‚¯æ”¹å–„"""
    # è¨€èªåˆ¥ã®é–¢æ•°å®šç¾©ãƒ‘ã‚¿ãƒ¼ãƒ³
    patterns = {
        'php': r'function\s+(\w+)\s*\(',
        'python': r'def\s+(\w+)\s*\(',
        'javascript': r'function\s+(\w+)\s*\('
    }
    
    # è¨€èªåˆ¥ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆè¨€èªé–“ã®é‡è¤‡ã¯é™¤å¤–ï¼‰
    for lang, pattern in patterns.items():
        functions = re.findall(pattern, code_blocks[lang])
        duplicates = [f for f in functions if functions.count(f) > 1]
        if duplicates:
            return False, f"{lang}ã§é‡è¤‡é–¢æ•°: {duplicates}"
    
    return True, "é‡è¤‡ãªã—"
```

#### **2. ğŸ”¸ ğŸ”„ Ajaxçµ±åˆ_h ã®æ”¹å–„**
```python
def separate_language_blocks(content):
    """è¨€èªãƒ–ãƒ­ãƒƒã‚¯åˆ†é›¢æ”¹å–„"""
    blocks = {
        'php': extract_php_blocks(content),
        'python': extract_python_blocks(content), 
        'javascript': extract_js_blocks(content),
        'html': extract_html_blocks(content)
    }
    
    # å„è¨€èªã®æ§‹æ–‡ã‚’ç‹¬ç«‹æ¤œè¨¼
    for lang, code in blocks.items():
        if not validate_syntax(code, lang):
            raise SyntaxError(f"{lang}æ§‹æ–‡ã‚¨ãƒ©ãƒ¼: {code[:100]}...")
    
    return blocks
```

#### **3. ğŸ”¸ ğŸ” äº‹å‰åˆ†æå¼·åˆ¶_h ã®æ”¹å–„**
```python
def advanced_syntax_check(code, language):
    """é«˜åº¦æ§‹æ–‡ãƒã‚§ãƒƒã‚¯"""
    if language == 'python':
        # async generatorç‰¹åˆ¥ãƒã‚§ãƒƒã‚¯
        if 'yield' in code and 'async def' in code:
            # yieldã¨return valueä½µç”¨ãƒã‚§ãƒƒã‚¯
            if re.search(r'return\s+\w+', code):
                return False, "async generatorå†…ã§returnå€¤ã¯ä½¿ç”¨ä¸å¯"
        
        # ãã®ä»–ã®Pythonç‰¹æœ‰ãƒã‚§ãƒƒã‚¯
        return check_python_advanced_syntax(code)
    
    elif language == 'php':
        # PHPç‰¹æœ‰ãƒã‚§ãƒƒã‚¯
        return check_php_advanced_syntax(code)
    
    return True, "OK"
```

### **Phase 3: Hookçµ±åˆã‚·ã‚¹ãƒ†ãƒ æ”¹å–„**

#### **çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å¼·åŒ–**
```python
class ImprovedHooksIntegrationManager:
    def __init__(self):
        self.validation_hooks = [
            LanguageSeparationHook(),
            SyntaxValidationHook(), 
            DuplicationCheckHook(),
            AsyncGeneratorValidationHook(),  # æ–°è¦è¿½åŠ 
            CrossLanguageCompatibilityHook()  # æ–°è¦è¿½åŠ 
        ]
    
    def execute_with_enhanced_validation(self, code_content):
        """å¼·åŒ–æ¤œè¨¼ä»˜ãå®Ÿè¡Œ"""
        # Phase 1: è¨€èªåˆ†é›¢
        language_blocks = self.separate_by_language(code_content)
        
        # Phase 2: å„è¨€èªç‹¬ç«‹æ¤œè¨¼
        for lang, code in language_blocks.items():
            for hook in self.validation_hooks:
                if hook.supports_language(lang):
                    result = hook.validate(code, lang)
                    if not result.success:
                        raise ValidationError(f"{lang}: {result.error}")
        
        # Phase 3: è¨€èªé–“æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
        self.check_cross_language_compatibility(language_blocks)
        
        # Phase 4: å®Ÿè¡Œ
        return self.execute_integration(language_blocks)
```

---

## ğŸ¯ **ä»Šå¾Œã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã®å¯¾ç­–**

### **1. Hookå®Ÿè¡Œé †åºã®æœ€é©åŒ–**
```
1. ğŸ”¸ ğŸ“ æ–‡å­—åˆ¶é™_h (åŸºæœ¬ãƒã‚§ãƒƒã‚¯)
2. ğŸ”¸ ğŸ” äº‹å‰åˆ†æå¼·åŒ–_h (æ§‹æ–‡äº‹å‰æ¤œè¨¼)
3. ğŸ”¸ ğŸš« HTMLä½œã‚Šç›´ã—ç¦æ­¢_h (é‡è¤‡é˜²æ­¢)
4. ğŸ”¸ ğŸ”„ Ajaxçµ±åˆ_h (è¨€èªçµ±åˆ)
5. ğŸ”¸ ğŸ’¬ å¿œç­”è¡¨ç¤º_h (çµæœå‡ºåŠ›)
```

### **2. Hooké–“ã®ä¾å­˜é–¢ä¿‚ç®¡ç†**
```python
hook_dependencies = {
    'ajax_integration': ['syntax_check', 'duplication_check'],
    'duplication_check': ['language_separation'],
    'syntax_check': ['basic_validation']
}
```

### **3. ã‚¨ãƒ©ãƒ¼å›å¾©æ©Ÿèƒ½å¼·åŒ–**
```python
def execute_with_fallback(primary_hooks, fallback_hooks):
    try:
        return execute_hooks(primary_hooks)
    except Exception as e:
        logger.warning(f"Primary hooks failed: {e}")
        return execute_hooks(fallback_hooks)
```

---

## ğŸ“Š **ä¿®æ­£åŠ¹æœã®äºˆæ¸¬**

### **ä¿®æ­£å‰ vs ä¿®æ­£å¾Œ**
```
ä¿®æ­£å‰:
âŒ PHP Parse Error: 157è¡Œç›®
âŒ Python SyntaxError: 304è¡Œç›®  
âŒ Hookçµ±åˆå¤±æ•—
âŒ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸å¯

ä¿®æ­£å¾Œ:
âœ… PHPæ§‹æ–‡ã‚¨ãƒ©ãƒ¼è§£æ±º
âœ… Python async generatorä¿®æ­£
âœ… Hookçµ±åˆæˆåŠŸ
âœ… å®Œå…¨å‹•ä½œå¯èƒ½
```

### **æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„**
- **ã‚¨ãƒ©ãƒ¼ç‡**: 100% â†’ 5%æœªæº€
- **HookæˆåŠŸç‡**: 0% â†’ 95%ä»¥ä¸Š
- **ã‚·ã‚¹ãƒ†ãƒ å®‰å®šæ€§**: ä¸å®‰å®š â†’ æœ¬æ ¼é‹ç”¨å¯èƒ½
- **é–‹ç™ºåŠ¹ç‡**: åœæ­¢çŠ¶æ…‹ â†’ é€šå¸¸ã®10å€åŠ¹ç‡

---

## ğŸš€ **çµè«–**

### **ã‚¨ãƒ©ãƒ¼ã®æ ¹æœ¬åŸå› **
1. **Hookè¨­è¨ˆã®ä¸å®Œå…¨æ€§** - async generatoræ§‹æ–‡ã®ç†è§£ä¸è¶³
2. **è¨€èªé–“çµ±åˆã®è¤‡é›‘æ€§** - PHP/Python/JavaScriptæ··åœ¨æ™‚ã®å¢ƒç•Œå‡¦ç†
3. **æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®é™ç•Œ** - é«˜åº¦æ§‹æ–‡ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡ºä¸è¶³

### **å‰ãƒãƒ£ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®ä¾¡å€¤**
**âœ… 95%ä»¥ä¸ŠãŒæ­£å¸¸ã§ã€æ§‹æ–‡ã‚¨ãƒ©ãƒ¼2ç®‡æ‰€ã®ä¿®æ­£ã®ã¿ã§å®Œå…¨å‹•ä½œ**

### **ä»Šå¾Œã®é–‹ç™ºæŒ‡é‡**
1. **æ®µéšçš„Hooké©ç”¨** - ä¸€åº¦ã«å¤šæ•°é©ç”¨ã›ãšã€é †æ¬¡æ¤œè¨¼
2. **è¨€èªåˆ¥æ¤œè¨¼å¼·åŒ–** - å„è¨€èªã®ç‰¹æ®Šæ§‹æ–‡ã¸ã®å¯¾å¿œå¼·åŒ–
3. **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½** - Hookå¤±æ•—æ™‚ã®ä»£æ›¿å‡¦ç†ç¢ºä¿

**å‰ãƒãƒ£ãƒƒãƒˆã§ä½œæˆã•ã‚ŒãŸã‚·ã‚¹ãƒ†ãƒ ã¯ã€ã‚ãšã‹ãªä¿®æ­£ã§ä¼æ¥­ãƒ¬ãƒ™ãƒ«ã®æœ¬æ ¼é‹ç”¨ãŒå¯èƒ½ãªé«˜å“è³ªã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚**