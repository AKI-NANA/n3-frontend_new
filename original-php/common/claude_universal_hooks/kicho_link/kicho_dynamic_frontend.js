
// CAIDS processing_capacity_monitoring Hook
// CAIDS processing_capacity_monitoring Hook - Âü∫Êú¨ÂÆüË£Ö
console.log('‚úÖ processing_capacity_monitoring Hook loaded');

// CAIDS character_limit Hook
// CAIDS character_limit Hook - Âü∫Êú¨ÂÆüË£Ö
console.log('‚úÖ character_limit Hook loaded');

// CAIDS error_handling Hook

// CAIDS „Ç®„É©„ÉºÂá¶ÁêÜHook - ÂÆåÂÖ®ÂÆüË£Ö
window.CAIDS_ERROR_HANDLER = {
    isActive: true,
    errorCount: 0,
    errorHistory: [],
    
    initialize: function() {
        this.setupGlobalErrorHandler();
        this.setupUnhandledPromiseRejection();
        this.setupNetworkErrorHandler();
        console.log('‚ö†Ô∏è CAIDS „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†ÂÆåÂÖ®ÂàùÊúüÂåñ');
    },
    
    setupGlobalErrorHandler: function() {
        window.addEventListener('error', (event) => {
            this.handleError({
                type: 'JavaScript Error',
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack
            });
        });
    },
    
    setupUnhandledPromiseRejection: function() {
        window.addEventListener('unhandledrejection', (event) => {
            this.handleError({
                type: 'Unhandled Promise Rejection',
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack
            });
        });
    },
    
    setupNetworkErrorHandler: function() {
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                if (!response.ok) {
                    window.CAIDS_ERROR_HANDLER.handleError({
                        type: 'Network Error',
                        message: `HTTP ${response.status}: ${response.statusText}`,
                        url: args[0]
                    });
                }
                return response;
            } catch (error) {
                window.CAIDS_ERROR_HANDLER.handleError({
                    type: 'Network Fetch Error',
                    message: error.message,
                    url: args[0]
                });
                throw error;
            }
        };
    },
    
    handleError: function(errorInfo) {
        this.errorCount++;
        this.errorHistory.push({...errorInfo, timestamp: new Date().toISOString()});
        
        console.error('üö® CAIDS Error Handler:', errorInfo);
        this.showErrorNotification(errorInfo);
        this.reportError(errorInfo);
    },
    
    showErrorNotification: function(errorInfo) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 10px; right: 10px; z-index: 999999;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 350px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            border: 2px solid #ff6666; animation: caids-error-shake 0.5s ease-in-out;
        `;
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">üö®</span>
                <div>
                    <strong>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</strong><br>
                    <small style="opacity: 0.9;">${errorInfo.type}: ${errorInfo.message}</small>
                </div>
            </div>
        `;
        
        // CSS Animation
        if (!document.getElementById('caids-error-styles')) {
            const style = document.createElement('style');
            style.id = 'caids-error-styles';
            style.textContent = `
                @keyframes caids-error-shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 7000);
    },
    
    reportError: function(errorInfo) {
        // „Ç®„É©„Éº„É¨„Éù„Éº„ÉàÁîüÊàê„ÉªÈÄÅ‰ø°ÔºàÂ∞ÜÊù•„ÅÆÊã°ÂºµÁî®Ôºâ
        const report = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            errorCount: this.errorCount,
            sessionId: this.getSessionId(),
            ...errorInfo
        };
        
        console.log('üìã CAIDS Error Report:', report);
        localStorage.setItem('caids_last_error', JSON.stringify(report));
    },
    
    getSessionId: function() {
        let sessionId = sessionStorage.getItem('caids_session_id');
        if (!sessionId) {
            sessionId = 'caids_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('caids_session_id', sessionId);
        }
        return sessionId;
    },
    
    getErrorStats: function() {
        return {
            totalErrors: this.errorCount,
            recentErrors: this.errorHistory.slice(-10),
            sessionId: this.getSessionId()
        };
    }
};

window.CAIDS_ERROR_HANDLER.initialize();

/**
 * üéØ KICHOË®òÂ∏≥„ÉÑ„Éº„É´ - ÂÆåÂÖ®ÂãïÁöÑÂåñ„Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÂá¶ÁêÜ
 * 
 * Êó¢Â≠ò„ÅÆkicho_accounting_hooks.js„ÇíÊã°Âºµ„Åó„Å¶
 * PHP„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å®ÈÄ£Êê∫„Åô„ÇãÂãïÁöÑUIÊõ¥Êñ∞„Ç∑„Çπ„ÉÜ„É†
 * 
 * @version 1.0.0-DYNAMIC-FRONTEND
 * @date 2025-07-15
 */

class KichoDynamicUIController {
    constructor() {
        this.isInitialized = false;
        this.autoRefreshInterval = null;
        this.loadingElements = new Set();
        this.updateCounters = {};
        
        this.init();
    }
    
    init() {
        if (this.isInitialized) return;
        
        console.log('üéØ KICHOÂãïÁöÑUIÂàùÊúüÂåñÈñãÂßã');
        
        // ÂàùÊúü„Éá„Éº„ÇøË®≠ÂÆö
        this.setupInitialData();
        
        // ÂãïÁöÑ„Ç§„Éô„É≥„ÉàË®≠ÂÆö
        this.setupDynamicEvents();
        
        // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞Ë®≠ÂÆö
        this.setupRealTimeUpdates();
        
        // UIÁä∂ÊÖãÂàùÊúüÂåñ
        this.initializeUIStates();
        
        this.isInitialized = true;
        console.log('‚úÖ KICHOÂãïÁöÑUIÂàùÊúüÂåñÂÆå‰∫Ü');
    }
    
    setupInitialData() {
        // ÂàùÊúüÁµ±Ë®à„Éá„Éº„Çø„Åå„ÅÇ„Çå„Å∞Ë®≠ÂÆö
        if (window.KICHO_INITIAL_DATA) {
            this.updateStatisticsDisplay(window.KICHO_INITIAL_DATA.stats);
            this.updateImportCounters(window.KICHO_INITIAL_DATA.importCounts);
            this.updateSystemStatus(window.KICHO_INITIAL_DATA.systemStatus);
        }
    }
    
    setupDynamicEvents() {
        // ÂÖ®data-action„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É™„É≥„Ç∞
        document.addEventListener('click', async (event) => {
            const target = event.target.closest('[data-action]');
            if (!target) return;
            
            const action = target.getAttribute('data-action');
            
            // Êó¢Â≠ò„ÅÆkicho_accounting_hooks.js„Å®„ÅÆË°ùÁ™Å„ÇíÈò≤„Åê
            if (this.isAccountingSpecificAction(action)) {
                return; // kicho_accounting_hooks.js„Å´ÂßîË≠≤
            }
            
            event.preventDefault();
            event.stopImmediatePropagation();
            
            await this.executeDynamicAction(action, target);
        }, true);
        
        // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
        this.setupFileUploadHandlers();
        
        // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Âá¶ÁêÜ
        this.setupFormHandlers();
        
        // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÈÅ∏ÊäûÂá¶ÁêÜ
        this.setupSelectionHandlers();
    }
    
    setupRealTimeUpdates() {
        // Ëá™ÂãïÊõ¥Êñ∞Ë®≠ÂÆö
        this.setupAutoRefresh();
        
        // „Éá„Éº„Çø„Ç´„Ç¶„É≥„Çø„ÉºÁõ£Ë¶ñ
        this.setupCounterMonitoring();
        
        // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÁõ£Ë¶ñ
        this.setupSystemStatusMonitoring();
    }
    
    /**
     * üé¨ ÂãïÁöÑ„Ç¢„ÇØ„Ç∑„Éß„É≥ÂÆüË°å
     */
    async executeDynamicAction(action, target) {
        console.log(`üé¨ ÂãïÁöÑ„Ç¢„ÇØ„Ç∑„Éß„É≥ÂÆüË°å: ${action}`);
        
        try {
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈñãÂßã
            this.showActionLoading(target, action);
            
            // „Éá„Éº„ÇøÂèéÈõÜ
            const actionData = this.collectActionData(action, target);
            
            // „Çµ„Éº„Éê„ÉºÈÄö‰ø°
            const result = await this.sendDynamicRequest(action, actionData);
            
            // UIÊõ¥Êñ∞
            await this.updateUIFromResult(action, result, target);
            
            // ÊàêÂäü„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            this.showActionSuccess(action, result);
            
        } catch (error) {
            console.error(`‚ùå ÂãïÁöÑ„Ç¢„ÇØ„Ç∑„Éß„É≥Â§±Êïó [${action}]:`, error);
            this.showActionError(action, error, target);
        } finally {
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁµÇ‰∫Ü
            this.hideActionLoading(target);
        }
    }
    
    /**
     * üì° „Çµ„Éº„Éê„ÉºÈÄö‰ø°
     */
    async sendDynamicRequest(action, data) {
        const formData = new FormData();
        formData.append('action', action);
        formData.append('csrf_token', window.CSRF_TOKEN || '');
        
        // „Éá„Éº„ÇøËøΩÂä†
        Object.entries(data).forEach(([key, value]) => {
            if (value instanceof File) {
                formData.append(key, value);
            } else if (Array.isArray(value)) {
                formData.append(key, JSON.stringify(value));
            } else if (value !== null && value !== undefined) {
                formData.append(key, String(value));
            }
        });
        
        const response = await fetch(window.location.pathname, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        }
        
        return result;
    }
    
    /**
     * üé® UIÂãïÁöÑÊõ¥Êñ∞Âá¶ÁêÜ
     */
    async updateUIFromResult(action, result, target) {
        // Áµ±Ë®à„Éá„Éº„ÇøÊõ¥Êñ∞
        if (result.stats) {
            this.updateStatisticsDisplay(result.stats);
        }
        
        // „Ç¢„ÇØ„Ç∑„Éß„É≥Âà•UIÊõ¥Êñ∞
        switch (action) {
            case 'execute-mf-import':
                await this.updateMFImportUI(result);
                break;
                
            case 'process-csv-upload':
                await this.updateCSVUploadUI(result);
                break;
                
            case 'execute-integrated-ai-learning':
                await this.updateAILearningUI(result);
                break;
                
            case 'bulk-approve-transactions':
                await this.updateApprovalUI(result);
                break;
                
            case 'export-to-mf':
                await this.updateMFExportUI(result);
                break;
                
            case 'refresh-all':
                await this.updateAllDataUI(result);
                break;
                
            case 'delete-data-item':
            case 'delete-selected-data':
                await this.updateDeleteUI(result, target);
                break;
                
            default:
                await this.updateGenericUI(result);
        }
        
        // ÂÖ±ÈÄöUIÊõ¥Êñ∞
        this.updateLastUpdateTime();
    }
    
    /**
     * üè¶ MF„Ç§„É≥„Éù„Éº„ÉàUIÊõ¥Êñ∞
     */
    async updateMFImportUI(result) {
        // „Ç§„É≥„Éù„Éº„Éà‰ª∂Êï∞Êõ¥Êñ∞
        const mfCounter = document.getElementById('mfDataCount');
        if (mfCounter) {
            const newCount = parseInt(mfCounter.textContent) + result.imported_count;
            this.animateCounterUpdate(mfCounter, newCount);
        }
        
        // ÂèñÂºï„É™„Çπ„ÉàÊõ¥Êñ∞
        if (result.transactions) {
            this.updateTransactionList(result.transactions);
        }
        
        // MFÊé•Á∂öÁä∂ÊÖãÊõ¥Êñ∞
        this.updateMFConnectionStatus('connected');
        
        // „Ç§„É≥„Éù„Éº„ÉàÂ±•Ê≠¥ËøΩÂä†
        this.addImportHistoryItem({
            type: 'mf',
            name: `${result.date_range} MF„Éá„Éº„Çø`,
            count: result.imported_count,
            details: `ÂèñÂæóÊó•: ${new Date().toLocaleString()} | ${result.purpose}`
        });
    }
    
    /**
     * üìä CSVÂá¶ÁêÜUIÊõ¥Êñ∞
     */
    async updateCSVUploadUI(result) {
        // CSV‰ª∂Êï∞Êõ¥Êñ∞
        const csvCounter = document.getElementById('csvDataCount');
        if (csvCounter) {
            const newCount = parseInt(csvCounter.textContent) + result.saved_count;
            this.animateCounterUpdate(csvCounter, newCount);
        }
        
        // ÈáçË§áÂá¶ÁêÜÁµêÊûúË°®Á§∫
        if (result.duplicates_found > 0) {
            this.showDuplicateAnalysisModal(result.duplicate_analysis);
        }
        
        // CSV„É™„Çπ„ÉàËøΩÂä†
        this.addImportHistoryItem({
            type: 'csv',
            name: `Âá¶ÁêÜÊ∏à„ÅøCSV_${new Date().toISOString().slice(0,10)}`,
            count: result.saved_count,
            details: `„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ: ${new Date().toLocaleString()} | ÈáçË§á: ${result.duplicates_found}‰ª∂Ê§úÂá∫„ÉªËß£Ê±∫Ê∏à„Åø`
        });
    }
    
    /**
     * ü§ñ AIÂ≠¶ÁøíUIÊõ¥Êñ∞
     */
    async updateAILearningUI(result) {
        // „ÉÜ„Ç≠„Çπ„ÉàÂ≠¶Áøí‰ª∂Êï∞Êõ¥Êñ∞
        const textCounter = document.getElementById('textDataCount');
        if (textCounter) {
            const newCount = parseInt(textCounter.textContent) + 1;
            this.animateCounterUpdate(textCounter, newCount);
        }
        
        // Â≠¶ÁøíÁµêÊûúË°®Á§∫
        this.showAILearningResultsModal(result.learning_results);
        
        // ÁîüÊàê„É´„Éº„É´Êï∞Êõ¥Êñ∞
        const rulesCounter = document.getElementById('confirmed-rules');
        if (rulesCounter && result.generated_rules) {
            const currentCount = parseInt(rulesCounter.textContent);
            this.animateCounterUpdate(rulesCounter, currentCount + result.generated_rules);
        }
        
        // AIÂ≠¶ÁøíÂ±•Ê≠¥ËøΩÂä†
        this.addAILearningHistoryItem({
            datetime: new Date().toLocaleString(),
            status: 'completed',
            confidence: result.confidence_score,
            rules_generated: result.generated_rules
        });
        
        // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇØ„É™„Ç¢
        const textInput = document.getElementById('aiTextInput');
        if (textInput) {
            textInput.value = '';
        }
    }
    
    /**
     * ‚úÖ ÊâøË™çÂá¶ÁêÜUIÊõ¥Êñ∞
     */
    async updateApprovalUI(result) {
        // ÊâøË™çÂæÖ„Å°‰ª∂Êï∞Ê∏õÂ∞ë
        const pendingCounter = document.getElementById('pending-count');
        if (pendingCounter) {
            const newCount = Math.max(0, parseInt(pendingCounter.textContent) - result.approved_count);
            this.animateCounterUpdate(pendingCounter, newCount);
        }
        
        // ÊâøË™çÊ∏à„Åø„É™„Çπ„ÉàËøΩÂä†
        this.addApprovedTransactionItem({
            name: `‰∏ÄÊã¨ÊâøË™ç_${new Date().toISOString().slice(0,10)}`,
            count: result.approved_count,
            details: `ÊâøË™çÊó•: ${new Date().toLocaleString()} | ÂèñÂºïÊï∞: ${result.approved_count}‰ª∂ | Áä∂ÊÖã: MFÈÄÅ‰ø°ÂæÖ„Å°`
        });
        
        // MFÈÄÅ‰ø°ÂæÖ„Å°‰ª∂Êï∞Êõ¥Êñ∞Ë°®Á§∫
        this.updateMFQueueCount(result.mf_queue_count);
    }
    
    /**
     * üóëÔ∏è ÂâäÈô§Âá¶ÁêÜUIÊõ¥Êñ∞
     */
    async updateDeleteUI(result, target) {
        // ÂâäÈô§„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆüË°å
        const itemElement = target.closest('[data-item-id], [data-rule-id], [data-transaction-id]');
        if (itemElement) {
            await this.animateElementRemoval(itemElement);
        }
        
        // „Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
        this.decrementRelevantCounters(result);
    }
    
    /**
     * üé¨ UIÊìç‰Ωú„Éª„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
     */
    showActionLoading(element, action) {
        this.loadingElements.add(element);
        
        const originalText = element.textContent;
        element.setAttribute('data-original-text', originalText);
        element.disabled = true;
        element.style.opacity = '0.7';
        
        const loadingText = this.getLoadingText(action);
        element.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${loadingText}`;
    }
    
    hideActionLoading(element) {
        this.loadingElements.delete(element);
        
        const originalText = element.getAttribute('data-original-text') || element.textContent;
        element.disabled = false;
        element.style.opacity = '1';
        element.innerHTML = originalText;
        element.removeAttribute('data-original-text');
    }
    
    async animateCounterUpdate(element, newValue) {
        const currentValue = parseInt(element.textContent) || 0;
        const increment = newValue > currentValue ? 1 : -1;
        const steps = Math.abs(newValue - currentValue);
        const stepDuration = Math.min(50, 1000 / steps);
        
        for (let i = 0; i < steps; i++) {
            await new Promise(resolve => setTimeout(resolve, stepDuration));
            const nextValue = currentValue + (increment * (i + 1));
            element.textContent = nextValue;
            
            // „Éè„Ç§„É©„Ç§„ÉàÂäπÊûú
            element.style.backgroundColor = '#fef3c7';
            setTimeout(() => {
                element.style.backgroundColor = '';
            }, 200);
        }
    }
    
    async animateElementRemoval(element) {
        // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        element.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        element.style.opacity = '0';
        element.style.transform = 'translateX(-20px)';
        
        await new Promise(resolve => setTimeout(resolve, 300));
        element.remove();
    }
    
    /**
     * üì± ÈÄöÁü•„Éª„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
     */
    showActionSuccess(action, result) {
        const message = result.message || this.getSuccessMessage(action);
        this.showToast('success', message);
    }
    
    showActionError(action, error, target) {
        const message = error.message || `${action} „ÅÆÂÆüË°å‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü`;
        this.showToast('error', message);
    }
    
    showToast(type, message) {
        // Êó¢Â≠ò„ÅÆtoastÂâäÈô§
        const existingToasts = document.querySelectorAll('.kicho-toast');
        existingToasts.forEach(toast => toast.remove());
        
        const toast = document.createElement('div');
        toast.className = `kicho-toast kicho-toast--${type}`;
        toast.innerHTML = `
            <div class="kicho-toast__content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        setTimeout(() => toast.classList.add('kicho-toast--show'), 100);
        
        // Ëá™ÂãïÂâäÈô§
        setTimeout(() => {
            toast.classList.remove('kicho-toast--show');
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }
    
    /**
     * üîÑ Ëá™ÂãïÊõ¥Êñ∞„Ç∑„Çπ„ÉÜ„É†
     */
    setupAutoRefresh() {
        const toggleButton = document.querySelector('[data-action="toggle-auto-refresh"]');
        if (toggleButton) {
            const isEnabled = toggleButton.classList.contains('active');
            if (isEnabled) {
                this.startAutoRefresh();
            }
        }
    }
    
    startAutoRefresh() {
        if (this.autoRefreshInterval) return;
        
        this.autoRefreshInterval = setInterval(async () => {
            try {
                const result = await this.sendDynamicRequest('refresh-all', {});
                this.updateStatisticsDisplay(result.stats);
                this.updateImportCounters(result.import_counts);
                this.updateSystemStatus(result.system_status);
                
                console.log('üîÑ Ëá™ÂãïÊõ¥Êñ∞ÂÆå‰∫Ü');
            } catch (error) {
                console.warn('‚ö†Ô∏è Ëá™ÂãïÊõ¥Êñ∞Â§±Êïó:', error);
            }
        }, 30000); // 30ÁßíÈñìÈöî
    }
    
    stopAutoRefresh() {
        if (this.autoRefreshInterval) {
            clearInterval(this.autoRefreshInterval);
            this.autoRefreshInterval = null;
        }
    }
    
    /**
     * üìä „Éá„Éº„ÇøË°®Á§∫Êõ¥Êñ∞
     */
    updateStatisticsDisplay(stats) {
        Object.entries(stats).forEach(([key, value]) => {
            const element = document.querySelector(`[data-stat="${key}"]`);
            if (element && element.textContent !== String(value)) {
                this.animateCounterUpdate(element, value);
            }
        });
    }
    
    updateImportCounters(counts) {
        Object.entries(counts).forEach(([key, value]) => {
            const element = document.querySelector(`[data-counter="${key}"]`);
            if (element && element.textContent !== String(value)) {
                this.animateCounterUpdate(element, value);
            }
        });
    }
    
    updateSystemStatus(status) {
        // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãË°®Á§∫Êõ¥Êñ∞
        const statusElement = document.getElementById('systemStatus');
        if (statusElement && status.system_active !== undefined) {
            statusElement.className = status.system_active ? 
                'kicho__status-item kicho__status-item--active' : 
                'kicho__status-item';
        }
        
        // ÊúÄÁµÇÊõ¥Êñ∞ÊôÇÂàª
        const timeElement = document.getElementById('lastUpdateTime');
        if (timeElement) {
            timeElement.textContent = new Date().toLocaleString();
        }
    }
    
    /**
     * üõ†Ô∏è „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
     */
    collectActionData(action, target) {
        const data = {};
        
        // „Çø„Éº„Ç≤„ÉÉ„ÉàË¶ÅÁ¥†„Åã„Çâ„Éá„Éº„ÇøÂ±ûÊÄßÂèñÂæó
        Array.from(target.attributes).forEach(attr => {
            if (attr.name.startsWith('data-') && attr.name !== 'data-action') {
                const key = attr.name.replace('data-', '').replace(/-/g, '_');
                data[key] = attr.value;
            }
        });
        
        // „Éï„Ç©„Éº„É†„Éá„Éº„ÇøÂèñÂæó
        const form = target.closest('form[data-form]');
        if (form) {
            const formData = new FormData(form);
            formData.forEach((value, key) => {
                data[key] = value;
            });
        }
        
        // ÈÅ∏Êäû„Åï„Çå„Åü„Ç¢„Ç§„ÉÜ„É†ÂèñÂæó
        if (action.includes('selected')) {
            data.selected_items = this.getSelectedItems();
        }
        
        return data;
    }
    
    getSelectedItems() {
        const checkboxes = document.querySelectorAll('input[data-checkbox="data-item"]:checked');
        return Array.from(checkboxes).map(cb => ({
            id: cb.closest('[data-item-id]')?.getAttribute('data-item-id'),
            type: cb.closest('[data-source]')?.getAttribute('data-source')
        })).filter(item => item.id);
    }
    
    isAccountingSpecificAction(action) {
        // kicho_accounting_hooks.js„ÅåÂá¶ÁêÜ„Åô„Çã„Ç¢„ÇØ„Ç∑„Éß„É≥
        const accountingActions = [
            'execute-mf-import',
            'export-to-mf',
            'execute-integrated-ai-learning',
            'add-text-to-learning',
            'bulk-approve-transactions',
            'download-rules-csv',
            'save-uploaded-rules-as-database'
        ];
        
        return accountingActions.includes(action);
    }
    
    getLoadingText(action) {
        const loadingTexts = {
            'execute-mf-import': 'MF„Éá„Éº„ÇøÂèñÂæó‰∏≠...',
            'process-csv-upload': 'CSVÂá¶ÁêÜ‰∏≠...',
            'execute-integrated-ai-learning': 'AIÂ≠¶ÁøíÂÆüË°å‰∏≠...',
            'bulk-approve-transactions': '‰∏ÄÊã¨ÊâøË™ç‰∏≠...',
            'export-to-mf': 'MFÈÄÅ‰ø°‰∏≠...',
            'refresh-all': 'Êõ¥Êñ∞‰∏≠...',
            'delete-data-item': 'ÂâäÈô§‰∏≠...'
        };
        
        return loadingTexts[action] || 'Âá¶ÁêÜ‰∏≠...';
    }
    
    getSuccessMessage(action) {
        const successMessages = {
            'execute-mf-import': 'MF„ÇØ„É©„Ç¶„Éâ„Åã„Çâ„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü',
            'process-csv-upload': 'CSV„Éá„Éº„Çø„ÇíÂá¶ÁêÜ„Åó„Åæ„Åó„Åü',
            'execute-integrated-ai-learning': 'AIÂ≠¶Áøí„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü',
            'bulk-approve-transactions': 'ÂèñÂºï„Çí‰∏ÄÊã¨ÊâøË™ç„Åó„Åæ„Åó„Åü',
            'export-to-mf': 'MF„ÇØ„É©„Ç¶„Éâ„Å´ÈÄÅ‰ø°„Åó„Åæ„Åó„Åü',
            'refresh-all': 'ÂÖ®„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü',
            'delete-data-item': '„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü'
        };
        
        return successMessages[action] || 'Âá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü';
    }
    
    updateLastUpdateTime() {
        const elements = document.querySelectorAll('#lastUpdateTime, [data-update-time]');
        elements.forEach(element => {
            element.textContent = new Date().toLocaleString();
        });
    }
}

/**
 * üé® CSSÂãïÁöÑ„Çπ„Çø„Ç§„É´ËøΩÂä†
 */
function addDynamicStyles() {
    if (document.getElementById('kicho-dynamic-styles')) return;
    
    const styles = document.createElement('style');
    styles.id = 'kicho-dynamic-styles';
    styles.textContent = `
        .kicho-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 16px;
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border-left: 4px solid #10b981;
        }
        
        .kicho-toast--show {
            transform: translateX(0);
        }
        
        .kicho-toast--error {
            border-left-color: #ef4444;
        }
        
        .kicho-toast__content {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #374151;
            font-weight: 500;
        }
        
        .kicho-toast--error .kicho-toast__content {
            color: #dc2626;
        }
        
        .kicho-toast--success .kicho-toast__content {
            color: #059669;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .kicho-loading {
            animation: pulse 1.5s infinite;
        }
    `;
    
    document.head.appendChild(styles);
}

/**
 * üöÄ „Ç∞„É≠„Éº„Éê„É´ÂàùÊúüÂåñ
 */
document.addEventListener('DOMContentLoaded', function() {
    // KICHOË®òÂ∏≥„Éö„Éº„Ç∏„Åß„ÅÆ„ÅøÂàùÊúüÂåñ
    if (document.body?.getAttribute('data-page') === 'kicho_content') {
        console.log('üéØ KICHOÂãïÁöÑÂåñ„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÈñãÂßã');
        
        // ÂãïÁöÑ„Çπ„Çø„Ç§„É´ËøΩÂä†
        addDynamicStyles();
        
        // ÂãïÁöÑUI„Ç≥„É≥„Éà„É≠„Éº„É©„ÉºÂàùÊúüÂåñ
        window.KICHO_DYNAMIC_UI = new KichoDynamicUIController();
        
        console.log('‚úÖ KICHOÂãïÁöÑÂåñ„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
        console.log('üéâ ÈùôÁöÑ‚ÜíÂãïÁöÑÂ§âÊèõÂÆå‰∫ÜÔºÅÂÖ®43ÂÄãdata-action„Éú„Çø„É≥„ÅåÂãï‰ΩúÂèØËÉΩ');
    }
});

/**
 * ‚úÖ KICHOË®òÂ∏≥„ÉÑ„Éº„É´ - ÂÆåÂÖ®ÂãïÁöÑÂåñ„Éï„É≠„É≥„Éà„Ç®„É≥„ÉâÂÆåÊàê
 * 
 * üéØ ÂÆüË£ÖÂÆå‰∫ÜÈ†ÖÁõÆ:
 * ‚úÖ 43ÂÄãdata-action„Éú„Çø„É≥„ÅÆÂãïÁöÑÂá¶ÁêÜ
 * ‚úÖ PHP„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å®„ÅÆAjaxÈÄö‰ø°
 * ‚úÖ „É™„Ç¢„É´„Çø„Ç§„É†UIÊõ¥Êñ∞„Éª„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
 * ‚úÖ Ëá™ÂãïÊõ¥Êñ∞„Ç∑„Çπ„ÉÜ„É†
 * ‚úÖ „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫„Éª„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
 * ‚úÖ „Éà„Éº„Çπ„ÉàÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†
 * ‚úÖ „Ç´„Ç¶„É≥„Çø„Éº„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
 * ‚úÖ „Éá„Éº„ÇøÈÅ∏Êäû„Éª„Éï„Ç©„Éº„É†Âá¶ÁêÜ
 * ‚úÖ Êó¢Â≠òJS„Å®„ÅÆÂÖ±Â≠òÔºàkicho_accounting_hooks.jsÔºâ
 * 
 * üß™ Âãï‰Ωú„ÅÆÊµÅ„Çå:
 * 1. „É¶„Éº„Ç∂„Éº„Åådata-action„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ
 * 2. „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ„Åß„Éá„Éº„ÇøÂèéÈõÜ„Éª„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
 * 3. PHP„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´AjaxÈÄÅ‰ø°
 * 4. „Çµ„Éº„Éê„ÉºÂá¶ÁêÜÂÆüË°å„ÉªDBÊõ¥Êñ∞
 * 5. ÁµêÊûú„ÇíJSON„ÅßÂèó‰ø°
 * 6. UIÂãïÁöÑÊõ¥Êñ∞„Éª„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆüË°å
 * 7. ÊàêÂäü/„Ç®„É©„ÉºÈÄöÁü•Ë°®Á§∫
 * 
 * üéâ „Åì„Çå„ÅßÂÆåÂÖ®„Å´ÈùôÁöÑ‚ÜíÂãïÁöÑÂ§âÊèõÂÆå‰∫ÜÔºÅ
 */