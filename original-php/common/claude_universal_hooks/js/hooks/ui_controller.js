
// CAIDS character_limit Hook
// CAIDS character_limit Hook - Âü∫Êú¨ÂÆüË£Ö
console.log('‚úÖ character_limit Hook loaded');

// CAIDS error_handling Hook

// CAIDS „Ç®„É©„ÉºÂá¶ÁêÜHook - ÂÆåÂÖ®ÂÆüË£Ö
window.CAIDS_ERROR_HANDLER = {
    isActive: true,
    errorCount: 0,
    errorHistory: [],
    
    initialize: function() {
        this.setupGlobalErrorHandler();
        this.setupUnhandledPromiseRejection();
        this.setupNetworkErrorHandler();
        console.log('‚ö†Ô∏è CAIDS „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†ÂÆåÂÖ®ÂàùÊúüÂåñ');
    },
    
    setupGlobalErrorHandler: function() {
        window.addEventListener('error', (event) => {
            this.handleError({
                type: 'JavaScript Error',
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack
            });
        });
    },
    
    setupUnhandledPromiseRejection: function() {
        window.addEventListener('unhandledrejection', (event) => {
            this.handleError({
                type: 'Unhandled Promise Rejection',
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack
            });
        });
    },
    
    setupNetworkErrorHandler: function() {
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                if (!response.ok) {
                    window.CAIDS_ERROR_HANDLER.handleError({
                        type: 'Network Error',
                        message: `HTTP ${response.status}: ${response.statusText}`,
                        url: args[0]
                    });
                }
                return response;
            } catch (error) {
                window.CAIDS_ERROR_HANDLER.handleError({
                    type: 'Network Fetch Error',
                    message: error.message,
                    url: args[0]
                });
                throw error;
            }
        };
    },
    
    handleError: function(errorInfo) {
        this.errorCount++;
        this.errorHistory.push({...errorInfo, timestamp: new Date().toISOString()});
        
        console.error('üö® CAIDS Error Handler:', errorInfo);
        this.showErrorNotification(errorInfo);
        this.reportError(errorInfo);
    },
    
    showErrorNotification: function(errorInfo) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 10px; right: 10px; z-index: 999999;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 350px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            border: 2px solid #ff6666; animation: caids-error-shake 0.5s ease-in-out;
        `;
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">üö®</span>
                <div>
                    <strong>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</strong><br>
                    <small style="opacity: 0.9;">${errorInfo.type}: ${errorInfo.message}</small>
                </div>
            </div>
        `;
        
        // CSS Animation
        if (!document.getElementById('caids-error-styles')) {
            const style = document.createElement('style');
            style.id = 'caids-error-styles';
            style.textContent = `
                @keyframes caids-error-shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 7000);
    },
    
    reportError: function(errorInfo) {
        // „Ç®„É©„Éº„É¨„Éù„Éº„ÉàÁîüÊàê„ÉªÈÄÅ‰ø°ÔºàÂ∞ÜÊù•„ÅÆÊã°ÂºµÁî®Ôºâ
        const report = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            errorCount: this.errorCount,
            sessionId: this.getSessionId(),
            ...errorInfo
        };
        
        console.log('üìã CAIDS Error Report:', report);
        localStorage.setItem('caids_last_error', JSON.stringify(report));
    },
    
    getSessionId: function() {
        let sessionId = sessionStorage.getItem('caids_session_id');
        if (!sessionId) {
            sessionId = 'caids_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('caids_session_id', sessionId);
        }
        return sessionId;
    },
    
    getErrorStats: function() {
        return {
            totalErrors: this.errorCount,
            recentErrors: this.errorHistory.slice(-10),
            sessionId: this.getSessionId()
        };
    }
};

window.CAIDS_ERROR_HANDLER.initialize();

/**
 * KICHOË®òÂ∏≥„ÉÑ„Éº„É´Â∞ÇÁî® „Ç∑„É≥„Éó„É´UIÂà∂Âæ°„ÇØ„É©„Çπ
 * 
 * ÁõÆÁöÑ: hooks„Ç∑„Çπ„ÉÜ„É†„Åß„ÅÆÊúÄ‰ΩéÈôê„ÅÆUIÂà∂Âæ°„ÅÆ„Åø
 * - ÂâäÈô§„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
 * - „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
 * - ÊàêÂäü„Éª„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
 * - „Éá„Éº„ÇøÊõ¥Êñ∞
 */

class KichoUIController {
    constructor(config) {
        this.config = config || {};
        this.init();
    }
    
    init() {
        console.log('üé® KICHO UI Controller ÂàùÊúüÂåñ');
        
        // ÊúÄ‰ΩéÈôê„ÅÆCSSÊ≥®ÂÖ•
        this.injectMinimalCSS();
        
        // „Éà„Éº„Çπ„ÉàË°®Á§∫Áî®„Ç≥„É≥„ÉÜ„Éä‰ΩúÊàê
        this.createToastContainer();
    }
    
    injectMinimalCSS() {
        if (document.getElementById('kicho-minimal-css')) return;
        
        const style = document.createElement('style');
        style.id = 'kicho-minimal-css';
        style.textContent = `
            /* KICHO hooksÁî® ÊúÄÂ∞èÈôêCSS */
            .kicho-loading {
                opacity: 0.6;
                pointer-events: none;
                position: relative;
            }
            
            .kicho-loading::after {
                content: "‚ü≥";
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 16px;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                0% { transform: translate(-50%, -50%) rotate(0deg); }
                100% { transform: translate(-50%, -50%) rotate(360deg); }
            }
            
            .kicho-delete-fade {
                transition: opacity 0.3s ease;
                opacity: 0.3;
                background-color: #ffebee !important;
            }
            
            .kicho-toast-container {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
            }
            
            .kicho-toast {
                background: white;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                margin-bottom: 8px;
                padding: 12px 16px;
                display: flex;
                align-items: center;
                gap: 8px;
                min-width: 250px;
                border-left: 4px solid;
                animation: slideIn 0.3s ease-out;
            }
            
            .kicho-toast.success { border-left-color: #4CAF50; }
            .kicho-toast.error { border-left-color: #f44336; }
            .kicho-toast.warning { border-left-color: #ff9800; }
            .kicho-toast.info { border-left-color: #2196F3; }
            
            @keyframes slideIn {
                0% { transform: translateX(100%); opacity: 0; }
                100% { transform: translateX(0); opacity: 1; }
            }
        `;
        
        document.head.appendChild(style);
    }
    
    createToastContainer() {
        if (document.getElementById('kicho-toast-container')) return;
        
        const container = document.createElement('div');
        container.id = 'kicho-toast-container';
        container.className = 'kicho-toast-container';
        document.body.appendChild(container);
    }
    
    // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
    showLoading(element) {
        if (!element) return;
        
        element.classList.add('kicho-loading');
        element.disabled = true;
        
        console.log('üîÑ „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈñãÂßã');
    }
    
    // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
    hideLoading(element) {
        if (!element) return;
        
        element.classList.remove('kicho-loading');
        element.disabled = false;
        
        console.log('‚úÖ „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁµÇ‰∫Ü');
    }
    
    // ÂâäÈô§„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÔºàÂØæË±°Ë¶ÅÁ¥†„ÇíÂæê„ÄÖ„Å´ÈùûË°®Á§∫Ôºâ
    startDeleteAnimation(element) {
        if (!element) return;
        
        element.classList.add('kicho-delete-fade');
        
        // 0.5ÁßíÂæå„Å´Ë¶ÅÁ¥†„ÇíÂâäÈô§
        setTimeout(() => {
            const row = element.closest('tr, .data-row, .item, [data-item-id]');
            if (row) {
                row.remove();
                console.log('üóëÔ∏è Ë¶ÅÁ¥†ÂâäÈô§ÂÆå‰∫Ü');
            }
        }, 500);
    }
    
    // ÊàêÂäü„Éª„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
    showMessage(type, message) {
        const toast = document.createElement('div');
        toast.className = `kicho-toast ${type}`;
        
        const icon = this.getIcon(type);
        toast.innerHTML = `
            <span>${icon}</span>
            <span>${message}</span>
        `;
        
        const container = document.getElementById('kicho-toast-container');
        container.appendChild(toast);
        
        // 3ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
        
        console.log(`üí¨ „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫: ${type} - ${message}`);
    }
    
    getIcon(type) {
        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
        };
        return icons[type] || '‚ÑπÔ∏è';
    }
    
    // „Éá„Éº„ÇøÊõ¥Êñ∞ÔºàÁµ±Ë®àÊï∞ÂÄ§„Å™„Å©Ôºâ
    updateData(updates) {
        if (!updates || typeof updates !== 'object') return;
        
        Object.entries(updates).forEach(([key, value]) => {
            // ID„ÄÅ„ÇØ„É©„Çπ„ÄÅdata-statÂ±ûÊÄß„ÅßË¶ÅÁ¥†„ÇíÊ§úÁ¥¢
            const selectors = [`#${key}`, `.${key}`, `[data-stat="${key}"]`];
            
            for (const selector of selectors) {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.value = value;
                    } else {
                        element.textContent = value;
                    }
                });
            }
        });
        
        console.log('üìä „Éá„Éº„ÇøÊõ¥Êñ∞ÂÆå‰∫Ü:', updates);
    }
    
    // „É™„Çπ„ÉàÊõ¥Êñ∞ÔºàHTMLÁΩÆÊèõÔºâ
    updateList(selector, html) {
        const element = document.querySelector(selector);
        if (element && html) {
            element.innerHTML = html;
            console.log(`üìù „É™„Çπ„ÉàÊõ¥Êñ∞: ${selector}`);
        }
    }
    
    // „Éï„Ç©„Éº„É†„ÇØ„É™„Ç¢
    clearForm(selector) {
        const form = document.querySelector(selector);
        if (form) {
            if (form.tagName === 'FORM') {
                form.reset();
            } else {
                // ÂÄãÂà•ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇØ„É™„Ç¢
                const inputs = form.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            }
            console.log(`üóëÔ∏è „Éï„Ç©„Éº„É†„ÇØ„É™„Ç¢: ${selector}`);
        }
    }
    
    // Âçò‰∏Ä„Éï„Ç£„Éº„É´„Éâ„ÇØ„É™„Ç¢
    clearInput(selector) {
        const input = document.querySelector(selector);
        if (input) {
            input.value = '';
            console.log(`üóëÔ∏è ÂÖ•Âäõ„ÇØ„É™„Ç¢: ${selector}`);
        }
    }
    
    // ÈÅ∏ÊäûÁä∂ÊÖã„ÅÆÂàá„ÇäÊõø„Åà
    toggleSelection(element, isSelected) {
        if (!element) return;
        
        if (isSelected) {
            element.classList.add('kicho-selected');
        } else {
            element.classList.remove('kicho-selected');
        }
    }
    
    // „Éö„Éº„Ç∏„É™„É≠„Éº„ÉâÔºàAjaxÊõ¥Êñ∞Ôºâ
    refreshPage() {
        // ÂÆüÈöõ„Å´„ÅØ„Éö„Éº„Ç∏„É™„É≠„Éº„Éâ„Åß„ÅØ„Å™„Åè„ÄÅÁµ±Ë®à„Éá„Éº„Çø„Å™„Å©„ÅÆÂÜçË™≠„ÅøËæº„Åø
        console.log('üîÑ „Éö„Éº„Ç∏ÂÜÖÂÆπÊõ¥Êñ∞‰∏≠...');
        
        // get_statistics„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂÆüË°å
        if (window.KICHO_HOOKS_ENGINE) {
            window.KICHO_HOOKS_ENGINE.executeAction('get_statistics', null, {});
        }
    }
}

// „Ç∞„É≠„Éº„Éê„É´ÂèÇÁÖßÁî®
window.KichoUIController = KichoUIController;