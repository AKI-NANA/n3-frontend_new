
// CAIDS processing_capacity_monitoring Hook
// CAIDS processing_capacity_monitoring Hook - Âü∫Êú¨ÂÆüË£Ö
console.log('‚úÖ processing_capacity_monitoring Hook loaded');

// CAIDS character_limit Hook
// CAIDS character_limit Hook - Âü∫Êú¨ÂÆüË£Ö
console.log('‚úÖ character_limit Hook loaded');

// CAIDS error_handling Hook

// CAIDS „Ç®„É©„ÉºÂá¶ÁêÜHook - ÂÆåÂÖ®ÂÆüË£Ö
window.CAIDS_ERROR_HANDLER = {
    isActive: true,
    errorCount: 0,
    errorHistory: [],
    
    initialize: function() {
        this.setupGlobalErrorHandler();
        this.setupUnhandledPromiseRejection();
        this.setupNetworkErrorHandler();
        console.log('‚ö†Ô∏è CAIDS „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†ÂÆåÂÖ®ÂàùÊúüÂåñ');
    },
    
    setupGlobalErrorHandler: function() {
        window.addEventListener('error', (event) => {
            this.handleError({
                type: 'JavaScript Error',
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack
            });
        });
    },
    
    setupUnhandledPromiseRejection: function() {
        window.addEventListener('unhandledrejection', (event) => {
            this.handleError({
                type: 'Unhandled Promise Rejection',
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack
            });
        });
    },
    
    setupNetworkErrorHandler: function() {
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                if (!response.ok) {
                    window.CAIDS_ERROR_HANDLER.handleError({
                        type: 'Network Error',
                        message: `HTTP ${response.status}: ${response.statusText}`,
                        url: args[0]
                    });
                }
                return response;
            } catch (error) {
                window.CAIDS_ERROR_HANDLER.handleError({
                    type: 'Network Fetch Error',
                    message: error.message,
                    url: args[0]
                });
                throw error;
            }
        };
    },
    
    handleError: function(errorInfo) {
        this.errorCount++;
        this.errorHistory.push({...errorInfo, timestamp: new Date().toISOString()});
        
        console.error('üö® CAIDS Error Handler:', errorInfo);
        this.showErrorNotification(errorInfo);
        this.reportError(errorInfo);
    },
    
    showErrorNotification: function(errorInfo) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 10px; right: 10px; z-index: 999999;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 350px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            border: 2px solid #ff6666; animation: caids-error-shake 0.5s ease-in-out;
        `;
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">üö®</span>
                <div>
                    <strong>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</strong><br>
                    <small style="opacity: 0.9;">${errorInfo.type}: ${errorInfo.message}</small>
                </div>
            </div>
        `;
        
        // CSS Animation
        if (!document.getElementById('caids-error-styles')) {
            const style = document.createElement('style');
            style.id = 'caids-error-styles';
            style.textContent = `
                @keyframes caids-error-shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 7000);
    },
    
    reportError: function(errorInfo) {
        // „Ç®„É©„Éº„É¨„Éù„Éº„ÉàÁîüÊàê„ÉªÈÄÅ‰ø°ÔºàÂ∞ÜÊù•„ÅÆÊã°ÂºµÁî®Ôºâ
        const report = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            errorCount: this.errorCount,
            sessionId: this.getSessionId(),
            ...errorInfo
        };
        
        console.log('üìã CAIDS Error Report:', report);
        localStorage.setItem('caids_last_error', JSON.stringify(report));
    },
    
    getSessionId: function() {
        let sessionId = sessionStorage.getItem('caids_session_id');
        if (!sessionId) {
            sessionId = 'caids_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('caids_session_id', sessionId);
        }
        return sessionId;
    },
    
    getErrorStats: function() {
        return {
            totalErrors: this.errorCount,
            recentErrors: this.errorHistory.slice(-10),
            sessionId: this.getSessionId()
        };
    }
};

window.CAIDS_ERROR_HANDLER.initialize();

/**
 * KICHOË®òÂ∏≥„ÉÑ„Éº„É´Â∞ÇÁî® HooksÂÆüË°å„Ç®„É≥„Ç∏„É≥
 * 
 * Ê©üËÉΩ:
 * - 40ÂÄã„ÅÆdata-action„Éú„Çø„É≥„ÇíÁµ±ÂêàÁÆ°ÁêÜ
 * - UI/UX„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âà∂Âæ°
 * - AjaxÈÄö‰ø°„Éª„Ç®„É©„ÉºÂá¶ÁêÜ
 * - MFÈÄ£Êê∫„ÉªAIÂ≠¶ÁøíÁâπÂåñÊ©üËÉΩ
 */

class KichoHooksEngine {
    constructor() {
        this.config = null;
        this.uiController = null;
        this.errorHandler = null;
        this.retryAttempts = new Map();
        this.maxRetries = 3;
        this.requestId = 0;
        
        this.init();
    }
    
    async init() {
        console.log('üöÄ KICHO Hooks Engine ÂàùÊúüÂåñÈñãÂßã');
        
        try {
            // Ë®≠ÂÆö„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
            await this.loadConfig();
            
            // ‰æùÂ≠ò„ÇØ„É©„ÇπÂàùÊúüÂåñ
            this.uiController = new KichoUIController(this.config);
            this.errorHandler = new KichoErrorHandler(this.config);
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
            this.setupEventListeners();
            
            console.log('‚úÖ KICHO Hooks Engine ÂàùÊúüÂåñÂÆå‰∫Ü');
            
        } catch (error) {
            console.error('‚ùå KICHO Hooks Engine ÂàùÊúüÂåñÂ§±Êïó:', error);
        }
    }
    
    async loadConfig() {
        try {
            // Ë§áÊï∞Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„Çí‰∏¶Ë°åË™≠„ÅøËæº„Åø
            const [hooksConfig, animationsConfig] = await Promise.all([
                fetch('/common/claude_universal_hooks/config/hooks/kicho_hooks.json').then(r => r.json()),
                fetch('/common/claude_universal_hooks/config/hooks/ui_animations.json').then(r => r.json())
            ]);
            
            this.config = {
                ...hooksConfig,
                animations: animationsConfig
            };
            
            console.log('‚úÖ KICHO HooksË®≠ÂÆöË™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
            
        } catch (error) {
            console.error('‚ùå KICHO HooksË®≠ÂÆöË™≠„ÅøËæº„ÅøÂ§±Êïó:', error);
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØË®≠ÂÆö
            this.config = this.getDefaultConfig();
        }
    }
    
    getDefaultConfig() {
        return {
            actions: {},
            error_handling: {
                retry_enabled: true,
                max_retries: 3,
                retry_delay: 1000
            },
            ui_patterns: {},
            mf_integration: {
                backup_before_send: true,
                approval_required: true
            }
        };
    }
    
    setupEventListeners() {
        // data-action„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„ÉàÂßîË≠≤
        document.addEventListener('click', (event) => {
            const target = event.target.closest('[data-action]');
            if (!target) return;
            
            const action = target.getAttribute('data-action');
            
            // KICHOÂ∞ÇÁî®„Ç¢„ÇØ„Ç∑„Éß„É≥Âà§ÂÆö
            if (this.isKichoAction(action)) {
                event.preventDefault();
                event.stopImmediatePropagation();
                
                this.executeAction(action, target);
            }
        }, true); // „Ç≠„É£„Éó„ÉÅ„É£„Éï„Çß„Éº„Ç∫„ÅßÊçïÁç≤ÔºàÁ´∂ÂêàÂõûÈÅøÔºâ
        
        console.log('‚úÖ „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆöÂÆå‰∫Ü');
    }
    
    isKichoAction(action) {
        const KICHO_ACTIONS = [
            'refresh-all', 'toggle-auto-refresh', 'health-check',
            'execute-mf-import', 'process-csv-upload', 'add-text-to-learning',
            'show-import-history', 'show-mf-history', 'execute-mf-recovery',
            'show-duplicate-history', 'show-ai-learning-history', 'show-optimization-suggestions',
            'select-all-imported-data', 'select-by-date-range', 'select-by-source',
            'delete-selected-data', 'delete-data-item',
            'execute-integrated-ai-learning',
            'download-rules-csv', 'create-new-rule', 'download-all-rules-csv',
            'rules-csv-upload', 'save-uploaded-rules-as-database',
            'edit-saved-rule', 'delete-saved-rule',
            'download-pending-csv', 'download-pending-transactions-csv',
            'approval-csv-upload', 'bulk-approve-transactions',
            'view-transaction-details', 'delete-approved-transaction',
            'refresh-ai-history', 'load-more-sessions',
            'execute-full-backup', 'export-to-mf', 'create-manual-backup',
            'generate-advanced-report', 'get_statistics', 'get-ai-status', 'get-ai-history'
        ];
        
        return KICHO_ACTIONS.includes(action);
    }
    
    async executeAction(actionName, target, customData = {}) {
        const requestId = ++this.requestId;
        console.log(`üéØ „Ç¢„ÇØ„Ç∑„Éß„É≥ÂÆüË°å: ${actionName} (ID: ${requestId})`);
        
        const actionConfig = this.config?.actions?.[actionName];
        
        if (!actionConfig) {
            console.warn(`‚ö†Ô∏è Êú™ÂÆöÁæ©„Ç¢„ÇØ„Ç∑„Éß„É≥: ${actionName}`);
            return;
        }
        
        try {
            // 1. Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
            if (actionConfig.confirmation && !confirm(actionConfig.confirmation)) {
                console.log(`‚èπÔ∏è „É¶„Éº„Ç∂„Éº„Ç≠„É£„É≥„Çª„É´: ${actionName}`);
                return;
            }
            
            // 2. „Éá„Éº„ÇøÊäΩÂá∫
            const data = this.extractDataFromTarget(target, customData);
            
            // 3. „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆüË°åÔºàÂøÖË¶Å„Å™Â†¥ÂêàÔºâ
            if (actionConfig.backup_before || actionConfig.backup_required) {
                await this.executeBackup();
            }
            
            // 4. UIÊõ¥Êñ∞ÈñãÂßã
            if (actionConfig.ui_update) {
                this.uiController.startUIUpdate(actionConfig.ui_update, target);
            }
            
            // 5. AjaxÈÄö‰ø°ÂÆüË°å
            const result = await this.executeAjax(actionName, data, requestId);
            
            // 6. ÊàêÂäüÂá¶ÁêÜ
            await this.handleSuccess(result, actionConfig, target, requestId);
            
        } catch (error) {
            // 7. „Ç®„É©„ÉºÂá¶ÁêÜ
            await this.handleError(error, actionConfig, target, actionName, requestId);
        }
    }
    
    extractDataFromTarget(target, customData = {}) {
        const data = { ...customData };
        
        // data-* Â±ûÊÄß„ÇíÊäΩÂá∫
        Object.entries(target.dataset).forEach(([key, value]) => {
            if (key !== 'action') {
                // camelCase ‚Üí snake_case Â§âÊèõ
                const phpKey = key.replace(/([A-Z])/g, '_$1').toLowerCase();
                data[phpKey] = value;
            }
        });
        
        // „Éï„Ç©„Éº„É†ÂÖ•ÂäõÂÄ§„ÇíÊäΩÂá∫
        const form = target.closest('form');
        if (form) {
            const formData = new FormData(form);
            for (const [key, value] of formData.entries()) {
                data[key] = value;
            }
        }
        
        // ÁâπÂÆöË¶ÅÁ¥†„ÅÆÂÄ§„ÇíÊäΩÂá∫
        const associatedInputs = target.getAttribute('data-inputs');
        if (associatedInputs) {
            associatedInputs.split(',').forEach(selector => {
                const input = document.querySelector(selector.trim());
                if (input) {
                    const name = input.name || input.id || selector.replace(/[#.]/, '');
                    data[name] = input.value;
                }
            });
        }
        
        return data;
    }
    
    async executeAjax(action, data, requestId) {
        const formData = new FormData();
        formData.append('action', action);
        formData.append('csrf_token', this.getCSRFToken());
        formData.append('request_id', requestId);
        
        // „Éá„Éº„Çø„ÇíFormData„Å´ËøΩÂä†
        Object.entries(data).forEach(([key, value]) => {
            if (value !== null && value !== undefined) {
                formData.append(key, value);
            }
        });
        
        console.log(`üåê AjaxÈÄÅ‰ø°: ${action}`, Object.fromEntries(formData));
        
        const response = await fetch(window.location.pathname, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-KICHO-Hooks': '1.0'
            },
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log(`üì® AjaxÂèó‰ø°: ${action}`, result);
        
        return result;
    }
    
    async handleSuccess(result, actionConfig, target, requestId) {
        console.log(`‚úÖ ÊàêÂäüÂá¶ÁêÜ: ${actionConfig.success_message || 'Âá¶ÁêÜÂÆå‰∫Ü'}`);
        
        // 1. „É™„Éà„É©„Ç§„Ç´„Ç¶„É≥„Çø„É™„Çª„ÉÉ„Éà
        this.retryAttempts.delete(requestId);
        
        // 2. UIÊõ¥Êñ∞ÂÆå‰∫Ü
        if (actionConfig.ui_update) {
            this.uiController.finishUIUpdate(actionConfig.ui_update, target, result);
        }
        
        // 3. ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        if (actionConfig.success_message) {
            this.uiController.showToast('success', actionConfig.success_message);
        }
        
        // 4. ÁâπÂÆöUIÊìç‰ΩúÂÆüË°å
        await this.executePostSuccessActions(actionConfig, result);
    }
    
    async executePostSuccessActions(actionConfig, result) {
        // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇØ„É™„Ç¢
        if (actionConfig.clear_input) {
            const input = document.querySelector(actionConfig.clear_input);
            if (input) input.value = '';
        }
        
        // „Éï„Ç©„Éº„É†„ÇØ„É™„Ç¢
        if (actionConfig.clear_form) {
            const form = document.querySelector(actionConfig.clear_form);
            if (form) form.reset();
        }
        
        // „É™„Çπ„ÉàÊõ¥Êñ∞
        if (actionConfig.refresh_list) {
            const list = document.querySelector(actionConfig.refresh_list);
            if (list && result.html) {
                list.innerHTML = result.html;
            }
        }
        
        // Áµ±Ë®àÊõ¥Êñ∞
        if (actionConfig.refresh_stats && result.stats) {
            this.updateStats(result.stats);
        }
        
        // „ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂÆüË°å
        if (actionConfig.trigger_download && result.download_url) {
            this.triggerDownload(result.download_url, result.filename);
        }
        
        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        if (actionConfig.modal_content && result.modal_html) {
            this.uiController.showModal(actionConfig.modal_content, result.modal_html);
        }
        
        // Ëá™Âãï„É™„É≠„Éº„Éâ
        if (actionConfig.ajax_refresh) {
            setTimeout(() => this.refreshPageContent(), 1000);
        }
    }
    
    async handleError(error, actionConfig, target, actionName, requestId) {
        console.error(`‚ùå „Ç®„É©„ÉºÂá¶ÁêÜ: ${actionName}`, error);
        
        // 1. UIÊõ¥Êñ∞ÂÅúÊ≠¢
        this.uiController.stopUIUpdate(target);
        
        // 2. „É™„Éà„É©„Ç§Âá¶ÁêÜ
        if (actionConfig.error_retry && this.shouldRetry(requestId)) {
            const retryCount = this.retryAttempts.get(requestId) || 0;
            this.retryAttempts.set(requestId, retryCount + 1);
            
            console.log(`üîÑ „É™„Éà„É©„Ç§ ${retryCount + 1}/${this.maxRetries}: ${actionName}`);
            
            // ÈÅÖÂª∂Âæå„É™„Éà„É©„Ç§
            setTimeout(() => {
                this.executeAction(actionName, target);
            }, this.config.error_handling.retry_delay || 1000);
            
            return;
        }
        
        // 3. „Ç®„É©„ÉºÂá¶ÁêÜ„Å´ÂßîË≠≤
        this.errorHandler.handleError(error, actionName, target);
    }
    
    shouldRetry(requestId) {
        const currentAttempts = this.retryAttempts.get(requestId) || 0;
        return currentAttempts < this.maxRetries;
    }
    
    async executeBackup() {
        console.log('üíæ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆüË°å‰∏≠...');
        // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂá¶ÁêÜ„ÅÆÂÆüË£Ö
        // ÂÆüÈöõ„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åß„ÅØ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóAPI„ÇíÂëº„Å≥Âá∫„Åó
    }
    
    getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]')?.content || '';
    }
    
    updateStats(stats) {
        Object.entries(stats).forEach(([key, value]) => {
            const element = document.querySelector(`#${key}, .${key}, [data-stat="${key}"]`);
            if (element) {
                element.textContent = value;
            }
        });
    }
    
    triggerDownload(url, filename) {
        const link = document.createElement('a');
        link.href = url;
        link.download = filename || '';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    refreshPageContent() {
        // AjaxÁµåÁî±„Åß„Éö„Éº„Ç∏„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊõ¥Êñ∞
        // „Éö„Éº„Ç∏ÂÖ®‰Ωì„É™„É≠„Éº„Éâ„Åß„ÅØ„Å™„Åè„ÄÅÂøÖË¶ÅÈÉ®ÂàÜ„ÅÆ„ÅøÊõ¥Êñ∞
        console.log('üîÑ „Éö„Éº„Ç∏„Ç≥„É≥„ÉÜ„É≥„ÉÑÊõ¥Êñ∞‰∏≠...');
    }
}

// „Ç∞„É≠„Éº„Éê„É´ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    // „Éö„Éº„Ç∏Âà§ÂÆö
    const isKichoPage = document.body?.matches('[data-page="kicho_content"]') ||
                       window.location.href.includes('kicho_content') ||
                       window.location.search.includes('page=kicho_content');
    
    if (isKichoPage) {
        console.log('üéØ KICHOÂ∞ÇÁî®„Éö„Éº„Ç∏Ê§úÂá∫ - Hooks EngineÂàùÊúüÂåñ');
        window.KICHO_HOOKS_ENGINE = new KichoHooksEngine();
    } else {
        console.log('‚ÑπÔ∏è KICHO„Éö„Éº„Ç∏‰ª•Â§ñ - Hooks EngineÂàùÊúüÂåñ„Çπ„Ç≠„ÉÉ„Éó');
    }
});

// ‰øùÈô∫„ÅÆ„Åü„ÇÅ„ÅÆwindow.onload
window.addEventListener('load', function() {
    if (!window.KICHO_HOOKS_ENGINE && 
        (window.location.href.includes('kicho') || document.querySelector('[data-action]'))) {
        console.log('üîÑ ÈÅÖÂª∂ÂàùÊúüÂåñ: KICHO Hooks Engine');
        window.KICHO_HOOKS_ENGINE = new KichoHooksEngine();
    }
});