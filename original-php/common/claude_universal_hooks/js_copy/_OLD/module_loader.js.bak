/**
 * üè¢ ‰ºÅÊ•≠„É¨„Éô„É´ÂãïÁöÑ„É¢„Ç∏„É•„Éº„É´„É≠„Éº„ÉÄ„ÉºÔºàAjaxÁµ±ÂêàÁâàÔºâ
 * „Éï„Ç°„Ç§„É´: common/js/module_loader.js
 * 
 * ‚úÖ AjaxÂ∞ÇÁî®„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÁµ±Âêà
 * ‚úÖ Êó¢Â≠ò„Éè„É≥„Éâ„É©„ÉºËá™ÂãïÊ§úÂá∫
 * ‚úÖ „É¢„Ç∏„É•„Éº„É´Âà•„É´„Éº„ÉÜ„Ç£„É≥„Ç∞
 * ‚úÖ „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÊ©üËÉΩ
 */

"use strict";

// Ajax „Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÁÆ°ÁêÜ„ÇØ„É©„Çπ
class AjaxEndpointManager {
    constructor() {
        this.endpoints = new Map();
        this.fallbackUrl = '/ajax_module_router.php';
        this.defaultTimeout = 15000;
        
        // Êó¢Â≠ò„Éè„É≥„Éâ„É©„Éº„ÅÆÁôªÈå≤
        this.registerKnownEndpoints();
    }
    
    /**
     * Êó¢Â≠ò„ÅÆAjax „Éè„É≥„Éâ„É©„Éº„ÇíÁôªÈå≤
     */
    registerKnownEndpoints() {
        const knownEndpoints = [
            // „É¢„Ç∏„É•„Éº„É´Âà•Â∞ÇÁî®„Éè„É≥„Éâ„É©„Éº
            { module: 'kicho', url: '/modules/kicho/kicho_ajax_handler.php', priority: 1 },
            { module: 'apikey', url: '/modules/apikey/apikey_ajax_handler.php', priority: 1 },
            { module: 'shohin', url: '/modules/shohin/shohin_ajax_handler.php', priority: 1 },
            { module: 'zaiko', url: '/modules/zaiko/zaiko_ajax_handler.php', priority: 1 },
            { module: 'juchu_kanri', url: '/modules/juchu_kanri/juchu_ajax_handler.php', priority: 1 },
            
            // Ê±éÁî®„Éè„É≥„Éâ„É©„Éº
            { module: 'other', url: '/modules/other/other_modules_ajax_handler.php', priority: 2 },
            
            // Áµ±Âêà„Éè„É≥„Éâ„É©„ÉºÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
            { module: '*', url: '/ajax_module_router.php', priority: 3 },
            
            // Êó¢Â≠ò„ÅÆ‰∏ÄËà¨ÁöÑ„Éë„Çø„Éº„É≥
            { module: '*', url: '/?ajax=1', priority: 4 },
            { module: '*', url: '/ajax.php', priority: 5 }
        ];
        
        knownEndpoints.forEach(endpoint => {
            if (!this.endpoints.has(endpoint.module)) {
                this.endpoints.set(endpoint.module, []);
            }
            this.endpoints.get(endpoint.module).push(endpoint);
        });
        
        // ÂÑ™ÂÖàÈ†Ü‰Ωç„Åß„ÇΩ„Éº„Éà
        this.endpoints.forEach(endpoints => {
            endpoints.sort((a, b) => a.priority - b.priority);
        });
        
        console.log('üì° Ajax „Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÁôªÈå≤ÂÆå‰∫Ü:', this.endpoints);
    }
    
    /**
     * „É¢„Ç∏„É•„Éº„É´Áî®„ÅÆ„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÂèñÂæó
     */
    getEndpointForModule(module) {
        // Â∞ÇÁî®„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÂÑ™ÂÖà
        const moduleEndpoints = this.endpoints.get(module);
        if (moduleEndpoints && moduleEndpoints.length > 0) {
            return moduleEndpoints[0].url;
        }
        
        // Ê±éÁî®„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà
        const genericEndpoints = this.endpoints.get('*');
        if (genericEndpoints && genericEndpoints.length > 0) {
            return genericEndpoints[0].url;
        }
        
        // ÊúÄÁµÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        return this.fallbackUrl;
    }
    
    /**
     * Ëá™Âãï„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÊ§úÂá∫
     */
    async detectBestEndpoint(module, action) {
        const candidates = [
            ...this.endpoints.get(module) || [],
            ...this.endpoints.get('*') || []
        ];
        
        console.log(`üîç „Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÊ§úÂá∫ÈñãÂßã: ${module}#${action}`);
        
        for (const candidate of candidates) {
            try {
                const result = await this.testEndpoint(candidate.url, action, { module });
                if (result.success) {
                    console.log(`‚úÖ ÊúÄÈÅ©„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÁô∫Ë¶ã: ${candidate.url}`);
                    return candidate.url;
                }
            } catch (error) {
                console.log(`‚ùå „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÉÜ„Çπ„ÉàÂ§±Êïó: ${candidate.url} - ${error.message}`);
            }
        }
        
        console.warn(`‚ö†Ô∏è ÊúÄÈÅ©„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÊú™Áô∫Ë¶ã„ÄÅ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ‰ΩøÁî®: ${module}`);
        return this.fallbackUrl;
    }
    
    /**
     * „Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÉÜ„Çπ„Éà
     */
    async testEndpoint(url, action = 'health_check', data = {}) {
        const formData = new FormData();
        formData.append('action', action);
        Object.keys(data).forEach(key => {
            formData.append(key, data[key]);
        });
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData,
            timeout: 5000
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const text = await response.text();
        
        // JSON „É¨„Çπ„Éù„É≥„ÇπÁ¢∫Ë™ç
        try {
            const json = JSON.parse(text);
            return json;
        } catch (parseError) {
            // HTML „É¨„Çπ„Éù„É≥„Çπ„ÅÆÂ†¥Âêà„ÅØ„Ç®„É©„Éº
            if (text.includes('<!DOCTYPE') || text.includes('<html')) {
                throw new Error('HTML response received');
            }
            throw parseError;
        }
    }
}

// Áµ±ÂêàAjaxÈÄö‰ø°„ÇØ„É©„Çπ
class UnifiedAjaxManager {
    constructor() {
        this.endpointManager = new AjaxEndpointManager();
        this.requestHistory = new Map();
        this.activeRequests = new Map();
        this.retryCount = 3;
        this.retryDelay = 1000;
    }
    
    /**
     * Áµ±ÂêàAjax „É™„ÇØ„Ç®„Çπ„Éà
     */
    async request(module, action, data = {}, options = {}) {
        const requestId = this.generateRequestId();
        const config = {
            timeout: options.timeout || 15000,
            retries: options.retries || this.retryCount,
            autoDetect: options.autoDetect !== false,
            endpoint: options.endpoint || null,
            ...options
        };
        
        console.log(`üì§ Áµ±ÂêàAjax [${requestId}]: ${module}#${action}`, data);
        
        try {
            // „Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÊ±∫ÂÆö
            let endpoint;
            if (config.endpoint) {
                endpoint = config.endpoint;
            } else if (config.autoDetect) {
                endpoint = await this.endpointManager.detectBestEndpoint(module, action);
            } else {
                endpoint = this.endpointManager.getEndpointForModule(module);
            }
            
            // „É™„ÇØ„Ç®„Çπ„ÉàÂÆüË°å
            const result = await this.executeRequest(endpoint, module, action, data, config);
            
            console.log(`‚úÖ Áµ±ÂêàAjaxÊàêÂäü [${requestId}]: ${module}#${action}`, result);
            return result;
            
        } catch (error) {
            console.error(`‚ùå Áµ±ÂêàAjaxÂ§±Êïó [${requestId}]: ${module}#${action}`, error);
            throw error;
        }
    }
    
    /**
     * „É™„ÇØ„Ç®„Çπ„ÉàÂÆüË°åÔºà„É™„Éà„É©„Ç§ÂØæÂøúÔºâ
     */
    async executeRequest(endpoint, module, action, data, config) {
        let lastError;
        
        for (let attempt = 1; attempt <= config.retries; attempt++) {
            try {
                console.log(`üîÑ Ë©¶Ë°å ${attempt}/${config.retries}: ${endpoint}`);
                
                const formData = new FormData();
                formData.append('action', action);
                formData.append('module', module);
                
                // CSRF „Éà„Éº„ÇØ„É≥ËøΩÂä†
                const csrfToken = this.getCSRFToken();
                if (csrfToken) {
                    formData.append('csrf_token', csrfToken);
                }
                
                // „Éá„Éº„ÇøËøΩÂä†
                Object.keys(data).forEach(key => {
                    if (data[key] !== null && data[key] !== undefined) {
                        formData.append(key, data[key]);
                    }
                });
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData,
                    timeout: config.timeout
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                
                // JSON Ëß£Êûê
                try {
                    const json = JSON.parse(text);
                    return json;
                } catch (parseError) {
                    // HTML „É¨„Çπ„Éù„É≥„Çπ„Åã„ÇâJSONÈÉ®ÂàÜ„ÇíÊäΩÂá∫Ë©¶Ë°å
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        try {
                            return JSON.parse(jsonMatch[0]);
                        } catch (e) {
                            throw new Error('Invalid JSON in response');
                        }
                    }
                    throw new Error('No valid JSON found in response');
                }
                
            } catch (error) {
                lastError = error;
                console.warn(`‚ö†Ô∏è Ë©¶Ë°å${attempt}Â§±Êïó: ${error.message}`);
                
                if (attempt < config.retries) {
                    await this.delay(this.retryDelay * attempt);
                }
            }
        }
        
        throw lastError;
    }
    
    /**
     * CSRF „Éà„Éº„ÇØ„É≥ÂèñÂæó
     */
    getCSRFToken() {
        return window.NAGANO3_CSRF_TOKEN || 
               document.querySelector('meta[name="csrf-token"]')?.content ||
               '';
    }
    
    /**
     * „É™„ÇØ„Ç®„Çπ„ÉàIDÁîüÊàê
     */
    generateRequestId() {
        return `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
    
    /**
     * ÈÅÖÂª∂Èñ¢Êï∞
     */
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// DynamicModuleLoader „Å´AjaxÊ©üËÉΩ„ÇíÁµ±Âêà
class DynamicModuleLoader {
    constructor(options = {}) {
        this.config = {
            baseUrl: options.baseUrl || this.getBaseUrl(),
            timeout: options.timeout || 15000,
            enableAjax: options.enableAjax !== false,
            ...options
        };
        
        this.loadedModules = new Map();
        this.log = new UnifiedLogger('ModuleLoader');
        
        // AjaxÊ©üËÉΩÁµ±Âêà
        if (this.config.enableAjax) {
            this.ajax = new UnifiedAjaxManager();
            this.log.info('AjaxÊ©üËÉΩÁµ±ÂêàÂÆå‰∫Ü');
        }
    }
    
    /**
     * „É¢„Ç∏„É•„Éº„É´Áî®AjaxÂÆüË°å
     */
    async executeModuleAjax(moduleName, action, data = {}, options = {}) {
        if (!this.ajax) {
            throw new Error('AjaxÊ©üËÉΩ„ÅåÁÑ°Âäπ„Åß„Åô');
        }
        
        this.log.debug(`„É¢„Ç∏„É•„Éº„É´AjaxÂÆüË°å: ${moduleName}#${action}`);
        return await this.ajax.request(moduleName, action, data, options);
    }
    
    /**
     * „Éô„Éº„ÇπURLÂèñÂæó
     */
    getBaseUrl() {
        if (typeof window === 'undefined') return '/';
        
        const baseElement = document.querySelector('base[href]');
        if (baseElement) {
            return baseElement.href;
        }
        
        return window.location.origin + '/';
    }
}

// „Ç∞„É≠„Éº„Éê„É´ÁôªÈå≤
window.NAGANO3 = window.NAGANO3 || {};
window.NAGANO3.ModuleLoader = DynamicModuleLoader;
window.NAGANO3.AjaxManager = UnifiedAjaxManager;

// „Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàê
const moduleLoader = new DynamicModuleLoader();
window.NAGANO3.moduleLoader = moduleLoader;

// ‰ΩøÁî®ÊñπÊ≥ï„É≠„Ç∞Âá∫Âäõ
console.log(`
üì¶ Áµ±Âêà„É¢„Ç∏„É•„Éº„É´„É≠„Éº„ÉÄ„Éº + Ajax Manager
=======================================

‰ΩøÁî®ÊñπÊ≥ï:
1. NAGANO3.moduleLoader.executeModuleAjax('kicho', 'health_check')
2. NAGANO3.moduleLoader.ajax.request('kicho', 'get_stats', {limit: 10})

ÁâπÂæ¥:
‚úÖ Êó¢Â≠ò„Éè„É≥„Éâ„É©„ÉºËá™ÂãïÊ§úÂá∫
‚úÖ „Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÊúÄÈÅ©Âåñ
‚úÖ Ëá™Âãï„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
‚úÖ „É™„Éà„É©„Ç§Ê©üËÉΩ
‚úÖ Áµ±Âêà„É≠„Ç∞

Êó¢Â≠ò„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà:
- modules/kicho/kicho_ajax_handler.php
- modules/other/other_modules_ajax_handler.php  
- ajax_module_router.php (Áµ±Âêà)
`);

// =====================================
// „Ç∞„É≠„Éº„Éê„É´ÂÖ¨ÈñãÔºàES6ÊßãÊñáÂâäÈô§Ôºâ
// =====================================
window.DynamicModuleLoader = DynamicModuleLoader;
window.UnifiedAjaxManager = UnifiedAjaxManager;
window.AjaxEndpointManager = AjaxEndpointManager;

// NAGANO3„Ç∑„Çπ„ÉÜ„É†„Å∏„ÅÆÁµ±Âêà
if (window.NAGANO3) {
    window.NAGANO3.DynamicModuleLoader = DynamicModuleLoader;
    window.NAGANO3.UnifiedAjaxManager = UnifiedAjaxManager; 
    window.NAGANO3.AjaxEndpointManager = AjaxEndpointManager;
}

console.log('‚úÖ „É¢„Ç∏„É•„Éº„É´„É≠„Éº„ÉÄ„Éº„ÇØ„É©„Çπ„Çí„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶ÂÖ¨ÈñãÂÆå‰∫Ü');