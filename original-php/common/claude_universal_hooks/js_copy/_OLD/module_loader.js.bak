/**
 * ğŸ¢ ä¼æ¥­ãƒ¬ãƒ™ãƒ«å‹•çš„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ­ãƒ¼ãƒ€ãƒ¼ï¼ˆAjaxçµ±åˆç‰ˆï¼‰
 * ãƒ•ã‚¡ã‚¤ãƒ«: common/js/module_loader.js
 * 
 * âœ… Ajaxå°‚ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµ±åˆ
 * âœ… æ—¢å­˜ãƒãƒ³ãƒ‰ãƒ©ãƒ¼è‡ªå‹•æ¤œå‡º
 * âœ… ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
 * âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½
 */

"use strict";

// Ajax ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç®¡ç†ã‚¯ãƒ©ã‚¹
class AjaxEndpointManager {
    constructor() {
        this.endpoints = new Map();
        this.fallbackUrl = '/ajax_module_router.php';
        this.defaultTimeout = 15000;
        
        // æ—¢å­˜ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ç™»éŒ²
        this.registerKnownEndpoints();
    }
    
    /**
     * æ—¢å­˜ã®Ajax ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ç™»éŒ²
     */
    registerKnownEndpoints() {
        const knownEndpoints = [
            // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¥å°‚ç”¨ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
            { module: 'kicho', url: '/modules/kicho/kicho_ajax_handler.php', priority: 1 },
            { module: 'apikey', url: '/modules/apikey/apikey_ajax_handler.php', priority: 1 },
            { module: 'shohin', url: '/modules/shohin/shohin_ajax_handler.php', priority: 1 },
            { module: 'zaiko', url: '/modules/zaiko/zaiko_ajax_handler.php', priority: 1 },
            { module: 'juchu_kanri', url: '/modules/juchu_kanri/juchu_ajax_handler.php', priority: 1 },
            
            // æ±ç”¨ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
            { module: 'other', url: '/modules/other/other_modules_ajax_handler.php', priority: 2 },
            
            // çµ±åˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            { module: '*', url: '/ajax_module_router.php', priority: 3 },
            
            // æ—¢å­˜ã®ä¸€èˆ¬çš„ãƒ‘ã‚¿ãƒ¼ãƒ³
            { module: '*', url: '/?ajax=1', priority: 4 },
            { module: '*', url: '/ajax.php', priority: 5 }
        ];
        
        knownEndpoints.forEach(endpoint => {
            if (!this.endpoints.has(endpoint.module)) {
                this.endpoints.set(endpoint.module, []);
            }
            this.endpoints.get(endpoint.module).push(endpoint);
        });
        
        // å„ªå…ˆé †ä½ã§ã‚½ãƒ¼ãƒˆ
        this.endpoints.forEach(endpoints => {
            endpoints.sort((a, b) => a.priority - b.priority);
        });
        
        console.log('ğŸ“¡ Ajax ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç™»éŒ²å®Œäº†:', this.endpoints);
    }
    
    /**
     * ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç”¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå–å¾—
     */
    getEndpointForModule(module) {
        // å°‚ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå„ªå…ˆ
        const moduleEndpoints = this.endpoints.get(module);
        if (moduleEndpoints && moduleEndpoints.length > 0) {
            return moduleEndpoints[0].url;
        }
        
        // æ±ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        const genericEndpoints = this.endpoints.get('*');
        if (genericEndpoints && genericEndpoints.length > 0) {
            return genericEndpoints[0].url;
        }
        
        // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        return this.fallbackUrl;
    }
    
    /**
     * è‡ªå‹•ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ¤œå‡º
     */
    async detectBestEndpoint(module, action) {
        const candidates = [
            ...this.endpoints.get(module) || [],
            ...this.endpoints.get('*') || []
        ];
        
        console.log(`ğŸ” ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ¤œå‡ºé–‹å§‹: ${module}#${action}`);
        
        for (const candidate of candidates) {
            try {
                const result = await this.testEndpoint(candidate.url, action, { module });
                if (result.success) {
                    console.log(`âœ… æœ€é©ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç™ºè¦‹: ${candidate.url}`);
                    return candidate.url;
                }
            } catch (error) {
                console.log(`âŒ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆå¤±æ•—: ${candidate.url} - ${error.message}`);
            }
        }
        
        console.warn(`âš ï¸ æœ€é©ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæœªç™ºè¦‹ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½¿ç”¨: ${module}`);
        return this.fallbackUrl;
    }
    
    /**
     * ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
     */
    async testEndpoint(url, action = 'health_check', data = {}) {
        const formData = new FormData();
        formData.append('action', action);
        Object.keys(data).forEach(key => {
            formData.append(key, data[key]);
        });
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData,
            timeout: 5000
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const text = await response.text();
        
        // JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª
        try {
            const json = JSON.parse(text);
            return json;
        } catch (parseError) {
            // HTML ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
            if (text.includes('<!DOCTYPE') || text.includes('<html')) {
                throw new Error('HTML response received');
            }
            throw parseError;
        }
    }
}

// çµ±åˆAjaxé€šä¿¡ã‚¯ãƒ©ã‚¹
class UnifiedAjaxManager {
    constructor() {
        this.endpointManager = new AjaxEndpointManager();
        this.requestHistory = new Map();
        this.activeRequests = new Map();
        this.retryCount = 3;
        this.retryDelay = 1000;
    }
    
    /**
     * çµ±åˆAjax ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
     */
    async request(module, action, data = {}, options = {}) {
        const requestId = this.generateRequestId();
        const config = {
            timeout: options.timeout || 15000,
            retries: options.retries || this.retryCount,
            autoDetect: options.autoDetect !== false,
            endpoint: options.endpoint || null,
            ...options
        };
        
        console.log(`ğŸ“¤ çµ±åˆAjax [${requestId}]: ${module}#${action}`, data);
        
        try {
            // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ±ºå®š
            let endpoint;
            if (config.endpoint) {
                endpoint = config.endpoint;
            } else if (config.autoDetect) {
                endpoint = await this.endpointManager.detectBestEndpoint(module, action);
            } else {
                endpoint = this.endpointManager.getEndpointForModule(module);
            }
            
            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ
            const result = await this.executeRequest(endpoint, module, action, data, config);
            
            console.log(`âœ… çµ±åˆAjaxæˆåŠŸ [${requestId}]: ${module}#${action}`, result);
            return result;
            
        } catch (error) {
            console.error(`âŒ çµ±åˆAjaxå¤±æ•— [${requestId}]: ${module}#${action}`, error);
            throw error;
        }
    }
    
    /**
     * ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤å¯¾å¿œï¼‰
     */
    async executeRequest(endpoint, module, action, data, config) {
        let lastError;
        
        for (let attempt = 1; attempt <= config.retries; attempt++) {
            try {
                console.log(`ğŸ”„ è©¦è¡Œ ${attempt}/${config.retries}: ${endpoint}`);
                
                const formData = new FormData();
                formData.append('action', action);
                formData.append('module', module);
                
                // CSRF ãƒˆãƒ¼ã‚¯ãƒ³è¿½åŠ 
                const csrfToken = this.getCSRFToken();
                if (csrfToken) {
                    formData.append('csrf_token', csrfToken);
                }
                
                // ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
                Object.keys(data).forEach(key => {
                    if (data[key] !== null && data[key] !== undefined) {
                        formData.append(key, data[key]);
                    }
                });
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData,
                    timeout: config.timeout
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                
                // JSON è§£æ
                try {
                    const json = JSON.parse(text);
                    return json;
                } catch (parseError) {
                    // HTML ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰JSONéƒ¨åˆ†ã‚’æŠ½å‡ºè©¦è¡Œ
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        try {
                            return JSON.parse(jsonMatch[0]);
                        } catch (e) {
                            throw new Error('Invalid JSON in response');
                        }
                    }
                    throw new Error('No valid JSON found in response');
                }
                
            } catch (error) {
                lastError = error;
                console.warn(`âš ï¸ è©¦è¡Œ${attempt}å¤±æ•—: ${error.message}`);
                
                if (attempt < config.retries) {
                    await this.delay(this.retryDelay * attempt);
                }
            }
        }
        
        throw lastError;
    }
    
    /**
     * CSRF ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
     */
    getCSRFToken() {
        return window.NAGANO3_CSRF_TOKEN || 
               document.querySelector('meta[name="csrf-token"]')?.content ||
               '';
    }
    
    /**
     * ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDç”Ÿæˆ
     */
    generateRequestId() {
        return `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
    
    /**
     * é…å»¶é–¢æ•°
     */
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// DynamicModuleLoader ã«Ajaxæ©Ÿèƒ½ã‚’çµ±åˆ
class DynamicModuleLoader {
    constructor(options = {}) {
        this.config = {
            baseUrl: options.baseUrl || this.getBaseUrl(),
            timeout: options.timeout || 15000,
            enableAjax: options.enableAjax !== false,
            ...options
        };
        
        this.loadedModules = new Map();
        this.log = new UnifiedLogger('ModuleLoader');
        
        // Ajaxæ©Ÿèƒ½çµ±åˆ
        if (this.config.enableAjax) {
            this.ajax = new UnifiedAjaxManager();
            this.log.info('Ajaxæ©Ÿèƒ½çµ±åˆå®Œäº†');
        }
    }
    
    /**
     * ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç”¨Ajaxå®Ÿè¡Œ
     */
    async executeModuleAjax(moduleName, action, data = {}, options = {}) {
        if (!this.ajax) {
            throw new Error('Ajaxæ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™');
        }
        
        this.log.debug(`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«Ajaxå®Ÿè¡Œ: ${moduleName}#${action}`);
        return await this.ajax.request(moduleName, action, data, options);
    }
    
    /**
     * ãƒ™ãƒ¼ã‚¹URLå–å¾—
     */
    getBaseUrl() {
        if (typeof window === 'undefined') return '/';
        
        const baseElement = document.querySelector('base[href]');
        if (baseElement) {
            return baseElement.href;
        }
        
        return window.location.origin + '/';
    }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ç™»éŒ²
window.NAGANO3 = window.NAGANO3 || {};
window.NAGANO3.ModuleLoader = DynamicModuleLoader;
window.NAGANO3.AjaxManager = UnifiedAjaxManager;

// ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
const moduleLoader = new DynamicModuleLoader();
window.NAGANO3.moduleLoader = moduleLoader;

// ä½¿ç”¨æ–¹æ³•ãƒ­ã‚°å‡ºåŠ›
console.log(`
ğŸ“¦ çµ±åˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ­ãƒ¼ãƒ€ãƒ¼ + Ajax Manager
=======================================

ä½¿ç”¨æ–¹æ³•:
1. NAGANO3.moduleLoader.executeModuleAjax('kicho', 'health_check')
2. NAGANO3.moduleLoader.ajax.request('kicho', 'get_stats', {limit: 10})

ç‰¹å¾´:
âœ… æ—¢å­˜ãƒãƒ³ãƒ‰ãƒ©ãƒ¼è‡ªå‹•æ¤œå‡º
âœ… ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæœ€é©åŒ–
âœ… è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
âœ… ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
âœ… çµ±åˆãƒ­ã‚°

æ—¢å­˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:
- modules/kicho/kicho_ajax_handler.php
- modules/other/other_modules_ajax_handler.php  
- ajax_module_router.php (çµ±åˆ)
`);

// =====================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ï¼ˆES6æ§‹æ–‡å‰Šé™¤ï¼‰
// =====================================
window.DynamicModuleLoader = DynamicModuleLoader;
window.UnifiedAjaxManager = UnifiedAjaxManager;
window.AjaxEndpointManager = AjaxEndpointManager;

// NAGANO3ã‚·ã‚¹ãƒ†ãƒ ã¸ã®çµ±åˆ
if (window.NAGANO3) {
    window.NAGANO3.DynamicModuleLoader = DynamicModuleLoader;
    window.NAGANO3.UnifiedAjaxManager = UnifiedAjaxManager; 
    window.NAGANO3.AjaxEndpointManager = AjaxEndpointManager;
}

console.log('âœ… ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å…¬é–‹å®Œäº†');