
// CAIDS character_limit Hook
// CAIDS character_limit Hook - Âü∫Êú¨ÂÆüË£Ö
console.log('‚úÖ character_limit Hook loaded');

// CAIDS error_handling Hook

// CAIDS „Ç®„É©„ÉºÂá¶ÁêÜHook - ÂÆåÂÖ®ÂÆüË£Ö
window.CAIDS_ERROR_HANDLER = {
    isActive: true,
    errorCount: 0,
    errorHistory: [],
    
    initialize: function() {
        this.setupGlobalErrorHandler();
        this.setupUnhandledPromiseRejection();
        this.setupNetworkErrorHandler();
        console.log('‚ö†Ô∏è CAIDS „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†ÂÆåÂÖ®ÂàùÊúüÂåñ');
    },
    
    setupGlobalErrorHandler: function() {
        window.addEventListener('error', (event) => {
            this.handleError({
                type: 'JavaScript Error',
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack
            });
        });
    },
    
    setupUnhandledPromiseRejection: function() {
        window.addEventListener('unhandledrejection', (event) => {
            this.handleError({
                type: 'Unhandled Promise Rejection',
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack
            });
        });
    },
    
    setupNetworkErrorHandler: function() {
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                if (!response.ok) {
                    window.CAIDS_ERROR_HANDLER.handleError({
                        type: 'Network Error',
                        message: `HTTP ${response.status}: ${response.statusText}`,
                        url: args[0]
                    });
                }
                return response;
            } catch (error) {
                window.CAIDS_ERROR_HANDLER.handleError({
                    type: 'Network Fetch Error',
                    message: error.message,
                    url: args[0]
                });
                throw error;
            }
        };
    },
    
    handleError: function(errorInfo) {
        this.errorCount++;
        this.errorHistory.push({...errorInfo, timestamp: new Date().toISOString()});
        
        console.error('üö® CAIDS Error Handler:', errorInfo);
        this.showErrorNotification(errorInfo);
        this.reportError(errorInfo);
    },
    
    showErrorNotification: function(errorInfo) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 10px; right: 10px; z-index: 999999;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 350px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            border: 2px solid #ff6666; animation: caids-error-shake 0.5s ease-in-out;
        `;
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">üö®</span>
                <div>
                    <strong>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</strong><br>
                    <small style="opacity: 0.9;">${errorInfo.type}: ${errorInfo.message}</small>
                </div>
            </div>
        `;
        
        // CSS Animation
        if (!document.getElementById('caids-error-styles')) {
            const style = document.createElement('style');
            style.id = 'caids-error-styles';
            style.textContent = `
                @keyframes caids-error-shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 7000);
    },
    
    reportError: function(errorInfo) {
        // „Ç®„É©„Éº„É¨„Éù„Éº„ÉàÁîüÊàê„ÉªÈÄÅ‰ø°ÔºàÂ∞ÜÊù•„ÅÆÊã°ÂºµÁî®Ôºâ
        const report = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            errorCount: this.errorCount,
            sessionId: this.getSessionId(),
            ...errorInfo
        };
        
        console.log('üìã CAIDS Error Report:', report);
        localStorage.setItem('caids_last_error', JSON.stringify(report));
    },
    
    getSessionId: function() {
        let sessionId = sessionStorage.getItem('caids_session_id');
        if (!sessionId) {
            sessionId = 'caids_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('caids_session_id', sessionId);
        }
        return sessionId;
    },
    
    getErrorStats: function() {
        return {
            totalErrors: this.errorCount,
            recentErrors: this.errorHistory.slice(-10),
            sessionId: this.getSessionId()
        };
    }
};

window.CAIDS_ERROR_HANDLER.initialize();

/**
 * Ê±éÁî®„Éï„Ç©„Éº„É†Ê©üËÉΩÔºàBootstrap.jsÂØæÂøúÁâàÔºâ
 * „Éï„Ç°„Ç§„É´: common/js/components/forms.js
 * 
 * üéØ ÁõÆÁöÑ: ÂÖ®„É¢„Ç∏„É•„Éº„É´ÂÖ±ÈÄö„ÅÆ„Éï„Ç©„Éº„É†Ê©üËÉΩ
 * ‚úÖ „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºà„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÔºâ
 * ‚úÖ „Éï„Ç©„Éº„É†„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
 * ‚úÖ Ëá™Âãï‰øùÂ≠òÊ©üËÉΩ
 * ‚úÖ „Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫
 */

"use strict";

console.log("üìù Ê±éÁî®„Éï„Ç©„Éº„É†Ê©üËÉΩË™≠„ÅøËæº„ÅøÈñãÂßã");

// ===== NAGANO3.components.forms „Å®„Åó„Å¶ÁôªÈå≤ =====
window.NAGANO3 = window.NAGANO3 || {};
window.NAGANO3.components = window.NAGANO3.components || {};

window.NAGANO3.components.forms = {
    version: '1.0.0',
    initialized: false,
    
    // Ë®≠ÂÆö
    config: {
        maxFileSize: 10 * 1024 * 1024, // 10MB
        allowedTypes: {
            csv: ['.csv'],
            excel: ['.xlsx', '.xls'],
            text: ['.txt'],
            image: ['.jpg', '.jpeg', '.png', '.gif'],
            document: ['.pdf', '.doc', '.docx']
        },
        autoSaveInterval: 30000, // 30Áßí
        debug: window.location.hostname.includes('localhost')
    },
    
    // Áä∂ÊÖãÁÆ°ÁêÜ
    state: {
        activeUploads: new Map(),
        autoSaveTimers: new Map(),
        validationRules: new Map()
    },
    
    // ÂàùÊúüÂåñ
    init() {
        if (this.initialized) return;
        
        console.log('üîß „Éï„Ç©„Éº„É†Ê©üËÉΩÂàùÊúüÂåñÈñãÂßã');
        
        try {
            this.setupGlobalEventListeners();
            this.setupAutoDiscovery();
            this.initialized = true;
            
            console.log('‚úÖ „Éï„Ç©„Éº„É†Ê©üËÉΩÂàùÊúüÂåñÂÆå‰∫Ü');
            
        } catch (error) {
            console.error('‚ùå „Éï„Ç©„Éº„É†Ê©üËÉΩÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
        }
    },
    
    // „Ç∞„É≠„Éº„Éê„É´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
    setupGlobalEventListeners() {
        // „Éï„Ç°„Ç§„É´ÂÖ•Âäõ„ÅÆËá™ÂãïË®≠ÂÆö
        document.addEventListener('change', (e) => {
            if (e.target.type === 'file' && e.target.hasAttribute('data-auto-upload')) {
                this.handleFileChange(e.target);
            }
        });
        
        // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°„ÅÆËá™ÂãïÂá¶ÁêÜ
        document.addEventListener('submit', (e) => {
            if (e.target.hasAttribute('data-auto-validate')) {
                if (!this.validateForm(e.target)) {
                    e.preventDefault();
                }
            }
        });
    },
    
    // Ëá™ÂãïÁô∫Ë¶ãÊ©üËÉΩ
    setupAutoDiscovery() {
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Ç®„É™„Ç¢„ÅÆËá™ÂãïË®≠ÂÆö
        document.querySelectorAll('[data-file-drop]').forEach(element => {
            this.setupFileUpload(element.id || element);
        });
        
        // Ëá™Âãï‰øùÂ≠ò„Éï„Ç©„Éº„É†„ÅÆË®≠ÂÆö
        document.querySelectorAll('[data-auto-save]').forEach(form => {
            this.setupAutoSave(form.id || form);
        });
    },
    
    // ===== „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ©üËÉΩ =====
    
    /**
     * „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâË®≠ÂÆö
     * @param {string|Element} target - ÂØæË±°Ë¶ÅÁ¥†„Åæ„Åü„ÅØID
     * @param {Object} options - „Ç™„Éó„Ç∑„Éß„É≥Ë®≠ÂÆö
     */
    setupFileUpload(target, options = {}) {
        const element = typeof target === 'string' ? document.getElementById(target) : target;
        if (!element) {
            console.warn('„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂØæË±°„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', target);
            return;
        }
        
        const config = { ...this.config, ...options };
        
        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„Ç§„Éô„É≥„ÉàË®≠ÂÆö
        element.addEventListener('dragover', (e) => {
            e.preventDefault();
            element.classList.add('drag-over');
            
            if (config.debug) {
                console.log('üìÅ „Éï„Ç°„Ç§„É´„Éâ„É©„ÉÉ„Ç∞„Ç™„Éº„Éê„Éº');
            }
        });
        
        element.addEventListener('dragleave', (e) => {
            e.preventDefault();
            element.classList.remove('drag-over');
        });
        
        element.addEventListener('drop', (e) => {
            e.preventDefault();
            element.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            this.handleFiles(files, element, config);
        });
        
        // „ÇØ„É™„ÉÉ„ÇØ„Åß„Éï„Ç°„Ç§„É´ÈÅ∏Êäû
        element.addEventListener('click', () => {
            const fileInput = this.createFileInput(config);
            fileInput.click();
            
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                this.handleFiles(files, element, config);
            });
        });
        
        console.log('üìÅ „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâË®≠ÂÆöÂÆå‰∫Ü:', element.id || 'unnamed');
    },
    
    /**
     * „Éï„Ç°„Ç§„É´Âá¶ÁêÜ
     * @param {File[]} files - „Éï„Ç°„Ç§„É´ÈÖçÂàó
     * @param {Element} target - ÂØæË±°Ë¶ÅÁ¥†
     * @param {Object} config - Ë®≠ÂÆö
     */
    handleFiles(files, target, config) {
        files.forEach(file => {
            // „Éï„Ç°„Ç§„É´Ê§úË®º
            const validation = this.validateFile(file, config);
            if (!validation.valid) {
                this.showFileError(validation.message, target);
                return;
            }
            
            // „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
            this.uploadFile(file, target, config);
        });
    },
    
    /**
     * „Éï„Ç°„Ç§„É´Ê§úË®º
     * @param {File} file - „Éï„Ç°„Ç§„É´
     * @param {Object} config - Ë®≠ÂÆö
     * @returns {Object} Ê§úË®ºÁµêÊûú
     */
    validateFile(file, config) {
        // „Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ
        if (file.size > config.maxFileSize) {
            return {
                valid: false,
                message: `„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„Åå‰∏äÈôêÔºà${this.formatFileSize(config.maxFileSize)}Ôºâ„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô`
            };
        }
        
        // Êã°ÂºµÂ≠ê„ÉÅ„Çß„ÉÉ„ÇØ
        const extension = '.' + file.name.split('.').pop().toLowerCase();
        const allowedExtensions = Object.values(config.allowedTypes).flat();
        
        if (allowedExtensions.length > 0 && !allowedExtensions.includes(extension)) {
            return {
                valid: false,
                message: `Ë®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„ÅôÔºà${allowedExtensions.join(', ')}Ôºâ`
            };
        }
        
        return { valid: true };
    },
    
    /**
     * „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆüË°å
     * @param {File} file - „Éï„Ç°„Ç§„É´
     * @param {Element} target - ÂØæË±°Ë¶ÅÁ¥†
     * @param {Object} config - Ë®≠ÂÆö
     */
    async uploadFile(file, target, config) {
        const uploadId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        try {
            // „Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫ÈñãÂßã
            this.showUploadProgress(uploadId, file.name, target);
            
            // FormData‰ΩúÊàê
            const formData = new FormData();
            formData.append('file', file);
            formData.append('action', config.action || 'file_upload');
            formData.append('upload_id', uploadId);
            
            // ËøΩÂä†„Éá„Éº„Çø
            if (config.data) {
                Object.entries(config.data).forEach(([key, value]) => {
                    formData.append(key, value);
                });
            }
            
            // „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆüË°å
            const response = await fetch(config.uploadUrl || window.location.href, {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                this.showUploadSuccess(uploadId, result.message || '„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂÆå‰∫Ü', target);
                
                // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å
                if (config.onSuccess) {
                    config.onSuccess(result, file);
                }
                
            } else {
                throw new Error(result.message || '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº');
            }
            
        } catch (error) {
            console.error('„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
            this.showUploadError(uploadId, error.message, target);
            
            if (config.onError) {
                config.onError(error, file);
            }
        }
    },
    
    // ===== „Éï„Ç©„Éº„É†„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Ê©üËÉΩ =====
    
    /**
     * „Éï„Ç©„Éº„É†„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
     * @param {string|Element} target - ÂØæË±°„Éï„Ç©„Éº„É†
     * @param {Object} rules - „Éê„É™„Éá„Éº„Ç∑„Éß„É≥„É´„Éº„É´
     */
    setupValidation(target, rules = {}) {
        const form = typeof target === 'string' ? document.getElementById(target) : target;
        if (!form) return;
        
        this.state.validationRules.set(form, rules);
        
        // „É™„Ç¢„É´„Çø„Ç§„É†„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
        form.addEventListener('input', (e) => {
            if (e.target.name && rules[e.target.name]) {
                this.validateField(e.target, rules[e.target.name]);
            }
        });
        
        console.log('‚úÖ „Éï„Ç©„Éº„É†„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Ë®≠ÂÆöÂÆå‰∫Ü:', form.id || 'unnamed');
    },
    
    /**
     * „Éï„Ç©„Éº„É†ÂÖ®‰Ωì„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
     * @param {Element} form - „Éï„Ç©„Éº„É†Ë¶ÅÁ¥†
     * @returns {boolean} „Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÁµêÊûú
     */
    validateForm(form) {
        const rules = this.state.validationRules.get(form);
        if (!rules) return true;
        
        let isValid = true;
        
        Object.entries(rules).forEach(([fieldName, fieldRules]) => {
            const field = form.querySelector(`[name="${fieldName}"]`);
            if (field && !this.validateField(field, fieldRules)) {
                isValid = false;
            }
        });
        
        return isValid;
    },
    
    /**
     * „Éï„Ç£„Éº„É´„Éâ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
     * @param {Element} field - „Éï„Ç£„Éº„É´„ÉâË¶ÅÁ¥†
     * @param {Object} rules - „É´„Éº„É´
     * @returns {boolean} „Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÁµêÊûú
     */
    validateField(field, rules) {
        const value = field.value.trim();
        let isValid = true;
        let errorMessage = '';
        
        // ÂøÖÈ†à„ÉÅ„Çß„ÉÉ„ÇØ
        if (rules.required && !value) {
            isValid = false;
            errorMessage = rules.messages?.required || '„Åì„ÅÆÈ†ÖÁõÆ„ÅØÂøÖÈ†à„Åß„Åô';
        }
        
        // ÊúÄÂ∞èÈï∑„ÉÅ„Çß„ÉÉ„ÇØ
        if (isValid && rules.minLength && value.length < rules.minLength) {
            isValid = false;
            errorMessage = rules.messages?.minLength || `${rules.minLength}ÊñáÂ≠ó‰ª•‰∏äÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`;
        }
        
        // ÊúÄÂ§ßÈï∑„ÉÅ„Çß„ÉÉ„ÇØ
        if (isValid && rules.maxLength && value.length > rules.maxLength) {
            isValid = false;
            errorMessage = rules.messages?.maxLength || `${rules.maxLength}ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`;
        }
        
        // „Éë„Çø„Éº„É≥„ÉÅ„Çß„ÉÉ„ÇØ
        if (isValid && rules.pattern && !rules.pattern.test(value)) {
            isValid = false;
            errorMessage = rules.messages?.pattern || 'ÂÖ•ÂäõÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì';
        }
        
        // „Ç´„Çπ„Çø„É†„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
        if (isValid && rules.custom) {
            const customResult = rules.custom(value, field);
            if (!customResult.valid) {
                isValid = false;
                errorMessage = customResult.message;
            }
        }
        
        this.showFieldValidation(field, isValid, errorMessage);
        return isValid;
    },
    
    // ===== Ëá™Âãï‰øùÂ≠òÊ©üËÉΩ =====
    
    /**
     * Ëá™Âãï‰øùÂ≠òË®≠ÂÆö
     * @param {string|Element} target - ÂØæË±°„Éï„Ç©„Éº„É†
     * @param {Object} options - „Ç™„Éó„Ç∑„Éß„É≥
     */
    setupAutoSave(target, options = {}) {
        const form = typeof target === 'string' ? document.getElementById(target) : target;
        if (!form) return;
        
        const config = {
            interval: options.interval || this.config.autoSaveInterval,
            action: options.action || 'auto_save',
            showNotification: options.showNotification !== false,
            ...options
        };
        
        // Â§âÊõ¥Áõ£Ë¶ñ
        let hasChanges = false;
        form.addEventListener('input', () => {
            hasChanges = true;
        });
        
        // ÂÆöÊúü‰øùÂ≠ò
        const timer = setInterval(() => {
            if (hasChanges) {
                this.performAutoSave(form, config);
                hasChanges = false;
            }
        }, config.interval);
        
        this.state.autoSaveTimers.set(form, timer);
        
        console.log('üíæ Ëá™Âãï‰øùÂ≠òË®≠ÂÆöÂÆå‰∫Ü:', form.id || 'unnamed');
    },
    
    /**
     * Ëá™Âãï‰øùÂ≠òÂÆüË°å
     * @param {Element} form - „Éï„Ç©„Éº„É†
     * @param {Object} config - Ë®≠ÂÆö
     */
    async performAutoSave(form, config) {
        try {
            const formData = new FormData(form);
            formData.append('action', config.action);
            formData.append('auto_save', '1');
            
            const response = await fetch(config.saveUrl || window.location.href, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                
                if (result.success && config.showNotification) {
                    this.showAutoSaveNotification('Ëá™Âãï‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                }
            }
            
        } catch (error) {
            console.warn('Ëá™Âãï‰øùÂ≠ò„Ç®„É©„Éº:', error);
        }
    },
    
    // ===== UIÊ©üËÉΩ =====
    
    /**
     * „Éï„Ç°„Ç§„É´ÂÖ•Âäõ‰ΩúÊàê
     * @param {Object} config - Ë®≠ÂÆö
     * @returns {Element} „Éï„Ç°„Ç§„É´ÂÖ•ÂäõË¶ÅÁ¥†
     */
    createFileInput(config) {
        const input = document.createElement('input');
        input.type = 'file';
        input.style.display = 'none';
        
        if (config.multiple) {
            input.multiple = true;
        }
        
        if (config.accept) {
            input.accept = config.accept;
        }
        
        return input;
    },
    
    /**
     * „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫
     * @param {string} uploadId - „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâID
     * @param {string} fileName - „Éï„Ç°„Ç§„É´Âêç
     * @param {Element} target - ÂØæË±°Ë¶ÅÁ¥†
     */
    showUploadProgress(uploadId, fileName, target) {
        const progress = document.createElement('div');
        progress.id = `upload-progress-${uploadId}`;
        progress.className = 'upload-progress';
        progress.innerHTML = `
            <div class="upload-progress__info">
                <span class="upload-progress__name">${this.escapeHtml(fileName)}</span>
                <span class="upload-progress__status">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...</span>
            </div>
            <div class="upload-progress__bar">
                <div class="upload-progress__fill"></div>
            </div>
        `;
        
        target.appendChild(progress);
    },
    
    /**
     * „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊàêÂäüË°®Á§∫
     * @param {string} uploadId - „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâID
     * @param {string} message - „É°„ÉÉ„Çª„Éº„Ç∏
     * @param {Element} target - ÂØæË±°Ë¶ÅÁ¥†
     */
    showUploadSuccess(uploadId, message, target) {
        const progress = document.getElementById(`upload-progress-${uploadId}`);
        if (progress) {
            progress.innerHTML = `
                <div class="upload-success">
                    <i class="fas fa-check-circle"></i>
                    ${this.escapeHtml(message)}
                </div>
            `;
            
            setTimeout(() => {
                progress.remove();
            }, 3000);
        }
    },
    
    /**
     * „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„ÉºË°®Á§∫
     * @param {string} uploadId - „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâID
     * @param {string} message - „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
     * @param {Element} target - ÂØæË±°Ë¶ÅÁ¥†
     */
    showUploadError(uploadId, message, target) {
        const progress = document.getElementById(`upload-progress-${uploadId}`);
        if (progress) {
            progress.innerHTML = `
                <div class="upload-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    ${this.escapeHtml(message)}
                </div>
            `;
            
            setTimeout(() => {
                progress.remove();
            }, 5000);
        }
    },
    
    /**
     * „Éï„Ç°„Ç§„É´„Ç®„É©„ÉºË°®Á§∫
     * @param {string} message - „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
     * @param {Element} target - ÂØæË±°Ë¶ÅÁ¥†
     */
    showFileError(message, target) {
        if (window.NAGANO3?.components?.notifications?.show) {
            window.NAGANO3.components.notifications.show(message, 'error');
        } else {
            alert(`„Éï„Ç°„Ç§„É´„Ç®„É©„Éº: ${message}`);
        }
    },
    
    /**
     * „Éï„Ç£„Éº„É´„Éâ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Ë°®Á§∫
     * @param {Element} field - „Éï„Ç£„Éº„É´„ÉâË¶ÅÁ¥†
     * @param {boolean} isValid - „Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÁµêÊûú
     * @param {string} errorMessage - „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏
     */
    showFieldValidation(field, isValid, errorMessage) {
        // Êó¢Â≠ò„ÅÆ„Ç®„É©„ÉºË°®Á§∫ÂâäÈô§
        const existingError = field.parentNode.querySelector('.field-error');
        if (existingError) {
            existingError.remove();
        }
        
        // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥Áä∂ÊÖã„ÅÆ„ÇØ„É©„ÇπË®≠ÂÆö
        field.classList.toggle('field-valid', isValid);
        field.classList.toggle('field-invalid', !isValid);
        
        // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        if (!isValid && errorMessage) {
            const error = document.createElement('div');
            error.className = 'field-error';
            error.textContent = errorMessage;
            field.parentNode.appendChild(error);
        }
    },
    
    /**
     * Ëá™Âãï‰øùÂ≠òÈÄöÁü•Ë°®Á§∫
     * @param {string} message - „É°„ÉÉ„Çª„Éº„Ç∏
     */
    showAutoSaveNotification(message) {
        // ËªΩÈáèÈÄöÁü•ÔºàÂè≥‰∏ã„Å´Â∞è„Åï„ÅèË°®Á§∫Ôºâ
        const notification = document.createElement('div');
        notification.className = 'auto-save-notification';
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s;
        `;
        
        document.body.appendChild(notification);
        
        // „Éï„Çß„Éº„Éâ„Ç§„É≥„Éª„Ç¢„Ç¶„Éà
        setTimeout(() => notification.style.opacity = '1', 10);
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    },
    
    // ===== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ =====
    
    /**
     * „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„Éï„Ç©„Éº„Éû„ÉÉ„Éà
     * @param {number} bytes - „Éê„Ç§„ÉàÊï∞
     * @returns {string} „Éï„Ç©„Éº„Éû„ÉÉ„ÉàÊ∏à„Åø„Çµ„Ç§„Ç∫
     */
    formatFileSize(bytes) {
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;
        
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }
        
        return `${Math.round(size * 100) / 100}${units[unitIndex]}`;
    },
    
    /**
     * HTML„Ç®„Çπ„Ç±„Éº„Éó
     * @param {string} text - „ÉÜ„Ç≠„Çπ„Éà
     * @returns {string} „Ç®„Çπ„Ç±„Éº„ÉóÊ∏à„Åø„ÉÜ„Ç≠„Çπ„Éà
     */
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },
    
    /**
     * „Éï„Ç©„Éº„É†Ê©üËÉΩÂÅúÊ≠¢
     * @param {string|Element} target - ÂØæË±°Ë¶ÅÁ¥†
     */
    destroy(target) {
        const element = typeof target === 'string' ? document.getElementById(target) : target;
        if (!element) return;
        
        // „Çø„Ç§„Éû„ÉºÂÅúÊ≠¢
        if (this.state.autoSaveTimers.has(element)) {
            clearInterval(this.state.autoSaveTimers.get(element));
            this.state.autoSaveTimers.delete(element);
        }
        
        // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥„É´„Éº„É´ÂâäÈô§
        this.state.validationRules.delete(element);
        
        console.log('üóëÔ∏è „Éï„Ç©„Éº„É†Ê©üËÉΩÂÅúÊ≠¢:', element.id || 'unnamed');
    }
};

// ===== „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞ÁôªÈå≤ÔºàHTMLÂà©Áî®Áî®Ôºâ =====
window.setupFileUpload = function(target, options) {
    return window.NAGANO3.components.forms.setupFileUpload(target, options);
};

window.setupValidation = function(target, rules) {
    return window.NAGANO3.components.forms.setupValidation(target, rules);
};

window.setupAutoSave = function(target, options) {
    return window.NAGANO3.components.forms.setupAutoSave(target, options);
};

// ===== Ëá™ÂãïÂàùÊúüÂåñÔºàNAGANO3 readyÂæåÔºâ =====
document.addEventListener('nagano3:ready', function() {
    console.log('üöÄ „Éï„Ç©„Éº„É†Ê©üËÉΩËá™ÂãïÂàùÊúüÂåñÈñãÂßã');
    window.NAGANO3.components.forms.init();
});

// „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂàùÊúüÂåñÔºàBootstrap.jsÊú™‰ΩøÁî®Áí∞Â¢ÉÁî®Ôºâ
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            if (!window.NAGANO3.components.forms.initialized) {
                window.NAGANO3.components.forms.init();
            }
        }, 100);
    });
} else {
    setTimeout(() => {
        if (!window.NAGANO3.components.forms.initialized) {
            window.NAGANO3.components.forms.init();
        }
    }, 100);
}

console.log("‚úÖ Ê±éÁî®„Éï„Ç©„Éº„É†Ê©üËÉΩË™≠„ÅøËæº„ÅøÂÆå‰∫Ü");