/**
 * æ£šå¸ã—ã‚·ã‚¹ãƒ†ãƒ  ç´”ç²‹Webãƒ„ãƒ¼ãƒ«ç‰ˆ JavaScript
 * ãƒ•ã‚¡ã‚¤ãƒ«: tanaoroshi_inventory.js
 * æ–¹é‡: hookså®Œå…¨æ’é™¤ãƒ»æ¨™æº–JavaScriptãƒ»ç›´æ¥APIå‘¼ã³å‡ºã—
 * å‚ç…§: inventory_system_fixed.html ã®å‹•ä½œã‚’å®Œå…¨å†ç¾
 */

(function() {
    'use strict';
    
    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç®¡ç†ï¼‰
    // ========================================
    window.TanaoroshiInventory = {
        selectedProducts: [],
        allProducts: [],
        filteredProducts: [],
        exchangeRate: 150.25,
        currentView: 'grid', // 'grid' | 'list'
        isLoading: false,
        apiEndpoint: 'modules/tanaoroshi_inline_complete/tanaoroshi_ajax_handler.php'
    };
    
    // çŸ­ç¸®ã‚¢ã‚¯ã‚»ã‚¹
    const State = window.TanaoroshiInventory;
    
    // ========================================
    // DOMåˆæœŸåŒ–ï¼ˆDOMContentLoadedï¼‰
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ æ£šå¸ã—ã‚·ã‚¹ãƒ†ãƒ ï¼ˆç´”ç²‹Webãƒ„ãƒ¼ãƒ«ç‰ˆï¼‰åˆæœŸåŒ–é–‹å§‹');
        
        try {
            initializeInventorySystem();
        } catch (error) {
            console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            showErrorMessage('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
    });
    
    // ========================================
    // ãƒ¡ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
    // ========================================
    function initializeInventorySystem() {
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        setupEventListeners();
        
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹
        loadInventoryData();
        
        // ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆæ›´æ–°
        updateExchangeRateDisplay();
        
        console.log('âœ… æ£šå¸ã—ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
    }
    
    // ========================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    // ========================================
    function setupEventListeners() {
        // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³
        const cardViewBtn = document.getElementById('card-view-btn');
        const listViewBtn = document.getElementById('list-view-btn');
        
        if (cardViewBtn) {
            cardViewBtn.addEventListener('click', () => switchView('grid'));
        }
        if (listViewBtn) {
            listViewBtn.addEventListener('click', () => switchView('list'));
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–¢é€£
        const filterSelects = document.querySelectorAll('.inventory__filter-select');
        filterSelects.forEach(select => {
            select.addEventListener('change', applyFilters);
        });
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
        const applyBtn = document.querySelector('.btn[onclick="applyFilters()"]');
        const resetBtn = document.querySelector('.btn[onclick="resetFilters()"]');
        
        if (applyBtn) {
            applyBtn.removeAttribute('onclick');
            applyBtn.addEventListener('click', applyFilters);
        }
        if (resetBtn) {
            resetBtn.removeAttribute('onclick');
            resetBtn.addEventListener('click', resetFilters);
        }
        
        // æ¤œç´¢æ©Ÿèƒ½
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', debounce(handleSearch, 300));
        }
        
        // ã‚»ãƒƒãƒˆå“ä½œæˆãƒœã‚¿ãƒ³
        const createSetBtn = document.getElementById('create-set-btn');
        if (createSetBtn) {
            createSetBtn.addEventListener('click', handleCreateSet);
        }
        
        // æ–°è¦å•†å“ç™»éŒ²ãƒœã‚¿ãƒ³
        const addProductBtn = document.getElementById('add-product-btn');
        if (addProductBtn) {
            addProductBtn.addEventListener('click', handleAddProduct);
        }
        
        console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
    }
    
    // ========================================
    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆfetch APIä½¿ç”¨ï¼‰
    // ========================================
    async function loadInventoryData() {
        if (State.isLoading) {
            console.log('â³ æ—¢ã«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­ã§ã™');
            return;
        }
        
        State.isLoading = true;
        showLoadingIndicator(true);
        
        try {
            console.log('ğŸ“¡ PostgreSQLãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹:', State.apiEndpoint);
            
            const response = await fetch(State.apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({
                    action: 'get_inventory',
                    limit: '50',
                    dev_mode: '1'
                }),
                cache: 'no-cache'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            State.allProducts = data.data || [];
            State.filteredProducts = [...State.allProducts];
            
            console.log(`âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ: ${State.allProducts.length}ä»¶`);
            
            // UIæ›´æ–°
            updateProductDisplay();
            updateStatisticsDisplay(data.statistics);
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            showSuccessMessage(`${State.allProducts.length}ä»¶ã®å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            
        } catch (error) {
            console.error('âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
            console.log('ğŸ”„ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
            loadSampleData();
            
            showErrorMessage(`ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            
        } finally {
            State.isLoading = false;
            showLoadingIndicator(false);
        }
    }
    
    // ========================================
    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
    // ========================================
    function loadSampleData() {
        const sampleData = [
            {
                id: 1,
                name: 'Vintage Japanese Kimono Traditional Silk',
                sku: 'EB-KIMONO01',
                type: 'stock',
                condition: 'used',
                priceUSD: 89.99,
                costUSD: 58.49,
                profitUSD: 31.50,
                stock: 1,
                category: 'Clothing',
                channels: ['ebay'],
                image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=300&h=200&fit=crop',
                listing_status: 'active',
                watchers_count: 24,
                views_count: 342
            },
            {
                id: 2,
                name: 'Nintendo Game Boy Color Pokemon Edition',
                sku: 'EB-GBCPOKE',
                type: 'stock',
                condition: 'used',
                priceUSD: 156.78,
                costUSD: 101.91,
                profitUSD: 54.87,
                stock: 1,
                category: 'Electronics',
                channels: ['ebay'],
                image: 'https://images.unsplash.com/photo-1606144042614-b2417e99c4e3?w=300&h=200&fit=crop',
                listing_status: 'active',
                watchers_count: 67,
                views_count: 1234
            },
            {
                id: 3,
                name: 'Sony Walkman Vintage Cassette Player',
                sku: 'EB-WALKMAN',
                type: 'dropship',
                condition: 'used',
                priceUSD: 234.56,
                costUSD: 152.46,
                profitUSD: 82.10,
                stock: 0,
                category: 'Electronics',
                channels: ['ebay'],
                image: 'https://images.unsplash.com/photo-1493020258366-be3ead61c4bb?w=300&h=200&fit=crop',
                listing_status: 'active',
                watchers_count: 43,
                views_count: 876
            }
        ];
        
        State.allProducts = sampleData;
        State.filteredProducts = [...sampleData];
        
        updateProductDisplay();
        updateStatisticsDisplay({
            total: 3,
            stock: 2,
            dropship: 1,
            hybrid: 0,
            set: 0,
            total_value_usd: 481.33
        });
        
        console.log('ğŸ“‹ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºå®Œäº†: 3ä»¶');
    }
    
    // ========================================
    // å•†å“è¡¨ç¤ºæ›´æ–°
    // ========================================
    function updateProductDisplay() {
        if (State.currentView === 'grid') {
            updateCardView();
        } else {
            updateListView();
        }
    }
    
    // ========================================
    // ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    // ========================================
    function updateCardView() {
        const container = document.getElementById('card-view');
        if (!container) {
            console.error('âŒ card-view container not found');
            return;
        }
        
        if (State.filteredProducts.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <p>è¡¨ç¤ºã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            `;
            return;
        }
        
        const cardsHTML = State.filteredProducts.map(product => createProductCard(product)).join('');
        container.innerHTML = cardsHTML;
        
        // ã‚«ãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        setupCardEventListeners();
        
        console.log(`ğŸ¨ ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼æ›´æ–°å®Œäº†: ${State.filteredProducts.length}ä»¶`);
    }
    
    // ========================================
    // å•†å“ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
    // ========================================
    function createProductCard(product) {
        const badgeClass = `inventory__badge--${product.type}`;
        const badgeText = {
            'stock': 'æœ‰åœ¨åº«',
            'dropship': 'ç„¡åœ¨åº«',
            'set': 'ã‚»ãƒƒãƒˆå“',
            'hybrid': 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰'
        }[product.type] || 'ä¸æ˜';
        
        const priceJPY = Math.round(product.priceUSD * State.exchangeRate);
        
        const imageHTML = product.image ? 
            `<img src="${product.image}" alt="${product.name}" class="inventory__card-img">` :
            `<div class="inventory__card-placeholder">
                <i class="fas fa-image"></i>
                <span>ç”»åƒãªã—</span>
            </div>`;
        
        const stockInfo = (product.type === 'stock' || product.type === 'hybrid') ?
            `<span style="color: var(--color-success); font-size: 0.7rem; font-weight: 600;">åœ¨åº«:${product.stock}</span>` :
            `<span style="color: var(--color-info); font-size: 0.7rem;">${product.listing_status}</span>`;
        
        return `
            <div class="inventory__card" data-id="${product.id}" data-type="${product.type}">
                <div class="inventory__card-image">
                    ${imageHTML}
                    <div class="inventory__card-badges">
                        <span class="inventory__badge ${badgeClass}">${badgeText}</span>
                        <div class="inventory__channel-badges">
                            <span class="inventory__channel-badge inventory__channel-badge--ebay">E</span>
                        </div>
                    </div>
                </div>
                <div class="inventory__card-info">
                    <h3 class="inventory__card-title" title="${product.name}">${product.name}</h3>
                    <div class="inventory__card-price">
                        <div class="inventory__card-price-main">$${product.priceUSD.toFixed(2)}</div>
                        <div class="inventory__card-price-sub">Â¥${priceJPY.toLocaleString()}</div>
                    </div>
                    <div class="inventory__card-meta">
                        <div class="inventory__meta-item">
                            <span>ä»•å…¥ä¾¡æ ¼:</span>
                            <span class="inventory__meta-value">$${product.costUSD.toFixed(2)}</span>
                        </div>
                        <div class="inventory__meta-item">
                            <span>åˆ©ç›Š:</span>
                            <span class="inventory__meta-value">$${product.profitUSD.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="inventory__card-footer">
                        <span class="inventory__card-sku" title="${product.sku}">${product.sku}</span>
                        ${stockInfo}
                    </div>
                </div>
            </div>
        `;
    }
    
    // ========================================
    // ã‚«ãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    // ========================================
    function setupCardEventListeners() {
        const cards = document.querySelectorAll('.inventory__card');
        
        cards.forEach(card => {
            // ã‚¯ãƒªãƒƒã‚¯é™¤å¤–è¦ç´ ãƒã‚§ãƒƒã‚¯
            card.addEventListener('click', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                
                selectCard(this);
            });
        });
    }
    
    // ========================================
    // ã‚«ãƒ¼ãƒ‰é¸æŠå‡¦ç†
    // ========================================
    function selectCard(cardElement) {
        const productId = parseInt(cardElement.dataset.id);
        
        if (isNaN(productId)) {
            console.error('âŒ ç„¡åŠ¹ãªå•†å“ID:', cardElement.dataset.id);
            return;
        }
        
        // é¸æŠçŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆ
        cardElement.classList.toggle('inventory__card--selected');
        
        if (cardElement.classList.contains('inventory__card--selected')) {
            // é¸æŠè¿½åŠ 
            if (!State.selectedProducts.includes(productId)) {
                State.selectedProducts.push(productId);
            }
        } else {
            // é¸æŠè§£é™¤
            State.selectedProducts = State.selectedProducts.filter(id => id !== productId);
        }
        
        updateSelectionUI();
        console.log('ğŸ“‹ é¸æŠå•†å“:', State.selectedProducts);
    }
    
    // ========================================
    // é¸æŠUIæ›´æ–°
    // ========================================
    function updateSelectionUI() {
        const createSetBtn = document.getElementById('create-set-btn');
        const setBtnText = document.getElementById('set-btn-text');
        
        if (createSetBtn && setBtnText) {
            const selectedCount = State.selectedProducts.length;
            
            if (selectedCount >= 2) {
                createSetBtn.disabled = false;
                createSetBtn.className = 'btn btn--warning';
                setBtnText.textContent = `é¸æŠå•†å“ã§ã‚»ãƒƒãƒˆå“ä½œæˆ (${selectedCount}ç‚¹)`;
            } else {
                createSetBtn.disabled = false;
                createSetBtn.className = 'btn btn--warning';
                setBtnText.textContent = 'æ–°è¦ã‚»ãƒƒãƒˆå“ä½œæˆ';
            }
        }
    }
    
    // ========================================
    // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
    // ========================================
    function switchView(view) {
        const cardView = document.getElementById('card-view');
        const excelView = document.getElementById('excel-view');
        const cardViewBtn = document.getElementById('card-view-btn');
        const listViewBtn = document.getElementById('list-view-btn');
        
        console.log('ğŸ”„ ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆé–‹å§‹:', view);
        console.log('è¦ç´ ç¢ºèª - cardView:', !!cardView, 'excelView:', !!excelView);
        
        if (!cardView || !excelView || !cardViewBtn || !listViewBtn) {
            console.error('âŒ ãƒ“ãƒ¥ãƒ¼è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            console.error('è¦ç´ çŠ¶æ…‹:', { cardView: !!cardView, excelView: !!excelView, cardViewBtn: !!cardViewBtn, listViewBtn: !!listViewBtn });
            return;
        }
        
        // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
        cardViewBtn.classList.remove('inventory__view-btn--active');
        listViewBtn.classList.remove('inventory__view-btn--active');
        
        if (view === 'grid') {
            // ğŸ”§ ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            cardView.classList.remove('inventory__view--hidden');
            cardView.classList.add('inventory__view--visible');
            excelView.classList.remove('inventory__view--visible');
            excelView.classList.add('inventory__view--hidden');
            cardViewBtn.classList.add('inventory__view-btn--active');
            listViewBtn.classList.remove('inventory__view-btn--active');
            State.currentView = 'grid';
            console.log('âœ… ã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ');
        } else {
            // ğŸ”§ Excelãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            cardView.classList.remove('inventory__view--visible');
            cardView.classList.add('inventory__view--hidden');
            excelView.classList.remove('inventory__view--hidden');
            excelView.classList.add('inventory__view--visible');
            listViewBtn.classList.add('inventory__view-btn--active');
            cardViewBtn.classList.remove('inventory__view-btn--active');
            State.currentView = 'list';
            updateListView();
            console.log('âœ… Excelãƒ“ãƒ¥ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ');
        }
    }
    
    // ========================================
    // ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼æ›´æ–°
    // ========================================
    function updateListView() {
        const tableBody = document.getElementById('excel-table-body');
        if (!tableBody) {
            console.error('âŒ excel-table-body not found');
            return;
        }
        
        if (State.filteredProducts.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="13" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        è¡¨ç¤ºã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“
                    </td>
                </tr>
            `;
            return;
        }
        
        const rowsHTML = State.filteredProducts.map(product => createTableRow(product)).join('');
        tableBody.innerHTML = rowsHTML;
        
        console.log(`ğŸ“Š ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼æ›´æ–°å®Œäº†: ${State.filteredProducts.length}ä»¶`);
    }
    
    // ========================================
    // ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œç”Ÿæˆ
    // ========================================
    function createTableRow(product) {
        const typeOptions = {
            'stock': 'æœ‰åœ¨åº«',
            'dropship': 'ç„¡åœ¨åº«',
            'set': 'ã‚»ãƒƒãƒˆå“',
            'hybrid': 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰'
        };
        
        const conditionText = product.condition === 'new' ? 'æ–°å“' : 'ä¸­å¤';
        const profit = (product.priceUSD - product.costUSD).toFixed(2);
        
        return `
            <tr data-id="${product.id}">
                <td><input type="checkbox" class="excel-checkbox product-checkbox" data-id="${product.id}"></td>
                <td>
                    ${product.image ? 
                        `<img src="${product.image}" alt="å•†å“ç”»åƒ" style="width: 40px; height: 32px; object-fit: cover; border-radius: 4px;">` :
                        `<div style="width: 40px; height: 32px; background: var(--bg-tertiary); border-radius: 4px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-image" style="color: var(--text-muted);"></i></div>`
                    }
                </td>
                <td style="font-size: 0.75rem;">${product.name}</td>
                <td style="font-size: 0.75rem;">${product.sku}</td>
                <td style="font-size: 0.75rem; text-align: center;">${typeOptions[product.type] || product.type}</td>
                <td style="font-size: 0.75rem; text-align: center;">${conditionText}</td>
                <td style="font-size: 0.75rem; text-align: right;">$${product.priceUSD.toFixed(2)}</td>
                <td style="font-size: 0.75rem; text-align: center;">${product.stock}</td>
                <td style="font-size: 0.75rem; text-align: right;">$${product.costUSD.toFixed(2)}</td>
                <td style="font-size: 0.75rem; text-align: right; font-weight: 600; color: var(--color-success);">$${profit}</td>
                <td style="font-size: 0.75rem; text-align: center;">
                    <span style="padding: 1px 3px; background: #0064d2; color: white; border-radius: 2px; font-size: 0.6rem;">E</span>
                </td>
                <td style="font-size: 0.75rem;">${product.category}</td>
                <td>
                    <div style="display: flex; gap: 2px;">
                        <button class="excel-btn excel-btn--small" onclick="showProductDetail(${product.id})" title="è©³ç´°">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }
    
    // ========================================
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
    // ========================================
    function applyFilters() {
        console.log('ğŸ¯ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨é–‹å§‹');
        
        const filterType = document.getElementById('filter-type')?.value || '';
        const filterChannel = document.getElementById('filter-channel')?.value || '';
        const filterStatus = document.getElementById('filter-stock-status')?.value || '';
        const filterPrice = document.getElementById('filter-price-range')?.value || '';
        const searchQuery = document.getElementById('search-input')?.value || '';
        
        State.filteredProducts = State.allProducts.filter(product => {
            // ç¨®é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (filterType && product.type !== filterType) {
                return false;
            }
            
            // ãƒãƒ£ãƒãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (filterChannel && !product.channels.includes(filterChannel)) {
                return false;
            }
            
            // åœ¨åº«çŠ¶æ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (filterStatus) {
                if (filterStatus === 'sufficient' && product.stock < 10) return false;
                if (filterStatus === 'low' && (product.stock >= 10 || product.stock <= 0)) return false;
                if (filterStatus === 'out' && product.stock > 0) return false;
            }
            
            // ä¾¡æ ¼ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (filterPrice) {
                const price = product.priceUSD;
                switch (filterPrice) {
                    case '0-25': if (price < 0 || price > 25) return false; break;
                    case '25-50': if (price < 25 || price > 50) return false; break;
                    case '50-100': if (price < 50 || price > 100) return false; break;
                    case '100+': if (price < 100) return false; break;
                }
            }
            
            // æ¤œç´¢ã‚¯ã‚¨ãƒª
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                const searchFields = [
                    product.name,
                    product.sku,
                    product.category
                ].join(' ').toLowerCase();
                
                if (!searchFields.includes(query)) {
                    return false;
                }
            }
            
            return true;
        });
        
        updateProductDisplay();
        updateFilteredStatistics();
        
        console.log(`âœ… ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å®Œäº†: ${State.filteredProducts.length}/${State.allProducts.length}ä»¶è¡¨ç¤º`);
    }
    
    function resetFilters() {
        console.log('ğŸ”„ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ');
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
        const filterSelects = document.querySelectorAll('.inventory__filter-select');
        filterSelects.forEach(select => select.value = '');
        
        // æ¤œç´¢å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
        const searchInput = document.getElementById('search-input');
        if (searchInput) searchInput.value = '';
        
        // å…¨å•†å“ã‚’è¡¨ç¤º
        State.filteredProducts = [...State.allProducts];
        updateProductDisplay();
        updateFilteredStatistics();
        
        console.log('âœ… ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆå®Œäº†');
    }
    
    function handleSearch(event) {
        const query = event.target.value;
        console.log('ğŸ” æ¤œç´¢:', query);
        applyFilters(); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ã‚’å‘¼ã³å‡ºã—
    }
    
    // ========================================
    // çµ±è¨ˆæƒ…å ±æ›´æ–°
    // ========================================
    function updateStatisticsDisplay(stats) {
        const elements = {
            'total-products': stats.total,
            'stock-products': stats.stock,
            'dropship-products': stats.dropship,
            'set-products': stats.set || 0,
            'hybrid-products': stats.hybrid || 0,
            'total-value': `$${(stats.total_value_usd / 1000).toFixed(1)}K`
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value.toLocaleString ? value.toLocaleString() : value;
            }
        });
        
        console.log('ğŸ“Š çµ±è¨ˆæƒ…å ±æ›´æ–°å®Œäº†:', stats);
    }
    
    function updateFilteredStatistics() {
        const filteredStats = {
            total: State.filteredProducts.length,
            stock: State.filteredProducts.filter(p => p.type === 'stock').length,
            dropship: State.filteredProducts.filter(p => p.type === 'dropship').length,
            hybrid: State.filteredProducts.filter(p => p.type === 'hybrid').length,
            set: State.filteredProducts.filter(p => p.type === 'set').length,
            total_value_usd: State.filteredProducts.reduce((sum, p) => sum + p.priceUSD, 0)
        };
        
        updateStatisticsDisplay(filteredStats);
    }
    
    // ========================================
    // UIçŠ¶æ…‹åˆ¶å¾¡
    // ========================================
    function showLoadingIndicator(show) {
        const container = document.getElementById('card-view');
        if (!container) return;
        
        if (show) {
            container.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-secondary);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2.5rem; margin-bottom: 1rem;"></i>
                    <p style="font-size: 1.1rem;">PostgreSQLã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            `;
        }
    }
    
    // ========================================
    // é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
    // ========================================
    function showSuccessMessage(message) {
        showNotification(message, 'success', 'fas fa-check-circle');
    }
    
    function showErrorMessage(message) {
        showNotification(message, 'error', 'fas fa-exclamation-triangle');
    }
    
    function showNotification(message, type, icon) {
        const colors = {
            success: 'var(--color-success)',
            error: 'var(--color-danger)',
            warning: 'var(--color-warning)',
            info: 'var(--color-info)'
        };
        
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${colors[type] || colors.info};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            font-size: 0.9rem;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 8px;
        `;
        
        notification.innerHTML = `
            <i class="${icon}"></i>
            <div>${message}</div>
        `;
        
        document.body.appendChild(notification);
        
        // è‡ªå‹•å‰Šé™¤
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100px)';
                notification.style.transition = 'all 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }, type === 'error' ? 8000 : 5000);
    }
    
    // ========================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    // ========================================
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    function updateExchangeRateDisplay() {
        const element = document.getElementById('exchange-rate');
        if (element) {
            element.textContent = `Â¥${State.exchangeRate}`;
        }
    }
    
    // ========================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    // ========================================
    function handleCreateSet() {
        if (State.selectedProducts.length >= 2) {
            alert(`${State.selectedProducts.length}ç‚¹ã®å•†å“ã§ã‚»ãƒƒãƒˆå“ã‚’ä½œæˆã—ã¾ã™ã€‚`);
        } else {
            alert('æ–°è¦ã‚»ãƒƒãƒˆå“ä½œæˆç”»é¢ã‚’é–‹ãã¾ã™ã€‚');
        }
    }
    
    function handleAddProduct() {
        alert('æ–°è¦å•†å“ç™»éŒ²ç”»é¢ã‚’é–‹ãã¾ã™ã€‚');
    }
    
    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆäº’æ›æ€§ï¼‰
    // ========================================
    window.switchView = switchView;
    window.applyFilters = applyFilters;
    window.resetFilters = resetFilters;
    window.showProductDetail = function(id) {
        console.log('å•†å“è©³ç´°è¡¨ç¤º:', id);
        alert(`å•†å“ID ${id} ã®è©³ç´°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚`);
    };
    window.exportData = function() {
        console.log('ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ');
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™ã€‚');
    };
    
    console.log('ğŸ“œ æ£šå¸ã—ã‚·ã‚¹ãƒ†ãƒ ï¼ˆç´”ç²‹Webãƒ„ãƒ¼ãƒ«ç‰ˆï¼‰JavaScriptèª­ã¿è¾¼ã¿å®Œäº†');
    
})();