/**
 * NAGANO-3 ã‚¹ãƒžãƒ¼ãƒˆãƒ‘ã‚¹è§£æ±ºã‚·ã‚¹ãƒ†ãƒ 
 * common/js/utils/smart_path_resolver.js
 * 
 * âœ… ãƒ•ã‚©ãƒ«ãƒ€ç§»å‹•å¯¾å¿œã®è‡ªå‹•æ¤œå‡º
 * âœ… è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
 * âœ… ç ´æãƒªãƒ³ã‚¯ã®è‡ªå‹•ä¿®å¾©
 * âœ… æ®µéšŽçš„ç§»è¡Œã‚µãƒãƒ¼ãƒˆ
 * 
 * @version 1.0.0
 * @created 2025-07-06
 */

"use strict";

/**
 * ã‚¹ãƒžãƒ¼ãƒˆãƒ‘ã‚¹è§£æ±ºã‚¯ãƒ©ã‚¹
 */
class SmartPathResolver {
    constructor() {
        this.searchPaths = [
            // ðŸŽ¯ æŽ¨å¥¨æ§‹é€ 
            'common/js/core/',
            'common/js/ui/', 
            'common/js/debug/',
            'common/js/utils/',
            'common/js/modules/',
            
            // ðŸ”„ å¾“æ¥æ§‹é€ ï¼ˆå¾Œæ–¹äº’æ›ï¼‰
            'common/js/',
            
            // ðŸ“¦ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…æ§‹é€ 
            'modules/{module}/js/',
            'modules/{module}/assets/',
            'modules/{module}/',
            
            // ðŸ”§ ãã®ä»–å€™è£œ
            'assets/js/',
            'js/',
            'scripts/',
            'static/js/'
        ];
        
        this.fileCache = new Map();
        this.notFoundCache = new Set();
        this.moveHistory = new Map();
        
        this.initializeMoveHistory();
        
        console.log('ðŸŽ¯ SmartPathResolver: åˆæœŸåŒ–å®Œäº†');
    }
    
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•å±¥æ­´ã®åˆæœŸåŒ–
     */
    initializeMoveHistory() {
        try {
            const stored = localStorage.getItem('nagano3_file_moves');
            if (stored) {
                const moves = JSON.parse(stored);
                this.moveHistory = new Map(moves);
                console.log(`ðŸ“‹ ç§»å‹•å±¥æ­´å¾©å…ƒ: ${this.moveHistory.size}ä»¶`);
            }
        } catch (error) {
            console.warn('ç§»å‹•å±¥æ­´ã®å¾©å…ƒã«å¤±æ•—:', error);
        }
    }
    
    /**
     * ãƒ¡ã‚¤ãƒ³: ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ãƒ»è§£æ±º
     */
    async findFile(filename, moduleName = null, options = {}) {
        const cacheKey = this.getCacheKey(filename, moduleName);
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
        if (this.fileCache.has(cacheKey)) {
            const cached = this.fileCache.get(cacheKey);
            console.log(`ðŸ“¦ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ: ${filename} â†’ ${cached}`);
            return cached;
        }
        
        // Not Found ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
        if (this.notFoundCache.has(cacheKey)) {
            console.log(`âŒ Not Found ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${filename}`);
            return null;
        }
        
        console.log(`ðŸ” ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢é–‹å§‹: ${filename}${moduleName ? ` (module: ${moduleName})` : ''}`);
        
        // 1. ç§»å‹•å±¥æ­´ã‹ã‚‰æ¤œç´¢
        const fromHistory = await this.searchMoveHistory(filename);
        if (fromHistory) {
            this.fileCache.set(cacheKey, fromHistory);
            return fromHistory;
        }
        
        // 2. ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒžãƒƒãƒãƒ³ã‚°æ¤œç´¢
        const fromPattern = await this.searchByPatterns(filename, moduleName);
        if (fromPattern) {
            this.fileCache.set(cacheKey, fromPattern);
            return fromPattern;
        }
        
        // 3. æŽ¨æ¸¬ã«ã‚ˆã‚‹æ¤œç´¢
        const fromGuess = await this.searchByGuess(filename, moduleName);
        if (fromGuess) {
            this.fileCache.set(cacheKey, fromGuess);
            return fromGuess;
        }
        
        // 4. è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        console.warn(`âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«æœªç™ºè¦‹: ${filename}`);
        this.notFoundCache.add(cacheKey);
        
        if (options.createFallback) {
            return this.createFallbackPath(filename, moduleName);
        }
        
        return null;
    }
    
    /**
     * ç§»å‹•å±¥æ­´ã‹ã‚‰æ¤œç´¢
     */
    async searchMoveHistory(filename) {
        for (const [oldPath, newPath] of this.moveHistory) {
            if (oldPath.endsWith(filename)) {
                if (await this.fileExists(newPath)) {
                    console.log(`ðŸ“‹ ç§»å‹•å±¥æ­´ã‹ã‚‰ç™ºè¦‹: ${filename} â†’ ${newPath}`);
                    return newPath;
                }
            }
        }
        return null;
    }
    
    /**
     * ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒžãƒƒãƒãƒ³ã‚°æ¤œç´¢
     */
    async searchByPatterns(filename, moduleName) {
        for (const basePath of this.searchPaths) {
            const path = moduleName ? 
                basePath.replace('{module}', moduleName) : 
                basePath;
            
            const fullPath = path + filename;
            
            if (await this.fileExists(fullPath)) {
                console.log(`ðŸ“ ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒžãƒƒãƒ: ${filename} â†’ ${fullPath}`);
                return fullPath;
            }
        }
        return null;
    }
    
    /**
     * æŽ¨æ¸¬ã«ã‚ˆã‚‹æ¤œç´¢
     */
    async searchByGuess(filename, moduleName) {
        const guessedPaths = this.generateGuessedPaths(filename, moduleName);
        
        for (const guessedPath of guessedPaths) {
            if (await this.fileExists(guessedPath)) {
                console.log(`ðŸ”® æŽ¨æ¸¬ãƒ’ãƒƒãƒˆ: ${filename} â†’ ${guessedPath}`);
                return guessedPath;
            }
        }
        
        return null;
    }
    
    /**
     * æŽ¨æ¸¬ãƒ‘ã‚¹ç”Ÿæˆ
     */
    generateGuessedPaths(filename, moduleName) {
        const paths = [];
        
        // ãƒ•ã‚¡ã‚¤ãƒ«åã«ã‚ˆã‚‹åˆ†é¡žæŽ¨æ¸¬
        if (filename.includes('debug')) {
            paths.push(`common/js/debug/${filename}`);
        }
        
        if (filename.includes('theme')) {
            paths.push(`common/js/ui/${filename}`);
        }
        
        if (filename.includes('ajax')) {
            paths.push(`common/js/core/${filename}`);
        }
        
        if (filename.includes('notification')) {
            paths.push(`common/js/ui/${filename}`);
        }
        
        if (filename.includes('config')) {
            paths.push(`common/js/core/${filename}`);
        }
        
        if (filename.includes('util') || filename.includes('helper')) {
            paths.push(`common/js/utils/${filename}`);
        }
        
        // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åã«ã‚ˆã‚‹æŽ¨æ¸¬
        if (moduleName) {
            paths.push(`modules/${moduleName}/${filename}`);
            paths.push(`modules/${moduleName}/js/${filename}`);
            paths.push(`modules/${moduleName}/assets/${filename}`);
            paths.push(`common/js/modules/${moduleName}/${filename}`);
        }
        
        return paths;
    }
    
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
     */
    async fileExists(path) {
        try {
            const response = await fetch(path, { 
                method: 'HEAD',
                cache: 'no-cache' 
            });
            return response.status === 200;
        } catch {
            return false;
        }
    }
    
    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•ã®è¨˜éŒ²
     */
    recordMove(oldPath, newPath) {
        this.moveHistory.set(oldPath, newPath);
        
        try {
            localStorage.setItem('nagano3_file_moves', 
                JSON.stringify(Array.from(this.moveHistory.entries())));
            console.log(`ðŸ“ ç§»å‹•è¨˜éŒ²: ${oldPath} â†’ ${newPath}`);
        } catch (error) {
            console.warn('ç§»å‹•è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—:', error);
        }
    }
    
    /**
     * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‘ã‚¹ä½œæˆ
     */
    createFallbackPath(filename, moduleName) {
        if (moduleName) {
            return `modules/${moduleName}/${filename}`;
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥ã«ã‚ˆã‚‹æŽ¨æ¸¬
        if (filename.endsWith('.js')) {
            return `common/js/${filename}`;
        }
        
        return `assets/${filename}`;
    }
    
    /**
     * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆ
     */
    getCacheKey(filename, moduleName) {
        return moduleName ? `${moduleName}:${filename}` : filename;
    }
    
    /**
     * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
     */
    clearCache() {
        this.fileCache.clear();
        this.notFoundCache.clear();
        console.log('ðŸ§¹ ãƒ‘ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº†');
    }
    
    /**
     * çµ±è¨ˆæƒ…å ±
     */
    getStats() {
        return {
            cached_files: this.fileCache.size,
            not_found_cache: this.notFoundCache.size,
            move_history: this.moveHistory.size,
            search_patterns: this.searchPaths.length
        };
    }
    
    /**
     * ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
     */
    showDebugInfo() {
        console.group('ðŸŽ¯ SmartPathResolver Debug Info');
        console.log('Stats:', this.getStats());
        console.log('Search Paths:', this.searchPaths);
        console.log('File Cache:', Array.from(this.fileCache.entries()));
        console.log('Move History:', Array.from(this.moveHistory.entries()));
        console.groupEnd();
    }
}

/**
 * äº’æ›æ€§ãƒ–ãƒªãƒƒã‚¸ã‚¯ãƒ©ã‚¹
 */
class CompatibilityBridge {
    constructor(pathResolver) {
        this.pathResolver = pathResolver;
        this.setupAliases();
        this.setupPathRedirects();
        
        console.log('ðŸ”— CompatibilityBridge: åˆæœŸåŒ–å®Œäº†');
    }
    
    setupAliases() {
        // æ—§é–¢æ•°åã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
        if (window.NAGANO3) {
            window.NAGANO3_OLD = {
                loadScript: window.NAGANO3.loadScript,
                ajax: window.NAGANO3.ajax
            };
            
            // çŸ­ç¸®ã‚¨ã‚¤ãƒªã‚¢ã‚¹
            window.N3 = window.NAGANO3;
        }
    }
    
    setupPathRedirects() {
        // æ—§ãƒ‘ã‚¹ã‹ã‚‰æ–°ãƒ‘ã‚¹ã¸ã®è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        const pathRedirects = {
            'common/js/ajax.js': 'common/js/core/ajax.js',
            'common/js/notifications.js': 'common/js/ui/notifications.js',
            'common/js/theme.js': 'common/js/ui/theme.js',
            'common/js/debug_safe.js': 'common/js/debug/debug_safe.js',
            'common/js/module_loader.js': 'common/js/utils/module_loader.js'
        };
        
        // ãƒ‘ã‚¹ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¨˜éŒ²
        for (const [oldPath, newPath] of Object.entries(pathRedirects)) {
            this.pathResolver.recordMove(oldPath, newPath);
        }
        
        window.NAGANO3_PATH_REDIRECTS = pathRedirects;
    }
    
    /**
     * æ—§ãƒ‘ã‚¹ã®è‡ªå‹•å¤‰æ›
     */
    async resolveOldPath(oldPath) {
        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¾žæ›¸ã‹ã‚‰æ¤œç´¢
        if (window.NAGANO3_PATH_REDIRECTS[oldPath]) {
            return window.NAGANO3_PATH_REDIRECTS[oldPath];
        }
        
        // ãƒ‘ã‚¹ãƒªã‚¾ãƒ«ãƒãƒ¼ã§æ¤œç´¢
        const filename = oldPath.split('/').pop();
        return await this.pathResolver.findFile(filename);
    }
}

/**
 * æ®µéšŽçš„ç§»è¡Œãƒ˜ãƒ«ãƒ‘ãƒ¼
 */
class MigrationHelper {
    constructor(pathResolver) {
        this.pathResolver = pathResolver;
        this.migrationSteps = [];
        this.currentStep = 0;
        
        console.log('ðŸ”„ MigrationHelper: åˆæœŸåŒ–å®Œäº†');
    }
    
    addMigrationStep(description, actions) {
        this.migrationSteps.push({ 
            description, 
            actions: typeof actions === 'function' ? actions : () => actions
        });
    }
    
    async executeMigration() {
        console.log('ðŸ”„ æ®µéšŽçš„ç§»è¡Œé–‹å§‹');
        
        for (let i = 0; i < this.migrationSteps.length; i++) {
            const step = this.migrationSteps[i];
            console.log(`ðŸ“‹ Step ${i+1}: ${step.description}`);
            
            try {
                await step.actions();
                console.log(`âœ… Step ${i+1} å®Œäº†`);
                this.currentStep = i + 1;
            } catch (error) {
                console.error(`âŒ Step ${i+1} å¤±æ•—:`, error);
                break;
            }
        }
        
        console.log(`ðŸŽ‰ ç§»è¡Œå®Œäº†: ${this.currentStep}/${this.migrationSteps.length} steps`);
    }
    
    async checkFileMove(oldPath, newPath) {
        const exists = await this.pathResolver.fileExists(newPath);
        if (exists) {
            this.pathResolver.recordMove(oldPath, newPath);
            console.log(`âœ… ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•ç¢ºèª: ${oldPath} â†’ ${newPath}`);
        } else {
            console.warn(`âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•æœªå®Œäº†: ${newPath} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
        }
    }
}

// =====================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«åˆæœŸåŒ–
// =====================================

// ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
const smartPathResolver = new SmartPathResolver();
const compatibilityBridge = new CompatibilityBridge(smartPathResolver);
const migrationHelper = new MigrationHelper(smartPathResolver);

// NAGANO3çµ±åˆ
if (window.NAGANO3) {
    window.NAGANO3.pathResolver = smartPathResolver;
    window.NAGANO3.compatibility = compatibilityBridge;
    window.NAGANO3.migration = migrationHelper;
} else {
    window.NAGANO3_PATH_RESOLVER = smartPathResolver;
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
window.findFile = (filename, moduleName) => smartPathResolver.findFile(filename, moduleName);
window.recordFileMove = (oldPath, newPath) => smartPathResolver.recordMove(oldPath, newPath);
window.showPathDebug = () => smartPathResolver.showDebugInfo();

// =====================================
// äº‹å‰å®šç¾©æ¸ˆã¿ç§»è¡Œã‚¹ãƒ†ãƒƒãƒ—
// =====================================

// Core JSãƒ•ã‚¡ã‚¤ãƒ«ã®ç§»è¡Œ
migrationHelper.addMigrationStep(
    'Core JSãƒ•ã‚¡ã‚¤ãƒ«ã®ç§»å‹•ç¢ºèª',
    async () => {
        await migrationHelper.checkFileMove('common/js/ajax.js', 'common/js/core/ajax.js');
        await migrationHelper.checkFileMove('common/js/config.js', 'common/js/core/config.js');
        await migrationHelper.checkFileMove('common/js/error_handling.js', 'common/js/core/error_handling.js');
    }
);

// UI JSãƒ•ã‚¡ã‚¤ãƒ«ã®ç§»è¡Œ
migrationHelper.addMigrationStep(
    'UI JSãƒ•ã‚¡ã‚¤ãƒ«ã®ç§»å‹•ç¢ºèª',
    async () => {
        await migrationHelper.checkFileMove('common/js/notifications.js', 'common/js/ui/notifications.js');
        await migrationHelper.checkFileMove('common/js/theme.js', 'common/js/ui/theme.js');
        await migrationHelper.checkFileMove('common/js/loading-control.js', 'common/js/ui/loading-control.js');
    }
);

// Debug JSãƒ•ã‚¡ã‚¤ãƒ«ã®ç§»è¡Œ
migrationHelper.addMigrationStep(
    'Debug JSãƒ•ã‚¡ã‚¤ãƒ«ã®ç§»å‹•ç¢ºèª',
    async () => {
        await migrationHelper.checkFileMove('common/js/debug_safe.js', 'common/js/debug/debug_safe.js');
        await migrationHelper.checkFileMove('common/js/debug_emergency_fallback.js', 'common/js/debug/debug_emergency_fallback.js');
    }
);

console.log('ðŸŽ¯ SmartPathResolver ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');

// è‡ªå‹•ç§»è¡Œå®Ÿè¡Œï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ï¼‰
if (window.location.search.includes('auto_migrate=true')) {
    setTimeout(() => {
        console.log('ðŸš€ è‡ªå‹•ç§»è¡Œå®Ÿè¡Œé–‹å§‹');
        migrationHelper.executeMigration();
    }, 1000);
}