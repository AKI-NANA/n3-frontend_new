
// CAIDS character_limit Hook
// CAIDS character_limit Hook - Âü∫Êú¨ÂÆüË£Ö
console.log('‚úÖ character_limit Hook loaded');

// CAIDS error_handling Hook

// CAIDS „Ç®„É©„ÉºÂá¶ÁêÜHook - ÂÆåÂÖ®ÂÆüË£Ö
window.CAIDS_ERROR_HANDLER = {
    isActive: true,
    errorCount: 0,
    errorHistory: [],
    
    initialize: function() {
        this.setupGlobalErrorHandler();
        this.setupUnhandledPromiseRejection();
        this.setupNetworkErrorHandler();
        console.log('‚ö†Ô∏è CAIDS „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†ÂÆåÂÖ®ÂàùÊúüÂåñ');
    },
    
    setupGlobalErrorHandler: function() {
        window.addEventListener('error', (event) => {
            this.handleError({
                type: 'JavaScript Error',
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack
            });
        });
    },
    
    setupUnhandledPromiseRejection: function() {
        window.addEventListener('unhandledrejection', (event) => {
            this.handleError({
                type: 'Unhandled Promise Rejection',
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack
            });
        });
    },
    
    setupNetworkErrorHandler: function() {
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                if (!response.ok) {
                    window.CAIDS_ERROR_HANDLER.handleError({
                        type: 'Network Error',
                        message: `HTTP ${response.status}: ${response.statusText}`,
                        url: args[0]
                    });
                }
                return response;
            } catch (error) {
                window.CAIDS_ERROR_HANDLER.handleError({
                    type: 'Network Fetch Error',
                    message: error.message,
                    url: args[0]
                });
                throw error;
            }
        };
    },
    
    handleError: function(errorInfo) {
        this.errorCount++;
        this.errorHistory.push({...errorInfo, timestamp: new Date().toISOString()});
        
        console.error('üö® CAIDS Error Handler:', errorInfo);
        this.showErrorNotification(errorInfo);
        this.reportError(errorInfo);
    },
    
    showErrorNotification: function(errorInfo) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 10px; right: 10px; z-index: 999999;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 350px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            border: 2px solid #ff6666; animation: caids-error-shake 0.5s ease-in-out;
        `;
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">üö®</span>
                <div>
                    <strong>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</strong><br>
                    <small style="opacity: 0.9;">${errorInfo.type}: ${errorInfo.message}</small>
                </div>
            </div>
        `;
        
        // CSS Animation
        if (!document.getElementById('caids-error-styles')) {
            const style = document.createElement('style');
            style.id = 'caids-error-styles';
            style.textContent = `
                @keyframes caids-error-shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 7000);
    },
    
    reportError: function(errorInfo) {
        // „Ç®„É©„Éº„É¨„Éù„Éº„ÉàÁîüÊàê„ÉªÈÄÅ‰ø°ÔºàÂ∞ÜÊù•„ÅÆÊã°ÂºµÁî®Ôºâ
        const report = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            errorCount: this.errorCount,
            sessionId: this.getSessionId(),
            ...errorInfo
        };
        
        console.log('üìã CAIDS Error Report:', report);
        localStorage.setItem('caids_last_error', JSON.stringify(report));
    },
    
    getSessionId: function() {
        let sessionId = sessionStorage.getItem('caids_session_id');
        if (!sessionId) {
            sessionId = 'caids_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('caids_session_id', sessionId);
        }
        return sessionId;
    },
    
    getErrorStats: function() {
        return {
            totalErrors: this.errorCount,
            recentErrors: this.errorHistory.slice(-10),
            sessionId: this.getSessionId()
        };
    }
};

window.CAIDS_ERROR_HANDLER.initialize();

/**
 * üîç NAGANO-3 È´òÂ∫¶„Éï„Ç°„Ç§„É´Êé¢Á¥¢„Ç∑„Çπ„ÉÜ„É†
 * 
 * ‚úÖ Ë§áÊï∞„Éë„Çø„Éº„É≥Ëá™ÂãïÊé¢Á¥¢„Éª„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
 * ‚úÖ ÂÆåÂÖ®„Ç®„É©„ÉºÊäëÂà∂Ôºà404/Network/CORSÁ≠âÔºâ
 * ‚úÖ „Ç§„É≥„ÉÜ„É™„Ç∏„Çß„É≥„ÉàÊé®Ê∏¨„Éª„Éï„Ç°„Ç§„É´ÂêçÂ§âÊèõ
 * ‚úÖ „Çª„ÉÉ„Ç∑„Éß„É≥„Ç≠„É£„ÉÉ„Ç∑„É•„ÉªÊÄßËÉΩÊúÄÈÅ©Âåñ
 * 
 * @version 3.0.0-advanced-search
 */

"use strict";

// =====================================
// üõ°Ô∏è È´òÂ∫¶„Éï„Ç°„Ç§„É´Êé¢Á¥¢„Ç∑„Çπ„ÉÜ„É†
// =====================================

if (!window.NAGANO3_ADVANCED_FILE_FINDER) {
    window.NAGANO3_ADVANCED_FILE_FINDER = true;
    
    console.log('üîç NAGANO-3 È´òÂ∫¶„Éï„Ç°„Ç§„É´Êé¢Á¥¢„Ç∑„Çπ„ÉÜ„É†ÈñãÂßã');

    class AdvancedFileFinder {
        constructor() {
            this.searchPatterns = {
                // JS„Éï„Ç°„Ç§„É´Êé¢Á¥¢„Éë„Çø„Éº„É≥ÔºàÂÑ™ÂÖàÈ†Ü‰ΩçÈ†ÜÔºâ
                js: [
                    'common/js/pages/{filename}',
                    'common/js/components/{filename}',
                    'common/js/modules/{filename}',
                    'common/js/core/{filename}',
                    'common/js/ui/{filename}',
                    'common/js/utils/{filename}',
                    'common/js/system/{filename}',
                    'common/js/debug/{filename}',
                    'common/js/{filename}',
                    'js/pages/{filename}',
                    'js/components/{filename}',
                    'js/{filename}',
                    'assets/js/{filename}',
                    'modules/{modulename}/assets/{filename}',
                    'modules/{modulename}/{filename}',
                    '{filename}'
                ],
                
                // CSS„Éï„Ç°„Ç§„É´Êé¢Á¥¢„Éë„Çø„Éº„É≥
                css: [
                    'common/css/core/{filename}',
                    'common/css/pages/{filename}',
                    'common/css/templates/{filename}',
                    'common/css/components/{filename}',
                    'common/css/{filename}',
                    'css/core/{filename}',
                    'css/{filename}',
                    'assets/css/{filename}',
                    'modules/{modulename}/assets/{filename}',
                    '{filename}'
                ]
            };
            
            this.fileExtensions = {
                js: ['.js', '.min.js', '.esm.js'],
                css: ['.css', '.min.css']
            };
            
            this.cache = new Map(); // „Éï„Ç°„Ç§„É´Â≠òÂú®„Ç≠„É£„ÉÉ„Ç∑„É•
            this.sessionCache = this.loadSessionCache();
            this.silentMode = true; // ÂÆåÂÖ®„Ç®„É©„ÉºÊäëÂà∂
            this.maxSearchAttempts = 15; // ÊúÄÂ§ßÊé¢Á¥¢ÂõûÊï∞
            this.searchTimeout = 1000; // 1Áßí„Çø„Ç§„É†„Ç¢„Ç¶„Éà
            
            this.initializeErrorSuppression();
        }
        
        /**
         * ÂÆåÂÖ®„Ç®„É©„ÉºÊäëÂà∂ÂàùÊúüÂåñ
         */
        initializeErrorSuppression() {
            // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„ÉºÂÆåÂÖ®ÊäëÂà∂
            const originalFetch = window.fetch;
            const self = this;
            
            window.fetch = function(...args) {
                const [url, options] = args;
                
                // „Éï„Ç°„Ç§„É´Êé¢Á¥¢Èñ¢ÈÄ£„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„ÅÆ„ÅøÂá¶ÁêÜ
                if (self.isFileSearchRequest(url)) {
                    return originalFetch.apply(this, args).catch(error => {
                        // 404„ÇÑ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÇíÂÆåÂÖ®„Å´ÊäëÂà∂
                        if (self.silentMode) {
                            return { ok: false, status: 404, statusText: 'Not Found (Suppressed)' };
                        }
                        throw error;
                    });
                }
                
                return originalFetch.apply(this, args);
            };
        }
        
        /**
         * „Éï„Ç°„Ç§„É´Êé¢Á¥¢„É™„ÇØ„Ç®„Çπ„ÉàÂà§ÂÆö
         */
        isFileSearchRequest(url) {
            return url.includes('.js') || url.includes('.css');
        }
        
        /**
         * È´òÂ∫¶„Éï„Ç°„Ç§„É´Êé¢Á¥¢„É°„Ç§„É≥Èñ¢Êï∞
         */
        async findFile(filename, type = 'js', options = {}) {
            const searchKey = `${filename}:${type}`;
            
            // „Ç≠„É£„ÉÉ„Ç∑„É•Á¢∫Ë™ç
            if (this.cache.has(searchKey)) {
                const cached = this.cache.get(searchKey);
                console.log(`üéØ „Ç≠„É£„ÉÉ„Ç∑„É•ÂëΩ‰∏≠: ${filename} ‚Üí ${cached}`);
                return cached;
            }
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥„Ç≠„É£„ÉÉ„Ç∑„É•Á¢∫Ë™ç
            if (this.sessionCache.found[searchKey]) {
                const sessionCached = this.sessionCache.found[searchKey];
                this.cache.set(searchKey, sessionCached);
                console.log(`üì¶ „Çª„ÉÉ„Ç∑„Éß„É≥„Ç≠„É£„ÉÉ„Ç∑„É•ÂëΩ‰∏≠: ${filename} ‚Üí ${sessionCached}`);
                return sessionCached;
            }
            
            // Â§±Êïó„Ç≠„É£„ÉÉ„Ç∑„É•Á¢∫Ë™ç
            if (this.sessionCache.notFound.includes(searchKey)) {
                console.log(`‚ùå Â§±Êïó„Ç≠„É£„ÉÉ„Ç∑„É•: ${filename}`);
                return null;
            }
            
            console.log(`üîç È´òÂ∫¶„Éï„Ç°„Ç§„É´Êé¢Á¥¢ÈñãÂßã: ${filename} (${type})`);
            
            try {
                const result = await this.performAdvancedSearch(filename, type, options);
                
                if (result) {
                    // ÊàêÂäü„Ç≠„É£„ÉÉ„Ç∑„É•
                    this.cache.set(searchKey, result);
                    this.sessionCache.found[searchKey] = result;
                    this.saveSessionCache();
                    
                    console.log(`‚úÖ „Éï„Ç°„Ç§„É´Áô∫Ë¶ã: ${filename} ‚Üí ${result}`);
                    return result;
                } else {
                    // Â§±Êïó„Ç≠„É£„ÉÉ„Ç∑„É•
                    this.sessionCache.notFound.push(searchKey);
                    this.saveSessionCache();
                    
                    console.log(`‚ùå „Éï„Ç°„Ç§„É´Êú™Áô∫Ë¶ã: ${filename}`);
                    return null;
                }
                
            } catch (error) {
                if (!this.silentMode) {
                    console.warn(`‚ö†Ô∏è Êé¢Á¥¢„Ç®„É©„Éº: ${filename}`, error);
                }
                return null;
            }
        }
        
        /**
         * È´òÂ∫¶Êé¢Á¥¢ÂÆüË°å
         */
        async performAdvancedSearch(filename, type, options) {
            const patterns = this.searchPatterns[type] || this.searchPatterns.js;
            const extensions = this.fileExtensions[type] || this.fileExtensions.js;
            
            // „Éï„Ç°„Ç§„É´Âêç„Éê„É™„Ç®„Éº„Ç∑„Éß„É≥ÁîüÊàê
            const fileVariations = this.generateFileVariations(filename, extensions);
            
            // „Éë„Çø„Éº„É≥√ó„Éê„É™„Ç®„Éº„Ç∑„Éß„É≥Á∑èÂΩì„ÇäÊé¢Á¥¢
            for (const pattern of patterns) {
                for (const fileVariation of fileVariations) {
                    const searchPaths = this.generateSearchPaths(pattern, fileVariation, options);
                    
                    for (const searchPath of searchPaths) {
                        const exists = await this.checkFileExistsUltraSilent(searchPath);
                        if (exists) {
                            return searchPath;
                        }
                    }
                }
            }
            
            return null;
        }
        
        /**
         * „Éï„Ç°„Ç§„É´Âêç„Éê„É™„Ç®„Éº„Ç∑„Éß„É≥ÁîüÊàê
         */
        generateFileVariations(filename, extensions) {
            const variations = new Set();
            
            // Âü∫Êú¨„Éï„Ç°„Ç§„É´Âêç
            variations.add(filename);
            
            // Êã°ÂºµÂ≠ê„Å™„Åó„ÅÆÂ†¥Âêà„ÄÅÊã°ÂºµÂ≠êËøΩÂä†
            if (!filename.includes('.')) {
                extensions.forEach(ext => {
                    variations.add(filename + ext);
                });
            }
            
            // „Éè„Ç§„Éï„É≥„Éª„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢Â§âÊèõ
            const hyphenVersion = filename.replace(/_/g, '-');
            const underscoreVersion = filename.replace(/-/g, '_');
            
            variations.add(hyphenVersion);
            variations.add(underscoreVersion);
            
            // Êã°ÂºµÂ≠êËøΩÂä†„Éê„Éº„Ç∏„Éß„É≥
            if (!hyphenVersion.includes('.')) {
                extensions.forEach(ext => {
                    variations.add(hyphenVersion + ext);
                });
            }
            
            if (!underscoreVersion.includes('.')) {
                extensions.forEach(ext => {
                    variations.add(underscoreVersion + ext);
                });
            }
            
            // „Ç±„Éº„ÇπÂ§âÊèõ
            variations.add(filename.toLowerCase());
            variations.add(filename.toUpperCase());
            
            // ÁúÅÁï•ÂΩ¢Êé®Ê∏¨
            if (filename.includes('-')) {
                const abbreviated = filename.split('-').map(part => part.charAt(0)).join('');
                extensions.forEach(ext => {
                    variations.add(abbreviated + ext);
                });
            }
            
            return Array.from(variations);
        }
        
        /**
         * Ê§úÁ¥¢„Éë„ÇπÁîüÊàê
         */
        generateSearchPaths(pattern, filename, options) {
            const paths = [];
            
            // Âü∫Êú¨„Éë„ÇπÁΩÆÊèõ
            let basePath = pattern.replace('{filename}', filename);
            
            // „É¢„Ç∏„É•„Éº„É´ÂêçÊé®Ê∏¨„ÉªÁΩÆÊèõ
            if (basePath.includes('{modulename}')) {
                const moduleNames = this.inferModuleNames(filename, options);
                
                moduleNames.forEach(moduleName => {
                    paths.push(basePath.replace('{modulename}', moduleName));
                });
            } else {
                paths.push(basePath);
            }
            
            return paths;
        }
        
        /**
         * „É¢„Ç∏„É•„Éº„É´ÂêçÊé®Ê∏¨
         */
        inferModuleNames(filename, options) {
            const moduleNames = [];
            
            // „Ç™„Éó„Ç∑„Éß„É≥„Åã„ÇâÊåáÂÆö
            if (options.moduleName) {
                moduleNames.push(options.moduleName);
            }
            
            // ÁèæÂú®„Éö„Éº„Ç∏„Åã„ÇâÊé®Ê∏¨
            const currentPage = this.detectCurrentPage();
            if (currentPage) {
                moduleNames.push(currentPage);
            }
            
            // „Éï„Ç°„Ç§„É´Âêç„Åã„ÇâÊé®Ê∏¨
            if (filename.includes('kicho')) moduleNames.push('kicho');
            if (filename.includes('juchu')) moduleNames.push('juchu');
            if (filename.includes('shohin')) moduleNames.push('shohin');
            if (filename.includes('zaiko')) moduleNames.push('zaiko');
            
            // URL„Åã„ÇâÊé®Ê∏¨
            const url = window.location.href;
            if (url.includes('kicho')) moduleNames.push('kicho');
            if (url.includes('juchu')) moduleNames.push('juchu');
            if (url.includes('shohin')) moduleNames.push('shohin');
            if (url.includes('zaiko')) moduleNames.push('zaiko');
            
            // ÈáçË§áÈô§Âéª
            return [...new Set(moduleNames)];
        }
        
        /**
         * ÁèæÂú®„Éö„Éº„Ç∏Ê§úÂá∫
         */
        detectCurrentPage() {
            const pageParam = new URLSearchParams(window.location.search).get('page');
            if (pageParam) return pageParam;
            
            const url = window.location.href;
            if (url.includes('kicho')) return 'kicho';
            if (url.includes('juchu')) return 'juchu';
            if (url.includes('shohin')) return 'shohin';
            if (url.includes('zaiko')) return 'zaiko';
            if (url.includes('debug')) return 'debug';
            
            return 'dashboard';
        }
        
        /**
         * Ë∂Ö„Çµ„Ç§„É¨„É≥„Éà„Éï„Ç°„Ç§„É´Â≠òÂú®Á¢∫Ë™ç
         */
        async checkFileExistsUltraSilent(url) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), this.searchTimeout);
                
                const response = await fetch(url, {
                    method: 'HEAD',
                    signal: controller.signal,
                    cache: 'no-cache',
                    mode: 'cors',
                    credentials: 'same-origin'
                });
                
                clearTimeout(timeoutId);
                return response.ok;
                
            } catch (error) {
                // ÂÖ®Á®ÆÈ°û„ÅÆ„Ç®„É©„Éº„ÇíÂÆåÂÖ®ÊäëÂà∂
                // 404, Network, CORS, Timeout Á≠â
                return false;
            }
        }
        
        /**
         * „Çª„ÉÉ„Ç∑„Éß„É≥„Ç≠„É£„ÉÉ„Ç∑„É•ÁÆ°ÁêÜ
         */
        loadSessionCache() {
            try {
                const cached = sessionStorage.getItem('nagano3_file_finder_cache');
                return cached ? JSON.parse(cached) : {
                    found: {},
                    notFound: [],
                    timestamp: Date.now()
                };
            } catch (error) {
                return { found: {}, notFound: [], timestamp: Date.now() };
            }
        }
        
        saveSessionCache() {
            try {
                this.sessionCache.timestamp = Date.now();
                sessionStorage.setItem('nagano3_file_finder_cache', JSON.stringify(this.sessionCache));
            } catch (error) {
                // „Çπ„Éà„É¨„Éº„Ç∏„Ç®„É©„Éº„ÇÇÊäëÂà∂
            }
        }
        
        /**
         * „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢
         */
        clearCache() {
            this.cache.clear();
            this.sessionCache = { found: {}, notFound: [], timestamp: Date.now() };
            try {
                sessionStorage.removeItem('nagano3_file_finder_cache');
            } catch (error) {
                // ÊäëÂà∂
            }
            console.log('üóëÔ∏è „Éï„Ç°„Ç§„É´Êé¢Á¥¢„Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢ÂÆå‰∫Ü');
        }
        
        /**
         * „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±
         */
        getDebugInfo() {
            return {
                cacheSize: this.cache.size,
                sessionFound: Object.keys(this.sessionCache.found).length,
                sessionNotFound: this.sessionCache.notFound.length,
                searchPatterns: Object.keys(this.searchPatterns),
                silentMode: this.silentMode,
                maxSearchAttempts: this.maxSearchAttempts
            };
        }
        
        /**
         * „Çµ„Ç§„É¨„É≥„Éà„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
         */
        setSilentMode(enabled) {
            this.silentMode = enabled;
            console.log(`üîá È´òÂ∫¶„Éï„Ç°„Ç§„É´Êé¢Á¥¢„Çµ„Ç§„É¨„É≥„Éà„É¢„Éº„Éâ: ${enabled ? 'ON' : 'OFF'}`);
        }
    }

    // =====================================
    // üöÄ Áµ±ÂêàJS LoaderÔºàÈ´òÂ∫¶Êé¢Á¥¢ÂØæÂøúÁâàÔºâ
    // =====================================
    
    class UltraJSLoader {
        constructor() {
            this.fileFinder = new AdvancedFileFinder();
            this.loadedFiles = new Set();
            this.loadingPromises = new Map(); // ÈáçË§áË™≠„ÅøËæº„ÅøÈò≤Ê≠¢
            this.currentPage = this.fileFinder.detectCurrentPage();
            
            // NAGANO3Áµ±Âêà
            if (!window.NAGANO3) window.NAGANO3 = {};
            if (!window.NAGANO3.system) window.NAGANO3.system = {};
            window.NAGANO3.system.ultraJSLoader = this;
            window.NAGANO3.system.fileFinder = this.fileFinder;
        }
        
        /**
         * „Çπ„Éû„Éº„Éà„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
         */
        async loadFile(filename, options = {}) {
            // ÈáçË§áË™≠„ÅøËæº„ÅøÈò≤Ê≠¢
            if (this.loadingPromises.has(filename)) {
                console.log(`‚è≥ Ë™≠„ÅøËæº„Åø‰∏≠: ${filename}`);
                return this.loadingPromises.get(filename);
            }
            
            if (this.loadedFiles.has(filename)) {
                console.log(`‚è≠Ô∏è Êó¢Ë™≠„ÅøËæº„Åø: ${filename}`);
                return { success: true, cached: true };
            }
            
            // Ë™≠„ÅøËæº„ÅøÈñãÂßã
            const loadPromise = this.performSmartLoad(filename, options);
            this.loadingPromises.set(filename, loadPromise);
            
            try {
                const result = await loadPromise;
                if (result.success) {
                    this.loadedFiles.add(filename);
                }
                return result;
            } finally {
                this.loadingPromises.delete(filename);
            }
        }
        
        /**
         * „Çπ„Éû„Éº„ÉàË™≠„ÅøËæº„ÅøÂÆüË°å
         */
        async performSmartLoad(filename, options) {
            try {
                // „Éï„Ç°„Ç§„É´Êé¢Á¥¢
                const fileType = filename.endsWith('.css') ? 'css' : 'js';
                const foundPath = await this.fileFinder.findFile(filename, fileType, {
                    moduleName: options.moduleName || this.currentPage
                });
                
                if (!foundPath) {
                    console.log(`‚ùå „Éï„Ç°„Ç§„É´Êú™Áô∫Ë¶ã: ${filename}`);
                    return { success: false, error: 'File not found' };
                }
                
                // „Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
                if (fileType === 'js') {
                    return this.loadJSFile(foundPath);
                } else {
                    return this.loadCSSFile(foundPath);
                }
                
            } catch (error) {
                console.warn(`‚ö†Ô∏è „Çπ„Éû„Éº„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${filename}`, error);
                return { success: false, error: error.message };
            }
        }
        
        /**
         * JS „Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
         */
        async loadJSFile(url) {
            return new Promise((resolve) => {
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.async = false;
                script.src = url;
                
                script.onload = () => {
                    console.log(`‚úÖ JSË™≠„ÅøËæº„ÅøÊàêÂäü: ${url}`);
                    resolve({ success: true, url: url });
                };
                
                script.onerror = () => {
                    script.remove();
                    console.warn(`‚ùå JSË™≠„ÅøËæº„ÅøÂ§±Êïó: ${url}`);
                    resolve({ success: false, error: 'Script load failed', url: url });
                };
                
                document.head.appendChild(script);
                
                // „Çø„Ç§„É†„Ç¢„Ç¶„Éà
                setTimeout(() => {
                    if (!script.readyState || script.readyState === 'loading') {
                        script.remove();
                        resolve({ success: false, error: 'Timeout', url: url });
                    }
                }, 10000);
            });
        }
        
        /**
         * CSS „Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
         */
        async loadCSSFile(url) {
            return new Promise((resolve) => {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = url;
                
                link.onload = () => {
                    console.log(`‚úÖ CSSË™≠„ÅøËæº„ÅøÊàêÂäü: ${url}`);
                    resolve({ success: true, url: url });
                };
                
                link.onerror = () => {
                    link.remove();
                    console.warn(`‚ùå CSSË™≠„ÅøËæº„ÅøÂ§±Êïó: ${url}`);
                    resolve({ success: false, error: 'CSS load failed', url: url });
                };
                
                document.head.appendChild(link);
                
                // „Çø„Ç§„É†„Ç¢„Ç¶„Éà
                setTimeout(() => {
                    if (!link.sheet) {
                        link.remove();
                        resolve({ success: false, error: 'Timeout', url: url });
                    }
                }, 5000);
            });
        }
        
        /**
         * „Éö„Éº„Ç∏Âõ∫Êúâ„Éï„Ç°„Ç§„É´Ëá™ÂãïË™≠„ÅøËæº„Åø
         */
        async loadPageFiles(page = null) {
            const targetPage = page || this.currentPage;
            console.log(`üì¶ „Éö„Éº„Ç∏„Éï„Ç°„Ç§„É´Ëá™ÂãïË™≠„ÅøËæº„Åø: ${targetPage}`);
            
            const pageFiles = this.getPageFileList(targetPage);
            const results = [];
            
            for (const filename of pageFiles) {
                const result = await this.loadFile(filename, { moduleName: targetPage });
                results.push({ filename, ...result });
            }
            
            const successCount = results.filter(r => r.success).length;
            console.log(`üì¶ „Éö„Éº„Ç∏„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${successCount}/${results.length}‰ª∂ÊàêÂäü`);
            
            return results;
        }
        
        /**
         * „Éö„Éº„Ç∏Âà•„Éï„Ç°„Ç§„É´„É™„Çπ„Éà
         */
        getPageFileList(page) {
            const fileMap = {
                'kicho': ['kicho.js', 'kicho-dashboard.js', 'ai-learning.js'],
                'juchu': ['juchu.js', 'order-management.js'],
                'shohin': ['shohin.js', 'product-management.js'],
                'zaiko': ['zaiko.js', 'inventory-management.js'],
                'debug': ['debug-panel.js', 'performance-monitor.js'],
                'dashboard': ['dashboard.js', 'stats-widget.js']
            };
            
            return fileMap[page] || fileMap['dashboard'];
        }
        
        /**
         * „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±
         */
        getDebugInfo() {
            return {
                currentPage: this.currentPage,
                loadedFiles: Array.from(this.loadedFiles),
                loadingFiles: Array.from(this.loadingPromises.keys()),
                fileFinder: this.fileFinder.getDebugInfo()
            };
        }
    }

    // =====================================
    // üöÄ „Ç∞„É≠„Éº„Éê„É´ÂàùÊúüÂåñ„Éª„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ
    // =====================================
    
    const ultraLoader = new UltraJSLoader();
    
    // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞ÂÆöÁæ©
    window.findFile = function(filename, type, options) {
        return ultraLoader.fileFinder.findFile(filename, type, options);
    };
    
    window.loadFileSmartly = function(filename, options) {
        return ultraLoader.loadFile(filename, options);
    };
    
    window.loadPageFiles = function(page) {
        return ultraLoader.loadPageFiles(page);
    };
    
    window.clearFileCache = function() {
        ultraLoader.fileFinder.clearCache();
    };
    
    window.getFileFinderStatus = function() {
        return ultraLoader.getDebugInfo();
    };
    
    window.setFileFinderSilent = function(enabled) {
        ultraLoader.fileFinder.setSilentMode(enabled);
    };
    
    // ÂàùÊúüÂåñÂÆå‰∫Ü„Ç§„Éô„É≥„Éà
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ È´òÂ∫¶„Éï„Ç°„Ç§„É´Êé¢Á¥¢„Ç∑„Çπ„ÉÜ„É†Ê∫ñÂÇôÂÆå‰∫Ü');
        
        // ÁèæÂú®„Éö„Éº„Ç∏„ÅÆ„Éï„Ç°„Ç§„É´Ëá™ÂãïË™≠„ÅøËæº„Åø
        setTimeout(() => {
            ultraLoader.loadPageFiles();
        }, 1000);
    });
    
    console.log('‚úÖ NAGANO-3 È´òÂ∫¶„Éï„Ç°„Ç§„É´Êé¢Á¥¢„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆöÂÆå‰∫Ü');

} else {
    console.log('‚è≠Ô∏è È´òÂ∫¶„Éï„Ç°„Ç§„É´Êé¢Á¥¢„Ç∑„Çπ„ÉÜ„É†Êó¢„Å´ÂàùÊúüÂåñÊ∏à„Åø');
}