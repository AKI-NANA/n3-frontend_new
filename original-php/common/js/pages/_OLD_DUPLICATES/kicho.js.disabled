/**
 * ğŸ“ common/js/pages/kicho_enhanced.js - å®Œå…¨æ‹¡å¼µç‰ˆ
 * ğŸ¯ æ©Ÿèƒ½: è¿½åŠ æ©Ÿèƒ½ã®JavaScriptå®Ÿè£…
 * âš¡ åŠ¹æœ: CSVé‡è¤‡é˜²æ­¢ãƒ»MFå±¥æ­´ç®¡ç†ãƒ»AIåˆ†æãƒ»é«˜åº¦æ‰¿èªã‚·ã‚¹ãƒ†ãƒ 
 */

"use strict";

// =====================================
// ğŸš€ æ‹¡å¼µæ©Ÿèƒ½çµ±åˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
// =====================================

window.KICHO_ENHANCED = window.KICHO_ENHANCED || {
    version: '1.0.0-complete',
    initialized: false,
    autoRefreshEnabled: false,
    refreshInterval: 30000,
    intervalId: null,
    managers: {}
};

// =====================================
// ğŸ”„ CSVé‡è¤‡é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ 
// =====================================

class CSVDuplicatePreventionManager {
    constructor() {
        this.currentFile = null;
        this.duplicateResults = null;
        this.processingInProgress = false;
    }

    // ã‚¹ãƒãƒ¼ãƒˆCSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    async handleSmartCSVUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        this.currentFile = file;
        this.processingInProgress = true;

        try {
            showNotification('CSVé‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­...', 'info');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
            const csvData = await this.readCSVFile(file);
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
            const strategy = document.getElementById('duplicateStrategy').value;
            const duplicateResult = await this.checkDuplicates(csvData, strategy);
            
            this.duplicateResults = duplicateResult;
            
            // çµæœè¡¨ç¤º
            this.displayDuplicateResults(duplicateResult);
            
            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
            const uploadBtn = document.getElementById('csvUploadBtn');
            if (uploadBtn) {
                uploadBtn.disabled = false;
                uploadBtn.textContent = `é‡è¤‡è§£æ±ºã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (${duplicateResult.unique_count}ä»¶)`;
            }

            if (duplicateResult.duplicate_count > 0) {
                showNotification(`${duplicateResult.duplicate_count}ä»¶ã®é‡è¤‡ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`, 'warning');
            } else {
                showNotification('é‡è¤‡ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'success');
            }

        } catch (error) {
            console.error('CSVå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            showNotification('CSVå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
        } finally {
            this.processingInProgress = false;
        }
    }

    // CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    async readCSVFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    const headers = lines[0].split(',');
                    const data = [];

                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header.trim()] = values[index]?.trim() || '';
                        });
                        data.push(row);
                    }

                    resolve(data);
                } catch (error) {
                    reject(new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            };
            reader.onerror = () => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
            reader.readAsText(file, 'UTF-8');
        });
    }

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
    async checkDuplicates(csvData, strategy) {
        try {
            const response = await NAGANO3.ajax.request('check_csv_duplicates', {
                csv_data: JSON.stringify(csvData),
                strategy: strategy
            });

            if (response.success) {
                return response.data;
            } else {
                throw new Error(response.message);
            }
        } catch (error) {
            throw new Error('é‡è¤‡ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
    }

    // é‡è¤‡çµæœè¡¨ç¤º
    displayDuplicateResults(results) {
        const summaryElement = document.getElementById('csvDuplicateSummary');
        if (summaryElement) {
            summaryElement.style.display = 'block';
            
            document.getElementById('totalRecords').textContent = results.total_count;
            document.getElementById('duplicateRecords').textContent = results.duplicate_count;
            document.getElementById('uniqueRecords').textContent = results.unique_count;
        }
    }

    // é‡è¤‡è§£æ±ºå‡¦ç†å®Ÿè¡Œ
    async processCSVUpload() {
        if (!this.duplicateResults) {
            showNotification('å…ˆã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
            return;
        }

        try {
            const resolutionStrategy = document.getElementById('resolutionStrategy').value;
            
            showNotification('é‡è¤‡è§£æ±ºå‡¦ç†ã‚’å®Ÿè¡Œä¸­...', 'info');

            if (this.duplicateResults.duplicate_count > 0) {
                const resolutionResult = await this.resolveDuplicates(
                    this.duplicateResults.duplicates, 
                    resolutionStrategy
                );
                
                showNotification(
                    `é‡è¤‡è§£æ±ºå®Œäº†: ${resolutionResult.resolved_count}ä»¶å‡¦ç†`, 
                    'success'
                );
            }

            // å®Ÿéš›ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            await this.executeUpload(this.duplicateResults.unique_records);
            
            showNotification('CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
            
            // UI ãƒªã‚»ãƒƒãƒˆ
            this.resetUploadUI();

        } catch (error) {
            console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            showNotification('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        }
    }

    // é‡è¤‡è§£æ±ºå®Ÿè¡Œ
    async resolveDuplicates(duplicates, strategy) {
        const response = await NAGANO3.ajax.request('resolve_csv_duplicates', {
            duplicates: JSON.stringify(duplicates),
            resolution_strategy: strategy
        });

        if (response.success) {
            return response.data;
        } else {
            throw new Error(response.message);
        }
    }

    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
    async executeUpload(data) {
        // å®Ÿéš›ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ï¼ˆæ—¢å­˜ã®CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼‰
        console.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ:', data.length, 'ä»¶');
    }

    // UI ãƒªã‚»ãƒƒãƒˆ
    resetUploadUI() {
        this.currentFile = null;
        this.duplicateResults = null;
        
        const uploadBtn = document.getElementById('csvUploadBtn');
        if (uploadBtn) {
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'é‡è¤‡ãƒã‚§ãƒƒã‚¯&ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
        }

        const summaryElement = document.getElementById('csvDuplicateSummary');
        if (summaryElement) {
            summaryElement.style.display = 'none';
        }

        const fileInput = document.getElementById('csvFileInput');
        if (fileInput) {
            fileInput.value = '';
        }
    }
}

// =====================================
// ğŸŒ MFé€£æºå±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
// =====================================

class MFHistoryManager {
    constructor() {
        this.history = [];
        this.currentStatus = 'unknown';
        this.autoRecoveryInProgress = false;
    }

    // MFå±¥æ­´è¡¨ç¤º
    async showMFHistory() {
        try {
            showNotification('MFé€£æºå±¥æ­´ã‚’å–å¾—ä¸­...', 'info');

            const response = await NAGANO3.ajax.request('get_mf_history', {
                limit: 50,
                filter: JSON.stringify({})
            });

            if (response.success) {
                this.history = response.data.history;
                this.displayHistoryModal(response.data.history);
                showNotification('MFé€£æºå±¥æ­´ã‚’å–å¾—ã—ã¾ã—ãŸ', 'success');
            } else {
                throw new Error(response.message);
            }

        } catch (error) {
            console.error('MFå±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            showNotification('MFå±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        }
    }

    // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    displayHistoryModal(history) {
        const modal = document.createElement('div');
        modal.className = 'kicho__modal';
        modal.innerHTML = `
            <div class="kicho__modal-overlay" onclick="this.closest('.kicho__modal').remove()"></div>
            <div class="kicho__modal-content">
                <div class="kicho__modal-header">
                    <h3>
                        <i class="fas fa-history"></i>
                        MFé€£æºå±¥æ­´
                    </h3>
                    <button onclick="this.closest('.kicho__modal').remove()" class="kicho__modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="kicho__modal-body">
                    <div class="kicho__history-list">
                        ${history.map(item => `
                            <div class="kicho__history-item kicho__history-item--${item.result}">
                                <div class="kicho__history-header">
                                    <span class="kicho__history-time">${item.timestamp}</span>
                                    <span class="kicho__history-action">${this.getActionText(item.action)}</span>
                                    <span class="kicho__history-result kicho__history-result--${item.result}">
                                        ${item.result === 'success' ? 'æˆåŠŸ' : 'ã‚¨ãƒ©ãƒ¼'}
                                    </span>
                                </div>
                                <div class="kicho__history-details">
                                    ${this.formatHistoryDetails(item)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    // MFæ¥ç¶šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    async updateMFStatus() {
        try {
            const response = await NAGANO3.ajax.request('get_mf_status');

            if (response.success) {
                this.currentStatus = response.data.status;
                this.updateStatusDisplay(response.data);
            }

        } catch (error) {
            console.error('MFã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            this.currentStatus = 'error';
        }
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
    updateStatusDisplay(statusData) {
        const statusIcon = document.getElementById('mfStatusIcon');
        const statusText = document.getElementById('mfStatusText');
        const lastSync = document.getElementById('lastMfSync');
        const errorCount = document.getElementById('mfErrorCount');

        if (statusIcon) {
            statusIcon.className = statusData.status === 'connected' ? 'fas fa-wifi' : 
                                   statusData.status === 'warning' ? 'fas fa-exclamation-triangle' : 
                                   'fas fa-wifi-slash';
        }

        if (statusText) {
            statusText.textContent = statusData.status === 'connected' ? 'æ¥ç¶šæ¸ˆã¿' : 
                                     statusData.status === 'warning' ? 'è­¦å‘Š' : 
                                     'æœªæ¥ç¶š';
        }

        if (lastSync && statusData.last_success) {
            lastSync.textContent = statusData.last_success.timestamp;
        }

        if (errorCount) {
            errorCount.textContent = statusData.error_count;
        }
    }

    // è‡ªå‹•å¾©æ—§å®Ÿè¡Œ
    async executeMFRecovery() {
        if (this.autoRecoveryInProgress) {
            showNotification('è‡ªå‹•å¾©æ—§ã¯æ—¢ã«å®Ÿè¡Œä¸­ã§ã™', 'warning');
            return;
        }

        try {
            this.autoRecoveryInProgress = true;
            showNotification('MFé€£æºè‡ªå‹•å¾©æ—§ã‚’å®Ÿè¡Œä¸­...', 'info');

            const response = await NAGANO3.ajax.request('execute_mf_recovery', {
                error_context: JSON.stringify({
                    current_status: this.currentStatus,
                    timestamp: new Date().toISOString()
                })
            });

            if (response.success) {
                showNotification('MFé€£æºã®å¾©æ—§ã«æˆåŠŸã—ã¾ã—ãŸ', 'success');
                await this.updateMFStatus();
            } else {
                showNotification('MFé€£æºã®å¾©æ—§ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }

        } catch (error) {
            console.error('MFå¾©æ—§ã‚¨ãƒ©ãƒ¼:', error);
            showNotification('å¾©æ—§å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
        } finally {
            this.autoRecoveryInProgress = false;
        }
    }

    // ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
    getActionText(action) {
        const actionMap = {
            'import': 'ãƒ‡ãƒ¼ã‚¿å–å¾—',
            'export': 'ãƒ‡ãƒ¼ã‚¿é€ä¿¡',
            'sync': 'åŒæœŸå‡¦ç†',
            'auto_recovery': 'è‡ªå‹•å¾©æ—§'
        };
        return actionMap[action] || action;
    }

    formatHistoryDetails(item) {
        if (item.data) {
            const details = [];
            if (item.data.imported_count) details.push(`å–å¾—ä»¶æ•°: ${item.data.imported_count}ä»¶`);
            if (item.data.exported_count) details.push(`é€ä¿¡ä»¶æ•°: ${item.data.exported_count}ä»¶`);
            if (item.data.error_code) details.push(`ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${item.data.error_code}`);
            if (item.duration) details.push(`å‡¦ç†æ™‚é–“: ${item.duration}ç§’`);
            
            return details.join(' | ');
        }
        return '';
    }
}

// =====================================
// ğŸ§  AIå­¦ç¿’å±¥æ­´ãƒ»åˆ†æã‚·ã‚¹ãƒ†ãƒ 
// =====================================

class AILearningAnalyticsManager {
    constructor() {
        this.sessions = [];
        this.accuracyTrend = [];
        this.qualityAnalysis = null;
    }

    // é«˜åº¦AIå­¦ç¿’å®Ÿè¡Œ
    async executeAdvancedAILearning() {
        const textInput = document.getElementById('aiTextInput');
        const learningMode = document.getElementById('learningMode');
        const ruleCategory = document.getElementById('ruleCategory');

        if (!textInput || !textInput.value.trim()) {
            showNotification('å­¦ç¿’ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
            return;
        }

        try {
            showNotification('AIå­¦ç¿’ã‚’å®Ÿè¡Œä¸­...', 'info');
            this.showLearningProgress(true);

            const response = await NAGANO3.ajax.request('execute_ai_learning', {
                text_content: textInput.value,
                learning_mode: learningMode.value,
                category: ruleCategory.value
            });

            if (response.success) {
                showNotification(
                    `AIå­¦ç¿’å®Œäº†: ${response.data.generated_rules_count}ä»¶ã®ãƒ«ãƒ¼ãƒ«ç”Ÿæˆ`, 
                    'success'
                );
                
                // çµæœè¡¨ç¤º
                this.displayLearningResults(response.data);
                
                // ãƒ†ã‚­ã‚¹ãƒˆã‚¯ãƒªã‚¢
                textInput.value = '';
                
                // çµ±è¨ˆæ›´æ–°
                await this.refreshAIAnalytics();

            } else {
                throw new Error(response.message);
            }

        } catch (error) {
            console.error('AIå­¦ç¿’ã‚¨ãƒ©ãƒ¼:', error);
            showNotification('AIå­¦ç¿’ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        } finally {
            this.showLearningProgress(false);
        }
    }

    // å­¦ç¿’é€²è¡Œè¡¨ç¤º
    showLearningProgress(show) {
        const stages = ['stage1', 'stage2', 'stage3'];
        
        stages.forEach((stageId, index) => {
            const stage = document.getElementById(stageId);
            if (stage) {
                if (show) {
                    setTimeout(() => {
                        stage.classList.add('kicho__stage--active');
                    }, index * 1000);
                } else {
                    stage.classList.remove('kicho__stage--active');
                }
            }
        });
    }

    // å­¦ç¿’çµæœè¡¨ç¤º
    displayLearningResults(results) {
        const modal = document.createElement('div');
        modal.className = 'kicho__modal';
        modal.innerHTML = `
            <div class="kicho__modal-overlay" onclick="this.closest('.kicho__modal').remove()"></div>
            <div class="kicho__modal-content">
                <div class="kicho__modal-header">
                    <h3>
                        <i class="fas fa-brain"></i>
                        AIå­¦ç¿’çµæœ
                    </h3>
                    <button onclick="this.closest('.kicho__modal').remove()" class="kicho__modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="kicho__modal-body">
                    <div class="kicho__learning-results">
                        <div class="kicho__result-stats">
                            <div class="kicho__result-stat">
                                <span class="kicho__stat-number">${results.generated_rules_count}</span>
                                <span class="kicho__stat-label">ç”Ÿæˆãƒ«ãƒ¼ãƒ«æ•°</span>
                            </div>
                            <div class="kicho__result-stat">
                                <span class="kicho__stat-number">${results.confidence_avg}%</span>
                                <span class="kicho__stat-label">å¹³å‡ä¿¡é ¼åº¦</span>
                            </div>
                            <div class="kicho__result-stat">
                                <span class="kicho__stat-number">${results.processing_time}ç§’</span>
                                <span class="kicho__stat-label">å‡¦ç†æ™‚é–“</span>
                            </div>
                        </div>
                        <div class="kicho__accuracy-improvement">
                            <h4>ç²¾åº¦æ”¹å–„</h4>
                            <p>å‡¦ç†å‰: ${results.accuracy_before}% â†’ å‡¦ç†å¾Œ: ${results.accuracy_after}%</p>
                            <p class="kicho__improvement-value">
                                æ”¹å–„å€¤: +${results.accuracy_after - results.accuracy_before}%
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    // AIå­¦ç¿’å±¥æ­´è¡¨ç¤º
    async showAILearningHistory() {
        try {
            const response = await NAGANO3.ajax.request('get_ai_learning_history', {
                limit: 20
            });

            if (response.success) {
                this.sessions = response.data.sessions;
                this.displayHistoryModal(response.data.sessions);
            } else {
                throw new Error(response.message);
            }

        } catch (error) {
            console.error('AIå±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            showNotification('AIå±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        }
    }

    // AIåˆ†ææ›´æ–°
    async refreshAIAnalytics() {
        try {
            // ç²¾åº¦æ¨ç§»å–å¾—
            const trendResponse = await NAGANO3.ajax.request('get_ai_accuracy_trend', {
                days: 7
            });

            if (trendResponse.success) {
                this.accuracyTrend = trendResponse.data;
                this.updateAccuracyChart(trendResponse.data);
            }

            // æœ€é©åŒ–ææ¡ˆå–å¾—
            const suggestionsResponse = await NAGANO3.ajax.request('get_ai_optimization_suggestions');
            
            if (suggestionsResponse.success) {
                this.displayOptimizationSuggestions(suggestionsResponse.data);
            }

        } catch (error) {
            console.error('AIåˆ†ææ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        }
    }

    // ç²¾åº¦ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
    updateAccuracyChart(trendData) {
        const timeline = document.getElementById('accuracyTimeline');
        if (!timeline) return;

        const maxAccuracy = Math.max(...trendData.map(item => item.accuracy));
        const minAccuracy = Math.min(...trendData.map(item => item.accuracy));
        const range = maxAccuracy - minAccuracy || 1;

        timeline.innerHTML = trendData.slice(-5).map(item => {
            const height = ((item.accuracy - minAccuracy) / range) * 80 + 20;
            return `
                <div class="kicho__timeline-item">
                    <span class="kicho__timeline-date">${new Date(item.date).getMonth() + 1}/${new Date(item.date).getDate()}</span>
                    <div class="kicho__timeline-bar" style="height: ${height}%;">${item.accuracy}%</div>
                </div>
            `;
        }).join('');

        // ç¾åœ¨ã®ç²¾åº¦æ›´æ–°
        const currentAccuracy = document.getElementById('currentAccuracy');
        if (currentAccuracy && trendData.length > 0) {
            currentAccuracy.textContent = trendData[trendData.length - 1].accuracy + '%';
        }
    }

    // æœ€é©åŒ–ææ¡ˆè¡¨ç¤º
    async showAIOptimizationSuggestions() {
        try {
            const response = await NAGANO3.ajax.request('get_ai_optimization_suggestions');

            if (response.success) {
                this.displayOptimizationModal(response.data);
            } else {
                throw new Error(response.message);
            }

        } catch (error) {
            console.error('æœ€é©åŒ–ææ¡ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            showNotification('æœ€é©åŒ–ææ¡ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        }
    }

    // æœ€é©åŒ–ææ¡ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    displayOptimizationModal(suggestions) {
        const modal = document.createElement('div');
        modal.className = 'kicho__modal';
        modal.innerHTML = `
            <div class="kicho__modal-overlay" onclick="this.closest('.kicho__modal').remove()"></div>
            <div class="kicho__modal-content">
                <div class="kicho__modal-header">
                    <h3>
                        <i class="fas fa-lightbulb"></i>
                        AIæœ€é©åŒ–ææ¡ˆ
                    </h3>
                    <button onclick="this.closest('.kicho__modal').remove()" class="kicho__modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="kicho__modal-body">
                    <div class="kicho__optimization-suggestions">
                        ${suggestions.map(suggestion => `
                            <div class="kicho__suggestion-item kicho__suggestion-item--${suggestion.priority}">
                                <div class="kicho__suggestion-header">
                                    <h4>${suggestion.title}</h4>
                                    <span class="kicho__suggestion-priority">${this.getPriorityText(suggestion.priority)}</span>
                                </div>
                                <p class="kicho__suggestion-description">${suggestion.description}</p>
                                <div class="kicho__suggestion-impact">
                                    æœŸå¾…åŠ¹æœ: ${suggestion.estimated_improvement}
                                </div>
                                <button class="btn btn--primary btn--small" onclick="this.executeOptimization('${suggestion.type}')">
                                    å®Ÿè¡Œ
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
    }

    // ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
    getPriorityText(priority) {
        const priorityMap = {
            'high': 'é«˜å„ªå…ˆåº¦',
            'medium': 'ä¸­å„ªå…ˆåº¦',
            'low': 'ä½å„ªå…ˆåº¦'
        };
        return priorityMap[priority] || priority;
    }

    displayHistoryModal(sessions) {
        // AIå­¦ç¿’å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã®å®Ÿè£…
        console.log('AIå­¦ç¿’å±¥æ­´è¡¨ç¤º:', sessions);
    }
}

// =====================================
// ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ 
// =====================================

class RealtimeLogManager {
    constructor() {
        this.logs = [];
        this.autoScroll = true;
        this.filters = {
            level: 'all',
            source: 'all',
            search: ''
        };
    }

    // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªè¿½åŠ 
    addLogEntry(level, source, message) {
        const entry = {
            timestamp: new Date().toLocaleTimeString(),
            level: level,
            source: source,
            message: message,
            id: Date.now() + Math.random()
        };

        this.logs.unshift(entry);
        
        // ãƒ­ã‚°æ•°åˆ¶é™ï¼ˆæœ€å¤§500ä»¶ï¼‰
        if (this.logs.length > 500) {
            this.logs = this.logs.slice(0, 500);
        }

        this.displayLogEntry(entry);
    }

    // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªè¡¨ç¤º
    displayLogEntry(entry) {
        const logDisplay = document.getElementById('logDisplay');
        if (!logDisplay) return;

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        if (!this.shouldDisplayEntry(entry)) return;

        const logElement = document.createElement('div');
        logElement.className = `kicho__log-entry kicho__log-entry--${entry.level}`;
        logElement.innerHTML = `
            <span class="kicho__log-time">${entry.timestamp}</span>
            <span class="kicho__log-source">${entry.source}</span>
            <span class="kicho__log-message">${entry.message}</span>
        `;

        logDisplay.insertBefore(logElement, logDisplay.firstChild);

        // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        if (this.autoScroll) {
            logDisplay.scrollTop = 0;
        }

        // è¡¨ç¤ºæ•°åˆ¶é™
        const entries = logDisplay.querySelectorAll('.kicho__log-entry');
        if (entries.length > 100) {
            entries[entries.length - 1].remove();
        }
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ãƒã‚§ãƒƒã‚¯
    shouldDisplayEntry(entry) {
        if (this.filters.level !== 'all' && entry.level !== this.filters.level) {
            return false;
        }

        if (this.filters.source !== 'all' && entry.source !== this.filters.source) {
            return false;
        }

        if (this.filters.search && !entry.message.toLowerCase().includes(this.filters.search.toLowerCase())) {
            return false;
        }

        return true;
    }

    // ãƒ­ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
    applyLogFilters() {
        this.filters.level = document.getElementById('logLevelFilter').value;
        this.filters.source = document.getElementById('logSourceFilter').value;
        this.filters.search = document.getElementById('logSearchInput').value;

        this.refreshLogDisplay();
    }

    // ãƒ­ã‚°è¡¨ç¤ºæ›´æ–°
    refreshLogDisplay() {
        const logDisplay = document.getElementById('logDisplay');
        if (!logDisplay) return;

        logDisplay.innerHTML = '';

        this.logs.forEach(entry => {
            if (this.shouldDisplayEntry(entry)) {
                this.displayLogEntry(entry);
            }
        });
    }

    // ãƒ­ã‚°ã‚¯ãƒªã‚¢
    clearLogs() {
        this.logs = [];
        const logDisplay = document.getElementById('logDisplay');
        if (logDisplay) {
            logDisplay.innerHTML = '';
        }
        
        this.addLogEntry('info', 'system', 'ãƒ­ã‚°ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ');
    }

    // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆ
    toggleAutoScroll() {
        this.autoScroll = !this.autoScroll;
        
        const icon = document.getElementById('scrollToggleIcon');
        if (icon) {
            icon.className = this.autoScroll ? 'fas fa-arrows-alt-v' : 'fas fa-pause';
        }

        this.addLogEntry('info', 'system', 
            this.autoScroll ? 'è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ' : 'è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸ'
        );
    }
}

// =====================================
// ğŸš€ çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ 
// =====================================

class EnhancedInitializationManager {
    constructor() {
        this.csvManager = new CSVDuplicatePreventionManager();
        this.mfManager = new MFHistoryManager();
        this.aiManager = new AILearningAnalyticsManager();
        this.logManager = new RealtimeLogManager();
    }

    // æ‹¡å¼µæ©Ÿèƒ½åˆæœŸåŒ–
    async initializeEnhancedFeatures() {
        try {
            console.log('ğŸš€ æ‹¡å¼µæ©Ÿèƒ½åˆæœŸåŒ–é–‹å§‹');

            // ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ç™»éŒ²
            KICHO_ENHANCED.managers = {
                csv: this.csvManager,
                mf: this.mfManager,
                ai: this.aiManager,
                log: this.logManager
            };

            // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await this.loadInitialData();

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            this.setupEventListeners();

            // è‡ªå‹•æ›´æ–°é–‹å§‹
            this.startAutoUpdate();

            // åˆæœŸåŒ–å®Œäº†ãƒ­ã‚°
            this.logManager.addLogEntry('success', 'system', 'æ‹¡å¼µæ©Ÿèƒ½åˆæœŸåŒ–å®Œäº†');

            KICHO_ENHANCED.initialized = true;
            console.log('âœ… æ‹¡å¼µæ©Ÿèƒ½åˆæœŸåŒ–å®Œäº†');

        } catch (error) {
            console.error('âŒ æ‹¡å¼µæ©Ÿèƒ½åˆæœŸåŒ–å¤±æ•—:', error);
            this.logManager.addLogEntry('error', 'system', `åˆæœŸåŒ–å¤±æ•—: ${error.message}`);
        }
    }

    // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async loadInitialData() {
        try {
            // MFã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            await this.mfManager.updateMFStatus();
            this.logManager.addLogEntry('success', 'mf', 'MFæ¥ç¶šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å®Œäº†');

            // AIåˆ†æãƒ‡ãƒ¼ã‚¿æ›´æ–°
            await this.aiManager.refreshAIAnalytics();
            this.logManager.addLogEntry('success', 'ai', 'AIåˆ†æãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†');

        } catch (error) {
            this.logManager.addLogEntry('error', 'system', `åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    setupEventListeners() {
        // CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const csvInput = document.getElementById('csvFileInput');
        if (csvInput) {
            csvInput.addEventListener('change', (e) => {
                this.csvManager.handleSmartCSVUpload(e);
            });
        }

        // ãƒ­ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        ['logLevelFilter', 'logSourceFilter', 'logSearchInput'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', () => {
                    this.logManager.applyLogFilters();
                });
            }
        });
    }

    // è‡ªå‹•æ›´æ–°é–‹å§‹
    startAutoUpdate() {
        if (KICHO_ENHANCED.intervalId) {
            clearInterval(KICHO_ENHANCED.intervalId);
        }

        KICHO_ENHANCED.intervalId = setInterval(async () => {
            try {
                // MFã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                await this.mfManager.updateMFStatus();
                
                // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆæ—¢å­˜æ©Ÿèƒ½ï¼‰
                if (typeof refreshAllData === 'function') {
                    // æ—¢å­˜ã®refreshAllDataé–¢æ•°ãŒã‚ã‚Œã°å®Ÿè¡Œ
                }

                this.logManager.addLogEntry('info', 'system', 'å®šæœŸæ›´æ–°å®Œäº†');

            } catch (error) {
                this.logManager.addLogEntry('error', 'system', `å®šæœŸæ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }, KICHO_ENHANCED.refreshInterval);

        KICHO_ENHANCED.autoRefreshEnabled = true;
        console.log('ğŸ”„ è‡ªå‹•æ›´æ–°é–‹å§‹');
    }
}

// =====================================
// ğŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ é€£æºï¼‰
// =====================================

// CSVé‡è¤‡é˜²æ­¢é–¢é€£
window.handleSmartCSVUpload = function(event) {
    KICHO_ENHANCED.managers.csv.handleSmartCSVUpload(event);
};

window.processCSVUpload = function() {
    KICHO_ENHANCED.managers.csv.processCSVUpload();
};

window.showDuplicateHistory = function() {
    showNotification('é‡è¤‡å‡¦ç†å±¥æ­´æ©Ÿèƒ½ã¯å®Ÿè£…ä¸­ã§ã™', 'info');
};

// MFé€£æºå±¥æ­´é–¢é€£
window.showMFHistory = function() {
    KICHO_ENHANCED.managers.mf.showMFHistory();
};

window.executeMFRecovery = function() {
    KICHO_ENHANCED.managers.mf.executeMFRecovery();
};

// AIå­¦ç¿’é–¢é€£
window.executeAdvancedAILearning = function() {
    KICHO_ENHANCED.managers.ai.executeAdvancedAILearning();
};

window.showAILearningHistory = function() {
    KICHO_ENHANCED.managers.ai.showAILearningHistory();
};

window.showAIOptimizationSuggestions = function() {
    KICHO_ENHANCED.managers.ai.showAIOptimizationSuggestions();
};

window.refreshAIAnalytics = function() {
    KICHO_ENHANCED.managers.ai.refreshAIAnalytics();
};

// ãƒ­ã‚°é–¢é€£
window.toggleLogAutoScroll = function() {
    KICHO_ENHANCED.managers.log.toggleAutoScroll();
};

window.clearProcessingLog = function() {
    KICHO_ENHANCED.managers.log.clearLogs();
};

window.applyLogFilters = function() {
    KICHO_ENHANCED.managers.log.applyLogFilters();
};

// å…¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°
window.refreshAllData = function() {
    if (KICHO_ENHANCED.managers.log) {
        KICHO_ENHANCED.managers.log.addLogEntry('info', 'system', 'æ‰‹å‹•ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–‹å§‹');
    }
    
    // æ—¢å­˜ã®refreshDataé–¢æ•°ãŒã‚ã‚Œã°å®Ÿè¡Œ
    if (typeof refreshData === 'function') {
        refreshData();
    }
    
    // æ‹¡å¼µæ©Ÿèƒ½ãƒ‡ãƒ¼ã‚¿æ›´æ–°
    if (KICHO_ENHANCED.initialized) {
        KICHO_ENHANCED.managers.mf.updateMFStatus();
        KICHO_ENHANCED.managers.ai.refreshAIAnalytics();
    }
};

// è‡ªå‹•æ›´æ–°åˆ‡ã‚Šæ›¿ãˆ
window.toggleAutoRefresh = function() {
    const btn = document.getElementById('autoRefreshBtn');
    
    if (KICHO_ENHANCED.autoRefreshEnabled) {
        clearInterval(KICHO_ENHANCED.intervalId);
        KICHO_ENHANCED.autoRefreshEnabled = false;
        
        if (btn) {
            btn.innerHTML = '<i class="fas fa-play"></i> è‡ªå‹•æ›´æ–°é–‹å§‹';
            btn.className = 'btn btn--success';
        }
        
        if (KICHO_ENHANCED.managers.log) {
            KICHO_ENHANCED.managers.log.addLogEntry('info', 'system', 'è‡ªå‹•æ›´æ–°ã‚’åœæ­¢ã—ã¾ã—ãŸ');
        }
    } else {
        const manager = new EnhancedInitializationManager();
        manager.startAutoUpdate();
        
        if (btn) {
            btn.innerHTML = '<i class="fas fa-pause"></i> è‡ªå‹•æ›´æ–°åœæ­¢';
            btn.className = 'btn btn--warning';
        }
        
        if (KICHO_ENHANCED.managers.log) {
            KICHO_ENHANCED.managers.log.addLogEntry('info', 'system', 'è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
        }
    }
};

// =====================================
// ğŸ åˆæœŸåŒ–å®Ÿè¡Œ
// =====================================

document.addEventListener('DOMContentLoaded', function() {
    // NAGANO3ã‚·ã‚¹ãƒ†ãƒ ã®æº–å‚™å®Œäº†ã‚’å¾…ã¤
    const initializeWhenReady = () => {
        if (window.NAGANO3?.initialized) {
            const manager = new EnhancedInitializationManager();
            manager.initializeEnhancedFeatures();
        } else {
            setTimeout(initializeWhenReady, 100);
        }
    };

    setTimeout(initializeWhenReady, 1000);
});

// ãƒšãƒ¼ã‚¸ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
window.addEventListener('beforeunload', function() {
    if (KICHO_ENHANCED.intervalId) {
        clearInterval(KICHO_ENHANCED.intervalId);
    }
    
    console.log('ğŸ§¹ æ‹¡å¼µæ©Ÿèƒ½ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
});