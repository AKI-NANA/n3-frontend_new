
// CAIDS character_limit Hook
// CAIDS character_limit Hook - Âü∫Êú¨ÂÆüË£Ö
console.log('‚úÖ character_limit Hook loaded');

// CAIDS error_handling Hook

// CAIDS „Ç®„É©„ÉºÂá¶ÁêÜHook - ÂÆåÂÖ®ÂÆüË£Ö
window.CAIDS_ERROR_HANDLER = {
    isActive: true,
    errorCount: 0,
    errorHistory: [],
    
    initialize: function() {
        this.setupGlobalErrorHandler();
        this.setupUnhandledPromiseRejection();
        this.setupNetworkErrorHandler();
        console.log('‚ö†Ô∏è CAIDS „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Ç∑„Çπ„ÉÜ„É†ÂÆåÂÖ®ÂàùÊúüÂåñ');
    },
    
    setupGlobalErrorHandler: function() {
        window.addEventListener('error', (event) => {
            this.handleError({
                type: 'JavaScript Error',
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack
            });
        });
    },
    
    setupUnhandledPromiseRejection: function() {
        window.addEventListener('unhandledrejection', (event) => {
            this.handleError({
                type: 'Unhandled Promise Rejection',
                message: event.reason?.message || String(event.reason),
                stack: event.reason?.stack
            });
        });
    },
    
    setupNetworkErrorHandler: function() {
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                if (!response.ok) {
                    window.CAIDS_ERROR_HANDLER.handleError({
                        type: 'Network Error',
                        message: `HTTP ${response.status}: ${response.statusText}`,
                        url: args[0]
                    });
                }
                return response;
            } catch (error) {
                window.CAIDS_ERROR_HANDLER.handleError({
                    type: 'Network Fetch Error',
                    message: error.message,
                    url: args[0]
                });
                throw error;
            }
        };
    },
    
    handleError: function(errorInfo) {
        this.errorCount++;
        this.errorHistory.push({...errorInfo, timestamp: new Date().toISOString()});
        
        console.error('üö® CAIDS Error Handler:', errorInfo);
        this.showErrorNotification(errorInfo);
        this.reportError(errorInfo);
    },
    
    showErrorNotification: function(errorInfo) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 10px; right: 10px; z-index: 999999;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white; padding: 15px 20px; border-radius: 8px;
            max-width: 350px; box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-size: 13px; font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            border: 2px solid #ff6666; animation: caids-error-shake 0.5s ease-in-out;
        `;
        errorDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">üö®</span>
                <div>
                    <strong>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</strong><br>
                    <small style="opacity: 0.9;">${errorInfo.type}: ${errorInfo.message}</small>
                </div>
            </div>
        `;
        
        // CSS Animation
        if (!document.getElementById('caids-error-styles')) {
            const style = document.createElement('style');
            style.id = 'caids-error-styles';
            style.textContent = `
                @keyframes caids-error-shake {
                    0%, 100% { transform: translateX(0); }
                    25% { transform: translateX(-5px); }
                    75% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 7000);
    },
    
    reportError: function(errorInfo) {
        // „Ç®„É©„Éº„É¨„Éù„Éº„ÉàÁîüÊàê„ÉªÈÄÅ‰ø°ÔºàÂ∞ÜÊù•„ÅÆÊã°ÂºµÁî®Ôºâ
        const report = {
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href,
            errorCount: this.errorCount,
            sessionId: this.getSessionId(),
            ...errorInfo
        };
        
        console.log('üìã CAIDS Error Report:', report);
        localStorage.setItem('caids_last_error', JSON.stringify(report));
    },
    
    getSessionId: function() {
        let sessionId = sessionStorage.getItem('caids_session_id');
        if (!sessionId) {
            sessionId = 'caids_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('caids_session_id', sessionId);
        }
        return sessionId;
    },
    
    getErrorStats: function() {
        return {
            totalErrors: this.errorCount,
            recentErrors: this.errorHistory.slice(-10),
            sessionId: this.getSessionId()
        };
    }
};

window.CAIDS_ERROR_HANDLER.initialize();

/**
 * ÂÖ®„Éö„Éº„Ç∏ÂØæÂøú CSS„É≠„Éº„ÉÄ„Éº„Ç∑„Çπ„ÉÜ„É†
 * common/js/global-css-loader.js
 * 
 * „Å©„ÅÆ„Éö„Éº„Ç∏„Åß„ÇÇËá™ÂãïÁöÑ„Å´„É≠„Éº„Éá„Ç£„É≥„Ç∞CSS„ÇíË™≠„ÅøËæº„Åø
 */

"use strict";

// ÈáçË§áË™≠„ÅøËæº„ÅøÈò≤Ê≠¢
if (!window.NAGANO3_GLOBAL_CSS_LOADED) {
    window.NAGANO3_GLOBAL_CSS_LOADED = true;
    
    console.log('üåê Global CSS Loader ÈñãÂßã');

    /**
     * ÂÖ®„Éö„Éº„Ç∏ÂØæÂøúCSS„É≠„Éº„ÉÄ„Éº„ÇØ„É©„Çπ
     */
    class GlobalCSSLoader {
        constructor() {
            this.requiredCSS = [
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞Èñ¢ÈÄ£CSSÔºàÊúÄÂÑ™ÂÖàÔºâ
                'common/css/core/loading-supplement.css',
                
                // „Åù„ÅÆ‰ªñ„ÅÆÂÖ±ÈÄöCSSÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶ËøΩÂä†Ôºâ
                // 'common/css/core/global-fixes.css',
                // 'common/css/core/responsive.css'
            ];
            
            this.loadedCSS = new Set();
            this.init();
        }
        
        /**
         * ÂàùÊúüÂåñ„ÉªËá™ÂãïË™≠„ÅøËæº„Åø
         */
        init() {
            console.log('üöÄ „Ç∞„É≠„Éº„Éê„É´CSSËá™ÂãïË™≠„ÅøËæº„ÅøÈñãÂßã');
            
            // DOMÊ∫ñÂÇôÂæå„Å´ÂÆüË°å
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => this.loadAllCSS());
            } else {
                this.loadAllCSS();
            }
        }
        
        /**
         * ÂÖ®CSS„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø
         */
        async loadAllCSS() {
            console.log(`üì¶ ${this.requiredCSS.length}ÂÄã„ÅÆCSS„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÈñãÂßã`);
            
            const loadPromises = this.requiredCSS.map(cssFile => this.loadCSS(cssFile));
            
            try {
                const results = await Promise.allSettled(loadPromises);
                
                const successful = results.filter(r => r.status === 'fulfilled').length;
                const failed = results.filter(r => r.status === 'rejected').length;
                
                console.log(`‚úÖ CSSË™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ÊàêÂäü${successful}‰ª∂, Â§±Êïó${failed}‰ª∂`);
                
                // Â§±Êïó„Åó„Åü„Éï„Ç°„Ç§„É´„ÅÆË©≥Á¥∞
                results.forEach((result, index) => {
                    if (result.status === 'rejected') {
                        console.warn(`‚ùå ${this.requiredCSS[index]}: ${result.reason}`);
                    }
                });
                
                // Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü„Ç§„Éô„É≥„Éà
                this.dispatchLoadCompleteEvent();
                
            } catch (error) {
                console.error('‚ùå CSSË™≠„ÅøËæº„ÅøÈáçÂ§ß„Ç®„É©„Éº:', error);
            }
        }
        
        /**
         * ÂÄãÂà•CSSË™≠„ÅøËæº„Åø
         */
        loadCSS(cssFile) {
            return new Promise((resolve, reject) => {
                // Êó¢„Å´Ë™≠„ÅøËæº„ÅøÊ∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (this.loadedCSS.has(cssFile)) {
                    console.log(`‚è≠Ô∏è „Çπ„Ç≠„ÉÉ„ÉóÔºàÊó¢Ë™≠„ÅøËæº„ÅøÔºâ: ${cssFile}`);
                    resolve(cssFile);
                    return;
                }
                
                // Êó¢Â≠ò„ÅÆlinkË¶ÅÁ¥†„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const existingLink = document.querySelector(`link[href="${cssFile}"]`);
                if (existingLink) {
                    console.log(`‚è≠Ô∏è „Çπ„Ç≠„ÉÉ„ÉóÔºàÊó¢Â≠òÂú®Ôºâ: ${cssFile}`);
                    this.loadedCSS.add(cssFile);
                    resolve(cssFile);
                    return;
                }
                
                // Êñ∞„Åó„ÅÑlinkË¶ÅÁ¥†„Çí‰ΩúÊàê
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = cssFile;
                
                // Ë™≠„ÅøËæº„ÅøÊàêÂäüÊôÇ
                link.onload = () => {
                    this.loadedCSS.add(cssFile);
                    console.log(`‚úÖ CSSË™≠„ÅøËæº„ÅøÊàêÂäü: ${cssFile}`);
                    resolve(cssFile);
                };
                
                // Ë™≠„ÅøËæº„ÅøÂ§±ÊïóÊôÇ
                link.onerror = () => {
                    const error = `CSSË™≠„ÅøËæº„ÅøÂ§±Êïó: ${cssFile}`;
                    console.error(`‚ùå ${error}`);
                    reject(new Error(error));
                };
                
                // „Çø„Ç§„É†„Ç¢„Ç¶„ÉàË®≠ÂÆöÔºà10ÁßíÔºâ
                const timeout = setTimeout(() => {
                    const error = `CSSË™≠„ÅøËæº„Åø„Çø„Ç§„É†„Ç¢„Ç¶„Éà: ${cssFile}`;
                    console.error(`‚è∞ ${error}`);
                    reject(new Error(error));
                }, 10000);
                
                link.onload = () => {
                    clearTimeout(timeout);
                    this.loadedCSS.add(cssFile);
                    console.log(`‚úÖ CSSË™≠„ÅøËæº„ÅøÊàêÂäü: ${cssFile}`);
                    resolve(cssFile);
                };
                
                // DOM„Å´ËøΩÂä†
                document.head.appendChild(link);
                console.log(`üì• CSSË™≠„ÅøËæº„ÅøÈñãÂßã: ${cssFile}`);
            });
        }
        
        /**
         * CSSËøΩÂä†ÔºàÂãïÁöÑÔºâ
         */
        addCSS(cssFile) {
            if (!this.requiredCSS.includes(cssFile)) {
                this.requiredCSS.push(cssFile);
            }
            return this.loadCSS(cssFile);
        }
        
        /**
         * Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü„Ç§„Éô„É≥„ÉàÁô∫ÁÅ´
         */
        dispatchLoadCompleteEvent() {
            const event = new CustomEvent('nagano3:css-loaded', {
                detail: {
                    loadedFiles: Array.from(this.loadedCSS),
                    totalFiles: this.requiredCSS.length,
                    timestamp: Date.now()
                }
            });
            
            document.dispatchEvent(event);
            window.dispatchEvent(event);
            
            console.log('üì° CSSË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„Ç§„Éô„É≥„ÉàÁô∫ÁÅ´');
        }
        
        /**
         * Ë™≠„ÅøËæº„ÅøÁä∂Ê≥ÅÁ¢∫Ë™ç
         */
        getStatus() {
            return {
                requiredFiles: this.requiredCSS.length,
                loadedFiles: this.loadedCSS.size,
                loadedList: Array.from(this.loadedCSS),
                missing: this.requiredCSS.filter(file => !this.loadedCSS.has(file))
            };
        }
        
        /**
         * ‰∏çË∂≥CSSË£úÂÆå
         */
        async supplementMissingCSS() {
            const status = this.getStatus();
            
            if (status.missing.length > 0) {
                console.log(`üîÑ ‰∏çË∂≥CSSË£úÂÆå: ${status.missing.length}‰ª∂`);
                
                const loadPromises = status.missing.map(file => this.loadCSS(file));
                await Promise.allSettled(loadPromises);
                
                console.log('‚úÖ CSSË£úÂÆåÂÆå‰∫Ü');
            } else {
                console.log('‚úÖ ÂÖ®CSSË™≠„ÅøËæº„ÅøÊ∏à„Åø');
            }
        }
    }

    // „Ç∞„É≠„Éº„Éê„É´„Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàê
    window.NAGANO3_CSS_LOADER = new GlobalCSSLoader();

    // NAGANO3ÂêçÂâçÁ©∫Èñì„Å∏„ÅÆÁôªÈå≤
    if (window.NAGANO3) {
        if (!window.NAGANO3.system) {
            window.NAGANO3.system = {};
        }
        window.NAGANO3.system.cssLoader = window.NAGANO3_CSS_LOADER;
    }

    // „Éò„É´„Éë„ÉºÈñ¢Êï∞
    window.loadGlobalCSS = function(cssFile) {
        return window.NAGANO3_CSS_LOADER.addCSS(cssFile);
    };

    window.checkCSSStatus = function() {
        return window.NAGANO3_CSS_LOADER.getStatus();
    };

    window.supplementCSS = function() {
        return window.NAGANO3_CSS_LOADER.supplementMissingCSS();
    };

    console.log('‚úÖ Global CSS Loader ÂàùÊúüÂåñÂÆå‰∫Ü');

    // ‰ΩøÁî®‰æã„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Ë°®Á§∫
    console.log(`
üåê Global CSS Loader ‰ΩøÁî®‰æã:
============================

// CSSË™≠„ÅøËæº„ÅøÁä∂Ê≥ÅÁ¢∫Ë™ç
checkCSSStatus();

// ‰∏çË∂≥CSSË£úÂÆå
await supplementCSS();

// Êñ∞„Åó„ÅÑCSSËøΩÂä†
await loadGlobalCSS('common/css/custom.css');

// Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü„Ç§„Éô„É≥„ÉàÁõ£Ë¶ñ
document.addEventListener('nagano3:css-loaded', function(e) {
    console.log('CSSË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', e.detail);
});
    `);
}
