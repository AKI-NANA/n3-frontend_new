# スコア管理システム v2 セットアップガイド

## 📋 概要

スコア管理システム v2は、商品の出品優先順位を自動決定する戦略的スコアリングシステムです。

### 主な改善点
- ✅ **直感的なUI**: ビジネス戦略ベースの設定画面
- ✅ **計算テスト**: 設定変更の効果を保存前に確認
- ✅ **重み主導**: 重み(Wk)がスコアの主導権を持つスケール設計
- ✅ **安全性**: 基本点設定(Sk)は上級者設定として格納

## 🚀 セットアップ手順

### Step 1: データベースセットアップ

1. Supabase ダッシュボードにログイン
   ```
   https://supabase.com/dashboard/project/zdzfpucdyxdlavkgrvil
   ```

2. 左サイドバーの「SQL Editor」をクリック

3. 「New query」ボタンをクリック

4. 以下のSQLファイルの内容をコピー&ペースト:
   ```
   database/migrations/001_score_system_setup.sql
   ```

5. 「Run」ボタンをクリックして実行

6. 成功メッセージを確認:
   ```
   ✅ スコア管理システム v2 のデータベースセットアップ完了
   📊 デフォルト設定: 1件
   🎯 プリセット設定: 2件（利益優先型、低競合優先型）
   ```

### Step 2: アプリケーション起動

```bash
# 開発サーバーを起動
npm run dev

# または
yarn dev
```

### Step 3: システムにアクセス

ブラウザで以下のURLを開く:
```
http://localhost:3000/score-management
```

## 📊 使い方

### 1. スコア設定の調整

「スコア設定」タブで戦略を調整:

#### 🥇 戦略設定エリア（重み調整）
- **利益額の重み**: キャッシュフロー重視なら50点以上に
- **競合の少なさの重み**: 確実に売れる商品重視なら40点以上に
- **希少性の重み**: レア商品・高単価狙いで上げる
- **分析データ鮮度の重み**: 市場変動が激しい場合に上げる
- **実績スコアの重み**: 他セラー実績を参考にする場合に上げる

※ 合計を必ず100点にしてください

#### 🥈 リスク/リターン調整エリア（乗数調整）
- **優遇開始ライン**: 高利益商品のブースト開始金額
- **優遇の強さ**: ブースト倍率（0.2倍で劇的に優遇）
- **ペナルティ開始ライン**: 低利益商品の排除基準
- **排除の厳しさ**: ペナルティ倍率（0.4倍でより厳格に）

### 2. 計算テスト

「計算テスト」タブで設定の効果を確認:

1. テスト用の商品データを入力:
   - 純利益額
   - 競合数
   - 商品状態（新品/中古）
   - 希少性キーワード有無
   - データ鮮度

2. リアルタイムで計算結果を確認:
   - 基本スコア（重み付け合計）
   - 利益乗数（ブースト効果）
   - ペナルティ（減点効果）
   - 最終スコア

3. 推奨コメントで判断:
   - **出品推奨**: スコア1000以上
   - **条件付き推奨**: スコア0-1000
   - **出品非推奨**: スコアマイナス

### 3. 全商品スコア計算

1. ヘッダーの「全商品再計算」ボタンをクリック
2. 計算完了を待つ（商品数により数秒〜数分）
3. 「ランキング」タブで結果を確認

### 4. ランキング確認

「ランキング」タブで:
- スコア順に商品をソート
- 詳細モーダルでスコア内訳を確認
- 出品優先順位を判断

## 🎯 プリセット設定

システムには3つのプリセット設定が含まれています:

### 1. デフォルト（バランス型）
```
利益: 40点
競合: 30点
希少性: 10点
鮮度: 10点
実績: 10点
```
初心者推奨。バランスの取れた設定。

### 2. 利益最優先型（profit_focus）
```
利益: 60点
競合: 20点
希少性: 5点
鮮度: 5点
実績: 10点
```
キャッシュフロー重視の戦略。

### 3. 低競合優先型（low_competition）
```
利益: 30点
競合: 50点
希少性: 5点
鮮度: 5点
実績: 10点
```
確実に売れる商品を選ぶ戦略。

## 🔧 トラブルシューティング

### エラー: 「設定の取得に失敗しました」

**原因**: score_settings テーブルが存在しないか、デフォルトデータが未挿入

**解決方法**:
1. Supabase SQL Editorで以下を実行:
   ```sql
   SELECT * FROM score_settings WHERE name = 'default';
   ```
2. 結果が空の場合、Step 1のSQLを再実行

### エラー: 「Column 'listing_score' does not exist」

**原因**: products_master テーブルにスコアカラムが追加されていない

**解決方法**:
1. Supabase SQL Editorで以下を実行:
   ```sql
   ALTER TABLE products_master ADD COLUMN IF NOT EXISTS listing_score NUMERIC;
   ALTER TABLE products_master ADD COLUMN IF NOT EXISTS score_calculated_at TIMESTAMP;
   ALTER TABLE products_master ADD COLUMN IF NOT EXISTS score_details JSONB;
   ```

### スコアが計算されない

**原因**: 商品データに必須フィールドが不足

**必須フィールド**:
- `price_jpy`: 販売価格
- `acquired_price_jpy`: 仕入価格
- `condition`: 商品状態（'new' または 'used'）

**解決方法**:
1. products_master テーブルでデータを確認
2. 不足フィールドを追加または修正

## 📚 技術詳細

### スコア計算式

```
最終スコア(Ui) = (ΣWk × Sk) × M_Profit × M_Penalty + R
```

- **Wk**: 重み（合計100点）
- **Sk**: 基本点（各カテゴリの評価値）
- **M_Profit**: 利益乗数（1.0〜3.0倍）
- **M_Penalty**: ペナルティ乗数（0.4〜1.0倍）
- **R**: 微細な乱数（重複防止）

### データベーススキーマ

#### score_settings テーブル
```sql
- id (UUID): 主キー
- name (TEXT): 設定名（ユニーク）
- description (TEXT): 説明
- weight_* (NUMERIC): 各カテゴリの重み
- profit_multiplier_* (NUMERIC): 利益乗数設定
- penalty_* (NUMERIC): ペナルティ設定
- score_* (NUMERIC): 基本点設定
- is_active (BOOLEAN): アクティブフラグ
```

#### products_master 追加カラム
```sql
- listing_score (NUMERIC): 計算済みスコア
- score_calculated_at (TIMESTAMP): 計算日時
- score_details (JSONB): スコア詳細内訳
```

## 🎓 ベストプラクティス

1. **段階的な調整**: 最初はデフォルト設定で試し、徐々に調整
2. **計算テスト活用**: 設定変更前に必ずテストで効果を確認
3. **定期的な再計算**: 市場データ更新後は全商品を再計算
4. **実績の蓄積**: ランキング上位商品の販売実績を記録し、設定改善に活用

## 📞 サポート

問題が解決しない場合:
1. Supabaseダッシュボードのログを確認
2. ブラウザの開発者コンソールでエラーメッセージを確認
3. データベースの接続状態を確認

---

**バージョン**: v2.0.0  
**最終更新**: 2025-11-02
