# 完全理解ガイド: HTSコードと関税率の流れ

## 🎯 あなたの疑問（非常に重要！）

### Q1: ツールがSupabaseと連携する？
**A: はい！ツールは完全にSupabaseと連携しています。**

### Q2: どうやってHTSコードがわかるのか？
**A: AIが「選択」→ ツールがSupabaseで「検証」**

### Q3: HTSと原産国はAIが判定する？
**A: はい、でも「候補から選ぶだけ」**

### Q4: 正確なHTSはSupabaseにある？
**A: はい！だからツールが最終確認します**

---

## 📊 完全なフロー（超詳細版）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
フェーズ1: 候補リストの準備（ツール → Supabase）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ツール（Next.js）
    ↓ GET /api/hts-codes
┌─────────────────────────────────────┐
│ Supabaseの hs_codes テーブル        │
├─────────────────────────────────────┤
│ code          | description         │
│ 9006.91.0000  | camera tripods     │
│ 8517.62.0050  | smartphones        │
│ 8471.30.0100  | laptops            │
│ ... 197件                           │
└─────────────────────────────────────┘
    ↓ 200件取得
┌─────────────────────────────────────┐
│ ツールのメモリに保存                 │
│ [                                   │
│   {code: "9006.91.0000", ...},     │
│   {code: "8517.62.0050", ...},     │
│   ... 200件                         │
│ ]                                   │
└─────────────────────────────────────┘


ツール（Next.js）
    ↓ GET /api/hts-countries
┌─────────────────────────────────────┐
│ Supabaseの hts_countries テーブル   │
├─────────────────────────────────────┤
│ country_code  | country_name       │
│ JP            | Japan              │
│ CN            | China              │
│ US            | United States      │
│ ... 47カ国                          │
└─────────────────────────────────────┘
    ↓ 50カ国取得
┌─────────────────────────────────────┐
│ ツールのメモリに保存                 │
│ [                                   │
│   {code: "JP", name: "Japan"},     │
│   {code: "CN", name: "China"},     │
│   ... 50カ国                        │
│ ]                                   │
└─────────────────────────────────────┘

👆 ツールは確実にSupabaseからデータを取得済み


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
フェーズ2: プロンプト生成（ツール内で実行）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ツール
    ↓ プロンプト生成
┌─────────────────────────────────────┐
│ 商品名: Canon EOS カメラ三脚          │
│                                     │
│ HTSコード候補（Supabaseから取得）:   │
│ - 9006.91.0000: camera tripods     │
│ - 8517.62.0050: smartphones        │
│ - 8471.30.0100: laptops            │
│ ... 197件                           │
│                                     │
│ 原産国候補（Supabaseから取得）:      │
│ - JP: Japan                        │
│ - CN: China                        │
│ - US: United States                │
│ ... 47カ国                          │
│                                     │
│ 上記から選んでください               │
└─────────────────────────────────────┘
    ↓ ユーザーがコピー


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
フェーズ3: AI判定（AIは候補から選ぶだけ）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ユーザー → Gemini/Claude Web（プロンプト貼り付け）
    ↓
┌─────────────────────────────────────┐
│ AI の処理:                          │
│                                     │
│ 1. プロンプトを読む                  │
│    商品名 = "Canon EOS カメラ三脚"   │
│                                     │
│ 2. Web検索実行                      │
│    "camera tripod HTS code" で検索  │
│    結果: 9006.91 が適切と判明       │
│                                     │
│ 3. 候補リストを確認                  │
│    9006.91.0000 が候補にある！       │
│    → これを選択                      │
│                                     │
│ 4. Web検索実行                      │
│    "Canon manufacturing country"    │
│    結果: 多くは中国製造              │
│                                     │
│ 5. 候補リストを確認                  │
│    CN (China) が候補にある！         │
│    → これを選択                      │
└─────────────────────────────────────┘
    ↓ JSON出力
┌─────────────────────────────────────┐
│ {                                   │
│   "hts_candidates": [               │
│     {                               │
│       "code": "9006.91.0000",  ←選択│
│       "confidence": 85              │
│     }                               │
│   ],                                │
│   "origin_country": {               │
│     "code": "CN"  ←選択              │
│   }                                 │
│ }                                   │
└─────────────────────────────────────┘

👆 AIは候補から選んだだけ
   HTSコードも原産国もSupabaseの候補から選択
   新しいコードは作っていない


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
フェーズ4: 検証と関税率取得（ツール → Supabase）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ユーザー → ツール（JSON貼り付け）
    ↓
ツール: JSONを解析
    ├─ hts_code = "9006.91.0000"  ←AIが選んだ
    └─ origin_country = "CN"       ←AIが選んだ
    ↓
ツール → Supabase で検証＆関税率取得
    ↓
┌─────────────────────────────────────┐
│ SELECT * FROM customs_duties        │
│ WHERE hts_code = '9006.91.0000'     │
│   AND origin_country = 'CN'         │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ Supabaseの customs_duties テーブル  │
├─────────────────────────────────────┤
│ hts_code      | origin | duty_rate │
│ 9006.91.0000  | CN     | 0.1025    │
│               |        | (10.25%)  │
└─────────────────────────────────────┘
    ↓ 関税率取得成功！
┌─────────────────────────────────────┐
│ ツール: データ保存                   │
│                                     │
│ UPDATE products SET                 │
│   listing_data = {                  │
│     hts_code: "9006.91.0000",      │
│     origin_country: "CN",          │
│     duty_rate: 0.1025  ←取得した！  │
│   }                                 │
└─────────────────────────────────────┘

👆 ツールがSupabaseで正確な関税率を取得
```

---

## 🔑 重要ポイント

### 1. ツールは完全にSupabaseと連携

```javascript
// ツール（Next.js）の処理

// ステップ1: 候補取得
const htsCodes = await supabase
  .from('hs_codes')
  .select('*')
  .limit(200)
// → 200件のHTSコード候補

const countries = await supabase
  .from('hts_countries')
  .select('*')
// → 50カ国の原産国候補


// ステップ2: プロンプト生成
const prompt = `
HTSコード候補:
${htsCodes.map(h => `- ${h.code}: ${h.description}`)}

原産国候補:
${countries.map(c => `- ${c.code}: ${c.name}`)}
`


// ステップ3: AIの選択結果で検証
const aiResult = JSON.parse(userInput)

const { data } = await supabase
  .from('customs_duties')
  .select('*')
  .eq('hts_code', aiResult.hts_candidates[0].code)  // AIが選んだ
  .eq('origin_country', aiResult.origin_country.code)  // AIが選んだ
  .single()

// data.duty_rate が正確な関税率！
```

### 2. AIは候補から選ぶだけ

```
AIの処理:
1. プロンプトの候補リストを見る
2. Web検索で「どれが適切か」調べる
3. 候補の中から選ぶ
4. JSON出力

AIは新しいHTSコードを作らない！
AIは候補にないコードを選ばない！
```

### 3. 関税率はSupabaseから取得

```
customs_duties テーブル:
┌───────────────┬────────┬────────────┐
│ hts_code      │ origin │ duty_rate  │
├───────────────┼────────┼────────────┤
│ 9006.91.0000  │ CN     │ 0.1025     │
│ 9006.91.0000  │ JP     │ 0.0275     │
│ 8517.62.0050  │ CN     │ 0.0750     │
│ ...           │ ...    │ ...        │
└───────────────┴────────┴────────────┘

検索:
WHERE hts_code = 'AIが選んだコード'
  AND origin_country = 'AIが選んだ国'

結果:
duty_rate が取得できる
```

---

## 💡 なぜこの2段階方式なのか？

### 理由1: AIは判定が得意、データベースは苦手

```
AI:
✅ 「カメラ三脚」→「9006.91.0000が適切」と判定できる
❌ Supabaseのcustoms_dutiesテーブルを検索できない

ツール:
❌ 「カメラ三脚」→「どのHTSコード？」判定できない
✅ Supabaseのcustoms_dutiesテーブルを検索できる
```

### 理由2: 組み合わせで完璧

```
ステップ1: ツールが候補を用意
  ├─ HTSコード200件（Supabaseから）
  └─ 原産国50カ国（Supabaseから）

ステップ2: AIが最適なものを選択
  ├─ HTSコード: 9006.91.0000
  └─ 原産国: CN

ステップ3: ツールが関税率を取得
  └─ SELECT * FROM customs_duties
      WHERE hts = '9006.91.0000' AND country = 'CN'
      → duty_rate: 0.1025
```

---

## 🎯 具体例で完全理解

### 商品: Canon EOS カメラ三脚

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ステップ1: ツールがSupabaseから候補取得
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

hs_codes テーブル:
┌───────────────┬─────────────────────────┐
│ code          │ description             │
├───────────────┼─────────────────────────┤
│ 9006.91.0000  │ camera tripods         │  ← この候補あり
│ 8517.62.0050  │ smartphones            │
│ 8471.30.0100  │ laptops                │
│ ... 197件      │                        │
└───────────────┴─────────────────────────┘

hts_countries テーブル:
┌──────┬─────────────┐
│ code │ name        │
├──────┼─────────────┤
│ JP   │ Japan       │
│ CN   │ China       │  ← この候補あり
│ US   │ USA         │
│ ... 47カ国         │
└──────┴─────────────┘

→ これをプロンプトに含める


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ステップ2: AIが候補から選択
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

AI: "カメラ三脚" を分析
  → Web検索: "camera tripod HTS code"
  → 9006.91 が適切と判明
  → 候補リストを確認
  → 9006.91.0000 がある！
  → これを選択

AI: "Canon" を分析
  → Web検索: "Canon manufacturing"
  → 中国製が多いと判明
  → 候補リストを確認
  → CN (China) がある！
  → これを選択

出力:
{
  "hts_candidates": [{"code": "9006.91.0000"}],
  "origin_country": {"code": "CN"}
}


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ステップ3: ツールがSupabaseで関税率取得
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ツール: AIの選択結果を受信
  hts_code = "9006.91.0000"
  origin_country = "CN"

ツール → Supabase検索:
  SELECT * FROM customs_duties
  WHERE hts_code = '9006.91.0000'
    AND origin_country = 'CN'

customs_duties テーブル:
┌───────────────┬────────┬───────────┐
│ hts_code      │ origin │ duty_rate │
├───────────────┼────────┼───────────┤
│ 9006.91.0000  │ CN     │ 0.1025    │  ← ヒット！
└───────────────┴────────┴───────────┘

結果: duty_rate = 0.1025 (10.25%)

ツール → products テーブルに保存:
  UPDATE products SET
    listing_data = {
      hts_code: "9006.91.0000",
      origin_country: "CN",
      duty_rate: 0.1025  ← 正確な関税率！
    }
```

---

## 📊 データの所在まとめ

### Supabaseに保存されているデータ

```
1. hs_codes テーブル
   ├─ HTSコード候補 200件
   └─ 各コードの説明

2. hts_countries テーブル
   ├─ 原産国マスター 50カ国
   └─ 国名

3. customs_duties テーブル
   ├─ HTSコード × 原産国の組み合わせ
   └─ 正確な関税率データ
```

### AIが持っているデータ

```
なし！

AIは：
- Supabaseに接続できない
- データベースを読めない
- プロンプトのテキストだけが見える
```

### プロンプトに含まれるデータ

```
1. 商品情報（ツールから）
2. HTSコード候補 200件（Supabaseから取得してプロンプトに埋め込み）
3. 原産国候補 50カ国（Supabaseから取得してプロンプトに埋め込み）
```

---

## 🎉 結論

### Q: ツールがSupabaseと連携する？
**A: はい！完全に連携しています**
- 候補リスト取得
- 関税率検索
- データ保存

### Q: どうやってHTSコードがわかる？
**A: 2段階です**
1. AIが候補から選択（9006.91.0000）
2. ツールがSupabaseで検証＆関税率取得

### Q: 正確なHTSはSupabaseにある？
**A: はい！だから最終的にツールが確認します**
- AIの選択 → ツールの検証 → 正確なデータ

### データの流れ

```
Supabase → ツール → プロンプト → AI → 選択
                                    ↓
Supabase ← ツール ← 検証 ← 選択結果
   ↓
正確な関税率
```

**コスト: ¥0**
**精度: Supabase検証により保証**
