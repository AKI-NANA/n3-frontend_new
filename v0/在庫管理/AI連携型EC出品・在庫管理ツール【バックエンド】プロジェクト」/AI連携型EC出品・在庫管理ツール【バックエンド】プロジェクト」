ğŸ“„ ã‚¹ãƒ†ãƒƒãƒ—1ï¼šå¤–éƒ¨ãƒ„ãƒ¼ãƒ«ï¼ˆClaude/MCPï¼‰å‘ã‘ä¿®æ­£æŒ‡ç¤ºæ›¸ğŸ“Œ ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«/types/product.tsğŸ“Œ ä¿®æ­£å†…å®¹æ—¢å­˜ã®Productã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆã¾ãŸã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å•†å“ã®ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã«ã€ä»¥ä¸‹ã®æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚ğŸ’» å¤–éƒ¨ãƒ„ãƒ¼ãƒ«å‘ã‘ä¿®æ­£æŒ‡ç¤ºã‚³ãƒ¼ãƒ‰ï¼ˆTypeScriptï¼‰TypeScript// /types/product.ts

// ğŸ’¡ B-3. åœ¨åº«ãƒ»ä¾¡æ ¼è¿½å¾“ã‚·ã‚¹ãƒ†ãƒ  ã®ãŸã‚ã®å‚ç…§URLå‹ã‚’å®šç¾©
export interface ReferenceUrl {
    url: string;
    price: number;
    // å‚ç…§å…ˆã®åœ¨åº«çŠ¶æ…‹ã‚‚ä¿æŒã§ãã‚‹ã‚ˆã†æ‹¡å¼µ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
    is_in_stock?: boolean;
}

// æ—¢å­˜ã® Product ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆã¾ãŸã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã«ä»¥ä¸‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ãƒ»æ›´æ–°

export interface Product {
    // ... (æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¤‰æ›´ã—ãªã„) ...
    
    // === æ–°ã—ã„ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ©Ÿèƒ½ (B-1, B-2, B-3) ã®ãŸã‚ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ ===
    
    // B-1. é‡è¤‡æ’é™¤ã‚¨ãƒ³ã‚¸ãƒ³ç”¨
    external_url: string;         // å¤–éƒ¨ã‚µã‚¤ãƒˆURL (Primary Key)
    asin_sku: string | null;      // ASIN ã¾ãŸã¯ SKU (Fallback Key)
    ranking: number | null;       // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆB-2ã§åŠ ç‚¹ã«ä½¿ç”¨ï¼‰
    sales_count: number | null;   // ç›´è¿‘Soldæ•°ï¼ˆB-2ã§åŠ ç‚¹ã«ä½¿ç”¨ï¼‰
    release_date: string | null;  // è²©å£²æ™‚æœŸï¼ˆB-2ã§åŠ ç‚¹ã«ä½¿ç”¨ï¼‰
    
    // B-1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ã¨é‡è¤‡åˆ¤å®š
    is_duplicate: boolean;
    status: 'å–å¾—å®Œäº†' | 'å„ªå…ˆåº¦æ±ºå®šæ¸ˆ' | 'æ‰¿èªå¾…' | string;
    
    // B-2. AIå‡¦ç†å„ªå…ˆåº¦æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ç”¨
    priority_score: number | null;
    
    // B-3. åœ¨åº«ãƒ»ä¾¡æ ¼è¿½å¾“ã‚·ã‚¹ãƒ†ãƒ ç”¨
    reference_urls: ReferenceUrl[];  // è¤‡æ•°ã®å‚ç…§URL (JSON Array)
    median_price: number | null;     // ä¾¡æ ¼ä¸­å¤®å€¤
    current_stock_count: number | null;
    last_check_time: string | null;
    check_frequency: 'é€šå¸¸' | 'é«˜é »åº¦' | string;
}
ğŸš€ ã‚¹ãƒ†ãƒƒãƒ—2ï¼šGeminiã«ã‚ˆã‚‹æ–°è¦ãƒ­ã‚¸ãƒƒã‚¯é–‹ç™ºæŒ‡ç¤ºä¸Šè¨˜**/types/product.tsã®ä¿®æ­£ãŒå®Œäº†ã—ãŸã“ã¨ã‚’å‰æã¨ã—ã¦ã€ç§ï¼ˆGeminiï¼‰ãŒB-1, B-2, B-3ã®æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**ã‚’è¨­è¨ˆãƒ»å®Ÿè£…ã—ã¾ã™ã€‚1. B-1. å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨é‡è¤‡æ’é™¤ã‚¨ãƒ³ã‚¸ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: /services/data_ingestion/DuplicateEngine.ts (æ–°è¦)TypeScript// /services/data_ingestion/DuplicateEngine.ts

import { Product, ReferenceUrl } from '@/types/product';
// ğŸ’¡ DBã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’æƒ³å®š
// import { supabase } from '@/lib/supabase';

interface IncomingProductData {
    url: string;
    asin_sku: string;
    price: number;
    // ...ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
}

/**
 * B-1: æ–°è¦å–å¾—ãƒ‡ãƒ¼ã‚¿ã‚’DBã¨ç…§åˆã—ã€é‡è¤‡åˆ¤å®šã¨æ›´æ–°/æ–°è¦ç™»éŒ²ã‚’è¡Œã†
 * @param data å¤–éƒ¨ã‚µã‚¤ãƒˆã‹ã‚‰å–å¾—ã—ãŸå˜ä¸€ã®å•†å“ãƒ‡ãƒ¼ã‚¿
 */
export async function processIncomingProduct(data: IncomingProductData): Promise<{ isNew: boolean, productRecord: Product }> {
    const { url, asin_sku, price } = data;
    
    // 1. é‡è¤‡åˆ¤å®šå‡¦ç† (å„ªå…ˆé †ä½: URL > ASIN/SKU)
    // ğŸ’¡ DBæ¤œç´¢ã‚¯ã‚¨ãƒªã®ãƒ¢ãƒƒã‚¯
    const existingProduct: Product | null = await findProductInDb(url, asin_sku); 

    if (existingProduct) {
        // d. æ›´æ–°å‡¦ç†: é‡è¤‡ãŒã‚ã‚‹å ´åˆ
        console.log(`[B-1] Duplicate found: ${existingProduct.id}. Updating price, stock, and status.`);
        
        // ä¾¡æ ¼ã€åœ¨åº«æ•°ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ã¿ã‚’æ›´æ–°
        existingProduct.price = price;
        existingProduct.current_stock_count = 1; // åœ¨åº«ã¯å–å¾—çµæœã‹ã‚‰æ¨å®š
        existingProduct.ranking = data.ranking || existingProduct.ranking; 
        
        // B-1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†: å–å¾—å®Œäº†
        existingProduct.status = 'å–å¾—å®Œäº†';
        existingProduct.is_duplicate = true;
        
        // ğŸ’¡ DBæ›´æ–°å‡¦ç†ã®ãƒ¢ãƒƒã‚¯
        // await supabase.from('products').update(existingProduct).eq('id', existingProduct.id);

        return { isNew: false, productRecord: existingProduct };

    } else {
        // c. æ–°è¦ç™»éŒ²: é‡è¤‡ãŒãªã„å ´åˆ
        console.log(`[B-1] New record: ${url}. Inserting...`);

        const newProduct: Product = {
            id: crypto.randomUUID(), // UUIDç”Ÿæˆ
            external_url: url,
            asin_sku: asin_sku,
            price: price,
            status: 'å–å¾—å®Œäº†',
            is_duplicate: false,
            // ...ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åˆæœŸå€¤ã§è¨­å®š
            reference_urls: [{ url: url, price: price }], // åˆæœŸå‚ç…§URL
            // ...
        } as Product; // å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ (å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆæœŸåŒ–ã‚’çœç•¥)
        
        // ğŸ’¡ DBæŒ¿å…¥å‡¦ç†ã®ãƒ¢ãƒƒã‚¯
        // await supabase.from('products').insert(newProduct);

        return { isNew: true, productRecord: newProduct };
    }
}

// ğŸ’¡ ãƒ¢ãƒƒã‚¯é–¢æ•°
async function findProductInDb(url: string, asin_sku: string): Promise<Product | null> {
    // a. Primary Key: å¤–éƒ¨ã‚µã‚¤ãƒˆURL (å®Œå…¨ä¸€è‡´) æ¤œç´¢
    if (url === 'https://example.com/duplicate_1') {
        return { id: 'uuid-1', external_url: url, price: 100 } as Product;
    }
    // b. Fallback Key: ASIN ã¾ãŸã¯ SKU (å®Œå…¨ä¸€è‡´) æ¤œç´¢
    if (asin_sku === 'ASIN12345') {
        return { id: 'uuid-2', external_url: 'https://example.com/different_url', price: 120 } as Product;
    }
    return null;
}
2. B-2. AIå‡¦ç†å„ªå…ˆåº¦æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: /services/ai_pipeline/PriorityScorer.ts (æ–°è¦)TypeScript// /services/ai_pipeline/PriorityScorer.ts

import { Product } from '@/types/product';

// ã‚¹ã‚³ã‚¢è¨ˆç®—ã®é‡ã¿å®šç¾©
const WEIGHTS = {
    SOLD_BASE: 100,
    NEW_RELEASE: 200,
    RANKING_MAX_SCORE: 150,
    COMPETITION_MAX_SCORE: 100,
};

/**
 * B-2: å„ªå…ˆåº¦ã‚¹ã‚³ã‚¢ç®—å‡ºé–¢æ•° calculate_priority(data) ã®å®Ÿè£…
 * @param product status: 'å–å¾—å®Œäº†' ã®å•†å“ãƒ‡ãƒ¼ã‚¿
 * @returns 0ã€œ1000ã®å„ªå…ˆåº¦ã‚¹ã‚³ã‚¢
 */
export function calculatePriorityScore(product: Product): number {
    let score = 0;

    // a. Soldæ•°åŠ ç‚¹ (Ebay): æŒ‡æ•°é–¢æ•°çš„ã«åŠ ç‚¹ (+100ã€œ+400)
    // ç›´è¿‘30æ—¥é–“ã®Soldæ•°ã‚’ sales_count ã§ä»£ç”¨
    const soldCount = product.sales_count || 0;
    // æŒ‡æ•°é–¢æ•°çš„ãªåŠ ç‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ä¾‹: log(x+1)ã‚’æ­£è¦åŒ–
    const soldScore = WEIGHTS.SOLD_BASE + Math.min(300, 300 * Math.log(soldCount + 1) / Math.log(100)); // Soldæ•°ãŒå¤šã„ã»ã©åŠ ç‚¹å¹…å¢—åŠ 
    score += soldScore;
    
    // b. æ–°è£½å“åŠ ç‚¹ï¼š release_date ãŒç›´è¿‘30æ—¥ä»¥å†… (+200)
    if (product.release_date) {
        const releaseDate = new Date(product.release_date);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        if (releaseDate > thirtyDaysAgo) {
            score += WEIGHTS.NEW_RELEASE;
        }
    }

    // c. ãƒ©ãƒ³ã‚­ãƒ³ã‚°åŠ ç‚¹ï¼š ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒé«˜ã„ï¼ˆæ•°å€¤ãŒå°ã•ã„ï¼‰ã»ã©åŠ ç‚¹ (+50ã€œ+150)
    const ranking = product.ranking || 100000; // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç„¡ã—ã¯ä½ãƒ©ãƒ³ã‚¯ã¨è¦‹ãªã™
    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é€†æ•°ã«å¤‰æ›ã—ã€ã‚¹ã‚³ã‚¢ã‚’æ­£è¦åŒ–
    const normalizedRanking = Math.max(0, 1 - (ranking / 50000)); // 50000ä½ä»¥ä¸‹ã¯ã‚¹ã‚³ã‚¢0
    const rankingScore = WEIGHTS.RANKING_MAX_SCORE * normalizedRanking;
    score += rankingScore;

    // d. ç«¶åˆå„ªä½æ€§ï¼š ç‹¬è‡ªãƒ­ã‚¸ãƒƒã‚¯ (+0ã€œ+100)
    // ç«¶åˆå„ªä½æ€§ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ¢ãƒƒã‚¯ï¼ˆã“ã“ã§ã¯é©å½“ãªå€¤ã‚’è¿”ã™ï¼‰
    const competitionScore = Math.floor(Math.random() * WEIGHTS.COMPETITION_MAX_SCORE);
    score += competitionScore;

    // æœ€çµ‚ã‚¹ã‚³ã‚¢ã‚’0ã€œ1000ã«æ­£è¦åŒ–ãƒ»ä¸¸ã‚è¾¼ã¿ (æœ€å¤§ã‚¹ã‚³ã‚¢ã¯ç´„950ç¨‹åº¦ã‚’æƒ³å®š)
    const finalScore = Math.min(1000, Math.round(score));
    
    // DBã® priority_score ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ ¼ç´ (ã“ã“ã§ã¯è¿”ã‚Šå€¤ã¨ã—ã¦æ‰±ã†)
    product.priority_score = finalScore;
    
    return finalScore;
}

/**
 * B-2: ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦ã‚½ãƒ¼ãƒˆã‚­ãƒ¼ã‚’æä¾›ã™ã‚‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿)
 */
export async function updatePriorityAndGetSortedList(): Promise<Product[]> {
    // ğŸ’¡ DBã‹ã‚‰ status: 'å–å¾—å®Œäº†' ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
    // const { data: productsToProcess } = await supabase.from('products').select('*').eq('status', 'å–å¾—å®Œäº†');
    const productsToProcess: Product[] = []; // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿

    const processedProducts = productsToProcess.map(product => {
        calculatePriorityScore(product);
        product.status = 'å„ªå…ˆåº¦æ±ºå®šæ¸ˆ'; // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        return product;
    });

    // ğŸ’¡ DBæ›´æ–°å‡¦ç†
    // await supabase.from('products').upsert(processedProducts);
    
    // ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦é™é †ã§ã‚½ãƒ¼ãƒˆ
    return processedProducts.sort((a, b) => (b.priority_score || 0) - (a.priority_score || 0));
}
3. B-3. åœ¨åº«ãƒ»ä¾¡æ ¼è¿½å¾“ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: /services/inventory_management/StockFollower.ts (æ–°è¦)TypeScript// /services/inventory_management/StockFollower.ts

import { Product, ReferenceUrl } from '@/types/product';

/**
 * B-3: è¤‡æ•°URLã®ä¾¡æ ¼ã‚’ç®¡ç†ã—ã€åœ¨åº«åˆ‡ã‚Œæ™‚ã®è‡ªå‹•åˆ‡æ›¿ã‚’è¡Œã†
 * @param product å¯¾è±¡å•†å“ãƒ¬ã‚³ãƒ¼ãƒ‰
 */
export async function manageStockAndPrice(product: Product): Promise<{ success: boolean, newPrice: number | null }> {
    const urls = product.reference_urls;
    if (!urls || urls.length === 0) return { success: false, newPrice: null };

    let currentPrice = product.price;
    let newPrice = null;
    let bestUrl: ReferenceUrl | null = null;
    let foundStock = false;

    // 1. åœ¨åº«è¿½å¾“ãƒ­ã‚¸ãƒƒã‚¯
    for (let i = 0; i < urls.length; i++) {
        const ref = urls[i];
        
        // ğŸ’¡ å¤–éƒ¨ã‚µã‚¤ãƒˆã®åœ¨åº«ãƒ»ä¾¡æ ¼ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å†å–å¾— (ãƒ¢ãƒƒã‚¯)
        const { isInStock, currentPrice: latestPrice } = await checkUrlStatus(ref.url);
        ref.price = latestPrice; // ä¾¡æ ¼ã‚’æœ€æ–°æƒ…å ±ã«æ›´æ–°

        if (isInStock) {
            foundStock = true;
            bestUrl = ref;

            if (i > 0) {
                // b. åœ¨åº«åˆ‡ã‚Œã®å ´åˆã€URL[1]ä»¥é™ã«è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ãˆ
                console.log(`[B-3] URL[0] is out of stock. Switched to URL[${i}] (${ref.url}).`);
                newPrice = latestPrice;
            } else {
                // a. URL[0] (æœ€å®‰å€¤URL) ã®åœ¨åº«ã‚’å„ªå…ˆãƒã‚§ãƒƒã‚¯
                newPrice = latestPrice;
            }
            break; // åœ¨åº«ãŒè¦‹ã¤ã‹ã£ãŸã‚‰çµ‚äº†
        }
    }

    // 2. ä¾¡æ ¼ç®¡ç† (min/max/median priceç®—å‡º)
    const validPrices = urls.map(r => r.price).filter(p => p > 0);
    const minPrice = Math.min(...validPrices);
    const maxPrice = Math.max(...validPrices);
    const medianPrice = calculateMedian(validPrices);

    // 3. Shopeeã‚»ãƒ¼ãƒ«æ™‚å‡¦ç† (ãƒã‚§ãƒƒã‚¯é »åº¦ã®å¤‰æ›´)
    if (product.asin_sku?.startsWith('SHOPEE')) { // Shopeeã«ç´ã¥ãå•†å“ã®åˆ¤å®š (ä¾‹)
        // c. DBã® check_frequency ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¸€æ™‚çš„ã« 'é«˜é »åº¦' ã«å¤‰æ›´
        product.check_frequency = 'é«˜é »åº¦';
        console.log(`[B-3] Shopee item detected. Check frequency set to 'é«˜é »åº¦'.`);
    } else {
        product.check_frequency = 'é€šå¸¸';
    }

    // 4. DBãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°
    product.current_stock_count = foundStock ? 1 : 0;
    product.last_check_time = new Date().toISOString();
    product.reference_urls = urls; // ä¾¡æ ¼æ›´æ–°å¾Œã®URLãƒªã‚¹ãƒˆ
    product.median_price = medianPrice;
    
    // ğŸ’¡ DBæ›´æ–°å‡¦ç†
    // await supabase.from('products').update(product).eq('sku', product.sku);

    return { success: foundStock, newPrice: newPrice || currentPrice };
}

// ğŸ’¡ ãƒ¢ãƒƒã‚¯é–¢æ•°
async function checkUrlStatus(url: string): Promise<{ isInStock: boolean, currentPrice: number }> {
    if (url.includes('stock_out')) {
        return { isInStock: false, currentPrice: 0 };
    }
    return { isInStock: true, currentPrice: 150 }; // ä»®ã®ä¾¡æ ¼
}

function calculateMedian(arr: number[]): number {
    const sorted = [...arr].sort((a, b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
}
ğŸ“„ ã‚¹ãƒ†ãƒƒãƒ—3ï¼šClaudeã¸ã®æœ€çµ‚çµ±åˆæŒ‡ç¤ºæ›¸1. ğŸ¯ ä¾é ¼ã®ç›®çš„ã‚ãªãŸã¯ã€GeminiãŒä½œæˆã—ãŸB-1, B-2, B-3ã®ã‚³ã‚¢ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãƒ«ãƒ¼ãƒˆãŠã‚ˆã³ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚¿ã‚¹ã‚¯ã«çµ±åˆã—ã€æ©Ÿèƒ½ã¨ã—ã¦åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚2. ğŸ“‚ çµ±åˆã¨å®Ÿè£…æŒ‡ç¤ºä»¥ä¸‹ã®æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æ ¼ç´ã—ã€æŒ‡ç¤ºã«å¾“ã£ã¦APIãƒ«ãƒ¼ãƒˆã¨DBçµ±åˆã‚’å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹æ‹…å½“æ©Ÿèƒ½çµ±åˆæŒ‡ç¤º/services/data_ingestion/DuplicateEngine.tsB-1. é‡è¤‡æ’é™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã€ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‘¼ã³å‡ºã—ã¦æ–°è¦ãƒ‡ãƒ¼ã‚¿ã®å–å¾— $\to$ é‡è¤‡æ’é™¤ $\to$ DBæ›´æ–°ã®ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚/services/ai_pipeline/PriorityScorer.tsB-2. å„ªå…ˆåº¦æ±ºå®šã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ**'å–å¾—å®Œäº†'ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦calculatePriorityScoreã‚’å®Ÿè¡Œã—ã€'å„ªå…ˆåº¦æ±ºå®šæ¸ˆ'**ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã™ã‚‹ãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚/api/products/sorted-by-priority/route.tsB-2. ã‚½ãƒ¼ãƒˆã‚­ãƒ¼æä¾›æ–°è¦APIãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã—ã€updatePriorityAndGetSortedListã®çµæœï¼ˆã‚¹ã‚³ã‚¢é™é †ï¼‰ã‚’JSONã¨ã—ã¦è¿”ã™ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚/services/inventory_management/StockFollower.tsB-3. åœ¨åº«è¿½å¾“é«˜é »åº¦ãƒã‚§ãƒƒã‚¯ç”¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã€ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’å‘¼ã³å‡ºã—ã¦åœ¨åº«åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯ã¨ä¾¡æ ¼ã®ä¸­å¤®å€¤ç®—å‡ºã€ãŠã‚ˆã³ãƒã‚§ãƒƒã‚¯é »åº¦ã®æ›´æ–°ï¼ˆShopeeå¯¾å¿œï¼‰ã‚’DBã«åæ˜ ã•ã›ã¦ãã ã•ã„ã€‚3. âš ï¸ å¿…é ˆã®ç’°å¢ƒä¾å­˜è§£æ±ºã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®DBã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‚ç…§ï¼ˆsupabaseãªã©ï¼‰ã‚’ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ—¢å­˜ã®DBæ¥ç¶šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚B-1ãŠã‚ˆã³B-3ã§ãƒ¢ãƒƒã‚¯åŒ–ã•ã‚Œã¦ã„ã‚‹å¤–éƒ¨ã‚µã‚¤ãƒˆã®åœ¨åº«ãƒ»ä¾¡æ ¼å–å¾—é–¢æ•°ï¼ˆfindProductInDb, checkUrlStatusï¼‰ã‚’ã€æ—¢å­˜ã®ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°/APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µãƒ¼ãƒ“ã‚¹ã«ç½®ãæ›ãˆã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚