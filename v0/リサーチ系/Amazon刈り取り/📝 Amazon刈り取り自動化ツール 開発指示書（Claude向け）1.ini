📝 Amazon刈り取り自動化ツール 開発指示書（Claude向け）1. プロジェクト概要と目標項目詳細ツール名刈り取り自動化ツール (AmazonArbitrageTool)目標**「選定→購入（自動）→承認→出品（自動）」のフルオートメーションを実現し、競合に先駆けた高回転率の仕入れ・販売（日次10〜30個）を行う。最重要要件Keepa波形分析とAIリスク判定に基づきarbitrage_scoreを算出し、このスコアをトリガーとして夜間でも即時自動決済**を実行する。アクセスパス/tools/amazon-arbitrage (新規作成)関連ファイル/types/product.ts, /lib/research/scorer.ts (新規), /app/api/arbitrage/... (新規API群)2. データベースと型定義の拡張（/types/product.ts）既存の/types/product.tsを拡張し、刈り取り戦略に必要な全ての追跡・分析用カラムを追加します。✅ Productインターフェースへの追加フィールドTypeScript// /types/product.ts への追加フィールド

// AIによるリスク分析の結果型
export interface AiAssessment {
  potential: 'high' | 'low'; // 刈り取りポテンシャル
  reason: string;            // ポテンシャルの根拠
  risk: 'high' | 'low';      // リスク判定（需要減退/偽物など）
  risk_reason: string;       // リスクの根拠
}

export interface Product extends BaseProduct { // BaseProductは既存の型を指す
  // --- スコアリングと分析 ---
  arbitrage_score: number | null; // 刈り取り販売スコア (最終値。自動決済のトリガー)
  keepa_data: Record<string, any> | null; // Keepa履歴データ
  market_text_data: string | null; // 市場調査で収集したテキストデータ
  ai_arbitrage_assessment: AiAssessment | null; // AIによるリスク/ポテンシャル判定
  is_discontinued_category: boolean; // 廃盤で価値上昇しやすいカテゴリーか否か

  // --- 刈り取り管理と自動化 ---
  is_arbitrage_target: boolean; // 刈り取り対象として仕入れが確定したか
  arbitrage_status: 'in_research' | 'tracked' | 'purchased' | 'awaiting_inspection' | 'ready_to_list' | 'listed'; // ステータス追跡
  amazon_order_id: string | null; // Amazonの注文ID
  purchase_account_id: string | null; // 使用した購入アカウントID (リスク分散用)
  
  // --- 利益最適化 ---
  profit_ebay_usd: number | null;
  profit_amazon_jpy: number | null;
  profit_domestic_jpy: number | null;
}
3. コアロジック：スコアリングとリスク回避（/lib/research/scorer.ts）Keepaの波形（P-1, P-3）とAIのリスク判定を統合し、arbitrage_scoreを算出するロジックを実装します。✅ calculateArbitrageScore 関数の実装パターン/リスクロジックスコアへの影響P-1: シャープな下落（現在の価格） < （過去90日間の平均価格の70%） AND 価格変動が急激。+40点（自動決済の最優先トリガー）P-2: 廃盤希少性is_discontinued_categoryがTRUE AND 出品者数が減少傾向。+20点P-3: 緩やかな値崩れKeepaトレンドラインが継続的な下落を示している。-50点（自動決済対象から除外）AIリスク判定ai_arbitrage_assessment.riskが"high"（需要減退、偽物リスクなど）の場合。強制的にスコアを0点に設定し、自動決済をブロック。✅ AI分析の組み込みスコアリングロジック内で、AI分析結果（ai_arbitrage_assessment）を参照し、リスク検出時の強制的なスコア0点化を最優先で実行する。4. システムフローとAPI定義（オートメーション）4.1. 選定・トラッキング・自動決済ステップ機能詳細な自動化内容API/ファイル自動選定スコアリング完了後arbitrage_scoreが閾値以上の商品を自動でトラッキング(arbitrage_status = tracked)に設定。/lib/research/scorer.tsKeepa設定自動トラッキング後システムがKeepa APIを利用し、価格が設定値を下回った場合の通知設定を自動で投入（手動設定の手間を排除）。バックエンドロジック通知受信Keepa WebhookKeepaからの通知をトリガーとして受信する。/app/api/arbitrage/webhook/keepa/route.ts自動決済Webhook受信時決済実行時、購入アカウントIDに紐づく**異なるIPアドレス（プロキシ）を使用し、Amazonへの自動操作で注文を確定させる。/app/api/arbitrage/execute-payment/route.tsデータ取得決済完了後注文IDと追跡情報**、最終仕入れ価格を即座にAmazon注文履歴から取得し、DBを更新（arbitrage_status = awaiting_inspection）。/app/api/arbitrage/confirm-purchase/route.ts4.2. 承認と即時販売（高回転率）ステップ機能詳細な自動化内容API/ファイル検品待ちUIUI表示/tools/amazon-arbitrageにarbitrage_statusがawaiting_inspectionの商品リストを表示。/app/tools/amazon-arbitrage/page.tsx承認人為介入（唯一）スタッフが偽物・破損がないことを確認し「承認」ボタンを押す。/app/tools/amazon-arbitrage/page.tsx即時出品承認ボタン押下承認ボタン押下をトリガーに、多販路出品パイプラインが自動で起動する。arbitrage_statusをready_to_list→listedへ更新。/app/api/arbitrage/approve-listing/[id]/route.ts販売ロジック出品パイプライン有在庫として多販路に即時出品。回転率を最優先し、最低利益額（¥4,000）を維持する積極的な自動価格調整を行う。/app/api/listing/execute/route.ts (改修)5. UIの実装（/app/tools/amazon-arbitrage/page.tsx）✅ コンポーネントの構造検品待ちリスト: arbitrage_status === 'awaiting_inspection'の商品を表示。最も目立つ位置に配置。操作: **「✅ 検品完了 & 承認 (即時出品)」**ボタン（/api/arbitrage/approve-listing/[id]を叩く）。商品到着待ちリスト: arbitrage_status === 'purchased'の商品を表示。自動決済候補リスト: arbitrage_status === 'tracked'の商品を表示。スコア（例: 90点）と共に表示し、自動決済待機中であることを明示。✅ CSS スタイル/components/ProductModal/FullFeaturedModal.module.cssの既存クラスを流用し、統一感のあるセクションデザインとする。CSS/* 例: セクションの囲みとヘッダーを使用 */
.dataSection, .sectionHeader
6. リスク管理と安全対策（最優先事項）リスク要因システムによる技術的・運用的な対策アカウント停止（赤盤）自動決済実行時に、IPアドレス、購入アカウント、決済手段の分散を強制的に適用するロジックを実装。損失（赤字）**Keepa波形分析（P-3）とAIリスク判定（需要減退/偽物）**により、自動決済の対象から低スコア商品を完全に除外する。素早い現金化の遅延検品承認後の出品パイプライン起動を0秒で実行し、システム的な遅延を排除する。支払い方法現在は個人カードだが、将来の法人化・Amazon Business請求書払いへの移行を念頭に、アカウント分散ロジックを設計する。