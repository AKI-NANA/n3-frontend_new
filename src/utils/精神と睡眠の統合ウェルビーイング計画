import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, collection, query, onSnapshot, addDoc, deleteDoc, updateDoc } from 'firebase/firestore';
import { Lightbulb, BookOpen, Clock, Zap, Sun, Moon, CheckCircle, Trash2, Calendar, Menu, Activity, Brain } from 'lucide-react'; // ã‚¢ã‚¤ã‚³ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åˆ©ç”¨

// --- ç’°å¢ƒå¤‰æ•°ã¨Firebaseã®åˆæœŸåŒ– ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'health-pro-v4-default';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let db, auth;
if (Object.keys(firebaseConfig).length) {
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  auth = getAuth(app);
}

// --- å®šæ•°ã¨ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ ---
// çŒ®ç«‹ãƒ»é‹å‹•é–¢é€£ã®å®šæ•°ã¯å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰å¼•ãç¶™ã
const DAILY_GOALS = { protein: 120, iron: 10, calcium: 600, sodium: 1500, sugar: 50 }; 
const NUTRIENT_UNITS = { protein: 'g', iron: 'mg', calcium: 'mg', sodium: 'mg', sugar: 'g' };
const DUMMY_RECIPES = [
  { id: 'r1', name: 'é«˜ã‚¿ãƒ³ãƒ‘ã‚¯é¶ã‚€ã­è‚‰ã‚°ãƒªãƒ« (å›½ç”£)', nutrients: { protein: 45, iron: 2, calcium: 50, sodium: 300, sugar: 5 }, advParams: { hasAdditives: 'ãªã—', foodPairing: 'ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼' } },
  { id: 'r3', name: 'è¼¸å…¥ãƒ•ãƒ«ãƒ¼ãƒ„ã®ç ‚ç³–æ¼¬ã‘ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ', nutrients: { protein: 15, iron: 0.5, calcium: 250, sodium: 50, sugar: 65 }, advParams: { hasAdditives: 'ç€è‰²æ–™', foodPairing: 'ãªã—' } },
  { id: 'r4', name: 'æœ‰æ©Ÿé‡èœã¨ãƒ„ãƒŠã®ã‚µãƒ©ãƒ€', nutrients: { protein: 20, iron: 1, calcium: 30, sodium: 200, sugar: 5 }, advParams: { hasAdditives: 'ãªã—', foodPairing: 'ç©€ç‰©' } },
];
const EXERCISE_TYPES = [
  { id: 'e1', name: 'ğŸ§˜ ãƒ¨ã‚¬ (30åˆ†)', target: 'æŸ”è»Ÿæ€§ãƒ»ãƒªãƒ©ãƒƒã‚¯ã‚¹', calories: 150 },
  { id: 'e2', name: 'ğŸš¶ æ•£æ­© (40åˆ†/æœ‰é…¸ç´ )', target: 'æœ‰é…¸ç´ é‹å‹•ãƒ»ç¿’æ…£', calories: 200 },
  { id: 'e3', name: 'ğŸƒ HIIT (30åˆ†/é«˜è² è·)', target: 'è„‚è‚ªç‡ƒç„¼', calories: 400 },
  { id: 'e4', name: 'ğŸ’ª ç­‹ãƒˆãƒ¬ (å…¨èº«)', target: 'ç­‹åŠ›UPãƒ»åŸºç¤ä»£è¬', calories: 300 },
];
const DUMMY_USER_STATS = { bodyFat: 28, targetBodyFat: 20, stressLevel: 75 }; // ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ«ã‚’è¿½åŠ  (0-100)

// --- æ–°ã—ã„å®šæ•°: ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ã‚¿ã‚¹ã‚¯ ---
const WELLBEING_TYPES = [
    { id: 'w1', name: 'ğŸ§  ã‚¯ãƒ³ãƒ«ãƒ³ (20åˆ†)', type: 'mental', icon: <Brain className="w-4 h-4" />, target: 'æ„è­˜æ´»æ€§åŒ–' },
    { id: 'w2', name: 'ğŸ§˜ ç‘æƒ³/å†…è¦³ (15åˆ†)', type: 'mental', icon: <Lightbulb className="w-4 h-4" />, target: 'ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›' },
    { id: 'w3', name: 'ğŸ“ æ—¥è¨˜/å¤¢æ—¥è¨˜', type: 'mental', icon: <BookOpen className="w-4 h-4" />, target: 'è‡ªå·±èªè­˜' },
    { id: 'w4', name: 'ğŸ’Š noosã‚µãƒ—ãƒªæ‘‚å–', type: 'sleep', icon: <Zap className="w-4 h-4" />, target: 'ç¡çœ ã®è³ª' },
    { id: 'w5', name: 'â° è‡ªç„¶å…‰ã‚¿ã‚¤ãƒãƒ¼èµ·åºŠ', type: 'sleep', icon: <Sun className="w-4 h-4" />, target: 'ä½“å†…æ™‚è¨ˆãƒªã‚»ãƒƒãƒˆ' },
    { id: 'w6', name: 'ğŸ˜´ ã‚¢ãƒ©ãƒ¼ãƒˆãªã—ã§èµ·åºŠ', type: 'sleep', icon: <Moon className="w-4 h-4" />, target: 'ç¡çœ åŠ¹ç‡' },
    { id: 'w7', name: 'ğŸ§˜â€â™‚ï¸ ãƒãƒ™ãƒƒãƒˆå¼å¥åº·æ³• (10åˆ†)', type: 'mental', icon: <Activity className="w-4 h-4" />, target: 'ã‚¨ãƒãƒ«ã‚®ãƒ¼èª¿å’Œ' },
];

const HEALTH_RISKS = [
  { name: 'é«˜è¡€åœ§ãƒªã‚¹ã‚¯', targetNutrient: 'sodium', prevention: 'æ¸›å¡©ã€æœ‰é…¸ç´ é‹å‹•', medical: 'è¡€åœ§ãƒ»ãƒŠãƒˆãƒªã‚¦ãƒ å€¤æ¤œæŸ»' },
  { name: 'é«˜è¡€ç³–ãƒªã‚¹ã‚¯', targetNutrient: 'sugar', prevention: 'é£Ÿå¾Œ15åˆ†æ­©è¡Œã€ã‚¯ãƒ­ãƒ æ‘‚å–', medical: 'HbA1cã€è¡€ç³–å€¤æ¤œæŸ»' },
  { name: 'æ…¢æ€§ã‚¹ãƒˆãƒ¬ã‚¹', targetNutrient: 'N/A', prevention: 'ç‘æƒ³ã€ã‚¯ãƒ³ãƒ«ãƒ³ã€ç¡çœ åŠ¹ç‡å‘ä¸Š', medical: 'ã‚³ãƒ«ãƒã‚¾ãƒ¼ãƒ«å€¤æ¤œæŸ»' },
];


// --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
const formatDate = (date) => date.toISOString().split('T')[0];
const getWeekStart = (date) => {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
    return new Date(d.setDate(diff));
};
const getDaysInMonth = (date) => {
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1);
    const startDay = getWeekStart(firstDay); 
    const days = [];
    let current = new Date(startDay);
    for (let i = 0; i < 42; i++) {
        days.push(new Date(current));
        current.setDate(current.getDate() + 1);
    }
    return days;
};
const getDaysInWeek = (date) => {
    const startOfWeek = getWeekStart(date);
    return Array.from({ length: 7 }).map((_, i) => {
        const d = new Date(startOfWeek);
        d.setDate(d.getDate() + i);
        return d;
    });
};

// ä½“è„‚è‚ªç‡ã«åŸºã¥ã„ãŸé‹å‹•ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
const getRecommendedExercise = (date) => {
  const day = date.getDay();
  const bodyFat = DUMMY_USER_STATS.bodyFat;

  if (bodyFat >= 25) {
    if (day % 3 === 1) return { recipeId: 'e3', time: 'æœ', description: 'ä½“è„‚è‚ªç‡ƒç„¼ã®ãŸã‚ã€HIITã‚’å„ªå…ˆ' }; 
    if (day % 3 === 2) return { recipeId: 'e4', time: 'å¤œ', description: 'åŸºç¤ä»£è¬ã‚¢ãƒƒãƒ—ã®ãŸã‚ã€ç­‹ãƒˆãƒ¬ã‚’å„ªå…ˆ' }; 
    return { recipeId: 'e2', time: 'å¤•', description: 'è»½ã„æœ‰é…¸ç´ é‹å‹•ã§ç¶™ç¶šæ€§ã‚’é‡è¦–' }; 
  } else {
    if (day % 2 === 0) return { recipeId: 'e1', time: 'æœ', description: 'æŸ”è»Ÿæ€§ã¨ãƒªãƒ©ãƒƒã‚¯ã‚¹ã‚’é‡è¦–' };
    return { recipeId: 'e4', time: 'å¤œ', description: 'ã‚·ã‚§ã‚¤ãƒ—ã‚¢ãƒƒãƒ—ã®ãŸã‚ç­‹ãƒˆãƒ¬' };
  }
};

// ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ«ã«åŸºã¥ã„ãŸã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
const getRecommendedWellbeing = (stressLevel) => {
    if (stressLevel >= 70) {
        // é«˜ã‚¹ãƒˆãƒ¬ã‚¹æ™‚: ç‘æƒ³ã¨ç¡çœ åŠ¹ç‡ã‚’é‡è¦–
        return [
            { id: 'w2', description: 'é«˜ã‚¹ãƒˆãƒ¬ã‚¹ã®ãŸã‚ã€ç‘æƒ³ã§å¿ƒã‚’é®ã‚ã¾ã™' },
            { id: 'w4', description: 'è³ªã®é«˜ã„ç¡çœ ã®ãŸã‚ã€ã‚µãƒ—ãƒªæ‘‚å–' }
        ];
    } else if (stressLevel >= 50) {
        // ä¸­ã‚¹ãƒˆãƒ¬ã‚¹æ™‚: æ•´ç†ã¨ãƒªã‚»ãƒƒãƒˆã‚’é‡è¦–
        return [
            { id: 'w3', description: 'æ—¥è¨˜ã§æ€è€ƒã‚’æ•´ç†ã—ã¾ã™' },
            { id: 'w7', description: 'ãƒãƒ™ãƒƒãƒˆå¼å¥åº·æ³•ã§ã‚¨ãƒãƒ«ã‚®ãƒ¼èª¿å’Œ' }
        ];
    } else {
        // ä½ã‚¹ãƒˆãƒ¬ã‚¹æ™‚: æ´»æ€§åŒ–ã¨å‘ä¸Šã‚’é‡è¦–
        return [
            { id: 'w1', description: 'æ„è­˜æ´»æ€§åŒ–ã®ãŸã‚ã‚¯ãƒ³ãƒ«ãƒ³' },
            { id: 'w5', description: 'ä½“å†…æ™‚è¨ˆãƒªã‚»ãƒƒãƒˆã®ãŸã‚è‡ªç„¶å…‰èµ·åºŠ' }
        ];
    }
};


// --- UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« ---
const CustomAlert = ({ message, onClose }) => (
  <div className="fixed top-0 left-0 right-0 z-50 p-4">
    <div className="max-w-md mx-auto bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl shadow-lg flex justify-between items-center">
      <p className="font-bold">ğŸš¨ è­¦å‘Š: çŒ®ç«‹ã«æ³¨æ„ãŒå¿…è¦ã§ã™</p>
      <p className="text-sm ml-4">{message}</p>
      <button onClick={onClose} className="ml-4 text-red-500 hover:text-red-800 font-bold">
        &times;
      </button>
    </div>
  </div>
);

// --- UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: äºˆé˜²å¯¾ç­–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (åˆ¥ã‚¿ãƒ–) ---
const PreventionView = () => (
    <div className="p-8 bg-white rounded-xl shadow-inner min-h-[70vh]">
        <h2 className="text-3xl font-bold text-indigo-700 mb-6 border-b pb-3">
            äºˆé˜²å¯¾ç­–çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ 
        </h2>
        <p className="text-gray-600 mb-8">
            ã‚ãªãŸã®å¥åº·ãƒªã‚¹ã‚¯ã«åŸºã¥ãã€æ „é¤Šã€é‹å‹•ã€åŒ»ç™‚ã®å´é¢ã‹ã‚‰çµ±åˆçš„ãªäºˆé˜²ç­–ã‚’ææ¡ˆã—ã¾ã™ã€‚ç¾åœ¨ã®ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ«ã¯ **{DUMMY_USER_STATS.stressLevel}%** ã§ã™ã€‚
        </p>

        <div className="space-y-8">
            {HEALTH_RISKS.map((risk, index) => (
                <div key={index} className="p-5 border border-red-300 bg-red-50 rounded-lg shadow-md hover:shadow-xl transition duration-300">
                    <h3 className="text-xl font-bold text-red-700 mb-3 flex items-center">
                        <span className="text-2xl mr-2">ğŸ¯</span> {risk.name}
                    </h3>
                    
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-3 text-sm">
                        <div className="bg-yellow-100 p-3 rounded-md">
                            <p className="font-semibold text-gray-800 border-b pb-1 mb-1">æ „é¤Š</p>
                            <p className="text-gray-600">åˆ¶é™/å¼·åŒ–æ „é¤Šç´ : **{risk.targetNutrient}**</p>
                        </div>
                        <div className="bg-blue-100 p-3 rounded-md">
                            <p className="font-semibold text-gray-800 border-b pb-1 mb-1">é‹å‹•</p>
                            <p className="text-gray-600">å¯¾ç­–: **{risk.prevention.split(', ')[1] || 'N/A'}**</p>
                        </div>
                        <div className="bg-purple-100 p-3 rounded-md">
                            <p className="font-semibold text-gray-800 border-b pb-1 mb-1">ç²¾ç¥ãƒ»ç¡çœ </p>
                            <p className="text-gray-600">å¯¾ç­–: **{risk.prevention.split(', ').slice(2).join(', ') || 'N/A'}**</p>
                        </div>
                        <div className="bg-green-100 p-3 rounded-md">
                            <p className="font-semibold text-gray-800 border-b pb-1 mb-1">åŒ»ç™‚</p>
                            <p className="text-gray-600">æ¨å¥¨å¥åº·è¨ºæ–­: **{risk.medical}**</p>
                        </div>
                    </div>
                </div>
            ))}
        </div>
    </div>
);


// --- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
const App = () => {
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [userId, setUserId] = useState(null);
  const [menuPlans, setMenuPlans] = useState([]); 
  const [exercisePlans, setExercisePlans] = useState([]); 
  const [wellbeingPlans, setWellbeingPlans] = useState([]); // æ–°ã—ã„ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿
  const [currentDate, setCurrentDate] = useState(new Date());
  const [calendarView, setCalendarView] = useState('month');
  const [currentPage, setCurrentPage] = useState('calendar'); // 'calendar', 'exercise', 'wellbeing', 'prevention'
  const [showAlert, setShowAlert] = useState(null); 

  // --- Firebaseèªè¨¼ã¨åˆæœŸåŒ– ---
  useEffect(() => {
    if (!auth || !db) { setIsAuthReady(true); return; }
    
    const initializeAuth = async () => {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Firebase Auth Error:", error);
        }
    };
    initializeAuth();

    const unsubscribe = onAuthStateChanged(auth, (user) => {
      if (user) {
        setUserId(user.uid);
      } else {
        setUserId(crypto.randomUUID()); 
      }
      setIsAuthReady(true);
    });
    return () => unsubscribe();
  }, []);

  // --- Firestoreãƒ‡ãƒ¼ã‚¿è³¼èª­ (å…±é€šãƒ•ãƒƒã‚¯ã§3ç¨®é¡ã‚’è³¼èª­) ---
  const useFirestoreCollection = (collectionName, setState) => {
    useEffect(() => {
      if (!db || !userId) return;
  
      const itemRef = collection(db, 'artifacts', appId, 'users', userId, collectionName);
      const unsub = onSnapshot(itemRef, (snapshot) => {
        const plans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setState(plans);
      }, (error) => console.error(`${collectionName} Snapshot Error:`, error));
  
      return () => unsub();
    }, [userId]);
  };
  
  useFirestoreCollection('menu_plans', setMenuPlans);
  useFirestoreCollection('exercise_plans', setExercisePlans);
  useFirestoreCollection('wellbeing_plans', setWellbeingPlans);


  // --- ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ ---

  // ç¦æ­¢äº‹é …ãƒã‚§ãƒƒã‚¯
  const checkProhibitions = useCallback((recipe) => {
    let warning = null;
    // (çœç•¥: çŒ®ç«‹ã«é–¢ã™ã‚‹ç¦æ­¢äº‹é …ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯)
    return warning;
  }, []);

  // çŒ®ç«‹ã®è¿½åŠ 
  const handleAddMeal = useCallback(async (dateStr, recipeId) => {
    if (!userId || !db) return;
    const recipe = DUMMY_RECIPES.find(r => r.id === recipeId);
    if (!recipe) return;
    
    const warning = checkProhibitions(recipe);
    if (warning) { setShowAlert(warning); }

    const newMeal = { date: dateStr, recipeName: recipe.name, nutrients: recipe.nutrients, advParams: recipe.advParams, isCompleted: false, timestamp: Date.now() };
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'menu_plans'), newMeal);
    } catch (e) { console.error('çŒ®ç«‹è¿½åŠ ã‚¨ãƒ©ãƒ¼:', e); }
  }, [userId, checkProhibitions]);

  // é‹å‹•ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¿½åŠ 
  const handleAddExercise = useCallback(async (dateStr, exerciseId, isRecommended = false) => {
    if (!userId || !db) return;
    const exercise = EXERCISE_TYPES.find(e => e.id === exerciseId);
    if (!exercise) return;

    const newExercise = { date: dateStr, exerciseName: exercise.name, target: exercise.target, isCompleted: false, isRecommended: isRecommended, timestamp: Date.now() };
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'exercise_plans'), newExercise);
    } catch (e) { console.error('é‹å‹•è¿½åŠ ã‚¨ãƒ©ãƒ¼:', e); }
  }, [userId]);
  
  // ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ã‚¿ã‚¹ã‚¯ã®è¿½åŠ 
  const handleAddWellbeing = useCallback(async (dateStr, wellbeingId, isRecommended = false) => {
    if (!userId || !db) return;
    const task = WELLBEING_TYPES.find(t => t.id === wellbeingId);
    if (!task) return;

    const newTask = { date: dateStr, taskName: task.name, type: task.type, target: task.target, isCompleted: false, isRecommended: isRecommended, timestamp: Date.now() };
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'wellbeing_plans'), newTask);
    } catch (e) { console.error('ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ã‚¿ã‚¹ã‚¯è¿½åŠ ã‚¨ãƒ©ãƒ¼:', e); }
  }, [userId]);

  // å®Ÿç¸¾ã®ãƒˆã‚°ãƒ« (å…±é€š)
  const handleToggleCompletion = useCallback(async (itemId, collectionType) => {
    if (!userId || !db) return;
    
    let currentPlan, collectionName;
    if (collectionType === 'menu') {
        currentPlan = menuPlans.find(m => m.id === itemId);
        collectionName = 'menu_plans';
    } else if (collectionType === 'exercise') {
        currentPlan = exercisePlans.find(e => e.id === itemId);
        collectionName = 'exercise_plans';
    } else if (collectionType === 'wellbeing') {
        currentPlan = wellbeingPlans.find(w => w.id === itemId);
        collectionName = 'wellbeing_plans';
    } else {
        return;
    }
    
    if (!currentPlan) return;
    
    const itemRef = doc(db, 'artifacts', appId, 'users', userId, collectionName, itemId);
    try {
      await updateDoc(itemRef, { isCompleted: !currentPlan.isCompleted });
    } catch (e) { console.error('å®Ÿç¸¾æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e); }
  }, [userId, menuPlans, exercisePlans, wellbeingPlans]);
  
  // ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ (å…±é€š)
  const handleDeleteItem = useCallback(async (itemId, collectionType) => {
    if (!userId || !db) return;
    const collectionName = collectionType === 'menu' ? 'menu_plans' : 
                           collectionType === 'exercise' ? 'exercise_plans' : 'wellbeing_plans';
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, collectionName, itemId));
    } catch (e) { console.error('ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e); }
  }, [userId]);


  // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…±é€šãƒ­ã‚¸ãƒƒã‚¯ ---

  // æœŸé–“ã®å¤‰æ›´
  const changePeriod = (amount) => {
    const newDate = new Date(currentDate);
    if (calendarView === 'month') {
      newDate.setMonth(newDate.getMonth() + amount);
    } else {
      newDate.setDate(newDate.getDate() + (amount * 7));
    }
    setCurrentDate(newDate);
  };

  // é”æˆåº¦ã®ãƒãƒƒã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (å…±é€š)
  const GoalBadge = ({ date, plans, collectionType }) => {
    const dateStr = formatDate(date);
    const dayItems = plans.filter(p => p.date === dateStr);
    const completed = dayItems.filter(p => p.isCompleted).length;
    const total = dayItems.length;
    
    if (formatDate(date) === formatDate(new Date())) return null; 
    if (total === 0) return null;
    
    let color, label;
    if (collectionType === 'menu') {
        color = 'bg-green-100 text-green-700';
        label = 'çŒ®ç«‹';
    } else if (collectionType === 'exercise') {
        color = 'bg-blue-100 text-blue-700';
        label = 'é‹å‹•';
    } else if (collectionType === 'wellbeing') {
        color = 'bg-purple-100 text-purple-700';
        label = 'ç²¾ç¥/ç¡çœ ';
    } else {
        return null;
    }

    if (completed === total) {
      return <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${color}`}>ğŸ† å®Œäº†</span>;
    }
    
    if (completed > 0 && completed < total) {
        return <span className={`text-xs font-bold px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700`}>{completed}/{total} é€²è¡Œä¸­</span>;
    }

    return null;
  };

  // --- UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: å…±é€šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ§‹é€  ---
  const BaseCalendar = ({ data, onAddItem, ItemComponent, Recommender, title, collectionType, syncMock}) => {
    const calendarDays = calendarView === 'month' ? getDaysInMonth(currentDate) : getDaysInWeek(currentDate);

    return (
        <div className="p-6">
            <div className="flex justify-between items-center mb-6 border-b pb-3">
                <h2 className="text-2xl font-bold text-gray-800 flex items-center">{title}</h2>
                
                <div className="flex space-x-3 items-center">
                    <button 
                        className="bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 transition shadow-md text-sm"
                        onClick={() => console.log(syncMock)}
                    >
                        <Calendar className="w-4 h-4 inline mr-1"/> Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨åŒæœŸ
                    </button>
                    <button 
                        onClick={() => setCalendarView(calendarView === 'month' ? 'week' : 'month')}
                        className="p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium text-sm"
                    >
                        {calendarView === 'month' ? 'é€±è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ' : 'æœˆè¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ'}
                    </button>
                    <div className="flex space-x-1">
                        <button onClick={() => changePeriod(-1)} className="p-2 bg-indigo-100 text-indigo-700 rounded-full hover:bg-indigo-200 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                        </button>
                        <button onClick={() => changePeriod(1)} className="p-2 bg-indigo-100 text-indigo-700 rounded-full hover:bg-indigo-200 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clipRule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            </div>
            
            {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“ */}
            <div className={`grid ${calendarView === 'month' ? 'grid-cols-7' : 'grid-cols-7'}`}>
              {['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'].map(day => (
                <div key={day} className="text-center font-semibold text-sm py-2 text-gray-600 bg-gray-100 border-b">{day}</div>
              ))}
              
              {calendarDays.map((date, index) => {
                const dateStr = formatDate(date);
                const isToday = dateStr === formatDate(new Date());
                const isCurrentMonth = calendarView === 'month' ? date.getMonth() === currentDate.getMonth() : true;
                const dayItems = data.filter(item => item.date === dateStr);

                return (
                  <div 
                    key={index} 
                    className={`
                      p-2 border border-gray-200 overflow-y-auto transition relative
                      ${calendarView === 'month' ? 'min-h-[140px]' : 'min-h-[280px]'}
                      ${isCurrentMonth ? 'bg-white' : 'bg-gray-50 text-gray-400'}
                      ${isToday ? 'border-2 border-indigo-500 bg-indigo-50 shadow-inner' : ''}
                    `}
                  >
                    <div className="flex justify-between items-start mb-1">
                        <span className={`text-lg font-bold ${isToday ? 'text-indigo-700' : 'text-gray-800'}`}>
                            {date.getDate()}
                        </span>
                        
                        <div className="flex flex-col items-end space-y-1">
                            <GoalBadge date={date} plans={data} collectionType={collectionType} />
                            {Recommender && <Recommender date={date} onAdd={onAddItem} dayItems={dayItems}/>}
                        </div>
                    </div>

                    {/* ã‚¢ã‚¤ãƒ†ãƒ ã®è¡¨ç¤º */}
                    <div className="space-y-1">
                      {dayItems.map(item => (
                        <ItemComponent 
                            key={item.id} 
                            item={item} 
                            onToggle={() => handleToggleCompletion(item.id, collectionType)} 
                            onDelete={() => handleDeleteItem(item.id, collectionType)}
                        />
                      ))}
                    </div>

                    {/* ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ ãƒœã‚¿ãƒ³ (ç°¡ç•¥ç‰ˆ) */}
                    <div className="mt-2 absolute bottom-2 left-2 right-2">
                      <select 
                          onChange={(e) => onAddItem(dateStr, e.target.value)}
                          className={`text-xs p-1 border-none bg-indigo-100 rounded w-full cursor-pointer text-indigo-700 font-medium ${isCurrentMonth ? '' : 'opacity-50'}`}
                          value=""
                          disabled={!isCurrentMonth}
                      >
                          <option value="" disabled>+ {collectionType === 'menu' ? 'çŒ®ç«‹' : collectionType === 'exercise' ? 'é‹å‹•' : 'ã‚¿ã‚¹ã‚¯'}ã‚’è¿½åŠ ...</option>
                          {(collectionType === 'menu' ? DUMMY_RECIPES : collectionType === 'exercise' ? EXERCISE_TYPES : WELLBEING_TYPES).map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                      </select>
                    </div>
                  </div>
                );
              })}
            </div>
      </div>
    );
  };

  // --- é£Ÿäº‹é–¢é€£ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (Meal) ---
  const MealItem = ({ item, onToggle, onDelete }) => (
    <div className="bg-gray-100 p-2 rounded-lg shadow-sm border border-gray-200">
        <div className="flex justify-between items-start">
            <p className="text-sm font-semibold text-gray-800 leading-tight">{item.recipeName}</p>
            <button onClick={onDelete} className="text-red-400 hover:text-red-600 p-0.5 rounded-full transition" title="å‰Šé™¤">
                <Trash2 className="h-4 w-4"/>
            </button>
        </div>
        <div className="flex justify-between items-center mt-1">
            <label className="flex items-center cursor-pointer">
                <input type="checkbox" checked={item.isCompleted} onChange={onToggle} className="h-4 w-4 text-green-600 form-checkbox rounded border-gray-300 focus:ring-green-500"/>
                <span className={`ml-2 text-xs ${item.isCompleted ? 'line-through text-gray-400' : 'text-gray-700'}`}>æ‘‚å–å®Œäº†</span>
            </label>
        </div>
    </div>
  );

  // --- é‹å‹•é–¢é€£ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (Exercise) ---
  const ExerciseItem = ({ item, onToggle, onDelete }) => (
    <div className={`p-2 rounded-lg shadow-sm border ${item.isRecommended ? 'bg-yellow-100 border-yellow-300' : 'bg-blue-100 border-blue-300'}`}>
        <div className="flex justify-between items-start">
            <p className="text-sm font-semibold text-gray-800 leading-tight">
                {item.exerciseName}
                {item.isRecommended && <span className="text-xs bg-yellow-400 text-gray-800 px-1 ml-1 rounded-full font-bold">æ¨å¥¨</span>}
            </p>
            <button onClick={onDelete} className="text-red-400 hover:text-red-600 p-0.5 rounded-full transition" title="å‰Šé™¤">
                <Trash2 className="h-4 w-4"/>
            </button>
        </div>
        <div className="flex justify-between items-center mt-1">
            <label className="flex items-center cursor-pointer">
                <input type="checkbox" checked={item.isCompleted} onChange={onToggle} className="h-4 w-4 text-teal-600 form-checkbox rounded border-gray-300 focus:ring-teal-500"/>
                <span className={`ml-2 text-xs ${item.isCompleted ? 'line-through text-gray-400' : 'text-gray-700'}`}>å®Ÿè¡Œå®Œäº†</span>
            </label>
            <span className="text-xs text-gray-600 font-medium">{item.target}</span>
        </div>
    </div>
  );

  // --- ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°é–¢é€£ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (Wellbeing) ---
  const WellbeingItem = ({ item, onToggle, onDelete }) => {
    const taskDetails = WELLBEING_TYPES.find(t => t.name === item.taskName);
    const bgColor = item.type === 'mental' ? 'bg-purple-100 border-purple-300' : 'bg-pink-100 border-pink-300';
    
    return (
        <div className={`p-2 rounded-lg shadow-sm border ${bgColor}`}>
            <div className="flex justify-between items-start">
                <p className="text-sm font-semibold text-gray-800 leading-tight flex items-center">
                    {taskDetails?.icon}
                    <span className="ml-1">{item.taskName}</span>
                    {item.isRecommended && <span className="text-xs bg-yellow-400 text-gray-800 px-1 ml-1 rounded-full font-bold">æ¨å¥¨</span>}
                </p>
                <button onClick={onDelete} className="text-red-400 hover:text-red-600 p-0.5 rounded-full transition" title="å‰Šé™¤">
                    <Trash2 className="h-4 w-4"/>
                </button>
            </div>
            <div className="flex justify-between items-center mt-1">
                <label className="flex items-center cursor-pointer">
                    <input type="checkbox" checked={item.isCompleted} onChange={onToggle} className="h-4 w-4 text-purple-600 form-checkbox rounded border-gray-300 focus:ring-purple-500"/>
                    <span className={`ml-2 text-xs ${item.isCompleted ? 'line-through text-gray-400' : 'text-gray-700'}`}>å®Œäº†</span>
                </label>
                <span className={`text-xs font-medium px-2 py-0.5 rounded-full ${item.type === 'mental' ? 'bg-purple-200' : 'bg-pink-200'}`}>{item.target}</span>
            </div>
        </div>
    );
  };
  
  // ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (Recommendation)
  const WellbeingRecommender = ({ date, onAdd, dayItems }) => {
    const isTodayOrFuture = date >= new Date().setHours(0, 0, 0, 0);
    
    if (isTodayOrFuture) {
        const recommendations = getRecommendedWellbeing(DUMMY_USER_STATS.stressLevel);
        const hasRecommendation = dayItems.some(item => item.isRecommended);

        if (!hasRecommendation && recommendations.length > 0) {
            return (
                <button
                    onClick={() => {
                        recommendations.forEach(rec => onAdd(formatDate(date), rec.id, true));
                    }}
                    className="text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full hover:bg-purple-700 transition font-medium"
                    title={`ç¾åœ¨ã®ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ«(${DUMMY_USER_STATS.stressLevel}%)ã«åŸºã¥ã„ãŸæ¨å¥¨ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ `}
                >
                    æœ¬æ—¥ã®ãŠã™ã™ã‚è¿½åŠ 
                </button>
            );
        }
    }
    return null;
  };

  // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
  const MealCalendarView = () => (
    <BaseCalendar
      data={menuPlans}
      onAddItem={handleAddMeal}
      ItemComponent={MealItem}
      Recommender={() => null} // é£Ÿäº‹ã®ç¿Œæ—¥èª¿æ•´ã¯ä¸€æ—¦çœç•¥
      title="çŒ®ç«‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (é£Ÿäº‹)"
      collectionType="menu"
      syncMock="Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸ: çŒ®ç«‹äºˆå®šã‚’åŒæœŸã™ã‚‹APIã‚’å‘¼ã³å‡ºã—ã¾ã™"
    />
  );
  
  const ExerciseCalendarView = () => (
    <BaseCalendar
      data={exercisePlans}
      onAddItem={handleAddExercise}
      ItemComponent={ExerciseItem}
      Recommender={({ date, onAdd, dayItems }) => {
          const isTodayOrFuture = date >= new Date().setHours(0, 0, 0, 0);
          const recommended = getRecommendedExercise(date);
          const hasRecommendation = dayItems.some(item => item.isRecommended);

          if (isTodayOrFuture && !hasRecommendation) {
              return (
                  <button
                      onClick={() => onAdd(formatDate(date), recommended.recipeId, true)}
                      className="text-xs bg-green-500 text-white px-2 py-0.5 rounded-full hover:bg-green-600 transition font-medium"
                  >
                      æœ¬æ—¥ã®ãŠã™ã™ã‚è¿½åŠ 
                  </button>
              );
          }
          return null;
      }}
      title="é‹å‹•ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (ç¿’æ…£åŒ–)"
      collectionType="exercise"
      syncMock="Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸ: é‹å‹•äºˆå®šã‚’åŒæœŸã™ã‚‹APIã‚’å‘¼ã³å‡ºã—ã¾ã™"
    />
  );
  
  const WellbeingCalendarView = () => (
    <BaseCalendar
      data={wellbeingPlans}
      onAddItem={handleAddWellbeing}
      ItemComponent={WellbeingItem}
      Recommender={WellbeingRecommender}
      title="ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ (ç²¾ç¥ãƒ»ç¡çœ )"
      collectionType="wellbeing"
      syncMock="Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸ: ç²¾ç¥ãƒ»ç¡çœ ã‚¿ã‚¹ã‚¯ã‚’åŒæœŸã™ã‚‹APIã‚’å‘¼ã³å‡ºã—ã¾ã™"
    />
  );


  if (!isAuthReady) {
    return <div className="flex items-center justify-center min-h-screen bg-gray-100"><div className="text-xl text-indigo-600">èªè¨¼ä¸­...</div></div>;
  }
  
  return (
    <div className="min-h-screen bg-gray-50 font-sans">
      {/* ç¦æ­¢äº‹é …ã‚¢ãƒ©ãƒ¼ãƒˆ */}
      {showAlert && <CustomAlert message={showAlert} onClose={() => setShowAlert(null)} />}

      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
      <header className="bg-white shadow-md">
        <div className="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
          <h1 className="text-2xl font-extrabold text-indigo-700 flex items-center">
            <CheckCircle className="w-6 h-6 mr-2 text-green-500"/> çµ±åˆäºˆé˜²åŒ»ç™‚ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
          </h1>
          <nav className="flex space-x-3">
            <button
              onClick={() => setCurrentPage('calendar')}
              className={`px-4 py-2 rounded-full font-medium transition flex items-center ${
                currentPage === 'calendar' ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-100'
              }`}
            >
              <Menu className="w-4 h-4 mr-1"/> çŒ®ç«‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
            </button>
            <button
              onClick={() => setCurrentPage('exercise')}
              className={`px-4 py-2 rounded-full font-medium transition flex items-center ${
                currentPage === 'exercise' ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-100'
              }`}
            >
              <Activity className="w-4 h-4 mr-1"/> é‹å‹•ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
            </button>
            <button
              onClick={() => setCurrentPage('wellbeing')}
              className={`px-4 py-2 rounded-full font-medium transition flex items-center ${
                currentPage === 'wellbeing' ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-100'
              }`}
            >
              <Brain className="w-4 h-4 mr-1"/> ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°
            </button>
            <button
              onClick={() => setCurrentPage('prevention')}
              className={`px-4 py-2 rounded-full font-medium transition flex items-center ${
                currentPage === 'prevention' ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-600 hover:bg-gray-100'
              }`}
            >
              <Lightbulb className="w-4 h-4 mr-1"/> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            </button>
          </nav>
          <div className="text-sm text-gray-500">
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <span className="font-mono text-xs bg-gray-100 p-1 rounded">{userId}</span>
          </div>
        </div>
      </header>

      {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <main className="max-w-screen-2xl mx-auto p-4 lg:p-8">
        <div className="bg-white rounded-xl shadow-2xl overflow-hidden">
          {currentPage === 'calendar' && <MealCalendarView />}
          {currentPage === 'exercise' && <ExerciseCalendarView />}
          {currentPage === 'wellbeing' && <WellbeingCalendarView />}
          {currentPage === 'prevention' && <PreventisonView />}
        </div>
      </main>

      {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
      <footer className="py-4 text-center text-xs text-gray-400">
        â€»æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã€é«˜åº¦ãªäºˆé˜²åŒ»ç™‚AIã¨ãƒ‡ãƒ¼ã‚¿è“„ç©ã‚’æƒ³å®šã—ãŸUI/UXã§ã™ã€‚
      </footer>
    </div>
  );
};

export default App;
