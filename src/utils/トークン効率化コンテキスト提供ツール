<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>トークン効率化コンテキスト提供ツール</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interフォント設定 */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* スクロールバーのスタイルを調整（オプション） */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        /* ファイルツリーのクリック可能要素のスタイル */
        .file-item, .folder-toggle {
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .file-item:hover, .folder-toggle:hover {
            background-color: #f0f4f8; /* ホバーで少し明るく */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', /* Indigo-600 */
                        'secondary': '#10b981', /* Emerald-500 */
                        'bg-light': '#f9fafb',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-bg-light min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <header class="mb-6 pb-4 border-b border-indigo-200">
            <h1 class="text-3xl font-bold text-primary">トークン効率化 コンテキスト提供UI</h1>
            <p class="text-gray-600 mt-1">ローカルトークン消費を最小化するために、必要なファイルパスと内容を正確にClaudeに伝達します。</p>
        </header>

        <!-- メインコンテナ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- 1. ファイルツリー (左側) -->
            <div class="lg:col-span-1 bg-white p-4 rounded-xl shadow-lg h-[600px] overflow-y-auto custom-scrollbar border border-gray-200">
                <h2 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">プロジェクトファイル構造 (シミュレーション)</h2>
                <div id="file-tree" class="space-y-1 text-sm">
                    <!-- ファイルツリーがここにレンダリングされます -->
                </div>
            </div>

            <!-- 2. コンテキストプレビューと操作 (右側) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- 選択されたパスとスニペット -->
                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">選択中のコンテキスト</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">【ファイルパス】</label>
                        <div id="selected-path" class="p-3 mt-1 bg-gray-50 border border-gray-300 text-sm font-mono rounded-lg break-all text-indigo-700">
                            ファイルを選択してください...
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">【コードスニペット】(トークン削減のため抜粋)</label>
                        <pre id="selected-content" class="p-3 mt-1 bg-gray-800 text-white text-xs rounded-lg h-48 overflow-y-auto custom-scrollbar">
// ここにファイルの関連コードが表示されます。
// ... (トークン節約のため、最小限のコンテキストを渡します)
                        </pre>
                    </div>

                    <p class="text-sm text-red-600 mt-2">※ローカルパスの`/Users/aritahiroaki/...`部分は、あなたのPC環境に合わせて適宜変更してください。</p>

                </div>

                <!-- コピーボタン -->
                <button id="copy-button" 
                        class="w-full py-3 px-4 bg-secondary text-white font-bold rounded-xl shadow-md hover:bg-emerald-600 transition duration-150 disabled:opacity-50 flex items-center justify-center" 
                        disabled>
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    LLMへのプロンプトをコピー (パス + 内容)
                </button>
                <div id="copy-message" class="text-center text-sm text-green-700 font-medium hidden">コピーしました！Claudeへの指示を添えて貼り付けてください。</div>
            </div>
        </div>
    </div>

    <script type="module">
        // 仮想ファイルシステム構造を定義 (日本語で説明を追加)
        const FILE_STRUCTURE = {
            name: "n3-frontend_new (ECフロントエンド)",
            isFolder: true,
            children: [
                {
                    name: "components (コンポーネント群)",
                    isFolder: true,
                    children: [
                        { 
                            name: "ProductModal (商品詳細モーダル)",
                            isFolder: true,
                            children: [
                                {
                                    name: "components",
                                    isFolder: true,
                                    children: [
                                        {
                                            name: "Tabs",
                                            isFolder: true,
                                            children: [
                                                { 
                                                    name: "TabMirror.tsx", 
                                                    path: "/Users/aritahiroaki/n3-frontend_new/components/ProductModal/components/Tabs/TabMirror.tsx",
                                                    isFolder: false,
                                                    content: `
import React from 'react';
import { useProductContext } from '../../../../context/ProductContext';
// ... 依存関係のインポート

/**
 * 鏡像/類似商品タブのメインコンポーネント。
 * 主に商品推薦ロジックを担当。
 */
const TabMirror = () => {
    const { productData, currentTab } = useProductContext();
    // ... 複雑な商品照合ロジック
    
    if (currentTab !== 'mirror') return null;

    return (
        <div className="p-4 bg-gray-50 rounded-lg">
            <h3 className="text-lg font-bold mb-3">類似商品レコメンド</h3>
            {/* ... レコメンドUIのレンダリング */}
        </div>
    );
};

export default TabMirror;
                                                    `
                                                },
                                                { 
                                                    name: "TabSpec.tsx", 
                                                    path: "/Users/aritahiroaki/n3-frontend_new/components/ProductModal/components/Tabs/TabSpec.tsx",
                                                    isFolder: false,
                                                    content: `
import SpecTable from './SpecTable';
// ... 他のインポート

/**
 * 商品スペックタブ。単なる表示用。
 */
const TabSpec = ({ data }) => {
    // ... スペック表示ロジック
    return <SpecTable specs={data.specs} />;
};

export default TabSpec;
                                                    `
                                                },
                                            ]
                                        },
                                    ]
                                },
                            ]
                        },
                        { 
                            name: "Header.tsx", 
                            path: "/Users/aritahiroaki/n3-frontend_new/components/Header.tsx",
                            isFolder: false,
                            content: `
import { SearchBar } from './SearchBar';
// ... 依存関係

/**
 * サイト全体のヘッダーコンポーネント
 */
const Header = () => {
    // ... ナビゲーションロジック
    return (
        <header className="fixed top-0 w-full bg-white shadow z-10">
            <div className="max-w-7xl mx-auto flex justify-between items-center p-4">
                {/* ... UI要素 */}
            </div>
        </header>
    );
};

export default Header;
                            `
                        },
                    ]
                },
                {
                    name: "utils (ユーティリティ関数)",
                    isFolder: true,
                    children: [
                        { 
                            name: "auth.ts", 
                            path: "/Users/aritahiroaki/n3-frontend_new/utils/auth.ts",
                            isFolder: false,
                            content: `
// Firebase/NextAuthなどの認証ロジック
export const getAuthToken = () => {
    // トークン取得処理
    return localStorage.getItem('authToken');
};

export const signIn = (user, pass) => {
    // ログイン処理
    // ...
};
                            `
                        },
                    ]
                },
                { 
                    name: "package.json", 
                    path: "/Users/aritahiroaki/n3-frontend_new/package.json",
                    isFolder: false,
                    content: `
{
  "name": "n3-frontend_new",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start"
  },
  "dependencies": {
    "next": "14.0.0",
    "react": "18.2.0",
    "tailwindcss": "3.3.0"
    // ... (他の依存関係)
  }
}
                    `
                }
            ]
        };

        const fileTreeEl = document.getElementById('file-tree');
        const selectedPathEl = document.getElementById('selected-path');
        const selectedContentEl = document.getElementById('selected-content');
        const copyButton = document.getElementById('copy-button');
        const copyMessage = document.getElementById('copy-message');
        
        let currentSelectedFile = null;
        let base_user_path = "/Users/aritahiroaki/n3-frontend_new"; // ユーザーのベースパス

        /**
         * ファイルツリーを再帰的にレンダリングする
         * @param {Object} node - ファイル構造ノード
         * @param {string} currentPath - 現在の親のパス
         */
        function renderTree(node, currentPath = '') {
            const el = document.createElement('div');
            el.className = 'pl-3';

            const nameEl = document.createElement('div');
            
            // パスからファイル名/フォルダ名のみを抽出（説明部分を削除）
            const cleanName = node.name.split(' (')[0];
            const displayPath = currentPath + cleanName + (node.isFolder ? '/' : '');

            if (node.isFolder) {
                // フォルダ
                nameEl.className = 'folder-toggle flex items-center p-1 rounded-lg text-indigo-800 font-medium';
                nameEl.innerHTML = `
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                    ${node.name}
                `;
                nameEl.onclick = () => {
                    const contentEl = el.querySelector('.folder-content');
                    if (contentEl) {
                        contentEl.classList.toggle('hidden');
                    }
                };
                
                const contentEl = document.createElement('div');
                contentEl.className = 'folder-content hidden';
                
                if (node.children) {
                    node.children.forEach(child => {
                        contentEl.appendChild(renderTree(child, displayPath));
                    });
                }

                el.appendChild(nameEl);
                el.appendChild(contentEl);

            } else {
                // ファイル
                nameEl.className = 'file-item flex items-center p-1 rounded-lg text-gray-700 hover:bg-indigo-100 hover:text-indigo-900';
                nameEl.innerHTML = `
                    <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    ${cleanName}
                `;
                nameEl.onclick = () => {
                    selectFile(node);
                    // 以前に選択されたファイルをリセットし、現在のファイルをハイライト
                    document.querySelectorAll('.file-item').forEach(item => {
                        item.classList.remove('bg-indigo-200', 'text-indigo-900', 'font-semibold');
                    });
                    nameEl.classList.add('bg-indigo-200', 'text-indigo-900', 'font-semibold');
                };
                el.appendChild(nameEl);
            }

            return el;
        }

        /**
         * ファイルが選択されたときにプレビューを更新する
         * @param {Object} fileNode - 選択されたファイルノード
         */
        function selectFile(fileNode) {
            currentSelectedFile = fileNode;
            
            // ローカル環境のパスに置き換えて表示 (ユーザー名部分は仮)
            const simulatedPath = fileNode.path.replace("/Users/aritahiroaki/n3-frontend_new", base_user_path);

            selectedPathEl.textContent = simulatedPath;
            selectedContentEl.textContent = fileNode.content.trim();
            copyButton.disabled = false;
        }

        /**
         * LLM向けプロンプトをクリップボードにコピーする
         */
        function copyPrompt() {
            if (!currentSelectedFile) return;

            const path = selectedPathEl.textContent;
            const content = selectedContentEl.textContent;

            // LLMに渡すプロンプトのテンプレート
            const promptTemplate = `
以下のファイルについて変更を依頼します。トークン節約のため、必要なコンテキストのみを提示します。

【ファイルパス】: ${path}
【現在のファイル内容】: 
${content}
---
【変更指示】: 
ここに具体的な変更内容を日本語で記述してください。（例: 'TabMirrorコンポーネントに、ユーザーが類似商品を「お気に入り」登録できるボタンとそのロジックを追加してください。State管理はContextを使用してください。'）
`;
            
            // クリップボードへのコピー
            navigator.clipboard.writeText(promptTemplate.trim()).then(() => {
                copyMessage.classList.remove('hidden');
                setTimeout(() => {
                    copyMessage.classList.add('hidden');
                }, 3000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('コピーに失敗しました。ブラウザがクリップボード操作を許可しているか確認してください。');
            });
        }
        
        // イベントリスナーの設定
        copyButton.addEventListener('click', copyPrompt);

        // 初期化処理: ファイルツリーのレンダリング
        document.addEventListener('DOMContentLoaded', () => {
            const treeContainer = document.getElementById('file-tree');
            // ルートノードは特別に処理し、常に開いている状態にする
            const rootNameEl = document.createElement('div');
            rootNameEl.className = 'flex items-center p-1 font-bold text-lg text-primary';
            rootNameEl.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h12a1 1 0 001-1v-10"></path></svg>
                ${FILE_STRUCTURE.name}
            `;
            treeContainer.appendChild(rootNameEl);

            const rootContentEl = document.createElement('div');
            rootContentEl.className = 'pl-2 border-l border-gray-300 ml-2';

            if (FILE_STRUCTURE.children) {
                FILE_STRUCTURE.children.forEach(child => {
                    rootContentEl.appendChild(renderTree(child, '')); // 最初のレベルはパスに何も付けない
                });
            }
            treeContainer.appendChild(rootContentEl);
            
            // 初期のパス表示を調整
            selectedPathEl.textContent = base_user_path + " の下のファイルを選択してください。";
        });
    </script>
</body>
</html>