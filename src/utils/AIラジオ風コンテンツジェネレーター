<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIãƒ©ã‚¸ã‚ªé¢¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        .voice-card {
            background-color: #eef2ff;
            border-left: 4px solid #4f46e5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .audio-player {
            width: 100%;
            margin-top: 20px;
            border-radius: 8px;
        }
        .tts-button {
            transition: all 0.2s;
        }
        .tts-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">AIãƒ©ã‚¸ã‚ªé¢¨ éŸ³å£°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ¶ä½œ</h1>
    <p class="text-gray-600 mb-8 text-center">
        **å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ä¸è¦ï¼** å°æœ¬ã‚’ç›´æ¥AIéŸ³å£°åˆæˆAPIã«æ¸¡ã—ã€ãƒ©ã‚¸ã‚ªé¢¨éŸ³å£°ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    </p>

    <div class="voice-card">
        <h2 class="text-lg font-semibold text-indigo-700 mb-2">ãƒ©ã‚¸ã‚ªå°æœ¬ (Host: Kore, Guest: Zephyr)</h2>
        <p class="text-sm text-gray-600 mb-3">
            â€»ä¼šè©±å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä¾‹: **ãƒ›ã‚¹ãƒˆ:** ã“ã‚“ã«ã¡ã¯ã€‚ä»Šæ—¥ã®çµŒæ¸ˆãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯... **ã‚²ã‚¹ãƒˆ:** ã¯ã„ã€ç‰¹ã«æ ªä¾¡ã®å‹•ããŒ...
        </p>
        <textarea id="scriptInput" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-800" placeholder="ä¾‹ï¼š
ãƒ›ã‚¹ãƒˆ: å¤§è°·é¸æ‰‹ã®æœ€æ–°ã®ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³ã«ã¤ã„ã¦ã€ã‚¢ãƒ¡ãƒªã‚«ã®åå¿œã¯ã©ã†ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ã‚²ã‚¹ãƒˆ: ç†±ç‹‚çš„ã§ã™ã­ï¼ç‰¹ã«å½¼ã®æ‰“æ’ƒãƒ•ã‚©ãƒ¼ãƒ ã®ä¿®æ­£ãŒæ³¨ç›®ã•ã‚Œã¦ã„ã¾ã™ã€‚
ãƒ›ã‚¹ãƒˆ: ãªã‚‹ã»ã©ã€‚ã“ã®å‹¢ã„ã§ã‚¢ãƒ»ãƒªãƒ¼ã‚°ã®MVPã¯ç¢ºå®Ÿã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ï¼">
ãƒ›ã‚¹ãƒˆ: æœ€æ–°ã®å¥åº·ç®¡ç†ãƒˆãƒ¬ãƒ³ãƒ‰ã«ã¤ã„ã¦ã€ä»Šæ—¥ã¯ã‚²ã‚¹ãƒˆã®Janeã•ã‚“ã«ãŠè©±ã‚’ä¼ºã„ã¾ã™ã€‚
ã‚²ã‚¹ãƒˆ: ã¯ã„ã€æœ€è¿‘è©±é¡Œã®ã€Œãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒ»ã‚¤ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚
ãƒ›ã‚¹ãƒˆ: èˆˆå‘³æ·±ã„ã§ã™ã­ã€‚ãã‚Œã§ã¯ã€ãã®å…·ä½“çš„ãªæ–¹æ³•ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ
</textarea>
    </div>

    <button id="generateButton" onclick="generateAudio()" class="tts-button w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50" disabled>
        <span id="buttonText">ğŸ¤– éŸ³å£°ç”Ÿæˆã‚’é–‹å§‹ (TTS)</span>
    </button>
    
    <div id="loadingIndicator" class="hidden text-center mt-4 text-indigo-600 font-medium">
        éŸ³å£°ã‚’ç”Ÿæˆä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...
    </div>

    <div id="resultContainer" class="mt-8 hidden">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ç”Ÿæˆçµæœ</h2>
        <audio id="audioPlayer" controls class="audio-player"></audio>
        <a id="downloadLink" class="inline-block mt-4 text-indigo-600 hover:text-indigo-800 transition duration-150" download="ai_podcast.wav" href="#">WAVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
    </div>

    <p id="errorMessage" class="text-red-600 text-sm mt-4 hidden"></p>
</div>

<script>
    // Firebaseã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const apiKey = ""; // APIã‚­ãƒ¼ã¯ã‚­ãƒ£ãƒ³ãƒã‚¹ç’°å¢ƒã§è‡ªå‹•çš„ã«æä¾›ã•ã‚Œã¾ã™
    const audioPlayer = document.getElementById('audioPlayer');
    const generateButton = document.getElementById('generateButton');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const resultContainer = document.getElementById('resultContainer');
    const downloadLink = document.getElementById('downloadLink');
    const scriptInput = document.getElementById('scriptInput');
    const errorMessage = document.getElementById('errorMessage');

    // ------------------------------------
    // TTS APIã‹ã‚‰è¿”ã•ã‚Œã‚‹PCMãƒ‡ãƒ¼ã‚¿ã‚’WAVå½¢å¼ã«å¤‰æ›ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ------------------------------------

    /**
     * Base64æ–‡å­—åˆ—ã‚’ArrayBufferã«å¤‰æ›ã—ã¾ã™ã€‚
     */
    function base64ToArrayBuffer(base64) {
        const binaryString = atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    /**
     * PCM 16-bit ãƒ‡ãƒ¼ã‚¿ã‚’ WAV ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã® Blob ã«å¤‰æ›ã—ã¾ã™ã€‚
     * APIã¯Signed 16-bit PCM (L16)ã§ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆã¯APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚
     */
    function pcmToWav(pcmData, sampleRate) {
        const buffer = new ArrayBuffer(44 + pcmData.length * 2); // 44ãƒã‚¤ãƒˆã®WAVãƒ˜ãƒƒãƒ€ãƒ¼ + ãƒ‡ãƒ¼ã‚¿
        const view = new DataView(buffer);
        
        // RIFF ãƒ˜ãƒƒãƒ€ãƒ¼
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + pcmData.length * 2, true);
        writeString(view, 8, 'WAVE');
        
        // fmt ãƒãƒ£ãƒ³ã‚¯
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);  // ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º
        view.setUint16(20, 1, true);   // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚³ãƒ¼ãƒ‰ (PCM)
        view.setUint16(22, 1, true);   // ãƒãƒ£ãƒ³ãƒãƒ«æ•° (ãƒ¢ãƒãƒ©ãƒ«)
        view.setUint32(24, sampleRate, true); // ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆ
        view.setUint32(28, sampleRate * 2, true); // ByteRate (SampleRate * NumChannels * BitsPerSample/8)
        view.setUint16(32, 2, true);   // BlockAlign (NumChannels * BitsPerSample/8)
        view.setUint16(34, 16, true);  // BitsPerSample
        
        // data ãƒãƒ£ãƒ³ã‚¯
        writeString(view, 36, 'data');
        view.setUint32(40, pcmData.length * 2, true); // ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º
        
        // PCMãƒ‡ãƒ¼ã‚¿ (Int16)
        for (let i = 0; i < pcmData.length; i++) {
            view.setInt16(44 + i * 2, pcmData[i], true);
        }
        
        return new Blob([buffer], { type: 'audio/wav' });
    }

    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }

    // ------------------------------------
    // TTSç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
    // ------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        // ãƒ‡ãƒ¢ã®ãŸã‚ã€èªè¨¼çŠ¶æ…‹ã«é–¢ã‚ã‚‰ãšãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        generateButton.disabled = false;
    });

    /**
     * AIéŸ³å£°åˆæˆã‚’å®Ÿè¡Œã—ã€éŸ³å£°ã‚’å†ç”Ÿãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã«ã—ã¾ã™ã€‚
     */
    async function generateAudio() {
        const script = scriptInput.value.trim();
        if (!script) {
            errorMessage.textContent = "å°æœ¬ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
            errorMessage.classList.remove('hidden');
            return;
        }

        generateButton.disabled = true;
        loadingIndicator.classList.remove('hidden');
        errorMessage.classList.add('hidden');
        resultContainer.classList.add('hidden');

        try {
            // TTS API URL
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            // ãƒ©ã‚¸ã‚ªé¢¨ã«ã™ã‚‹ãŸã‚ã€ãƒãƒ«ãƒã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼è¨­å®šã‚’ä½¿ç”¨
            const payload = {
                contents: [{
                    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ä½“ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦æ¸¡ã™
                    parts: [{ text: script }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        multiSpeakerVoiceConfig: {
                            // "ãƒ›ã‚¹ãƒˆ:"ã¨"ã‚²ã‚¹ãƒˆ:"ã®ã‚¿ã‚°ã«åŸºã¥ã„ã¦å£°ã‚’å‰²ã‚Šå½“ã¦ã‚‹
                            speakerVoiceConfigs: [
                                { speaker: "ãƒ›ã‚¹ãƒˆ", voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } },
                                { speaker: "ã‚²ã‚¹ãƒˆ", voiceConfig: { prebuiltVoiceConfig: { voiceName: "Zephyr" } } }
                            ]
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            
            // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã‚’è€ƒæ…®ã—ãŸãƒ•ã‚§ãƒƒãƒ
            const fetchWithRetry = async (url, options, maxRetries = 5) => {
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.ok) return response;
                        if (response.status === 429 && i < maxRetries - 1) { // 429: Too Many Requests
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            console.warn(`Rate limit hit, retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API request failed with status ${response.status}`);
                    } catch (error) {
                        if (i === maxRetries - 1) throw error;
                    }
                }
            };


            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            
            // å¿œç­”ã®æ¤œè¨¼
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (!audioData || !mimeType || !mimeType.startsWith("audio/L16")) {
                console.error("TTS API Response Error:", result);
                errorMessage.textContent = "éŸ³å£°ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å°æœ¬ã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                errorMessage.classList.remove('hidden');
                return;
            }

            // ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ãƒ¼ãƒˆã®æŠ½å‡º (ä¾‹: audio/L16;rate=24000)
            const rateMatch = mimeType.match(/rate=(\d+)/);
            const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000; 

            // PCMãƒ‡ãƒ¼ã‚¿ã‚’WAVå½¢å¼ã«å¤‰æ›
            const pcmDataBuffer = base64ToArrayBuffer(audioData);
            // APIã¯Signed 16-bit PCMã‚’è¿”ã™
            const pcm16 = new Int16Array(pcmDataBuffer); 
            const wavBlob = pcmToWav(pcm16, sampleRate);
            
            // å†ç”Ÿç”¨ã®URLã‚’ä½œæˆã—ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¨­å®š
            const audioUrl = URL.createObjectURL(wavBlob);
            audioPlayer.src = audioUrl;
            downloadLink.href = audioUrl;

            resultContainer.classList.remove('hidden');

        } catch (error) {
            console.error("Error during TTS generation:", error);
            errorMessage.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
            errorMessage.classList.remove('hidden');
        } finally {
            loadingIndicator.classList.add('hidden');
            generateButton.disabled = false;
        }
    }
</script>
</body>
</html>
