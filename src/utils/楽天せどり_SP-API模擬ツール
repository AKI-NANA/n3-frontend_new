import { ChangeDetectionStrategy, Component, computed, signal, OnInit } from '@angular/core';
import { getAuth, signInWithCustomToken, signInAnonymously } from 'firebase/auth';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, arrayUnion, arrayRemove, getDoc, Firestore } from 'firebase/firestore';

// Firebaseã¨ã‚¢ãƒ—ãƒªã®IDã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦æä¾›ã•ã‚Œã¾ã™ (Canvasç’°å¢ƒã®åˆ¶ç´„)
declare const __app_id: string;
declare const __firebase_config: string;
declare const __initial_auth_token: string;

// MARK: - ãƒ‡ãƒ¼ã‚¿ã®å‹å®šç¾©

interface ArbitrageSettings {
  spuMultiplier: number;
  amazonFeeRate: number;
  maxBSRThreshold: number;
  minProfitRate: number;
}

interface ArbitrageProduct {
  id: string;
  asin: string;
  productName: string;
  rakutenPrice: number;
  amazonPrice: number;
  currentBSR: number;
  purchaseStatus: 'pending' | 'bought' | 'skipped' | 'sold';
  isExcluded: boolean; // æ¥½å¤©å´ã§ä»•å…¥ã‚Œä¸å¯
}

interface TrackedRoute {
  name: string;
  url: string;
}

@Component({
  selector: 'app-root',
  template: `
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <div class="min-h-screen bg-gray-50 p-4 md:p-10 font-sans">
      <header class="text-center mb-10">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
          <i class="fas fa-search-dollar text-green-600 mr-3"></i> æ¥½å¤©ã›ã©ã‚Š SP-APIæ¨¡æ“¬é¸å®šãƒ„ãƒ¼ãƒ«
        </h1>
        <p class="text-gray-600">å‡ºå“å¯å¦ï¼ˆAPIæ¨¡æ“¬ï¼‰ã€å›è»¢ç‡ã€ãƒã‚¤ãƒ³ãƒˆåˆ©ç›Šç‡ã®å…¨ã¦ã‚’ã‚¯ãƒªã‚¢ã—ãŸå•†å“ã®ã¿ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
        <p *if="userId()" class="text-xs mt-2 text-gray-400">User ID: {{ userId() }}</p>
      </header>

      <!-- è¨­å®šã‚¨ãƒªã‚¢ -->
      <section class="max-w-4xl mx-auto mb-8 p-6 bg-white rounded-xl shadow-lg border-t-4 border-red-500">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-sliders-h text-red-500 mr-2"></i> ãƒã‚¤ãƒ³ãƒˆï¼†ãƒ•ã‚£ãƒ«ã‚¿è¨­å®š
        </h2>
        <form (ngSubmit)="saveSettings()" class="grid grid-cols-1 md:grid-cols-4 gap-4">
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ç¾åœ¨ã®SPUå€ç‡ (1+Xå€)</label>
            <div class="flex items-center">
              <input type="number" [(ngModel)]="settings().spuMultiplier" name="spu" min="1" class="input-style flex-grow" required>
              <span class="ml-2 text-xl font-bold text-red-600">å€</span>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Amazonæ‰‹æ•°æ–™ (%)</label>
            <div class="flex items-center">
              <input type="number" [(ngModel)]="settings().amazonFeeRate" name="fee" min="1" max="50" class="input-style flex-grow" required>
              <span class="ml-2 text-xl font-bold text-gray-600">%</span>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">è¨±å®¹æœ€å¤§BSR (å›è»¢ç‡)</label>
            <input type="number" [(ngModel)]="settings().maxBSRThreshold" name="bsr" min="100" class="input-style" required>
            <p class="text-xs text-gray-500 mt-1">ã“ã®å€¤ä»¥ä¸‹ã®BSRã®ã¿è¡¨ç¤º</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">æœ€ä½åˆ©ç›Šç‡ (%)</label>
            <input type="number" [(ngModel)]="settings().minProfitRate" name="minProfit" min="1" class="input-style" required>
            <p class="text-xs text-gray-500 mt-1">ã“ã®å€¤ä»¥ä¸Šã®åˆ©ç›Šç‡ã®ã¿è¡¨ç¤º</p>
          </div>

          <div class="md:col-span-4 pt-2">
            <button type="submit" [disabled]="!isAuthReady()" class="w-full px-4 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition shadow-md flex items-center justify-center disabled:opacity-50">
              <i class="fas fa-save mr-2"></i> è¨­å®šã‚’ä¿å­˜ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ›´æ–°
            </button>
          </div>
        </form>
      </section>

      <!-- å‡ºå“åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼†æ—¢çŸ¥ã®åˆ¶é™ãƒªã‚¹ãƒˆ -->
      <section class="max-w-4xl mx-auto mb-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- ASINå€‹åˆ¥ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ (SP-APIæ¨¡æ“¬) -->
        <div class="p-6 bg-white rounded-xl shadow-lg border-l-4 border-green-500">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-laptop-code text-green-500 mr-2"></i> å‡ºå“å¯å¦ã‚¯ã‚¤ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ (SP-APIæ¨¡æ“¬)
          </h3>
          
          <form (ngSubmit)="checkAsinEligibility()" class="flex space-x-2 mb-4">
            <input type="text" [(ngModel)]="checkAsinInput" name="checkAsin" placeholder="ASINã‚’å…¥åŠ› (ä¾‹: B00A005)" class="input-style flex-1" required>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">åˆ¤å®š</button>
          </form>

          <div *if="asinCheckResult()" class="mt-4 p-3 rounded-lg font-bold"
               [ngClass]="asinCheckResult().eligible ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
            <i class="fas" [ngClass]="asinCheckResult().eligible ? 'fa-check-circle' : 'fa-times-circle'"></i>
            ASIN: {{ asinCheckResult().asin }} ã¯ **{{ asinCheckResult().eligible ? 'å‡ºå“å¯èƒ½' : 'å‡ºå“åˆ¶é™ã‚ã‚Š' }}** ã§ã™ã€‚
          </div>
        </div>

        <!-- æ—¢çŸ¥ã®åˆ¶é™ASINãƒªã‚¹ãƒˆ (DBé€£æº) -->
        <div class="p-6 bg-white rounded-xl shadow-lg border-l-4 border-yellow-500">
          <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-ban text-yellow-500 mr-2"></i> å‡ºå“ã§ããªã„ASINï¼ˆæ—¢çŸ¥ã®åˆ¶é™ãƒªã‚¹ãƒˆï¼‰
          </h3>
          
          <div class="space-y-2 max-h-40 overflow-y-auto">
            <div *for="let asin of limitedAsins()" class="flex justify-between items-center bg-yellow-50 p-2 rounded-lg text-sm">
              <span class="font-medium">{{ asin }}</span>
              <button (click)="removeLimitedAsin(asin)" class="ml-2 text-red-500 hover:text-red-700" [disabled]="!isAuthReady()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <p *if="limitedAsins().length === 0" class="text-sm text-gray-500 text-center py-2">
                ASINã‚’ç™»éŒ²ã™ã‚‹ã¨ã€æ—¢çŸ¥ã®åˆ¶é™å•†å“ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã«æ®‹ã‚Šã¾ã™ã€‚
            </p>
          </div>
        </div>
      </section>
      
      <!-- æ¤œå‡ºã•ã‚ŒãŸãƒãƒ£ãƒ³ã‚¹å•†å“ãƒªã‚¹ãƒˆ -->
      <main class="max-w-4xl mx-auto">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 pb-2 border-b border-gray-200 flex justify-between items-center">
          <span><i class="fas fa-piggy-bank text-green-600 mr-2"></i> åˆ©ç›Šç¢ºå®šãƒãƒ£ãƒ³ã‚¹å•†å“ãƒªã‚¹ãƒˆ</span>
          <span class="text-lg font-bold text-gray-600">è¡¨ç¤ºä»¶æ•°: {{ filteredProducts().length }}</span>
        </h2>

        <div *if="filteredProducts().length === 0" class="card p-8 text-center bg-yellow-50 text-yellow-700">
          <i class="fas fa-filter text-2xl mb-3"></i>
          <p class="font-medium">ç¾åœ¨ã®è¨­å®šã«é©åˆã™ã‚‹å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å‡ºå“åˆ¶é™ãƒã‚§ãƒƒã‚¯ã‚’é€šéã—ã€åˆ©ç›Šç‡ã¨å›è»¢ç‡ã‚’æº€ãŸã™å•†å“ã‚’æ¢ã—ã¾ã—ã‚‡ã†ã€‚</p>
        </div>

        <div *if="filteredProducts().length > 0" class="space-y-4">
          <div *for="let product of filteredProducts()" class="card p-4 flex justify-between items-center transition duration-150" [ngClass]="getProductCardStyle(product.analysis.netProfitRate)">
            
            <!-- å•†å“æƒ…å ±ã¨åˆ†æçµæœ -->
            <div class="flex-grow pr-4">
              <h3 class="text-xl font-bold text-gray-900 mb-1">{{ product.productName }}</h3>
              <div class="flex space-x-4 text-sm text-gray-600 mb-2">
                <span>æ¥½å¤©ä¾¡æ ¼: <span class="font-bold text-red-600">Â¥{{ product.rakutenPrice | number }}</span></span>
                <span>Amazonä¾¡æ ¼: <span class="font-bold text-blue-600">Â¥{{ product.amazonPrice | number }}</span></span>
              </div>
              
              <div class="flex items-center space-x-4">
                <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white" 
                      [ngClass]="product.analysis.netProfitRate > settings().minProfitRate ? 'bg-green-500' : 'bg-red-500'">
                  åˆ©ç›Šç‡: {{ product.analysis.netProfitRate | number:'1.0-1' }}%
                </span>
                <span class="text-xs font-semibold px-2 py-0.5 rounded-full text-white" 
                      [ngClass]="product.currentBSR <= settings().maxBSRThreshold ? 'bg-blue-500' : 'bg-orange-500'">
                  BSR (å›è»¢ç‡): {{ product.currentBSR | number }}ä½
                </span>
                <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-green-700 text-white">
                  <i class="fas fa-lock-open mr-1"></i> å‡ºå“å¯å¦ãƒã‚§ãƒƒã‚¯: **OK**
                </span>
              </div>
            </div>
            
            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨æœ€çµ‚åˆ©ç›Š -->
            <div class="text-right w-48">
              <p class="text-3xl font-extrabold" [ngClass]="product.analysis.netProfit > 0 ? 'text-green-700' : 'text-red-700'">
                Â¥{{ product.analysis.netProfit | number }}
              </p>
              <p class="text-sm font-semibold text-gray-600 mb-2">ç´”åˆ©ç›Š</p>
              
              <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
              <div *if="product.purchaseStatus === 'pending'" class="flex flex-col space-y-2">
                <button *if="product.analysis.netProfit > 0" 
                        (click)="updateStatus(product.id, 'bought', product.analysis)" 
                        [disabled]="!isAuthReady()"
                        class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition shadow-md text-sm disabled:opacity-50">
                    <i class="fas fa-hand-holding-usd mr-2"></i> ä»•å…¥ã‚Œå®Ÿè¡Œ (å®Ÿç¸¾ç™»éŒ²)
                </button>
              </div>
              
              <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
              <span *if="product.purchaseStatus === 'bought'" class="w-full px-4 py-2 bg-blue-500 text-white font-bold rounded-lg cursor-not-allowed flex items-center justify-center text-sm opacity-90">
                  <i class="fas fa-dolly-flatbed mr-2"></i> ä»•å…¥ã‚Œæ¸ˆã¿ (è²©å£²å¾…ã¡)
              </span>
              <span *if="product.purchaseStatus === 'sold'" class="w-full px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg cursor-not-allowed flex items-center justify-center text-sm opacity-90">
                  <i class="fas fa-medal mr-2"></i> **å®Ÿç¸¾ç™»éŒ²æ¸ˆ**
              </span>
            </div>
          </div>
          
          <h3 class="text-xl font-semibold text-gray-800 mt-8 mb-4">éå»ã®è²©å£²å®Ÿç¸¾ (ç´¯ç©: {{ pastSalesRecords().length }})</h3>
          <div *if="pastSalesRecords().length > 0" class="bg-gray-100 p-4 rounded-lg text-sm space-y-2 max-h-40 overflow-y-auto">
              <div *for="let record of pastSalesRecords()" class="flex justify-between border-b pb-1">
                  <span class="font-medium text-gray-700">{{ record.productName }}</span>
                  <span class="text-green-700 font-bold">Â¥{{ record.netProfit | number }} åˆ©ç›Š</span>
                  <span class="text-gray-500 text-xs">{{ record.purchaseDate }}</span>
              </div>
          </div>
          <p *if="pastSalesRecords().length === 0" class="text-sm text-gray-500 text-center py-2 bg-gray-100 rounded-lg">
              ä»•å…¥ã‚Œå®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã“ã“ã«è²©å£²å®Ÿç¸¾ãŒè¨˜éŒ²ã•ã‚Œã¾ã™ã€‚
          </p>
        </div>
      </main>
    </div>
    
    <style>
      .input-style { @apply w-full p-2 border border-gray-300 rounded-lg focus:border-red-500 focus:ring-red-500 transition; }
      .card { @apply bg-white rounded-xl shadow-md; }
    </style>
  `,
  styles: [
    `
      .input-style {
        width: 100%;
        padding: 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        transition: all 0.2s;
        font-size: 0.875rem; /* text-sm */
      }
      .input-style:focus {
        border-color: #ef4444; /* red-500 */
        box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.5);
      }
    `
  ],
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class App implements OnInit {
  db!: Firestore;
  auth: any;
  userId = signal<string | null>(null);
  isAuthReady = signal(false);

  // MARK: - State Management
  settings = signal<ArbitrageSettings>({
    spuMultiplier: 8,
    amazonFeeRate: 15,
    maxBSRThreshold: 5000,
    minProfitRate: 10,
  });

  allProducts = signal<ArbitrageProduct[]>([]);
  limitedAsins = signal<string[]>([]);
  pastSalesRecords = signal<any[]>([]);

  // æ–°è¦æ©Ÿèƒ½: ASINå€‹åˆ¥ãƒã‚§ãƒƒã‚¯
  checkAsinInput = '';
  asinCheckResult = signal<{asin: string, eligible: boolean} | null>(null);

  // MARK: - API Simulation Data
  // å®Ÿéš›ã«ã¯SP-APIçµŒç”±ã§å–å¾—ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã€‚ã“ã“ã§ã¯æ—¢çŸ¥ã®åˆ¶é™ASINã‚’å®šç¾©ã€‚
  readonly knownRestrictedAsins = ['B00A005', 'B01XYZ123', 'B05JKL987']; 

  // MARK: - Computed Properties (è‡ªå‹•è¨ˆç®—)

  productsWithAnalysis = computed(() => {
    const s = this.settings();
    const restricted = this.knownRestrictedAsins; // åˆ¶é™ASINãƒªã‚¹ãƒˆã‚’APIãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä½¿ç”¨

    return this.allProducts().map(product => {
      // 1. å‡ºå“å¯å¦åˆ¤å®š (SP-APIæ¨¡æ“¬)
      // åˆ¶é™ASINãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
      const isLimitedByApi = restricted.includes(product.asin);

      // 2. å®Ÿè³ªä»•å…¥ã‚Œå€¤ã®è¨ˆç®— (ãƒã‚¤ãƒ³ãƒˆè€ƒæ…®)
      const pointRate = s.spuMultiplier / 100;
      const effectiveRakutenPrice = product.rakutenPrice * (1 - pointRate);

      // 3. Amazonã§ã®ç´”å£²ä¸Šï¼ˆæ‰‹æ•°æ–™è€ƒæ…®ï¼‰
      const amazonNetRevenue = product.amazonPrice * (1 - s.amazonFeeRate / 100);

      // 4. ç´”åˆ©ç›Š
      const netProfit = Math.round(amazonNetRevenue - effectiveRakutenPrice);
      
      // 5. åˆ©ç›Šç‡
      const netProfitRate = (netProfit / effectiveRakutenPrice) * 100;

      return {
        ...product,
        isLimitedByApi: isLimitedByApi, // APIæ¨¡æ“¬ãƒã‚§ãƒƒã‚¯çµæœ
        analysis: {
          effectiveRakutenPrice,
          amazonNetRevenue,
          netProfit,
          netProfitRate: parseFloat(netProfitRate.toFixed(1)),
        }
      };
    });
  });

  // 2. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° (å‡ºå“åˆ¶é™ã€å›è»¢ç‡ã€åˆ©ç›Šç‡)
  filteredProducts = computed(() => {
    const s = this.settings();
    const analyzedProducts = this.productsWithAnalysis();

    return analyzedProducts.filter(product => {
      // 1. å‡ºå“åˆ¶é™å•†å“ã¯é™¤å¤– **(APIãƒã‚§ãƒƒã‚¯çµæœãŒä¸å¯ã®å ´åˆã¯é™¤å¤–)**
      if (product.isLimitedByApi) return false;
      
      // 2. æ¥½å¤©å´ã®ä»•å…¥ã‚Œä¸å¯å•†å“ã¯é™¤å¤– (å¿µã®ãŸã‚)
      if (product.isExcluded) return false;

      // 3. å›è»¢ç‡ãƒ•ã‚£ãƒ«ã‚¿: BSRãŒè¨±å®¹ä¸Šé™ä»¥ä¸‹ã§ã‚ã‚‹ã“ã¨
      const isGoodRotation = product.currentBSR <= s.maxBSRThreshold;

      // 4. åˆ©ç›Šç‡ãƒ•ã‚£ãƒ«ã‚¿: åˆ©ç›Šç‡ãŒæœ€ä½åŸºæº–ä»¥ä¸Šã§ã‚ã‚‹ã“ã¨ (åˆ©ç›ŠãŒãƒã‚¤ãƒŠã‚¹ã‚‚é™¤å¤–)
      const isGoodProfit = product.analysis.netProfitRate >= s.minProfitRate && product.analysis.netProfit > 0;
      
      // 5. å®Ÿè¡Œ: å…¨ã¦OKã‹ã¤æœªè³¼å…¥ã®ã‚‚ã®ã®ã¿è¡¨ç¤º
      return product.purchaseStatus === 'pending' && isGoodRotation && isGoodProfit;
    }).sort((a, b) => b.analysis.netProfit - a.analysis.netProfit); // **åˆ©ç›Šé †ã«ã‚½ãƒ¼ãƒˆ**
  });
  
  // MARK: - API Simulation: Individual ASIN Check
  checkAsinEligibility(): void {
    if (!this.checkAsinInput) return;
    
    const asin = this.checkAsinInput.toUpperCase();
    
    // å®Ÿéš›ã«ã¯ã“ã“ã§Amazon SP-APIã®ã‚³ãƒ¼ãƒ«ãŒç™ºç”Ÿã—ã€å‡ºå“å¯å¦ãŒè¿”ã•ã‚Œã‚‹ã€‚
    // ä»Šå›ã¯ã€æ—¢çŸ¥ã®åˆ¶é™ãƒªã‚¹ãƒˆã‚’ä½¿ã£ã¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹ã€‚
    const eligible = !this.knownRestrictedAsins.includes(asin);
    
    this.asinCheckResult.set({ asin: asin, eligible: eligible });
    
    if (!eligible) {
        // å‡ºå“åˆ¶é™ãŒã‚ã‚‹å ´åˆã€æ—¢çŸ¥ã®åˆ¶é™ASINãƒªã‚¹ãƒˆï¼ˆæ‰‹å‹•ç®¡ç†ï¼‰ã«è¿½åŠ ã—ã¦å­¦ç¿’ã•ã›ã‚‹
        this.addLimitedAsin(asin);
        console.log(`ASIN ${asin} ã¯å‡ºå“åˆ¶é™ãŒã‚ã£ãŸãŸã‚ã€æ—¢çŸ¥ã®åˆ¶é™ASINãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚`);
    } else {
        console.log(`ASIN ${asin} ã¯å‡ºå“å¯èƒ½ã§ã™ã€‚`);
    }
  }

  // MARK: - Initialization (Firebase Setup)
  ngOnInit(): void {
    try {
      const firebaseConfig = JSON.parse(__firebase_config);
      const app = initializeApp(firebaseConfig);
      this.db = getFirestore(app);
      this.auth = getAuth(app);

      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        signInWithCustomToken(this.auth, __initial_auth_token).catch(() => signInAnonymously(this.auth));
      } else {
        signInAnonymously(this.auth);
      }

      this.auth.onAuthStateChanged((user: any) => {
        this.userId.set(user ? user.uid : null);
        this.isAuthReady.set(true);
        if (user) {
          this.setupListeners();
        }
      });

      this.loadMockProducts();

    } catch (e) {
      console.error("Firebase Initialization Error:", e);
    }
  }

  // MARK: - Firebase Listeners and Reference Helpers

  getDocRef(collectionName: string, docId: string): any | null {
    if (!this.db || !this.userId()) return null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const currentUserId = this.userId() || 'anonymous';
    const path = `/artifacts/${appId}/users/${currentUserId}/${collectionName}/${docId}`;
    return doc(this.db, path);
  }

  setupListeners(): void {
    if (!this.db || !this.userId()) return;
    
    this.loadSettings();

    // æ—¢çŸ¥ã®åˆ¶é™ASINã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼
    const limitedRef = this.getDocRef('arbitrage_lists', 'manual_limited_asins');
    if (limitedRef) {
      onSnapshot(limitedRef, (docSnap) => {
        if (docSnap.exists() && docSnap.data()['asins']) {
          this.limitedAsins.set(docSnap.data()['asins']);
        } else {
          this.limitedAsins.set([]);
        }
      }, (error) => console.error("Error fetching limited ASINs:", error));
    }

    // è²©å£²å®Ÿç¸¾ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼
    const salesRef = this.getDocRef('arbitrage_lists', 'sales_records');
    if (salesRef) {
      onSnapshot(salesRef, (docSnap) => {
        if (docSnap.exists() && docSnap.data()['records']) {
          const records = docSnap.data()['records'].sort((a: any, b: any) => new Date(b.purchaseDate).getTime() - new Date(a.purchaseDate).getTime());
          this.pastSalesRecords.set(records);
        } else {
          this.pastSalesRecords.set([]);
        }
      }, (error) => console.error("Error fetching sales records:", error));
    }
  }

  // MARK: - Firestore: Settings
  async loadSettings(): Promise<void> {
    const settingsRef = this.getDocRef('arbitrage_settings', 'user_settings');
    if (!settingsRef) return;

    try {
      const docSnap = await getDoc(settingsRef);
      if (docSnap.exists()) {
        this.settings.set(docSnap.data() as ArbitrageSettings);
      } else {
        await setDoc(settingsRef, this.settings());
      }
    } catch (e) {
      console.error("Error loading settings:", e);
    }
  }

  async saveSettings(): Promise<void> {
    const settingsRef = this.getDocRef('arbitrage_settings', 'user_settings');
    if (!settingsRef) return;

    try {
      await setDoc(settingsRef, this.settings());
      console.log("Settings saved and filters updated successfully.");
    } catch (e) {
      console.error("Error saving settings: ", e);
    }
  }

  // MARK: - Firestore: Limited ASINs (Manual List)
  async addLimitedAsin(asin: string): Promise<void> {
    const limitedRef = this.getDocRef('arbitrage_lists', 'manual_limited_asins');
    if (!limitedRef || !this.isAuthReady()) return;

    try {
      await updateDoc(limitedRef, {
        asins: arrayUnion(asin.toUpperCase())
      });
    } catch (e) {
      await setDoc(limitedRef, { asins: [asin.toUpperCase()] }, { merge: true });
    }
  }

  async removeLimitedAsin(asin: string): Promise<void> {
    const limitedRef = this.getDocRef('arbitrage_lists', 'manual_limited_asins');
    if (!limitedRef || !this.isAuthReady()) return;

    try {
      await updateDoc(limitedRef, {
        asins: arrayRemove(asin)
      });
      console.log("Limited ASIN removed successfully.");
    } catch (e) {
      console.error("Error removing limited ASIN:", e);
    }
  }

  // MARK: - Product Action (ä»•å…¥ã‚Œå®Ÿè¡Œã¨å®Ÿç¸¾ç™»éŒ²)
  async updateStatus(id: string, newStatus: ArbitrageProduct['purchaseStatus'], analysis: any): Promise<void> {
    if (!this.isAuthReady()) return;
    
    // 1. ä»•å…¥ã‚Œæ¸ˆã¿ã¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ãƒªã‚¹ãƒˆã‚’æ›´æ–°
    this.allProducts.update(products => {
      const product = products.find(p => p.id === id);
      if (product) {
        product.purchaseStatus = newStatus;
      }
      return [...products];
    });

    // 2. ä»•å…¥ã‚Œå®Ÿè¡Œã®å ´åˆã€å®Ÿç¸¾ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«è¨˜éŒ²
    if (newStatus === 'bought') {
        const salesRef = this.getDocRef('arbitrage_lists', 'sales_records');
        if (!salesRef) return;
        
        const product = this.allProducts().find(p => p.id === id);

        const newRecord = {
            id: product!.id,
            asin: product!.asin,
            productName: product!.productName,
            netProfit: analysis.netProfit,
            netProfitRate: analysis.netProfitRate,
            purchaseDate: new Date().toLocaleDateString('ja-JP'),
            status: 'sold'
        };

        try {
            await updateDoc(salesRef, {
                records: arrayUnion(newRecord)
            });
            console.log(`[ACTION] ${product!.productName} ã‚’ä»•å…¥ã‚Œæ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã€å®Ÿç¸¾ã«è¿½åŠ ã—ã¾ã—ãŸã€‚`);
        } catch (e) {
            await setDoc(salesRef, { records: [newRecord] }, { merge: true });
            console.log(`[ACTION] ${product!.productName} ã‚’ä»•å…¥ã‚Œæ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã€å®Ÿç¸¾ã«è¿½åŠ ã—ã¾ã—ãŸã€‚`);
        }
    }
  }

  // MARK: - UI Style & Utility
  getProductCardStyle(profitRate: number): string {
    if (profitRate < this.settings().minProfitRate || profitRate <= 0) {
        return 'bg-gray-100 border-l-4 border-gray-400 opacity-60';
    }
    if (profitRate >= 20) {
        return 'bg-green-50 border-l-4 border-green-500 shadow-lg ring-4 ring-green-200';
    }
    return 'bg-white border-l-4 border-blue-300 hover:shadow-md';
  }

  // MARK: - Mock Data (ASIN B00A005ã¯åˆ¶é™ãƒªã‚¹ãƒˆã¨ä¸€è‡´ã•ã›ã¾ã™)
  loadMockProducts(): void {
    const mockProducts: ArbitrageProduct[] = [
      { // ğŸŒŸ åˆ©ç›Šç‡OK, å›è»¢ç‡OK, åˆ¶é™ãªã— -> å³è³¼å…¥å€™è£œ
        id: 'A001', asin: 'B00A001', productName: 'æœ€æ–°ã‚²ãƒ¼ãƒ æ©Ÿã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ (é™å®š)', 
        rakutenPrice: 10000, amazonPrice: 13500, currentBSR: 1500, purchaseStatus: 'pending', isExcluded: false
      },
      { // âŒ åˆ©ç›Šç‡NG
        id: 'A002', asin: 'B00A002', productName: 'äººæ°—ãƒ–ãƒ©ãƒ³ãƒ‰åŒ–ç²§å“', 
        rakutenPrice: 8000, amazonPrice: 8500, currentBSR: 500, purchaseStatus: 'pending', isExcluded: false
      },
      { // âš ï¸ åˆ©ç›Šç‡OK, å›è»¢ç‡NG -> ãƒ•ã‚£ãƒ«ã‚¿ã§é™¤å¤–
        id: 'A003', asin: 'B00A003', productName: 'å¤§å‹å®¶å…· (é«˜é¡)', 
        rakutenPrice: 50000, amazonPrice: 70000, currentBSR: 8000, purchaseStatus: 'pending', isExcluded: false
      },
      { // âŒ ASIN: B00A005 ã¯åˆ¶é™ãƒªã‚¹ãƒˆã¨ä¸€è‡´ -> ãƒ•ã‚£ãƒ«ã‚¿ã§é™¤å¤–ã•ã‚Œã‚‹
        id: 'A005', asin: 'B00A005', productName: 'åŒ»ç™‚æ©Ÿå™¨ (è¦åˆ¶ãƒ»é«˜åˆ©ç›Š)', 
        rakutenPrice: 15000, amazonPrice: 22000, currentBSR: 100, purchaseStatus: 'pending', isExcluded: false
      },
      { // ğŸŒŸ åˆ©ç›Šç‡OK, å›è»¢ç‡OK (é«˜åˆ©ç›Šç‡)
        id: 'A006', asin: 'B00A006', productName: 'é™å®šç‰ˆDVD BOX', 
        rakutenPrice: 18000, amazonPrice: 28000, currentBSR: 4500, purchaseStatus: 'pending', isExcluded: false
      },
      { // ğŸ¯ éå»å®Ÿç¸¾ã‚ã‚Šå•†å“ (ã“ã®å•†å“ã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¯¾è±¡å¤–: soldã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹)
        id: 'A007', asin: 'B00A007', productName: 'ãƒªãƒ”ãƒ¼ãƒˆä»•å…¥ã‚Œç¢ºå®šå•†å“', 
        rakutenPrice: 5000, amazonPrice: 7500, currentBSR: 1000, purchaseStatus: 'sold', isExcluded: false
      },
    ];
    this.allProducts.set(mockProducts);
  }
}