import React, { useState, useEffect, useCallback, useMemo } from 'react';
// Firebase Imports
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, collection, query, where, onSnapshot, setDoc, updateDoc, deleteDoc, addDoc, serverTimestamp } from 'firebase/firestore';

// Lucide React Icons
import { Calendar, Apple, Dumbbell, Target, ClipboardCheck, Clock, CheckCircle, UploadCloud, Utensils, Zap, Heart, Activity, Settings, Plus, X, ListOrdered, Scale } from 'lucide-react';

// =================================================================
// 1. 環境設定とFirebase初期化
// =================================================================
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-health-app';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Firebaseサービスインスタンス (初期値はnull)
let app, auth, db;

// 栄養素推定のためのGemini APIエンドポイント
// NOTE: 実際の画像理解には base64ImageData が必要ですが、ここではモック処理とします。
const GEMINI_VISION_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;
const apiKey = "";

// =================================================================
// 2. モックデータと定数
// =================================================================

const INITIAL_GOALS = {
  calorie: 2000,
  protein: 100,
  fat: 60,
  carb: 250,
  salt: 6.0, // g
};

const TAB_OPTIONS = [
    { id: 'dashboard', icon: Target, name: '目標/概要' },
    { id: 'meal', icon: Utensils, name: '食事記録' },
    { id: 'calendar', icon: Calendar, name: 'カレンダー' },
    { id: 'recipe', icon: ListOrdered, name: '献立提案' },
    { id: 'healthcheck', icon: ClipboardCheck, name: '検診スケジュール' },
    { id: 'settings', icon: Settings, name: '設定' },
];

// =================================================================
// 3. ユーティリティ関数
// =================================================================

/** 栄養素推定 (Gemini APIのモック) */
const mockEstimateNutrition = async (base64Image, mealName) => {
    // 実際のAPI呼び出しロジックはここに入りますが、ここではモックを返します。
    // ユーザープロンプト: "この写真の食事（${mealName}）の推定栄養素をJSONで教えてください。"
    
    console.log("Gemini API: 栄養素を推定中... (モック)");

    // ランダムな栄養素を生成
    const randomFactor = Math.random() * 0.5 + 0.75; // 0.75から1.25の間
    return {
        calorie: Math.round(500 * randomFactor),
        protein: Math.round(25 * randomFactor),
        fat: Math.round(15 * randomFactor),
        carb: Math.round(70 * randomFactor),
        salt: (3.0 * randomFactor).toFixed(1),
        estimated: true,
    };
};

/** 日付を 'YYYY-MM-DD' 形式でフォーマット */
const formatDate = (date) => {
    const d = new Date(date);
    let month = '' + (d.getMonth() + 1);
    let day = '' + d.getDate();
    const year = d.getFullYear();

    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;

    return [year, month, day].join('-');
};

/** パーセンテージ計算 */
const calculatePercentage = (current, goal) => {
    if (goal <= 0) return 0;
    return Math.min(100, Math.round((current / goal) * 100));
};

// =================================================================
// 4. メインコンポーネント
// =================================================================

const App = () => {
    const [dbInstance, setDbInstance] = useState(null);
    const [authInstance, setAuthInstance] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [activeTab, setActiveTab] = useState('dashboard');
    const [meals, setMeals] = useState([]);
    const [exercises, setExercises] = useState([]);
    const [healthChecks, setHealthChecks] = useState([]);
    const [goals, setGoals] = useState(INITIAL_GOALS);
    const [recipes, setRecipes] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    // ----------------------------------------------------------------
    // 4.1. Firebase 初期化と認証
    // ----------------------------------------------------------------
    useEffect(() => {
        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setAuthInstance(auth);
                setDbInstance(db);

                // 認証状態の監視
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        // トークンがない場合、匿名サインインを試みる
                        const anonUser = await signInAnonymously(auth);
                        setUserId(anonUser.user.uid);
                    }
                    setIsAuthReady(true);
                    setLoading(false);
                });

                // カスタム認証トークンでのサインインを試行
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .catch((e) => {
                            console.error("Custom token sign-in failed, trying anonymous.", e);
                            signInAnonymously(auth).catch((ae) => console.error("Anonymous sign-in failed.", ae));
                        });
                }
                
                return () => unsubscribe();
            } else {
                setError("Firebase configuration is missing.");
                setLoading(false);
            }
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
            setError("Firebaseの初期化中にエラーが発生しました。");
            setLoading(false);
        }
    }, []);

    // ----------------------------------------------------------------
    // 4.2. データ取得 (Firestore onSnapshot)
    // ----------------------------------------------------------------
    useEffect(() => {
        if (!isAuthReady || !dbInstance || !userId) return;

        // Firestoreのパスを構築
        const userPath = `artifacts/${appId}/users/${userId}`;

        // データのリアルタイムリスナー設定
        const collections = [
            { name: 'meals', setter: setMeals },
            { name: 'exercises', setter: setExercises },
            { name: 'healthChecks', setter: setHealthChecks },
            { name: 'recipes', setter: setRecipes }
        ];

        const unsubscribers = collections.map(({ name, setter }) => {
            const q = query(collection(dbInstance, `${userPath}/${name}`));
            return onSnapshot(q, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // 日付で降順ソート
                data.sort((a, b) => new Date(b.date) - new Date(a.date));
                setter(data);
                if (loading) setLoading(false);
            }, (e) => {
                console.error(`Error fetching ${name}:`, e);
                setError(`${name}データの取得中にエラーが発生しました。`);
            });
        });

        // 目標設定の取得 (ドキュメント形式)
        const goalsDocRef = doc(dbInstance, `${userPath}/config/goals`);
        const unsubscribeGoals = onSnapshot(goalsDocRef, (docSnap) => {
            if (docSnap.exists()) {
                setGoals({ ...INITIAL_GOALS, ...docSnap.data() });
            } else {
                // 初回は初期値をセット
                setDoc(goalsDocRef, INITIAL_GOALS).catch(e => console.error("Goal set failed:", e));
            }
        });

        // クリーンアップ関数
        return () => {
            unsubscribers.forEach(unsub => unsub());
            unsubscribeGoals();
        };

    }, [isAuthReady, dbInstance, userId]);

    // ----------------------------------------------------------------
    // 4.3. データ操作関数
    // ----------------------------------------------------------------

    // 共通のデータ追加関数
    const addData = useCallback(async (collectionName, data) => {
        if (!dbInstance || !userId) return;
        try {
            const userPath = `artifacts/${appId}/users/${userId}`;
            await addDoc(collection(dbInstance, `${userPath}/${collectionName}`), {
                ...data,
                date: data.date || formatDate(new Date()),
                timestamp: serverTimestamp(),
            });
        } catch (e) {
            console.error(`Failed to add ${collectionName}:`, e);
            setError(`データの追加に失敗しました: ${collectionName}`);
        }
    }, [dbInstance, userId]);

    // 共通のデータ削除関数
    const deleteData = useCallback(async (collectionName, id) => {
        if (!dbInstance || !userId) return;
        try {
            const userPath = `artifacts/${appId}/users/${userId}`;
            await deleteDoc(doc(dbInstance, `${userPath}/${collectionName}`, id));
        } catch (e) {
            console.error(`Failed to delete ${collectionName}:`, e);
            setError(`データの削除に失敗しました: ${collectionName}`);
        }
    }, [dbInstance, userId]);

    // 目標の更新
    const updateGoals = useCallback(async (newGoals) => {
        if (!dbInstance || !userId) return;
        try {
            const userPath = `artifacts/${appId}/users/${userId}`;
            await updateDoc(doc(dbInstance, `${userPath}/config/goals`), newGoals);
        } catch (e) {
            console.error("Failed to update goals:", e);
            setError("目標の更新に失敗しました。");
        }
    }, [dbInstance, userId]);

    // ----------------------------------------------------------------
    // 4.4. 計算された値 (今日の集計など)
    // ----------------------------------------------------------------

    const todayDate = formatDate(new Date());

    const todayMeals = useMemo(() => meals.filter(m => m.date === todayDate), [meals, todayDate]);
    const todayExercises = useMemo(() => exercises.filter(e => e.date === todayDate), [exercises, todayDate]);

    // 今日の栄養素摂取量の集計
    const todayNutrition = useMemo(() => {
        const initial = { calorie: 0, protein: 0, fat: 0, carb: 0, salt: 0 };
        return todayMeals.reduce((acc, meal) => ({
            calorie: acc.calorie + (meal.calorie || 0),
            protein: acc.protein + (meal.protein || 0),
            fat: acc.fat + (meal.fat || 0),
            carb: acc.carb + (meal.carb || 0),
            salt: acc.salt + (parseFloat(meal.salt) || 0),
        }), initial);
    }, [todayMeals]);

    // 今日の運動消費カロリー
    const totalBurnedCalories = useMemo(() => {
        return todayExercises.reduce((sum, exercise) => sum + (exercise.calories || 0), 0);
    }, [todayExercises]);

    // 純摂取カロリー
    const netCalories = todayNutrition.calorie - totalBurnedCalories;

    // ----------------------------------------------------------------
    // 4.5. UIコンポーネント
    // ----------------------------------------------------------------

    // 共通のプログレスバー
    const ProgressBar = ({ label, current, goal, unit, color }) => {
        const percent = calculatePercentage(current, goal);
        const barColor = percent > 100 ? 'bg-red-500' : (color || 'bg-green-500');

        return (
            <div className="space-y-1">
                <div className="flex justify-between text-sm font-medium">
                    <span>{label}</span>
                    <span>{current.toFixed(1)}{unit} / {goal}{unit}</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2.5">
                    <div className={`${barColor} h-2.5 rounded-full`} style={{ width: `${percent}%` }}></div>
                </div>
                {percent > 100 && <p className="text-xs text-red-500 font-bold">目標オーバー！</p>}
            </div>
        );
    };

    // 栄養素入力モーダル
    const MealInputModal = ({ isVisible, onClose, initialData = {} }) => {
        const [name, setName] = useState(initialData.name || '');
        const [time, setTime] = useState(initialData.time || new Date().toTimeString().slice(0, 5));
        const [calorie, setCalorie] = useState(initialData.calorie || '');
        const [protein, setProtein] = useState(initialData.protein || '');
        const [fat, setFat] = useState(initialData.fat || '');
        const [carb, setCarb] = useState(initialData.carb || '');
        const [salt, setSalt] = useState(initialData.salt || '');
        const [mealDate, setMealDate] = useState(initialData.date || todayDate);
        const [imageFile, setImageFile] = useState(null);
        const [isEstimating, setIsEstimating] = useState(false);

        const handleImageUpload = (e) => {
            const file = e.target.files[0];
            if (file) {
                setImageFile(file);
                // 画像をbase64に変換し、栄養素推定APIを呼び出す
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const base64Image = reader.result.split(',')[1];
                    setIsEstimating(true);
                    try {
                        const estimated = await mockEstimateNutrition(base64Image, name || '未設定の食事');
                        setCalorie(estimated.calorie);
                        setProtein(estimated.protein);
                        setFat(estimated.fat);
                        setCarb(estimated.carb);
                        setSalt(estimated.salt);
                    } catch (e) {
                        console.error("Estimation failed:", e);
                        alert("栄養素の推定に失敗しました。手動で入力してください。");
                    } finally {
                        setIsEstimating(false);
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        const handleSubmit = () => {
            if (!name || !calorie) {
                alert('食事名とカロリーは必須です。');
                return;
            }
            const data = {
                name,
                time,
                date: mealDate,
                calorie: parseInt(calorie) || 0,
                protein: parseFloat(protein) || 0,
                fat: parseFloat(fat) || 0,
                carb: parseFloat(carb) || 0,
                salt: parseFloat(salt) || 0,
                // imageRef: imageFile ? "storage/path/to/image" : null, // 実際はFirebase Storageに保存
            };
            addData('meals', data);
            onClose();
        };

        if (!isVisible) return null;

        return (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl w-full max-w-lg p-6 shadow-2xl">
                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 className="text-xl font-bold text-gray-800">食事の記録と栄養素の推定</h3>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100">
                            <X className="w-5 h-5" />
                        </button>
                    </div>

                    <div className="space-y-4">
                        <input type="date" value={mealDate} onChange={(e) => setMealDate(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" />
                        <input type="time" value={time} onChange={(e) => setTime(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" />
                        <input type="text" placeholder="食事名 (例: 朝食、鶏むね肉のサラダ)" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" />

                        <div className="p-3 border border-red-300 rounded-lg bg-red-50">
                            <label className="block text-sm font-medium text-red-700 mb-2 flex items-center">
                                <UploadCloud className="w-4 h-4 mr-1" />
                                画像から栄養素を推定 (オプション)
                            </label>
                            <input type="file" accept="image/*" onChange={handleImageUpload} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-100 file:text-red-700 hover:file:bg-red-200" />
                            {isEstimating && <p className="mt-2 text-sm text-red-600 animate-pulse">AIが栄養素を推定中です...</p>}
                            {imageFile && <p className="mt-2 text-xs text-gray-500">画像: {imageFile.name} ({isEstimating ? '処理中' : '推定完了'})</p>}
                        </div>

                        <h4 className="font-semibold text-gray-700 border-b pb-1">栄養素 (半角数値入力)</h4>
                        <div className="grid grid-cols-2 gap-4">
                            <InputWithUnit label="カロリー (kcal)" value={calorie} onChange={setCalorie} type="number" />
                            <InputWithUnit label="タンパク質 (g)" value={protein} onChange={setProtein} type="number" />
                            <InputWithUnit label="脂質 (g)" value={fat} onChange={setFat} type="number" />
                            <InputWithUnit label="炭水化物 (g)" value={carb} onChange={setCarb} type="number" />
                            <InputWithUnit label="塩分 (g)" value={salt} onChange={setSalt} type="number" step="0.1" />
                        </div>
                    </div>

                    <button onClick={handleSubmit} className="mt-6 w-full py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150 flex items-center justify-center">
                        <CheckCircle className="w-5 h-5 mr-2" />
                        記録を保存
                    </button>
                </div>
            </div>
        );
    };

    // 運動入力モーダル
    const ExerciseInputModal = ({ isVisible, onClose }) => {
        const [name, setName] = useState('');
        const [duration, setDuration] = useState('');
        const [calories, setCalories] = useState('');
        const [exerciseDate, setExerciseDate] = useState(todayDate);

        const handleSubmit = () => {
            if (!name || !calories) {
                alert('運動名と消費カロリーは必須です。');
                return;
            }
            const data = {
                name,
                duration: parseInt(duration) || 0,
                calories: parseInt(calories) || 0,
                date: exerciseDate,
            };
            addData('exercises', data);
            onClose();
        };

        if (!isVisible) return null;

        return (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl">
                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 className="text-xl font-bold text-gray-800">運動の記録</h3>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100">
                            <X className="w-5 h-5" />
                        </button>
                    </div>

                    <div className="space-y-4">
                        <input type="date" value={exerciseDate} onChange={(e) => setExerciseDate(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" />
                        <input type="text" placeholder="運動名 (例: ランニング、筋トレ)" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" />
                        <InputWithUnit label="時間 (分)" value={duration} onChange={setDuration} type="number" />
                        <InputWithUnit label="消費カロリー (kcal)" value={calories} onChange={setCalories} type="number" color="blue" />
                    </div>

                    <button onClick={handleSubmit} className="mt-6 w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center">
                        <Dumbbell className="w-5 h-5 mr-2" />
                        記録を保存
                    </button>
                </div>
            </div>
        );
    };
    
    // 検診登録モーダル
    const HealthCheckInputModal = ({ isVisible, onClose }) => {
        const [name, setName] = useState('');
        const [date, setDate] = useState('');
        const [notes, setNotes] = useState('');

        const handleSubmit = () => {
            if (!name || !date) {
                alert('検診名と日付は必須です。');
                return;
            }
            const data = {
                name,
                date,
                notes,
                completed: false,
            };
            addData('healthChecks', data);
            onClose();
        };

        if (!isVisible) return null;

        return (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl">
                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 className="text-xl font-bold text-gray-800">健康診断・検診の登録</h3>
                        <button onClick={onClose} className="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100">
                            <X className="w-5 h-5" />
                        </button>
                    </div>

                    <div className="space-y-4">
                        <input type="text" placeholder="検診名 (例: 胃がん検診、定期健康診断)" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" />
                        <label className="block text-sm font-medium text-gray-700">予定日</label>
                        <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" />
                        <textarea placeholder="メモ (結果、病院名など)" value={notes} onChange={(e) => setNotes(e.target.value)} rows="3" className="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500"></textarea>
                    </div>

                    <button onClick={handleSubmit} className="mt-6 w-full py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150 flex items-center justify-center">
                        <ClipboardCheck className="w-5 h-5 mr-2" />
                        検診を登録
                    </button>
                </div>
            </div>
        );
    };

    // 共通インプットコンポーネント
    const InputWithUnit = ({ label, value, onChange, type = "text", unit = '', color = 'red', step = '1' }) => (
        <div>
            <label className="block text-sm font-medium text-gray-700">{label}</label>
            <div className="mt-1 relative rounded-md shadow-sm">
                <input
                    type={type}
                    value={value}
                    onChange={(e) => onChange(e.target.value)}
                    step={step}
                    className={`block w-full pr-10 p-2 border border-gray-300 rounded-lg focus:ring-${color}-500 focus:border-${color}-500`}
                />
                {unit && <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                    <span className="text-gray-500 sm:text-sm">{unit}</span>
                </div>}
            </div>
        </div>
    );
    
    // ----------------------------------------------------------------
    // 4.6. Tab Content: Dashboard
    // ----------------------------------------------------------------
    const DashboardTab = () => (
        <div className="space-y-6">
            <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 flex items-center"><Target className="w-6 h-6 mr-2 text-red-600" />今日の進捗（{todayDate}）</h2>

            {/* カロリーサマリー */}
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div className="bg-white p-4 rounded-xl shadow-md border-t-4 border-red-500">
                    <p className="text-sm text-gray-500">目標カロリー</p>
                    <p className="text-3xl font-extrabold text-red-600">{goals.calorie} <span className="text-base font-normal">kcal</span></p>
                </div>
                <div className="bg-white p-4 rounded-xl shadow-md border-t-4 border-green-500">
                    <p className="text-sm text-gray-500">摂取カロリー</p>
                    <p className="text-3xl font-extrabold text-green-600">{todayNutrition.calorie} <span className="text-base font-normal">kcal</span></p>
                </div>
                <div className="bg-white p-4 rounded-xl shadow-md border-t-4 border-blue-500">
                    <p className="text-sm text-gray-500">純摂取カロリー</p>
                    <p className="text-3xl font-extrabold text-blue-600">{netCalories} <span className="text-base font-normal">kcal</span></p>
                </div>
            </div>

            {/* 栄養素プログレスバー */}
            <div className="bg-gray-50 p-5 rounded-xl shadow-inner space-y-4">
                <h3 className="font-bold text-lg text-gray-700">主要栄養素の進捗</h3>
                <ProgressBar label="カロリー摂取" current={netCalories} goal={goals.calorie} unit="kcal" color="red" />
                <ProgressBar label="タンパク質摂取" current={todayNutrition.protein} goal={goals.protein} unit="g" color="purple" />
                <ProgressBar label="脂質摂取" current={todayNutrition.fat} goal={goals.fat} unit="g" color="yellow" />
                <ProgressBar label="炭水化物摂取" current={todayNutrition.carb} goal={goals.carb} unit="g" color="indigo" />
                <ProgressBar label="塩分摂取" current={todayNutrition.salt} goal={goals.salt} unit="g" color="red" />
            </div>

            {/* 今日の活動サマリー */}
            <div className="bg-white p-5 rounded-xl shadow-md border-l-4 border-gray-400">
                <h3 className="font-bold text-lg text-gray-700 flex items-center"><Activity className="w-5 h-5 mr-2 text-gray-500" />今日の活動</h3>
                <p className="mt-2 text-xl font-semibold text-blue-600">{totalBurnedCalories} kcal <span className="text-base font-normal text-gray-600">消費</span></p>
                <div className="mt-4 space-y-2 max-h-40 overflow-y-auto">
                    {todayExercises.length > 0 ? (
                        todayExercises.map(e => (
                            <div key={e.id} className="text-sm flex justify-between items-center p-2 bg-blue-50 rounded-lg">
                                <span>{e.name} ({e.duration}分)</span>
                                <span className="font-mono text-blue-800">-{e.calories} kcal</span>
                            </div>
                        ))
                    ) : (
                        <p className="text-gray-500 text-sm">今日はまだ運動記録がありません。</p>
                    )}
                </div>
            </div>

            {/* 今後の検診スケジュール */}
            <div className="bg-white p-5 rounded-xl shadow-md border-l-4 border-yellow-400">
                <h3 className="font-bold text-lg text-gray-700 flex items-center"><ClipboardCheck className="w-5 h-5 mr-2 text-yellow-500" />今後の検診スケジュール</h3>
                <div className="mt-4 space-y-2 max-h-40 overflow-y-auto">
                    {healthChecks.length > 0 ? (
                        healthChecks.filter(c => !c.completed).slice(0, 3).map(c => (
                            <div key={c.id} className="text-sm flex justify-between items-center p-2 bg-yellow-50 rounded-lg">
                                <span className="font-semibold">{c.name}</span>
                                <span className="text-yellow-800">{c.date}</span>
                            </div>
                        ))
                    ) : (
                        <p className="text-gray-500 text-sm">検診の登録がありません。</p>
                    )}
                </div>
                <button onClick={() => setActiveTab('healthcheck')} className="mt-4 text-sm text-red-600 hover:text-red-800 font-medium">
                    詳細スケジュールを見る →
                </button>
            </div>
        </div>
    );

    // ----------------------------------------------------------------
    // 4.7. Tab Content: Meal
    // ----------------------------------------------------------------
    const MealTab = () => {
        const [showMealModal, setShowMealModal] = useState(false);
        return (
            <div className="space-y-6">
                <div className="flex justify-between items-center border-b pb-2">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center"><Utensils className="w-6 h-6 mr-2 text-red-600" />食事の記録</h2>
                    <button onClick={() => setShowMealModal(true)} className="bg-red-600 text-white p-2 rounded-full shadow-lg hover:bg-red-700 transition duration-150">
                        <Plus className="w-6 h-6" />
                    </button>
                </div>

                <div className="bg-red-50 p-4 rounded-xl shadow-inner space-y-3">
                    <h3 className="font-bold text-lg text-gray-700">今日の食事サマリー</h3>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="text-sm font-semibold">カロリー: <span className="text-red-600">{todayNutrition.calorie} kcal</span></div>
                        <div className="text-sm font-semibold">塩分: <span className="text-red-600">{todayNutrition.salt.toFixed(1)} g</span></div>
                        <div className="text-sm font-semibold">タンパク質: <span className="text-red-600">{todayNutrition.protein.toFixed(1)} g</span></div>
                        <div className="text-sm font-semibold">炭水化物: <span className="text-red-600">{todayNutrition.carb.toFixed(1)} g</span></div>
                    </div>
                </div>

                <h3 className="font-bold text-xl text-gray-700">過去の食事記録 ({meals.length}件)</h3>
                <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                    {meals.length > 0 ? (
                        meals.map(meal => (
                            <div key={meal.id} className="bg-white p-4 rounded-xl shadow-md border-l-4 border-red-400 flex justify-between items-start">
                                <div className="space-y-1">
                                    <p className="text-xs text-gray-500 flex items-center"><Calendar className="w-3 h-3 mr-1" />{meal.date} <Clock className="w-3 h-3 ml-2 mr-1" />{meal.time}</p>
                                    <p className="text-lg font-bold text-gray-800">{meal.name}</p>
                                    <div className="text-sm text-gray-600 grid grid-cols-2 gap-x-4">
                                        <span><Zap className="w-3 h-3 inline mr-1 text-yellow-500" />{meal.calorie} kcal</span>
                                        <span><Scale className="w-3 h-3 inline mr-1 text-red-500" />塩分: {meal.salt.toFixed(1)}g</span>
                                    </div>
                                </div>
                                <button onClick={() => deleteData('meals', meal.id)} className="text-gray-400 hover:text-red-600 transition">
                                    <X className="w-4 h-4" />
                                </button>
                            </div>
                        ))
                    ) : (
                        <p className="text-gray-500 text-center py-10">まだ食事記録がありません。右上の＋ボタンから登録しましょう。</p>
                    )}
                </div>

                <MealInputModal isVisible={showMealModal} onClose={() => setShowMealModal(false)} />
            </div>
        );
    };

    // ----------------------------------------------------------------
    // 4.8. Tab Content: Calendar (簡易版)
    // ----------------------------------------------------------------
    const CalendarTab = () => {
        const [showExerciseModal, setShowExerciseModal] = useState(false);
        return (
            <div className="space-y-6">
                <div className="flex justify-between items-center border-b pb-2">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center"><Dumbbell className="w-6 h-6 mr-2 text-blue-600" />運動と活動記録</h2>
                    <button onClick={() => setShowExerciseModal(true)} className="bg-blue-600 text-white p-2 rounded-full shadow-lg hover:bg-blue-700 transition duration-150">
                        <Plus className="w-6 h-6" />
                    </button>
                </div>

                <div className="bg-blue-50 p-4 rounded-xl shadow-inner">
                    <h3 className="font-bold text-lg text-gray-700">今日の運動 ({todayDate})</h3>
                    <p className="mt-1 text-xl font-semibold text-blue-600">{totalBurnedCalories} kcal <span className="text-base font-normal text-gray-600">消費</span></p>
                </div>

                <h3 className="font-bold text-xl text-gray-700">過去の運動記録 ({exercises.length}件)</h3>
                <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                    {exercises.length > 0 ? (
                        exercises.map(exercise => (
                            <div key={exercise.id} className="bg-white p-4 rounded-xl shadow-md border-l-4 border-blue-400 flex justify-between items-start">
                                <div className="space-y-1">
                                    <p className="text-xs text-gray-500 flex items-center"><Calendar className="w-3 h-3 mr-1" />{exercise.date}</p>
                                    <p className="text-lg font-bold text-gray-800">{exercise.name} <span className="text-base font-normal text-gray-500">({exercise.duration}分)</span></p>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <span className="font-bold text-blue-600">{exercise.calories} kcal</span>
                                    <button onClick={() => deleteData('exercises', exercise.id)} className="text-gray-400 hover:text-red-600 transition">
                                        <X className="w-4 h-4" />
                                    </button>
                                </div>
                            </div>
                        ))
                    ) : (
                        <p className="text-gray-500 text-center py-10">まだ運動記録がありません。</p>
                    )}
                </div>

                <ExerciseInputModal isVisible={showExerciseModal} onClose={() => setShowExerciseModal(false)} />
            </div>
        );
    };

    // ----------------------------------------------------------------
    // 4.9. Tab Content: Health Check
    // ----------------------------------------------------------------
    const HealthCheckTab = () => {
        const [showCheckModal, setShowCheckModal] = useState(false);
        const upcomingChecks = healthChecks.filter(c => new Date(c.date) >= new Date(todayDate)).sort((a, b) => new Date(a.date) - new Date(b.date));
        const pastChecks = healthChecks.filter(c => new Date(c.date) < new Date(todayDate)).sort((a, b) => new Date(b.date) - new Date(a.date));

        const toggleComplete = async (check) => {
            if (!dbInstance || !userId) return;
            const userPath = `artifacts/${appId}/users/${userId}`;
            await updateDoc(doc(dbInstance, `${userPath}/healthChecks`, check.id), {
                completed: !check.completed
            });
        };

        return (
            <div className="space-y-6">
                <div className="flex justify-between items-center border-b pb-2">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center"><Heart className="w-6 h-6 mr-2 text-pink-600" />健康診断・検診スケジュール</h2>
                    <button onClick={() => setShowCheckModal(true)} className="bg-pink-600 text-white p-2 rounded-full shadow-lg hover:bg-pink-700 transition duration-150">
                        <Plus className="w-6 h-6" />
                    </button>
                </div>

                <div className="p-4 bg-pink-50 rounded-xl shadow-inner">
                    <h3 className="font-bold text-lg text-pink-800 mb-2">今後の予定 ({upcomingChecks.length}件)</h3>
                    {upcomingChecks.length > 0 ? (
                        upcomingChecks.map(c => (
                            <div key={c.id} className={`flex justify-between items-center p-3 my-2 rounded-lg ${c.completed ? 'bg-gray-200 line-through' : 'bg-white border border-pink-200'}`}>
                                <div>
                                    <p className="font-semibold">{c.name}</p>
                                    <p className="text-sm text-gray-600">{c.date}</p>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <button onClick={() => toggleComplete(c)} className={`text-sm py-1 px-3 rounded-full ${c.completed ? 'bg-gray-400 text-white' : 'bg-pink-100 text-pink-700 hover:bg-pink-200'}`}>
                                        {c.completed ? '完了済' : '完了にする'}
                                    </button>
                                    <button onClick={() => deleteData('healthChecks', c.id)} className="text-gray-400 hover:text-red-600">
                                        <X className="w-4 h-4" />
                                    </button>
                                </div>
                            </div>
                        ))
                    ) : (
                        <p className="text-sm text-gray-500">今後の検診の予定はありません。定期的なチェックアップを推奨します。</p>
                    )}
                </div>

                <h3 className="font-bold text-xl text-gray-700">過去の記録</h3>
                <div className="space-y-3 max-h-64 overflow-y-auto pr-2">
                    {pastChecks.length > 0 ? (
                        pastChecks.map(c => (
                            <div key={c.id} className="bg-white p-3 rounded-lg shadow-sm border-l-4 border-gray-400">
                                <p className="font-semibold">{c.name} ({c.date})</p>
                                <p className="text-sm text-gray-600">{c.notes || 'メモなし'}</p>
                            </div>
                        ))
                    ) : <p className="text-gray-500 text-sm">過去の検診記録がありません。</p>}
                </div>

                <HealthCheckInputModal isVisible={showCheckModal} onClose={() => setShowCheckModal(false)} />
            </div>
        );
    };

    // ----------------------------------------------------------------
    // 4.10. Tab Content: Recipe (献立提案)
    // ----------------------------------------------------------------
    const RecipeTab = () => {
        const [proposedMenu, setProposedMenu] = useState(null);
        const [isProposing, setIsProposing] = useState(false);
        const [showRecipeModal, setShowRecipeModal] = useState(false);

        // 献立自動提案 (Gemini APIのモック)
        const proposeMenu = async () => {
            setIsProposing(true);
            // 実際のAPIでは、今日の栄養素データ、目標、レシピDBの情報を送ります。
            // 例: "目標カロリー2000kcalに対し、今日1500kcal、タンパク質が不足しています。データベースのレシピから、それを補う夕食の献立をJSONで提案してください。"
            console.log("Gemini API: 献立提案を生成中... (モック)");

            await new Promise(resolve => setTimeout(resolve, 2000)); // API遅延をシミュレート

            setProposedMenu({
                date: todayDate,
                target: 'タンパク質と食物繊維を強化',
                meals: [
                    { name: "鶏むね肉とブロッコリーのレモン蒸し", notes: "高タンパク、低脂質で理想的です。", estimatedCalorie: 350 },
                    { name: "ワカメと豆腐の味噌汁", notes: "不足しがちなミネラルを補給。", estimatedCalorie: 80 },
                    { name: "玄米ご飯 (少量)", notes: "適度な炭水化物と食物繊維。", estimatedCalorie: 200 },
                ],
            });
            setIsProposing(false);
        };

        // レシピ登録モーダル
        const RecipeInputModal = ({ isVisible, onClose }) => {
            const [name, setName] = useState('');
            const [ingredients, setIngredients] = useState('');
            const [notes, setNotes] = useState('');

            const handleSubmit = () => {
                if (!name) {
                    alert('レシピ名は必須です。');
                    return;
                }
                const data = {
                    name,
                    ingredients: ingredients.split('\n').filter(i => i.trim() !== ''),
                    notes,
                };
                addData('recipes', data);
                onClose();
            };

            if (!isVisible) return null;
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 className="text-xl font-bold text-gray-800">レシピの登録 (DB拡充)</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100">
                                <X className="w-5 h-5" />
                            </button>
                        </div>
                        <div className="space-y-4">
                            <input type="text" placeholder="レシピ名" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg" />
                            <textarea placeholder="材料（改行で区切り）" value={ingredients} onChange={(e) => setIngredients(e.target.value)} rows="4" className="w-full p-2 border border-gray-300 rounded-lg"></textarea>
                            <textarea placeholder="調理手順・メモ" value={notes} onChange={(e) => setNotes(e.target.value)} rows="3" className="w-full p-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <button onClick={handleSubmit} className="mt-6 w-full py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">
                            レシピをDBに保存
                        </button>
                    </div>
                </div>
            );
        };

        return (
            <div className="space-y-6">
                 <div className="flex justify-between items-center border-b pb-2">
                    <h2 className="text-2xl font-bold text-gray-800 flex items-center"><ListOrdered className="w-6 h-6 mr-2 text-red-600" />献立提案とレシピDB</h2>
                    <button onClick={() => setShowRecipeModal(true)} className="bg-red-600 text-white p-2 rounded-full shadow-lg hover:bg-red-700 transition duration-150">
                        <Plus className="w-6 h-6" />
                    </button>
                </div>

                <div className="p-5 bg-green-50 rounded-xl shadow-md border-t-4 border-green-500 space-y-3">
                    <h3 className="font-bold text-xl text-green-800">栄養素に基づいた献立提案</h3>
                    <p className="text-sm text-gray-600">現在の栄養素の進捗を考慮し、目標達成のための献立を自動で提案します。</p>
                    <button onClick={proposeMenu} disabled={isProposing} className="w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-150 flex items-center justify-center disabled:opacity-50">
                        {isProposing ? (
                            <span className="flex items-center"><Zap className="w-5 h-5 mr-2 animate-pulse" />献立をAIに生成中...</span>
                        ) : (
                            <span className="flex items-center"><Apple className="w-5 h-5 mr-2" />献立を自動提案する</span>
                        )}
                    </button>

                    {proposedMenu && (
                        <div className="mt-4 bg-white p-4 rounded-lg border border-green-300">
                            <p className="font-semibold text-green-700 mb-2">提案日: {proposedMenu.date} | 強化目標: {proposedMenu.target}</p>
                            <ul className="space-y-2">
                                {proposedMenu.meals.map((meal, index) => (
                                    <li key={index} className="border-b pb-2">
                                        <p className="font-bold text-gray-800">{meal.name}</p>
                                        <p className="text-sm text-gray-600">メモ: {meal.notes}</p>
                                        <p className="text-xs text-gray-500">推定: {meal.estimatedCalorie} kcal</p>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>

                <h3 className="font-bold text-xl text-gray-700">マイレシピデータベース ({recipes.length}件)</h3>
                <div className="space-y-3 max-h-64 overflow-y-auto pr-2">
                    {recipes.length > 0 ? (
                        recipes.map(r => (
                            <div key={r.id} className="bg-white p-3 rounded-lg shadow-sm border-l-4 border-red-400 flex justify-between items-center">
                                <p className="font-semibold">{r.name}</p>
                                <button onClick={() => deleteData('recipes', r.id)} className="text-gray-400 hover:text-red-600">
                                    <X className="w-4 h-4" />
                                </button>
                            </div>
                        ))
                    ) : <p className="text-gray-500 text-sm">レシピデータベースに登録がありません。献立提案の精度向上のため、ぜひ登録してください。</p>}
                </div>
                <RecipeInputModal isVisible={showRecipeModal} onClose={() => setShowRecipeModal(false)} />
            </div>
        );
    };

    // ----------------------------------------------------------------
    // 4.11. Tab Content: Settings (目標設定)
    // ----------------------------------------------------------------
    const SettingsTab = () => {
        const [currentGoals, setCurrentGoals] = useState(goals);

        useEffect(() => {
            setCurrentGoals(goals);
        }, [goals]);

        const handleSave = () => {
            updateGoals(currentGoals);
            alert('新しい目標が保存されました。');
        };

        return (
            <div className="space-y-6">
                <h2 className="text-2xl font-bold text-gray-800 border-b pb-2 flex items-center"><Settings className="w-6 h-6 mr-2 text-gray-600" />健康目標の設定</h2>

                <div className="bg-white p-5 rounded-xl shadow-md space-y-4">
                    <h3 className="font-bold text-xl text-red-600">デイリー栄養目標</h3>
                    <p className="text-sm text-gray-600">ここに設定された目標値に基づいて、ダッシュボードの進捗が計算されます。</p>

                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <InputWithUnit label="カロリー (kcal)" value={currentGoals.calorie} onChange={(v) => setCurrentGoals(prev => ({ ...prev, calorie: parseInt(v) || 0 }))} type="number" color="red" />
                        <InputWithUnit label="タンパク質 (g)" value={currentGoals.protein} onChange={(v) => setCurrentGoals(prev => ({ ...prev, protein: parseFloat(v) || 0 }))} type="number" color="purple" />
                        <InputWithUnit label="脂質 (g)" value={currentGoals.fat} onChange={(v) => setCurrentGoals(prev => ({ ...prev, fat: parseFloat(v) || 0 }))} type="number" color="yellow" />
                        <InputWithUnit label="炭水化物 (g)" value={currentGoals.carb} onChange={(v) => setCurrentGoals(prev => ({ ...prev, carb: parseFloat(v) || 0 }))} type="number" color="indigo" />
                        <InputWithUnit label="塩分 (g)" value={currentGoals.salt} onChange={(v) => setCurrentGoals(prev => ({ ...prev, salt: parseFloat(v) || 0 }))} type="number" step="0.1" color="red" />
                    </div>

                    <button onClick={handleSave} className="mt-6 w-full py-3 bg-gray-700 text-white font-bold rounded-lg hover:bg-gray-800 transition duration-150 flex items-center justify-center">
                        <CheckCircle className="w-5 h-5 mr-2" />
                        目標を保存
                    </button>
                </div>
                
                {/* ログイン情報表示 */}
                <div className="text-xs text-gray-500 border-t pt-4">
                    <p>ユーザーID: <span className="font-mono text-gray-700">{userId || '認証待ち...'}</span></p>
                </div>
            </div>
        );
    };

    // ----------------------------------------------------------------
    // 4.12. メインレンダリング
    // ----------------------------------------------------------------

    const renderContent = () => {
        if (loading) {
            return <div className="p-8 text-center text-gray-500">データを読み込み中...</div>;
        }
        if (error) {
            return <div className="p-8 text-center text-red-600 font-bold">エラー: {error}</div>;
        }

        switch (activeTab) {
            case 'dashboard':
                return <DashboardTab />;
            case 'meal':
                return <MealTab />;
            case 'calendar':
                return <CalendarTab />;
            case 'recipe':
                return <RecipeTab />;
            case 'healthcheck':
                return <HealthCheckTab />;
            case 'settings':
                return <SettingsTab />;
            default:
                return <DashboardTab />;
        }
    };

    return (
        <div className="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8">
            <div className="max-w-5xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden">
                {/* ヘッダーとナビゲーション */}
                <header className="bg-red-600 p-4 sm:p-6 shadow-lg">
                    <h1 className="text-3xl font-extrabold text-white">健康管理ダッシュボード</h1>
                </header>
                
                {/* タブナビゲーション */}
                <nav className="bg-white border-b border-gray-200 sticky top-0 z-10 overflow-x-auto">
                    <div className="flex justify-start sm:justify-center">
                        {TAB_OPTIONS.map((tab) => {
                            const Icon = tab.icon;
                            const isActive = activeTab === tab.id;
                            return (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex-shrink-0 flex items-center px-4 py-3 sm:px-6 border-b-4 transition duration-150 ${
                                        isActive
                                            ? 'border-red-600 text-red-600 font-bold bg-red-50'
                                            : 'border-transparent text-gray-500 hover:text-red-600 hover:border-red-200'
                                    }`}
                                >
                                    <Icon className="w-5 h-5 mr-1" />
                                    <span className="text-sm font-medium">{tab.name}</span>
                                </button>
                            );
                        })}
                    </div>
                </nav>

                {/* タブコンテンツ */}
                <main className="p-4 sm:p-6 lg:p-8">
                    {renderContent()}
                </main>
            </div>
        </div>
    );
};

export default App;
