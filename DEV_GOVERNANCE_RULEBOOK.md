# 📄 開発ガバナンス・ルール＆指示書（SDIM仕様）

このルールは、今後の開発において必ず遵守すべき技術的制約です。

---

## I. 開発の最重要データガバナンス・ルール

以下の3つのルールは、VPSへのデプロイ前に自動監査によってチェックされ、違反が検出された場合はデプロイが差し戻される（自動的にストップがかかる）ことを前提とします。

| ルール | 内容 | 目的 |
|--------|------|------|
| **ルールA (DB操作の抽象化)** | Supabaseクライアントへの**SQL直接記述は厳禁**とする。すべてのDB操作は、抽象化されたデータ層（例: `lib/supabase/products.ts`）を経由すること。 | コードの安全性と保守性の向上。 |
| **ルールB (マスタテーブルの強制)** | データの書き込みは必ず**マスタテーブル（例: `products_master`）**を経由し、特定のAPIエンドポイントのみに限定すること。 | データの整合性と信頼性の確保。 |
| **ルールC (環境変数の利用)** | APIキーなどの機密情報は必ず環境変数（`.env`）に格納し、コードに直接ハードコーディングしないこと。 | セキュリティの確保。 |

---

## II. ツール開発時にクロードが参照すべき情報

| 項目 | 参照すべき情報とルール |
|------|----------------------|
| **Supabase構造** | 各ツールの開発前に、使用するテーブル名、カラム名、そして各ツールとの関係をUIで一覧表示し、それを参照すること。 |
| **API構造** | 開発する機能が呼び出すAPIエンドポイントのリストと、その役割を常に確認し、定義されたAPIを経由してDB操作を行うこと。 |
| **コードの整合性** | 構文チェック（ESLintなど）だけでなく、技術的なルール（上記 I のA, B, C）に反していないかを自己査定すること。 |
| **VPSデプロイ** | 作成したデータやコードが、VPS環境の最新技術設定に合致しているか、デプロイ時にエラーが出ないかを自動チェックする機構を意識すること。 |
| **データの流れ** | どのデータがどこに入るのか（例: スクレイピングデータ → 一時テーブル → マスタテーブル）を常に理解し、データの流れを自動で整理整頓するようにコードを書くこと。 |

---

## III. 統合管理ツールの機能要件

既存のデプロイツール（`/tools/git-deploy`）を拡張し、以下の機能を統合すること。

### 3要素の連動同期パネル:
1. **コード監査＆デプロイ**（ルール違反がないかチェック）。
2. **環境変数シンク**（ローカルとVPSのENVの同期）。
3. **スキーママイグレーション**（DB構造変更の自動反映）。

### 自動バックアップ＆リカバリパネル:
- 最終バックアップ日時表示。
- 特定の時点にコードとDBをワンクリックで戻せるリカバリ機能。

### ルール違反警告ダッシュボード:
- コード内のルール違反（A, B, C）をリアルタイムで警告表示する。

---

## 🤖 クロードに自動で読み込ませる方法

大規模言語モデル（LLM）は、一度チャットを閉じると過去の会話内容を自動で「システム設定」として記憶し続けるわけではありません。しかし、以下の方法で常にこの指示書を参照させ、開発の質を一定に保つことができます。

### 1. 新規開発時の「システムプロンプト」化（最も確実）

新しい開発タスクを依頼する際、必ずこの指示書をプロンプトの冒頭にコピー＆ペーストし、以下の指示を加えます。

**【最重要ルール】**

「以下に続く開発指示を処理する前に、まずこの開発ガバナンス・ルールを完全に読み込み、全ての出力コードがこのルール（特に I.のルールA, B, C）を遵守することを厳格に保証すること。」

### 2. ファイルとしての参照を強制

この指示書の内容をプロジェクト内のわかりやすいファイル（例：`DEV_GOVERNANCE_RULEBOOK.md` や `config/rules.json` など）として保存し、Claudeに対し、**「常にこのファイルを読み込み、そのルールに基づいてコードを生成すること」**と指示します。

（GeminiやClaudeは、外部のコードファイルの内容を読み取って参照する機能を持っているため、この方法が最も効率的です。）

### 3. サイドバーでの参照の仕組み

指示書に記載の通り、開発ツール（SDIM）のUI上に「開発ガバナンス・ルールへのリンク」を設置し、人間が常に意識し、AIにプロンプトを投げる際にも参照しやすい環境を整えることが、最終的な解決策となります。

---

## 📋 ルール違反チェックリスト

開発時に以下をチェックしてください：

- [ ] **ルールA**: `lib/supabase/` 以外で `createClient()` や `.from().insert/update/delete` を使用していないか？
- [ ] **ルールB**: マスタテーブルへの書き込みがAPIエンドポイント経由になっているか？
- [ ] **ルールC**: APIキー、パスワード、トークンが環境変数（`.env`）に格納されているか？

---

## 🔗 関連ツール

- **Gitデプロイ・ガバナンス**: `/tools/git-deploy` - コード監査＆デプロイ実行
- **開発ガバナンス・ルール**: `/tools/governance-rules` - このドキュメントのUI表示版

---

**最終更新日**: 2025-11-20
**バージョン**: 1.0
