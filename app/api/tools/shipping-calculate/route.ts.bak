// app/api/tools/shipping-calculate/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { supabase } from '@/lib/supabase'
import { calculateUsaPriceV3 } from '@/lib/ebay-pricing/usa-price-calculator-v3'

export async function POST(request: NextRequest) {
  try {
    const { productIds } = await request.json()

    if (!productIds || !Array.isArray(productIds) || productIds.length === 0) {
      return NextResponse.json(
        { error: 'å•†å“IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 400 }
      )
    }

    console.log(`ğŸ“¦ USA DDPé€æ–™è¨ˆç®—é–‹å§‹: ${productIds.length}ä»¶`)

    // å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const { data: products, error: fetchError } = await supabase
      .from('products')
      .select('*')
      .in('id', productIds)

    if (fetchError) throw fetchError

    const updated: string[] = []
    const errors: any[] = []

    // å„å•†å“ã®é€æ–™è¨ˆç®—
    for (const product of products || []) {
      try {
        const listingData = product.listing_data || {}
        const weight_g = listingData.weight_g
        const price_jpy = product.price_jpy
        
        // å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
        if (!weight_g || !price_jpy) {
          console.warn(`âš ï¸ é‡é‡ã¾ãŸã¯ä¾¡æ ¼æƒ…å ±ä¸è¶³: ${product.title}`)
          errors.push({ 
            id: product.id, 
            error: 'é‡é‡ã¾ãŸã¯ä¾¡æ ¼æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™' 
          })
          continue
        }

        console.log(`ğŸ” USA DDPè¨ˆç®—: ${product.title}`)
        console.log(`   ä»•å…¥: ${price_jpy}å††, é‡é‡: ${weight_g}g (${(weight_g/1000).toFixed(2)}kg)`)

        // ğŸ‡ºğŸ‡¸ USA DDPä¾¡æ ¼è¨ˆç®—ï¼ˆç²¾å¯†ç‰ˆV3ï¼‰
        const usaPriceResult = await calculateUsaPriceV3({
          costJPY: price_jpy,
          weight_kg: weight_g / 1000,  // gã‚’kgã«å¤‰æ›
          length_cm: listingData.length_cm || 30,
          width_cm: listingData.width_cm || 20,
          height_cm: listingData.height_cm || 15,
          hsCode: listingData.hs_code || '9620.00.20.00',
          originCountry: 'JP',
          targetMargin: 15,  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ15%
          exchangeRate: 150  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ150å††/USD
        })

        if (!usaPriceResult.success) {
          throw new Error(usaPriceResult.error || 'USA DDPè¨ˆç®—å¤±æ•—')
        }

        console.log(`ğŸ’° USA DDPè¨ˆç®—çµæœ:`)
        console.log(`   ãƒãƒªã‚·ãƒ¼å: ${usaPriceResult.policy?.name}`)
        console.log(`   å•†å“ä¾¡æ ¼: $${usaPriceResult.productPrice?.toFixed(2)}`)
        console.log(`   DDPé€æ–™: $${usaPriceResult.shipping?.toFixed(2)}`)
        console.log(`   ç·å£²ä¸Š: $${usaPriceResult.totalRevenue?.toFixed(2)}`)
        console.log(`   åˆ©ç›Šç‡: ${usaPriceResult.profitMargin_NoRefund?.toFixed(2)}%`)

        // listing_dataã‚’æ›´æ–°ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼‰
        const updatedListingData = {
          ...listingData,
          // ğŸ¯ æœ€é‡è¦: ãƒãƒªã‚·ãƒ¼å
          usa_shipping_policy_name: usaPriceResult.policy?.name || null,
          // ä¾¡æ ¼æƒ…å ±
          ddp_price_usd: usaPriceResult.totalRevenue || 0,
          product_price_usd: usaPriceResult.productPrice || 0,
          // é€æ–™æƒ…å ±
          shipping_cost_usd: usaPriceResult.shipping || 0,
          shipping_service: 'USA DDP (RT Express)',
          // åˆ©ç›Šæƒ…å ±
          profit_margin: usaPriceResult.profitMargin_NoRefund || 0,
          profit_amount_usd: usaPriceResult.profitUSD_NoRefund || 0
        }

        const { error: updateError } = await supabase
          .from('products')
          .update({
            listing_data: updatedListingData,
            // ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã«ã‚‚ä¿å­˜ï¼ˆæ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆç”¨ï¼‰
            profit_margin: usaPriceResult.profitMargin_NoRefund,
            profit_amount_usd: usaPriceResult.profitUSD_NoRefund,
            updated_at: new Date().toISOString()
          })
          .eq('id', product.id)

        if (updateError) throw updateError

        updated.push(product.id)
        console.log(`âœ… USA DDPè¨ˆç®—å®Œäº†: ${product.title}`)

      } catch (err: any) {
        console.error(`âŒ USA DDPè¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${product.title}`, err)
        errors.push({ id: product.id, error: err.message })
      }
    }

    console.log(`ğŸ“Š USA DDPè¨ˆç®—å®Œäº†: ${updated.length}ä»¶æˆåŠŸ, ${errors.length}ä»¶å¤±æ•—`)

    return NextResponse.json({
      success: true,
      updated: updated.length,
      failed: errors.length,
      errors: errors.length > 0 ? errors : undefined
    })

  } catch (error: any) {
    console.error('âŒ USA DDPè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error)
    return NextResponse.json(
      { error: error.message || 'USA DDPè¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ' },
      { status: 500 }
    )
  }
}
