// components/ebay-pricing/calculator-tab-complete.tsx
'use client'

import { Calculator, CheckCircle, XCircle, AlertTriangle, HelpCircle, TrendingUp, DollarSign, ArrowRight, Settings, Percent } from 'lucide-react'
import { STORE_FEES } from '@/app/ebay-pricing/page'
import { useState, useMemo, useEffect } from 'react'

interface CalculatorTabProps {
  formData: any
  onInputChange: (field: string, value: any) => void
  onCalculate: (adjustments?: {
    targetProfitMargin: number
    costAdjustmentPercent: number
    shippingAdjustmentPercent: number
    otherCostAdjustmentPercent: number
    adjustedCostJPY: number
  }) => void
  resultDDP: any
  resultDDU: any
  hsCodes: any[]
  countries: any[]
  categoryFees: any[]
}

// ç¨ç‡ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
const TAX_RATE_GROUPS = [
  { rate: 0, label: '0% (ç„¡ç¨)', color: 'text-green-600' },
  { rate: 2.5, label: '2.5%', color: 'text-blue-600' },
  { rate: 4.5, label: '4.5%', color: 'text-indigo-600' },
  { rate: 5.3, label: '5.3%', color: 'text-purple-600' },
  { rate: 6.5, label: '6.5%', color: 'text-pink-600' },
  { rate: 10, label: '10%', color: 'text-orange-600' },
  { rate: 15, label: '15%ä»¥ä¸Š', color: 'text-red-600' },
]

export function CalculatorTabComplete({
  formData,
  onInputChange,
  onCalculate,
  resultDDP,
  resultDDU,
  hsCodes,
  countries,
  categoryFees,
}: CalculatorTabProps) {
  const [selectedTaxRate, setSelectedTaxRate] = useState<number | null>(null)
  const [fvfRates, setFvfRates] = useState<number[]>([0.035, 0.0635, 0.1315, 0.1495, 0.15])

  // ğŸ†• ç›®æ¨™åˆ©ç›Šç‡ãƒ»èª¿æ•´ï¼…
  const [targetProfitMargin, setTargetProfitMargin] = useState<number>(15)
  const [costAdjustmentPercent, setCostAdjustmentPercent] = useState<number>(0)
  const [shippingAdjustmentPercent, setShippingAdjustmentPercent] = useState<number>(0)
  const [otherCostAdjustmentPercent, setOtherCostAdjustmentPercent] = useState<number>(0)

  // ğŸ†• è©³ç´°è¨­å®šè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  const [showAdvancedSettings, setShowAdvancedSettings] = useState(false)

  // âœ… é…é€ãƒãƒªã‚·ãƒ¼é–¢é€£ï¼ˆå®Œå…¨ç‰ˆï¼‰
  const [shippingPolicies, setShippingPolicies] = useState<any[]>([])
  const [selectedPolicyId, setSelectedPolicyId] = useState<number | null>(null)
  const [policyZoneRates, setPolicyZoneRates] = useState<any[]>([])
  const [loadingPolicies, setLoadingPolicies] = useState(false)
  const [autoSelectedPolicy, setAutoSelectedPolicy] = useState<any>(null)
  const [policyDebugInfo, setPolicyDebugInfo] = useState<string>('')

  // FVFç‡ã‚’APIã‹ã‚‰å–å¾—
  useEffect(() => {
    fetch('/api/ebay/get-unique-fvf-rates')
      .then(r => r.json())
      .then(data => {
        if (data.rates && data.rates.length > 0) {
          setFvfRates(data.rates)
        }
      })
      .catch(err => console.error('FVFç‡å–å¾—ã‚¨ãƒ©ãƒ¼:', err))
  }, [])

  // ğŸ†• é…é€ãƒãƒªã‚·ãƒ¼å–å¾—ï¼ˆåˆå›ã®ã¿ï¼‰
  useEffect(() => {
    setLoadingPolicies(true)
    fetch('/api/ebay/get-shipping-policies')
      .then(r => r.json())
      .then(data => {
        if (data.policies) {
          setShippingPolicies(data.policies)
        }
      })
      .catch(err => console.error('é…é€ãƒãƒªã‚·ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', err))
      .finally(() => setLoadingPolicies(false))
  }, [])

  // âœ… æ–°ãƒ­ã‚¸ãƒƒã‚¯: é‡é‡ + å•†å“ä¾¡æ ¼ã§æœ€é©ãªãƒãƒªã‚·ãƒ¼ã‚’è‡ªå‹•é¸æŠ
  useEffect(() => {
    // é‡é‡ã¨åŸä¾¡ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if (!formData.actualWeight || !formData.costJPY || !formData.exchangeRate) {
      setPolicyDebugInfo('')
      return
    }

    const weight = formData.actualWeight
    // ä»®ã®è²©å£²ä¾¡æ ¼ã‚’è¨ˆç®—ï¼ˆåŸä¾¡Ã—1.5ã‚’æƒ³å®šï¼‰
    const estimatedPriceUSD = (formData.costJPY / formData.exchangeRate) * 1.5

    // APIã§æœ€é©ãªãƒãƒªã‚·ãƒ¼ã‚’å–å¾—
    fetch('/api/ebay/select-shipping-policy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        weight: weight,
        itemPriceUSD: estimatedPriceUSD,
        quantity: 1
      })
    })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          // ãƒãƒªã‚·ãƒ¼ã‚’è‡ªå‹•é¸æŠ
          setAutoSelectedPolicy(data.policy)
          setSelectedPolicyId(data.policy.id)
          
          // é€æ–™ã‚’è‡ªå‹•è¨­å®š
          if (data.shipping?.usa?.total) {
            onInputChange('shippingFeeUSD', data.shipping.usa.total)
          }
          if (data.shipping?.other?.total) {
            onInputChange('otherShippingFeeUSD', data.shipping.other.total)
          }

          // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
          const debugMsg = `âœ… ${data.policy.pricing_basis} ${data.policy.price_band || ''} | ${weight}kg | $${estimatedPriceUSD.toFixed(0)} | ${data.policy.name}`
          setPolicyDebugInfo(debugMsg)
          console.log('é…é€ãƒãƒªã‚·ãƒ¼è‡ªå‹•é¸æŠ:', data)
        } else {
          setPolicyDebugInfo(`âŒ ãƒãƒªã‚·ãƒ¼é¸æŠå¤±æ•—: ${data.error || 'Unknown error'}`)
          console.error('ãƒãƒªã‚·ãƒ¼é¸æŠã‚¨ãƒ©ãƒ¼:', data)
        }
      })
      .catch(err => {
        setPolicyDebugInfo(`âŒ API ã‚¨ãƒ©ãƒ¼: ${err.message}`)
        console.error('ãƒãƒªã‚·ãƒ¼é¸æŠAPIã‚¨ãƒ©ãƒ¼:', err)
      })
  }, [formData.actualWeight, formData.costJPY, formData.exchangeRate])

  // ğŸ†• é¸æŠã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼ã®ZONEåˆ¥é€æ–™ã‚’å–å¾—ï¼ˆæ‰‹å‹•é¸æŠæ™‚ã®ã¿ï¼‰
  useEffect(() => {
    if (selectedPolicyId && !autoSelectedPolicy) {
      fetch(`/api/ebay/get-policy-zone-rates?policyId=${selectedPolicyId}`)
        .then(r => r.json())
        .then(data => {
          if (data.rates) {
            setPolicyZoneRates(data.rates)
          }
        })
        .catch(err => console.error('ZONEåˆ¥é€æ–™å–å¾—ã‚¨ãƒ©ãƒ¼:', err))
    }
  }, [selectedPolicyId])

  // ç¨ç‡ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸHTSã‚³ãƒ¼ãƒ‰
  const filteredHsCodes = useMemo(() => {
    if (selectedTaxRate === null) return hsCodes
    
    if (selectedTaxRate === 15) {
      return hsCodes.filter((hs: any) => (hs.base_duty || 0) >= 0.15)
    }
    
    const tolerance = 0.001
    return hsCodes.filter((hs: any) => 
      Math.abs((hs.base_duty || 0) - selectedTaxRate / 100) < tolerance
    )
  }, [hsCodes, selectedTaxRate])

  const selectedHsCode = hsCodes.find((hs: any) => hs.code === formData.hsCode)
  const selectedStore = STORE_FEES[formData.storeType as keyof typeof STORE_FEES]
  const selectedCountry = countries.find((c: any) => c.code === formData.originCountry)

  const adjustedCostJPY = useMemo(() => {
    const base = formData.costJPY
    return base * (1 + costAdjustmentPercent / 100)
  }, [formData.costJPY, costAdjustmentPercent])

  const adjustedShippingUSD = useMemo(() => {
    if (!selectedPolicyId || policyZoneRates.length === 0) {
      return { usa: formData.shippingFeeUSD || 0, other: formData.otherShippingFeeUSD || 0 }
    }
    const usaRate = policyZoneRates.find((r: any) => r.zone_code === 'US')
    const otherRate = policyZoneRates.find((r: any) => r.zone_type === 'OTHER' || r.zone_code === 'FA')
    
    const baseUsaShipping = usaRate ? (usaRate.first_item_shipping_usd || usaRate.display_shipping_usd) : formData.shippingFeeUSD || 0
    const baseOtherShipping = otherRate ? (otherRate.first_item_shipping_usd || otherRate.display_shipping_usd) : formData.otherShippingFeeUSD || 0
    
    return {
      usa: baseUsaShipping * (1 + shippingAdjustmentPercent / 100),
      other: baseOtherShipping * (1 + shippingAdjustmentPercent / 100)
    }
  }, [selectedPolicyId, policyZoneRates, shippingAdjustmentPercent, formData.shippingFeeUSD, formData.otherShippingFeeUSD])

  useEffect(() => {
    if (adjustedShippingUSD.usa !== formData.shippingFeeUSD) {
      onInputChange('shippingFeeUSD', adjustedShippingUSD.usa)
    }
    if (adjustedShippingUSD.other !== formData.otherShippingFeeUSD) {
      onInputChange('otherShippingFeeUSD', adjustedShippingUSD.other)
    }
  }, [adjustedShippingUSD])

  const calculateTaxRefund = (costJPY: number, estimatedRevenueUSD: number, exchangeRateValue: number) => {
    const estimatedEbayFees = estimatedRevenueUSD * formData.fvfRate
    const estimatedPayoneerFees = estimatedRevenueUSD * 0.02
    const totalDeductibleExpensesJPY = costJPY + (estimatedEbayFees + estimatedPayoneerFees) * exchangeRateValue
    return (totalDeductibleExpensesJPY * 10) / 110
  }

  const estimatedRevenueUSD = ((adjustedCostJPY / 150) * 1.5) || 100
  const taxRefund = calculateTaxRefund(adjustedCostJPY, estimatedRevenueUSD, 150)

  const getRecommendation = () => {
    if (!resultDDP?.success || !resultDDU?.success) return null

    const ddpProfit = resultDDP.profitJPY_NoRefund
    const dduProfit = resultDDU.profitJPY_NoRefund
    const profitDiff = ddpProfit - dduProfit
    const profitDiffPercent = (profitDiff / Math.max(ddpProfit, dduProfit)) * 100

    let recommendation = 'DDP'
    let reason = ''
    let confidence = 'high'

    if (Math.abs(profitDiffPercent) > 10) {
      recommendation = profitDiff > 0 ? 'DDP' : 'DDU'
      reason = `åˆ©ç›Šå·®ãŒå¤§ãã„ï¼ˆ${Math.abs(profitDiff).toFixed(0)}å††ã€${Math.abs(profitDiffPercent).toFixed(1)}%ï¼‰`
      confidence = 'high'
    }
    else if (resultDDU.shipping > 30) {
      recommendation = 'DDU'
      reason = `é€æ–™ãŒé«˜é¡ï¼ˆ$${resultDDU.shipping}ï¼‰ã®ãŸã‚DDUç€æ‰•ã„ãŒè‡ªç„¶`
      confidence = 'medium'
    }
    else if (parseFloat(resultDDP.breakdown?.tariff || 0) > 20) {
      recommendation = 'DDU'
      reason = `é–¢ç¨ãŒé«˜é¡ï¼ˆ$${resultDDP.breakdown?.tariff}ï¼‰ã®ãŸã‚è³¼å…¥è€…è² æ‹…ãŒè‡ªç„¶`
      confidence = 'medium'
    }
    else if (resultDDP.profitMargin_NoRefund < 0.15) {
      recommendation = 'DDP'
      reason = 'åˆ©ç›Šç‡ãŒä½ã„ãŸã‚é–¢ç¨è¾¼ã¿ã§ç¢ºå®Ÿã«åˆ©ç›Šç¢ºä¿'
      confidence = 'medium'
    }
    else {
      recommendation = 'DDP'
      reason = 'åŸºæœ¬çš„ã«DDPï¼ˆé–¢ç¨è¾¼ã¿ï¼‰ãŒæ¨å¥¨ã€USAå¸‚å ´ã§ã®æ¨™æº–'
      confidence = 'low'
    }

    return {
      recommendation,
      reason,
      confidence,
      profitDiff,
      profitDiffPercent,
    }
  }

  const recommendation = getRecommendation()

  return (
    <div className="space-y-4">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-lg shadow-lg">
        <h2 className="text-2xl font-bold flex items-center gap-2">
          <Calculator className="w-7 h-7" />
          eBay DDP/DDU ä¾¡æ ¼è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆå®Œå…¨ç‰ˆï¼‰
        </h2>
        <p className="text-indigo-100 text-sm mt-1">
          ä¾¡æ ¼å¸¯ + é‡é‡ + é–¢ç¨ã§æœ€é©ãªãƒãƒªã‚·ãƒ¼ã‚’è‡ªå‹•é¸æŠ | DBã‹ã‚‰é€æ–™ã‚’å–å¾—
        </p>
      </div>

      {/* ğŸ†• é…é€ãƒãƒªã‚·ãƒ¼è‡ªå‹•é¸æŠè¡¨ç¤º */}
      {policyDebugInfo && (
        <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
          <h3 className="text-lg font-bold text-blue-800 mb-2">ğŸ“¦ è‡ªå‹•é¸æŠã•ã‚ŒãŸé…é€ãƒãƒªã‚·ãƒ¼</h3>
          <div className="text-sm text-blue-900">{policyDebugInfo}</div>
          {autoSelectedPolicy && (
            <div className="mt-2 grid grid-cols-3 gap-2 text-xs">
              <div className="bg-white p-2 rounded">
                <div className="text-gray-600">æ–¹å¼</div>
                <div className="font-bold">{autoSelectedPolicy.pricing_basis}</div>
              </div>
              {autoSelectedPolicy.price_band && (
                <div className="bg-white p-2 rounded">
                  <div className="text-gray-600">ä¾¡æ ¼å¸¯</div>
                  <div className="font-bold">{autoSelectedPolicy.price_band}</div>
                </div>
              )}
              {autoSelectedPolicy.weight_range && (
                <div className="bg-white p-2 rounded">
                  <div className="text-gray-600">é‡é‡</div>
                  <div className="font-bold">{autoSelectedPolicy.weight_range}</div>
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆç°¡ç•¥ç‰ˆã§ç¶™ç¶šï¼‰ */}
      <div className="bg-white p-6 rounded-lg shadow-lg">
        <h3 className="text-xl font-bold text-gray-800 mb-4">å…¥åŠ›é …ç›®</h3>
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <InputField
              label="ä»•å…¥å€¤ï¼ˆå††ï¼‰"
              type="number"
              value={formData.costJPY}
              onChange={(e) => onInputChange('costJPY', parseFloat(e.target.value) || 0)}
            />
          </div>
          <div>
            <InputField
              label="å®Ÿé‡é‡(kg)"
              type="number"
              step="0.1"
              value={formData.actualWeight}
              onChange={(e) => onInputChange('actualWeight', parseFloat(e.target.value) || 0)}
            />
          </div>
          <div>
            <InputField
              label="ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ"
              type="number"
              value={formData.exchangeRate}
              onChange={(e) => onInputChange('exchangeRate', parseFloat(e.target.value) || 150)}
            />
          </div>
        </div>

        <button
          onClick={() => onCalculate({
            targetProfitMargin,
            costAdjustmentPercent,
            shippingAdjustmentPercent,
            otherCostAdjustmentPercent,
            adjustedCostJPY
          })}
          className="w-full mt-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-bold hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg flex items-center justify-center gap-2"
        >
          <Calculator className="w-5 h-5" />
          DDP & DDU åŒæ™‚è¨ˆç®—
        </button>
      </div>

      {/* è¨ˆç®—çµæœ */}
      {(resultDDP || resultDDU) && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="bg-white p-4 rounded shadow">
            <h3 className="font-bold text-indigo-800 mb-2">ğŸ‡ºğŸ‡¸ DDPçµæœ</h3>
            {resultDDP?.success ? (
              <div className="text-sm space-y-1">
                <div>é€æ–™: ${resultDDP.shipping?.toFixed(2) || 'N/A'}</div>
                <div>åˆ©ç›Š: Â¥{Math.round(resultDDP.profitJPY_NoRefund || 0).toLocaleString()}</div>
              </div>
            ) : (
              <div className="text-red-600">è¨ˆç®—ã‚¨ãƒ©ãƒ¼</div>
            )}
          </div>
          <div className="bg-white p-4 rounded shadow">
            <h3 className="font-bold text-green-800 mb-2">ğŸŒ DDUçµæœ</h3>
            {resultDDU?.success ? (
              <div className="text-sm space-y-1">
                <div>é€æ–™: ${resultDDU.shipping?.toFixed(2) || 'N/A'}</div>
                <div>åˆ©ç›Š: Â¥{Math.round(resultDDU.profitJPY_NoRefund || 0).toLocaleString()}</div>
              </div>
            ) : (
              <div className="text-red-600">è¨ˆç®—ã‚¨ãƒ©ãƒ¼</div>
            )}
          </div>
        </div>
      )}
    </div>
  )
}

import { ResultCard, ScoreBar, InputField, SelectField, Tooltip, PriceRow, CostRow, ErrorResult } from './result-card-components'
import { FinalPriceDisplay } from './final-price-display'
