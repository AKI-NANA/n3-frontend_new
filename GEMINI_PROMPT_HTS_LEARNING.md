# Gemini相談用プロンプト: HTS学習システムの実装指示書作成

以下の内容をGeminiに貼り付けてください:

---

## 依頼内容

越境EC自動化システム（N3）のHTS分類精度を向上させるため、**学習データベースシステム**の実装指示書を作成してください。

---

## 現在の状況

### 実装済み
1. **PostgreSQL RPC関数**: キーワードからHTS候補を検索（3段階スコアリング）
2. **Next.js API**: `/api/products/hts-lookup` でHTS検索
3. **UI**: 商品編集画面でキーワード入力→検索→手動選択

### 問題点
- 同じパターンの商品（例: ポケモンカード）でも毎回手動で選択が必要
- ユーザーが確定したHTSコードが蓄積されない
- カテゴリー、ブランド、素材からの自動判定ができない

---

## 実現したいこと

### 1. 学習データの蓄積
ユーザーがHTSコードを確定したとき、以下の情報をデータベースに自動記録:

**記録する情報**:
- 商品タイトル（日本語・英語）
- 使用したキーワード
- 確定したHTSコード（10桁）
- 原産国コード（2文字）
- 素材
- カテゴリー
- ブランド名
- 選択時のスコア・信頼度
- 使用回数・成功率

**目的**: 同じパターンの商品で自動的に正確なHTSコードを提案

---

### 2. カテゴリー別のHTS自動判定

**カテゴリーマスター**を作成し、カテゴリー名からHTSコードを推定:

#### 例: トレーディングカード
```
カテゴリー: "トレーディングカード" / "Trading Cards"
→ HTSコード: 9504.40.00.00
→ 素材候補: "Card Stock", "Paper"
→ 関連キーワード: "playing cards", "printed cards", "collectible cards"
```

#### 例: スマートフォン
```
カテゴリー: "スマートフォン" / "Smartphones"
→ HTSコード: 8517.12.00.00
→ 素材候補: "Plastic", "Glass", "Metal"
→ 関連キーワード: "mobile phone", "smartphone", "cellular"
```

#### 例: アパレル（綿製Tシャツ）
```
カテゴリー: "Tシャツ" / "T-Shirts"
素材: "Cotton"
→ HTSコード: 6109.10.00.12
→ 関連キーワード: "cotton shirt", "apparel", "clothing"
```

---

### 3. ブランド名からの原産国・素材判定

**ブランドマスター**を作成し、ブランド名から製造情報を推定:

#### 例: ポケモンカード
```
ブランド: "Pokémon" / "ポケモン"
→ 原産国候補:
  - 日本語版 → JP
  - 英語版（米国製） → US
  - 英語版（ベルギー製） → BE
→ HTSコード: 9504.40.00.00
→ 素材: "Card Stock"
```

#### 例: Apple製品
```
ブランド: "Apple" / "iPhone"
→ 原産国候補: CN（中国）, VN（ベトナム）
→ HTSコード: 8517.12.00.00（スマホ）
→ 素材: "Aluminum", "Glass"
```

---

### 4. 素材からのHTS推定補助

**素材とHTSの関連性**を登録:

```
素材: "Card Stock" + キーワード: "playing cards"
→ HTSコード: 9504.40.00.00

素材: "Cotton" + カテゴリー: "shirt"
→ HTSコード: 6109.10.00.12

素材: "Plastic" + カテゴリー: "toy"
→ HTSコード: 9503.00.00.00
```

---

## データベース設計の要件

### 必要なテーブル

1. **hts_learning_data** - 学習データ蓄積
   - 商品情報（タイトル、カテゴリー、ブランド、素材）
   - 確定したHTS情報（コード、原産国）
   - 使用したキーワード
   - 統計情報（使用回数、成功率）

2. **hts_category_master** - カテゴリー→HTS判定
   - カテゴリー名（日英）
   - 推奨HTSコード
   - 推奨素材
   - 推奨キーワード

3. **hts_brand_master** - ブランド→製造情報判定
   - ブランド名（日英）
   - 原産国候補（複数）
   - 関連HTSコード
   - 素材候補

4. **hts_material_patterns** - 素材パターン
   - 素材名
   - 関連HTSコード
   - キーワードパターン

---

## 検索ロジックの要件

### 3段階検索システム

```
ステップ1: 学習データから検索（最優先）
  - 同じ商品タイトルパターン
  - 同じキーワード
  - 同じカテゴリー+ブランド
  → 一致あり: 信頼度 very_high（学習済み）

ステップ2: マスターデータから推定
  - カテゴリーマスターから検索
  - ブランドマスターから検索
  - 素材パターンから検索
  → 一致あり: 信頼度 high（推定）

ステップ3: HTS公式データから検索
  - 通常のキーワード検索
  - 3段階スコアリング
  → 結果: 信頼度 medium/low（検索結果）
```

---

## 実装指示書に含めてほしい内容

1. **データベース設計**
   - 全テーブルのCREATE TABLE文
   - インデックス定義
   - リレーション

2. **PostgreSQLストアドファンクション**
   - `search_hts_with_learning()` - 学習データを含む検索
   - `record_hts_learning()` - 学習データ記録
   - `get_category_hts()` - カテゴリーからHTS取得

3. **Next.js API実装**
   - `/api/products/hts-lookup` - 検索API（学習統合）
   - `/api/products/update` - 保存時に学習データ記録
   - `/api/hts/learning-stats` - 学習データ統計

4. **TypeScript型定義**
   - 学習データ型
   - マスターデータ型

5. **初期データ**
   - カテゴリーマスターの初期データ（トレカ、スマホ、アパレル等）
   - ブランドマスターの初期データ（ポケモン、Apple、Nike等）

6. **テストケース**
   - 学習データ記録のテスト
   - 学習データからの検索テスト
   - マスターデータからの推定テスト

---

## 技術スタック

- **Database**: PostgreSQL (Supabase)
- **Backend**: Next.js 15.5.4 App Router
- **Language**: TypeScript
- **ORM**: Supabase Client

---

## 重要な制約

1. **既存コードとの互換性**: 現在の検索APIを破壊しない
2. **段階的実装**: Phase 1（学習蓄積）→ Phase 2（検索統合）→ Phase 3（マスター統合）
3. **パフォーマンス**: 検索は3秒以内
4. **精度目標**: 学習後の精度99%以上

---

## 期待される成果物

完全な実装指示書（マークダウン形式）で、以下を含む:

1. システム設計概要
2. データベース設計（全SQL）
3. API設計（全エンドポイント）
4. フロントエンド実装ガイド
5. テスト項目
6. 段階的実装手順

---

以上の要件に基づき、Claude（AI開発アシスタント）が実装できるレベルの詳細な指示書を作成してください。

特に重要なのは:
- カテゴリー→HTS自動判定
- ブランド→原産国推定
- 素材→HTS推定
- 学習データの効率的な蓄積と活用

よろしくお願いします。
